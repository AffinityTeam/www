/* Minification failed. Returning unminified contents.
(16948,13-14): run-time error JS1003: Expected ':': (
(16949,3-4): run-time error JS1009: Expected '}': {
(16965,3-4): run-time error JS1002: Syntax error: }
(16984,3-4): run-time error JS1002: Syntax error: }
(16994,4-5): run-time error JS1195: Expected expression: ,
(17393,4-5): run-time error JS1195: Expected expression: ,
(17410,4-5): run-time error JS1195: Expected expression: ,
(17447,4-5): run-time error JS1195: Expected expression: ,
(17485,4-5): run-time error JS1195: Expected expression: ,
(17517,4-5): run-time error JS1195: Expected expression: ,
(17519,27-28): run-time error JS1195: Expected expression: )
(17549,4-5): run-time error JS1195: Expected expression: ,
(17551,27-28): run-time error JS1195: Expected expression: )
(17556,4-5): run-time error JS1195: Expected expression: ,
(17560,35-36): run-time error JS1195: Expected expression: )
(17573,4-5): run-time error JS1195: Expected expression: ,
(17574,39-40): run-time error JS1195: Expected expression: )
(17581,1-2): run-time error JS1002: Syntax error: }
(18497,30-35): run-time error JS1195: Expected expression: class
(18585,7-12): run-time error JS1195: Expected expression: class
(18633,24-25): run-time error JS1014: Invalid character: `
(18634,9-10): run-time error JS1195: Expected expression: :
(18634,9-10): run-time error JS1195: Expected expression: :
(18634,28-29): run-time error JS1197: Too many errors. The file might not be a JavaScript file: -
(16993,5-24): run-time error JS1018: 'return' statement outside of function: return defaultValue
(16991,7-48): run-time error JS1018: 'return' statement outside of function: return isSet === 'true' || isSet === true
 */
/*! jQuery v@1.8.0 jquery.com | jquery.org/license */
(function(a,b){function G(a){var b=F[a]={};return p.each(a.split(s),function(a,c){b[c]=!0}),b}function J(a,c,d){if(d===b&&a.nodeType===1){var e="data-"+c.replace(I,"-$1").toLowerCase();d=a.getAttribute(e);if(typeof d=="string"){try{d=d==="true"?!0:d==="false"?!1:d==="null"?null:+d+""===d?+d:H.test(d)?p.parseJSON(d):d}catch(f){}p.data(a,c,d)}else d=b}return d}function K(a){var b;for(b in a){if(b==="data"&&p.isEmptyObject(a[b]))continue;if(b!=="toJSON")return!1}return!0}function ba(){return!1}function bb(){return!0}function bh(a){return!a||!a.parentNode||a.parentNode.nodeType===11}function bi(a,b){do a=a[b];while(a&&a.nodeType!==1);return a}function bj(a,b,c){b=b||0;if(p.isFunction(b))return p.grep(a,function(a,d){var e=!!b.call(a,d,a);return e===c});if(b.nodeType)return p.grep(a,function(a,d){return a===b===c});if(typeof b=="string"){var d=p.grep(a,function(a){return a.nodeType===1});if(be.test(b))return p.filter(b,d,!c);b=p.filter(b,d)}return p.grep(a,function(a,d){return p.inArray(a,b)>=0===c})}function bk(a){var b=bl.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}function bC(a,b){return a.getElementsByTagName(b)[0]||a.appendChild(a.ownerDocument.createElement(b))}function bD(a,b){if(b.nodeType!==1||!p.hasData(a))return;var c,d,e,f=p._data(a),g=p._data(b,f),h=f.events;if(h){delete g.handle,g.events={};for(c in h)for(d=0,e=h[c].length;d<e;d++)p.event.add(b,c,h[c][d])}g.data&&(g.data=p.extend({},g.data))}function bE(a,b){var c;if(b.nodeType!==1)return;b.clearAttributes&&b.clearAttributes(),b.mergeAttributes&&b.mergeAttributes(a),c=b.nodeName.toLowerCase(),c==="object"?(b.parentNode&&(b.outerHTML=a.outerHTML),p.support.html5Clone&&a.innerHTML&&!p.trim(b.innerHTML)&&(b.innerHTML=a.innerHTML)):c==="input"&&bv.test(a.type)?(b.defaultChecked=b.checked=a.checked,b.value!==a.value&&(b.value=a.value)):c==="option"?b.selected=a.defaultSelected:c==="input"||c==="textarea"?b.defaultValue=a.defaultValue:c==="script"&&b.text!==a.text&&(b.text=a.text),b.removeAttribute(p.expando)}function bF(a){return typeof a.getElementsByTagName!="undefined"?a.getElementsByTagName("*"):typeof a.querySelectorAll!="undefined"?a.querySelectorAll("*"):[]}function bG(a){bv.test(a.type)&&(a.defaultChecked=a.checked)}function bX(a,b){if(b in a)return b;var c=b.charAt(0).toUpperCase()+b.slice(1),d=b,e=bV.length;while(e--){b=bV[e]+c;if(b in a)return b}return d}function bY(a,b){return a=b||a,p.css(a,"display")==="none"||!p.contains(a.ownerDocument,a)}function bZ(a,b){var c,d,e=[],f=0,g=a.length;for(;f<g;f++){c=a[f];if(!c.style)continue;e[f]=p._data(c,"olddisplay"),b?(!e[f]&&c.style.display==="none"&&(c.style.display=""),c.style.display===""&&bY(c)&&(e[f]=p._data(c,"olddisplay",cb(c.nodeName)))):(d=bH(c,"display"),!e[f]&&d!=="none"&&p._data(c,"olddisplay",d))}for(f=0;f<g;f++){c=a[f];if(!c.style)continue;if(!b||c.style.display==="none"||c.style.display==="")c.style.display=b?e[f]||"":"none"}return a}function b$(a,b,c){var d=bO.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function b_(a,b,c,d){var e=c===(d?"border":"content")?4:b==="width"?1:0,f=0;for(;e<4;e+=2)c==="margin"&&(f+=p.css(a,c+bU[e],!0)),d?(c==="content"&&(f-=parseFloat(bH(a,"padding"+bU[e]))||0),c!=="margin"&&(f-=parseFloat(bH(a,"border"+bU[e]+"Width"))||0)):(f+=parseFloat(bH(a,"padding"+bU[e]))||0,c!=="padding"&&(f+=parseFloat(bH(a,"border"+bU[e]+"Width"))||0));return f}function ca(a,b,c){var d=b==="width"?a.offsetWidth:a.offsetHeight,e=!0,f=p.support.boxSizing&&p.css(a,"boxSizing")==="border-box";if(d<=0){d=bH(a,b);if(d<0||d==null)d=a.style[b];if(bP.test(d))return d;e=f&&(p.support.boxSizingReliable||d===a.style[b]),d=parseFloat(d)||0}return d+b_(a,b,c||(f?"border":"content"),e)+"px"}function cb(a){if(bR[a])return bR[a];var b=p("<"+a+">").appendTo(e.body),c=b.css("display");b.remove();if(c==="none"||c===""){bI=e.body.appendChild(bI||p.extend(e.createElement("iframe"),{frameBorder:0,width:0,height:0}));if(!bJ||!bI.createElement)bJ=(bI.contentWindow||bI.contentDocument).document,bJ.write("<!doctype html><html><body>"),bJ.close();b=bJ.body.appendChild(bJ.createElement(a)),c=bH(b,"display"),e.body.removeChild(bI)}return bR[a]=c,c}function ch(a,b,c,d){var e;if(p.isArray(b))p.each(b,function(b,e){c||cd.test(a)?d(a,e):ch(a+"["+(typeof e=="object"?b:"")+"]",e,c,d)});else if(!c&&p.type(b)==="object")for(e in b)ch(a+"["+e+"]",b[e],c,d);else d(a,b)}function cy(a){return function(b,c){typeof b!="string"&&(c=b,b="*");var d,e,f,g=b.toLowerCase().split(s),h=0,i=g.length;if(p.isFunction(c))for(;h<i;h++)d=g[h],f=/^\+/.test(d),f&&(d=d.substr(1)||"*"),e=a[d]=a[d]||[],e[f?"unshift":"push"](c)}}function cz(a,c,d,e,f,g){f=f||c.dataTypes[0],g=g||{},g[f]=!0;var h,i=a[f],j=0,k=i?i.length:0,l=a===cu;for(;j<k&&(l||!h);j++)h=i[j](c,d,e),typeof h=="string"&&(!l||g[h]?h=b:(c.dataTypes.unshift(h),h=cz(a,c,d,e,h,g)));return(l||!h)&&!g["*"]&&(h=cz(a,c,d,e,"*",g)),h}function cA(a,c){var d,e,f=p.ajaxSettings.flatOptions||{};for(d in c)c[d]!==b&&((f[d]?a:e||(e={}))[d]=c[d]);e&&p.extend(!0,a,e)}function cB(a,c,d){var e,f,g,h,i=a.contents,j=a.dataTypes,k=a.responseFields;for(f in k)f in d&&(c[k[f]]=d[f]);while(j[0]==="*")j.shift(),e===b&&(e=a.mimeType||c.getResponseHeader("content-type"));if(e)for(f in i)if(i[f]&&i[f].test(e)){j.unshift(f);break}if(j[0]in d)g=j[0];else{for(f in d){if(!j[0]||a.converters[f+" "+j[0]]){g=f;break}h||(h=f)}g=g||h}if(g)return g!==j[0]&&j.unshift(g),d[g]}function cC(a,b){var c,d,e,f,g=a.dataTypes.slice(),h=g[0],i={},j=0;a.dataFilter&&(b=a.dataFilter(b,a.dataType));if(g[1])for(c in a.converters)i[c.toLowerCase()]=a.converters[c];for(;e=g[++j];)if(e!=="*"){if(h!=="*"&&h!==e){c=i[h+" "+e]||i["* "+e];if(!c)for(d in i){f=d.split(" ");if(f[1]===e){c=i[h+" "+f[0]]||i["* "+f[0]];if(c){c===!0?c=i[d]:i[d]!==!0&&(e=f[0],g.splice(j--,0,e));break}}}if(c!==!0)if(c&&a["throws"])b=c(b);else try{b=c(b)}catch(k){return{state:"parsererror",error:c?k:"No conversion from "+h+" to "+e}}}h=e}return{state:"success",data:b}}function cK(){try{return new a.XMLHttpRequest}catch(b){}}function cL(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}function cT(){return setTimeout(function(){cM=b},0),cM=p.now()}function cU(a,b){p.each(b,function(b,c){var d=(cS[b]||[]).concat(cS["*"]),e=0,f=d.length;for(;e<f;e++)if(d[e].call(a,b,c))return})}function cV(a,b,c){var d,e=0,f=0,g=cR.length,h=p.Deferred().always(function(){delete i.elem}),i=function(){var b=cM||cT(),c=Math.max(0,j.startTime+j.duration-b),d=1-(c/j.duration||0),e=0,f=j.tweens.length;for(;e<f;e++)j.tweens[e].run(d);return h.notifyWith(a,[j,d,c]),d<1&&f?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:p.extend({},b),opts:p.extend(!0,{specialEasing:{}},c),originalProperties:b,originalOptions:c,startTime:cM||cT(),duration:c.duration,tweens:[],createTween:function(b,c,d){var e=p.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(e),e},stop:function(b){var c=0,d=b?j.tweens.length:0;for(;c<d;c++)j.tweens[c].run(1);return b?h.resolveWith(a,[j,b]):h.rejectWith(a,[j,b]),this}}),k=j.props;cW(k,j.opts.specialEasing);for(;e<g;e++){d=cR[e].call(j,a,k,j.opts);if(d)return d}return cU(j,k),p.isFunction(j.opts.start)&&j.opts.start.call(a,j),p.fx.timer(p.extend(i,{anim:j,queue:j.opts.queue,elem:a})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}function cW(a,b){var c,d,e,f,g;for(c in a){d=p.camelCase(c),e=b[d],f=a[c],p.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=p.cssHooks[d];if(g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}}function cX(a,b,c){var d,e,f,g,h,i,j,k,l=this,m=a.style,n={},o=[],q=a.nodeType&&bY(a);c.queue||(j=p._queueHooks(a,"fx"),j.unqueued==null&&(j.unqueued=0,k=j.empty.fire,j.empty.fire=function(){j.unqueued||k()}),j.unqueued++,l.always(function(){l.always(function(){j.unqueued--,p.queue(a,"fx").length||j.empty.fire()})})),a.nodeType===1&&("height"in b||"width"in b)&&(c.overflow=[m.overflow,m.overflowX,m.overflowY],p.css(a,"display")==="inline"&&p.css(a,"float")==="none"&&(!p.support.inlineBlockNeedsLayout||cb(a.nodeName)==="inline"?m.display="inline-block":m.zoom=1)),c.overflow&&(m.overflow="hidden",p.support.shrinkWrapBlocks||l.done(function(){m.overflow=c.overflow[0],m.overflowX=c.overflow[1],m.overflowY=c.overflow[2]}));for(d in b){f=b[d];if(cO.exec(f)){delete b[d];if(f===(q?"hide":"show"))continue;o.push(d)}}g=o.length;if(g){h=p._data(a,"fxshow")||p._data(a,"fxshow",{}),q?p(a).show():l.done(function(){p(a).hide()}),l.done(function(){var b;p.removeData(a,"fxshow",!0);for(b in n)p.style(a,b,n[b])});for(d=0;d<g;d++)e=o[d],i=l.createTween(e,q?h[e]:0),n[e]=h[e]||p.style(a,e),e in h||(h[e]=i.start,q&&(i.end=i.start,i.start=e==="width"||e==="height"?1:0))}}function cY(a,b,c,d,e){return new cY.prototype.init(a,b,c,d,e)}function cZ(a,b){var c,d={height:a},e=0;for(;e<4;e+=2-b)c=bU[e],d["margin"+c]=d["padding"+c]=a;return b&&(d.opacity=d.width=a),d}function c_(a){return p.isWindow(a)?a:a.nodeType===9?a.defaultView||a.parentWindow:!1}var c,d,e=a.document,f=a.location,g=a.navigator,h=a.jQuery,i=a.$,j=Array.prototype.push,k=Array.prototype.slice,l=Array.prototype.indexOf,m=Object.prototype.toString,n=Object.prototype.hasOwnProperty,o=String.prototype.trim,p=function(a,b){return new p.fn.init(a,b,c)},q=/[\-+]?(?:\d*\.|)\d+(?:[eE][\-+]?\d+|)/.source,r=/\S/,s=/\s+/,t=r.test(" ")?/^[\s\xA0]+|[\s\xA0]+$/g:/^\s+|\s+$/g,u=/^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,v=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,w=/^[\],:{}\s]*$/,x=/(?:^|:|,)(?:\s*\[)+/g,y=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,z=/"[^"\\\r\n]*"|true|false|null|-?(?:\d\d*\.|)\d+(?:[eE][\-+]?\d+|)/g,A=/^-ms-/,B=/-([\da-z])/gi,C=function(a,b){return(b+"").toUpperCase()},D=function(){e.addEventListener?(e.removeEventListener("DOMContentLoaded",D,!1),p.ready()):e.readyState==="complete"&&(e.detachEvent("onreadystatechange",D),p.ready())},E={};p.fn=p.prototype={constructor:p,init:function(a,c,d){var f,g,h,i;if(!a)return this;if(a.nodeType)return this.context=this[0]=a,this.length=1,this;if(typeof a=="string"){a.charAt(0)==="<"&&a.charAt(a.length-1)===">"&&a.length>=3?f=[null,a,null]:f=u.exec(a);if(f&&(f[1]||!c)){if(f[1])return c=c instanceof p?c[0]:c,i=c&&c.nodeType?c.ownerDocument||c:e,a=p.parseHTML(f[1],i,!0),v.test(f[1])&&p.isPlainObject(c)&&this.attr.call(a,c,!0),p.merge(this,a);g=e.getElementById(f[2]);if(g&&g.parentNode){if(g.id!==f[2])return d.find(a);this.length=1,this[0]=g}return this.context=e,this.selector=a,this}return!c||c.jquery?(c||d).find(a):this.constructor(c).find(a)}return p.isFunction(a)?d.ready(a):(a.selector!==b&&(this.selector=a.selector,this.context=a.context),p.makeArray(a,this))},selector:"",jquery:"1.8.0",length:0,size:function(){return this.length},toArray:function(){return k.call(this)},get:function(a){return a==null?this.toArray():a<0?this[this.length+a]:this[a]},pushStack:function(a,b,c){var d=p.merge(this.constructor(),a);return d.prevObject=this,d.context=this.context,b==="find"?d.selector=this.selector+(this.selector?" ":"")+c:b&&(d.selector=this.selector+"."+b+"("+c+")"),d},each:function(a,b){return p.each(this,a,b)},ready:function(a){return p.ready.promise().done(a),this},eq:function(a){return a=+a,a===-1?this.slice(a):this.slice(a,a+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(k.apply(this,arguments),"slice",k.call(arguments).join(","))},map:function(a){return this.pushStack(p.map(this,function(b,c){return a.call(b,c,b)}))},end:function(){return this.prevObject||this.constructor(null)},push:j,sort:[].sort,splice:[].splice},p.fn.init.prototype=p.fn,p.extend=p.fn.extend=function(){var a,c,d,e,f,g,h=arguments[0]||{},i=1,j=arguments.length,k=!1;typeof h=="boolean"&&(k=h,h=arguments[1]||{},i=2),typeof h!="object"&&!p.isFunction(h)&&(h={}),j===i&&(h=this,--i);for(;i<j;i++)if((a=arguments[i])!=null)for(c in a){d=h[c],e=a[c];if(h===e)continue;k&&e&&(p.isPlainObject(e)||(f=p.isArray(e)))?(f?(f=!1,g=d&&p.isArray(d)?d:[]):g=d&&p.isPlainObject(d)?d:{},h[c]=p.extend(k,g,e)):e!==b&&(h[c]=e)}return h},p.extend({noConflict:function(b){return a.$===p&&(a.$=i),b&&a.jQuery===p&&(a.jQuery=h),p},isReady:!1,readyWait:1,holdReady:function(a){a?p.readyWait++:p.ready(!0)},ready:function(a){if(a===!0?--p.readyWait:p.isReady)return;if(!e.body)return setTimeout(p.ready,1);p.isReady=!0;if(a!==!0&&--p.readyWait>0)return;d.resolveWith(e,[p]),p.fn.trigger&&p(e).trigger("ready").off("ready")},isFunction:function(a){return p.type(a)==="function"},isArray:Array.isArray||function(a){return p.type(a)==="array"},isWindow:function(a){return a!=null&&a==a.window},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return a==null?String(a):E[m.call(a)]||"object"},isPlainObject:function(a){if(!a||p.type(a)!=="object"||a.nodeType||p.isWindow(a))return!1;try{if(a.constructor&&!n.call(a,"constructor")&&!n.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}var d;for(d in a);return d===b||n.call(a,d)},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},error:function(a){throw new Error(a)},parseHTML:function(a,b,c){var d;return!a||typeof a!="string"?null:(typeof b=="boolean"&&(c=b,b=0),b=b||e,(d=v.exec(a))?[b.createElement(d[1])]:(d=p.buildFragment([a],b,c?null:[]),p.merge([],(d.cacheable?p.clone(d.fragment):d.fragment).childNodes)))},parseJSON:function(b){if(!b||typeof b!="string")return null;b=p.trim(b);if(a.JSON&&a.JSON.parse)return a.JSON.parse(b);if(w.test(b.replace(y,"@").replace(z,"]").replace(x,"")))return(new Function("return "+b))();p.error("Invalid JSON: "+b)},parseXML:function(c){var d,e;if(!c||typeof c!="string")return null;try{a.DOMParser?(e=new DOMParser,d=e.parseFromString(c,"text/xml")):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(c))}catch(f){d=b}return(!d||!d.documentElement||d.getElementsByTagName("parsererror").length)&&p.error("Invalid XML: "+c),d},noop:function(){},globalEval:function(b){b&&r.test(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(A,"ms-").replace(B,C)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toUpperCase()===b.toUpperCase()},each:function(a,c,d){var e,f=0,g=a.length,h=g===b||p.isFunction(a);if(d){if(h){for(e in a)if(c.apply(a[e],d)===!1)break}else for(;f<g;)if(c.apply(a[f++],d)===!1)break}else if(h){for(e in a)if(c.call(a[e],e,a[e])===!1)break}else for(;f<g;)if(c.call(a[f],f,a[f++])===!1)break;return a},trim:o?function(a){return a==null?"":o.call(a)}:function(a){return a==null?"":a.toString().replace(t,"")},makeArray:function(a,b){var c,d=b||[];return a!=null&&(c=p.type(a),a.length==null||c==="string"||c==="function"||c==="regexp"||p.isWindow(a)?j.call(d,a):p.merge(d,a)),d},inArray:function(a,b,c){var d;if(b){if(l)return l.call(b,a,c);d=b.length,c=c?c<0?Math.max(0,d+c):c:0;for(;c<d;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,c){var d=c.length,e=a.length,f=0;if(typeof d=="number")for(;f<d;f++)a[e++]=c[f];else while(c[f]!==b)a[e++]=c[f++];return a.length=e,a},grep:function(a,b,c){var d,e=[],f=0,g=a.length;c=!!c;for(;f<g;f++)d=!!b(a[f],f),c!==d&&e.push(a[f]);return e},map:function(a,c,d){var e,f,g=[],h=0,i=a.length,j=a instanceof p||i!==b&&typeof i=="number"&&(i>0&&a[0]&&a[i-1]||i===0||p.isArray(a));if(j)for(;h<i;h++)e=c(a[h],h,d),e!=null&&(g[g.length]=e);else for(f in a)e=c(a[f],f,d),e!=null&&(g[g.length]=e);return g.concat.apply([],g)},guid:1,proxy:function(a,c){var d,e,f;return typeof c=="string"&&(d=a[c],c=a,a=d),p.isFunction(a)?(e=k.call(arguments,2),f=function(){return a.apply(c,e.concat(k.call(arguments)))},f.guid=a.guid=a.guid||f.guid||p.guid++,f):b},access:function(a,c,d,e,f,g,h){var i,j=d==null,k=0,l=a.length;if(d&&typeof d=="object"){for(k in d)p.access(a,c,k,d[k],1,g,e);f=1}else if(e!==b){i=h===b&&p.isFunction(e),j&&(i?(i=c,c=function(a,b,c){return i.call(p(a),c)}):(c.call(a,e),c=null));if(c)for(;k<l;k++)c(a[k],d,i?e.call(a[k],k,c(a[k],d)):e,h);f=1}return f?a:j?c.call(a):l?c(a[0],d):g},now:function(){return(new Date).getTime()}}),p.ready.promise=function(b){if(!d){d=p.Deferred();if(e.readyState==="complete"||e.readyState!=="loading"&&e.addEventListener)setTimeout(p.ready,1);else if(e.addEventListener)e.addEventListener("DOMContentLoaded",D,!1),a.addEventListener("load",p.ready,!1);else{e.attachEvent("onreadystatechange",D),a.attachEvent("onload",p.ready);var c=!1;try{c=a.frameElement==null&&e.documentElement}catch(f){}c&&c.doScroll&&function g(){if(!p.isReady){try{c.doScroll("left")}catch(a){return setTimeout(g,50)}p.ready()}}()}}return d.promise(b)},p.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(a,b){E["[object "+b+"]"]=b.toLowerCase()}),c=p(e);var F={};p.Callbacks=function(a){a=typeof a=="string"?F[a]||G(a):p.extend({},a);var c,d,e,f,g,h,i=[],j=!a.once&&[],k=function(b){c=a.memory&&b,d=!0,h=f||0,f=0,g=i.length,e=!0;for(;i&&h<g;h++)if(i[h].apply(b[0],b[1])===!1&&a.stopOnFalse){c=!1;break}e=!1,i&&(j?j.length&&k(j.shift()):c?i=[]:l.disable())},l={add:function(){if(i){var b=i.length;(function d(b){p.each(b,function(b,c){p.isFunction(c)&&(!a.unique||!l.has(c))?i.push(c):c&&c.length&&d(c)})})(arguments),e?g=i.length:c&&(f=b,k(c))}return this},remove:function(){return i&&p.each(arguments,function(a,b){var c;while((c=p.inArray(b,i,c))>-1)i.splice(c,1),e&&(c<=g&&g--,c<=h&&h--)}),this},has:function(a){return p.inArray(a,i)>-1},empty:function(){return i=[],this},disable:function(){return i=j=c=b,this},disabled:function(){return!i},lock:function(){return j=b,c||l.disable(),this},locked:function(){return!j},fireWith:function(a,b){return b=b||[],b=[a,b.slice?b.slice():b],i&&(!d||j)&&(e?j.push(b):k(b)),this},fire:function(){return l.fireWith(this,arguments),this},fired:function(){return!!d}};return l},p.extend({Deferred:function(a){var b=[["resolve","done",p.Callbacks("once memory"),"resolved"],["reject","fail",p.Callbacks("once memory"),"rejected"],["notify","progress",p.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return p.Deferred(function(c){p.each(b,function(b,d){var f=d[0],g=a[b];e[d[1]](p.isFunction(g)?function(){var a=g.apply(this,arguments);a&&p.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[f+"With"](this===e?c:this,[a])}:c[f])}),a=null}).promise()},promise:function(a){return typeof a=="object"?p.extend(a,d):d}},e={};return d.pipe=d.then,p.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[a^1][2].disable,b[2][2].lock),e[f[0]]=g.fire,e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=k.call(arguments),d=c.length,e=d!==1||a&&p.isFunction(a.promise)?d:0,f=e===1?a:p.Deferred(),g=function(a,b,c){return function(d){b[a]=this,c[a]=arguments.length>1?k.call(arguments):d,c===h?f.notifyWith(b,c):--e||f.resolveWith(b,c)}},h,i,j;if(d>1){h=new Array(d),i=new Array(d),j=new Array(d);for(;b<d;b++)c[b]&&p.isFunction(c[b].promise)?c[b].promise().done(g(b,j,c)).fail(f.reject).progress(g(b,i,h)):--e}return e||f.resolveWith(j,c),f.promise()}}),p.support=function(){var b,c,d,f,g,h,i,j,k,l,m,n=e.createElement("div");n.setAttribute("className","t"),n.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",c=n.getElementsByTagName("*"),d=n.getElementsByTagName("a")[0],d.style.cssText="top:1px;float:left;opacity:.5";if(!c||!c.length||!d)return{};f=e.createElement("select"),g=f.appendChild(e.createElement("option")),h=n.getElementsByTagName("input")[0],b={leadingWhitespace:n.firstChild.nodeType===3,tbody:!n.getElementsByTagName("tbody").length,htmlSerialize:!!n.getElementsByTagName("link").length,style:/top/.test(d.getAttribute("style")),hrefNormalized:d.getAttribute("href")==="/a",opacity:/^0.5/.test(d.style.opacity),cssFloat:!!d.style.cssFloat,checkOn:h.value==="on",optSelected:g.selected,getSetAttribute:n.className!=="t",enctype:!!e.createElement("form").enctype,html5Clone:e.createElement("nav").cloneNode(!0).outerHTML!=="<:nav></:nav>",boxModel:e.compatMode==="CSS1Compat",submitBubbles:!0,changeBubbles:!0,focusinBubbles:!1,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0,boxSizingReliable:!0,pixelPosition:!1},h.checked=!0,b.noCloneChecked=h.cloneNode(!0).checked,f.disabled=!0,b.optDisabled=!g.disabled;try{delete n.test}catch(o){b.deleteExpando=!1}!n.addEventListener&&n.attachEvent&&n.fireEvent&&(n.attachEvent("onclick",m=function(){b.noCloneEvent=!1}),n.cloneNode(!0).fireEvent("onclick"),n.detachEvent("onclick",m)),h=e.createElement("input"),h.value="t",h.setAttribute("type","radio"),b.radioValue=h.value==="t",h.setAttribute("checked","checked"),h.setAttribute("name","t"),n.appendChild(h),i=e.createDocumentFragment(),i.appendChild(n.lastChild),b.checkClone=i.cloneNode(!0).cloneNode(!0).lastChild.checked,b.appendChecked=h.checked,i.removeChild(h),i.appendChild(n);if(n.attachEvent)for(k in{submit:!0,change:!0,focusin:!0})j="on"+k,l=j in n,l||(n.setAttribute(j,"return;"),l=typeof n[j]=="function"),b[k+"Bubbles"]=l;return p(function(){var c,d,f,g,h="padding:0;margin:0;border:0;display:block;overflow:hidden;",i=e.getElementsByTagName("body")[0];if(!i)return;c=e.createElement("div"),c.style.cssText="visibility:hidden;border:0;width:0;height:0;position:static;top:0;margin-top:1px",i.insertBefore(c,i.firstChild),d=e.createElement("div"),c.appendChild(d),d.innerHTML="<table><tr><td></td><td>t</td></tr></table>",f=d.getElementsByTagName("td"),f[0].style.cssText="padding:0;margin:0;border:0;display:none",l=f[0].offsetHeight===0,f[0].style.display="",f[1].style.display="none",b.reliableHiddenOffsets=l&&f[0].offsetHeight===0,d.innerHTML="",d.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;",b.boxSizing=d.offsetWidth===4,b.doesNotIncludeMarginInBodyOffset=i.offsetTop!==1,a.getComputedStyle&&(b.pixelPosition=(a.getComputedStyle(d,null)||{}).top!=="1%",b.boxSizingReliable=(a.getComputedStyle(d,null)||{width:"4px"}).width==="4px",g=e.createElement("div"),g.style.cssText=d.style.cssText=h,g.style.marginRight=g.style.width="0",d.style.width="1px",d.appendChild(g),b.reliableMarginRight=!parseFloat((a.getComputedStyle(g,null)||{}).marginRight)),typeof d.style.zoom!="undefined"&&(d.innerHTML="",d.style.cssText=h+"width:1px;padding:1px;display:inline;zoom:1",b.inlineBlockNeedsLayout=d.offsetWidth===3,d.style.display="block",d.style.overflow="visible",d.innerHTML="<div></div>",d.firstChild.style.width="5px",b.shrinkWrapBlocks=d.offsetWidth!==3,c.style.zoom=1),i.removeChild(c),c=d=f=g=null}),i.removeChild(n),c=d=f=g=h=i=n=null,b}();var H=/^(?:\{.*\}|\[.*\])$/,I=/([A-Z])/g;p.extend({cache:{},deletedIds:[],uuid:0,expando:"jQuery"+(p.fn.jquery+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(a){return a=a.nodeType?p.cache[a[p.expando]]:a[p.expando],!!a&&!K(a)},data:function(a,c,d,e){if(!p.acceptData(a))return;var f,g,h=p.expando,i=typeof c=="string",j=a.nodeType,k=j?p.cache:a,l=j?a[h]:a[h]&&h;if((!l||!k[l]||!e&&!k[l].data)&&i&&d===b)return;l||(j?a[h]=l=p.deletedIds.pop()||++p.uuid:l=h),k[l]||(k[l]={},j||(k[l].toJSON=p.noop));if(typeof c=="object"||typeof c=="function")e?k[l]=p.extend(k[l],c):k[l].data=p.extend(k[l].data,c);return f=k[l],e||(f.data||(f.data={}),f=f.data),d!==b&&(f[p.camelCase(c)]=d),i?(g=f[c],g==null&&(g=f[p.camelCase(c)])):g=f,g},removeData:function(a,b,c){if(!p.acceptData(a))return;var d,e,f,g=a.nodeType,h=g?p.cache:a,i=g?a[p.expando]:p.expando;if(!h[i])return;if(b){d=c?h[i]:h[i].data;if(d){p.isArray(b)||(b in d?b=[b]:(b=p.camelCase(b),b in d?b=[b]:b=b.split(" ")));for(e=0,f=b.length;e<f;e++)delete d[b[e]];if(!(c?K:p.isEmptyObject)(d))return}}if(!c){delete h[i].data;if(!K(h[i]))return}g?p.cleanData([a],!0):p.support.deleteExpando||h!=h.window?delete h[i]:h[i]=null},_data:function(a,b,c){return p.data(a,b,c,!0)},acceptData:function(a){var b=a.nodeName&&p.noData[a.nodeName.toLowerCase()];return!b||b!==!0&&a.getAttribute("classid")===b}}),p.fn.extend({data:function(a,c){var d,e,f,g,h,i=this[0],j=0,k=null;if(a===b){if(this.length){k=p.data(i);if(i.nodeType===1&&!p._data(i,"parsedAttrs")){f=i.attributes;for(h=f.length;j<h;j++)g=f[j].name,g.indexOf("data-")===0&&(g=p.camelCase(g.substring(5)),J(i,g,k[g]));p._data(i,"parsedAttrs",!0)}}return k}return typeof a=="object"?this.each(function(){p.data(this,a)}):(d=a.split(".",2),d[1]=d[1]?"."+d[1]:"",e=d[1]+"!",p.access(this,function(c){if(c===b)return k=this.triggerHandler("getData"+e,[d[0]]),k===b&&i&&(k=p.data(i,a),k=J(i,a,k)),k===b&&d[1]?this.data(d[0]):k;d[1]=c,this.each(function(){var b=p(this);b.triggerHandler("setData"+e,d),p.data(this,a,c),b.triggerHandler("changeData"+e,d)})},null,c,arguments.length>1,null,!1))},removeData:function(a){return this.each(function(){p.removeData(this,a)})}}),p.extend({queue:function(a,b,c){var d;if(a)return b=(b||"fx")+"queue",d=p._data(a,b),c&&(!d||p.isArray(c)?d=p._data(a,b,p.makeArray(c)):d.push(c)),d||[]},dequeue:function(a,b){b=b||"fx";var c=p.queue(a,b),d=c.shift(),e=p._queueHooks(a,b),f=function(){p.dequeue(a,b)};d==="inprogress"&&(d=c.shift()),d&&(b==="fx"&&c.unshift("inprogress"),delete e.stop,d.call(a,f,e)),!c.length&&e&&e.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return p._data(a,c)||p._data(a,c,{empty:p.Callbacks("once memory").add(function(){p.removeData(a,b+"queue",!0),p.removeData(a,c,!0)})})}}),p.fn.extend({queue:function(a,c){var d=2;return typeof a!="string"&&(c=a,a="fx",d--),arguments.length<d?p.queue(this[0],a):c===b?this:this.each(function(){var b=p.queue(this,a,c);p._queueHooks(this,a),a==="fx"&&b[0]!=="inprogress"&&p.dequeue(this,a)})},dequeue:function(a){return this.each(function(){p.dequeue(this,a)})},delay:function(a,b){return a=p.fx?p.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,c){var d,e=1,f=p.Deferred(),g=this,h=this.length,i=function(){--e||f.resolveWith(g,[g])};typeof a!="string"&&(c=a,a=b),a=a||"fx";while(h--)(d=p._data(g[h],a+"queueHooks"))&&d.empty&&(e++,d.empty.add(i));return i(),f.promise(c)}});var L,M,N,O=/[\t\r\n]/g,P=/\r/g,Q=/^(?:button|input)$/i,R=/^(?:button|input|object|select|textarea)$/i,S=/^a(?:rea|)$/i,T=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,U=p.support.getSetAttribute;p.fn.extend({attr:function(a,b){return p.access(this,p.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){p.removeAttr(this,a)})},prop:function(a,b){return p.access(this,p.prop,a,b,arguments.length>1)},removeProp:function(a){return a=p.propFix[a]||a,this.each(function(){try{this[a]=b,delete this[a]}catch(c){}})},addClass:function(a){var b,c,d,e,f,g,h;if(p.isFunction(a))return this.each(function(b){p(this).addClass(a.call(this,b,this.className))});if(a&&typeof a=="string"){b=a.split(s);for(c=0,d=this.length;c<d;c++){e=this[c];if(e.nodeType===1)if(!e.className&&b.length===1)e.className=a;else{f=" "+e.className+" ";for(g=0,h=b.length;g<h;g++)~f.indexOf(" "+b[g]+" ")||(f+=b[g]+" ");e.className=p.trim(f)}}}return this},removeClass:function(a){var c,d,e,f,g,h,i;if(p.isFunction(a))return this.each(function(b){p(this).removeClass(a.call(this,b,this.className))});if(a&&typeof a=="string"||a===b){c=(a||"").split(s);for(h=0,i=this.length;h<i;h++){e=this[h];if(e.nodeType===1&&e.className){d=(" "+e.className+" ").replace(O," ");for(f=0,g=c.length;f<g;f++)while(d.indexOf(" "+c[f]+" ")>-1)d=d.replace(" "+c[f]+" "," ");e.className=a?p.trim(d):""}}}return this},toggleClass:function(a,b){var c=typeof a,d=typeof b=="boolean";return p.isFunction(a)?this.each(function(c){p(this).toggleClass(a.call(this,c,this.className,b),b)}):this.each(function(){if(c==="string"){var e,f=0,g=p(this),h=b,i=a.split(s);while(e=i[f++])h=d?h:!g.hasClass(e),g[h?"addClass":"removeClass"](e)}else if(c==="undefined"||c==="boolean")this.className&&p._data(this,"__className__",this.className),this.className=this.className||a===!1?"":p._data(this,"__className__")||""})},hasClass:function(a){var b=" "+a+" ",c=0,d=this.length;for(;c<d;c++)if(this[c].nodeType===1&&(" "+this[c].className+" ").replace(O," ").indexOf(b)>-1)return!0;return!1},val:function(a){var c,d,e,f=this[0];if(!arguments.length){if(f)return c=p.valHooks[f.type]||p.valHooks[f.nodeName.toLowerCase()],c&&"get"in c&&(d=c.get(f,"value"))!==b?d:(d=f.value,typeof d=="string"?d.replace(P,""):d==null?"":d);return}return e=p.isFunction(a),this.each(function(d){var f,g=p(this);if(this.nodeType!==1)return;e?f=a.call(this,d,g.val()):f=a,f==null?f="":typeof f=="number"?f+="":p.isArray(f)&&(f=p.map(f,function(a){return a==null?"":a+""})),c=p.valHooks[this.type]||p.valHooks[this.nodeName.toLowerCase()];if(!c||!("set"in c)||c.set(this,f,"value")===b)this.value=f})}}),p.extend({valHooks:{option:{get:function(a){var b=a.attributes.value;return!b||b.specified?a.value:a.text}},select:{get:function(a){var b,c,d,e,f=a.selectedIndex,g=[],h=a.options,i=a.type==="select-one";if(f<0)return null;c=i?f:0,d=i?f+1:h.length;for(;c<d;c++){e=h[c];if(e.selected&&(p.support.optDisabled?!e.disabled:e.getAttribute("disabled")===null)&&(!e.parentNode.disabled||!p.nodeName(e.parentNode,"optgroup"))){b=p(e).val();if(i)return b;g.push(b)}}return i&&!g.length&&h.length?p(h[f]).val():g},set:function(a,b){var c=p.makeArray(b);return p(a).find("option").each(function(){this.selected=p.inArray(p(this).val(),c)>=0}),c.length||(a.selectedIndex=-1),c}}},attrFn:{},attr:function(a,c,d,e){var f,g,h,i=a.nodeType;if(!a||i===3||i===8||i===2)return;if(e&&p.isFunction(p.fn[c]))return p(a)[c](d);if(typeof a.getAttribute=="undefined")return p.prop(a,c,d);h=i!==1||!p.isXMLDoc(a),h&&(c=c.toLowerCase(),g=p.attrHooks[c]||(T.test(c)?M:L));if(d!==b){if(d===null){p.removeAttr(a,c);return}return g&&"set"in g&&h&&(f=g.set(a,d,c))!==b?f:(a.setAttribute(c,""+d),d)}return g&&"get"in g&&h&&(f=g.get(a,c))!==null?f:(f=a.getAttribute(c),f===null?b:f)},removeAttr:function(a,b){var c,d,e,f,g=0;if(b&&a.nodeType===1){d=b.split(s);for(;g<d.length;g++)e=d[g],e&&(c=p.propFix[e]||e,f=T.test(e),f||p.attr(a,e,""),a.removeAttribute(U?e:c),f&&c in a&&(a[c]=!1))}},attrHooks:{type:{set:function(a,b){if(Q.test(a.nodeName)&&a.parentNode)p.error("type property can't be changed");else if(!p.support.radioValue&&b==="radio"&&p.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}},value:{get:function(a,b){return L&&p.nodeName(a,"button")?L.get(a,b):b in a?a.value:null},set:function(a,b,c){if(L&&p.nodeName(a,"button"))return L.set(a,b,c);a.value=b}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(a,c,d){var e,f,g,h=a.nodeType;if(!a||h===3||h===8||h===2)return;return g=h!==1||!p.isXMLDoc(a),g&&(c=p.propFix[c]||c,f=p.propHooks[c]),d!==b?f&&"set"in f&&(e=f.set(a,d,c))!==b?e:a[c]=d:f&&"get"in f&&(e=f.get(a,c))!==null?e:a[c]},propHooks:{tabIndex:{get:function(a){var c=a.getAttributeNode("tabindex");return c&&c.specified?parseInt(c.value,10):R.test(a.nodeName)||S.test(a.nodeName)&&a.href?0:b}}}}),M={get:function(a,c){var d,e=p.prop(a,c);return e===!0||typeof e!="boolean"&&(d=a.getAttributeNode(c))&&d.nodeValue!==!1?c.toLowerCase():b},set:function(a,b,c){var d;return b===!1?p.removeAttr(a,c):(d=p.propFix[c]||c,d in a&&(a[d]=!0),a.setAttribute(c,c.toLowerCase())),c}},U||(N={name:!0,id:!0,coords:!0},L=p.valHooks.button={get:function(a,c){var d;return d=a.getAttributeNode(c),d&&(N[c]?d.value!=="":d.specified)?d.value:b},set:function(a,b,c){var d=a.getAttributeNode(c);return d||(d=e.createAttribute(c),a.setAttributeNode(d)),d.value=b+""}},p.each(["width","height"],function(a,b){p.attrHooks[b]=p.extend(p.attrHooks[b],{set:function(a,c){if(c==="")return a.setAttribute(b,"auto"),c}})}),p.attrHooks.contenteditable={get:L.get,set:function(a,b,c){b===""&&(b="false"),L.set(a,b,c)}}),p.support.hrefNormalized||p.each(["href","src","width","height"],function(a,c){p.attrHooks[c]=p.extend(p.attrHooks[c],{get:function(a){var d=a.getAttribute(c,2);return d===null?b:d}})}),p.support.style||(p.attrHooks.style={get:function(a){return a.style.cssText.toLowerCase()||b},set:function(a,b){return a.style.cssText=""+b}}),p.support.optSelected||(p.propHooks.selected=p.extend(p.propHooks.selected,{get:function(a){var b=a.parentNode;return b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex),null}})),p.support.enctype||(p.propFix.enctype="encoding"),p.support.checkOn||p.each(["radio","checkbox"],function(){p.valHooks[this]={get:function(a){return a.getAttribute("value")===null?"on":a.value}}}),p.each(["radio","checkbox"],function(){p.valHooks[this]=p.extend(p.valHooks[this],{set:function(a,b){if(p.isArray(b))return a.checked=p.inArray(p(a).val(),b)>=0}})});var V=/^(?:textarea|input|select)$/i,W=/^([^\.]*|)(?:\.(.+)|)$/,X=/(?:^|\s)hover(\.\S+|)\b/,Y=/^key/,Z=/^(?:mouse|contextmenu)|click/,$=/^(?:focusinfocus|focusoutblur)$/,_=function(a){return p.event.special.hover?a:a.replace(X,"mouseenter$1 mouseleave$1")};p.event={add:function(a,c,d,e,f){var g,h,i,j,k,l,m,n,o,q,r;if(a.nodeType===3||a.nodeType===8||!c||!d||!(g=p._data(a)))return;d.handler&&(o=d,d=o.handler,f=o.selector),d.guid||(d.guid=p.guid++),i=g.events,i||(g.events=i={}),h=g.handle,h||(g.handle=h=function(a){return typeof p!="undefined"&&(!a||p.event.triggered!==a.type)?p.event.dispatch.apply(h.elem,arguments):b},h.elem=a),c=p.trim(_(c)).split(" ");for(j=0;j<c.length;j++){k=W.exec(c[j])||[],l=k[1],m=(k[2]||"").split(".").sort(),r=p.event.special[l]||{},l=(f?r.delegateType:r.bindType)||l,r=p.event.special[l]||{},n=p.extend({type:l,origType:k[1],data:e,handler:d,guid:d.guid,selector:f,namespace:m.join(".")},o),q=i[l];if(!q){q=i[l]=[],q.delegateCount=0;if(!r.setup||r.setup.call(a,e,m,h)===!1)a.addEventListener?a.addEventListener(l,h,!1):a.attachEvent&&a.attachEvent("on"+l,h)}r.add&&(r.add.call(a,n),n.handler.guid||(n.handler.guid=d.guid)),f?q.splice(q.delegateCount++,0,n):q.push(n),p.event.global[l]=!0}a=null},global:{},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,q,r=p.hasData(a)&&p._data(a);if(!r||!(m=r.events))return;b=p.trim(_(b||"")).split(" ");for(f=0;f<b.length;f++){g=W.exec(b[f])||[],h=i=g[1],j=g[2];if(!h){for(h in m)p.event.remove(a,h+b[f],c,d,!0);continue}n=p.event.special[h]||{},h=(d?n.delegateType:n.bindType)||h,o=m[h]||[],k=o.length,j=j?new RegExp("(^|\\.)"+j.split(".").sort().join("\\.(?:.*\\.|)")+"(\\.|$)"):null;for(l=0;l<o.length;l++)q=o[l],(e||i===q.origType)&&(!c||c.guid===q.guid)&&(!j||j.test(q.namespace))&&(!d||d===q.selector||d==="**"&&q.selector)&&(o.splice(l--,1),q.selector&&o.delegateCount--,n.remove&&n.remove.call(a,q));o.length===0&&k!==o.length&&((!n.teardown||n.teardown.call(a,j,r.handle)===!1)&&p.removeEvent(a,h,r.handle),delete m[h])}p.isEmptyObject(m)&&(delete r.handle,p.removeData(a,"events",!0))},customEvent:{getData:!0,setData:!0,changeData:!0},trigger:function(c,d,f,g){if(!f||f.nodeType!==3&&f.nodeType!==8){var h,i,j,k,l,m,n,o,q,r,s=c.type||c,t=[];if($.test(s+p.event.triggered))return;s.indexOf("!")>=0&&(s=s.slice(0,-1),i=!0),s.indexOf(".")>=0&&(t=s.split("."),s=t.shift(),t.sort());if((!f||p.event.customEvent[s])&&!p.event.global[s])return;c=typeof c=="object"?c[p.expando]?c:new p.Event(s,c):new p.Event(s),c.type=s,c.isTrigger=!0,c.exclusive=i,c.namespace=t.join("."),c.namespace_re=c.namespace?new RegExp("(^|\\.)"+t.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,m=s.indexOf(":")<0?"on"+s:"";if(!f){h=p.cache;for(j in h)h[j].events&&h[j].events[s]&&p.event.trigger(c,d,h[j].handle.elem,!0);return}c.result=b,c.target||(c.target=f),d=d!=null?p.makeArray(d):[],d.unshift(c),n=p.event.special[s]||{};if(n.trigger&&n.trigger.apply(f,d)===!1)return;q=[[f,n.bindType||s]];if(!g&&!n.noBubble&&!p.isWindow(f)){r=n.delegateType||s,k=$.test(r+s)?f:f.parentNode;for(l=f;k;k=k.parentNode)q.push([k,r]),l=k;l===(f.ownerDocument||e)&&q.push([l.defaultView||l.parentWindow||a,r])}for(j=0;j<q.length&&!c.isPropagationStopped();j++)k=q[j][0],c.type=q[j][1],o=(p._data(k,"events")||{})[c.type]&&p._data(k,"handle"),o&&o.apply(k,d),o=m&&k[m],o&&p.acceptData(k)&&o.apply(k,d)===!1&&c.preventDefault();return c.type=s,!g&&!c.isDefaultPrevented()&&(!n._default||n._default.apply(f.ownerDocument,d)===!1)&&(s!=="click"||!p.nodeName(f,"a"))&&p.acceptData(f)&&m&&f[s]&&(s!=="focus"&&s!=="blur"||c.target.offsetWidth!==0)&&!p.isWindow(f)&&(l=f[m],l&&(f[m]=null),p.event.triggered=s,f[s](),p.event.triggered=b,l&&(f[m]=l)),c.result}return},dispatch:function(c){c=p.event.fix(c||a.event);var d,e,f,g,h,i,j,k,l,m,n,o=(p._data(this,"events")||{})[c.type]||[],q=o.delegateCount,r=[].slice.call(arguments),s=!c.exclusive&&!c.namespace,t=p.event.special[c.type]||{},u=[];r[0]=c,c.delegateTarget=this;if(t.preDispatch&&t.preDispatch.call(this,c)===!1)return;if(q&&(!c.button||c.type!=="click")){g=p(this),g.context=this;for(f=c.target;f!=this;f=f.parentNode||this)if(f.disabled!==!0||c.type!=="click"){i={},k=[],g[0]=f;for(d=0;d<q;d++)l=o[d],m=l.selector,i[m]===b&&(i[m]=g.is(m)),i[m]&&k.push(l);k.length&&u.push({elem:f,matches:k})}}o.length>q&&u.push({elem:this,matches:o.slice(q)});for(d=0;d<u.length&&!c.isPropagationStopped();d++){j=u[d],c.currentTarget=j.elem;for(e=0;e<j.matches.length&&!c.isImmediatePropagationStopped();e++){l=j.matches[e];if(s||!c.namespace&&!l.namespace||c.namespace_re&&c.namespace_re.test(l.namespace))c.data=l.data,c.handleObj=l,h=((p.event.special[l.origType]||{}).handle||l.handler).apply(j.elem,r),h!==b&&(c.result=h,h===!1&&(c.preventDefault(),c.stopPropagation()))}}return t.postDispatch&&t.postDispatch.call(this,c),c.result},props:"attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return a.which==null&&(a.which=b.charCode!=null?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,c){var d,f,g,h=c.button,i=c.fromElement;return a.pageX==null&&c.clientX!=null&&(d=a.target.ownerDocument||e,f=d.documentElement,g=d.body,a.pageX=c.clientX+(f&&f.scrollLeft||g&&g.scrollLeft||0)-(f&&f.clientLeft||g&&g.clientLeft||0),a.pageY=c.clientY+(f&&f.scrollTop||g&&g.scrollTop||0)-(f&&f.clientTop||g&&g.clientTop||0)),!a.relatedTarget&&i&&(a.relatedTarget=i===a.target?c.toElement:i),!a.which&&h!==b&&(a.which=h&1?1:h&2?3:h&4?2:0),a}},fix:function(a){if(a[p.expando])return a;var b,c,d=a,f=p.event.fixHooks[a.type]||{},g=f.props?this.props.concat(f.props):this.props;a=p.Event(d);for(b=g.length;b;)c=g[--b],a[c]=d[c];return a.target||(a.target=d.srcElement||e),a.target.nodeType===3&&(a.target=a.target.parentNode),a.metaKey=!!a.metaKey,f.filter?f.filter(a,d):a},special:{ready:{setup:p.bindReady},load:{noBubble:!0},focus:{delegateType:"focusin"},blur:{delegateType:"focusout"},beforeunload:{setup:function(a,b,c){p.isWindow(this)&&(this.onbeforeunload=c)},teardown:function(a,b){this.onbeforeunload===b&&(this.onbeforeunload=null)}}},simulate:function(a,b,c,d){var e=p.extend(new p.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?p.event.trigger(e,null,b):p.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},p.event.handle=p.event.dispatch,p.removeEvent=e.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)}:function(a,b,c){var d="on"+b;a.detachEvent&&(typeof a[d]=="undefined"&&(a[d]=null),a.detachEvent(d,c))},p.Event=function(a,b){if(this instanceof p.Event)a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||a.returnValue===!1||a.getPreventDefault&&a.getPreventDefault()?bb:ba):this.type=a,b&&p.extend(this,b),this.timeStamp=a&&a.timeStamp||p.now(),this[p.expando]=!0;else return new p.Event(a,b)},p.Event.prototype={preventDefault:function(){this.isDefaultPrevented=bb;var a=this.originalEvent;if(!a)return;a.preventDefault?a.preventDefault():a.returnValue=!1},stopPropagation:function(){this.isPropagationStopped=bb;var a=this.originalEvent;if(!a)return;a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=bb,this.stopPropagation()},isDefaultPrevented:ba,isPropagationStopped:ba,isImmediatePropagationStopped:ba},p.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){p.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj,g=f.selector;if(!e||e!==d&&!p.contains(d,e))a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b;return c}}}),p.support.submitBubbles||(p.event.special.submit={setup:function(){if(p.nodeName(this,"form"))return!1;p.event.add(this,"click._submit keypress._submit",function(a){var c=a.target,d=p.nodeName(c,"input")||p.nodeName(c,"button")?c.form:b;d&&!p._data(d,"_submit_attached")&&(p.event.add(d,"submit._submit",function(a){a._submit_bubble=!0}),p._data(d,"_submit_attached",!0))})},postDispatch:function(a){a._submit_bubble&&(delete a._submit_bubble,this.parentNode&&!a.isTrigger&&p.event.simulate("submit",this.parentNode,a,!0))},teardown:function(){if(p.nodeName(this,"form"))return!1;p.event.remove(this,"._submit")}}),p.support.changeBubbles||(p.event.special.change={setup:function(){if(V.test(this.nodeName)){if(this.type==="checkbox"||this.type==="radio")p.event.add(this,"propertychange._change",function(a){a.originalEvent.propertyName==="checked"&&(this._just_changed=!0)}),p.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1),p.event.simulate("change",this,a,!0)});return!1}p.event.add(this,"beforeactivate._change",function(a){var b=a.target;V.test(b.nodeName)&&!p._data(b,"_change_attached")&&(p.event.add(b,"change._change",function(a){this.parentNode&&!a.isSimulated&&!a.isTrigger&&p.event.simulate("change",this.parentNode,a,!0)}),p._data(b,"_change_attached",!0))})},handle:function(a){var b=a.target;if(this!==b||a.isSimulated||a.isTrigger||b.type!=="radio"&&b.type!=="checkbox")return a.handleObj.handler.apply(this,arguments)},teardown:function(){return p.event.remove(this,"._change"),V.test(this.nodeName)}}),p.support.focusinBubbles||p.each({focus:"focusin",blur:"focusout"},function(a,b){var c=0,d=function(a){p.event.simulate(b,a.target,p.event.fix(a),!0)};p.event.special[b]={setup:function(){c++===0&&e.addEventListener(a,d,!0)},teardown:function(){--c===0&&e.removeEventListener(a,d,!0)}}}),p.fn.extend({on:function(a,c,d,e,f){var g,h;if(typeof a=="object"){typeof c!="string"&&(d=d||c,c=b);for(h in a)this.on(h,c,d,a[h],f);return this}d==null&&e==null?(e=c,d=c=b):e==null&&(typeof c=="string"?(e=d,d=b):(e=d,d=c,c=b));if(e===!1)e=ba;else if(!e)return this;return f===1&&(g=e,e=function(a){return p().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=p.guid++)),this.each(function(){p.event.add(this,a,e,d,c)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,c,d){var e,f;if(a&&a.preventDefault&&a.handleObj)return e=a.handleObj,p(a.delegateTarget).off(e.namespace?e.origType+"."+e.namespace:e.origType,e.selector,e.handler),this;if(typeof a=="object"){for(f in a)this.off(f,c,a[f]);return this}if(c===!1||typeof c=="function")d=c,c=b;return d===!1&&(d=ba),this.each(function(){p.event.remove(this,a,d,c)})},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},live:function(a,b,c){return p(this.context).on(a,this.selector,b,c),this},die:function(a,b){return p(this.context).off(a,this.selector||"**",b),this},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return arguments.length==1?this.off(a,"**"):this.off(b,a||"**",c)},trigger:function(a,b){return this.each(function(){p.event.trigger(a,b,this)})},triggerHandler:function(a,b){if(this[0])return p.event.trigger(a,b,this[0],!0)},toggle:function(a){var b=arguments,c=a.guid||p.guid++,d=0,e=function(c){var e=(p._data(this,"lastToggle"+a.guid)||0)%d;return p._data(this,"lastToggle"+a.guid,e+1),c.preventDefault(),b[e].apply(this,arguments)||!1};e.guid=c;while(d<b.length)b[d++].guid=c;return this.click(e)},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),p.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){p.fn[b]=function(a,c){return c==null&&(c=a,a=null),arguments.length>0?this.on(b,null,a,c):this.trigger(b)},Y.test(b)&&(p.event.fixHooks[b]=p.event.keyHooks),Z.test(b)&&(p.event.fixHooks[b]=p.event.mouseHooks)}),function(a,b){function bd(a,b,c,d){var e=0,f=b.length;for(;e<f;e++)Z(a,b[e],c,d)}function be(a,b,c,d,e,f){var g,h=$.setFilters[b.toLowerCase()];return h||Z.error(b),(a||!(g=e))&&bd(a||"*",d,g=[],e),g.length>0?h(g,c,f):[]}function bf(a,c,d,e,f){var g,h,i,j,k,l,m,n,p=0,q=f.length,s=L.POS,t=new RegExp("^"+s.source+"(?!"+r+")","i"),u=function(){var a=1,c=arguments.length-2;for(;a<c;a++)arguments[a]===b&&(g[a]=b)};for(;p<q;p++){s.exec(""),a=f[p],j=[],i=0,k=e;while(g=s.exec(a)){n=s.lastIndex=g.index+g[0].length;if(n>i){m=a.slice(i,g.index),i=n,l=[c],B.test(m)&&(k&&(l=k),k=e);if(h=H.test(m))m=m.slice(0,-5).replace(B,"$&*");g.length>1&&g[0].replace(t,u),k=be(m,g[1],g[2],l,k,h)}}k?(j=j.concat(k),(m=a.slice(i))&&m!==")"?B.test(m)?bd(m,j,d,e):Z(m,c,d,e?e.concat(k):k):o.apply(d,j)):Z(a,c,d,e)}return q===1?d:Z.uniqueSort(d)}function bg(a,b,c){var d,e,f,g=[],i=0,j=D.exec(a),k=!j.pop()&&!j.pop(),l=k&&a.match(C)||[""],m=$.preFilter,n=$.filter,o=!c&&b!==h;for(;(e=l[i])!=null&&k;i++){g.push(d=[]),o&&(e=" "+e);while(e){k=!1;if(j=B.exec(e))e=e.slice(j[0].length),k=d.push({part:j.pop().replace(A," "),captures:j});for(f in n)(j=L[f].exec(e))&&(!m[f]||(j=m[f](j,b,c)))&&(e=e.slice(j.shift().length),k=d.push({part:f,captures:j}));if(!k)break}}return k||Z.error(a),g}function bh(a,b,e){var f=b.dir,g=m++;return a||(a=function(a){return a===e}),b.first?function(b,c){while(b=b[f])if(b.nodeType===1)return a(b,c)&&b}:function(b,e){var h,i=g+"."+d,j=i+"."+c;while(b=b[f])if(b.nodeType===1){if((h=b[q])===j)return b.sizset;if(typeof h=="string"&&h.indexOf(i)===0){if(b.sizset)return b}else{b[q]=j;if(a(b,e))return b.sizset=!0,b;b.sizset=!1}}}}function bi(a,b){return a?function(c,d){var e=b(c,d);return e&&a(e===!0?c:e,d)}:b}function bj(a,b,c){var d,e,f=0;for(;d=a[f];f++)$.relative[d.part]?e=bh(e,$.relative[d.part],b):(d.captures.push(b,c),e=bi(e,$.filter[d.part].apply(null,d.captures)));return e}function bk(a){return function(b,c){var d,e=0;for(;d=a[e];e++)if(d(b,c))return!0;return!1}}var c,d,e,f,g,h=a.document,i=h.documentElement,j="undefined",k=!1,l=!0,m=0,n=[].slice,o=[].push,q=("sizcache"+Math.random()).replace(".",""),r="[\\x20\\t\\r\\n\\f]",s="(?:\\\\.|[-\\w]|[^\\x00-\\xa0])+",t=s.replace("w","w#"),u="([*^$|!~]?=)",v="\\["+r+"*("+s+")"+r+"*(?:"+u+r+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+t+")|)|)"+r+"*\\]",w=":("+s+")(?:\\((?:(['\"])((?:\\\\.|[^\\\\])*?)\\2|((?:[^,]|\\\\,|(?:,(?=[^\\[]*\\]))|(?:,(?=[^\\(]*\\))))*))\\)|)",x=":(nth|eq|gt|lt|first|last|even|odd)(?:\\((\\d*)\\)|)(?=[^-]|$)",y=r+"*([\\x20\\t\\r\\n\\f>+~])"+r+"*",z="(?=[^\\x20\\t\\r\\n\\f])(?:\\\\.|"+v+"|"+w.replace(2,7)+"|[^\\\\(),])+",A=new RegExp("^"+r+"+|((?:^|[^\\\\])(?:\\\\.)*)"+r+"+$","g"),B=new RegExp("^"+y),C=new RegExp(z+"?(?="+r+"*,|$)","g"),D=new RegExp("^(?:(?!,)(?:(?:^|,)"+r+"*"+z+")*?|"+r+"*(.*?))(\\)|$)"),E=new RegExp(z.slice(19,-6)+"\\x20\\t\\r\\n\\f>+~])+|"+y,"g"),F=/^(?:#([\w\-]+)|(\w+)|\.([\w\-]+))$/,G=/[\x20\t\r\n\f]*[+~]/,H=/:not\($/,I=/h\d/i,J=/input|select|textarea|button/i,K=/\\(?!\\)/g,L={ID:new RegExp("^#("+s+")"),CLASS:new RegExp("^\\.("+s+")"),NAME:new RegExp("^\\[name=['\"]?("+s+")['\"]?\\]"),TAG:new RegExp("^("+s.replace("[-","[-\\*")+")"),ATTR:new RegExp("^"+v),PSEUDO:new RegExp("^"+w),CHILD:new RegExp("^:(only|nth|last|first)-child(?:\\("+r+"*(even|odd|(([+-]|)(\\d*)n|)"+r+"*(?:([+-]|)"+r+"*(\\d+)|))"+r+"*\\)|)","i"),POS:new RegExp(x,"ig"),needsContext:new RegExp("^"+r+"*[>+~]|"+x,"i")},M={},N=[],O={},P=[],Q=function(a){return a.sizzleFilter=!0,a},R=function(a){return function(b){return b.nodeName.toLowerCase()==="input"&&b.type===a}},S=function(a){return function(b){var c=b.nodeName.toLowerCase();return(c==="input"||c==="button")&&b.type===a}},T=function(a){var b=!1,c=h.createElement("div");try{b=a(c)}catch(d){}return c=null,b},U=T(function(a){a.innerHTML="<select></select>";var b=typeof a.lastChild.getAttribute("multiple");return b!=="boolean"&&b!=="string"}),V=T(function(a){a.id=q+0,a.innerHTML="<a name='"+q+"'></a><div name='"+q+"'></div>",i.insertBefore(a,i.firstChild);var b=h.getElementsByName&&h.getElementsByName(q).length===2+h.getElementsByName(q+0).length;return g=!h.getElementById(q),i.removeChild(a),b}),W=T(function(a){return a.appendChild(h.createComment("")),a.getElementsByTagName("*").length===0}),X=T(function(a){return a.innerHTML="<a href='#'></a>",a.firstChild&&typeof a.firstChild.getAttribute!==j&&a.firstChild.getAttribute("href")==="#"}),Y=T(function(a){return a.innerHTML="<div class='hidden e'></div><div class='hidden'></div>",!a.getElementsByClassName||a.getElementsByClassName("e").length===0?!1:(a.lastChild.className="e",a.getElementsByClassName("e").length!==1)}),Z=function(a,b,c,d){c=c||[],b=b||h;var e,f,g,i,j=b.nodeType;if(j!==1&&j!==9)return[];if(!a||typeof a!="string")return c;g=ba(b);if(!g&&!d)if(e=F.exec(a))if(i=e[1]){if(j===9){f=b.getElementById(i);if(!f||!f.parentNode)return c;if(f.id===i)return c.push(f),c}else if(b.ownerDocument&&(f=b.ownerDocument.getElementById(i))&&bb(b,f)&&f.id===i)return c.push(f),c}else{if(e[2])return o.apply(c,n.call(b.getElementsByTagName(a),0)),c;if((i=e[3])&&Y&&b.getElementsByClassName)return o.apply(c,n.call(b.getElementsByClassName(i),0)),c}return bm(a,b,c,d,g)},$=Z.selectors={cacheLength:50,match:L,order:["ID","TAG"],attrHandle:{},createPseudo:Q,find:{ID:g?function(a,b,c){if(typeof b.getElementById!==j&&!c){var d=b.getElementById(a);return d&&d.parentNode?[d]:[]}}:function(a,c,d){if(typeof c.getElementById!==j&&!d){var e=c.getElementById(a);return e?e.id===a||typeof e.getAttributeNode!==j&&e.getAttributeNode("id").value===a?[e]:b:[]}},TAG:W?function(a,b){if(typeof b.getElementsByTagName!==j)return b.getElementsByTagName(a)}:function(a,b){var c=b.getElementsByTagName(a);if(a==="*"){var d,e=[],f=0;for(;d=c[f];f++)d.nodeType===1&&e.push(d);return e}return c}},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(K,""),a[3]=(a[4]||a[5]||"").replace(K,""),a[2]==="~="&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),a[1]==="nth"?(a[2]||Z.error(a[0]),a[3]=+(a[3]?a[4]+(a[5]||1):2*(a[2]==="even"||a[2]==="odd")),a[4]=+(a[6]+a[7]||a[2]==="odd")):a[2]&&Z.error(a[0]),a},PSEUDO:function(a){var b,c=a[4];return L.CHILD.test(a[0])?null:(c&&(b=D.exec(c))&&b.pop()&&(a[0]=a[0].slice(0,b[0].length-c.length-1),c=b[0].slice(0,-1)),a.splice(2,3,c||a[3]),a)}},filter:{ID:g?function(a){return a=a.replace(K,""),function(b){return b.getAttribute("id")===a}}:function(a){return a=a.replace(K,""),function(b){var c=typeof b.getAttributeNode!==j&&b.getAttributeNode("id");return c&&c.value===a}},TAG:function(a){return a==="*"?function(){return!0}:(a=a.replace(K,"").toLowerCase(),function(b){return b.nodeName&&b.nodeName.toLowerCase()===a})},CLASS:function(a){var b=M[a];return b||(b=M[a]=new RegExp("(^|"+r+")"+a+"("+r+"|$)"),N.push(a),N.length>$.cacheLength&&delete M[N.shift()]),function(a){return b.test(a.className||typeof a.getAttribute!==j&&a.getAttribute("class")||"")}},ATTR:function(a,b,c){return b?function(d){var e=Z.attr(d,a),f=e+"";if(e==null)return b==="!=";switch(b){case"=":return f===c;case"!=":return f!==c;case"^=":return c&&f.indexOf(c)===0;case"*=":return c&&f.indexOf(c)>-1;case"$=":return c&&f.substr(f.length-c.length)===c;case"~=":return(" "+f+" ").indexOf(c)>-1;case"|=":return f===c||f.substr(0,c.length+1)===c+"-"}}:function(b){return Z.attr(b,a)!=null}},CHILD:function(a,b,c,d){if(a==="nth"){var e=m++;return function(a){var b,f,g=0,h=a;if(c===1&&d===0)return!0;b=a.parentNode;if(b&&(b[q]!==e||!a.sizset)){for(h=b.firstChild;h;h=h.nextSibling)if(h.nodeType===1){h.sizset=++g;if(h===a)break}b[q]=e}return f=a.sizset-d,c===0?f===0:f%c===0&&f/c>=0}}return function(b){var c=b;switch(a){case"only":case"first":while(c=c.previousSibling)if(c.nodeType===1)return!1;if(a==="first")return!0;c=b;case"last":while(c=c.nextSibling)if(c.nodeType===1)return!1;return!0}}},PSEUDO:function(a,b,c,d){var e=$.pseudos[a]||$.pseudos[a.toLowerCase()];return e||Z.error("unsupported pseudo: "+a),e.sizzleFilter?e(b,c,d):e}},pseudos:{not:Q(function(a,b,c){var d=bl(a.replace(A,"$1"),b,c);return function(a){return!d(a)}}),enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&!!a.checked||b==="option"&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},parent:function(a){return!$.pseudos.empty(a)},empty:function(a){var b;a=a.firstChild;while(a){if(a.nodeName>"@"||(b=a.nodeType)===3||b===4)return!1;a=a.nextSibling}return!0},contains:Q(function(a){return function(b){return(b.textContent||b.innerText||bc(b)).indexOf(a)>-1}}),has:Q(function(a){return function(b){return Z(a,b).length>0}}),header:function(a){return I.test(a.nodeName)},text:function(a){var b,c;return a.nodeName.toLowerCase()==="input"&&(b=a.type)==="text"&&((c=a.getAttribute("type"))==null||c.toLowerCase()===b)},radio:R("radio"),checkbox:R("checkbox"),file:R("file"),password:R("password"),image:R("image"),submit:S("submit"),reset:S("reset"),button:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&a.type==="button"||b==="button"},input:function(a){return J.test(a.nodeName)},focus:function(a){var b=a.ownerDocument;return a===b.activeElement&&(!b.hasFocus||b.hasFocus())&&(!!a.type||!!a.href)},active:function(a){return a===a.ownerDocument.activeElement}},setFilters:{first:function(a,b,c){return c?a.slice(1):[a[0]]},last:function(a,b,c){var d=a.pop();return c?a:[d]},even:function(a,b,c){var d=[],e=c?1:0,f=a.length;for(;e<f;e=e+2)d.push(a[e]);return d},odd:function(a,b,c){var d=[],e=c?0:1,f=a.length;for(;e<f;e=e+2)d.push(a[e]);return d},lt:function(a,b,c){return c?a.slice(+b):a.slice(0,+b)},gt:function(a,b,c){return c?a.slice(0,+b+1):a.slice(+b+1)},eq:function(a,b,c){var d=a.splice(+b,1);return c?a:d}}};$.setFilters.nth=$.setFilters.eq,$.filters=$.pseudos,X||($.attrHandle={href:function(a){return a.getAttribute("href",2)},type:function(a){return a.getAttribute("type")}}),V&&($.order.push("NAME"),$.find.NAME=function(a,b){if(typeof b.getElementsByName!==j)return b.getElementsByName(a)}),Y&&($.order.splice(1,0,"CLASS"),$.find.CLASS=function(a,b,c){if(typeof b.getElementsByClassName!==j&&!c)return b.getElementsByClassName(a)});try{n.call(i.childNodes,0)[0].nodeType}catch(_){n=function(a){var b,c=[];for(;b=this[a];a++)c.push(b);return c}}var ba=Z.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?b.nodeName!=="HTML":!1},bb=Z.contains=i.compareDocumentPosition?function(a,b){return!!(a.compareDocumentPosition(b)&16)}:i.contains?function(a,b){var c=a.nodeType===9?a.documentElement:a,d=b.parentNode;return a===d||!!(d&&d.nodeType===1&&c.contains&&c.contains(d))}:function(a,b){while(b=b.parentNode)if(b===a)return!0;return!1},bc=Z.getText=function(a){var b,c="",d=0,e=a.nodeType;if(e){if(e===1||e===9||e===11){if(typeof a.textContent=="string")return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=bc(a)}else if(e===3||e===4)return a.nodeValue}else for(;b=a[d];d++)c+=bc(b);return c};Z.attr=function(a,b){var c,d=ba(a);return d||(b=b.toLowerCase()),$.attrHandle[b]?$.attrHandle[b](a):U||d?a.getAttribute(b):(c=a.getAttributeNode(b),c?typeof a[b]=="boolean"?a[b]?b:null:c.specified?c.value:null:null)},Z.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},[0,0].sort(function(){return l=0}),i.compareDocumentPosition?e=function(a,b){return a===b?(k=!0,0):(!a.compareDocumentPosition||!b.compareDocumentPosition?a.compareDocumentPosition:a.compareDocumentPosition(b)&4)?-1:1}:(e=function(a,b){if(a===b)return k=!0,0;if(a.sourceIndex&&b.sourceIndex)return a.sourceIndex-b.sourceIndex;var c,d,e=[],g=[],h=a.parentNode,i=b.parentNode,j=h;if(h===i)return f(a,b);if(!h)return-1;if(!i)return 1;while(j)e.unshift(j),j=j.parentNode;j=i;while(j)g.unshift(j),j=j.parentNode;c=e.length,d=g.length;for(var l=0;l<c&&l<d;l++)if(e[l]!==g[l])return f(e[l],g[l]);return l===c?f(a,g[l],-1):f(e[l],b,1)},f=function(a,b,c){if(a===b)return c;var d=a.nextSibling;while(d){if(d===b)return-1;d=d.nextSibling}return 1}),Z.uniqueSort=function(a){var b,c=1;if(e){k=l,a.sort(e);if(k)for(;b=a[c];c++)b===a[c-1]&&a.splice(c--,1)}return a};var bl=Z.compile=function(a,b,c){var d,e,f,g=O[a];if(g&&g.context===b)return g;e=bg(a,b,c);for(f=0;d=e[f];f++)e[f]=bj(d,b,c);return g=O[a]=bk(e),g.context=b,g.runs=g.dirruns=0,P.push(a),P.length>$.cacheLength&&delete O[P.shift()],g};Z.matches=function(a,b){return Z(a,null,null,b)},Z.matchesSelector=function(a,b){return Z(b,null,null,[a]).length>0};var bm=function(a,b,e,f,g){a=a.replace(A,"$1");var h,i,j,k,l,m,p,q,r,s=a.match(C),t=a.match(E),u=b.nodeType;if(L.POS.test(a))return bf(a,b,e,f,s);if(f)h=n.call(f,0);else if(s&&s.length===1){if(t.length>1&&u===9&&!g&&(s=L.ID.exec(t[0]))){b=$.find.ID(s[1],b,g)[0];if(!b)return e;a=a.slice(t.shift().length)}q=(s=G.exec(t[0]))&&!s.index&&b.parentNode||b,r=t.pop(),m=r.split(":not")[0];for(j=0,k=$.order.length;j<k;j++){p=$.order[j];if(s=L[p].exec(m)){h=$.find[p]((s[1]||"").replace(K,""),q,g);if(h==null)continue;m===r&&(a=a.slice(0,a.length-r.length)+m.replace(L[p],""),a||o.apply(e,n.call(h,0)));break}}}if(a){i=bl(a,b,g),d=i.dirruns++,h==null&&(h=$.find.TAG("*",G.test(a)&&b.parentNode||b));for(j=0;l=h[j];j++)c=i.runs++,i(l,b)&&e.push(l)}return e};h.querySelectorAll&&function(){var a,b=bm,c=/'|\\/g,d=/\=[\x20\t\r\n\f]*([^'"\]]*)[\x20\t\r\n\f]*\]/g,e=[],f=[":active"],g=i.matchesSelector||i.mozMatchesSelector||i.webkitMatchesSelector||i.oMatchesSelector||i.msMatchesSelector;T(function(a){a.innerHTML="<select><option selected></option></select>",a.querySelectorAll("[selected]").length||e.push("\\["+r+"*(?:checked|disabled|ismap|multiple|readonly|selected|value)"),a.querySelectorAll(":checked").length||e.push(":checked")}),T(function(a){a.innerHTML="<p test=''></p>",a.querySelectorAll("[test^='']").length&&e.push("[*^$]="+r+"*(?:\"\"|'')"),a.innerHTML="<input type='hidden'>",a.querySelectorAll(":enabled").length||e.push(":enabled",":disabled")}),e=e.length&&new RegExp(e.join("|")),bm=function(a,d,f,g,h){if(!g&&!h&&(!e||!e.test(a)))if(d.nodeType===9)try{return o.apply(f,n.call(d.querySelectorAll(a),0)),f}catch(i){}else if(d.nodeType===1&&d.nodeName.toLowerCase()!=="object"){var j=d.getAttribute("id"),k=j||q,l=G.test(a)&&d.parentNode||d;j?k=k.replace(c,"\\$&"):d.setAttribute("id",k);try{return o.apply(f,n.call(l.querySelectorAll(a.replace(C,"[id='"+k+"'] $&")),0)),f}catch(i){}finally{j||d.removeAttribute("id")}}return b(a,d,f,g,h)},g&&(T(function(b){a=g.call(b,"div");try{g.call(b,"[test!='']:sizzle"),f.push($.match.PSEUDO)}catch(c){}}),f=new RegExp(f.join("|")),Z.matchesSelector=function(b,c){c=c.replace(d,"='$1']");if(!ba(b)&&!f.test(c)&&(!e||!e.test(c)))try{var h=g.call(b,c);if(h||a||b.document&&b.document.nodeType!==11)return h}catch(i){}return Z(c,null,null,[b]).length>0})}(),Z.attr=p.attr,p.find=Z,p.expr=Z.selectors,p.expr[":"]=p.expr.pseudos,p.unique=Z.uniqueSort,p.text=Z.getText,p.isXMLDoc=Z.isXML,p.contains=Z.contains}(a);var bc=/Until$/,bd=/^(?:parents|prev(?:Until|All))/,be=/^.[^:#\[\.,]*$/,bf=p.expr.match.needsContext,bg={children:!0,contents:!0,next:!0,prev:!0};p.fn.extend({find:function(a){var b,c,d,e,f,g,h=this;if(typeof a!="string")return p(a).filter(function(){for(b=0,c=h.length;b<c;b++)if(p.contains(h[b],this))return!0});g=this.pushStack("","find",a);for(b=0,c=this.length;b<c;b++){d=g.length,p.find(a,this[b],g);if(b>0)for(e=d;e<g.length;e++)for(f=0;f<d;f++)if(g[f]===g[e]){g.splice(e--,1);break}}return g},has:function(a){var b,c=p(a,this),d=c.length;return this.filter(function(){for(b=0;b<d;b++)if(p.contains(this,c[b]))return!0})},not:function(a){return this.pushStack(bj(this,a,!1),"not",a)},filter:function(a){return this.pushStack(bj(this,a,!0),"filter",a)},is:function(a){return!!a&&(typeof a=="string"?bf.test(a)?p(a,this.context).index(this[0])>=0:p.filter(a,this).length>0:this.filter(a).length>0)},closest:function(a,b){var c,d=0,e=this.length,f=[],g=bf.test(a)||typeof a!="string"?p(a,b||this.context):0;for(;d<e;d++){c=this[d];while(c&&c.ownerDocument&&c!==b&&c.nodeType!==11){if(g?g.index(c)>-1:p.find.matchesSelector(c,a)){f.push(c);break}c=c.parentNode}}return f=f.length>1?p.unique(f):f,this.pushStack(f,"closest",a)},index:function(a){return a?typeof a=="string"?p.inArray(this[0],p(a)):p.inArray(a.jquery?a[0]:a,this):this[0]&&this[0].parentNode?this.prevAll().length:-1},add:function(a,b){var c=typeof a=="string"?p(a,b):p.makeArray(a&&a.nodeType?[a]:a),d=p.merge(this.get(),c);return this.pushStack(bh(c[0])||bh(d[0])?d:p.unique(d))},addBack:function(a){return this.add(a==null?this.prevObject:this.prevObject.filter(a))}}),p.fn.andSelf=p.fn.addBack,p.each({parent:function(a){var b=a.parentNode;return b&&b.nodeType!==11?b:null},parents:function(a){return p.dir(a,"parentNode")},parentsUntil:function(a,b,c){return p.dir(a,"parentNode",c)},next:function(a){return bi(a,"nextSibling")},prev:function(a){return bi(a,"previousSibling")},nextAll:function(a){return p.dir(a,"nextSibling")},prevAll:function(a){return p.dir(a,"previousSibling")},nextUntil:function(a,b,c){return p.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return p.dir(a,"previousSibling",c)},siblings:function(a){return p.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return p.sibling(a.firstChild)},contents:function(a){return p.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:p.merge([],a.childNodes)}},function(a,b){p.fn[a]=function(c,d){var e=p.map(this,b,c);return bc.test(a)||(d=c),d&&typeof d=="string"&&(e=p.filter(d,e)),e=this.length>1&&!bg[a]?p.unique(e):e,this.length>1&&bd.test(a)&&(e=e.reverse()),this.pushStack(e,a,k.call(arguments).join(","))}}),p.extend({filter:function(a,b,c){return c&&(a=":not("+a+")"),b.length===1?p.find.matchesSelector(b[0],a)?[b[0]]:[]:p.find.matches(a,b)},dir:function(a,c,d){var e=[],f=a[c];while(f&&f.nodeType!==9&&(d===b||f.nodeType!==1||!p(f).is(d)))f.nodeType===1&&e.push(f),f=f[c];return e},sibling:function(a,b){var c=[];for(;a;a=a.nextSibling)a.nodeType===1&&a!==b&&c.push(a);return c}});var bl="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",bm=/ jQuery\d+="(?:null|\d+)"/g,bn=/^\s+/,bo=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,bp=/<([\w:]+)/,bq=/<tbody/i,br=/<|&#?\w+;/,bs=/<(?:script|style|link)/i,bt=/<(?:script|object|embed|option|style)/i,bu=new RegExp("<(?:"+bl+")[\\s/>]","i"),bv=/^(?:checkbox|radio)$/,bw=/checked\s*(?:[^=]|=\s*.checked.)/i,bx=/\/(java|ecma)script/i,by=/^\s*<!(?:\[CDATA\[|\-\-)|[\]\-]{2}>\s*$/g,bz={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]},bA=bk(e),bB=bA.appendChild(e.createElement("div"));bz.optgroup=bz.option,bz.tbody=bz.tfoot=bz.colgroup=bz.caption=bz.thead,bz.th=bz.td,p.support.htmlSerialize||(bz._default=[1,"X<div>","</div>"]),p.fn.extend({text:function(a){return p.access(this,function(a){return a===b?p.text(this):this.empty().append((this[0]&&this[0].ownerDocument||e).createTextNode(a))},null,a,arguments.length)},wrapAll:function(a){if(p.isFunction(a))return this.each(function(b){p(this).wrapAll(a.call(this,b))});if(this[0]){var b=p(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&a.firstChild.nodeType===1)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){return p.isFunction(a)?this.each(function(b){p(this).wrapInner(a.call(this,b))}):this.each(function(){var b=p(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=p.isFunction(a);return this.each(function(c){p(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){p.nodeName(this,"body")||p(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(a){(this.nodeType===1||this.nodeType===11)&&this.appendChild(a)})},prepend:function(){return this.domManip(arguments,!0,function(a){(this.nodeType===1||this.nodeType===11)&&this.insertBefore(a,this.firstChild)})},before:function(){if(!bh(this[0]))return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this)});if(arguments.length){var a=p.clean(arguments);return this.pushStack(p.merge(a,this),"before",this.selector)}},after:function(){if(!bh(this[0]))return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this.nextSibling)});if(arguments.length){var a=p.clean(arguments);return this.pushStack(p.merge(this,a),"after",this.selector)}},remove:function(a,b){var c,d=0;for(;(c=this[d])!=null;d++)if(!a||p.filter(a,[c]).length)!b&&c.nodeType===1&&(p.cleanData(c.getElementsByTagName("*")),p.cleanData([c])),c.parentNode&&c.parentNode.removeChild(c);return this},empty:function(){var a,b=0;for(;(a=this[b])!=null;b++){a.nodeType===1&&p.cleanData(a.getElementsByTagName("*"));while(a.firstChild)a.removeChild(a.firstChild)}return this},clone:function(a,b){return a=a==null?!1:a,b=b==null?a:b,this.map(function(){return p.clone(this,a,b)})},html:function(a){return p.access(this,function(a){var c=this[0]||{},d=0,e=this.length;if(a===b)return c.nodeType===1?c.innerHTML.replace(bm,""):b;if(typeof a=="string"&&!bs.test(a)&&(p.support.htmlSerialize||!bu.test(a))&&(p.support.leadingWhitespace||!bn.test(a))&&!bz[(bp.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(bo,"<$1></$2>");try{for(;d<e;d++)c=this[d]||{},c.nodeType===1&&(p.cleanData(c.getElementsByTagName("*")),c.innerHTML=a);c=0}catch(f){}}c&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(a){return bh(this[0])?this.length?this.pushStack(p(p.isFunction(a)?a():a),"replaceWith",a):this:p.isFunction(a)?this.each(function(b){var c=p(this),d=c.html();c.replaceWith(a.call(this,b,d))}):(typeof a!="string"&&(a=p(a).detach()),this.each(function(){var b=this.nextSibling,c=this.parentNode;p(this).remove(),b?p(b).before(a):p(c).append(a)}))},detach:function(a){return this.remove(a,!0)},domManip:function(a,c,d){a=[].concat.apply([],a);var e,f,g,h,i=0,j=a[0],k=[],l=this.length;if(!p.support.checkClone&&l>1&&typeof j=="string"&&bw.test(j))return this.each(function(){p(this).domManip(a,c,d)});if(p.isFunction(j))return this.each(function(e){var f=p(this);a[0]=j.call(this,e,c?f.html():b),f.domManip(a,c,d)});if(this[0]){e=p.buildFragment(a,this,k),g=e.fragment,f=g.firstChild,g.childNodes.length===1&&(g=f);if(f){c=c&&p.nodeName(f,"tr");for(h=e.cacheable||l-1;i<l;i++)d.call(c&&p.nodeName(this[i],"table")?bC(this[i],"tbody"):this[i],i===h?g:p.clone(g,!0,!0))}g=f=null,k.length&&p.each(k,function(a,b){b.src?p.ajax?p.ajax({url:b.src,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0}):p.error("no ajax"):p.globalEval((b.text||b.textContent||b.innerHTML||"").replace(by,"")),b.parentNode&&b.parentNode.removeChild(b)})}return this}}),p.buildFragment=function(a,c,d){var f,g,h,i=a[0];return c=c||e,c=(c[0]||c).ownerDocument||c[0]||c,typeof c.createDocumentFragment=="undefined"&&(c=e),a.length===1&&typeof i=="string"&&i.length<512&&c===e&&i.charAt(0)==="<"&&!bt.test(i)&&(p.support.checkClone||!bw.test(i))&&(p.support.html5Clone||!bu.test(i))&&(g=!0,f=p.fragments[i],h=f!==b),f||(f=c.createDocumentFragment(),p.clean(a,c,f,d),g&&(p.fragments[i]=h&&f)),{fragment:f,cacheable:g}},p.fragments={},p.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){p.fn[a]=function(c){var d,e=0,f=[],g=p(c),h=g.length,i=this.length===1&&this[0].parentNode;if((i==null||i&&i.nodeType===11&&i.childNodes.length===1)&&h===1)return g[b](this[0]),this;for(;e<h;e++)d=(e>0?this.clone(!0):this).get(),p(g[e])[b](d),f=f.concat(d);return this.pushStack(f,a,g.selector)}}),p.extend({clone:function(a,b,c){var d,e,f,g;p.support.html5Clone||p.isXMLDoc(a)||!bu.test("<"+a.nodeName+">")?g=a.cloneNode(!0):(bB.innerHTML=a.outerHTML,bB.removeChild(g=bB.firstChild));if((!p.support.noCloneEvent||!p.support.noCloneChecked)&&(a.nodeType===1||a.nodeType===11)&&!p.isXMLDoc(a)){bE(a,g),d=bF(a),e=bF(g);for(f=0;d[f];++f)e[f]&&bE(d[f],e[f])}if(b){bD(a,g);if(c){d=bF(a),e=bF(g);for(f=0;d[f];++f)bD(d[f],e[f])}}return d=e=null,g},clean:function(a,b,c,d){var f,g,h,i,j,k,l,m,n,o,q,r,s=0,t=[];if(!b||typeof b.createDocumentFragment=="undefined")b=e;for(g=b===e&&bA;(h=a[s])!=null;s++){typeof h=="number"&&(h+="");if(!h)continue;if(typeof h=="string")if(!br.test(h))h=b.createTextNode(h);else{g=g||bk(b),l=l||g.appendChild(b.createElement("div")),h=h.replace(bo,"<$1></$2>"),i=(bp.exec(h)||["",""])[1].toLowerCase(),j=bz[i]||bz._default,k=j[0],l.innerHTML=j[1]+h+j[2];while(k--)l=l.lastChild;if(!p.support.tbody){m=bq.test(h),n=i==="table"&&!m?l.firstChild&&l.firstChild.childNodes:j[1]==="<table>"&&!m?l.childNodes:[];for(f=n.length-1;f>=0;--f)p.nodeName(n[f],"tbody")&&!n[f].childNodes.length&&n[f].parentNode.removeChild(n[f])}!p.support.leadingWhitespace&&bn.test(h)&&l.insertBefore(b.createTextNode(bn.exec(h)[0]),l.firstChild),h=l.childNodes,l=g.lastChild}h.nodeType?t.push(h):t=p.merge(t,h)}l&&(g.removeChild(l),h=l=g=null);if(!p.support.appendChecked)for(s=0;(h=t[s])!=null;s++)p.nodeName(h,"input")?bG(h):typeof h.getElementsByTagName!="undefined"&&p.grep(h.getElementsByTagName("input"),bG);if(c){q=function(a){if(!a.type||bx.test(a.type))return d?d.push(a.parentNode?a.parentNode.removeChild(a):a):c.appendChild(a)};for(s=0;(h=t[s])!=null;s++)if(!p.nodeName(h,"script")||!q(h))c.appendChild(h),typeof h.getElementsByTagName!="undefined"&&(r=p.grep(p.merge([],h.getElementsByTagName("script")),q),t.splice.apply(t,[s+1,0].concat(r)),s+=r.length)}return t},cleanData:function(a,b){var c,d,e,f,g=0,h=p.expando,i=p.cache,j=p.support.deleteExpando,k=p.event.special;for(;(e=a[g])!=null;g++)if(b||p.acceptData(e)){d=e[h],c=d&&i[d];if(c){if(c.events)for(f in c.events)k[f]?p.event.remove(e,f):p.removeEvent(e,f,c.handle);i[d]&&(delete i[d],j?delete e[h]:e.removeAttribute?e.removeAttribute(h):e[h]=null,p.deletedIds.push(d))}}}}),function(){var a,b;p.uaMatch=function(a){a=a.toLowerCase();var b=/(chrome)[ \/]([\w.]+)/.exec(a)||/(webkit)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||a.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a)||[];return{browser:b[1]||"",version:b[2]||"0"}},a=p.uaMatch(g.userAgent),b={},a.browser&&(b[a.browser]=!0,b.version=a.version),b.webkit&&(b.safari=!0),p.browser=b,p.sub=function(){function a(b,c){return new a.fn.init(b,c)}p.extend(!0,a,this),a.superclass=this,a.fn=a.prototype=this(),a.fn.constructor=a,a.sub=this.sub,a.fn.init=function c(c,d){return d&&d instanceof p&&!(d instanceof a)&&(d=a(d)),p.fn.init.call(this,c,d,b)},a.fn.init.prototype=a.fn;var b=a(e);return a}}();var bH,bI,bJ,bK=/alpha\([^)]*\)/i,bL=/opacity=([^)]*)/,bM=/^(top|right|bottom|left)$/,bN=/^margin/,bO=new RegExp("^("+q+")(.*)$","i"),bP=new RegExp("^("+q+")(?!px)[a-z%]+$","i"),bQ=new RegExp("^([-+])=("+q+")","i"),bR={},bS={position:"absolute",visibility:"hidden",display:"block"},bT={letterSpacing:0,fontWeight:400,lineHeight:1},bU=["Top","Right","Bottom","Left"],bV=["Webkit","O","Moz","ms"],bW=p.fn.toggle;p.fn.extend({css:function(a,c){return p.access(this,function(a,c,d){return d!==b?p.style(a,c,d):p.css(a,c)},a,c,arguments.length>1)},show:function(){return bZ(this,!0)},hide:function(){return bZ(this)},toggle:function(a,b){var c=typeof a=="boolean";return p.isFunction(a)&&p.isFunction(b)?bW.apply(this,arguments):this.each(function(){(c?a:bY(this))?p(this).show():p(this).hide()})}}),p.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=bH(a,"opacity");return c===""?"1":c}}}},cssNumber:{fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":p.support.cssFloat?"cssFloat":"styleFloat"},style:function(a,c,d,e){if(!a||a.nodeType===3||a.nodeType===8||!a.style)return;var f,g,h,i=p.camelCase(c),j=a.style;c=p.cssProps[i]||(p.cssProps[i]=bX(j,i)),h=p.cssHooks[c]||p.cssHooks[i];if(d===b)return h&&"get"in h&&(f=h.get(a,!1,e))!==b?f:j[c];g=typeof d,g==="string"&&(f=bQ.exec(d))&&(d=(f[1]+1)*f[2]+parseFloat(p.css(a,c)),g="number");if(d==null||g==="number"&&isNaN(d))return;g==="number"&&!p.cssNumber[i]&&(d+="px");if(!h||!("set"in h)||(d=h.set(a,d,e))!==b)try{j[c]=d}catch(k){}},css:function(a,c,d,e){var f,g,h,i=p.camelCase(c);return c=p.cssProps[i]||(p.cssProps[i]=bX(a.style,i)),h=p.cssHooks[c]||p.cssHooks[i],h&&"get"in h&&(f=h.get(a,!0,e)),f===b&&(f=bH(a,c)),f==="normal"&&c in bT&&(f=bT[c]),d||e!==b?(g=parseFloat(f),d||p.isNumeric(g)?g||0:f):f},swap:function(a,b,c){var d,e,f={};for(e in b)f[e]=a.style[e],a.style[e]=b[e];d=c.call(a);for(e in b)a.style[e]=f[e];return d}}),a.getComputedStyle?bH=function(a,b){var c,d,e,f,g=getComputedStyle(a,null),h=a.style;return g&&(c=g[b],c===""&&!p.contains(a.ownerDocument.documentElement,a)&&(c=p.style(a,b)),bP.test(c)&&bN.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=c,c=g.width,h.width=d,h.minWidth=e,h.maxWidth=f)),c}:e.documentElement.currentStyle&&(bH=function(a,b){var c,d,e=a.currentStyle&&a.currentStyle[b],f=a.style;return e==null&&f&&f[b]&&(e=f[b]),bP.test(e)&&!bM.test(b)&&(c=f.left,d=a.runtimeStyle&&a.runtimeStyle.left,d&&(a.runtimeStyle.left=a.currentStyle.left),f.left=b==="fontSize"?"1em":e,e=f.pixelLeft+"px",f.left=c,d&&(a.runtimeStyle.left=d)),e===""?"auto":e}),p.each(["height","width"],function(a,b){p.cssHooks[b]={get:function(a,c,d){if(c)return a.offsetWidth!==0||bH(a,"display")!=="none"?ca(a,b,d):p.swap(a,bS,function(){return ca(a,b,d)})},set:function(a,c,d){return b$(a,c,d?b_(a,b,d,p.support.boxSizing&&p.css(a,"boxSizing")==="border-box"):0)}}}),p.support.opacity||(p.cssHooks.opacity={get:function(a,b){return bL.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=p.isNumeric(b)?"alpha(opacity="+b*100+")":"",f=d&&d.filter||c.filter||"";c.zoom=1;if(b>=1&&p.trim(f.replace(bK,""))===""&&c.removeAttribute){c.removeAttribute("filter");if(d&&!d.filter)return}c.filter=bK.test(f)?f.replace(bK,e):f+" "+e}}),p(function(){p.support.reliableMarginRight||(p.cssHooks.marginRight={get:function(a,b){return p.swap(a,{display:"inline-block"},function(){if(b)return bH(a,"marginRight")})}}),!p.support.pixelPosition&&p.fn.position&&p.each(["top","left"],function(a,b){p.cssHooks[b]={get:function(a,c){if(c){var d=bH(a,b);return bP.test(d)?p(a).position()[b]+"px":d}}}})}),p.expr&&p.expr.filters&&(p.expr.filters.hidden=function(a){return a.offsetWidth===0&&a.offsetHeight===0||!p.support.reliableHiddenOffsets&&(a.style&&a.style.display||bH(a,"display"))==="none"},p.expr.filters.visible=function(a){return!p.expr.filters.hidden(a)}),p.each({margin:"",padding:"",border:"Width"},function(a,b){p.cssHooks[a+b]={expand:function(c){var d,e=typeof c=="string"?c.split(" "):[c],f={};for(d=0;d<4;d++)f[a+bU[d]+b]=e[d]||e[d-2]||e[0];return f}},bN.test(a)||(p.cssHooks[a+b].set=b$)});var cc=/%20/g,cd=/\[\]$/,ce=/\r?\n/g,cf=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,cg=/^(?:select|textarea)/i;p.fn.extend({serialize:function(){return p.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?p.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||cg.test(this.nodeName)||cf.test(this.type))}).map(function(a,b){var c=p(this).val();return c==null?null:p.isArray(c)?p.map(c,function(a,c){return{name:b.name,value:a.replace(ce,"\r\n")}}):{name:b.name,value:c.replace(ce,"\r\n")}}).get()}}),p.param=function(a,c){var d,e=[],f=function(a,b){b=p.isFunction(b)?b():b==null?"":b,e[e.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};c===b&&(c=p.ajaxSettings&&p.ajaxSettings.traditional);if(p.isArray(a)||a.jquery&&!p.isPlainObject(a))p.each(a,function(){f(this.name,this.value)});else for(d in a)ch(d,a[d],c,f);return e.join("&").replace(cc,"+")};var ci,cj,ck=/#.*$/,cl=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,cm=/^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,cn=/^(?:GET|HEAD)$/,co=/^\/\//,cp=/\?/,cq=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,cr=/([?&])_=[^&]*/,cs=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,ct=p.fn.load,cu={},cv={},cw=["*/"]+["*"];try{ci=f.href}catch(cx){ci=e.createElement("a"),ci.href="",ci=ci.href}cj=cs.exec(ci.toLowerCase())||[],p.fn.load=function(a,c,d){if(typeof a!="string"&&ct)return ct.apply(this,arguments);if(!this.length)return this;var e,f,g,h=this,i=a.indexOf(" ");return i>=0&&(e=a.slice(i,a.length),a=a.slice(0,i)),p.isFunction(c)?(d=c,c=b):typeof c=="object"&&(f="POST"),p.ajax({url:a,type:f,dataType:"html",data:c,complete:function(a,b){d&&h.each(d,g||[a.responseText,b,a])}}).done(function(a){g=arguments,h.html(e?p("<div>").append(a.replace(cq,"")).find(e):a)}),this},p.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){p.fn[b]=function(a){return this.on(b,a)}}),p.each(["get","post"],function(a,c){p[c]=function(a,d,e,f){return p.isFunction(d)&&(f=f||e,e=d,d=b),p.ajax({type:c,url:a,data:d,success:e,dataType:f})}}),p.extend({getScript:function(a,c){return p.get(a,b,c,"script")},getJSON:function(a,b,c){return p.get(a,b,c,"json")},ajaxSetup:function(a,b){return b?cA(a,p.ajaxSettings):(b=a,a=p.ajaxSettings),cA(a,b),a},ajaxSettings:{url:ci,isLocal:cm.test(cj[1]),global:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",processData:!0,async:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":cw},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":a.String,"text html":!0,"text json":p.parseJSON,"text xml":p.parseXML},flatOptions:{context:!0,url:!0}},ajaxPrefilter:cy(cu),ajaxTransport:cy(cv),ajax:function(a,c){function y(a,c,f,i){var k,s,t,u,w,y=c;if(v===2)return;v=2,h&&clearTimeout(h),g=b,e=i||"",x.readyState=a>0?4:0,f&&(u=cB(l,x,f));if(a>=200&&a<300||a===304)l.ifModified&&(w=x.getResponseHeader("Last-Modified"),w&&(p.lastModified[d]=w),w=x.getResponseHeader("Etag"),w&&(p.etag[d]=w)),a===304?(y="notmodified",k=!0):(k=cC(l,u),y=k.state,s=k.data,t=k.error,k=!t);else{t=y;if(!y||a)y="error",a<0&&(a=0)}x.status=a,x.statusText=""+(c||y),k?o.resolveWith(m,[s,y,x]):o.rejectWith(m,[x,y,t]),x.statusCode(r),r=b,j&&n.trigger("ajax"+(k?"Success":"Error"),[x,l,k?s:t]),q.fireWith(m,[x,y]),j&&(n.trigger("ajaxComplete",[x,l]),--p.active||p.event.trigger("ajaxStop"))}typeof a=="object"&&(c=a,a=b),c=c||{};var d,e,f,g,h,i,j,k,l=p.ajaxSetup({},c),m=l.context||l,n=m!==l&&(m.nodeType||m instanceof p)?p(m):p.event,o=p.Deferred(),q=p.Callbacks("once memory"),r=l.statusCode||{},t={},u={},v=0,w="canceled",x={readyState:0,setRequestHeader:function(a,b){if(!v){var c=a.toLowerCase();a=u[c]=u[c]||a,t[a]=b}return this},getAllResponseHeaders:function(){return v===2?e:null},getResponseHeader:function(a){var c;if(v===2){if(!f){f={};while(c=cl.exec(e))f[c[1].toLowerCase()]=c[2]}c=f[a.toLowerCase()]}return c===b?null:c},overrideMimeType:function(a){return v||(l.mimeType=a),this},abort:function(a){return a=a||w,g&&g.abort(a),y(0,a),this}};o.promise(x),x.success=x.done,x.error=x.fail,x.complete=q.add,x.statusCode=function(a){if(a){var b;if(v<2)for(b in a)r[b]=[r[b],a[b]];else b=a[x.status],x.always(b)}return this},l.url=((a||l.url)+"").replace(ck,"").replace(co,cj[1]+"//"),l.dataTypes=p.trim(l.dataType||"*").toLowerCase().split(s),l.crossDomain==null&&(i=cs.exec(l.url.toLowerCase()),l.crossDomain=!(!i||i[1]==cj[1]&&i[2]==cj[2]&&(i[3]||(i[1]==="http:"?80:443))==(cj[3]||(cj[1]==="http:"?80:443)))),l.data&&l.processData&&typeof l.data!="string"&&(l.data=p.param(l.data,l.traditional)),cz(cu,l,c,x);if(v===2)return x;j=l.global,l.type=l.type.toUpperCase(),l.hasContent=!cn.test(l.type),j&&p.active++===0&&p.event.trigger("ajaxStart");if(!l.hasContent){l.data&&(l.url+=(cp.test(l.url)?"&":"?")+l.data,delete l.data),d=l.url;if(l.cache===!1){var z=p.now(),A=l.url.replace(cr,"$1_="+z);l.url=A+(A===l.url?(cp.test(l.url)?"&":"?")+"_="+z:"")}}(l.data&&l.hasContent&&l.contentType!==!1||c.contentType)&&x.setRequestHeader("Content-Type",l.contentType),l.ifModified&&(d=d||l.url,p.lastModified[d]&&x.setRequestHeader("If-Modified-Since",p.lastModified[d]),p.etag[d]&&x.setRequestHeader("If-None-Match",p.etag[d])),x.setRequestHeader("Accept",l.dataTypes[0]&&l.accepts[l.dataTypes[0]]?l.accepts[l.dataTypes[0]]+(l.dataTypes[0]!=="*"?", "+cw+"; q=0.01":""):l.accepts["*"]);for(k in l.headers)x.setRequestHeader(k,l.headers[k]);if(!l.beforeSend||l.beforeSend.call(m,x,l)!==!1&&v!==2){w="abort";for(k in{success:1,error:1,complete:1})x[k](l[k]);g=cz(cv,l,c,x);if(!g)y(-1,"No Transport");else{x.readyState=1,j&&n.trigger("ajaxSend",[x,l]),l.async&&l.timeout>0&&(h=setTimeout(function(){x.abort("timeout")},l.timeout));try{v=1,g.send(t,y)}catch(B){if(v<2)y(-1,B);else throw B}}return x}return x.abort()},active:0,lastModified:{},etag:{}});var cD=[],cE=/\?/,cF=/(=)\?(?=&|$)|\?\?/,cG=p.now();p.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=cD.pop()||p.expando+"_"+cG++;return this[a]=!0,a}}),p.ajaxPrefilter("json jsonp",function(c,d,e){var f,g,h,i=c.data,j=c.url,k=c.jsonp!==!1,l=k&&cF.test(j),m=k&&!l&&typeof i=="string"&&!(c.contentType||"").indexOf("application/x-www-form-urlencoded")&&cF.test(i);if(c.dataTypes[0]==="jsonp"||l||m)return f=c.jsonpCallback=p.isFunction(c.jsonpCallback)?c.jsonpCallback():c.jsonpCallback,g=a[f],l?c.url=j.replace(cF,"$1"+f):m?c.data=i.replace(cF,"$1"+f):k&&(c.url+=(cE.test(j)?"&":"?")+c.jsonp+"="+f),c.converters["script json"]=function(){return h||p.error(f+" was not called"),h[0]},c.dataTypes[0]="json",a[f]=function(){h=arguments},e.always(function(){a[f]=g,c[f]&&(c.jsonpCallback=d.jsonpCallback,cD.push(f)),h&&p.isFunction(g)&&g(h[0]),h=g=b}),"script"}),p.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(a){return p.globalEval(a),a}}}),p.ajaxPrefilter("script",function(a){a.cache===b&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),p.ajaxTransport("script",function(a){if(a.crossDomain){var c,d=e.head||e.getElementsByTagName("head")[0]||e.documentElement;return{send:function(f,g){c=e.createElement("script"),c.async="async",a.scriptCharset&&(c.charset=a.scriptCharset),c.src=a.url,c.onload=c.onreadystatechange=function(a,e){if(e||!c.readyState||/loaded|complete/.test(c.readyState))c.onload=c.onreadystatechange=null,d&&c.parentNode&&d.removeChild(c),c=b,e||g(200,"success")},d.insertBefore(c,d.firstChild)},abort:function(){c&&c.onload(0,1)}}}});var cH,cI=a.ActiveXObject?function(){for(var a in cH)cH[a](0,1)}:!1,cJ=0;p.ajaxSettings.xhr=a.ActiveXObject?function(){return!this.isLocal&&cK()||cL()}:cK,function(a){p.extend(p.support,{ajax:!!a,cors:!!a&&"withCredentials"in a})}(p.ajaxSettings.xhr()),p.support.ajax&&p.ajaxTransport(function(c){if(!c.crossDomain||p.support.cors){var d;return{send:function(e,f){var g,h,i=c.xhr();c.username?i.open(c.type,c.url,c.async,c.username,c.password):i.open(c.type,c.url,c.async);if(c.xhrFields)for(h in c.xhrFields)i[h]=c.xhrFields[h];c.mimeType&&i.overrideMimeType&&i.overrideMimeType(c.mimeType),!c.crossDomain&&!e["X-Requested-With"]&&(e["X-Requested-With"]="XMLHttpRequest");try{for(h in e)i.setRequestHeader(h,e[h])}catch(j){}i.send(c.hasContent&&c.data||null),d=function(a,e){var h,j,k,l,m;try{if(d&&(e||i.readyState===4)){d=b,g&&(i.onreadystatechange=p.noop,cI&&delete cH[g]);if(e)i.readyState!==4&&i.abort();else{h=i.status,k=i.getAllResponseHeaders(),l={},m=i.responseXML,m&&m.documentElement&&(l.xml=m);try{l.text=i.responseText}catch(a){}try{j=i.statusText}catch(n){j=""}!h&&c.isLocal&&!c.crossDomain?h=l.text?200:404:h===1223&&(h=204)}}}catch(o){e||f(-1,o)}l&&f(h,j,l,k)},c.async?i.readyState===4?setTimeout(d,0):(g=++cJ,cI&&(cH||(cH={},p(a).unload(cI)),cH[g]=d),i.onreadystatechange=d):d()},abort:function(){d&&d(0,1)}}}});var cM,cN,cO=/^(?:toggle|show|hide)$/,cP=new RegExp("^(?:([-+])=|)("+q+")([a-z%]*)$","i"),cQ=/queueHooks$/,cR=[cX],cS={"*":[function(a,b){var c,d,e,f=this.createTween(a,b),g=cP.exec(b),h=f.cur(),i=+h||0,j=1;if(g){c=+g[2],d=g[3]||(p.cssNumber[a]?"":"px");if(d!=="px"&&i){i=p.css(f.elem,a,!0)||c||1;do e=j=j||".5",i=i/j,p.style(f.elem,a,i+d),j=f.cur()/h;while(j!==1&&j!==e)}f.unit=d,f.start=i,f.end=g[1]?i+(g[1]+1)*c:c}return f}]};p.Animation=p.extend(cV,{tweener:function(a,b){p.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");var c,d=0,e=a.length;for(;d<e;d++)c=a[d],cS[c]=cS[c]||[],cS[c].unshift(b)},prefilter:function(a,b){b?cR.unshift(a):cR.push(a)}}),p.Tween=cY,cY.prototype={constructor:cY,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||"swing",this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(p.cssNumber[c]?"":"px")},cur:function(){var a=cY.propHooks[this.prop];return a&&a.get?a.get(this):cY.propHooks._default.get(this)},run:function(a){var b,c=cY.propHooks[this.prop];return this.pos=b=p.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration),this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):cY.propHooks._default.set(this),this}},cY.prototype.init.prototype=cY.prototype,cY.propHooks={_default:{get:function(a){var b;return a.elem[a.prop]==null||!!a.elem.style&&a.elem.style[a.prop]!=null?(b=p.css(a.elem,a.prop,!1,""),!b||b==="auto"?0:b):a.elem[a.prop]},set:function(a){p.fx.step[a.prop]?p.fx.step[a.prop](a):a.elem.style&&(a.elem.style[p.cssProps[a.prop]]!=null||p.cssHooks[a.prop])?p.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},cY.propHooks.scrollTop=cY.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},p.each(["toggle","show","hide"],function(a,b){var c=p.fn[b];p.fn[b]=function(d,e,f){return d==null||typeof d=="boolean"||!a&&p.isFunction(d)&&p.isFunction(e)?c.apply(this,arguments):this.animate(cZ(b,!0),d,e,f)}}),p.fn.extend({fadeTo:function(a,b,c,d){return this.filter(bY).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=p.isEmptyObject(a),f=p.speed(b,c,d),g=function(){var b=cV(this,p.extend({},a),f);e&&b.stop(!0)};return e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,c,d){var e=function(a){var b=a.stop;delete a.stop,b(d)};return typeof a!="string"&&(d=c,c=a,a=b),c&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,c=a!=null&&a+"queueHooks",f=p.timers,g=p._data(this);if(c)g[c]&&g[c].stop&&e(g[c]);else for(c in g)g[c]&&g[c].stop&&cQ.test(c)&&e(g[c]);for(c=f.length;c--;)f[c].elem===this&&(a==null||f[c].queue===a)&&(f[c].anim.stop(d),b=!1,f.splice(c,1));(b||!d)&&p.dequeue(this,a)})}}),p.each({slideDown:cZ("show"),slideUp:cZ("hide"),slideToggle:cZ("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){p.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),p.speed=function(a,b,c){var d=a&&typeof a=="object"?p.extend({},a):{complete:c||!c&&b||p.isFunction(a)&&a,duration:a,easing:c&&b||b&&!p.isFunction(b)&&b};d.duration=p.fx.off?0:typeof d.duration=="number"?d.duration:d.duration in p.fx.speeds?p.fx.speeds[d.duration]:p.fx.speeds._default;if(d.queue==null||d.queue===!0)d.queue="fx";return d.old=d.complete,d.complete=function(){p.isFunction(d.old)&&d.old.call(this),d.queue&&p.dequeue(this,d.queue)},d},p.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},p.timers=[],p.fx=cY.prototype.init,p.fx.tick=function(){var a,b=p.timers,c=0;for(;c<b.length;c++)a=b[c],!a()&&b[c]===a&&b.splice(c--,1);b.length||p.fx.stop()},p.fx.timer=function(a){a()&&p.timers.push(a)&&!cN&&(cN=setInterval(p.fx.tick,p.fx.interval))},p.fx.interval=13,p.fx.stop=function(){clearInterval(cN),cN=null},p.fx.speeds={slow:600,fast:200,_default:400},p.fx.step={},p.expr&&p.expr.filters&&(p.expr.filters.animated=function(a){return p.grep(p.timers,function(b){return a===b.elem}).length});var c$=/^(?:body|html)$/i;p.fn.offset=function(a){if(arguments.length)return a===b?this:this.each(function(b){p.offset.setOffset(this,a,b)});var c,d,e,f,g,h,i,j,k,l,m=this[0],n=m&&m.ownerDocument;if(!n)return;return(e=n.body)===m?p.offset.bodyOffset(m):(d=n.documentElement,p.contains(d,m)?(c=m.getBoundingClientRect(),f=c_(n),g=d.clientTop||e.clientTop||0,h=d.clientLeft||e.clientLeft||0,i=f.pageYOffset||d.scrollTop,j=f.pageXOffset||d.scrollLeft,k=c.top+i-g,l=c.left+j-h,{top:k,left:l}):{top:0,left:0})},p.offset={bodyOffset:function(a){var b=a.offsetTop,c=a.offsetLeft;return p.support.doesNotIncludeMarginInBodyOffset&&(b+=parseFloat(p.css(a,"marginTop"))||0,c+=parseFloat(p.css(a,"marginLeft"))||0),{top:b,left:c}},setOffset:function(a,b,c){var d=p.css(a,"position");d==="static"&&(a.style.position="relative");var e=p(a),f=e.offset(),g=p.css(a,"top"),h=p.css(a,"left"),i=(d==="absolute"||d==="fixed")&&p.inArray("auto",[g,h])>-1,j={},k={},l,m;i?(k=e.position(),l=k.top,m=k.left):(l=parseFloat(g)||0,m=parseFloat(h)||0),p.isFunction(b)&&(b=b.call(a,c,f)),b.top!=null&&(j.top=b.top-f.top+l),b.left!=null&&(j.left=b.left-f.left+m),"using"in b?b.using.call(a,j):e.css(j)}},p.fn.extend({position:function(){if(!this[0])return;var a=this[0],b=this.offsetParent(),c=this.offset(),d=c$.test(b[0].nodeName)?{top:0,left:0}:b.offset();return c.top-=parseFloat(p.css(a,"marginTop"))||0,c.left-=parseFloat(p.css(a,"marginLeft"))||0,d.top+=parseFloat(p.css(b[0],"borderTopWidth"))||0,d.left+=parseFloat(p.css(b[0],"borderLeftWidth"))||0,{top:c.top-d.top,left:c.left-d.left}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||e.body;while(a&&!c$.test(a.nodeName)&&p.css(a,"position")==="static")a=a.offsetParent;return a||e.body})}}),p.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,c){var d=/Y/.test(c);p.fn[a]=function(e){return p.access(this,function(a,e,f){var g=c_(a);if(f===b)return g?c in g?g[c]:g.document.documentElement[e]:a[e];g?g.scrollTo(d?p(g).scrollLeft():f,d?f:p(g).scrollTop()):a[e]=f},a,e,arguments.length,null)}}),p.each({Height:"height",Width:"width"},function(a,c){p.each({padding:"inner"+a,content:c,"":"outer"+a},function(d,e){p.fn[e]=function(e,f){var g=arguments.length&&(d||typeof e!="boolean"),h=d||(e===!0||f===!0?"margin":"border");return p.access(this,function(c,d,e){var f;return p.isWindow(c)?c.document.documentElement["client"+a]:c.nodeType===9?(f=c.documentElement,Math.max(c.body["scroll"+a],f["scroll"+a],c.body["offset"+a],f["offset"+a],f["client"+a])):e===b?p.css(c,d,e,h):p.style(c,d,e,h)},c,g?e:b,g)}})}),a.jQuery=a.$=p,typeof define=="function"&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return p})})(window);;
// Unobtrusive Ajax support library for jQuery
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.
// @version v3.2.6
// 
// Microsoft grants you the right to use these script files for the sole
// purpose of either: (i) interacting through your browser with the Microsoft
// website or online service, subject to the applicable licensing or use
// terms; or (ii) using the files as included with a Microsoft product subject
// to that product's license terms. Microsoft reserves all other rights to the
// files not expressly granted by Microsoft, whether by implication, estoppel
// or otherwise. Insofar as a script file is dual licensed under GPL,
// Microsoft neither took the code under GPL nor distributes it thereunder but
// under the terms set out in this paragraph. All notices and licenses
// below are for informational purposes only.
!function(t){function a(t,a){for(var e=window,r=(t||"").split(".");e&&r.length;)e=e[r.shift()];return"function"==typeof e?e:(a.push(t),Function.constructor.apply(null,a))}function e(t){return"GET"===t||"POST"===t}function r(t,a){e(a)||t.setRequestHeader("X-HTTP-Method-Override",a)}function n(a,e,r){var n;r.indexOf("application/x-javascript")===-1&&(n=(a.getAttribute("data-ajax-mode")||"").toUpperCase(),t(a.getAttribute("data-ajax-update")).each(function(a,r){switch(n){case"BEFORE":t(r).prepend(e);break;case"AFTER":t(r).append(e);break;case"REPLACE-WITH":t(r).replaceWith(e);break;default:t(r).html(e)}}))}function i(i,u){var o,c,d,s;if(o=i.getAttribute("data-ajax-confirm"),!o||window.confirm(o)){c=t(i.getAttribute("data-ajax-loading")),s=parseInt(i.getAttribute("data-ajax-loading-duration"),10)||0,t.extend(u,{type:i.getAttribute("data-ajax-method")||void 0,url:i.getAttribute("data-ajax-url")||void 0,cache:"true"===(i.getAttribute("data-ajax-cache")||"").toLowerCase(),beforeSend:function(t){var e;return r(t,d),e=a(i.getAttribute("data-ajax-begin"),["xhr"]).apply(i,arguments),e!==!1&&c.show(s),e},complete:function(){c.hide(s),a(i.getAttribute("data-ajax-complete"),["xhr","status"]).apply(i,arguments)},success:function(t,e,r){n(i,t,r.getResponseHeader("Content-Type")||"text/html"),a(i.getAttribute("data-ajax-success"),["data","status","xhr"]).apply(i,arguments)},error:function(){a(i.getAttribute("data-ajax-failure"),["xhr","status","error"]).apply(i,arguments)}}),u.data.push({name:"X-Requested-With",value:"XMLHttpRequest"}),d=u.type.toUpperCase(),e(d)||(u.type="POST",u.data.push({name:"X-HTTP-Method-Override",value:d}));var p=t(i);if(p.is("form")&&"multipart/form-data"==p.attr("enctype")){var f=new FormData;t.each(u.data,function(t,a){f.append(a.name,a.value)}),t("input[type=file]",p).each(function(){var a=this;t.each(a.files,function(t,e){f.append(a.name,e)})}),t.extend(u,{processData:!1,contentType:!1,data:f})}t.ajax(u)}}function u(a){var e=t(a).data(d);return!e||!e.validate||e.validate()}var o="unobtrusiveAjaxClick",c="unobtrusiveAjaxClickTarget",d="unobtrusiveValidation";t(document).on("click","a[data-ajax=true]",function(t){t.preventDefault(),i(this,{url:this.href,type:"GET",data:[]})}),t(document).on("click","form[data-ajax=true] input[type=image]",function(a){var e=a.target.name,r=t(a.target),n=t(r.parents("form")[0]),i=r.offset();n.data(o,[{name:e+".x",value:Math.round(a.pageX-i.left)},{name:e+".y",value:Math.round(a.pageY-i.top)}]),setTimeout(function(){n.removeData(o)},0)}),t(document).on("click","form[data-ajax=true] :submit",function(a){var e=a.currentTarget.name,r=t(a.target),n=t(r.parents("form")[0]);n.data(o,e?[{name:e,value:a.currentTarget.value}]:[]),n.data(c,r),setTimeout(function(){n.removeData(o),n.removeData(c)},0)}),t(document).on("submit","form[data-ajax=true]",function(a){var e=t(this).data(o)||[],r=t(this).data(c),n=r&&(r.hasClass("cancel")||void 0!==r.attr("formnovalidate"));a.preventDefault(),(n||u(this))&&i(this,{url:this.action,type:this.method||"GET",data:e.concat(t(this).serializeArray())})})}(jQuery);;
/* MooTools: the javascript framework. license: MIT-style license. copyright: Copyright (c) 2006-2016 [Valerio Proietti](http://mad4milk.net/).*/ 
/*!
Web Build: http://mootools.net/core/builder/b7c3eeae94f1c893ddb863093e8282ef
*/
!function(){function t(t,e,i){if(r)for(var s=r.length;s--;){var o=r[s];n.call(t,o)&&e.call(i,o,t[o])}}this.MooTools={version:"1.6.0",build:"529422872adfff401b901b8b6c7ca5114ee95e2b"};var e=this.typeOf=function(t){if(null==t)return"null";if(null!=t.$family)return t.$family();if(t.nodeName){if(1==t.nodeType)return"element";if(3==t.nodeType)return/\S/.test(t.nodeValue)?"textnode":"whitespace"}else if("number"==typeof t.length){if("callee"in t)return"arguments";if("item"in t)return"collection"}return typeof t},n=(this.instanceOf=function(t,e){if(null==t)return!1;for(var n=t.$constructor||t.constructor;n;){if(n===e)return!0;n=n.parent}return t.hasOwnProperty?t instanceof e:!1},Object.prototype.hasOwnProperty),r=!0;for(var i in{toString:1})r=null;r&&(r=["hasOwnProperty","valueOf","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","constructor"]);var s=this.Function;s.prototype.overloadSetter=function(e){var n=this;return function(r,i){if(null==r)return this;if(e||"string"!=typeof r){for(var s in r)n.call(this,s,r[s]);t(r,n,this)}else n.call(this,r,i);return this}},s.prototype.overloadGetter=function(t){var e=this;return function(n){var r,i;if("string"!=typeof n?r=n:arguments.length>1?r=arguments:t&&(r=[n]),r){i={};for(var s=0;s<r.length;s++)i[r[s]]=e.call(this,r[s])}else i=e.call(this,n);return i}},s.prototype.extend=function(t,e){this[t]=e}.overloadSetter(),s.prototype.implement=function(t,e){this.prototype[t]=e}.overloadSetter();var o=Array.prototype.slice;Array.convert=function(t){return null==t?[]:a.isEnumerable(t)&&"string"!=typeof t?"array"==e(t)?t:o.call(t):[t]},s.convert=function(t){return"function"==e(t)?t:function(){return t}},Number.convert=function(t){var e=parseFloat(t);return isFinite(e)?e:null},String.convert=function(t){return t+""},s.from=s.convert,Number.from=Number.convert,String.from=String.convert,s.implement({hide:function(){return this.$hidden=!0,this},protect:function(){return this.$protected=!0,this}});var a=this.Type=function(t,n){if(t){var r=t.toLowerCase(),i=function(t){return e(t)==r};a["is"+t]=i,null!=n&&(n.prototype.$family=function(){return r}.hide())}return null==n?null:(n.extend(this),n.$constructor=a,n.prototype.$constructor=n,n)},u=Object.prototype.toString;a.isEnumerable=function(t){return null!=t&&"number"==typeof t.length&&"[object Function]"!=u.call(t)};var c={},l=function(t){var n=e(t.prototype);return c[n]||(c[n]=[])},h=function(t,n){if(!n||!n.$hidden){for(var r=l(this),i=0;i<r.length;i++){var s=r[i];"type"==e(s)?h.call(s,t,n):s.call(this,t,n)}var a=this.prototype[t];null!=a&&a.$protected||(this.prototype[t]=n),null==this[t]&&"function"==e(n)&&f.call(this,t,function(t){return n.apply(t,o.call(arguments,1))})}},f=function(t,e){if(!e||!e.$hidden){var n=this[t];null!=n&&n.$protected||(this[t]=e)}};a.implement({implement:h.overloadSetter(),extend:f.overloadSetter(),alias:function(t,e){h.call(this,t,this.prototype[e])}.overloadSetter(),mirror:function(t){return l(this).push(t),this}}),new a("Type",a);var p=function(t,e,n){var r=e!=Object,i=e.prototype;r&&(e=new a(t,e));for(var s=0,o=n.length;o>s;s++){var u=n[s],c=e[u],l=i[u];c&&c.protect(),r&&l&&e.implement(u,l.protect())}if(r){var h=i.propertyIsEnumerable(n[0]);e.forEachMethod=function(t){if(!h)for(var e=0,r=n.length;r>e;e++)t.call(i,i[n[e]],n[e]);for(var s in i)t.call(i,i[s],s)}}return p};p("String",String,["charAt","charCodeAt","concat","contains","indexOf","lastIndexOf","match","quote","replace","search","slice","split","substr","substring","trim","toLowerCase","toUpperCase"])("Array",Array,["pop","push","reverse","shift","sort","splice","unshift","concat","join","slice","indexOf","lastIndexOf","filter","forEach","every","map","some","reduce","reduceRight","contains"])("Number",Number,["toExponential","toFixed","toLocaleString","toPrecision"])("Function",s,["apply","call","bind"])("RegExp",RegExp,["exec","test"])("Object",Object,["create","defineProperty","defineProperties","keys","getPrototypeOf","getOwnPropertyDescriptor","getOwnPropertyNames","preventExtensions","isExtensible","seal","isSealed","freeze","isFrozen"])("Date",Date,["now"]),Object.extend=f.overloadSetter(),Date.extend("now",function(){return+new Date}),new a("Boolean",Boolean),Number.prototype.$family=function(){return isFinite(this)?"number":"null"}.hide(),Number.extend("random",function(t,e){return Math.floor(Math.random()*(e-t+1)+t)}),Array.implement({forEach:function(t,e){for(var n=0,r=this.length;r>n;n++)n in this&&t.call(e,this[n],n,this)},each:function(t,e){return Array.forEach(this,t,e),this}}),Object.extend({keys:function(e){var r=[];for(var i in e)n.call(e,i)&&r.push(i);return t(e,function(t){r.push(t)}),r},forEach:function(t,e,n){Object.keys(t).forEach(function(r){e.call(n,t[r],r,t)})}}),Object.each=Object.forEach;var d=function(t){switch(e(t)){case"array":return t.clone();case"object":return Object.clone(t);default:return t}};Array.implement("clone",function(){for(var t=this.length,e=new Array(t);t--;)e[t]=d(this[t]);return e});var m=function(t,n,r){switch(e(r)){case"object":"object"==e(t[n])?Object.merge(t[n],r):t[n]=Object.clone(r);break;case"array":t[n]=r.clone();break;default:t[n]=r}return t};Object.extend({merge:function(t,n,r){if("string"==e(n))return m(t,n,r);for(var i=1,s=arguments.length;s>i;i++){var o=arguments[i];for(var a in o)m(t,a,o[a])}return t},clone:function(t){var e={};for(var n in t)e[n]=d(t[n]);return e},append:function(t){for(var e=1,n=arguments.length;n>e;e++){var r=arguments[e]||{};for(var i in r)t[i]=r[i]}return t}}),["Object","WhiteSpace","TextNode","Collection","Arguments"].each(function(t){new a(t)});var v=Date.now();String.extend("uniqueID",function(){return(v++).toString(36)})}(),Array.implement({every:function(t,e){for(var n=0,r=this.length>>>0;r>n;n++)if(n in this&&!t.call(e,this[n],n,this))return!1;return!0},filter:function(t,e){for(var n,r=[],i=0,s=this.length>>>0;s>i;i++)i in this&&(n=this[i],t.call(e,n,i,this)&&r.push(n));return r},indexOf:function(t,e){for(var n=this.length>>>0,r=0>e?Math.max(0,n+e):e||0;n>r;r++)if(this[r]===t)return r;return-1},map:function(t,e){for(var n=this.length>>>0,r=Array(n),i=0;n>i;i++)i in this&&(r[i]=t.call(e,this[i],i,this));return r},some:function(t,e){for(var n=0,r=this.length>>>0;r>n;n++)if(n in this&&t.call(e,this[n],n,this))return!0;return!1},clean:function(){return this.filter(function(t){return null!=t})},invoke:function(t){var e=Array.slice(arguments,1);return this.map(function(n){return n[t].apply(n,e)})},associate:function(t){for(var e={},n=Math.min(this.length,t.length),r=0;n>r;r++)e[t[r]]=this[r];return e},link:function(t){for(var e={},n=0,r=this.length;r>n;n++)for(var i in t)if(t[i](this[n])){e[i]=this[n],delete t[i];break}return e},contains:function(t,e){return-1!=this.indexOf(t,e)},append:function(t){return this.push.apply(this,t),this},getLast:function(){return this.length?this[this.length-1]:null},getRandom:function(){return this.length?this[Number.random(0,this.length-1)]:null},include:function(t){return this.contains(t)||this.push(t),this},combine:function(t){for(var e=0,n=t.length;n>e;e++)this.include(t[e]);return this},erase:function(t){for(var e=this.length;e--;)this[e]===t&&this.splice(e,1);return this},empty:function(){return this.length=0,this},flatten:function(){for(var t=[],e=0,n=this.length;n>e;e++){var r=typeOf(this[e]);"null"!=r&&(t=t.concat("array"==r||"collection"==r||"arguments"==r||instanceOf(this[e],Array)?Array.flatten(this[e]):this[e]))}return t},pick:function(){for(var t=0,e=this.length;e>t;t++)if(null!=this[t])return this[t];return null},hexToRgb:function(t){if(3!=this.length)return null;var e=this.map(function(t){return 1==t.length&&(t+=t),parseInt(t,16)});return t?e:"rgb("+e+")"},rgbToHex:function(t){if(this.length<3)return null;if(4==this.length&&0==this[3]&&!t)return"transparent";for(var e=[],n=0;3>n;n++){var r=(this[n]-0).toString(16);e.push(1==r.length?"0"+r:r)}return t?e:"#"+e.join("")}}),Function.extend({attempt:function(){for(var t=0,e=arguments.length;e>t;t++)try{return arguments[t]()}catch(n){}return null}}),Function.implement({attempt:function(t,e){try{return this.apply(e,Array.convert(t))}catch(n){}return null},bind:function(t){var e=this,n=arguments.length>1?Array.slice(arguments,1):null,r=function(){},i=function(){var s=t,o=arguments.length;this instanceof i&&(r.prototype=e.prototype,s=new r);var a=n||o?e.apply(s,n&&o?n.concat(Array.slice(arguments)):n||arguments):e.call(s);return s==t?a:s};return i},pass:function(t,e){var n=this;return null!=t&&(t=Array.convert(t)),function(){return n.apply(e,t||arguments)}},delay:function(t,e,n){return setTimeout(this.pass(null==n?[]:n,e),t)},periodical:function(t,e,n){return setInterval(this.pass(null==n?[]:n,e),t)}}),Number.implement({limit:function(t,e){return Math.min(e,Math.max(t,this))},round:function(t){return t=Math.pow(10,t||0).toFixed(0>t?-t:0),Math.round(this*t)/t},times:function(t,e){for(var n=0;this>n;n++)t.call(e,n,this)},toFloat:function(){return parseFloat(this)},toInt:function(t){return parseInt(this,t||10)}}),Number.alias("each","times"),function(t){var e={};t.each(function(t){Number[t]||(e[t]=function(){return Math[t].apply(null,[this].concat(Array.convert(arguments)))})}),Number.implement(e)}(["abs","acos","asin","atan","atan2","ceil","cos","exp","floor","log","max","min","pow","sin","sqrt","tan"]),String.implement({contains:function(t,e){return(e?String(this).slice(e):String(this)).indexOf(t)>-1},test:function(t,e){return("regexp"==typeOf(t)?t:new RegExp(""+t,e)).test(this)},trim:function(){return String(this).replace(/^\s+|\s+$/g,"")},clean:function(){return String(this).replace(/\s+/g," ").trim()},camelCase:function(){return String(this).replace(/-\D/g,function(t){return t.charAt(1).toUpperCase()})},hyphenate:function(){return String(this).replace(/[A-Z]/g,function(t){return"-"+t.charAt(0).toLowerCase()})},capitalize:function(){return String(this).replace(/\b[a-z]/g,function(t){return t.toUpperCase()})},escapeRegExp:function(){return String(this).replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")},toInt:function(t){return parseInt(this,t||10)},toFloat:function(){return parseFloat(this)},hexToRgb:function(t){var e=String(this).match(/^#?(\w{1,2})(\w{1,2})(\w{1,2})$/);return e?e.slice(1).hexToRgb(t):null},rgbToHex:function(t){var e=String(this).match(/\d{1,3}/g);return e?e.rgbToHex(t):null},substitute:function(t,e){return String(this).replace(e||/\\?\{([^{}]+)\}/g,function(e,n){return"\\"==e.charAt(0)?e.slice(1):null!=t[n]?t[n]:""})}}),function(){var t=this.document,e=t.window=this,n=function(t,e){t=t.toLowerCase(),e=e?e.toLowerCase():"";var n=t.match(/(edge)[\s\/:]([\w\d\.]+)/);return n||(n=t.match(/(opera|ie|firefox|chrome|trident|crios|version)[\s\/:]([\w\d\.]+)?.*?(safari|(?:rv[\s\/:]|version[\s\/:])([\w\d\.]+)|$)/)||[null,"unknown",0]),"trident"==n[1]?(n[1]="ie",n[4]&&(n[2]=n[4])):"crios"==n[1]&&(n[1]="chrome"),e=t.match(/ip(?:ad|od|hone)/)?"ios":(t.match(/(?:webos|android)/)||t.match(/mac|win|linux/)||["other"])[0],"win"==e&&(e="windows"),{extend:Function.prototype.extend,name:"version"==n[1]?n[3]:n[1],version:parseFloat("opera"==n[1]&&n[4]?n[4]:n[2]),platform:e}},r=this.Browser=n(navigator.userAgent,navigator.platform);if("ie"==r.name&&t.documentMode&&(r.version=t.documentMode),r.extend({Features:{xpath:!!t.evaluate,air:!!e.runtime,query:!!t.querySelector,json:!!e.JSON},parseUA:n}),r.Request=function(){var t=function(){return new XMLHttpRequest},e=function(){return new ActiveXObject("MSXML2.XMLHTTP")},n=function(){return new ActiveXObject("Microsoft.XMLHTTP")};return Function.attempt(function(){return t(),t},function(){return e(),e},function(){return n(),n})}(),r.Features.xhr=!!r.Request,r.exec=function(n){if(!n)return n;if(e.execScript)e.execScript(n);else{var r=t.createElement("script");r.setAttribute("type","text/javascript"),r.text=n,t.head.appendChild(r),t.head.removeChild(r)}return n},String.implement("stripScripts",function(t){var e="",n=this.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi,function(t,n){return e+=n+"\n",""});return t===!0?r.exec(e):"function"==typeOf(t)&&t(e,n),n}),r.extend({Document:this.Document,Window:this.Window,Element:this.Element,Event:this.Event}),this.Window=this.$constructor=new Type("Window",function(){}),this.$family=Function.convert("window").hide(),Window.mirror(function(t,n){e[t]=n}),this.Document=t.$constructor=new Type("Document",function(){}),t.$family=Function.convert("document").hide(),Document.mirror(function(e,n){t[e]=n}),t.html=t.documentElement,t.head||(t.head=t.getElementsByTagName("head")[0]),t.execCommand)try{t.execCommand("BackgroundImageCache",!1,!0)}catch(i){}if(this.attachEvent&&!this.addEventListener){var s=function(){this.detachEvent("onunload",s),t.head=t.html=t.window=null,e=this.Window=t=null};this.attachEvent("onunload",s)}var o=Array.convert;try{o(t.html.childNodes)}catch(i){Array.convert=function(t){if("string"!=typeof t&&Type.isEnumerable(t)&&"array"!=typeOf(t)){for(var e=t.length,n=new Array(e);e--;)n[e]=t[e];return n}return o(t)};var a=Array.prototype,u=a.slice;["pop","push","reverse","shift","sort","splice","unshift","concat","join","slice"].each(function(t){var e=a[t];Array[t]=function(t){return e.apply(Array.convert(t),u.call(arguments,1))}})}}(),function(){var t=this.Class=new Type("Class",function(r){instanceOf(r,Function)&&(r={initialize:r});var i=function(){if(n(this),i.$prototyping)return this;this.$caller=null,this.$family=null;var t=this.initialize?this.initialize.apply(this,arguments):this;return this.$caller=this.caller=null,t}.extend(this).implement(r);return i.$constructor=t,i.prototype.$constructor=i,i.prototype.parent=e,i}),e=function(){if(!this.$caller)throw new Error('The method "parent" cannot be called.');var t=this.$caller.$name,e=this.$caller.$owner.parent,n=e?e.prototype[t]:null;if(!n)throw new Error('The method "'+t+'" has no parent.');return n.apply(this,arguments)},n=function(t){for(var e in t){var r=t[e];switch(typeOf(r)){case"object":var i=function(){};i.prototype=r,t[e]=n(new i);break;case"array":t[e]=r.clone()}}return t},r=function(t,e,n){n.$origin&&(n=n.$origin);var r=function(){if(n.$protected&&null==this.$caller)throw new Error('The method "'+e+'" cannot be called.');var t=this.caller,i=this.$caller;this.caller=i,this.$caller=r;var s=n.apply(this,arguments);return this.$caller=i,this.caller=t,s}.extend({$owner:t,$origin:n,$name:e});return r},i=function(e,n,i){if(t.Mutators.hasOwnProperty(e)&&(n=t.Mutators[e].call(this,n),null==n))return this;if("function"==typeOf(n)){if(n.$hidden)return this;this.prototype[e]=i?n:r(this,e,n)}else Object.merge(this.prototype,e,n);return this},s=function(t){t.$prototyping=!0;var e=new t;return delete t.$prototyping,e};t.implement("implement",i.overloadSetter()),t.Mutators={Extends:function(t){this.parent=t,this.prototype=s(t)},Implements:function(t){Array.convert(t).each(function(t){var e=new t;for(var n in e)i.call(this,n,e[n],!0)},this)}}}(),function(){this.Chain=new Class({$chain:[],chain:function(){return this.$chain.append(Array.flatten(arguments)),this},callChain:function(){return this.$chain.length?this.$chain.shift().apply(this,arguments):!1},clearChain:function(){return this.$chain.empty(),this}});var t=function(t){return t.replace(/^on([A-Z])/,function(t,e){return e.toLowerCase()})};this.Events=new Class({$events:{},addEvent:function(e,n,r){return e=t(e),this.$events[e]=(this.$events[e]||[]).include(n),r&&(n.internal=!0),this},addEvents:function(t){for(var e in t)this.addEvent(e,t[e]);return this},fireEvent:function(e,n,r){e=t(e);var i=this.$events[e];return i?(n=Array.convert(n),i.each(function(t){r?t.delay(r,this,n):t.apply(this,n)},this),this):this},removeEvent:function(e,n){e=t(e);var r=this.$events[e];if(r&&!n.internal){var i=r.indexOf(n);-1!=i&&delete r[i]}return this},removeEvents:function(e){var n;if("object"==typeOf(e)){for(n in e)this.removeEvent(n,e[n]);return this}e&&(e=t(e));for(n in this.$events)if(!e||e==n)for(var r=this.$events[n],i=r.length;i--;)i in r&&this.removeEvent(n,r[i]);return this}}),this.Options=new Class({setOptions:function(){var t=this.options=Object.merge.apply(null,[{},this.options].append(arguments));if(this.addEvent)for(var e in t)"function"==typeOf(t[e])&&/^on[A-Z]/.test(e)&&(this.addEvent(e,t[e]),delete t[e]);return this}})}(),function(){function t(r,i){if(r.$thenableState===o)if(r===i)n(r,new TypeError("Tried to resolve a thenable with itself."));else if(!i||"object"!=typeof i&&"function"!=typeof i)e(r,i);else{var s;try{s=i.then}catch(a){n(r,a)}if("function"==typeof s){var u=!1;l(function(){try{s.call(i,function(e){u||(u=!0,t(r,e))},function(t){u||(u=!0,n(r,t))})}catch(e){u||(u=!0,n(r,e))}})}else e(r,i)}}function e(t,e){t.$thenableState===o&&(t.$thenableResult=e,t.$thenableState=a,i(t))}function n(t,e){t.$thenableState===o&&(t.$thenableResult=e,t.$thenableState=u,i(t))}function r(t){t.$thenableState!==o&&(t.$thenableResult=null,t.$thenableState=o)}function i(t){var e,n=t.$thenableState,r=t.$thenableResult,i=t.$thenableReactions;n===a?(t.$thenableReactions=[],e="fulfillHandler"):n==u&&(t.$thenableReactions=[],e="rejectHandler"),e&&l(s.pass([r,i,e]))}function s(e,r,i){for(var s=0,o=r.length;o>s;++s){var a=r[s],u=a[i];if("Identity"===u)t(a.thenable,e);else if("Thrower"===u)n(a.thenable,e);else try{t(a.thenable,u(e))}catch(c){n(a.thenable,c)}}}var o=0,a=1,u=2,c=Class.Thenable=new Class({$thenableState:o,$thenableResult:null,$thenableReactions:[],resolve:function(e){return t(this,e),this},reject:function(t){return n(this,t),this},getThenableState:function(){switch(this.$thenableState){case o:return"pending";case a:return"fulfilled";case u:return"rejected"}},resetThenable:function(t){return n(this,t),r(this),this},then:function(t,e){"function"!=typeof t&&(t="Identity"),"function"!=typeof e&&(e="Thrower");var n=new c;return this.$thenableReactions.push({thenable:n,fulfillHandler:t,rejectHandler:e}),this.$thenableState!==o&&i(this),n},"catch":function(t){return this.then(null,t)}});c.extend({resolve:function(e){var n;return e instanceof c?n=e:(n=new c,t(n,e)),n},reject:function(t){var e=new c;return n(e,t),e}});var l;l="undefined"!=typeof process&&"function"==typeof process.nextTick?process.nextTick:"undefined"!=typeof setImmediate?setImmediate:function(t){setTimeout(t,0)}}(),function(){Object.extend({subset:function(t,e){for(var n={},r=0,i=e.length;i>r;r++){var s=e[r];s in t&&(n[s]=t[s])}return n},map:function(t,e,n){for(var r={},i=Object.keys(t),s=0;s<i.length;s++){var o=i[s];r[o]=e.call(n,t[o],o,t)}return r},filter:function(t,e,n){for(var r={},i=Object.keys(t),s=0;s<i.length;s++){var o=i[s],a=t[o];e.call(n,a,o,t)&&(r[o]=a)}return r},every:function(t,e,n){for(var r=Object.keys(t),i=0;i<r.length;i++){var s=r[i];if(!e.call(n,t[s],s))return!1}return!0},some:function(t,e,n){for(var r=Object.keys(t),i=0;i<r.length;i++){var s=r[i];if(e.call(n,t[s],s))return!0}return!1},values:function(t){for(var e=[],n=Object.keys(t),r=0;r<n.length;r++){var i=n[r];e.push(t[i])}return e},getLength:function(t){return Object.keys(t).length},keyOf:function(t,e){for(var n=Object.keys(t),r=0;r<n.length;r++){var i=n[r];if(t[i]===e)return i}return null},contains:function(t,e){return null!=Object.keyOf(t,e)},toQueryString:function(t,e){var n=[];return Object.each(t,function(t,r){e&&(r=e+"["+r+"]");var i;switch(typeOf(t)){case"object":i=Object.toQueryString(t,r);break;case"array":var s={};t.each(function(t,e){s[e]=t}),i=Object.toQueryString(s,r);break;default:i=r+"="+encodeURIComponent(t)}null!=t&&n.push(i)}),n.join("&")}})}(),function(){function t(t,s,o,u,l,f,p,d,m,v,g,y,b,x,E,S){if((s||-1===n)&&(e.expressions[++n]=[],r=-1,s))return"";if(o||u||-1===r){o=o||" ";var w=e.expressions[n];i&&w[r]&&(w[r].reverseCombinator=c(o)),w[++r]={combinator:o,tag:"*"}}var k=e.expressions[n][r];if(l)k.tag=l.replace(a,"");else if(f)k.id=f.replace(a,"");else if(p)p=p.replace(a,""),k.classList||(k.classList=[]),k.classes||(k.classes=[]),k.classList.push(p),k.classes.push({value:p,regexp:new RegExp("(^|\\s)"+h(p)+"(\\s|$)")});else if(b)S=S||E,S=S?S.replace(a,""):null,k.pseudos||(k.pseudos=[]),k.pseudos.push({key:b.replace(a,""),value:S,type:1==y.length?"class":"element"});else if(d){d=d.replace(a,""),g=(g||"").replace(a,"");var T,C;switch(m){case"^=":C=new RegExp("^"+h(g));break;case"$=":C=new RegExp(h(g)+"$");break;case"~=":C=new RegExp("(^|\\s)"+h(g)+"(\\s|$)");break;case"|=":C=new RegExp("^"+h(g)+"(-|$)");break;case"=":T=function(t){return g==t};break;case"*=":T=function(t){return t&&t.indexOf(g)>-1};break;case"!=":T=function(t){return g!=t};break;default:T=function(t){return!!t}}""==g&&/^[*$^]=$/.test(m)&&(T=function(){return!1}),T||(T=function(t){return t&&C.test(t)}),k.attributes||(k.attributes=[]),k.attributes.push({key:d,operator:m,value:g,test:T})}return""}var e,n,r,i,s={},o={},a=/\\/g,u=function(r,a){if(null==r)return null;if(r.Slick===!0)return r;r=(""+r).replace(/^\s+|\s+$/g,""),i=!!a;var c=i?o:s;if(c[r])return c[r];for(e={Slick:!0,expressions:[],raw:r,reverse:function(){return u(this.raw,!0)}},n=-1;r!=(r=r.replace(f,t)););return e.length=e.expressions.length,c[e.raw]=i?l(e):e},c=function(t){return"!"===t?" ":" "===t?"!":/^!/.test(t)?t.replace(/^!/,""):"!"+t},l=function(t){for(var e=t.expressions,n=0;n<e.length;n++){for(var r=e[n],i={parts:[],tag:"*",combinator:c(r[0].combinator)},s=0;s<r.length;s++){var o=r[s];o.reverseCombinator||(o.reverseCombinator=" "),o.combinator=o.reverseCombinator,delete o.reverseCombinator}r.reverse().push(i)}return t},h=function(t){return t.replace(/[-[\]{}()*+?.\\^$|,#\s]/g,function(t){return"\\"+t})},f=new RegExp("^(?:\\s*(,)\\s*|\\s*(<combinator>+)\\s*|(\\s+)|(<unicode>+|\\*)|\\#(<unicode>+)|\\.(<unicode>+)|\\[\\s*(<unicode1>+)(?:\\s*([*^$!~|]?=)(?:\\s*(?:([\"']?)(.*?)\\9)))?\\s*\\](?!\\])|(:+)(<unicode>+)(?:\\((?:(?:([\"'])([^\\13]*)\\13)|((?:\\([^)]+\\)|[^()]*)+))\\))?)".replace(/<combinator>/,"["+h(">+~`!@$%^&={}\\;</")+"]").replace(/<unicode>/g,"(?:[\\w\\u00a1-\\uFFFF-]|\\\\[^\\s0-9a-f])").replace(/<unicode1>/g,"(?:[:\\w\\u00a1-\\uFFFF-]|\\\\[^\\s0-9a-f])")),p=this.Slick||{};p.parse=function(t){return u(t)},p.escapeRegExp=h,this.Slick||(this.Slick=p)}.apply("undefined"!=typeof exports?exports:this),function(){var t={},e={},n=Object.prototype.toString;t.isNativeCode=function(t){return/\{\s*\[native code\]\s*\}/.test(""+t)},t.isXML=function(t){return!!t.xmlVersion||!!t.xml||"[object XMLDocument]"==n.call(t)||9==t.nodeType&&"HTML"!=t.documentElement.nodeName},t.setDocument=function(t){var n=t.nodeType;if(9==n);else if(n)t=t.ownerDocument;else{if(!t.navigator)return;t=t.document}if(this.document!==t){this.document=t;var r,i=t.documentElement,s=this.getUIDXML(i),o=e[s];if(o)for(r in o)this[r]=o[r];else{o=e[s]={},o.root=i,o.isXMLDocument=this.isXML(t),o.brokenStarGEBTN=o.starSelectsClosedQSA=o.idGetsName=o.brokenMixedCaseQSA=o.brokenGEBCN=o.brokenCheckedQSA=o.brokenEmptyAttributeQSA=o.isHTMLDocument=o.nativeMatchesSelector=!1;var a,u,c,l,h,f,p="slick_uniqueid",d=t.createElement("div"),m=t.body||t.getElementsByTagName("body")[0]||i;m.appendChild(d);try{d.innerHTML='<a id="'+p+'"></a>',o.isHTMLDocument=!!t.getElementById(p)}catch(v){}if(o.isHTMLDocument){d.style.display="none",d.appendChild(t.createComment("")),u=d.getElementsByTagName("*").length>1;try{d.innerHTML="foo</foo>",f=d.getElementsByTagName("*"),a=f&&!!f.length&&"/"==f[0].nodeName.charAt(0)}catch(v){}o.brokenStarGEBTN=u||a;try{d.innerHTML='<a name="'+p+'"></a><b id="'+p+'"></b>',o.idGetsName=t.getElementById(p)===d.firstChild}catch(v){}if(d.getElementsByClassName){try{d.innerHTML='<a class="f"></a><a class="b"></a>',d.getElementsByClassName("b").length,d.firstChild.className="b",l=2!=d.getElementsByClassName("b").length}catch(v){}try{d.innerHTML='<a class="a"></a><a class="f b a"></a>',c=2!=d.getElementsByClassName("a").length}catch(v){}o.brokenGEBCN=l||c}if(d.querySelectorAll){try{d.innerHTML="foo</foo>",f=d.querySelectorAll("*"),o.starSelectsClosedQSA=f&&!!f.length&&"/"==f[0].nodeName.charAt(0)}catch(v){}try{d.innerHTML='<a class="MiX"></a>',o.brokenMixedCaseQSA=!d.querySelectorAll(".MiX").length}catch(v){}try{d.innerHTML='<select><option selected="selected">a</option></select>',o.brokenCheckedQSA=0==d.querySelectorAll(":checked").length}catch(v){}try{d.innerHTML='<a class=""></a>',o.brokenEmptyAttributeQSA=0!=d.querySelectorAll('[class*=""]').length}catch(v){}}try{d.innerHTML='<form action="s"><input id="action"/></form>',h="s"!=d.firstChild.getAttribute("action")}catch(v){}if(o.nativeMatchesSelector=i.matches||i.mozMatchesSelector||i.webkitMatchesSelector,o.nativeMatchesSelector)try{o.nativeMatchesSelector.call(i,":slick"),o.nativeMatchesSelector=null}catch(v){}}try{i.slick_expando=1,delete i.slick_expando,o.getUID=this.getUIDHTML}catch(v){o.getUID=this.getUIDXML}m.removeChild(d),d=f=m=null,o.getAttribute=o.isHTMLDocument&&h?function(t,e){var n=this.attributeGetters[e];if(n)return n.call(t);var r=t.getAttributeNode(e);return r?r.nodeValue:null}:function(t,e){var n=this.attributeGetters[e];return n?n.call(t):t.getAttribute(e)},o.hasAttribute=i&&this.isNativeCode(i.hasAttribute)?function(t,e){return t.hasAttribute(e)}:function(t,e){return t=t.getAttributeNode(e),!(!t||!t.specified&&!t.nodeValue)};var g=i&&this.isNativeCode(i.contains),y=t&&this.isNativeCode(t.contains);o.contains=g&&y?function(t,e){return t.contains(e)}:g&&!y?function(e,n){return e===n||(e===t?t.documentElement:e).contains(n)}:i&&i.compareDocumentPosition?function(t,e){return t===e||!!(16&t.compareDocumentPosition(e))}:function(t,e){if(e)do if(e===t)return!0;while(e=e.parentNode);return!1},o.documentSorter=i.compareDocumentPosition?function(t,e){return t.compareDocumentPosition&&e.compareDocumentPosition?4&t.compareDocumentPosition(e)?-1:t===e?0:1:0}:"sourceIndex"in i?function(t,e){return t.sourceIndex&&e.sourceIndex?t.sourceIndex-e.sourceIndex:0}:t.createRange?function(t,e){if(!t.ownerDocument||!e.ownerDocument)return 0;var n=t.ownerDocument.createRange(),r=e.ownerDocument.createRange();return n.setStart(t,0),n.setEnd(t,0),r.setStart(e,0),r.setEnd(e,0),n.compareBoundaryPoints(Range.START_TO_END,r)}:null,i=null;for(r in o)this[r]=o[r]}}};var r=/^([#.]?)((?:[\w-]+|\*))$/,i=/\[.+[*$^]=(?:""|'')?\]/,s={};t.search=function(t,e,n,o){var a=this.found=o?null:n||[];if(!t)return a;if(t.navigator)t=t.document;else if(!t.nodeType)return a;var u,c,l,f,p=this.uniques={},d=!(!n||!n.length),m=9==t.nodeType;if(this.document!==(m?t:t.ownerDocument)&&this.setDocument(t),d)for(c=a.length;c--;)p[this.getUID(a[c])]=!0;if("string"==typeof e){var v=e.match(r);t:if(v){var g=v[1],y=v[2];if(g){if("#"==g){if(!this.isHTMLDocument||!m)break t;if(l=t.getElementById(y),!l)return a;if(this.idGetsName&&l.getAttributeNode("id").nodeValue!=y)break t;if(o)return l||null;d&&p[this.getUID(l)]||a.push(l)}else if("."==g){if(!this.isHTMLDocument||(!t.getElementsByClassName||this.brokenGEBCN)&&t.querySelectorAll)break t;if(t.getElementsByClassName&&!this.brokenGEBCN){if(f=t.getElementsByClassName(y),o)return f[0]||null;for(c=0;l=f[c++];)d&&p[this.getUID(l)]||a.push(l)}else{var b=new RegExp("(^|\\s)"+h.escapeRegExp(y)+"(\\s|$)");for(f=t.getElementsByTagName("*"),c=0;l=f[c++];)if(className=l.className,className&&b.test(className)){if(o)return l;d&&p[this.getUID(l)]||a.push(l)}}}}else{if("*"==y&&this.brokenStarGEBTN)break t;if(f=t.getElementsByTagName(y),o)return f[0]||null;for(c=0;l=f[c++];)d&&p[this.getUID(l)]||a.push(l)}return d&&this.sort(a),o?null:a}t:if(t.querySelectorAll){if(!this.isHTMLDocument||s[e]||this.brokenMixedCaseQSA||this.brokenCheckedQSA&&e.indexOf(":checked")>-1||this.brokenEmptyAttributeQSA&&i.test(e)||!m&&e.indexOf(",")>-1||h.disableQSA)break t;var x,E=e,S=t;m||(x=S.getAttribute("id"),slickid="slickid__",S.setAttribute("id",slickid),E="#"+slickid+" "+E,t=S.parentNode);try{if(o)return t.querySelector(E)||null;f=t.querySelectorAll(E)}catch(w){s[e]=1;break t}finally{m||(x?S.setAttribute("id",x):S.removeAttribute("id"),t=S)}if(this.starSelectsClosedQSA)for(c=0;l=f[c++];)!(l.nodeName>"@")||d&&p[this.getUID(l)]||a.push(l);else for(c=0;l=f[c++];)d&&p[this.getUID(l)]||a.push(l);return d&&this.sort(a),a}if(u=this.Slick.parse(e),!u.length)return a}else{if(null==e)return a;if(!e.Slick)return this.contains(t.documentElement||t,e)?(a?a.push(e):a=e,a):a;u=e}this.posNTH={},this.posNTHLast={},this.posNTHType={},this.posNTHTypeLast={},this.push=!d&&(o||1==u.length&&1==u.expressions[0].length)?this.pushArray:this.pushUID,null==a&&(a=[]);var k,T,C,N,O,A,L,M,$,j,D,P,H,F,R=u.expressions;t:for(c=0;P=R[c];c++)for(k=0;H=P[k];k++){if(N="combinator:"+H.combinator,!this[N])continue t;if(O=this.isXMLDocument?H.tag:H.tag.toUpperCase(),A=H.id,L=H.classList,M=H.classes,$=H.attributes,j=H.pseudos,F=k===P.length-1,this.bitUniques={},F?(this.uniques=p,this.found=a):(this.uniques={},this.found=[]),0===k){if(this[N](t,O,A,M,$,j,L),o&&F&&a.length)break t}else if(o&&F){for(T=0,C=D.length;C>T;T++)if(this[N](D[T],O,A,M,$,j,L),a.length)break t}else for(T=0,C=D.length;C>T;T++)this[N](D[T],O,A,M,$,j,L);D=this.found}return(d||u.expressions.length>1)&&this.sort(a),o?a[0]||null:a},t.uidx=1,t.uidk="slick-uniqueid",t.getUIDXML=function(t){var e=t.getAttribute(this.uidk);return e||(e=this.uidx++,t.setAttribute(this.uidk,e)),e},t.getUIDHTML=function(t){return t.uniqueNumber||(t.uniqueNumber=this.uidx++)},t.sort=function(t){return this.documentSorter?(t.sort(this.documentSorter),t):t},t.cacheNTH={},t.matchNTH=/^([+-]?\d*)?([a-z]+)?([+-]\d+)?$/,t.parseNTHArgument=function(t){var e=t.match(this.matchNTH);if(!e)return!1;var n=e[2]||!1,r=e[1]||1;"-"==r&&(r=-1);var i=+e[3]||0;return e="n"==n?{a:r,b:i}:"odd"==n?{a:2,b:1}:"even"==n?{a:2,b:0}:{a:0,b:r},this.cacheNTH[t]=e},t.createNTHPseudo=function(t,e,n,r){return function(i,s){var o=this.getUID(i);if(!this[n][o]){var a=i.parentNode;if(!a)return!1;var u=a[t],c=1;if(r){var l=i.nodeName;do u.nodeName==l&&(this[n][this.getUID(u)]=c++);while(u=u[e])}else do 1==u.nodeType&&(this[n][this.getUID(u)]=c++);while(u=u[e])}s=s||"n";var h=this.cacheNTH[s]||this.parseNTHArgument(s);if(!h)return!1;var f=h.a,p=h.b,d=this[n][o];if(0==f)return p==d;if(f>0){if(p>d)return!1}else if(d>p)return!1;return(d-p)%f==0}},t.pushArray=function(t,e,n,r,i,s){this.matchSelector(t,e,n,r,i,s)&&this.found.push(t)},t.pushUID=function(t,e,n,r,i,s){var o=this.getUID(t);!this.uniques[o]&&this.matchSelector(t,e,n,r,i,s)&&(this.uniques[o]=!0,this.found.push(t))},t.matchNode=function(t,e){if(this.isHTMLDocument&&this.nativeMatchesSelector)try{return this.nativeMatchesSelector.call(t,e.replace(/\[([^=]+)=\s*([^'"\]]+?)\s*\]/g,'[$1="$2"]'))}catch(n){}var r=this.Slick.parse(e);if(!r)return!0;var i,s,o=r.expressions,a=0;for(i=0;s=o[i];i++)if(1==s.length){var u=s[0];if(this.matchSelector(t,this.isXMLDocument?u.tag:u.tag.toUpperCase(),u.id,u.classes,u.attributes,u.pseudos))return!0;a++}if(a==r.length)return!1;var c,l=this.search(this.document,r);for(i=0;c=l[i++];)if(c===t)return!0;return!1},t.matchPseudo=function(t,e,n){var r="pseudo:"+e;if(this[r])return this[r](t,n);var i=this.getAttribute(t,e);return n?n==i:!!i},t.matchSelector=function(t,e,n,r,i,s){if(e){var o=this.isXMLDocument?t.nodeName:t.nodeName.toUpperCase();if("*"==e){if("@">o)return!1}else if(o!=e)return!1}if(n&&t.getAttribute("id")!=n)return!1;var a,u,c;if(r)for(a=r.length;a--;)if(c=this.getAttribute(t,"class"),!c||!r[a].regexp.test(c))return!1;if(i)for(a=i.length;a--;)if(u=i[a],u.operator?!u.test(this.getAttribute(t,u.key)):!this.hasAttribute(t,u.key))return!1;if(s)for(a=s.length;a--;)if(u=s[a],!this.matchPseudo(t,u.key,u.value))return!1;return!0};var o={" ":function(t,e,n,r,i,s,o){var a,u,c;if(this.isHTMLDocument){t:if(n){if(u=this.document.getElementById(n),!u&&t.all||this.idGetsName&&u&&u.getAttributeNode("id").nodeValue!=n){if(c=t.all[n],!c)return;for(c[0]||(c=[c]),a=0;u=c[a++];){var l=u.getAttributeNode("id");if(l&&l.nodeValue==n){this.push(u,e,null,r,i,s);break}}return}if(!u){if(this.contains(this.root,t))return;break t}if(this.document!==t&&!this.contains(t,u))return;return void this.push(u,e,null,r,i,s)}t:if(r&&t.getElementsByClassName&&!this.brokenGEBCN){if(c=t.getElementsByClassName(o.join(" ")),
!c||!c.length)break t;for(a=0;u=c[a++];)this.push(u,e,n,null,i,s);return}}if(c=t.getElementsByTagName(e),c&&c.length)for(this.brokenStarGEBTN||(e=null),a=0;u=c[a++];)this.push(u,e,n,r,i,s)},">":function(t,e,n,r,i,s){if(t=t.firstChild)do 1==t.nodeType&&this.push(t,e,n,r,i,s);while(t=t.nextSibling)},"+":function(t,e,n,r,i,s){for(;t=t.nextSibling;)if(1==t.nodeType){this.push(t,e,n,r,i,s);break}},"^":function(t,e,n,r,i,s){t=t.firstChild,t&&(1==t.nodeType?this.push(t,e,n,r,i,s):this["combinator:+"](t,e,n,r,i,s))},"~":function(t,e,n,r,i,s){for(;t=t.nextSibling;)if(1==t.nodeType){var o=this.getUID(t);if(this.bitUniques[o])break;this.bitUniques[o]=!0,this.push(t,e,n,r,i,s)}},"++":function(t,e,n,r,i,s){this["combinator:+"](t,e,n,r,i,s),this["combinator:!+"](t,e,n,r,i,s)},"~~":function(t,e,n,r,i,s){this["combinator:~"](t,e,n,r,i,s),this["combinator:!~"](t,e,n,r,i,s)},"!":function(t,e,n,r,i,s){for(;t=t.parentNode;)t!==this.document&&this.push(t,e,n,r,i,s)},"!>":function(t,e,n,r,i,s){t=t.parentNode,t!==this.document&&this.push(t,e,n,r,i,s)},"!+":function(t,e,n,r,i,s){for(;t=t.previousSibling;)if(1==t.nodeType){this.push(t,e,n,r,i,s);break}},"!^":function(t,e,n,r,i,s){t=t.lastChild,t&&(1==t.nodeType?this.push(t,e,n,r,i,s):this["combinator:!+"](t,e,n,r,i,s))},"!~":function(t,e,n,r,i,s){for(;t=t.previousSibling;)if(1==t.nodeType){var o=this.getUID(t);if(this.bitUniques[o])break;this.bitUniques[o]=!0,this.push(t,e,n,r,i,s)}}};for(var a in o)t["combinator:"+a]=o[a];var u={empty:function(t){var e=t.firstChild;return!(e&&1==e.nodeType||(t.innerText||t.textContent||"").length)},not:function(t,e){return!this.matchNode(t,e)},contains:function(t,e){return(t.innerText||t.textContent||"").indexOf(e)>-1},"first-child":function(t){for(;t=t.previousSibling;)if(1==t.nodeType)return!1;return!0},"last-child":function(t){for(;t=t.nextSibling;)if(1==t.nodeType)return!1;return!0},"only-child":function(t){for(var e=t;e=e.previousSibling;)if(1==e.nodeType)return!1;for(var n=t;n=n.nextSibling;)if(1==n.nodeType)return!1;return!0},"nth-child":t.createNTHPseudo("firstChild","nextSibling","posNTH"),"nth-last-child":t.createNTHPseudo("lastChild","previousSibling","posNTHLast"),"nth-of-type":t.createNTHPseudo("firstChild","nextSibling","posNTHType",!0),"nth-last-of-type":t.createNTHPseudo("lastChild","previousSibling","posNTHTypeLast",!0),index:function(t,e){return this["pseudo:nth-child"](t,""+(e+1))},even:function(t){return this["pseudo:nth-child"](t,"2n")},odd:function(t){return this["pseudo:nth-child"](t,"2n+1")},"first-of-type":function(t){for(var e=t.nodeName;t=t.previousSibling;)if(t.nodeName==e)return!1;return!0},"last-of-type":function(t){for(var e=t.nodeName;t=t.nextSibling;)if(t.nodeName==e)return!1;return!0},"only-of-type":function(t){for(var e=t,n=t.nodeName;e=e.previousSibling;)if(e.nodeName==n)return!1;for(var r=t;r=r.nextSibling;)if(r.nodeName==n)return!1;return!0},enabled:function(t){return!t.disabled},disabled:function(t){return t.disabled},checked:function(t){return t.checked||t.selected},focus:function(t){return this.isHTMLDocument&&this.document.activeElement===t&&(t.href||t.type||this.hasAttribute(t,"tabindex"))},root:function(t){return t===this.root},selected:function(t){return t.selected}};for(var c in u)t["pseudo:"+c]=u[c];var l=t.attributeGetters={"for":function(){return"htmlFor"in this?this.htmlFor:this.getAttribute("for")},href:function(){return"href"in this?this.getAttribute("href",2):this.getAttribute("href")},style:function(){return this.style?this.style.cssText:this.getAttribute("style")},tabindex:function(){var t=this.getAttributeNode("tabindex");return t&&t.specified?t.nodeValue:null},type:function(){return this.getAttribute("type")},maxlength:function(){var t=this.getAttributeNode("maxLength");return t&&t.specified?t.nodeValue:null}};l.MAXLENGTH=l.maxLength=l.maxlength;var h=t.Slick=this.Slick||{};h.version="1.1.7",h.search=function(e,n,r){return t.search(e,n,r)},h.find=function(e,n){return t.search(e,n,null,!0)},h.contains=function(e,n){return t.setDocument(e),t.contains(e,n)},h.getAttribute=function(e,n){return t.setDocument(e),t.getAttribute(e,n)},h.hasAttribute=function(e,n){return t.setDocument(e),t.hasAttribute(e,n)},h.match=function(e,n){return e&&n?n&&n!==e?(t.setDocument(e),t.matchNode(e,n)):!0:!1},h.defineAttributeGetter=function(e,n){return t.attributeGetters[e]=n,this},h.lookupAttributeGetter=function(e){return t.attributeGetters[e]},h.definePseudo=function(e,n){return t["pseudo:"+e]=function(t,e){return n.call(t,e)},this},h.lookupPseudo=function(e){var n=t["pseudo:"+e];return n?function(t){return n.call(this,t)}:null},h.override=function(e,n){return t.override(e,n),this},h.isXML=t.isXML,h.uidOf=function(e){return t.getUIDHTML(e)},this.Slick||(this.Slick=h)}.apply("undefined"!=typeof exports?exports:this);var Element=this.Element=function(t,e){var n=Element.Constructors[t];if(n)return n(e);if("string"!=typeof t)return document.id(t).set(e);if(e||(e={}),!/^[\w-]+$/.test(t)){var r=Slick.parse(t).expressions[0][0];t="*"==r.tag?"div":r.tag,r.id&&null==e.id&&(e.id=r.id);var i=r.attributes;if(i)for(var s,o=0,a=i.length;a>o;o++)s=i[o],null==e[s.key]&&(null!=s.value&&"="==s.operator?e[s.key]=s.value:s.value||s.operator||(e[s.key]=!0));r.classList&&null==e["class"]&&(e["class"]=r.classList.join(" "))}return document.newElement(t,e)};Browser.Element&&(Element.prototype=Browser.Element.prototype,Element.prototype._fireEvent=function(t){return function(e,n){return t.call(this,e,n)}}(Element.prototype.fireEvent)),new Type("Element",Element).mirror(function(t){if(!Array.prototype[t]){var e={};e[t]=function(){for(var e=[],n=arguments,r=!0,i=0,s=this.length;s>i;i++){var o=this[i],a=e[i]=o[t].apply(o,n);r=r&&"element"==typeOf(a)}return r?new Elements(e):e},Elements.implement(e)}}),Browser.Element||(Element.parent=Object,Element.Prototype={$constructor:Element,$family:Function.convert("element").hide()},Element.mirror(function(t,e){Element.Prototype[t]=e})),Element.Constructors={};var IFrame=new Type("IFrame",function(){var t,e=Array.link(arguments,{properties:Type.isObject,iframe:function(t){return null!=t}}),n=e.properties||{};e.iframe&&(t=document.id(e.iframe));var r=n.onload||function(){};delete n.onload,n.id=n.name=[n.id,n.name,t?t.id||t.name:"IFrame_"+String.uniqueID()].pick(),t=new Element(t||"iframe",n);var i=function(){r.call(t.contentWindow)};return window.frames[n.id]?i():t.addListener("load",i),t}),Elements=this.Elements=function(t){if(t&&t.length)for(var e,n={},r=0;e=t[r++];){var i=Slick.uidOf(e);n[i]||(n[i]=!0,this.push(e))}};Elements.prototype={length:0},Elements.parent=Array,new Type("Elements",Elements).implement({filter:function(t,e){return t?new Elements(Array.filter(this,"string"==typeOf(t)?function(e){return e.match(t)}:t,e)):this}.protect(),push:function(){for(var t=this.length,e=0,n=arguments.length;n>e;e++){var r=document.id(arguments[e]);r&&(this[t++]=r)}return this.length=t}.protect(),unshift:function(){for(var t=[],e=0,n=arguments.length;n>e;e++){var r=document.id(arguments[e]);r&&t.push(r)}return Array.prototype.unshift.apply(this,t)}.protect(),concat:function(){for(var t=new Elements(this),e=0,n=arguments.length;n>e;e++){var r=arguments[e];Type.isEnumerable(r)?t.append(r):t.push(r)}return t}.protect(),append:function(t){for(var e=0,n=t.length;n>e;e++)this.push(t[e]);return this}.protect(),empty:function(){for(;this.length;)delete this[--this.length];return this}.protect()}),function(){var t=Array.prototype.splice,e={0:0,1:1,length:2};t.call(e,1,1),1==e[1]&&Elements.implement("splice",function(){for(var e=this.length,n=t.apply(this,arguments);e>=this.length;)delete this[e--];return n}.protect()),Array.forEachMethod(function(t,e){Elements.implement(e,t)}),Array.mirror(Elements);var n;try{n="x"==document.createElement("<input name=x>").name}catch(r){}var i=function(t){return(""+t).replace(/&/g,"&amp;").replace(/"/g,"&quot;")},s=function(){var t=document.createElement("style"),e=!1;try{t.innerHTML="#justTesing{margin: 0px;}",e=!!t.innerHTML}catch(n){}return e}();Document.implement({newElement:function(t,e){if(e){if(null!=e.checked&&(e.defaultChecked=e.checked),"checkbox"!=e.type&&"radio"!=e.type||null!=e.value||(e.value="on"),!s&&"style"==t){var r=document.createElement("style");return r.setAttribute("type","text/css"),e.type&&delete e.type,this.id(r).set(e)}n&&(t="<"+t,e.name&&(t+=' name="'+i(e.name)+'"'),e.type&&(t+=' type="'+i(e.type)+'"'),t+=">",delete e.name,delete e.type)}return this.id(this.createElement(t)).set(e)}})}(),function(){Slick.uidOf(window),Slick.uidOf(document),Document.implement({newTextNode:function(t){return this.createTextNode(t)},getDocument:function(){return this},getWindow:function(){return this.window},id:function(){var t={string:function(e,n,r){return e=Slick.find(r,"#"+e.replace(/(\W)/g,"\\$1")),e?t.element(e,n):null},element:function(t,e){if(Slick.uidOf(t),!e&&!t.$family&&!/^(?:object|embed)$/i.test(t.tagName)){var n=t.fireEvent;t._fireEvent=function(t,e){return n(t,e)},Object.append(t,Element.Prototype)}return t},object:function(e,n,r){return e.toElement?t.element(e.toElement(r),n):null}};return t.textnode=t.whitespace=t.window=t.document=function(t){return t},function(e,n,r){if(e&&e.$family&&e.uniqueNumber)return e;var i=typeOf(e);return t[i]?t[i](e,n,r||document):null}}()}),null==window.$&&Window.implement("$",function(t,e){return document.id(t,e,this.document)}),Window.implement({getDocument:function(){return this.document},getWindow:function(){return this}}),[Document,Element].invoke("implement",{getElements:function(t){return Slick.search(this,t,new Elements)},getElement:function(t){return document.id(Slick.find(this,t))}});var t={contains:function(t){return Slick.contains(this,t)}};document.contains||Document.implement(t),document.createElement("div").contains||Element.implement(t);var e=function(t,e){if(!t)return e;t=Object.clone(Slick.parse(t));for(var n=t.expressions,r=n.length;r--;)n[r][0].combinator=e;return t};Object.forEach({getNext:"~",getPrevious:"!~",getParent:"!"},function(t,n){Element.implement(n,function(n){return this.getElement(e(n,t))})}),Object.forEach({getAllNext:"~",getAllPrevious:"!~",getSiblings:"~~",getChildren:">",getParents:"!"},function(t,n){Element.implement(n,function(n){return this.getElements(e(n,t))})}),Element.implement({getFirst:function(t){return document.id(Slick.search(this,e(t,">"))[0])},getLast:function(t){return document.id(Slick.search(this,e(t,">")).getLast())},getWindow:function(){return this.ownerDocument.window},getDocument:function(){return this.ownerDocument},getElementById:function(t){return document.id(Slick.find(this,"#"+(""+t).replace(/(\W)/g,"\\$1")))},match:function(t){return!t||Slick.match(this,t)}}),null==window.$$&&Window.implement("$$",function(t){if(1==arguments.length){if("string"==typeof t)return Slick.search(this.document,t,new Elements);if(Type.isEnumerable(t))return new Elements(t)}return new Elements(arguments)});var n={before:function(t,e){var n=e.parentNode;n&&n.insertBefore(t,e)},after:function(t,e){var n=e.parentNode;n&&n.insertBefore(t,e.nextSibling)},bottom:function(t,e){e.appendChild(t)},top:function(t,e){e.insertBefore(t,e.firstChild)}};n.inside=n.bottom;var r={},i={},s={};Array.forEach(["type","value","defaultValue","accessKey","cellPadding","cellSpacing","colSpan","frameBorder","rowSpan","tabIndex","useMap"],function(t){s[t.toLowerCase()]=t}),s.html="innerHTML",s.text=null==document.createElement("div").textContent?"innerText":"textContent",Object.forEach(s,function(t,e){i[e]=function(e,n){e[t]=n},r[e]=function(e){return e[t]}}),i.text=function(){return function(t,e){"style"==t.get("tag")?t.set("html",e):t[s.text]=e}}(i.text),r.text=function(t){return function(e){return"style"==e.get("tag")?e.innerHTML:t(e)}}(r.text);var o=["compact","nowrap","ismap","declare","noshade","checked","disabled","readOnly","multiple","selected","noresize","defer","defaultChecked","autofocus","controls","autoplay","loop"],a={};Array.forEach(o,function(t){var e=t.toLowerCase();a[e]=t,i[e]=function(e,n){e[t]=!!n},r[e]=function(e){return!!e[t]}}),Object.append(i,{"class":function(t,e){"className"in t?t.className=e||"":t.setAttribute("class",e)},"for":function(t,e){"htmlFor"in t?t.htmlFor=e:t.setAttribute("for",e)},style:function(t,e){t.style?t.style.cssText=e:t.setAttribute("style",e)},value:function(t,e){t.value=null!=e?e:""}}),r["class"]=function(t){return"className"in t?t.className||null:t.getAttribute("class")};var u=document.createElement("button");try{u.type="button"}catch(c){}"button"!=u.type&&(i.type=function(t,e){t.setAttribute("type",e)}),u=null;var h,f,p=function(){var t=document.createElement("style"),e=!1;try{t.innerHTML="#justTesing{margin: 0px;}",e=!!t.innerHTML}catch(n){}return e}(),d=document.createElement("input");d.value="t",d.type="submit",h="t"!=d.value;try{d.value="",d.type="email",f="email"==d.type}catch(c){}d=null,(h||!f)&&(i.type=function(t,e){try{var n=t.value;t.type=e,t.value=n}catch(r){}});var m=function(t){return t.random="attribute","attribute"==t.getAttribute("random")}(document.createElement("div")),v=function(t){return t.innerHTML='<object><param name="should_fix" value="the unknown" /></object>',1!=t.cloneNode(!0).firstChild.childNodes.length}(document.createElement("div")),g=!!document.createElement("div").classList,y=function(t){var e=(t||"").clean().split(" "),n={};return e.filter(function(t){return""===t||n[t]?void 0:n[t]=t})},b=function(t){this.classList.add(t)},x=function(t){this.classList.remove(t)};Element.implement({setProperty:function(t,e){var n=i[t.toLowerCase()];if(n)n(this,e);else{var r;m&&(r=this.retrieve("$attributeWhiteList",{})),null==e?(this.removeAttribute(t),m&&delete r[t]):(this.setAttribute(t,""+e),m&&(r[t]=!0))}return this},setProperties:function(t){for(var e in t)this.setProperty(e,t[e]);return this},getProperty:function(t){var e=r[t.toLowerCase()];if(e)return e(this);if(m){var n=this.getAttributeNode(t),i=this.retrieve("$attributeWhiteList",{});if(!n)return null;if(n.expando&&!i[t]){var s=this.outerHTML;if(s.substr(0,s.search(/\/?['"]?>(?![^<]*<['"])/)).indexOf(t)<0)return null;i[t]=!0}}var o=Slick.getAttribute(this,t);return o||Slick.hasAttribute(this,t)?o:null},getProperties:function(){var t=Array.convert(arguments);return t.map(this.getProperty,this).associate(t)},removeProperty:function(t){return this.setProperty(t,null)},removeProperties:function(){return Array.each(arguments,this.removeProperty,this),this},set:function(t,e){var n=Element.Properties[t];n&&n.set?n.set.call(this,e):this.setProperty(t,e)}.overloadSetter(),get:function(t){var e=Element.Properties[t];return e&&e.get?e.get.apply(this):this.getProperty(t)}.overloadGetter(),erase:function(t){var e=Element.Properties[t];return e&&e.erase?e.erase.apply(this):this.removeProperty(t),this},hasClass:g?function(t){return this.classList.contains(t)}:function(t){return y(this.className).contains(t)},addClass:g?function(t){return y(t).forEach(b,this),this}:function(t){return this.className=y(t+" "+this.className).join(" "),this},removeClass:g?function(t){return y(t).forEach(x,this),this}:function(t){var e=y(this.className);return y(t).forEach(e.erase,e),this.className=e.join(" "),this},toggleClass:function(t,e){return null==e&&(e=!this.hasClass(t)),e?this.addClass(t):this.removeClass(t)},adopt:function(){var t,e=this,n=Array.flatten(arguments),r=n.length;r>1&&(e=t=document.createDocumentFragment());for(var i=0;r>i;i++){var s=document.id(n[i],!0);s&&e.appendChild(s)}return t&&this.appendChild(t),this},appendText:function(t,e){return this.grab(this.getDocument().newTextNode(t),e)},grab:function(t,e){return n[e||"bottom"](document.id(t,!0),this),this},inject:function(t,e){return n[e||"bottom"](this,document.id(t,!0)),this},replaces:function(t){return t=document.id(t,!0),t.parentNode.replaceChild(this,t),this},wraps:function(t,e){return t=document.id(t,!0),this.replaces(t).grab(t,e)},getSelected:function(){return this.selectedIndex,new Elements(Array.convert(this.options).filter(function(t){return t.selected}))},toQueryString:function(){var t=[];return this.getElements("input, select, textarea").each(function(e){var n=e.type;if(e.name&&!e.disabled&&"submit"!=n&&"reset"!=n&&"file"!=n&&"image"!=n){var r="select"==e.get("tag")?e.getSelected().map(function(t){return document.id(t).get("value")}):"radio"!=n&&"checkbox"!=n||e.checked?e.get("value"):null;Array.convert(r).each(function(n){"undefined"!=typeof n&&t.push(encodeURIComponent(e.name)+"="+encodeURIComponent(n))})}}),t.join("&")}});var E={before:"beforeBegin",after:"afterEnd",bottom:"beforeEnd",top:"afterBegin",inside:"beforeEnd"};Element.implement("appendHTML","insertAdjacentHTML"in document.createElement("div")?function(t,e){return this.insertAdjacentHTML(E[e||"bottom"],t),this}:function(t,e){var r=new Element("div",{html:t}),i=r.childNodes,s=r.firstChild;if(!s)return this;if(i.length>1){s=document.createDocumentFragment();for(var o=0,a=i.length;a>o;o++)s.appendChild(i[o])}return n[e||"bottom"](s,this),this});var S={},w={},k=function(t){return w[t]||(w[t]={})},T=function(t){var e=t.uniqueNumber;return t.removeEvents&&t.removeEvents(),t.clearAttributes&&t.clearAttributes(),null!=e&&(delete S[e],delete w[e]),t},C={input:"checked",option:"selected",textarea:"value"};if(Element.implement({destroy:function(){var t=T(this).getElementsByTagName("*");return Array.each(t,T),Element.dispose(this),null},empty:function(){return Array.convert(this.childNodes).each(Element.dispose),this},dispose:function(){return this.parentNode?this.parentNode.removeChild(this):this},clone:function(t,e){t=t!==!1;var n,r=this.cloneNode(t),i=[r],s=[this];for(t&&(i.append(Array.convert(r.getElementsByTagName("*"))),s.append(Array.convert(this.getElementsByTagName("*")))),n=i.length;n--;){var o=i[n],a=s[n];if(e||o.removeAttribute("id"),o.clearAttributes&&(o.clearAttributes(),o.mergeAttributes(a),o.removeAttribute("uniqueNumber"),o.options))for(var u=o.options,c=a.options,l=u.length;l--;)u[l].selected=c[l].selected;var h=C[a.tagName.toLowerCase()];h&&a[h]&&(o[h]=a[h])}if(v){var f=r.getElementsByTagName("object"),p=this.getElementsByTagName("object");for(n=f.length;n--;)f[n].outerHTML=p[n].outerHTML}return document.id(r)}}),[Element,Window,Document].invoke("implement",{addListener:function(t,e){return window.attachEvent&&!window.addEventListener&&(S[Slick.uidOf(this)]=this),this.addEventListener?this.addEventListener(t,e,!!arguments[2]):this.attachEvent("on"+t,e),this},removeListener:function(t,e){return this.removeEventListener?this.removeEventListener(t,e,!!arguments[2]):this.detachEvent("on"+t,e),this},retrieve:function(t,e){var n=k(Slick.uidOf(this)),r=n[t];return null!=e&&null==r&&(r=n[t]=e),null!=r?r:null},store:function(t,e){var n=k(Slick.uidOf(this));return n[t]=e,this},eliminate:function(t){var e=k(Slick.uidOf(this));return delete e[t],this}}),window.attachEvent&&!window.addEventListener){var N=function(){Object.each(S,T),window.CollectGarbage&&CollectGarbage(),window.removeListener("unload",N)};window.addListener("unload",N)}Element.Properties={},Element.Properties.style={set:function(t){this.style.cssText=t},get:function(){return this.style.cssText},erase:function(){this.style.cssText=""}},Element.Properties.tag={get:function(){return this.tagName.toLowerCase()}},Element.Properties.html={set:function(t){null==t?t="":"array"==typeOf(t)&&(t=t.join("")),this.styleSheet&&!p?this.styleSheet.cssText=t:this.innerHTML=t},erase:function(){this.set("html","")}};var O,A=!0,L=!0,M=!0,$=document.createElement("div");if($.innerHTML="<nav></nav>",A=1==$.childNodes.length,!A){var j="abbr article aside audio canvas datalist details figcaption figure footer header hgroup mark meter nav output progress section summary time video".split(" ");for(O=document.createDocumentFragment(),l=j.length;l--;)O.createElement(j[l])}$=null,L=Function.attempt(function(){var t=document.createElement("table");return t.innerHTML="<tr><td></td></tr>",!0});var D=document.createElement("tr"),P="<td></td>";D.innerHTML=P,M=D.innerHTML==P,D=null,L&&M&&A||(Element.Properties.html.set=function(t){var e={table:[1,"<table>","</table>"],select:[1,"<select>","</select>"],tbody:[2,"<table><tbody>","</tbody></table>"],tr:[3,"<table><tbody><tr>","</tr></tbody></table>"]};return e.thead=e.tfoot=e.tbody,function(n){if(this.styleSheet)return t.call(this,n);var r=e[this.get("tag")];if(r||A||(r=[0,"",""]),!r)return t.call(this,n);var i=r[0],s=document.createElement("div"),o=s;for(A||O.appendChild(s),s.innerHTML=[r[1],n,r[2]].flatten().join("");i--;)o=o.firstChild;this.empty().adopt(o.childNodes),A||O.removeChild(s),s=null}}(Element.Properties.html.set));var H=document.createElement("form");H.innerHTML="<select><option>s</option></select>","s"!=H.firstChild.value&&(Element.Properties.value={set:function(t){var e=this.get("tag");if("select"!=e)return this.setProperty("value",t);var n=this.getElements("option");t=String(t);for(var r=0;r<n.length;r++){var i=n[r],s=i.getAttributeNode("value"),o=s&&s.specified?i.value:i.get("text");if(o===t)return i.selected=!0}},get:function(){var t=this,e=t.get("tag");if("select"!=e&&"option"!=e)return this.getProperty("value");if("select"==e&&!(t=t.getSelected()[0]))return"";var n=t.getAttributeNode("value");return n&&n.specified?t.value:t.get("text")}}),H=null,document.createElement("div").getAttributeNode("id")&&(Element.Properties.id={set:function(t){this.id=this.getAttributeNode("id").value=t},get:function(){return this.id||null},erase:function(){this.id=this.getAttributeNode("id").value=""}})}(),function(){var t={},e=function(t){var e;if(t.wheelDelta)e=t.wheelDelta%120==0?t.wheelDelta/120:t.wheelDelta/12;else{var n=t.deltaY||t.detail||0;e=-(n%3==0?n/3:10*n)}return e},n=this.DOMEvent=new Type("DOMEvent",function(n,r){if(r||(r=window),n=n||r.event,n.$extended)return n;this.event=n,this.$extended=!0,this.shift=n.shiftKey,this.control=n.ctrlKey,this.alt=n.altKey,this.meta=n.metaKey;for(var i=this.type=n.type,s=n.target||n.srcElement;s&&3==s.nodeType;)s=s.parentNode;if(this.target=document.id(s),0==i.indexOf("key")){var o=this.code=n.which||n.keyCode;this.shift&&"keypress"==i||(this.key=t[o]),("keydown"==i||"keyup"==i)&&(o>111&&124>o?this.key="f"+(o-111):o>95&&106>o&&(this.key=o-96)),null==this.key&&(this.key=String.fromCharCode(o).toLowerCase())}else if("click"==i||"dblclick"==i||"contextmenu"==i||"wheel"==i||"DOMMouseScroll"==i||0==i.indexOf("mouse")){var a=r.document;if(a=a.compatMode&&"CSS1Compat"!=a.compatMode?a.body:a.html,this.page={x:null!=n.pageX?n.pageX:n.clientX+a.scrollLeft,y:null!=n.pageY?n.pageY:n.clientY+a.scrollTop},this.client={x:null!=n.pageX?n.pageX-r.pageXOffset:n.clientX,y:null!=n.pageY?n.pageY-r.pageYOffset:n.clientY},("DOMMouseScroll"==i||"wheel"==i||"mousewheel"==i)&&(this.wheel=e(n)),this.rightClick=3==n.which||2==n.button,"mouseover"==i||"mouseout"==i||"mouseenter"==i||"mouseleave"==i){for(var u="mouseover"==i||"mouseenter"==i,c=n.relatedTarget||n[(u?"from":"to")+"Element"];c&&3==c.nodeType;)c=c.parentNode;this.relatedTarget=document.id(c)}}else if(0==i.indexOf("touch")||0==i.indexOf("gesture")){this.rotation=n.rotation,this.scale=n.scale,this.targetTouches=n.targetTouches,this.changedTouches=n.changedTouches;var l=this.touches=n.touches;if(l&&l[0]){var h=l[0];this.page={x:h.pageX,y:h.pageY},this.client={x:h.clientX,y:h.clientY}}}this.client||(this.client={}),this.page||(this.page={})});n.implement({stop:function(){return this.preventDefault().stopPropagation()},stopPropagation:function(){return this.event.stopPropagation?this.event.stopPropagation():this.event.cancelBubble=!0,this},preventDefault:function(){return this.event.preventDefault?this.event.preventDefault():this.event.returnValue=!1,this}}),n.defineKey=function(e,n){return t[e]=n,this},n.defineKeys=n.defineKey.overloadSetter(!0),n.defineKeys({38:"up",40:"down",37:"left",39:"right",27:"esc",32:"space",8:"backspace",9:"tab",46:"delete",13:"enter"})}(),function(){Element.Properties.events={set:function(t){this.addEvents(t)}},[Element,Window,Document].invoke("implement",{addEvent:function(t,e){var n=this.retrieve("events",{});if(n[t]||(n[t]={keys:[],values:[]}),n[t].keys.contains(e))return this;n[t].keys.push(e);var r=t,i=Element.Events[t],s=e,o=this;i&&(i.onAdd&&i.onAdd.call(this,e,t),i.condition&&(s=function(n){return i.condition.call(this,n,t)?e.call(this,n):!0}),i.base&&(r=Function.convert(i.base).call(this,t)));var a=function(){return e.call(o)},u=Element.NativeEvents[r];return u&&(2==u&&(a=function(t){t=new DOMEvent(t,o.getWindow()),s.call(o,t)===!1&&t.stop()}),this.addListener(r,a,arguments[2])),n[t].values.push(a),this},removeEvent:function(t,e){var n=this.retrieve("events");if(!n||!n[t])return this;var r=n[t],i=r.keys.indexOf(e);if(-1==i)return this;var s=r.values[i];delete r.keys[i],delete r.values[i];var o=Element.Events[t];return o&&(o.onRemove&&o.onRemove.call(this,e,t),o.base&&(t=Function.convert(o.base).call(this,t))),Element.NativeEvents[t]?this.removeListener(t,s,arguments[2]):this},addEvents:function(t){for(var e in t)this.addEvent(e,t[e]);return this},removeEvents:function(t){var e;if("object"==typeOf(t)){for(e in t)this.removeEvent(e,t[e]);return this}var n=this.retrieve("events");if(!n)return this;if(t)n[t]&&(n[t].keys.each(function(e){this.removeEvent(t,e)},this),delete n[t]);else{for(e in n)this.removeEvents(e);this.eliminate("events")}return this},fireEvent:function(t,e,n){var r=this.retrieve("events");return r&&r[t]?(e=Array.convert(e),r[t].keys.each(function(t){n?t.delay(n,this,e):t.apply(this,e)},this),this):this},cloneEvents:function(t,e){t=document.id(t);var n=t.retrieve("events");if(!n)return this;if(e)n[e]&&n[e].keys.each(function(t){this.addEvent(e,t)},this);else for(var r in n)this.cloneEvents(t,r);return this}}),Element.NativeEvents={click:2,dblclick:2,mouseup:2,mousedown:2,contextmenu:2,wheel:2,mousewheel:2,DOMMouseScroll:2,mouseover:2,mouseout:2,mousemove:2,selectstart:2,selectend:2,keydown:2,keypress:2,keyup:2,orientationchange:2,touchstart:2,touchmove:2,touchend:2,touchcancel:2,gesturestart:2,gesturechange:2,gestureend:2,focus:2,blur:2,change:2,reset:2,select:2,submit:2,paste:2,input:2,load:2,unload:1,beforeunload:2,resize:1,move:1,DOMContentLoaded:1,readystatechange:1,hashchange:1,popstate:2,pageshow:2,pagehide:2,error:1,abort:1,scroll:1,message:2},Element.Events={mousewheel:{base:"onwheel"in document?"wheel":"onmousewheel"in document?"mousewheel":"DOMMouseScroll"}};var t=function(t){var e=t.relatedTarget;return null==e?!0:e?e!=this&&"xul"!=e.prefix&&"document"!=typeOf(this)&&!this.contains(e):!1};"onmouseenter"in document.documentElement?(Element.NativeEvents.mouseenter=Element.NativeEvents.mouseleave=2,Element.MouseenterCheck=t):(Element.Events.mouseenter={base:"mouseover",condition:t},Element.Events.mouseleave={base:"mouseout",condition:t}),window.addEventListener||(Element.NativeEvents.propertychange=2,Element.Events.change={base:function(){var t=this.type;return"input"!=this.get("tag")||"radio"!=t&&"checkbox"!=t?"change":"propertychange"},condition:function(t){return"propertychange"!=t.type||"checked"==t.event.propertyName}})}(),function(){var t=!!window.addEventListener;Element.NativeEvents.focusin=Element.NativeEvents.focusout=2;var e=function(t,e,n,r,i){for(;i&&i!=t;){if(e(i,r))return n.call(i,r,i);i=document.id(i.parentNode)}},n={mouseenter:{base:"mouseover",condition:Element.MouseenterCheck},mouseleave:{base:"mouseout",condition:Element.MouseenterCheck},focus:{base:"focus"+(t?"":"in"),capture:!0},blur:{base:t?"blur":"focusout",capture:!0}},r="$delegation:",i=function(t){return{base:"focusin",remove:function(e,n){var i=e.retrieve(r+t+"listeners",{})[n];if(i&&i.forms)for(var s=i.forms.length;s--;)i.forms[s].removeEvent&&i.forms[s].removeEvent(t,i.fns[s])},listen:function(n,i,s,o,a,u){var c="form"==a.get("tag")?a:o.target.getParent("form");if(c){var l=n.retrieve(r+t+"listeners",{}),h=l[u]||{forms:[],fns:[]},f=h.forms,p=h.fns;if(-1==f.indexOf(c)){f.push(c);var d=function(t){e(n,i,s,t,a)};c.addEvent(t,d),p.push(d),l[u]=h,n.store(r+t+"listeners",l)}}}}},s=function(t){return{base:"focusin",listen:function(n,r,i,s,o){var a={blur:function(){this.removeEvents(a)}};a[t]=function(t){e(n,r,i,t,o)},s.target.addEvents(a)}}};t||Object.append(n,{submit:i("submit"),reset:i("reset"),change:s("change"),select:s("select")});var o=Element.prototype,a=o.addEvent,u=o.removeEvent,c=function(t,e){return function(n,r,i){if(-1==n.indexOf(":relay"))return t.call(this,n,r,i);var s=Slick.parse(n).expressions[0][0];if("relay"!=s.pseudos[0].key)return t.call(this,n,r,i);var o=s.tag;return s.pseudos.slice(1).each(function(t){o+=":"+t.key+(t.value?"("+t.value+")":"")}),t.call(this,n,r),e.call(this,o,s.pseudos[0].value,r)}},l={addEvent:function(t,r,i){var s=this.retrieve("$delegates",{}),o=s[t];if(o)for(var u in o)if(o[u].fn==i&&o[u].match==r)return this;var c=t,l=r,h=i,f=n[t]||{};t=f.base||c,r=function(t){return Slick.match(t,l)};var p=Element.Events[c];if(f.condition||p&&p.condition){var d=r,m=f.condition||p.condition;r=function(e,n){return d(e,n)&&m.call(e,n,t)}}var v=this,g=String.uniqueID(),y=f.listen?function(t,e){!e&&t&&t.target&&(e=t.target),e&&f.listen(v,r,i,t,e,g)}:function(t,n){!n&&t&&t.target&&(n=t.target),n&&e(v,r,i,t,n)};return o||(o={}),o[g]={match:l,fn:h,delegator:y},s[c]=o,a.call(this,t,y,f.capture)},removeEvent:function(t,e,r,i){var s=this.retrieve("$delegates",{}),o=s[t];if(!o)return this;if(i){var a=t,c=o[i].delegator,h=n[t]||{};return t=h.base||a,h.remove&&h.remove(this,i),delete o[i],s[a]=o,u.call(this,t,c,h.capture)}var f,p;if(r){for(f in o)if(p=o[f],p.match==e&&p.fn==r)return l.removeEvent.call(this,t,e,r,f)}else for(f in o)p=o[f],p.match==e&&l.removeEvent.call(this,t,e,p.fn,f);return this}};[Element,Window,Document].invoke("implement",{addEvent:c(a,l.addEvent),removeEvent:c(u,l.removeEvent)})}(),function(){var t,e=document.html;t=document.createElement("div"),t.style.color="red",t.style.color=null;var n="red"==t.style.color,r="1px solid #123abc";t.style.border=r;var i=t.style.border!=r;t=null;var s=!!window.getComputedStyle,o=null!=document.createElement("div").style.borderRadius;Element.Properties.styles={set:function(t){this.setStyles(t)}};var a=null!=e.style.opacity,u=null!=e.style.filter,c=/alpha\(opacity=([\d.]+)\)/i,l=function(t,e){t.store("$opacity",e),t.style.visibility=e>0||null==e?"visible":"hidden"},h=function(t,e,n){var r=t.style,i=r.filter||t.getComputedStyle("filter")||"";r.filter=(e.test(i)?i.replace(e,n):i+" "+n).trim(),r.filter||r.removeAttribute("filter")},f=a?function(t,e){t.style.opacity=e}:u?function(t,e){t.currentStyle&&t.currentStyle.hasLayout||(t.style.zoom=1),null==e||1==e?(h(t,c,""),1==e&&1!=p(t)&&h(t,c,"alpha(opacity=100)")):h(t,c,"alpha(opacity="+(100*e).limit(0,100).round()+")")}:l,p=a?function(t){var e=t.style.opacity||t.getComputedStyle("opacity");return""==e?1:e.toFloat()}:u?function(t){var e,n=t.style.filter||t.getComputedStyle("filter");return n&&(e=n.match(c)),null==e||null==n?1:e[1]/100}:function(t){var e=t.retrieve("$opacity");return null==e&&(e="hidden"==t.style.visibility?0:1),e},d=null==e.style.cssFloat?"styleFloat":"cssFloat",m={left:"0%",top:"0%",center:"50%",right:"100%",bottom:"100%"},v=null!=e.style.backgroundPositionX,g=/^-(ms)-/,y=function(t){return t.replace(g,"$1-").camelCase()},b=function(t,e){"backgroundPosition"==e&&(t.removeAttribute(e+"X"),e+="Y"),t.removeAttribute(e)};Element.implement({getComputedStyle:function(t){if(!s&&this.currentStyle)return this.currentStyle[y(t)];var e=Element.getDocument(this).defaultView,n=e?e.getComputedStyle(this,null):null;return n?n.getPropertyValue(t==d?"float":t.hyphenate()):""},setStyle:function(t,e){if("opacity"==t)return null!=e&&(e=parseFloat(e)),f(this,e),this;if(t=y("float"==t?d:t),"string"!=typeOf(e)){var r=(Element.Styles[t]||"@").split(" ");e=Array.convert(e).map(function(t,e){return r[e]?"number"==typeOf(t)?r[e].replace("@",Math.round(t)):t:""}).join(" ")}else e==String(Number(e))&&(e=Math.round(e));return this.style[t]=e,(""==e||null==e)&&n&&this.style.removeAttribute&&b(this.style,t),
this},getStyle:function(t){if("opacity"==t)return p(this);if(t=y("float"==t?d:t),o&&-1!=t.indexOf("borderRadius"))return["borderTopLeftRadius","borderTopRightRadius","borderBottomRightRadius","borderBottomLeftRadius"].map(function(t){return this.style[t]||"0px"},this).join(" ");var e=this.style[t];if(!e||"zIndex"==t){if(Element.ShortStyles.hasOwnProperty(t)){e=[];for(var n in Element.ShortStyles[t])e.push(this.getStyle(n));return e.join(" ")}e=this.getComputedStyle(t)}if(v&&/^backgroundPosition[XY]?$/.test(t))return e.replace(/(top|right|bottom|left)/g,function(t){return m[t]})||"0px";if(!e&&"backgroundPosition"==t)return"0px 0px";if(e){e=String(e);var r=e.match(/rgba?\([\d\s,]+\)/);r&&(e=e.replace(r[0],r[0].rgbToHex()))}if(!s&&!this.style[t]){if(/^(height|width)$/.test(t)&&!/px$/.test(e)){var a="width"==t?["left","right"]:["top","bottom"],u=0;return a.each(function(t){u+=this.getStyle("border-"+t+"-width").toInt()+this.getStyle("padding-"+t).toInt()},this),this["offset"+t.capitalize()]-u+"px"}if(/^border(.+)Width|margin|padding/.test(t)&&isNaN(parseFloat(e)))return"0px"}return i&&/^border(Top|Right|Bottom|Left)?$/.test(t)&&/^#/.test(e)?e.replace(/^(.+)\s(.+)\s(.+)$/,"$2 $3 $1"):e},setStyles:function(t){for(var e in t)this.setStyle(e,t[e]);return this},getStyles:function(){var t={};return Array.flatten(arguments).each(function(e){t[e]=this.getStyle(e)},this),t}}),Element.Styles={left:"@px",top:"@px",bottom:"@px",right:"@px",width:"@px",height:"@px",maxWidth:"@px",maxHeight:"@px",minWidth:"@px",minHeight:"@px",backgroundColor:"rgb(@, @, @)",backgroundSize:"@px",backgroundPosition:"@px @px",color:"rgb(@, @, @)",fontSize:"@px",letterSpacing:"@px",lineHeight:"@px",clip:"rect(@px @px @px @px)",margin:"@px @px @px @px",padding:"@px @px @px @px",border:"@px @ rgb(@, @, @) @px @ rgb(@, @, @) @px @ rgb(@, @, @)",borderWidth:"@px @px @px @px",borderStyle:"@ @ @ @",borderColor:"rgb(@, @, @) rgb(@, @, @) rgb(@, @, @) rgb(@, @, @)",zIndex:"@",zoom:"@",fontWeight:"@",textIndent:"@px",opacity:"@",borderRadius:"@px @px @px @px"},Element.ShortStyles={margin:{},padding:{},border:{},borderWidth:{},borderStyle:{},borderColor:{}},["Top","Right","Bottom","Left"].each(function(t){var e=Element.ShortStyles,n=Element.Styles;["margin","padding"].each(function(r){var i=r+t;e[r][i]=n[i]="@px"});var r="border"+t;e.border[r]=n[r]="@px @ rgb(@, @, @)";var i=r+"Width",s=r+"Style",o=r+"Color";e[r]={},e.borderWidth[i]=e[r][i]=n[i]="@px",e.borderStyle[s]=e[r][s]=n[s]="@",e.borderColor[o]=e[r][o]=n[o]="rgb(@, @, @)"}),v&&(Element.ShortStyles.backgroundPosition={backgroundPositionX:"@",backgroundPositionY:"@"})}(),function(){function t(t,e){return p(t,e).toInt()||0}function e(e){return t(e,"border-top-width")}function n(e){return t(e,"border-left-width")}function r(t){return/^(?:body|html)$/i.test(t.tagName)}function i(t){var e=t.getDocument();return e.compatMode&&"CSS1Compat"!=e.compatMode?e.body:e.html}var s=document.createElement("div"),o=document.createElement("div");s.style.height="0",s.appendChild(o);var a=o.offsetParent===s;s=o=null;var u=["height","paddingTop","paddingBottom","borderTopWidth","borderBottomWidth"],c=["width","paddingLeft","paddingRight","borderLeftWidth","borderRightWidth"],l=function(t){var e=window.getComputedStyle(t),n={x:0,y:0};return u.each(function(t){n.y+=parseFloat(e[t])}),c.each(function(t){n.x+=parseFloat(e[t])}),n},h=function(t){return"static"!=p(t,"position")||r(t)},f=function(t){return h(t)||/^(?:table|td|th)$/i.test(t.tagName)};Element.implement({scrollTo:function(t,e){return r(this)?this.getWindow().scrollTo(t,e):(this.scrollLeft=t,this.scrollTop=e),this},getSize:function(){if(r(this))return this.getWindow().getSize();if(!window.getComputedStyle)return{x:this.offsetWidth,y:this.offsetHeight};if("svg"==this.get("tag"))return l(this);try{var t=this.getBoundingClientRect();return{x:t.width,y:t.height}}catch(e){return{x:0,y:0}}},getScrollSize:function(){return r(this)?this.getWindow().getScrollSize():{x:this.scrollWidth,y:this.scrollHeight}},getScroll:function(){return r(this)?this.getWindow().getScroll():{x:this.scrollLeft,y:this.scrollTop}},getScrolls:function(){for(var t=this.parentNode,e={x:0,y:0};t&&!r(t);)e.x+=t.scrollLeft,e.y+=t.scrollTop,t=t.parentNode;return e},getOffsetParent:a?function(){var t=this;if(r(t)||"fixed"==p(t,"position"))return null;for(var e="static"==p(t,"position")?f:h;t=t.parentNode;)if(e(t))return t;return null}:function(){var t=this;if(r(t)||"fixed"==p(t,"position"))return null;try{return t.offsetParent}catch(e){}return null},getOffsets:function(){var t=this.getBoundingClientRect;if(t){var e=this.getBoundingClientRect(),n=document.id(this.getDocument().documentElement),i=n.getScroll(),s=this.getScrolls(),o="fixed"==p(this,"position");return{x:e.left.toFloat()+s.x+(o?0:i.x)-n.clientLeft,y:e.top.toFloat()+s.y+(o?0:i.y)-n.clientTop}}var a=this,u={x:0,y:0};if(r(this))return u;for(;a&&!r(a);)u.x+=a.offsetLeft,u.y+=a.offsetTop,a=a.offsetParent;return u},getPosition:function(t){var r=this.getOffsets(),i=this.getScrolls(),s={x:r.x-i.x,y:r.y-i.y};if(t&&(t=document.id(t))){var o=t.getPosition();return{x:s.x-o.x-n(t),y:s.y-o.y-e(t)}}return s},getCoordinates:function(t){if(r(this))return this.getWindow().getCoordinates();var e=this.getPosition(t),n=this.getSize(),i={left:e.x,top:e.y,width:n.x,height:n.y};return i.right=i.left+i.width,i.bottom=i.top+i.height,i},computePosition:function(e){return{left:e.x-t(this,"margin-left"),top:e.y-t(this,"margin-top")}},setPosition:function(t){return this.setStyles(this.computePosition(t))}}),[Document,Window].invoke("implement",{getSize:function(){var t=i(this);return{x:t.clientWidth,y:t.clientHeight}},getScroll:function(){var t=this.getWindow(),e=i(this);return{x:t.pageXOffset||e.scrollLeft,y:t.pageYOffset||e.scrollTop}},getScrollSize:function(){var t=i(this),e=this.getSize(),n=this.getDocument().body;return{x:Math.max(t.scrollWidth,n.scrollWidth,e.x),y:Math.max(t.scrollHeight,n.scrollHeight,e.y)}},getPosition:function(){return{x:0,y:0}},getCoordinates:function(){var t=this.getSize();return{top:0,left:0,bottom:t.y,right:t.x,height:t.y,width:t.x}}});var p=Element.getComputedStyle}(),Element.alias({position:"setPosition"}),[Window,Document,Element].invoke("implement",{getHeight:function(){return this.getSize().y},getWidth:function(){return this.getSize().x},getScrollTop:function(){return this.getScroll().y},getScrollLeft:function(){return this.getScroll().x},getScrollHeight:function(){return this.getScrollSize().y},getScrollWidth:function(){return this.getScrollSize().x},getTop:function(){return this.getPosition().y},getLeft:function(){return this.getPosition().x}}),function(){var t=this.Fx=new Class({Implements:[Chain,Events,Options,Class.Thenable],options:{fps:60,unit:!1,duration:500,frames:null,frameSkip:!0,link:"ignore"},initialize:function(t){this.subject=this.subject||this,this.setOptions(t)},getTransition:function(){return function(t){return-(Math.cos(Math.PI*t)-1)/2}},step:function(t){if(this.options.frameSkip){var e=null!=this.time?t-this.time:0,n=e/this.frameInterval;this.time=t,this.frame+=n}else this.frame++;if(this.frame<this.frames){var r=this.transition(this.frame/this.frames);this.set(this.compute(this.from,this.to,r))}else this.frame=this.frames,this.set(this.compute(this.from,this.to,1)),this.stop()},set:function(t){return t},compute:function(e,n,r){return t.compute(e,n,r)},check:function(){if(!this.isRunning())return!0;switch(this.options.link){case"cancel":return this.cancel(),!0;case"chain":return this.chain(this.caller.pass(arguments,this)),!1}return!1},start:function(e,n){if(!this.check(e,n))return this;this.from=e,this.to=n,this.frame=this.options.frameSkip?0:-1,this.time=null,this.transition=this.getTransition();var r=this.options.frames,s=this.options.fps,o=this.options.duration;return this.duration=t.Durations[o]||o.toInt(),this.frameInterval=1e3/s,this.frames=r||Math.round(this.duration/this.frameInterval),"pending"!==this.getThenableState()&&this.resetThenable(this.subject),this.fireEvent("start",this.subject),i.call(this,s),this},stop:function(){return this.isRunning()&&(this.time=null,s.call(this,this.options.fps),this.frames==this.frame?(this.fireEvent("complete",this.subject),this.callChain()||this.fireEvent("chainComplete",this.subject)):this.fireEvent("stop",this.subject),this.resolve(this.subject===this?null:this.subject)),this},cancel:function(){return this.isRunning()&&(this.time=null,s.call(this,this.options.fps),this.frame=this.frames,this.fireEvent("cancel",this.subject).clearChain(),this.reject(this.subject)),this},pause:function(){return this.isRunning()&&(this.time=null,s.call(this,this.options.fps)),this},resume:function(){return this.isPaused()&&i.call(this,this.options.fps),this},isRunning:function(){var t=e[this.options.fps];return t&&t.contains(this)},isPaused:function(){return this.frame<this.frames&&!this.isRunning()}});t.compute=function(t,e,n){return(e-t)*n+t},t.Durations={"short":250,normal:500,"long":1e3};var e={},n={},r=function(){for(var t=Date.now(),e=this.length;e--;){var n=this[e];n&&n.step(t)}},i=function(t){var i=e[t]||(e[t]=[]);i.push(this),n[t]||(n[t]=r.periodical(Math.round(1e3/t),i))},s=function(t){var r=e[t];r&&(r.erase(this),!r.length&&n[t]&&(delete e[t],n[t]=clearInterval(n[t])))}}(),Fx.CSS=new Class({Extends:Fx,prepare:function(t,e,n){n=Array.convert(n);var r=n[0],i=n[1];if(null==i){i=r,r=t.getStyle(e);var s=this.options.unit;if(s&&r&&"string"==typeof r&&r.slice(-s.length)!=s&&0!=parseFloat(r)){t.setStyle(e,i+s);var o=t.getComputedStyle(e);if(!/px$/.test(o)&&(o=t.style[("pixel-"+e).camelCase()],null==o)){var a=t.style.left;t.style.left=i+s,o=t.style.pixelLeft,t.style.left=a}r=(i||1)/(parseFloat(o)||1)*(parseFloat(r)||0),t.setStyle(e,r+s)}}return{from:this.parse(r),to:this.parse(i)}},parse:function(t){return t=Function.convert(t)(),t="string"==typeof t?t.split(" "):Array.convert(t),t.map(function(t){t=String(t);var e=!1;return Object.each(Fx.CSS.Parsers,function(n){if(!e){var r=n.parse(t);(r||0===r)&&(e={value:r,parser:n})}}),e=e||{value:t,parser:Fx.CSS.Parsers.String}})},compute:function(t,e,n){var r=[];return Math.min(t.length,e.length).times(function(i){r.push({value:t[i].parser.compute(t[i].value,e[i].value,n),parser:t[i].parser})}),r.$family=Function.convert("fx:css:value"),r},serve:function(t,e){"fx:css:value"!=typeOf(t)&&(t=this.parse(t));var n=[];return t.each(function(t){n=n.concat(t.parser.serve(t.value,e))}),n},render:function(t,e,n,r){t.setStyle(e,this.serve(n,r))},search:function(t){if(Fx.CSS.Cache[t])return Fx.CSS.Cache[t];var e={},n=new RegExp("^"+t.escapeRegExp()+"$"),r=function(t){Array.each(t,function(t){if(t.media)return void r(t.rules||t.cssRules);if(t.style){var i=t.selectorText?t.selectorText.replace(/^\w+/,function(t){return t.toLowerCase()}):null;i&&n.test(i)&&Object.each(Element.Styles,function(n,r){t.style[r]&&!Element.ShortStyles[r]&&(n=String(t.style[r]),e[r]=/^rgb/.test(n)?n.rgbToHex():n)})}})};return Array.each(document.styleSheets,function(t){var e=t.href;if(!(e&&e.indexOf("://")>-1&&-1==e.indexOf(document.domain))){var n=t.rules||t.cssRules;r(n)}}),Fx.CSS.Cache[t]=e}}),Fx.CSS.Cache={},Fx.CSS.Parsers={Color:{parse:function(t){return t.match(/^#[0-9a-f]{3,6}$/i)?t.hexToRgb(!0):(t=t.match(/(\d+),\s*(\d+),\s*(\d+)/))?[t[1],t[2],t[3]]:!1},compute:function(t,e,n){return t.map(function(r,i){return Math.round(Fx.compute(t[i],e[i],n))})},serve:function(t){return t.map(Number)}},Number:{parse:parseFloat,compute:Fx.compute,serve:function(t,e){return e?t+e:t}},String:{parse:Function.convert(!1),compute:function(t,e){return e},serve:function(t){return t}}},Fx.Morph=new Class({Extends:Fx.CSS,initialize:function(t,e){this.element=this.subject=document.id(t),this.parent(e)},set:function(t){"string"==typeof t&&(t=this.search(t));for(var e in t)this.render(this.element,e,t[e],this.options.unit);return this},compute:function(t,e,n){var r={};for(var i in t)r[i]=this.parent(t[i],e[i],n);return r},start:function(t){if(!this.check(t))return this;"string"==typeof t&&(t=this.search(t));var e={},n={};for(var r in t){var i=this.prepare(this.element,r,t[r]);e[r]=i.from,n[r]=i.to}return this.parent(e,n)}}),Element.Properties.morph={set:function(t){return this.get("morph").cancel().setOptions(t),this},get:function(){var t=this.retrieve("morph");return t||(t=new Fx.Morph(this,{link:"cancel"}),this.store("morph",t)),t}},Element.implement({morph:function(t){return this.get("morph").start(t),this}}),Fx.implement({getTransition:function(){var t=this.options.transition||Fx.Transitions.Sine.easeInOut;if("string"==typeof t){var e=t.split(":");t=Fx.Transitions,t=t[e[0]]||t[e[0].capitalize()],e[1]&&(t=t["ease"+e[1].capitalize()+(e[2]?e[2].capitalize():"")])}return t}}),Fx.Transition=function(t,e){e=Array.convert(e);var n=function(n){return t(n,e)};return Object.append(n,{easeIn:n,easeOut:function(n){return 1-t(1-n,e)},easeInOut:function(n){return(.5>=n?t(2*n,e):2-t(2*(1-n),e))/2}})},Fx.Transitions={linear:function(t){return t}},Fx.Transitions.extend=function(t){for(var e in t)Fx.Transitions[e]=new Fx.Transition(t[e])},Fx.Transitions.extend({Pow:function(t,e){return Math.pow(t,e&&e[0]||6)},Expo:function(t){return Math.pow(2,8*(t-1))},Circ:function(t){return 1-Math.sin(Math.acos(t))},Sine:function(t){return 1-Math.cos(t*Math.PI/2)},Back:function(t,e){return e=e&&e[0]||1.618,Math.pow(t,2)*((e+1)*t-e)},Bounce:function(t){for(var e,n=0,r=1;1;n+=r,r/=2)if(t>=(7-4*n)/11){e=r*r-Math.pow((11-6*n-11*t)/4,2);break}return e},Elastic:function(t,e){return Math.pow(2,10*--t)*Math.cos(20*t*Math.PI*(e&&e[0]||1)/3)}}),["Quad","Cubic","Quart","Quint"].each(function(t,e){Fx.Transitions[t]=new Fx.Transition(function(t){return Math.pow(t,e+2)})}),Fx.Tween=new Class({Extends:Fx.CSS,initialize:function(t,e){this.element=this.subject=document.id(t),this.parent(e)},set:function(t,e){return 1==arguments.length&&(e=t,t=this.property||this.options.property),this.render(this.element,t,e,this.options.unit),this},start:function(t,e,n){if(!this.check(t,e,n))return this;var r=Array.flatten(arguments);this.property=this.options.property||r.shift();var i=this.prepare(this.element,this.property,r);return this.parent(i.from,i.to)}}),Element.Properties.tween={set:function(t){return this.get("tween").cancel().setOptions(t),this},get:function(){var t=this.retrieve("tween");return t||(t=new Fx.Tween(this,{link:"cancel"}),this.store("tween",t)),t}},Element.implement({tween:function(t,e,n){return this.get("tween").start(t,e,n),this},fade:function(){var t,e,n=this.get("tween"),r=["opacity"].append(arguments);switch(null==r[1]&&(r[1]="toggle"),r[1]){case"in":t="start",r[1]=1;break;case"out":t="start",r[1]=0;break;case"show":t="set",r[1]=1;break;case"hide":t="set",r[1]=0;break;case"toggle":var i=this.retrieve("fade:flag",1==this.getStyle("opacity"));t="start",r[1]=i?0:1,this.store("fade:flag",!i),e=!0;break;default:t="start"}e||this.eliminate("fade:flag"),n[t].apply(n,r);var s=r[r.length-1];return"set"==t?this.setStyle("visibility",0==s?"hidden":"visible"):0!=s?n.$chain.length?n.chain(function(){this.element.setStyle("visibility","visible"),this.callChain()}):this.setStyle("visibility","visible"):n.chain(function(){this.element.getStyle("opacity")||(this.element.setStyle("visibility","hidden"),this.callChain())}),this},highlight:function(t,e){e||(e=this.retrieve("highlight:original",this.getStyle("background-color")),e="transparent"==e?"#fff":e);var n=this.get("tween");return n.start("background-color",t||"#ffff88",e).chain(function(){this.setStyle("background-color",this.retrieve("highlight:original")),n.callChain()}.bind(this)),this}}),function(){var t=function(){},e="onprogress"in new Browser.Request,n=this.Request=new Class({Implements:[Chain,Events,Options,Class.Thenable],options:{url:"",data:"",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/javascript, text/html, application/xml, text/xml, */*"},async:!0,format:!1,method:"post",link:"ignore",isSuccess:null,emulation:!0,urlEncoded:!0,encoding:"utf-8",evalScripts:!1,evalResponse:!1,timeout:0,noCache:!1},initialize:function(t){this.xhr=new Browser.Request,this.setOptions(t),this.headers=this.options.headers},onStateChange:function(){var n=this.xhr;4==n.readyState&&this.running&&(this.running=!1,this.status=0,Function.attempt(function(){var t=n.status;this.status=1223==t?204:t}.bind(this)),n.onreadystatechange=t,e&&(n.onprogress=n.onloadstart=t),this.timer&&(clearTimeout(this.timer),delete this.timer),this.response={text:this.xhr.responseText||"",xml:this.xhr.responseXML},this.options.isSuccess.call(this,this.status)?this.success(this.response.text,this.response.xml):this.failure())},isSuccess:function(){var t=this.status;return t>=200&&300>t},isRunning:function(){return!!this.running},processScripts:function(t){return this.options.evalResponse||/(ecma|java)script/.test(this.getHeader("Content-type"))?Browser.exec(t):t.stripScripts(this.options.evalScripts)},success:function(t,e){this.onSuccess(this.processScripts(t),e),this.resolve({text:t,xml:e})},onSuccess:function(){this.fireEvent("complete",arguments).fireEvent("success",arguments).callChain()},failure:function(){this.onFailure(),this.reject({reason:"failure",xhr:this.xhr})},onFailure:function(){this.fireEvent("complete").fireEvent("failure",this.xhr)},loadstart:function(t){this.fireEvent("loadstart",[t,this.xhr])},progress:function(t){this.fireEvent("progress",[t,this.xhr])},timeout:function(){this.fireEvent("timeout",this.xhr),this.reject({reason:"timeout",xhr:this.xhr})},setHeader:function(t,e){return this.headers[t]=e,this},getHeader:function(t){return Function.attempt(function(){return this.xhr.getResponseHeader(t)}.bind(this))},check:function(){if(!this.running)return!0;switch(this.options.link){case"cancel":return this.cancel(),!0;case"chain":return this.chain(this.caller.pass(arguments,this)),!1}return!1},send:function(t){if(!this.check(t))return this;this.options.isSuccess=this.options.isSuccess||this.isSuccess,this.running=!0;var n=typeOf(t);("string"==n||"element"==n)&&(t={data:t});var r=this.options;t=Object.append({data:r.data,url:r.url,method:r.method},t);var i=t.data,s=String(t.url),o=t.method.toLowerCase();switch(typeOf(i)){case"element":i=document.id(i).toQueryString();break;case"object":case"hash":i=Object.toQueryString(i)}if(this.options.format){var a="format="+this.options.format;i=i?a+"&"+i:a}if(this.options.emulation&&!["get","post"].contains(o)){var u="_method="+o;i=i?u+"&"+i:u,o="post"}if(this.options.urlEncoded&&["post","put"].contains(o)){var c=this.options.encoding?"; charset="+this.options.encoding:"";this.headers["Content-type"]="application/x-www-form-urlencoded"+c}s||(s=document.location.pathname);var l=s.lastIndexOf("/");l>-1&&(l=s.indexOf("#"))>-1&&(s=s.substr(0,l)),this.options.noCache&&(s+=(s.indexOf("?")>-1?"&":"?")+String.uniqueID()),!i||"get"!=o&&"delete"!=o||(s+=(s.indexOf("?")>-1?"&":"?")+i,i=null);var h=this.xhr;return e&&(h.onloadstart=this.loadstart.bind(this),h.onprogress=this.progress.bind(this)),h.open(o.toUpperCase(),s,this.options.async,this.options.user,this.options.password),this.options.withCredentials&&"withCredentials"in h&&(h.withCredentials=!0),h.onreadystatechange=this.onStateChange.bind(this),Object.each(this.headers,function(t,e){try{h.setRequestHeader(e,t)}catch(n){this.fireEvent("exception",[e,t]),this.reject({reason:"exception",xhr:h,exception:n})}},this),"pending"!==this.getThenableState()&&this.resetThenable({reason:"send"}),this.fireEvent("request"),h.send(i),this.options.async?this.options.timeout&&(this.timer=this.timeout.delay(this.options.timeout,this)):this.onStateChange(),this},cancel:function(){if(!this.running)return this;this.running=!1;var n=this.xhr;return n.abort(),this.timer&&(clearTimeout(this.timer),delete this.timer),n.onreadystatechange=t,e&&(n.onprogress=n.onloadstart=t),this.xhr=new Browser.Request,this.fireEvent("cancel"),this.reject({reason:"cancel",xhr:n}),this}}),r={};["get","post","put","delete","patch","head","GET","POST","PUT","DELETE","PATCH","HEAD"].each(function(t){r[t]=function(e){var n={method:t};return null!=e&&(n.data=e),this.send(n)}}),n.implement(r),Element.Properties.send={set:function(t){var e=this.get("send").cancel();return e.setOptions(t),this},get:function(){var t=this.retrieve("send");return t||(t=new n({data:this,link:"cancel",method:this.get("method")||"post",url:this.get("action")}),this.store("send",t)),t}},Element.implement({send:function(t){var e=this.get("send");return e.send({data:this,url:t||e.options.url}),this}})}(),Request.HTML=new Class({Extends:Request,options:{update:!1,append:!1,evalScripts:!0,filter:!1,headers:{Accept:"text/html, application/xml, text/xml, */*"}},success:function(t){var e=this.options,n=this.response;n.html=t.stripScripts(function(t){n.javascript=t});var r=n.html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);r&&(n.html=r[1]);var i=new Element("div").set("html",n.html);if(n.tree=i.childNodes,n.elements=i.getElements(e.filter||"*"),e.filter&&(n.tree=n.elements),e.update){var s=document.id(e.update).empty();e.filter?s.adopt(n.elements):s.set("html",n.html)}else if(e.append){var o=document.id(e.append);e.filter?n.elements.reverse().inject(o):o.adopt(i.getChildren())}e.evalScripts&&Browser.exec(n.javascript),this.onSuccess(n.tree,n.elements,n.html,n.javascript),this.resolve({tree:n.tree,elements:n.elements,html:n.html,javascript:n.javascript})}}),Element.Properties.load={set:function(t){var e=this.get("load").cancel();return e.setOptions(t),this},get:function(){var t=this.retrieve("load");return t||(t=new Request.HTML({data:this,link:"cancel",update:this,method:"get"}),this.store("load",t)),t}},Element.implement({load:function(){return this.get("load").send(Array.link(arguments,{data:Type.isObject,url:Type.isString})),this}}),"undefined"==typeof JSON&&(this.JSON={}),function(){var special={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},escape=function(t){return special[t]||"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)};JSON.validate=function(t){return t=t.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(t)},JSON.encode=JSON.stringify?function(t){return JSON.stringify(t)}:function(t){switch(t&&t.toJSON&&(t=t.toJSON()),typeOf(t)){case"string":return'"'+t.replace(/[\x00-\x1f\\"]/g,escape)+'"';case"array":return"["+t.map(JSON.encode).clean()+"]";case"object":case"hash":var e=[];return Object.each(t,function(t,n){var r=JSON.encode(t);r&&e.push(JSON.encode(n)+":"+r)}),"{"+e+"}";case"number":case"boolean":return""+t;case"null":return"null"}return null},JSON.secure=!0,JSON.decode=function(string,secure){if(!string||"string"!=typeOf(string))return null;if(null==secure&&(secure=JSON.secure),secure){if(JSON.parse)return JSON.parse(string);if(!JSON.validate(string))throw new Error("JSON could not decode the input; security is enabled and the value is not secure.")}return eval("("+string+")")}}(),Request.JSON=new Class({Extends:Request,options:{secure:!0},initialize:function(t){this.parent(t),Object.append(this.headers,{Accept:"application/json","X-Request":"JSON"})},success:function(t){var e;try{e=this.response.json=JSON.decode(t,this.options.secure)}catch(n){return void this.fireEvent("error",[t,n])}null==e?this.failure():(this.onSuccess(e,t),this.resolve({json:e,text:t}))}});var Cookie=new Class({Implements:Options,options:{path:"/",domain:!1,duration:!1,secure:!1,document:document,encode:!0,httpOnly:!1},initialize:function(t,e){this.key=t,this.setOptions(e)},write:function(t){if(this.options.encode&&(t=encodeURIComponent(t)),this.options.domain&&(t+="; domain="+this.options.domain),this.options.path&&(t+="; path="+this.options.path),this.options.duration){var e=new Date;e.setTime(e.getTime()+24*this.options.duration*60*60*1e3),t+="; expires="+e.toGMTString()}return this.options.secure&&(t+="; secure"),this.options.httpOnly&&(t+="; HttpOnly"),this.options.document.cookie=this.key+"="+t,this},read:function(){var t=this.options.document.cookie.match("(?:^|;)\\s*"+this.key.escapeRegExp()+"=([^;]*)");return t?decodeURIComponent(t[1]):null},dispose:function(){return new Cookie(this.key,Object.merge({},this.options,{duration:-1})).write(""),this}});Cookie.write=function(t,e,n){return new Cookie(t,n).write(e)},Cookie.read=function(t){return new Cookie(t).read()},Cookie.dispose=function(t,e){return new Cookie(t,e).dispose()},function(t,e){var n,r,i,s,o=[],a=e.createElement("div"),u=function(){clearTimeout(s),n||(Browser.loaded=n=!0,e.removeListener("DOMContentLoaded",u).removeListener("readystatechange",c),e.fireEvent("domready"),t.fireEvent("domready")),e=t=a=null},c=function(){for(var t=o.length;t--;)if(o[t]())return u(),!0;return!1},l=function(){clearTimeout(s),c()||(s=setTimeout(l,10))};e.addListener("DOMContentLoaded",u);var h=function(){try{return a.doScroll(),!0}catch(t){}return!1};a.doScroll&&!h()&&(o.push(h),i=!0),e.readyState&&o.push(function(){var t=e.readyState;return"loaded"==t||"complete"==t}),"onreadystatechange"in e?e.addListener("readystatechange",c):i=!0,i&&l(),Element.Events.domready={onAdd:function(t){n&&t.call(this)}},Element.Events.load={base:"load",onAdd:function(e){r&&this==t&&e.call(this)},condition:function(){return this==t&&(u(),delete Element.Events.load),!0}},t.addEvent("load",function(){r=!0})}(window,document);;
/* MooTools: the javascript framework. license: MIT-style license. copyright: Copyright (c) 2006-2016 [Valerio Proietti](http://mad4milk.net/).*/ 
/*!
Web Build: http://mootools.net/more/builder/9d9777cc390b05f2010e83620f14e44d
*/
MooTools.More={version:"1.6.0",build:"45b71db70f879781a7e0b0d3fb3bb1307c2521eb"},function(){var t={wait:function(t){return this.chain(function(){return this.callChain.delay(null==t?500:t,this),this}.bind(this))}};Chain.implement(t),this.Fx&&Fx.implement(t),this.Element&&Element.implement&&this.Fx&&Element.implement({chains:function(t){return Array.convert(t||["tween","morph","reveal"]).each(function(t){t=this.get(t),t&&t.setOptions({link:"chain"})},this),this},pauseFx:function(t,e){return this.chains(e).get(e||"tween").wait(t),this}})}(),Class.Mutators.Binds=function(t){return this.prototype.initialize||this.implement("initialize",function(){}),Array.convert(t).concat(this.prototype.Binds||[])},Class.Mutators.initialize=function(t){return function(){return Array.convert(this.Binds).each(function(t){var e=this[t];e&&(this[t]=e.bind(this))},this),t.apply(this,arguments)}},Class.Occlude=new Class({occlude:function(t,e){e=document.id(e||this.element);var i=e.retrieve(t||this.property);return i&&!this.occluded?this.occluded=i:(this.occluded=!1,e.store(t||this.property,this),this.occluded)}}),Class.refactor=function(t,e){return Object.each(e,function(e,i){var n=t.prototype[i];n=n&&n.$origin||n||function(){},t.implement(i,"function"==typeof e?function(){var t=this.previous;this.previous=n;var i=e.apply(this,arguments);return this.previous=t,i}:e)}),t},Class.Singleton=new Class({initialize:function(t){var e,i=new Class(t);return function(){if(e)return e;e=Object.append({},i.prototype),e.constructor=i;var t=i.apply(e,arguments);return e="object"==typeof t?t:e}}}),function(){Events.Pseudos=function(t,e,i){var n="_monitorEvents:",s=function(t){return{store:t.store?function(e,i){t.store(n+e,i)}:function(e,i){(t._monitorEvents||(t._monitorEvents={}))[e]=i},retrieve:t.retrieve?function(e,i){return t.retrieve(n+e,i)}:function(e,i){return t._monitorEvents?t._monitorEvents[e]||i:i}}},r=function(e){if(-1==e.indexOf(":")||!t)return null;for(var i=Slick.parse(e).expressions[0][0],n=i.pseudos,s=n.length,r=[];s--;){var o=n[s].key,a=t[o];null!=a&&r.push({event:i.tag,value:n[s].value,pseudo:o,original:e,listener:a})}return r.length?r:null};return{addEvent:function(t,i,n){var o=r(t);if(!o)return e.call(this,t,i,n);var a=s(this),h=a.retrieve(t,[]),l=o[0].event,u=Array.slice(arguments,2),c=i,d=this;return o.each(function(t){var e=t.listener,i=c;0==e?l+=":"+t.pseudo+"("+t.value+")":c=function(){e.call(d,t,i,arguments,c)}}),h.include({type:l,event:i,monitor:c}),a.store(t,h),t!=l&&e.apply(this,[t,i].concat(u)),e.apply(this,[l,c].concat(u))},removeEvent:function(t,e){var n=r(t);if(!n)return i.call(this,t,e);var o=s(this),a=o.retrieve(t);if(!a)return this;var h=Array.slice(arguments,2);return i.apply(this,[t,e].concat(h)),a.each(function(t,n){e&&t.event!=e||i.apply(this,[t.type,t.monitor].concat(h)),delete a[n]},this),o.store(t,a),this}}};var t={once:function(t,e,i,n){e.apply(this,i),this.removeEvent(t.event,n).removeEvent(t.original,e)},throttle:function(t,e,i){e._throttled||(e.apply(this,i),e._throttled=setTimeout(function(){e._throttled=!1},t.value||250))},pause:function(t,e,i){clearTimeout(e._pause),e._pause=e.delay(t.value||250,this,i)}};Events.definePseudo=function(e,i){return t[e]=i,this},Events.lookupPseudo=function(e){return t[e]};var e=Events.prototype;Events.implement(Events.Pseudos(t,e.addEvent,e.removeEvent)),["Request","Fx"].each(function(t){this[t]&&this[t].implement(Events.prototype)})}(),function(){var t=this.Drag=new Class({Implements:[Events,Options],options:{snap:6,unit:"px",grid:!1,style:!0,limit:!1,handle:!1,invert:!1,unDraggableTags:["button","input","a","textarea","select","option"],preventDefault:!1,stopPropagation:!1,compensateScroll:!1,modifiers:{x:"left",y:"top"}},initialize:function(){var e=Array.link(arguments,{options:Type.isObject,element:function(t){return null!=t}});this.element=document.id(e.element),this.document=this.element.getDocument(),this.setOptions(e.options||{});var i=typeOf(this.options.handle);this.handles=("array"==i||"collection"==i?$$(this.options.handle):document.id(this.options.handle))||this.element,this.mouse={now:{},pos:{}},this.value={start:{},now:{}},this.offsetParent=function(t){var e=t.getOffsetParent(),i=!e||/^(?:body|html)$/i.test(e.tagName);return i?window:document.id(e)}(this.element),this.selection="selectstart"in document?"selectstart":"mousedown",this.compensateScroll={start:{},diff:{},last:{}},!("ondragstart"in document)||"FileReader"in window||t.ondragstartFixed||(document.ondragstart=Function.convert(!1),t.ondragstartFixed=!0),this.bound={start:this.start.bind(this),check:this.check.bind(this),drag:this.drag.bind(this),stop:this.stop.bind(this),cancel:this.cancel.bind(this),eventStop:Function.convert(!1),scrollListener:this.scrollListener.bind(this)},this.attach()},attach:function(){return this.handles.addEvent("mousedown",this.bound.start),this.handles.addEvent("touchstart",this.bound.start),this.options.compensateScroll&&this.offsetParent.addEvent("scroll",this.bound.scrollListener),this},detach:function(){return this.handles.removeEvent("mousedown",this.bound.start),this.handles.removeEvent("touchstart",this.bound.start),this.options.compensateScroll&&this.offsetParent.removeEvent("scroll",this.bound.scrollListener),this},scrollListener:function(){if(this.mouse.start){var t=this.offsetParent.getScroll();if("absolute"==this.element.getStyle("position")){var e=this.sumValues(t,this.compensateScroll.last,-1);this.mouse.now=this.sumValues(this.mouse.now,e,1)}else this.compensateScroll.diff=this.sumValues(t,this.compensateScroll.start,-1);this.offsetParent!=window&&(this.compensateScroll.diff=this.sumValues(this.compensateScroll.start,t,-1)),this.compensateScroll.last=t,this.render(this.options)}},sumValues:function(t,e,i){var n={},s=this.options;for(var r in s.modifiers)s.modifiers[r]&&(n[r]=t[r]+e[r]*i);return n},start:function(t){if(!this.options.unDraggableTags.contains(t.target.get("tag"))){var e=this.options;if(!t.rightClick){e.preventDefault&&t.preventDefault(),e.stopPropagation&&t.stopPropagation(),this.compensateScroll.start=this.compensateScroll.last=this.offsetParent.getScroll(),this.compensateScroll.diff={x:0,y:0},this.mouse.start=t.page,this.fireEvent("beforeStart",this.element);var i=e.limit;this.limit={x:[],y:[]};var n,s,r=this.offsetParent==window?null:this.offsetParent;for(n in e.modifiers)if(e.modifiers[n]){var o=this.element.getStyle(e.modifiers[n]);if(o&&!o.match(/px$/)&&(s||(s=this.element.getCoordinates(r)),o=s[e.modifiers[n]]),e.style?this.value.now[n]=(o||0).toInt():this.value.now[n]=this.element[e.modifiers[n]],e.invert&&(this.value.now[n]*=-1),this.mouse.pos[n]=t.page[n]-this.value.now[n],i&&i[n])for(var a=2;a--;){var h=i[n][a];(h||0===h)&&(this.limit[n][a]="function"==typeof h?h():h)}}"number"==typeOf(this.options.grid)&&(this.options.grid={x:this.options.grid,y:this.options.grid});var l={mousemove:this.bound.check,mouseup:this.bound.cancel,touchmove:this.bound.check,touchend:this.bound.cancel};l[this.selection]=this.bound.eventStop,this.document.addEvents(l)}}},check:function(t){this.options.preventDefault&&t.preventDefault();var e=Math.round(Math.sqrt(Math.pow(t.page.x-this.mouse.start.x,2)+Math.pow(t.page.y-this.mouse.start.y,2)));e>this.options.snap&&(this.cancel(),this.document.addEvents({mousemove:this.bound.drag,mouseup:this.bound.stop,touchmove:this.bound.drag,touchend:this.bound.stop}),this.fireEvent("start",[this.element,t]).fireEvent("snap",this.element))},drag:function(t){var e=this.options;e.preventDefault&&t.preventDefault(),this.mouse.now=this.sumValues(t.page,this.compensateScroll.diff,-1),this.render(e),this.fireEvent("drag",[this.element,t])},render:function(t){for(var e in t.modifiers)t.modifiers[e]&&(this.value.now[e]=this.mouse.now[e]-this.mouse.pos[e],t.invert&&(this.value.now[e]*=-1),t.limit&&this.limit[e]&&((this.limit[e][1]||0===this.limit[e][1])&&this.value.now[e]>this.limit[e][1]?this.value.now[e]=this.limit[e][1]:(this.limit[e][0]||0===this.limit[e][0])&&this.value.now[e]<this.limit[e][0]&&(this.value.now[e]=this.limit[e][0])),t.grid[e]&&(this.value.now[e]-=(this.value.now[e]-(this.limit[e][0]||0))%t.grid[e]),t.style?this.element.setStyle(t.modifiers[e],this.value.now[e]+t.unit):this.element[t.modifiers[e]]=this.value.now[e])},cancel:function(t){this.document.removeEvents({mousemove:this.bound.check,mouseup:this.bound.cancel,touchmove:this.bound.check,touchend:this.bound.cancel}),t&&(this.document.removeEvent(this.selection,this.bound.eventStop),this.fireEvent("cancel",this.element))},stop:function(t){var e={mousemove:this.bound.drag,mouseup:this.bound.stop,touchmove:this.bound.drag,touchend:this.bound.stop};e[this.selection]=this.bound.eventStop,this.document.removeEvents(e),this.mouse.start=null,t&&this.fireEvent("complete",[this.element,t])}})}(),Element.implement({makeResizable:function(t){var e=new Drag(this,Object.merge({modifiers:{x:"width",y:"height"}},t));return this.store("resizer",e),e.addEvent("drag",function(){this.fireEvent("resize",e)}.bind(this))}}),Drag.Move=new Class({Extends:Drag,options:{droppables:[],container:!1,precalculate:!1,includeMargins:!0,checkDroppables:!0},initialize:function(t,e){if(this.parent(t,e),t=this.element,this.droppables=$$(this.options.droppables),this.setContainer(this.options.container),this.options.style){if("left"==this.options.modifiers.x&&"top"==this.options.modifiers.y){var i=t.getOffsetParent(),n=t.getStyles("left","top");!i||"auto"!=n.left&&"auto"!=n.top||t.setPosition(t.getPosition(i))}"static"==t.getStyle("position")&&t.setStyle("position","absolute")}this.addEvent("start",this.checkDroppables,!0),this.overed=null},setContainer:function(t){this.container=document.id(t),this.container&&"element"!=typeOf(this.container)&&(this.container=document.id(this.container.getDocument().body))},start:function(t){this.container&&(this.options.limit=this.calculateLimit()),this.options.precalculate&&(this.positions=this.droppables.map(function(t){return t.getCoordinates()})),this.parent(t)},calculateLimit:function(){var t=this.element,e=this.container,i=document.id(t.getOffsetParent())||document.body,n=e.getCoordinates(i),s={},r={},o={},a={},h={},l=i.getScroll();["top","right","bottom","left"].each(function(n){s[n]=t.getStyle("margin-"+n).toInt(),r[n]=t.getStyle("border-"+n).toInt(),o[n]=e.getStyle("margin-"+n).toInt(),a[n]=e.getStyle("border-"+n).toInt(),h[n]=i.getStyle("padding-"+n).toInt()},this);var u=t.offsetWidth+s.left+s.right,c=t.offsetHeight+s.top+s.bottom,d=0+l.x,f=0+l.y,p=n.right-a.right-u+l.x,m=n.bottom-a.bottom-c+l.y;if(this.options.includeMargins?(d+=s.left,f+=s.top):(p+=s.right,m+=s.bottom),"relative"==t.getStyle("position")){var g=t.getCoordinates(i);g.left-=t.getStyle("left").toInt(),g.top-=t.getStyle("top").toInt(),d-=g.left,f-=g.top,"relative"!=e.getStyle("position")&&(d+=a.left,f+=a.top),p+=s.left-g.left,m+=s.top-g.top,e!=i&&(d+=o.left+h.left,!h.left&&0>d&&(d=0),f+=i==document.body?0:o.top+h.top,!h.top&&0>f&&(f=0))}else d-=s.left,f-=s.top,e!=i&&(d+=n.left+a.left,f+=n.top+a.top);return{x:[d,p],y:[f,m]}},getDroppableCoordinates:function(t){var e=t.getCoordinates();if("fixed"==t.getStyle("position")){var i=window.getScroll();e.left+=i.x,e.right+=i.x,e.top+=i.y,e.bottom+=i.y}return e},checkDroppables:function(){var t=this.droppables.filter(function(t,e){t=this.positions?this.positions[e]:this.getDroppableCoordinates(t);var i=this.mouse.now;return i.x>t.left&&i.x<t.right&&i.y<t.bottom&&i.y>t.top},this).getLast();this.overed!=t&&(this.overed&&this.fireEvent("leave",[this.element,this.overed]),t&&this.fireEvent("enter",[this.element,t]),this.overed=t)},drag:function(t){this.parent(t),this.options.checkDroppables&&this.droppables.length&&this.checkDroppables()},stop:function(t){return this.checkDroppables(),this.fireEvent("drop",[this.element,this.overed,t]),this.overed=null,this.parent(t)}}),Element.implement({makeDraggable:function(t){var e=new Drag.Move(this,t);return this.store("dragger",e),e}}),function(){var t=function(t,e){var i=[];return Object.each(e,function(e){Object.each(e,function(e){t.each(function(t){i.push(t+"-"+e+("border"==t?"-width":""))})})}),i},e=function(t,e){var i=0;return Object.each(e,function(e,n){n.test(t)&&(i+=e.toInt())}),i},i=function(t){return!(t&&!t.offsetHeight&&!t.offsetWidth)};Element.implement({measure:function(t){if(i(this))return t.call(this);for(var e=this.getParent(),n=[];!i(e)&&e!=document.body;)n.push(e.expose()),e=e.getParent();var s=this.expose(),r=t.call(this);return s(),n.each(function(t){t()}),r},expose:function(){if("none"!=this.getStyle("display"))return function(){};var t=this.style.cssText;return this.setStyles({display:"block",position:"absolute",visibility:"hidden"}),function(){this.style.cssText=t}.bind(this)},getDimensions:function(t){t=Object.merge({computeSize:!1},t);var e={x:0,y:0},i=function(t,e){return e.computeSize?t.getComputedSize(e):t.getSize()},n=this.getParent("body");if(n&&"none"==this.getStyle("display"))e=this.measure(function(){return i(this,t)});else if(n)try{e=i(this,t)}catch(s){}return Object.append(e,e.x||0===e.x?{width:e.x,height:e.y}:{x:e.width,y:e.height})},getComputedSize:function(i){i=Object.merge({styles:["padding","border"],planes:{height:["top","bottom"],width:["left","right"]},mode:"both"},i);var n,s={},r={width:0,height:0};return"vertical"==i.mode?(delete r.width,delete i.planes.width):"horizontal"==i.mode&&(delete r.height,delete i.planes.height),t(i.styles,i.planes).each(function(t){s[t]=this.getStyle(t).toInt()},this),Object.each(i.planes,function(t,i){var o=i.capitalize(),a=this.getStyle(i);"auto"!=a||n||(n=this.getDimensions()),a=s[i]="auto"==a?n[i]:a.toInt(),r["total"+o]=a,t.each(function(t){var i=e(t,s);r["computed"+t.capitalize()]=i,r["total"+o]+=i})},this),Object.append(r,s)}})}(),function(){this.Slider=new Class({Implements:[Events,Options],Binds:["clickedElement","draggedKnob","scrolledElement"],options:{onTick:function(t){this.setKnobPosition(t)},initialStep:0,snap:!1,offset:0,range:!1,wheel:!1,steps:100,mode:"horizontal"},initialize:function(t,e,i){this.setOptions(i),i=this.options,this.element=document.id(t),e=this.knob=document.id(e),this.previousChange=this.previousEnd=this.step=i.initialStep?i.initialStep:i.range?i.range[0]:0;var n={},s={x:!1,y:!1};switch(i.mode){case"vertical":this.axis="y",this.property="top",this.offset="offsetHeight";break;case"horizontal":this.axis="x",this.property="left",this.offset="offsetWidth"}this.setSliderDimensions(),this.setRange(i.range,null,!0),"static"==e.getStyle("position")&&e.setStyle("position","relative"),e.setStyle(this.property,-i.offset),s[this.axis]=this.property,n[this.axis]=[-i.offset,this.full-i.offset];var r={snap:0,limit:n,modifiers:s,onDrag:this.draggedKnob,onStart:this.draggedKnob,onBeforeStart:function(){this.isDragging=!0}.bind(this),onCancel:function(){this.isDragging=!1}.bind(this),onComplete:function(){this.isDragging=!1,this.draggedKnob(),this.end()}.bind(this)};i.snap&&this.setSnap(r),this.drag=new Drag(e,r),null!=i.initialStep&&this.set(i.initialStep,!0),this.attach()},attach:function(){return this.element.addEvent("mousedown",this.clickedElement),this.options.wheel&&this.element.addEvent("mousewheel",this.scrolledElement),this.drag.attach(),this},detach:function(){return this.element.removeEvent("mousedown",this.clickedElement).removeEvent("mousewheel",this.scrolledElement),this.drag.detach(),this},autosize:function(){return this.setSliderDimensions().setKnobPosition(this.toPosition(this.step)),this.drag.options.limit[this.axis]=[-this.options.offset,this.full-this.options.offset],this.options.snap&&this.setSnap(),this},setSnap:function(t){return t||(t=this.drag.options),t.grid=Math.ceil(this.stepWidth),t.limit[this.axis][1]=this.element[this.offset],this},setKnobPosition:function(t){return this.options.snap&&(t=this.toPosition(this.step)),this.knob.setStyle(this.property,t),this},setSliderDimensions:function(){return this.full=this.element.measure(function(){return this.half=this.knob[this.offset]/2,this.element[this.offset]-this.knob[this.offset]+2*this.options.offset}.bind(this)),this},set:function(t,e){return this.range>0^t<this.min||(t=this.min),this.range>0^t>this.max||(t=this.max),this.step=t.round(this.modulus.decimalLength),e?this.checkStep().setKnobPosition(this.toPosition(this.step)):this.checkStep().fireEvent("tick",this.toPosition(this.step)).fireEvent("move").end(),this},setRange:function(t,e,i){this.min=Array.pick([t[0],0]),this.max=Array.pick([t[1],this.options.steps]),this.range=this.max-this.min,this.steps=this.options.steps||this.full;this.stepSize=Math.abs(this.range)/this.steps;return this.stepWidth=this.stepSize*this.full/Math.abs(this.range),this.setModulus(),t&&this.set(Array.pick([e,this.step]).limit(this.min,this.max),i),this},setModulus:function(){for(var t=((this.stepSize+"").split(".")[1]||[]).length,e="1";t--;)e+="0";this.modulus={multiplier:e.toInt(10),decimalLength:e.length-1}},clickedElement:function(t){if(!this.isDragging&&t.target!=this.knob){var e=this.range<0?-1:1,i=t.page[this.axis]-this.element.getPosition()[this.axis]-this.half;i=i.limit(-this.options.offset,this.full-this.options.offset),this.step=(this.min+e*this.toStep(i)).round(this.modulus.decimalLength),this.checkStep().fireEvent("tick",i).fireEvent("move").end()}},scrolledElement:function(t){var e="horizontal"==this.options.mode?t.wheel<0:t.wheel>0;this.set(this.step+(e?-1:1)*this.stepSize),t.stop()},draggedKnob:function(){var t=this.range<0?-1:1,e=this.drag.value.now[this.axis];e=e.limit(-this.options.offset,this.full-this.options.offset),this.step=(this.min+t*this.toStep(e)).round(this.modulus.decimalLength),this.checkStep(),this.fireEvent("move")},checkStep:function(){var t=this.step;return this.previousChange!=t&&(this.previousChange=t,this.fireEvent("change",t)),this},end:function(){var t=this.step;return this.previousEnd!==t&&(this.previousEnd=t,this.fireEvent("complete",t+"")),this},toStep:function(t){var e=(t+this.options.offset)*this.stepSize/this.full*this.steps;return this.options.steps?(e-e*this.modulus.multiplier%(this.stepSize*this.modulus.multiplier)/this.modulus.multiplier).round(this.modulus.decimalLength):e},toPosition:function(t){return this.full*Math.abs(this.min-t)/(this.steps*this.stepSize)-this.options.offset||0}})}(),function(){this.Sortables=new Class({Implements:[Events,Options],options:{opacity:1,clone:!1,revert:!1,handle:!1,dragOptions:{},unDraggableTags:["button","input","a","textarea","select","option"]},initialize:function(t,e){this.setOptions(e),this.elements=[],this.lists=[],this.idle=!0,this.addLists($$(document.id(t)||t)),this.options.clone||(this.options.revert=!1),this.options.revert&&(this.effect=new Fx.Morph(null,Object.merge({duration:250,link:"cancel"},this.options.revert)))},attach:function(){return this.addLists(this.lists),this},detach:function(){return this.lists=this.removeLists(this.lists),this},addItems:function(){return Array.flatten(arguments).each(function(t){this.elements.push(t);var e=t.retrieve("sortables:start",function(e){this.start.call(this,e,t)}.bind(this));(this.options.handle?t.getElement(this.options.handle)||t:t).addEvent("mousedown",e)},this),this},addLists:function(){return Array.flatten(arguments).each(function(t){this.lists.include(t),this.addItems(t.getChildren())},this),this},removeItems:function(){return $$(Array.flatten(arguments).map(function(t){this.elements.erase(t);var e=t.retrieve("sortables:start");return(this.options.handle?t.getElement(this.options.handle)||t:t).removeEvent("mousedown",e),t},this))},removeLists:function(){return $$(Array.flatten(arguments).map(function(t){return this.lists.erase(t),this.removeItems(t.getChildren()),t},this))},getDroppableCoordinates:function(t){var e=t.getOffsetParent(),i=t.getPosition(e),n={w:window.getScroll(),offsetParent:e.getScroll()};return i.x+=n.offsetParent.x,i.y+=n.offsetParent.y,"fixed"==e.getStyle("position")&&(i.x-=n.w.x,i.y-=n.w.y),i},getClone:function(t,e){if(!this.options.clone)return new Element(e.tagName).inject(document.body);if("function"==typeOf(this.options.clone))return this.options.clone.call(this,t,e,this.list);var i=e.clone(!0).setStyles({margin:0,position:"absolute",visibility:"hidden",width:e.getStyle("width")}).addEvent("mousedown",function(t){e.fireEvent("mousedown",t)});return i.get("html").test("radio")&&i.getElements("input[type=radio]").each(function(t,i){t.set("name","clone_"+i),t.get("checked")&&e.getElements("input[type=radio]")[i].set("checked",!0)}),i.inject(this.list).setPosition(this.getDroppableCoordinates(this.element))},getDroppables:function(){var t=this.list.getChildren().erase(this.clone).erase(this.element);return this.options.constrain||t.append(this.lists).erase(this.list),t},insert:function(t,e){var i="inside";this.lists.contains(e)?(this.list=e,this.drag.droppables=this.getDroppables()):i=this.element.getAllPrevious().contains(e)?"before":"after",this.element.inject(e,i),this.fireEvent("sort",[this.element,this.clone])},start:function(t,e){!this.idle||t.rightClick||!this.options.handle&&this.options.unDraggableTags.contains(t.target.get("tag"))||(this.idle=!1,this.element=e,this.opacity=e.getStyle("opacity"),this.list=e.getParent(),this.clone=this.getClone(t,e),this.drag=new Drag.Move(this.clone,Object.merge({droppables:this.getDroppables()},this.options.dragOptions)).addEvents({onSnap:function(){t.stop(),this.clone.setStyle("visibility","visible"),this.element.setStyle("opacity",this.options.opacity||0),this.fireEvent("start",[this.element,this.clone])}.bind(this),onEnter:this.insert.bind(this),onCancel:this.end.bind(this),onComplete:this.end.bind(this)}),this.clone.inject(this.element,"before"),this.drag.start(t))},end:function(){this.drag.detach(),this.element.setStyle("opacity",this.opacity);var t=this;if(this.effect){var e=this.element.getStyles("width","height"),i=this.clone,n=i.computePosition(this.getDroppableCoordinates(i)),s=function(){this.removeEvent("cancel",s),i.destroy(),t.reset()};this.effect.element=i,this.effect.start({top:n.top,left:n.left,width:e.width,height:e.height,opacity:.25}).addEvent("cancel",s).chain(s)}else this.clone.destroy(),t.reset()},reset:function(){this.idle=!0,this.fireEvent("complete",this.element)},serialize:function(){var t=Array.link(arguments,{modifier:Type.isFunction,index:function(t){return null!=t}}),e=this.lists.map(function(e){return e.getChildren().map(t.modifier||function(t){return t.get("id")},this)},this),i=t.index;return 1==this.lists.length&&(i=0),(i||0===i)&&i>=0&&i<this.lists.length?e[i]:e}})}(),function(){for(var t={relay:!1},e=["once","throttle","pause"],i=e.length;i--;)t[e[i]]=Events.lookupPseudo(e[i]);DOMEvent.definePseudo=function(e,i){return t[e]=i,this};var n=Element.prototype;[Element,Window,Document].invoke("implement",Events.Pseudos(t,n.addEvent,n.removeEvent))}(),function(){var t="$moo:keys-pressed",e="$moo:keys-keyup";DOMEvent.definePseudo("keys",function(i,n,s){var r=s[0],o=[],a=this.retrieve(t,[]),h=i.value;if("+"!=h?o.append(h.replace("++",function(){return o.push("+"),""}).split("+")):o=["+"],a.include(r.key),o.every(function(t){return a.contains(t)})&&n.apply(this,s),this.store(t,a),!this.retrieve(e)){var l=function(e){(function(){a=this.retrieve(t,[]).erase(e.key),this.store(t,a)}).delay(0,this)};this.store(e,l).addEvent("keyup",l)}}),DOMEvent.defineKeys({16:"shift",17:"control",18:"alt",20:"capslock",33:"pageup",34:"pagedown",35:"end",36:"home",144:"numlock",145:"scrolllock",186:";",187:"=",188:",",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",107:"+",109:"-",189:"-"})}(),function(){var t={a:/[àáâãäåăą]/g,A:/[ÀÁÂÃÄÅĂĄ]/g,c:/[ćčç]/g,C:/[ĆČÇ]/g,d:/[ďđ]/g,D:/[ĎÐ]/g,e:/[èéêëěę]/g,E:/[ÈÉÊËĚĘ]/g,g:/[ğ]/g,G:/[Ğ]/g,i:/[ìíîï]/g,I:/[ÌÍÎÏ]/g,l:/[ĺľł]/g,L:/[ĹĽŁ]/g,n:/[ñňń]/g,N:/[ÑŇŃ]/g,o:/[òóôõöøő]/g,O:/[ÒÓÔÕÖØ]/g,r:/[řŕ]/g,R:/[ŘŔ]/g,s:/[ššş]/g,S:/[ŠŞŚ]/g,t:/[ťţ]/g,T:/[ŤŢ]/g,u:/[ùúûůüµ]/g,U:/[ÙÚÛŮÜ]/g,y:/[ÿý]/g,Y:/[ŸÝ]/g,z:/[žźż]/g,Z:/[ŽŹŻ]/g,th:/[þ]/g,TH:/[Þ]/g,dh:/[ð]/g,DH:/[Ð]/g,ss:/[ß]/g,oe:/[œ]/g,OE:/[Œ]/g,ae:/[æ]/g,AE:/[Æ]/g},e={" ":/[\xa0\u2002\u2003\u2009]/g,"*":/[\xb7]/g,"'":/[\u2018\u2019]/g,'"':/[\u201c\u201d]/g,"...":/[\u2026]/g,"-":/[\u2013]/g,"&raquo;":/[\uFFFD]/g},i={ms:1,s:1e3,m:6e4,h:36e5},n=/(\d*.?\d+)([msh]+)/,s=function(t,e){var i,n=t;for(i in e)n=n.replace(e[i],i);return n},r=function(t,e){t=t||(e?"":"\\w+");var i=e?"<"+t+"(?!\\w)[^>]*>([\\s\\S]*?)</"+t+"(?!\\w)>":"</?"+t+"/?>|<"+t+"[\\s|/][^>]*>";return new RegExp(i,"gi")};String.implement({standardize:function(){return s(this,t)},repeat:function(t){return new Array(t+1).join(this)},pad:function(t,e,i){if(this.length>=t)return this;var n=(null==e?" ":""+e).repeat(t-this.length).substr(0,t-this.length);return i&&"right"!=i?"left"==i?n+this:n.substr(0,(n.length/2).floor())+this+n.substr(0,(n.length/2).ceil()):this+n},getTags:function(t,e){return this.match(r(t,e))||[]},stripTags:function(t,e){return this.replace(r(t,e),"")},tidy:function(){return s(this,e)},truncate:function(t,e,i){var n=this;if(null==e&&1==arguments.length&&(e="…"),n.length>t){if(n=n.substring(0,t),i){var s=n.lastIndexOf(i);-1!=s&&(n=n.substr(0,s))}e&&(n+=e)}return n},ms:function(){var t=n.exec(this);return null==t?Number(this):Number(t[1])*i[t[2]]}})}(),Element.implement({tidy:function(){this.set("value",this.get("value").tidy())},getTextInRange:function(t,e){return this.get("value").substring(t,e)},getSelectedText:function(){return this.setSelectionRange?this.getTextInRange(this.getSelectionStart(),this.getSelectionEnd()):document.selection.createRange().text},getSelectedRange:function(){if(null!=this.selectionStart)return{start:this.selectionStart,end:this.selectionEnd};var t={start:0,end:0},e=this.getDocument().selection.createRange();if(!e||e.parentElement()!=this)return t;var i=e.duplicate();if("text"==this.type)t.start=0-i.moveStart("character",-1e5),t.end=t.start+e.text.length;else{var n=this.get("value"),s=n.length;i.moveToElementText(this),i.setEndPoint("StartToEnd",e),i.text.length&&(s-=n.match(/[\n\r]*$/)[0].length),t.end=s-i.text.length,i.setEndPoint("StartToStart",e),t.start=s-i.text.length}return t},getSelectionStart:function(){return this.getSelectedRange().start},getSelectionEnd:function(){return this.getSelectedRange().end},setCaretPosition:function(t){return"end"==t&&(t=this.get("value").length),this.selectRange(t,t),this},getCaretPosition:function(){return this.getSelectedRange().start},selectRange:function(t,e){if(this.setSelectionRange)this.focus(),this.setSelectionRange(t,e);else{var i=this.get("value"),n=i.substr(t,e-t).replace(/\r/g,"").length;t=i.substr(0,t).replace(/\r/g,"").length;var s=this.createTextRange();s.collapse(!0),s.moveEnd("character",t+n),s.moveStart("character",t),s.select()}return this},insertAtCursor:function(t,e){var i=this.getSelectedRange(),n=this.get("value");return this.set("value",n.substring(0,i.start)+t+n.substring(i.end,n.length)),e!==!1?this.selectRange(i.start,i.start+t.length):this.setCaretPosition(i.start+t.length),this},insertAroundCursor:function(t,e){t=Object.append({before:"",defaultMiddle:"",after:""},t);var i=this.getSelectedText()||t.defaultMiddle,n=this.getSelectedRange(),s=this.get("value");if(n.start==n.end)this.set("value",s.substring(0,n.start)+t.before+i+t.after+s.substring(n.end,s.length)),this.selectRange(n.start+t.before.length,n.end+t.before.length+i.length);else{var r=s.substring(n.start,n.end);this.set("value",s.substring(0,n.start)+t.before+r+t.after+s.substring(n.end,s.length));var o=n.start+t.before.length;e!==!1?this.selectRange(o,o+r.length):this.setCaretPosition(o+s.length)}return this}}),function(){var t=!1,e=!1,i=function(){var i=new Element("div").setStyles({position:"fixed",top:0,right:0}).inject(document.body);t=0===i.offsetTop,i.dispose(),e=!0};Element.implement({pin:function(n,s){if(e||i(),"none"==this.getStyle("display"))return this;var r,o,a,h=window.getScroll();if(n!==!1){if(r=this.getPosition(),!this.retrieve("pin:_pinned")){var l={top:r.y-h.y,left:r.x-h.x,margin:"0px",padding:"0px"};if(t&&!s)this.setStyle("position","fixed").setStyles(l);else{o=this.getOffsetParent();var u=this.getPosition(o),c=this.getStyles("left","top");(o&&"auto"==c.left||"auto"==c.top)&&this.setPosition(u),"static"==this.getStyle("position")&&this.setStyle("position","absolute"),u={x:c.left.toInt()-h.x,y:c.top.toInt()-h.y},a=function(){if(this.retrieve("pin:_pinned")){var t=window.getScroll();this.setStyles({left:u.x+t.x,top:u.y+t.y})}}.bind(this),this.store("pin:_scrollFixer",a),window.addEvent("scroll",a)}this.store("pin:_pinned",!0)}}else{if(!this.retrieve("pin:_pinned"))return this;o=this.getParent();"static"!=o.getComputedStyle("position")?o:o.getOffsetParent();r=this.getPosition(),this.store("pin:_pinned",!1),a=this.retrieve("pin:_scrollFixer"),a?(this.store("pin:_scrollFixer",null),window.removeEvent("scroll",a)):this.setStyles({position:"absolute",top:r.y+h.y,left:r.x+h.x}),this.removeClass("isPinned")}return this},unpin:function(){return this.pin(!1)},togglePin:function(){return this.pin(!this.retrieve("pin:_pinned"))}})}(),function(t){var e=Element.Position={options:{relativeTo:document.body,position:{x:"center",y:"center"},offset:{x:0,y:0}},getOptions:function(t,i){return i=Object.merge({},e.options,i),e.setPositionOption(i),e.setEdgeOption(i),e.setOffsetOption(t,i),e.setDimensionsOption(t,i),i},setPositionOption:function(t){t.position=e.getCoordinateFromValue(t.position)},setEdgeOption:function(t){var i=e.getCoordinateFromValue(t.edge);t.edge=i?i:"center"==t.position.x&&"center"==t.position.y?{x:"center",y:"center"}:{x:"left",y:"top"}},setOffsetOption:function(t,e){var i={x:0,y:0},n={x:0,y:0},s=t.measure(function(){return document.id(this.getOffsetParent())});s&&s!=t.getDocument().body&&(n=s.getScroll(),i=s.measure(function(){var t=this.getPosition();if("fixed"==this.getStyle("position")){var e=window.getScroll();t.x+=e.x,t.y+=e.y}return t}),e.offset={parentPositioned:s!=document.id(e.relativeTo),x:e.offset.x-i.x+n.x,y:e.offset.y-i.y+n.y})},setDimensionsOption:function(t,e){e.dimensions=t.getDimensions({computeSize:!0,styles:["padding","border","margin"]})},getPosition:function(t,i){var n={};i=e.getOptions(t,i);var s=document.id(i.relativeTo)||document.body;e.setPositionCoordinates(i,n,s),i.edge&&e.toEdge(n,i);var r=i.offset;return n.left=(n.x>=0||r.parentPositioned||i.allowNegative?n.x:0).toInt(),n.top=(n.y>=0||r.parentPositioned||i.allowNegative?n.y:0).toInt(),e.toMinMax(n,i),(i.relFixedPosition||"fixed"==s.getStyle("position"))&&e.toRelFixedPosition(s,n),i.ignoreScroll&&e.toIgnoreScroll(s,n),i.ignoreMargins&&e.toIgnoreMargins(n,i),n.left=Math.ceil(n.left),n.top=Math.ceil(n.top),delete n.x,delete n.y,n},setPositionCoordinates:function(t,e,i){var n=t.offset.y,s=t.offset.x,r=i==document.body?window.getScroll():i.getPosition(),o=r.y,a=r.x,h=window.getSize();switch(t.position.x){case"left":e.x=a+s;break;case"right":e.x=a+s+i.offsetWidth;break;default:e.x=a+(i==document.body?h.x:i.offsetWidth)/2+s}switch(t.position.y){case"top":e.y=o+n;break;case"bottom":e.y=o+n+i.offsetHeight;break;default:e.y=o+(i==document.body?h.y:i.offsetHeight)/2+n}},toMinMax:function(t,e){var i,n={left:"x",top:"y"};["minimum","maximum"].each(function(s){["left","top"].each(function(r){i=e[s]?e[s][n[r]]:null,null!=i&&("minimum"==s?t[r]<i:t[r]>i)&&(t[r]=i)})})},toRelFixedPosition:function(t,e){var i=window.getScroll();e.top+=i.y,e.left+=i.x},toIgnoreScroll:function(t,e){var i=t.getScroll();e.top-=i.y,e.left-=i.x},toIgnoreMargins:function(t,e){t.left+="right"==e.edge.x?e.dimensions["margin-right"]:"center"!=e.edge.x?-e.dimensions["margin-left"]:-e.dimensions["margin-left"]+(e.dimensions["margin-right"]+e.dimensions["margin-left"])/2,t.top+="bottom"==e.edge.y?e.dimensions["margin-bottom"]:"center"!=e.edge.y?-e.dimensions["margin-top"]:-e.dimensions["margin-top"]+(e.dimensions["margin-bottom"]+e.dimensions["margin-top"])/2},toEdge:function(t,e){var i={},n=e.dimensions,s=e.edge;switch(s.x){case"left":i.x=0;break;case"right":i.x=-n.x-n.computedRight-n.computedLeft;break;default:i.x=-Math.round(n.totalWidth/2);
}switch(s.y){case"top":i.y=0;break;case"bottom":i.y=-n.y-n.computedTop-n.computedBottom;break;default:i.y=-Math.round(n.totalHeight/2)}t.x+=i.x,t.y+=i.y},getCoordinateFromValue:function(t){return"string"!=typeOf(t)?t:(t=t.toLowerCase(),{x:t.test("left")?"left":t.test("right")?"right":"center",y:t.test(/upper|top/)?"top":t.test("bottom")?"bottom":"center"})}};Element.implement({position:function(e){if(e&&(null!=e.x||null!=e.y))return t?t.apply(this,arguments):this;var i=this.setStyle("position","absolute").calculatePosition(e);return e&&e.returnPos?i:this.setStyles(i)},calculatePosition:function(t){return e.getPosition(this,t)}})}(Element.prototype.position),Elements.from=function(t,e){(e||null==e)&&(t=t.stripScripts());var i,n=t.match(/^\s*(?:<!--.*?-->\s*)*<(t[dhr]|tbody|tfoot|thead)/i);if(n){i=new Element("table");var s=n[1].toLowerCase();["td","th","tr"].contains(s)&&(i=new Element("tbody").inject(i),"tr"!=s&&(i=new Element("tr").inject(i)))}return(i||new Element("div")).set("html",t).getChildren()},function(){var t=!1,e=this.IframeShim=new Class({Implements:[Options,Events,Class.Occlude],options:{className:"iframeShim",src:'javascript:false;document.write("");',display:!1,zIndex:null,margin:0,offset:{x:0,y:0},browsers:t},property:"IframeShim",initialize:function(t,e){return this.element=document.id(t),this.occlude()?this.occluded:(this.setOptions(e),this.makeShim(),this)},makeShim:function(){if(this.options.browsers){var t=this.element.getStyle("zIndex").toInt();if(!t){t=1;var i=this.element.getStyle("position");"static"!=i&&i||this.element.setStyle("position","relative"),this.element.setStyle("zIndex",t)}t=(null!=this.options.zIndex||0===this.options.zIndex)&&t>this.options.zIndex?this.options.zIndex:t-1,0>t&&(t=1),this.shim=new Element("iframe",{src:this.options.src,scrolling:"no",frameborder:0,styles:{zIndex:t,position:"absolute",border:"none",filter:"progid:DXImageTransform.Microsoft.Alpha(style=0,opacity=0)"},"class":this.options.className}).store("IframeShim",this);var n=function(){this.shim.inject(this.element,"after"),this[this.options.display?"show":"hide"](),this.fireEvent("inject")}.bind(this);e.ready?n():window.addEvent("load",n)}else this.position=this.hide=this.show=this.dispose=Function.convert(this)},position:function(){if(!e.ready||!this.shim)return this;var t=this.element.measure(function(){return this.getSize()});return void 0!=this.options.margin&&(t.x=t.x-2*this.options.margin,t.y=t.y-2*this.options.margin,this.options.offset.x+=this.options.margin,this.options.offset.y+=this.options.margin),this.shim.set({width:t.x,height:t.y}).position({relativeTo:this.element,offset:this.options.offset}),this},hide:function(){return this.shim&&this.shim.setStyle("display","none"),this},show:function(){return this.shim&&this.shim.setStyle("display","block"),this.position()},dispose:function(){return this.shim&&this.shim.dispose(),this},destroy:function(){return this.shim&&this.shim.destroy(),this}})}(),window.addEvent("load",function(){IframeShim.ready=!0}),function(){this.Mask=new Class({Implements:[Options,Events],Binds:["position"],options:{style:{},"class":"mask",maskMargins:!1,useIframeShim:!0,iframeShimOptions:{}},initialize:function(t,e){this.target=document.id(t)||document.id(document.body),this.target.store("mask",this),this.setOptions(e),this.render(),this.inject()},render:function(){this.element=new Element("div",{"class":this.options["class"],id:this.options.id||"mask-"+String.uniqueID(),styles:Object.merge({},this.options.style,{display:"none"}),events:{click:function(t){this.fireEvent("click",t),this.options.hideOnClick&&this.hide()}.bind(this)}}),this.hidden=!0},toElement:function(){return this.element},inject:function(t,e){e=e||(this.options.inject?this.options.inject.where:"")||(this.target==document.body?"inside":"after"),t=t||this.options.inject&&this.options.inject.target||this.target,this.element.inject(t,e),this.options.useIframeShim&&(this.shim=new IframeShim(this.element,this.options.iframeShimOptions),this.addEvents({show:this.shim.show.bind(this.shim),hide:this.shim.hide.bind(this.shim),destroy:this.shim.destroy.bind(this.shim)}))},position:function(){return this.resize(this.options.width,this.options.height),this.element.position({relativeTo:this.target,position:"topLeft",ignoreMargins:!this.options.maskMargins,ignoreScroll:this.target==document.body}),this},resize:function(t,e){var i={styles:["padding","border"]};this.options.maskMargins&&i.styles.push("margin");var n=this.target.getComputedSize(i);if(this.target==document.body){this.element.setStyles({width:0,height:0});var s=window.getScrollSize();n.totalHeight<s.y&&(n.totalHeight=s.y),n.totalWidth<s.x&&(n.totalWidth=s.x)}return this.element.setStyles({width:Array.pick([t,n.totalWidth,n.x]),height:Array.pick([e,n.totalHeight,n.y])}),this},show:function(){return this.hidden?(window.addEvent("resize",this.position),this.position(),this.showMask.apply(this,arguments),this):this},showMask:function(){this.element.setStyle("display","block"),this.hidden=!1,this.fireEvent("show")},hide:function(){return this.hidden?this:(window.removeEvent("resize",this.position),this.hideMask.apply(this,arguments),this.options.destroyOnHide?this.destroy():this)},hideMask:function(){this.element.setStyle("display","none"),this.hidden=!0,this.fireEvent("hide")},toggle:function(){this[this.hidden?"show":"hide"]()},destroy:function(){this.hide(),this.element.destroy(),this.fireEvent("destroy"),this.target.eliminate("mask")}})}(),Element.Properties.mask={set:function(t){var e=this.retrieve("mask");return e&&e.destroy(),this.eliminate("mask").store("mask:options",t)},get:function(){var t=this.retrieve("mask");return t||(t=new Mask(this,this.retrieve("mask:options")),this.store("mask",t)),t}},Element.implement({mask:function(t){return t&&this.set("mask",t),this.get("mask").show(),this},unmask:function(){return this.get("mask").hide(),this}}),function(){this.Spinner=new Class({Extends:this.Mask,Implements:Chain,options:{"class":"spinner",containerPosition:{},content:{"class":"spinner-content"},messageContainer:{"class":"spinner-msg"},img:{"class":"spinner-img"},fxOptions:{link:"chain"}},initialize:function(t,e){this.target=document.id(t)||document.id(document.body),this.target.store("spinner",this),this.setOptions(e),this.render(),this.inject();var i=function(){this.active=!1}.bind(this);this.addEvents({hide:i,show:i})},render:function(){this.parent(),this.element.set("id",this.options.id||"spinner-"+String.uniqueID()),this.content=document.id(this.options.content)||new Element("div",this.options.content),this.content.inject(this.element),this.options.message&&(this.msg=document.id(this.options.message)||new Element("p",this.options.messageContainer).appendText(this.options.message),this.msg.inject(this.content)),this.options.img&&(this.img=document.id(this.options.img)||new Element("div",this.options.img),this.img.inject(this.content)),this.element.set("tween",this.options.fxOptions)},show:function(t){return this.active?this.chain(this.show.bind(this)):this.hidden?(this.target.set("aria-busy","true"),this.active=!0,this.parent(t)):(this.callChain.delay(20,this),this)},showMask:function(t){var e=function(){this.content.position(Object.merge({relativeTo:this.element},this.options.containerPosition))}.bind(this);t?(this.parent(),e()):(this.options.style.opacity||(this.options.style.opacity=this.element.getStyle("opacity").toFloat()),this.element.setStyles({display:"block",opacity:0}).tween("opacity",this.options.style.opacity),e(),this.hidden=!1,this.fireEvent("show"),this.callChain())},hide:function(t){return this.active?this.chain(this.hide.bind(this)):this.hidden?(this.callChain.delay(20,this),this):(this.target.set("aria-busy","false"),this.active=!0,this.parent(t))},hideMask:function(t){return t?this.parent():void this.element.tween("opacity",0).get("tween").chain(function(){this.element.setStyle("display","none"),this.hidden=!0,this.fireEvent("hide"),this.callChain()}.bind(this))},destroy:function(){this.content.destroy(),this.parent(),this.target.eliminate("spinner")}})}(),Request=Class.refactor(Request,{options:{useSpinner:!1,spinnerOptions:{},spinnerTarget:!1},initialize:function(t){this._send=this.send,this.send=function(t){var e=this.getSpinner();return e?e.chain(this._send.pass(t,this)).show():this._send(t),this},this.previous(t)},getSpinner:function(){if(!this.spinner){var t=document.id(this.options.spinnerTarget)||document.id(this.options.update);if(this.options.useSpinner&&t){t.set("spinner",this.options.spinnerOptions);var e=this.spinner=t.get("spinner");["complete","exception","cancel"].each(function(t){this.addEvent(t,e.hide.bind(e))},this)}}return this.spinner}}),Element.Properties.spinner={set:function(t){var e=this.retrieve("spinner");return e&&e.destroy(),this.eliminate("spinner").store("spinner:options",t)},get:function(){var t=this.retrieve("spinner");return t||(t=new Spinner(this,this.retrieve("spinner:options")),this.store("spinner",t)),t}},Element.implement({spin:function(t){return t&&this.set("spinner",t),this.get("spinner").show(),this},unspin:function(){return this.get("spinner").hide(),this}}),function(){var t=function(t){return decodeURIComponent(t.replace(/\+/g," "))};String.implement({parseQueryString:function(e,i){null==e&&(e=!0),null==i&&(i=!0);var n=this.split(/[&;]/),s={};return n.length?(n.each(function(n){var r=n.indexOf("=")+1,o=r?n.substr(r):"",a=r?n.substr(0,r-1).match(/([^\]\[]+|(\B)(?=\]))/g):[n],h=s;a&&(i&&(o=t(o)),a.each(function(i,n){e&&(i=t(i));var s=h[i];n<a.length-1?h=h[i]=s||{}:"array"==typeOf(s)?s.push(o):h[i]=null!=s?[s,o]:o}))}),s):s},cleanQueryString:function(t){return this.split("&").filter(function(e){var i=e.indexOf("="),n=0>i?"":e.substr(0,i),s=e.substr(i+1);return t?t.call(null,n,s):s||0===s}).join("&")}})}(),window.Form||(window.Form={}),function(){Form.Request=new Class({Binds:["onSubmit","onFormValidate"],Implements:[Options,Events,Class.Occlude],options:{requestOptions:{evalScripts:!0,useSpinner:!0,emulation:!1,link:"ignore"},sendButtonClicked:!0,extraData:{},resetForm:!0},property:"form.request",initialize:function(t,e,i){return this.element=document.id(t),this.occlude()?this.occluded:void this.setOptions(i).setTarget(e).attach()},setTarget:function(t){return this.target=document.id(t),this.request?this.request.setOptions({update:this.target}):this.makeRequest(),this},toElement:function(){return this.element},makeRequest:function(){var t=this;return this.request=new Request.HTML(Object.merge({update:this.target,emulation:!1,spinnerTarget:this.element,method:this.element.get("method")||"post"},this.options.requestOptions)).addEvents({success:function(e,i,n,s){["complete","success"].each(function(r){t.fireEvent(r,[t.target,e,i,n,s])})},failure:function(){t.fireEvent("complete",arguments).fireEvent("failure",arguments)},exception:function(){t.fireEvent("failure",arguments)}}),this.attachReset()},attachReset:function(){return this.options.resetForm?(this.request.addEvent("success",function(){Function.attempt(function(){this.element.reset()}.bind(this)),window.OverText&&OverText.update()}.bind(this)),this):this},attach:function(t){var e=0!=t?"addEvent":"removeEvent";this.element[e]("click:relay(button, input[type=submit])",this.saveClickedButton.bind(this));var i=this.element.retrieve("validator");return i?i[e]("onFormValidate",this.onFormValidate):this.element[e]("submit",this.onSubmit),this},detach:function(){return this.attach(!1)},enable:function(){return this.attach()},disable:function(){return this.detach()},onFormValidate:function(t,e,i){if(i){var n=this.element.retrieve("validator");(t||n&&!n.options.stopOnFailure)&&(i.stop(),this.send())}},onSubmit:function(t){var e=this.element.retrieve("validator");return e?(this.element.removeEvent("submit",this.onSubmit),e.addEvent("onFormValidate",this.onFormValidate),void e.validate(t)):(t&&t.stop(),void this.send())},saveClickedButton:function(t,e){var i=e.get("name");i&&this.options.sendButtonClicked&&(this.options.extraData[i]=e.get("value")||!0,this.clickedCleaner=function(){delete this.options.extraData[i],this.clickedCleaner=function(){}}.bind(this))},clickedCleaner:function(){},send:function(){var t=this.element.toQueryString().trim(),e=Object.toQueryString(this.options.extraData);return t?t+="&"+e:t=e,this.fireEvent("send",[this.element,t.parseQueryString()]),this.request.send({data:t,url:this.options.requestOptions.url||this.element.get("action")}),this.clickedCleaner(),this}}),Element.implement("formUpdate",function(t,e){var i=this.retrieve("form.request");return i?(t&&i.setTarget(t),e&&i.setOptions(e).makeRequest()):i=new Form.Request(this,t,e),i.send(),this})}(),Element.implement({isDisplayed:function(){return"none"!=this.getStyle("display")},isVisible:function(){var t=this.offsetWidth,e=this.offsetHeight;return 0==t&&0==e?!1:t>0&&e>0?!0:"none"!=this.style.display},toggle:function(){return this[this.isDisplayed()?"hide":"show"]()},hide:function(){var t;try{t=this.getStyle("display")}catch(e){}return"none"==t?this:this.store("element:_originalDisplay",t||"").setStyle("display","none")},show:function(t){return!t&&this.isDisplayed()?this:(t=t||this.retrieve("element:_originalDisplay")||"block",this.setStyle("display","none"==t?"block":t))},swapClass:function(t,e){return this.removeClass(t).addClass(e)}}),Document.implement({clearSelection:function(){if(window.getSelection){var t=window.getSelection();t&&t.removeAllRanges&&t.removeAllRanges()}else if(document.selection&&document.selection.empty)try{document.selection.empty()}catch(e){}}}),function(){var t=function(t){var e=t.options.hideInputs;if(window.OverText){var i=[null];OverText.each(function(t){i.include("."+t.options.labelClass)}),i&&(e+=i.join(", "))}return e?t.element.getElements(e):null};Fx.Reveal=new Class({Extends:Fx.Morph,options:{link:"cancel",styles:["padding","border","margin"],transitionOpacity:"opacity"in document.documentElement,mode:"vertical",display:function(){return"tr"!=this.element.get("tag")?"block":"table-row"},opacity:1,hideInputs:"opacity"in document.documentElement?null:"select, input, textarea, object, embed"},dissolve:function(){if(this.hiding||this.showing)"chain"==this.options.link?this.chain(this.dissolve.bind(this)):"cancel"!=this.options.link||this.hiding||(this.cancel(),this.dissolve());else if("none"!=this.element.getStyle("display")){this.hiding=!0,this.showing=!1,this.hidden=!0,this.cssText=this.element.style.cssText;var e=this.element.getComputedSize({styles:this.options.styles,mode:this.options.mode});this.options.transitionOpacity&&(e.opacity=this.options.opacity);var i={};Object.each(e,function(t,e){i[e]=[t,0]}),this.element.setStyles({display:Function.convert(this.options.display).call(this),overflow:"hidden"});var n=t(this);n&&n.setStyle("visibility","hidden"),this.$chain.unshift(function(){this.hidden&&(this.hiding=!1,this.element.style.cssText=this.cssText,this.element.setStyle("display","none"),n&&n.setStyle("visibility","visible")),this.fireEvent("hide",this.element),this.callChain()}.bind(this)),this.start(i)}else this.callChain.delay(10,this),this.fireEvent("complete",this.element),this.fireEvent("hide",this.element);return this},reveal:function(){if(this.showing||this.hiding)"chain"==this.options.link?this.chain(this.reveal.bind(this)):"cancel"!=this.options.link||this.showing||(this.cancel(),this.reveal());else if("none"==this.element.getStyle("display")){this.hiding=!1,this.showing=!0,this.hidden=!1,this.cssText=this.element.style.cssText;var e;this.element.measure(function(){e=this.element.getComputedSize({styles:this.options.styles,mode:this.options.mode})}.bind(this)),null!=this.options.heightOverride&&(e.height=this.options.heightOverride.toInt()),null!=this.options.widthOverride&&(e.width=this.options.widthOverride.toInt()),this.options.transitionOpacity&&(this.element.setStyle("opacity",0),e.opacity=this.options.opacity);var i={height:0,display:Function.convert(this.options.display).call(this)};Object.each(e,function(t,e){i[e]=0}),i.overflow="hidden",this.element.setStyles(i);var n=t(this);n&&n.setStyle("visibility","hidden"),this.$chain.unshift(function(){this.element.style.cssText=this.cssText,this.element.setStyle("display",Function.convert(this.options.display).call(this)),this.hidden||(this.showing=!1),n&&n.setStyle("visibility","visible"),this.callChain(),this.fireEvent("show",this.element)}.bind(this)),this.start(e)}else this.callChain(),this.fireEvent("complete",this.element),this.fireEvent("show",this.element);return this},toggle:function(){return"none"==this.element.getStyle("display")?this.reveal():this.dissolve(),this},cancel:function(){return this.parent.apply(this,arguments),null!=this.cssText&&(this.element.style.cssText=this.cssText),this.hiding=!1,this.showing=!1,this}}),Element.Properties.reveal={set:function(t){return this.get("reveal").cancel().setOptions(t),this},get:function(){var t=this.retrieve("reveal");return t||(t=new Fx.Reveal(this),this.store("reveal",t)),t}},Element.Properties.dissolve=Element.Properties.reveal,Element.implement({reveal:function(t){return this.get("reveal").setOptions(t).reveal(),this},dissolve:function(t){return this.get("reveal").setOptions(t).dissolve(),this},nix:function(t){var e=Array.link(arguments,{destroy:Type.isBoolean,options:Type.isObject});return this.get("reveal").setOptions(t).dissolve().chain(function(){this[e.destroy?"destroy":"dispose"]()}.bind(this)),this},wink:function(){var t=Array.link(arguments,{duration:Type.isNumber,options:Type.isObject}),e=this.get("reveal").setOptions(t.options);e.reveal().chain(function(){(function(){e.dissolve()}).delay(t.duration||2e3)})}})}(),Form.Request.Append=new Class({Extends:Form.Request,options:{useReveal:!0,revealOptions:{},inject:"bottom"},makeRequest:function(){this.request=new Request.HTML(Object.merge({url:this.element.get("action"),method:this.element.get("method")||"post",spinnerTarget:this.element},this.options.requestOptions,{evalScripts:!1})).addEvents({success:function(t,e,i,n){var s,r=Elements.from(i);s=1==r.length?r[0]:new Element("div",{styles:{display:"none"}}).adopt(r),s.inject(this.target,this.options.inject),this.options.requestOptions.evalScripts&&Browser.exec(n),this.fireEvent("beforeEffect",s);var o=function(){this.fireEvent("success",[s,this.target,t,e,i,n])}.bind(this);this.options.useReveal?(s.set("reveal",this.options.revealOptions).get("reveal").chain(o),s.reveal()):o()}.bind(this),failure:function(t){this.fireEvent("failure",t)}.bind(this)}),this.attachReset()}}),function(){var t=function(t){return null!=t},e=Object.prototype.hasOwnProperty;Object.extend({getFromPath:function(t,i){"string"==typeof i&&(i=i.split("."));for(var n=0,s=i.length;s>n;n++){if(!e.call(t,i[n]))return null;t=t[i[n]]}return t},cleanValues:function(e,i){i=i||t;for(var n in e)i(e[n])||delete e[n];return e},erase:function(t,i){return e.call(t,i)&&delete t[i],t},run:function(t){var e=Array.slice(arguments,1);for(var i in t)t[i].apply&&t[i].apply(t,e);return t}})}(),function(){var t=null,e={},i=function(t){return instanceOf(t,n.Set)?t:e[t]},n=this.Locale={define:function(i,s,r,o){var a;return instanceOf(i,n.Set)?(a=i.name,a&&(e[a]=i)):(a=i,e[a]||(e[a]=new n.Set(a)),i=e[a]),s&&i.define(s,r,o),t||(t=i),i},use:function(e){return e=i(e),e&&(t=e,this.fireEvent("change",e)),this},getCurrent:function(){return t},get:function(e,i){return t?t.get(e,i):""},inherit:function(t,e,n){return t=i(t),t&&t.inherit(e,n),this},list:function(){return Object.keys(e)}};Object.append(n,new Events),n.Set=new Class({sets:{},inherits:{locales:[],sets:{}},initialize:function(t){this.name=t||""},define:function(t,e,i){var n=this.sets[t];return n||(n={}),e&&("object"==typeOf(e)?n=Object.merge(n,e):n[e]=i),this.sets[t]=n,this},get:function(t,i,n){var s=Object.getFromPath(this.sets,t);if(null!=s){var r=typeOf(s);return"function"==r?s=s.apply(null,Array.convert(i)):"object"==r&&(s=Object.clone(s)),s}var o=t.indexOf("."),a=0>o?t:t.substr(0,o),h=(this.inherits.sets[a]||[]).combine(this.inherits.locales).include("en-US");n||(n=[]);for(var l=0,u=h.length;u>l;l++)if(!n.contains(h[l])){n.include(h[l]);var c=e[h[l]];if(c&&(s=c.get(t,i,n),null!=s))return s}return""},inherit:function(t,e){t=Array.convert(t),e&&!this.inherits.sets[e]&&(this.inherits.sets[e]=[]);for(var i=t.length;i--;)(e?this.inherits.sets[e]:this.inherits.locales).unshift(t[i]);return this}})}(),Locale.define("en-US","Date",{months:["January","February","March","April","May","June","July","August","September","October","November","December"],months_abbr:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],days_abbr:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],dateOrder:["month","date","year"],shortDate:"%m/%d/%Y",shortTime:"%I:%M%p",AM:"AM",PM:"PM",firstDayOfWeek:0,ordinal:function(t){return t>3&&21>t?"th":["th","st","nd","rd","th"][Math.min(t%10,4)]},lessThanMinuteAgo:"less than a minute ago",minuteAgo:"about a minute ago",minutesAgo:"{delta} minutes ago",hourAgo:"about an hour ago",hoursAgo:"about {delta} hours ago",dayAgo:"1 day ago",daysAgo:"{delta} days ago",weekAgo:"1 week ago",weeksAgo:"{delta} weeks ago",monthAgo:"1 month ago",monthsAgo:"{delta} months ago",yearAgo:"1 year ago",yearsAgo:"{delta} years ago",lessThanMinuteUntil:"less than a minute from now",minuteUntil:"about a minute from now",minutesUntil:"{delta} minutes from now",hourUntil:"about an hour from now",hoursUntil:"about {delta} hours from now",dayUntil:"1 day from now",daysUntil:"{delta} days from now",weekUntil:"1 week from now",weeksUntil:"{delta} weeks from now",monthUntil:"1 month from now",monthsUntil:"{delta} months from now",yearUntil:"1 year from now",yearsUntil:"{delta} years from now"}),function(){var t=this.Date,e=t.Methods={ms:"Milliseconds",year:"FullYear",min:"Minutes",mo:"Month",sec:"Seconds",hr:"Hours"};["Date","Day","FullYear","Hours","Milliseconds","Minutes","Month","Seconds","Time","TimezoneOffset","Week","Timezone","GMTOffset","DayOfYear","LastMonth","LastDayOfMonth","UTCDate","UTCDay","UTCFullYear","AMPM","Ordinal","UTCHours","UTCMilliseconds","UTCMinutes","UTCMonth","UTCSeconds","UTCMilliseconds"].each(function(e){t.Methods[e.toLowerCase()]=e});var i=function(t,e,n){return 1==e?t:t<Math.pow(10,e-1)?(n||"0")+i(t,e-1,n):t};t.implement({set:function(t,i){t=t.toLowerCase();var n=e[t]&&"set"+e[t];return n&&this[n]&&this[n](i),this}.overloadSetter(),get:function(t){t=t.toLowerCase();var i=e[t]&&"get"+e[t];return i&&this[i]?this[i]():null}.overloadGetter(),clone:function(){return new t(this.get("time"))},increment:function(e,i){switch(e=e||"day",i=null!=i?i:1,e){case"year":return this.increment("month",12*i);case"month":var n=this.get("date");return this.set("date",1).set("mo",this.get("mo")+i),this.set("date",n.min(this.get("lastdayofmonth")));case"week":return this.increment("day",7*i);case"day":return this.set("date",this.get("date")+i)}if(!t.units[e])throw new Error(e+" is not a supported interval");return this.set("time",this.get("time")+i*t.units[e]())},decrement:function(t,e){return this.increment(t,-1*(null!=e?e:1))},isLeapYear:function(){return t.isLeapYear(this.get("year"))},clearTime:function(){return this.set({hr:0,min:0,sec:0,ms:0})},diff:function(e,i){return"string"==typeOf(e)&&(e=t.parse(e)),((e-this)/t.units[i||"day"](3,3)).round()},getLastDayOfMonth:function(){return t.daysInMonth(this.get("mo"),this.get("year"))},getDayOfYear:function(){return(t.UTC(this.get("year"),this.get("mo"),this.get("date")+1)-t.UTC(this.get("year"),0,1))/t.units.day()},setDay:function(e,i){null==i&&(i=t.getMsg("firstDayOfWeek"),""===i&&(i=1)),e=(7+t.parseDay(e,!0)-i)%7;var n=(7+this.get("day")-i)%7;return this.increment("day",e-n)},getWeek:function(e){null==e&&(e=t.getMsg("firstDayOfWeek"),""===e&&(e=1));var i,n=this,s=(7+n.get("day")-e)%7,r=0;if(1==e){var o=n.get("month"),a=n.get("date")-s;if(11==o&&a>28)return 1;0==o&&-2>a&&(n=new t(n).decrement("day",s),s=0),i=new t(n.get("year"),0,1).get("day")||7,i>4&&(r=-7)}else i=new t(n.get("year"),0,1).get("day");return r+=n.get("dayofyear"),r+=6-s,r+=(7+i-e)%7,r/7},getOrdinal:function(e){return t.getMsg("ordinal",e||this.get("date"))},getTimezone:function(){return this.toString().replace(/^.*? ([A-Z]{3}).[0-9]{4}.*$/,"$1").replace(/^.*?\(([A-Z])[a-z]+ ([A-Z])[a-z]+ ([A-Z])[a-z]+\)$/,"$1$2$3")},getGMTOffset:function(){var t=this.get("timezoneOffset");return(t>0?"-":"+")+i((t.abs()/60).floor(),2)+i(t%60,2)},setAMPM:function(t){t=t.toUpperCase();var e=this.get("hr");return e>11&&"AM"==t?this.decrement("hour",12):12>e&&"PM"==t?this.increment("hour",12):this},getAMPM:function(){return this.get("hr")<12?"AM":"PM"},parse:function(e){return this.set("time",t.parse(e)),this},isValid:function(t){return t||(t=this),"date"==typeOf(t)&&!isNaN(t.valueOf())},format:function(e){if(!this.isValid())return"invalid date";if(e||(e="%x %X"),"string"==typeof e&&(e=r[e.toLowerCase()]||e),"function"==typeof e)return e(this);var n=this;return e.replace(/%([a-z%])/gi,function(e,s){switch(s){case"a":return t.getMsg("days_abbr")[n.get("day")];case"A":return t.getMsg("days")[n.get("day")];case"b":return t.getMsg("months_abbr")[n.get("month")];case"B":return t.getMsg("months")[n.get("month")];case"c":return n.format("%a %b %d %H:%M:%S %Y");case"d":return i(n.get("date"),2);case"e":return i(n.get("date"),2," ");case"H":return i(n.get("hr"),2);case"I":return i(n.get("hr")%12||12,2);case"j":return i(n.get("dayofyear"),3);case"k":return i(n.get("hr"),2," ");case"l":return i(n.get("hr")%12||12,2," ");case"L":return i(n.get("ms"),3);case"m":return i(n.get("mo")+1,2);case"M":return i(n.get("min"),2);case"o":return n.get("ordinal");case"p":return t.getMsg(n.get("ampm"));case"s":return Math.round(n/1e3);case"S":return i(n.get("seconds"),2);case"T":return n.format("%H:%M:%S");case"U":return i(n.get("week"),2);case"w":return n.get("day");case"x":return n.format(t.getMsg("shortDate"));case"X":return n.format(t.getMsg("shortTime"));case"y":return n.get("year").toString().substr(2);case"Y":return n.get("year");case"z":return n.get("GMTOffset");case"Z":return n.get("Timezone")}return s})},toISOString:function(){return this.format("iso8601")}}).alias({toJSON:"toISOString",compare:"diff",strftime:"format"});var n=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],s=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],r={db:"%Y-%m-%d %H:%M:%S",compact:"%Y%m%dT%H%M%S","short":"%d %b %H:%M","long":"%B %d, %Y %H:%M",rfc822:function(t){return n[t.get("day")]+t.format(", %d ")+s[t.get("month")]+t.format(" %Y %H:%M:%S %Z")},rfc2822:function(t){return n[t.get("day")]+t.format(", %d ")+s[t.get("month")]+t.format(" %Y %H:%M:%S %z")},iso8601:function(t){return t.getUTCFullYear()+"-"+i(t.getUTCMonth()+1,2)+"-"+i(t.getUTCDate(),2)+"T"+i(t.getUTCHours(),2)+":"+i(t.getUTCMinutes(),2)+":"+i(t.getUTCSeconds(),2)+"."+i(t.getUTCMilliseconds(),3)+"Z"}},o=[],a=t.parse,h=function(e,i,n){var s=-1,r=t.getMsg(e+"s");switch(typeOf(i)){case"object":s=r[i.get(e)];break;case"number":if(s=r[i],!s)throw new Error("Invalid "+e+" index: "+i);break;case"string":var o=r.filter(function(t){return this.test(t)},new RegExp("^"+i,"i"));if(!o.length)throw new Error("Invalid "+e+" string");if(o.length>1)throw new Error("Ambiguous "+e);s=o[0]}return n?r.indexOf(s):s},l=1900,u=70;t.extend({getMsg:function(t,e){return Locale.get("Date."+t,e)},units:{ms:Function.convert(1),second:Function.convert(1e3),minute:Function.convert(6e4),hour:Function.convert(36e5),day:Function.convert(864e5),week:Function.convert(6084e5),month:function(e,i){var n=new t;return 864e5*t.daysInMonth(null!=e?e:n.get("mo"),null!=i?i:n.get("year"))},year:function(e){return e=e||(new t).get("year"),t.isLeapYear(e)?316224e5:31536e6}},daysInMonth:function(e,i){return[31,t.isLeapYear(i)?29:28,31,30,31,30,31,31,30,31,30,31][e]},isLeapYear:function(t){return t%4===0&&t%100!==0||t%400===0},parse:function(e){var i=typeOf(e);if("number"==i)return new t(e);if("string"!=i)return e;if(e=e.clean(),!e.length)return null;var n;return o.some(function(t){var i=t.re.exec(e);return i?n=t.handler(i):!1}),n&&n.isValid()||(n=new t(a(e)),n&&n.isValid()||(n=new t(e.toInt()))),n},parseDay:function(t,e){return h("day",t,e)},parseMonth:function(t,e){return h("month",t,e)},parseUTC:function(e){var i=new t(e),n=t.UTC(i.get("year"),i.get("mo"),i.get("date"),i.get("hr"),i.get("min"),i.get("sec"),i.get("ms"));return new t(n)},orderIndex:function(e){return t.getMsg("dateOrder").indexOf(e)+1},defineFormat:function(t,e){return r[t]=e,this},defineParser:function(t){return o.push(t.re&&t.handler?t:g(t)),this},defineParsers:function(){return Array.flatten(arguments).each(t.defineParser),this},define2DigitYearStart:function(t){return u=t%100,l=t-u,this}}).extend({defineFormats:t.defineFormat.overloadSetter()});var c=function(e){return new RegExp("(?:"+t.getMsg(e).map(function(t){return t.substr(0,3)}).join("|")+")[a-z]*")},d=function(e){switch(e){case"T":return"%H:%M:%S";case"x":return(1==t.orderIndex("month")?"%m[-./]%d":"%d[-./]%m")+"([-./]%y)?";case"X":return"%H([.:]%M)?([.:]%S([.:]%s)?)? ?%p? ?%z?"}return null},f={d:/[0-2]?[0-9]|3[01]/,H:/[01]?[0-9]|2[0-3]/,I:/0?[1-9]|1[0-2]/,M:/[0-5]?\d/,s:/\d+/,o:/[a-z]*/,p:/[ap]\.?m\.?/,y:/\d{2}|\d{4}/,Y:/\d{4}/,z:/Z|[+-]\d{2}(?::?\d{2})?/};f.m=f.I,f.S=f.M;var p,m=function(t){p=t,f.a=f.A=c("days"),f.b=f.B=c("months"),o.each(function(t,e){t.format&&(o[e]=g(t.format))})},g=function(e){if(!p)return{format:e};var i=[],n=(e.source||e).replace(/%([a-z])/gi,function(t,e){return d(e)||t}).replace(/\((?!\?)/g,"(?:").replace(/ (?!\?|\*)/g,",? ").replace(/%([a-z%])/gi,function(t,e){var n=f[e];return n?(i.push(e),"("+n.source+")"):e}).replace(/\[a-z\]/gi,"[a-z\\u00c0-\\uffff;&]");return{format:e,re:new RegExp("^"+n+"$","i"),handler:function(e){e=e.slice(1).associate(i);var n=(new t).clearTime(),s=e.y||e.Y;null!=s&&v.call(n,"y",s),"d"in e&&v.call(n,"d",1),("m"in e||e.b||e.B)&&v.call(n,"m",1);for(var r in e)v.call(n,r,e[r]);return n}}},v=function(e,i){if(!i)return this;switch(e){case"a":case"A":return this.set("day",t.parseDay(i,!0));case"b":case"B":return this.set("mo",t.parseMonth(i,!0));case"d":return this.set("date",i);case"H":case"I":return this.set("hr",i);case"m":return this.set("mo",i-1);case"M":return this.set("min",i);case"p":return this.set("ampm",i.replace(/\./g,""));case"S":return this.set("sec",i);case"s":return this.set("ms",1e3*("0."+i));case"w":return this.set("day",i);case"Y":return this.set("year",i);case"y":return i=+i,100>i&&(i+=l+(u>i?100:0)),this.set("year",i);case"z":"Z"==i&&(i="+00");var n=i.match(/([+-])(\d{2}):?(\d{2})?/);return n=(n[1]+"1")*(60*n[2]+(+n[3]||0))+this.getTimezoneOffset(),this.set("time",this-6e4*n)}return this};t.defineParsers("%Y([-./]%m([-./]%d((T| )%X)?)?)?","%Y%m%d(T%H(%M%S?)?)?","%x( %X)?","%d%o( %b( %Y)?)?( %X)?","%b( %d%o)?( %Y)?( %X)?","%Y %b( %d%o( %X)?)?","%o %b %d %X %z %Y","%T","%H:%M( ?%p)?"),Locale.addEvent("change",function(t){Locale.get("Date")&&m(t)}).fireEvent("change",Locale.getCurrent())}(),Locale.define("en-US","FormValidator",{required:"This field is required.",length:"Please enter {length} characters (you entered {elLength} characters)",minLength:"Please enter at least {minLength} characters (you entered {length} characters).",maxLength:"Please enter no more than {maxLength} characters (you entered {length} characters).",integer:"Please enter an integer in this field. Numbers with decimals (e.g. 1.25) are not permitted.",numeric:'Please enter only numeric values in this field (i.e. "1" or "1.1" or "-1" or "-1.1").',digits:"Please use numbers and punctuation only in this field (for example, a phone number with dashes or dots is permitted).",alpha:"Please use only letters (a-z) within this field. No spaces or other characters are allowed.",alphanum:"Please use only letters (a-z) or numbers (0-9) in this field. No spaces or other characters are allowed.",dateSuchAs:"Please enter a valid date such as {date}",dateInFormatMDY:'Please enter a valid date such as MM/DD/YYYY (i.e. "12/31/1999")',
email:'Please enter a valid email address. For example "fred@domain.com".',url:"Please enter a valid URL such as http://www.example.com.",currencyDollar:"Please enter a valid $ amount. For example $100.00 .",oneRequired:"Please enter something for at least one of these inputs.",errorPrefix:"Error: ",warningPrefix:"Warning: ",noSpace:"There can be no spaces in this input.",reqChkByNode:"No items are selected.",requiredChk:"This field is required.",reqChkByName:"Please select a {label}.",match:"This field needs to match the {matchName} field",startDate:"the start date",endDate:"the end date",currentDate:"the current date",afterDate:"The date should be the same or after {label}.",beforeDate:"The date should be the same or before {label}.",startMonth:"Please select a start month",sameMonth:"These two dates must be in the same month - you must change one or the other.",creditcard:"The credit card number entered is invalid. Please check the number and try again. {length} digits entered."}),window.Form||(window.Form={});var InputValidator=this.InputValidator=new Class({Implements:[Options],options:{errorMsg:"Validation failed.",test:Function.convert(!0)},initialize:function(t,e){this.setOptions(e),this.className=t},test:function(t,e){return t=document.id(t),t?this.options.test(t,e||this.getProps(t)):!1},getError:function(t,e){t=document.id(t);var i=this.options.errorMsg;return"function"==typeOf(i)&&(i=i(t,e||this.getProps(t))),i},getProps:function(t){return t=document.id(t),t?t.get("validatorProps"):{}}});Element.Properties.validators={get:function(){return(this.get("data-validators")||this.className).clean().replace(/'(\\.|[^'])*'|"(\\.|[^"])*"/g,function(t){return t.replace(" ","\\x20")}).split(" ")}},Element.Properties.validatorProps={set:function(t){return this.eliminate("$moo:validatorProps").store("$moo:validatorProps",t)},get:function(t){if(t&&this.set(t),this.retrieve("$moo:validatorProps"))return this.retrieve("$moo:validatorProps");if(this.getProperty("data-validator-properties")||this.getProperty("validatorProps"))try{this.store("$moo:validatorProps",JSON.decode(this.getProperty("validatorProps")||this.getProperty("data-validator-properties"),!1))}catch(e){return{}}else{var i=this.get("validators").filter(function(t){return t.test(":")});i.length?(t={},i.each(function(e){var i=e.split(":");if(i[1])try{t[i[0]]=JSON.decode(i[1],!1)}catch(n){}}),this.store("$moo:validatorProps",t)):this.store("$moo:validatorProps",{})}return this.retrieve("$moo:validatorProps")}},Form.Validator=new Class({Implements:[Options,Events],options:{fieldSelectors:"input, select, textarea",ignoreHidden:!0,ignoreDisabled:!0,useTitles:!1,evaluateOnSubmit:!0,evaluateFieldsOnBlur:!0,evaluateFieldsOnChange:!0,serial:!0,stopOnFailure:!0,warningPrefix:function(){return Form.Validator.getMsg("warningPrefix")||"Warning: "},errorPrefix:function(){return Form.Validator.getMsg("errorPrefix")||"Error: "}},initialize:function(t,e){this.setOptions(e),this.element=document.id(t),this.warningPrefix=Function.convert(this.options.warningPrefix)(),this.errorPrefix=Function.convert(this.options.errorPrefix)(),this._bound={onSubmit:this.onSubmit.bind(this),blurOrChange:function(t,e){this.validationMonitor(e,!0)}.bind(this)},this.enable()},toElement:function(){return this.element},getFields:function(){return this.fields=this.element.getElements(this.options.fieldSelectors)},enable:function(){this.element.store("validator",this),this.options.evaluateOnSubmit&&this.element.addEvent("submit",this._bound.onSubmit),this.options.evaluateFieldsOnBlur&&this.element.addEvent("blur:relay(input,select,textarea)",this._bound.blurOrChange),this.options.evaluateFieldsOnChange&&this.element.addEvent("change:relay(input,select,textarea)",this._bound.blurOrChange)},disable:function(){this.element.eliminate("validator"),this.element.removeEvents({submit:this._bound.onSubmit,"blur:relay(input,select,textarea)":this._bound.blurOrChange,"change:relay(input,select,textarea)":this._bound.blurOrChange})},validationMonitor:function(){clearTimeout(this.timer),this.timer=this.validateField.delay(50,this,arguments)},onSubmit:function(t){this.validate(t)&&this.reset()},reset:function(){return this.getFields().each(this.resetField,this),this},validate:function(t){var e=this.getFields().map(function(t){return this.validateField(t,!0)},this).every(function(t){return t});return this.fireEvent("formValidate",[e,this.element,t]),this.options.stopOnFailure&&!e&&t&&t.preventDefault(),e},validateField:function(t,e){if(this.paused)return!0;t=document.id(t);var i,n,s=!t.hasClass("validation-failed");if(this.options.serial&&!e&&(i=this.element.getElement(".validation-failed"),n=this.element.getElement(".warning")),t&&(!i||e||t.hasClass("validation-failed")||i&&!this.options.serial)){var r=t.get("validators"),o=r.some(function(t){return this.getValidator(t)},this),a=[];if(r.each(function(e){e&&!this.test(e,t)&&a.include(e)},this),s=0===a.length,o&&!this.hasValidator(t,"warnOnly")&&(s?(t.addClass("validation-passed").removeClass("validation-failed"),this.fireEvent("elementPass",[t])):(t.addClass("validation-failed").removeClass("validation-passed"),this.fireEvent("elementFail",[t,a]))),!n){r.some(function(t){return t.test("^warn")?this.getValidator(t.replace(/^warn-/,"")):null},this);t.removeClass("warning");r.map(function(e){return e.test("^warn")?this.test(e.replace(/^warn-/,""),t,!0):null},this)}}return s},test:function(t,e,i){if(e=document.id(e),this.options.ignoreHidden&&!e.isVisible()||this.options.ignoreDisabled&&e.get("disabled"))return!0;var n=this.getValidator(t);null!=i&&(i=!1),this.hasValidator(e,"warnOnly")&&(i=!0);var s=e.hasClass("ignoreValidation")||(n?n.test(e):!0);return n&&this.fireEvent("elementValidate",[s,e,t,i]),i?!0:s},hasValidator:function(t,e){return t.get("validators").contains(e)},resetField:function(t){return t=document.id(t),t&&t.get("validators").each(function(e){e.test("^warn-")&&(e=e.replace(/^warn-/,"")),t.removeClass("validation-failed"),t.removeClass("warning"),t.removeClass("validation-passed")},this),this},stop:function(){return this.paused=!0,this},start:function(){return this.paused=!1,this},ignoreField:function(t,e){return t=document.id(t),t&&(this.enforceField(t),e?t.addClass("warnOnly"):t.addClass("ignoreValidation")),this},enforceField:function(t){return t=document.id(t),t&&t.removeClass("warnOnly").removeClass("ignoreValidation"),this}}),Form.Validator.getMsg=function(t){return Locale.get("FormValidator."+t)},Form.Validator.adders={validators:{},add:function(t,e){this.validators[t]=new InputValidator(t,e),this.initialize||this.implement({validators:this.validators})},addAllThese:function(t){Array.convert(t).each(function(t){this.add(t[0],t[1])},this)},getValidator:function(t){return this.validators[t.split(":")[0]]}},Object.append(Form.Validator,Form.Validator.adders),Form.Validator.implement(Form.Validator.adders),Form.Validator.add("IsEmpty",{errorMsg:!1,test:function(t){return"select-one"==t.type||"select"==t.type?!(t.selectedIndex>=0&&""!=t.options[t.selectedIndex].value):null==t.get("value")||0==t.get("value").length}}),Form.Validator.addAllThese([["required",{errorMsg:function(){return Form.Validator.getMsg("required")},test:function(t){return!Form.Validator.getValidator("IsEmpty").test(t)}}],["length",{errorMsg:function(t,e){return"null"!=typeOf(e.length)?Form.Validator.getMsg("length").substitute({length:e.length,elLength:t.get("value").length}):""},test:function(t,e){return"null"!=typeOf(e.length)?t.get("value").length==e.length||0==t.get("value").length:!0}}],["minLength",{errorMsg:function(t,e){return"null"!=typeOf(e.minLength)?Form.Validator.getMsg("minLength").substitute({minLength:e.minLength,length:t.get("value").length}):""},test:function(t,e){return"null"!=typeOf(e.minLength)?t.get("value").length>=(e.minLength||0):!0}}],["maxLength",{errorMsg:function(t,e){return"null"!=typeOf(e.maxLength)?Form.Validator.getMsg("maxLength").substitute({maxLength:e.maxLength,length:t.get("value").length}):""},test:function(t,e){return t.get("value").length<=(e.maxLength||1e4)}}],["validate-integer",{errorMsg:Form.Validator.getMsg.pass("integer"),test:function(t){return Form.Validator.getValidator("IsEmpty").test(t)||/^(-?[1-9]\d*|0)$/.test(t.get("value"))}}],["validate-numeric",{errorMsg:Form.Validator.getMsg.pass("numeric"),test:function(t){return Form.Validator.getValidator("IsEmpty").test(t)||/^-?(?:0$0(?=\d*\.)|[1-9]|0)\d*(\.\d+)?$/.test(t.get("value"))}}],["validate-digits",{errorMsg:Form.Validator.getMsg.pass("digits"),test:function(t){return Form.Validator.getValidator("IsEmpty").test(t)||/^[\d() .:\-\+#]+$/.test(t.get("value"))}}],["validate-alpha",{errorMsg:Form.Validator.getMsg.pass("alpha"),test:function(t){return Form.Validator.getValidator("IsEmpty").test(t)||/^[a-zA-Z]+$/.test(t.get("value"))}}],["validate-alphanum",{errorMsg:Form.Validator.getMsg.pass("alphanum"),test:function(t){return Form.Validator.getValidator("IsEmpty").test(t)||!/\W/.test(t.get("value"))}}],["validate-date",{errorMsg:function(t,e){if(Date.parse){var i=e.dateFormat||"%x";return Form.Validator.getMsg("dateSuchAs").substitute({date:(new Date).format(i)})}return Form.Validator.getMsg("dateInFormatMDY")},test:function(t,e){if(Form.Validator.getValidator("IsEmpty").test(t))return!0;var i=Locale.get("Date"),n=new RegExp([i.days,i.days_abbr,i.months,i.months_abbr,i.AM,i.PM].flatten().join("|"),"i"),s=t.get("value"),r=s.match(/[a-z]+/gi);if(r&&!r.every(n.exec,n))return!1;var o=Date.parse(s);if(!o)return!1;var a=e.dateFormat||"%x",h=o.format(a);return"invalid date"!=h&&t.set("value",h),o.isValid()}}],["validate-email",{errorMsg:Form.Validator.getMsg.pass("email"),test:function(t){return Form.Validator.getValidator("IsEmpty").test(t)||/^(?:[a-z0-9!#$%&'*+\/=?^_`{|}~-]\.?){0,63}[a-z0-9!#$%&'*+\/=?^_`{|}~-]@(?:(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)*[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\])$/i.test(t.get("value"))}}],["validate-url",{errorMsg:Form.Validator.getMsg.pass("url"),test:function(t){return Form.Validator.getValidator("IsEmpty").test(t)||/^(https?|ftp|rmtp|mms):\/\/(([A-Z0-9][A-Z0-9_-]*)(\.[A-Z0-9][A-Z0-9_-]*)+)(:(\d+))?\/?/i.test(t.get("value"))}}],["validate-currency-dollar",{errorMsg:Form.Validator.getMsg.pass("currencyDollar"),test:function(t){return Form.Validator.getValidator("IsEmpty").test(t)||/^\$?\-?([1-9]{1}[0-9]{0,2}(\,[0-9]{3})*(\.[0-9]{0,2})?|[1-9]{1}\d*(\.[0-9]{0,2})?|0(\.[0-9]{0,2})?|(\.[0-9]{1,2})?)$/.test(t.get("value"))}}],["validate-one-required",{errorMsg:Form.Validator.getMsg.pass("oneRequired"),test:function(t,e){var i=document.id(e["validate-one-required"])||t.getParent(e["validate-one-required"]);return i.getElements("input").some(function(t){return["checkbox","radio"].contains(t.get("type"))?t.get("checked"):t.get("value")})}}]]),Element.Properties.validator={set:function(t){this.get("validator").setOptions(t)},get:function(){var t=this.retrieve("validator");return t||(t=new Form.Validator(this),this.store("validator",t)),t}},Element.implement({validate:function(t){return t&&this.set("validator",t),this.get("validator").validate()}}),function(){function t(t,e,i,n){if(e&&t[e])return t[e];var s=document.id(t[i]);return s?s.getElements(n):[]}Form.Validator.addAllThese([["validate-enforce-oncheck",{test:function(e,i){var n=e.getParent("form").retrieve("validator");return n?(t(i,"toEnforce","enforceChildrenOf","input, select, textarea").each(function(t){e.checked?n.enforceField(t):(n.ignoreField(t),n.resetField(t))}),!0):!0}}],["validate-ignore-oncheck",{test:function(e,i){var n=e.getParent("form").retrieve("validator");return n?(t(i,"toIgnore","ignoreChildrenOf","input, select, textarea").each(function(t){e.checked?(n.ignoreField(t),n.resetField(t)):n.enforceField(t)}),!0):!0}}],["validate-enforce-onselect-value",{test:function(e,i){if(!i.value)return!0;var n=e.getParent("form").retrieve("validator");return n?(t(i,"toEnforce","enforceChildrenOf","input, select, textarea").each(function(t){i.value==e.value?n.enforceField(t):(n.ignoreField(t),n.resetField(t))}),!0):!0}}],["validate-nospace",{errorMsg:function(){return Form.Validator.getMsg("noSpace")},test:function(t,e){return!t.get("value").test(/\s/)}}],["validate-toggle-oncheck",{test:function(e,i){var n=e.getParent("form").retrieve("validator");if(!n)return!0;var s=t(i,"toToggle","toToggleChildrenOf","input, select, textarea");return e.checked?s.each(function(t){n.enforceField(t)}):s.each(function(t){n.ignoreField(t),n.resetField(t)}),!0}}],["validate-reqchk-bynode",{errorMsg:function(){return Form.Validator.getMsg("reqChkByNode")},test:function(e,i){return t(i,!1,"nodeId",i.selector||"input[type=checkbox], input[type=radio]").some(function(t){return t.checked})}}],["validate-required-check",{errorMsg:function(t,e){return e.useTitle?t.get("title"):Form.Validator.getMsg("requiredChk")},test:function(t,e){return!!t.checked}}],["validate-reqchk-byname",{errorMsg:function(t,e){return Form.Validator.getMsg("reqChkByName").substitute({label:e.label||t.get("type")})},test:function(t,e){var i=e.groupName||t.get("name"),n=$$("[name="+i+"]"),s=n.some(function(t,e){return t.checked}),r=t.getParent("form").retrieve("validator");return s&&r&&n.each(function(t,e){r.resetField(t)}),s}}],["validate-match",{errorMsg:function(t,e){return Form.Validator.getMsg("match").substitute({matchName:decodeURIComponent((e.matchName+"").replace(/\+/g,"%20"))||document.id(e.matchInput).get("name")})},test:function(t,e){var i=t.get("value"),n=document.id(e.matchInput)&&document.id(e.matchInput).get("value");return i&&n?i==n:!0}}],["validate-after-date",{errorMsg:function(t,e){return Form.Validator.getMsg("afterDate").substitute({label:e.afterLabel||(e.afterElement?Form.Validator.getMsg("startDate"):Form.Validator.getMsg("currentDate"))})},test:function(t,e){var i=document.id(e.afterElement)?Date.parse(document.id(e.afterElement).get("value")):new Date,n=Date.parse(t.get("value"));return n&&i?n>=i:!0}}],["validate-before-date",{errorMsg:function(t,e){return Form.Validator.getMsg("beforeDate").substitute({label:e.beforeLabel||(e.beforeElement?Form.Validator.getMsg("endDate"):Form.Validator.getMsg("currentDate"))})},test:function(t,e){var i=Date.parse(t.get("value")),n=document.id(e.beforeElement)?Date.parse(document.id(e.beforeElement).get("value")):new Date;return n&&i?n>=i:!0}}],["validate-custom-required",{errorMsg:function(){return Form.Validator.getMsg("required")},test:function(t,e){return t.get("value")!=e.emptyValue}}],["validate-same-month",{errorMsg:function(t,e){var i=document.id(e.sameMonthAs)&&document.id(e.sameMonthAs).get("value"),n=t.get("value");return""!=n?Form.Validator.getMsg(i?"sameMonth":"startMonth"):void 0},test:function(t,e){var i=Date.parse(t.get("value")),n=Date.parse(document.id(e.sameMonthAs)&&document.id(e.sameMonthAs).get("value"));return i&&n?i.format("%B")==n.format("%B"):!0}}],["validate-cc-num",{errorMsg:function(t){var e=t.get("value").replace(/[^0-9]/g,"");return Form.Validator.getMsg("creditcard").substitute({length:e.length})},test:function(t){if(Form.Validator.getValidator("IsEmpty").test(t))return!0;var e=t.get("value");e=e.replace(/[^0-9]/g,"");var i=!1;if(e.test(/^4[0-9]{12}([0-9]{3})?$/)?i="Visa":e.test(/^5[1-5]([0-9]{14})$/)?i="Master Card":e.test(/^3[47][0-9]{13}$/)?i="American Express":e.test(/^6(?:011|5[0-9]{2})[0-9]{12}$/)?i="Discover":e.test(/^3(?:0[0-5]|[68][0-9])[0-9]{11}$/)&&(i="Diners Club"),i){for(var n=0,s=0,r=e.length-1;r>=0;--r)s=e.charAt(r).toInt(),0!=s&&((e.length-r)%2==0&&(s+=s),s>9&&(s=s.toString().charAt(0).toInt()+s.toString().charAt(1).toInt()),n+=s);if(n%10==0)return!0}for(var o="";""!=e;)o+=" "+e.substr(0,4),e=e.substr(4);return t.getParent("form").retrieve("validator").ignoreField(t),t.set("value",o.clean()),t.getParent("form").retrieve("validator").enforceField(t),!1}}]])}(),Form.Validator.Inline=new Class({Extends:Form.Validator,options:{showError:function(t){t.reveal?t.reveal():t.setStyle("display","block")},hideError:function(t){t.dissolve?t.dissolve():t.setStyle("display","none")},scrollToErrorsOnSubmit:!0,scrollToErrorsOnBlur:!1,scrollToErrorsOnChange:!1,scrollFxOptions:{transition:"quad:out",offset:{y:-20}}},initialize:function(t,e){this.parent(t,e),this.addEvent("onElementValidate",function(t,e,i,n){var s=this.getValidator(i);if(!t&&s.getError(e)){n&&e.addClass("warning");var r=this.makeAdvice(i,e,s.getError(e),n);this.insertAdvice(r,e),this.showAdvice(i,e)}else this.hideAdvice(i,e)})},makeAdvice:function(t,e,i,n){var s=n?this.warningPrefix:this.errorPrefix;s+=this.options.useTitles?e.title||i:i;var r=n?"warning-advice":"validation-advice",o=this.getAdvice(t,e);return o=o?o.set("html",s):new Element("div",{html:s,styles:{display:"none"},id:"advice-"+t.split(":")[0]+"-"+this.getFieldId(e)}).addClass(r),e.store("$moo:advice-"+t,o),o},getFieldId:function(t){return t.id?t.id:t.id="input_"+t.name},showAdvice:function(t,e){var i=this.getAdvice(t,e);!i||e.retrieve("$moo:"+this.getPropName(t))||"none"!=i.getStyle("display")&&"hidden"!=i.getStyle("visibility")&&0!=i.getStyle("opacity")||(e.store("$moo:"+this.getPropName(t),!0),this.options.showError(i),this.fireEvent("showAdvice",[e,i,t]))},hideAdvice:function(t,e){var i=this.getAdvice(t,e);i&&e.retrieve("$moo:"+this.getPropName(t))&&(e.store("$moo:"+this.getPropName(t),!1),this.options.hideError(i),this.fireEvent("hideAdvice",[e,i,t]))},getPropName:function(t){return"advice"+t},resetField:function(t){return(t=document.id(t))?(this.parent(t),t.get("validators").each(function(e){this.hideAdvice(e,t)},this),this):this},getAllAdviceMessages:function(t,e){var i=[];if(t.hasClass("ignoreValidation")&&!e)return i;t.get("validators").some(function(e){var n=e.test("^warn-")||t.hasClass("warnOnly");n&&(e=e.replace(/^warn-/,""));var s=this.getValidator(e);s&&i.push({message:s.getError(t),warnOnly:n,passed:s.test(),validator:s})},this);return i},getAdvice:function(t,e){return e.retrieve("$moo:advice-"+t)},insertAdvice:function(t,e){var i=e.get("validatorProps");i.msgPos&&document.id(i.msgPos)?document.id(i.msgPos).grab(t):e.type&&"radio"==e.type.toLowerCase()?e.getParent().adopt(t):t.inject(document.id(e),"after")},validateField:function(t,e,i){var n=this.parent(t,e);if((this.options.scrollToErrorsOnSubmit&&null==i||i)&&!n){for(var s=document.id(this).getElement(".validation-failed"),r=document.id(this).getParent();r!=document.body&&r.getScrollSize().y==r.getSize().y;)r=r.getParent();var o=r.retrieve("$moo:fvScroller");!o&&window.Fx&&Fx.Scroll&&(o=new Fx.Scroll(r,this.options.scrollFxOptions),r.store("$moo:fvScroller",o)),s&&(o?o.toElement(s):r.scrollTo(r.getScroll().x,s.getPosition(r).y-20))}return n},watchFields:function(t){t.each(function(t){this.options.evaluateFieldsOnBlur&&t.addEvent("blur",this.validationMonitor.pass([t,!1,this.options.scrollToErrorsOnBlur],this)),this.options.evaluateFieldsOnChange&&t.addEvent("change",this.validationMonitor.pass([t,!0,this.options.scrollToErrorsOnChange],this))},this)}}),Fx.Elements=new Class({Extends:Fx.CSS,initialize:function(t,e){this.elements=this.subject=$$(t),this.parent(e)},compute:function(t,e,i){var n={};for(var s in t){var r=t[s],o=e[s],a=n[s]={};for(var h in r)a[h]=this.parent(r[h],o[h],i)}return n},set:function(t){for(var e in t)if(this.elements[e]){var i=t[e];for(var n in i)this.render(this.elements[e],n,i[n],this.options.unit)}return this},start:function(t){if(!this.check(t))return this;var e={},i={};for(var n in t)if(this.elements[n]){var s=t[n],r=e[n]={},o=i[n]={};for(var a in s){var h=this.prepare(this.elements[n],a,s[a]);r[a]=h.from,o[a]=h.to}}return this.parent(e,i)}}),Fx.Accordion=new Class({Extends:Fx.Elements,options:{fixedHeight:!1,fixedWidth:!1,display:0,show:!1,height:!0,width:!1,opacity:!0,alwaysHide:!1,trigger:"click",initialDisplayFx:!0,resetHeight:!0,keepOpen:!1},initialize:function(){var t=function(t){return null!=t},e=Array.link(arguments,{container:Type.isElement,options:Type.isObject,togglers:t,elements:t});this.parent(e.elements,e.options);var i=this.options,n=this.togglers=$$(e.togglers);this.previous=-1,this.internalChain=new Chain,i.alwaysHide&&(this.options.link="chain"),(i.show||0===this.options.show)&&(i.display=!1,this.previous=i.show),i.start&&(i.display=!1,i.show=!1);var s=this.effects={};i.opacity&&(s.opacity="fullOpacity"),i.width&&(s.width=i.fixedWidth?"fullWidth":"offsetWidth"),i.height&&(s.height=i.fixedHeight?"fullHeight":"scrollHeight");for(var r=0,o=n.length;o>r;r++)this.addSection(n[r],this.elements[r]);this.elements.each(function(t,e){if(i.show===e)this.fireEvent("active",[n[e],t]);else for(var r in s)t.setStyle(r,0)},this),(i.display||0===i.display||i.initialDisplayFx===!1)&&this.display(i.display,i.initialDisplayFx),i.fixedHeight!==!1&&(i.resetHeight=!1),this.addEvent("complete",this.internalChain.callChain.bind(this.internalChain))},addSection:function(t,e){t=document.id(t),e=document.id(e),this.togglers.include(t),this.elements.include(e);var i=this.togglers,n=this.options,s=i.contains(t),r=i.indexOf(t),o=this.display.pass(r,this);if(t.store("accordion:display",o).addEvent(n.trigger,o),n.height&&e.setStyles({"padding-top":0,"border-top":"none","padding-bottom":0,"border-bottom":"none"}),n.width&&e.setStyles({"padding-left":0,"border-left":"none","padding-right":0,"border-right":"none"}),e.fullOpacity=1,n.fixedWidth&&(e.fullWidth=n.fixedWidth),n.fixedHeight&&(e.fullHeight=n.fixedHeight),e.setStyle("overflow","hidden"),!s)for(var a in this.effects)e.setStyle(a,0);return this},removeSection:function(t,e){var i=this.togglers,n=i.indexOf(t),s=this.elements[n],r=function(){i.erase(t),this.elements.erase(s),this.detach(t)}.bind(this);return this.now==n||null!=e?this.display(null!=e?e:n-1>=0?n-1:0).chain(r):r(),this},detach:function(t){var e=function(t){t.removeEvent(this.options.trigger,t.retrieve("accordion:display"))}.bind(this);return t?e(t):this.togglers.each(e),this},display:function(t,e){if(!this.check(t,e))return this;var i={},n=this.elements,s=this.options,r=this.effects,o=s.keepOpen,a=s.alwaysHide;if(null==e&&(e=!0),"element"==typeOf(t)&&(t=n.indexOf(t)),t==this.current&&!a&&!o)return this;if(s.resetHeight){var h=n[this.current];if(h&&!this.selfHidden)for(var l in r)h.setStyle(l,h[r[l]])}return this.timer&&"chain"==s.link?this:(null!=this.current&&(this.previous=this.current),this.current=t,this.selfHidden=!1,n.each(function(n,h){i[h]={};var l,u;if(!o||h==t){h==t&&(u=n.offsetHeight>0&&s.height||n.offsetWidth>0&&s.width),h!=t?l=!0:(a||o)&&u&&(l=!0,this.selfHidden=!0),this.fireEvent(l?"background":"active",[this.togglers[h],n]);for(var c in r)i[h][c]=l?0:n[r[c]];e||l||!s.resetHeight||(i[h].height="auto")}},this),this.internalChain.clearChain(),this.internalChain.chain(function(){if(s.resetHeight&&!this.selfHidden){var e=n[t];e&&e.setStyle("height","auto")}}.bind(this)),e?this.start(i):this.set(i).internalChain.callChain())}}),Fx.Move=new Class({Extends:Fx.Morph,options:{relativeTo:document.body,position:"center",edge:!1,offset:{x:0,y:0}},start:function(t){var e=this.element,i=e.getStyles("top","left");return("auto"==i.top||"auto"==i.left)&&e.setPosition(e.getPosition(e.getOffsetParent())),this.parent(e.position(Object.merge({},this.options,t,{returnPos:!0})))}}),Element.Properties.move={set:function(t){return this.get("move").cancel().setOptions(t),this},get:function(){var t=this.retrieve("move");return t||(t=new Fx.Move(this,{link:"cancel"}),this.store("move",t)),t}},Element.implement({move:function(t){return this.get("move").start(t),this}}),function(){function t(t){return/^(?:body|html)$/i.test(t.tagName)}Fx.Scroll=new Class({Extends:Fx,options:{offset:{x:0,y:0},wheelStops:!0},initialize:function(t,e){if(this.element=this.subject=document.id(t),this.parent(e),"element"!=typeOf(this.element)&&(this.element=document.id(this.element.getDocument().body)),this.options.wheelStops){var i=this.element,n=this.cancel.pass(!1,this);this.addEvent("start",function(){i.addEvent("mousewheel",n)},!0),this.addEvent("complete",function(){i.removeEvent("mousewheel",n)},!0)}},set:function(){var t=Array.flatten(arguments);return this.element.scrollTo(t[0],t[1]),this},compute:function(t,e,i){return[0,1].map(function(n){return Fx.compute(t[n],e[n],i)})},start:function(t,e){if(!this.check(t,e))return this;var i=this.element.getScroll();return this.parent([i.x,i.y],[t,e])},calculateScroll:function(t,e){var i=this.element,n=i.getScrollSize(),s=i.getScroll(),r=i.getSize(),o=this.options.offset,a={x:t,y:e};for(var h in a)a[h]||0===a[h]||(a[h]=s[h]),"number"!=typeOf(a[h])&&(a[h]=n[h]-r[h]),a[h]+=o[h];return[a.x,a.y]},toTop:function(){return this.start.apply(this,this.calculateScroll(!1,0))},toLeft:function(){return this.start.apply(this,this.calculateScroll(0,!1))},toRight:function(){return this.start.apply(this,this.calculateScroll("right",!1))},toBottom:function(){return this.start.apply(this,this.calculateScroll(!1,"bottom"))},toElement:function(e,i){i=i?Array.convert(i):["x","y"];var n=t(this.element)?{x:0,y:0}:this.element.getScroll(),s=Object.map(document.id(e).getPosition(this.element),function(t,e){return i.contains(e)?t+n[e]:!1});return this.start.apply(this,this.calculateScroll(s.x,s.y))},toElementEdge:function(t,e,i){e=e?Array.convert(e):["x","y"],t=document.id(t);var n={},s=t.getPosition(this.element),r=t.getSize(),o=this.element.getScroll(),a=this.element.getSize(),h={x:s.x+r.x,y:s.y+r.y};return["x","y"].each(function(t){e.contains(t)&&(h[t]>o[t]+a[t]&&(n[t]=h[t]-a[t]),s[t]<o[t]&&(n[t]=s[t])),null==n[t]&&(n[t]=o[t]),i&&i[t]&&(n[t]=n[t]+i[t])},this),(n.x!=o.x||n.y!=o.y)&&this.start(n.x,n.y),this},toElementCenter:function(t,e,i){e=e?Array.convert(e):["x","y"],t=document.id(t);var n={},s=t.getPosition(this.element),r=t.getSize(),o=this.element.getScroll(),a=this.element.getSize();return["x","y"].each(function(t){e.contains(t)&&(n[t]=s[t]-(a[t]-r[t])/2),null==n[t]&&(n[t]=o[t]),i&&i[t]&&(n[t]=n[t]+i[t])},this),(n.x!=o.x||n.y!=o.y)&&this.start(n.x,n.y),this}})}(),Fx.Slide=new Class({Extends:Fx,options:{mode:"vertical",wrapper:!1,hideOverflow:!0,resetHeight:!1},initialize:function(t,e){t=this.element=this.subject=document.id(t),this.parent(e),e=this.options;var i=t.retrieve("wrapper"),n=t.getStyles("margin","position","overflow");e.hideOverflow&&(n=Object.append(n,{overflow:"hidden"})),e.wrapper&&(i=document.id(e.wrapper).setStyles(n)),i||(i=new Element("div",{styles:n}).wraps(t)),t.store("wrapper",i).setStyle("margin",0),"visible"==t.getStyle("overflow")&&t.setStyle("overflow","hidden"),this.now=[],this.open=!0,this.wrapper=i,this.addEvent("complete",function(){this.open=0!=i["offset"+this.layout.capitalize()],this.open&&this.options.resetHeight&&i.setStyle("height","")},!0)},vertical:function(){this.margin="margin-top",this.layout="height",this.offset=this.element.offsetHeight},horizontal:function(){this.margin="margin-left",this.layout="width",this.offset=this.element.offsetWidth},set:function(t){return this.element.setStyle(this.margin,t[0]),this.wrapper.setStyle(this.layout,t[1]),this},compute:function(t,e,i){return[0,1].map(function(n){return Fx.compute(t[n],e[n],i)})},start:function(t,e){if(!this.check(t,e))return this;this[e||this.options.mode]();var i,n=this.element.getStyle(this.margin).toInt(),s=this.wrapper.getStyle(this.layout).toInt(),r=[[n,s],[0,this.offset]],o=[[n,s],[-this.offset,0]];switch(t){case"in":i=r;break;case"out":i=o;break;case"toggle":i=0==s?r:o}return this.parent(i[0],i[1])},slideIn:function(t){return this.start("in",t)},slideOut:function(t){return this.start("out",t)},hide:function(t){return this[t||this.options.mode](),this.open=!1,this.set([-this.offset,0])},show:function(t){return this[t||this.options.mode](),this.open=!0,this.set([0,this.offset])},toggle:function(t){return this.start("toggle",t)}}),Element.Properties.slide={set:function(t){return this.get("slide").cancel().setOptions(t),this},get:function(){var t=this.retrieve("slide");return t||(t=new Fx.Slide(this,{link:"cancel"}),this.store("slide",t)),t}},Element.implement({slide:function(t,e){t=t||"toggle";var i,n=this.get("slide");switch(t){case"hide":n.hide(e);break;case"show":n.show(e);break;case"toggle":var s=this.retrieve("slide:flag",n.open);n[s?"slideOut":"slideIn"](e),this.store("slide:flag",!s),i=!0;break;default:n.start(t,e)}return i||this.eliminate("slide:flag"),this}}),Fx.SmoothScroll=new Class({Extends:Fx.Scroll,options:{axes:["x","y"]},initialize:function(t,e){e=e||document,this.doc=e.getDocument(),this.parent(this.doc,t);var i=e.getWindow(),n=i.location.href.match(/^[^#]*/)[0]+"#",s=$$(this.options.links||this.doc.links);s.each(function(t){if(0==t.href.indexOf(n)){var e=t.href.substr(n.length);e&&this.useLink(t,e)}},this),this.addEvent("complete",function(){i.location.hash=this.anchor,this.element.scrollTo(this.to[0],this.to[1])},!0)},useLink:function(t,e){return t.addEvent("click",function(i){var n=document.id(e)||this.doc.getElement("a[name="+e+"]");n&&(i.preventDefault(),this.toElement(n,this.options.axes).chain(function(){this.fireEvent("scrolledTo",[t,n])}.bind(this)),this.anchor=e)}.bind(this)),this}}),Fx.Sort=new Class({Extends:Fx.Elements,options:{mode:"vertical"},initialize:function(t,e){this.parent(t,e),this.elements.each(function(t){"static"==t.getStyle("position")&&t.setStyle("position","relative")}),this.setDefaultOrder()},setDefaultOrder:function(){this.currentOrder=this.elements.map(function(t,e){return e})},sort:function(){if(!this.check(arguments))return this;var t=Array.flatten(arguments),e=0,i=0,n={},s={},r="vertical"==this.options.mode,o=this.elements.map(function(t,n){var o,a=t.getComputedSize({styles:["border","padding","margin"]});r?(o={top:e,margin:a["margin-top"],height:a.totalHeight},e+=o.height-a["margin-top"]):(o={left:i,margin:a["margin-left"],width:a.totalWidth},i+=o.width);var h=r?"top":"left";s[n]={};var l=t.getStyle(h).toInt();return s[n][h]=l||0,o},this);this.set(s),t=t.map(function(t){return t.toInt()}),t.length!=this.elements.length&&(this.currentOrder.each(function(e){t.contains(e)||t.push(e)}),t.length>this.elements.length&&t.splice(this.elements.length-1,t.length-this.elements.length));var a=0;e=i=0,t.each(function(t){var s={};r?(s.top=e-o[t].top-a,e+=o[t].height):(s.left=i-o[t].left,i+=o[t].width),a+=o[t].margin,n[t]=s},this);var h={};return Array.clone(t).sort().each(function(t){h[t]=n[t]}),this.start(h),this.currentOrder=t,this},rearrangeDOM:function(t){t=t||this.currentOrder;var e=this.elements[0].getParent(),i=[];return this.elements.setStyle("opacity",0),t.each(function(t){i.push(this.elements[t].inject(e).setStyles({top:0,left:0}))},this),this.elements.setStyle("opacity",1),this.elements=$$(i),this.setDefaultOrder(),this},getDefaultOrder:function(){return this.elements.map(function(t,e){return e})},getCurrentOrder:function(){return this.currentOrder},forward:function(){return this.sort(this.getDefaultOrder())},backward:function(){return this.sort(this.getDefaultOrder().reverse())},reverse:function(){return this.sort(this.currentOrder.reverse())},sortByElements:function(t){return this.sort(t.map(function(t){return this.elements.indexOf(t)},this))},swap:function(t,e){"element"==typeOf(t)&&(t=this.elements.indexOf(t)),"element"==typeOf(e)&&(e=this.elements.indexOf(e));var i=Array.clone(this.currentOrder);return i[this.currentOrder.indexOf(t)]=e,i[this.currentOrder.indexOf(e)]=t,this.sort(i)}}),function(){var t=this.Keyboard=new Class({Extends:Events,Implements:[Options],options:{defaultEventType:"keydown",active:!1,manager:null,events:{},nonParsedEvents:["activate","deactivate","onactivate","ondeactivate","changed","onchanged"]},initialize:function(t){t&&t.manager&&(this._manager=t.manager,delete t.manager),this.setOptions(t),this._setup()},addEvent:function(e,i,n){return this.parent(t.parse(e,this.options.defaultEventType,this.options.nonParsedEvents),i,n)},removeEvent:function(e,i){return this.parent(t.parse(e,this.options.defaultEventType,this.options.nonParsedEvents),i)},toggleActive:function(){
return this[this.isActive()?"deactivate":"activate"]()},activate:function(e){if(e){if(e.isActive())return this;this._activeKB&&e!=this._activeKB&&(this.previous=this._activeKB,this.previous.fireEvent("deactivate")),this._activeKB=e.fireEvent("activate"),t.manager.fireEvent("changed")}else this._manager&&this._manager.activate(this);return this},isActive:function(){return this._manager?this._manager._activeKB==this:t.manager==this},deactivate:function(e){return e?e===this._activeKB&&(this._activeKB=null,e.fireEvent("deactivate"),t.manager.fireEvent("changed")):this._manager&&this._manager.deactivate(this),this},relinquish:function(){return this.isActive()&&this._manager&&this._manager.previous?this._manager.activate(this._manager.previous):this.deactivate(),this},manage:function(t){return t._manager&&t._manager.drop(t),this._instances.push(t),t._manager=this,this._activeKB||this.activate(t),this},drop:function(t){return t.relinquish(),this._instances.erase(t),this._activeKB==t&&(this.previous&&this._instances.contains(this.previous)?this.activate(this.previous):this._activeKB=this._instances[0]),this},trace:function(){t.trace(this)},each:function(e){t.each(this,e)},_instances:[],_disable:function(t){this._activeKB==t&&(this._activeKB=null)},_setup:function(){this.addEvents(this.options.events),t.manager&&!this._manager&&t.manager.manage(this),this.options.active?this.activate():this.relinquish()},_handle:function(t,e){if(!t.preventKeyboardPropagation){var i=!!this._manager;i&&this._activeKB&&(this._activeKB._handle(t,e),t.preventKeyboardPropagation)||(this.fireEvent(e,t),!i&&this._activeKB&&this._activeKB._handle(t,e))}}}),e={},i=["shift","control","alt","meta"],n=/^(?:shift|control|ctrl|alt|meta)$/;t.parse=function(t,s,r){if(r&&r.contains(t.toLowerCase()))return t;if(t=t.toLowerCase().replace(/^(keyup|keydown):/,function(t,e){return s=e,""}),!e[t])if("+"!=t){var o,a={};t.split("+").each(function(t){n.test(t)?a[t]=!0:o=t}),a.control=a.control||a.ctrl;var h=[];i.each(function(t){a[t]&&h.push(t)}),o&&h.push(o),e[t]=h.join("+")}else e[t]=t;return s+":keys("+e[t]+")"},t.each=function(e,i){for(var n=e||t.manager;n;)i(n),n=n._activeKB},t.stop=function(t){t.preventKeyboardPropagation=!0},t.manager=new t({active:!0}),t.trace=function(e){e=e||t.manager;var i=window.console&&console.log;i&&console.log("the following items have focus: "),t.each(e,function(t){i&&console.log(document.id(t.widget)||t.wiget||t)})};var s=function(e){var s=[];i.each(function(t){e[t]&&s.push(t)}),n.test(e.key)||s.push(e.key),t.manager._handle(e,e.type+":keys("+s.join("+")+")")};document.addEvents({keyup:s,keydown:s})}(),Keyboard.prototype.options.nonParsedEvents.combine(["rebound","onrebound"]),Keyboard.implement({addShortcut:function(t,e){return this._shortcuts=this._shortcuts||[],this._shortcutIndex=this._shortcutIndex||{},e.getKeyboard=Function.convert(this),e.name=t,this._shortcutIndex[t]=e,this._shortcuts.push(e),e.keys&&this.addEvent(e.keys,e.handler),this},addShortcuts:function(t){for(var e in t)this.addShortcut(e,t[e]);return this},removeShortcut:function(t){var e=this.getShortcut(t);return e&&e.keys&&(this.removeEvent(e.keys,e.handler),delete this._shortcutIndex[t],this._shortcuts.erase(e)),this},removeShortcuts:function(t){return t.each(this.removeShortcut,this),this},getShortcuts:function(){return this._shortcuts||[]},getShortcut:function(t){return(this._shortcutIndex||{})[t]}}),Keyboard.rebind=function(t,e){Array.convert(e).each(function(e){e.getKeyboard().removeEvent(e.keys,e.handler),e.getKeyboard().addEvent(t,e.handler),e.keys=t,e.getKeyboard().fireEvent("rebound")})},Keyboard.getActiveShortcuts=function(t){var e=[],i=[];return Keyboard.each(t,[].push.bind(e)),e.each(function(t){i.extend(t.getShortcuts())}),i},Keyboard.getShortcut=function(t,e,i){i=i||{};var n=i.many?[]:null,s=i.many?function(e){var i=e.getShortcut(t);i&&n.push(i)}:function(e){n||(n=e.getShortcut(t))};return Keyboard.each(e,s),n},Keyboard.getShortcuts=function(t,e){return Keyboard.getShortcut(t,e,{many:!0})},function(){this.HtmlTable=new Class({Implements:[Options,Events,Class.Occlude],options:{properties:{cellpadding:0,cellspacing:0,border:0},rows:[],headers:[],footers:[]},property:"HtmlTable",initialize:function(){var t=Array.link(arguments,{options:Type.isObject,table:Type.isElement,id:Type.isString});return this.setOptions(t.options),!t.table&&t.id&&(t.table=document.id(t.id)),this.element=t.table||new Element("table",this.options.properties),this.occlude()?this.occluded:void this.build()},build:function(){this.element.store("HtmlTable",this),this.body=document.id(this.element.tBodies[0])||new Element("tbody").inject(this.element),$$(this.body.rows),this.options.headers.length?this.setHeaders(this.options.headers):this.thead=document.id(this.element.tHead),this.thead&&(this.head=this.getHead()),this.options.footers.length&&this.setFooters(this.options.footers),this.tfoot=document.id(this.element.tFoot),this.tfoot&&(this.foot=document.id(this.tfoot.rows[0])),this.options.rows.each(function(t){this.push(t)},this)},toElement:function(){return this.element},empty:function(){return this.body.empty(),this},set:function(t,e){var i="headers"==t?"tHead":"tFoot",n=i.toLowerCase();this[n]=(document.id(this.element[i])||new Element(n).inject(this.element,"top")).empty();var s=this.push(e,{},this[n],"headers"==t?"th":"td");return"headers"==t?this.head=this.getHead():this.foot=this.getHead(),s},getHead:function(){var t=this.thead.rows;return t.length>1?$$(t):t.length?document.id(t[0]):!1},setHeaders:function(t){return this.set("headers",t),this},setFooters:function(t){return this.set("footers",t),this},update:function(t,e,i){var n=t.getChildren(i||"td"),s=n.length-1;return e.each(function(e,r){var o=n[r]||new Element(i||"td").inject(t),a=(e&&Object.prototype.hasOwnProperty.call(e,"content")?e.content:"")||e,h=typeOf(a);e&&Object.prototype.hasOwnProperty.call(e,"properties")&&o.set(e.properties),/(element(s?)|array|collection)/.test(h)?o.empty().adopt(a):o.set("html",a),r>s?n.push(o):n[r]=o}),{tr:t,tds:n}},push:function(t,e,i,n,s){return"element"==typeOf(t)&&"tr"==t.get("tag")?(t.inject(i||this.body,s),{tr:t,tds:t.getChildren("td")}):this.update(new Element("tr",e).inject(i||this.body,s),t,n)},pushMany:function(t,e,i,n,s){return t.map(function(t){return this.push(t,e,i,n,s)},this)}})}(),["adopt","inject","wraps","grab","replaces","dispose"].each(function(t){HtmlTable.implement(t,function(){return this.element[t].apply(this.element,arguments),this})}),HtmlTable=Class.refactor(HtmlTable,{options:{useKeyboard:!0,classRowSelected:"table-tr-selected",classRowHovered:"table-tr-hovered",classSelectable:"table-selectable",shiftForMultiSelect:!0,allowMultiSelect:!0,selectable:!1,selectHiddenRows:!1},initialize:function(){return this.previous.apply(this,arguments),this.occluded?this.occluded:(this.selectedRows=new Elements,this.bound||(this.bound={}),this.bound.mouseleave=this.mouseleave.bind(this),this.bound.clickRow=this.clickRow.bind(this),this.bound.activateKeyboard=function(){this.keyboard&&this.selectEnabled&&this.keyboard.activate()}.bind(this),void(this.options.selectable&&this.enableSelect()))},empty:function(){return this.body.rows.length&&this.selectNone(),this.previous()},enableSelect:function(){return this.selectEnabled=!0,this.attachSelects(),this.element.addClass(this.options.classSelectable),this},disableSelect:function(){return this.selectEnabled=!1,this.attachSelects(!1),this.element.removeClass(this.options.classSelectable),this},push:function(){var t=this.previous.apply(this,arguments);return this.updateSelects(),t},toggleRow:function(t){return this[(this.isSelected(t)?"de":"")+"selectRow"](t)},selectRow:function(t,e){return this.isSelected(t)||!e&&!this.body.getChildren().contains(t)?void 0:(this.options.allowMultiSelect||this.selectNone(),this.isSelected(t)||(this.selectedRows.push(t),t.addClass(this.options.classRowSelected),this.fireEvent("rowFocus",[t,this.selectedRows]),this.fireEvent("stateChanged")),this.focused=t,document.clearSelection(),this)},isSelected:function(t){return this.selectedRows.contains(t)},getSelected:function(){return this.selectedRows},serialize:function(){var t=this.previous.apply(this,arguments)||{};return this.options.selectable&&(t.selectedRows=this.selectedRows.map(function(t){return Array.indexOf(this.body.rows,t)}.bind(this))),t},restore:function(t){this.options.selectable&&t.selectedRows&&t.selectedRows.each(function(t){this.selectRow(this.body.rows[t])}.bind(this)),this.previous.apply(this,arguments)},deselectRow:function(t,e){return this.isSelected(t)&&(e||this.body.getChildren().contains(t))?(this.selectedRows=new Elements(Array.convert(this.selectedRows).erase(t)),t.removeClass(this.options.classRowSelected),this.fireEvent("rowUnfocus",[t,this.selectedRows]),this.fireEvent("stateChanged"),this):void 0},selectAll:function(t){return t||this.options.allowMultiSelect?(this.selectRange(0,this.body.rows.length,t),this):void 0},selectNone:function(){return this.selectAll(!0)},selectRange:function(t,e,i){if(this.options.allowMultiSelect||i){var n=i?"deselectRow":"selectRow",s=Array.clone(this.body.rows);if("element"==typeOf(t)&&(t=s.indexOf(t)),"element"==typeOf(e)&&(e=s.indexOf(e)),e=e<s.length-1?e:s.length-1,t>e){var r=t;t=e,e=r}for(var o=t;e>=o;o++)(this.options.selectHiddenRows||s[o].isDisplayed())&&this[n](s[o],!0);return this}},deselectRange:function(t,e){this.selectRange(t,e,!0)},enterRow:function(t){this.hovered&&(this.hovered=this.leaveRow(this.hovered)),this.hovered=t.addClass(this.options.classRowHovered)},leaveRow:function(t){t.removeClass(this.options.classRowHovered)},updateSelects:function(){Array.each(this.body.rows,function(t){var e=t.retrieve("binders");(e||this.selectEnabled)&&(e||(e={mouseenter:this.enterRow.pass([t],this),mouseleave:this.leaveRow.pass([t],this)},t.store("binders",e)),this.selectEnabled?t.addEvents(e):t.removeEvents(e))},this)},shiftFocus:function(t,e){if(!this.focused)return this.selectRow(this.body.rows[0],e);var i=this.getRowByOffset(t,this.options.selectHiddenRows);return null===i||this.focused==this.body.rows[i]?this:void this.toggleRow(this.body.rows[i],e)},clickRow:function(t,e){var i=(t.shift||t.meta||t.control)&&this.options.shiftForMultiSelect;i||t.rightClick&&this.isSelected(e)&&this.options.allowMultiSelect||this.selectNone(),t.rightClick?this.selectRow(e):this.toggleRow(e),t.shift&&(this.selectRange(this.rangeStart||this.body.rows[0],e,this.rangeStart?!this.isSelected(e):!0),this.focused=e),this.rangeStart=e},getRowByOffset:function(t,e){if(!this.focused)return 0;var i=Array.indexOf(this.body.rows,this.focused);if(0==i&&0>t||i==this.body.rows.length-1&&t>0)return null;if(e)i+=t;else{var n=0;if(t>0)for(;t>n&&i<this.body.rows.length-1;)this.body.rows[++i].isDisplayed()&&n++;else for(;n>t&&i>0;)this.body.rows[--i].isDisplayed()&&n--}return i},attachSelects:function(t){t=null!=t?t:!0;var e=t?"addEvents":"removeEvents";if(this.element[e]({mouseleave:this.bound.mouseleave,click:this.bound.activateKeyboard}),this.body[e]({"click:relay(tr)":this.bound.clickRow,"contextmenu:relay(tr)":this.bound.clickRow}),this.options.useKeyboard||this.keyboard){if(this.keyboard||(this.keyboard=new Keyboard),!this.selectKeysDefined){this.selectKeysDefined=!0;var i,n,s=function(t){var e=function(s){clearTimeout(i),s.preventDefault();var r=this.body.rows[this.getRowByOffset(t,this.options.selectHiddenRows)];s.shift&&r&&this.isSelected(r)?(this.deselectRow(this.focused),this.focused=r):(!r||this.options.allowMultiSelect&&s.shift||this.selectNone(),this.shiftFocus(t,s)),i=n?e.delay(100,this,s):function(){n=!0,e(s)}.delay(400)}.bind(this);return e}.bind(this),r=function(){clearTimeout(i),n=!1};this.keyboard.addEvents({"keydown:shift+up":s(-1),"keydown:shift+down":s(1),"keyup:shift+up":r,"keyup:shift+down":r,"keyup:up":r,"keyup:down":r});var o="";this.options.allowMultiSelect&&this.options.shiftForMultiSelect&&this.options.useKeyboard&&(o=" (Shift multi-selects)."),this.keyboard.addShortcuts({"Select Previous Row":{keys:"up",shortcut:"up arrow",handler:s(-1),description:"Select the previous row in the table."+o},"Select Next Row":{keys:"down",shortcut:"down arrow",handler:s(1),description:"Select the next row in the table."+o}})}this.keyboard[t?"activate":"deactivate"]()}this.updateSelects()},mouseleave:function(){this.hovered&&this.leaveRow(this.hovered)}}),function(){var t=document.createElement("table");try{t.innerHTML="<tr><td></td></tr>",t=0===t.childNodes.length}catch(e){t=!0}HtmlTable=Class.refactor(HtmlTable,{options:{sortIndex:0,sortReverse:!1,parsers:[],defaultParser:"string",classSortable:"table-sortable",classHeadSort:"table-th-sort",classHeadSortRev:"table-th-sort-rev",classNoSort:"table-th-nosort",classGroupHead:"table-tr-group-head",classGroup:"table-tr-group",classCellSort:"table-td-sort",classSortSpan:"table-th-sort-span",sortable:!1,thSelector:"th"},initialize:function(){return this.previous.apply(this,arguments),this.occluded?this.occluded:(this.sorted={index:null,dir:1},this.bound||(this.bound={}),this.bound.headClick=this.headClick.bind(this),this.sortSpans=new Elements,void(this.options.sortable&&(this.enableSort(),null!=this.options.sortIndex&&this.sort(this.options.sortIndex,this.options.sortReverse))))},attachSorts:function(t){this.detachSorts(),t!==!1&&this.element.addEvent("click:relay("+this.options.thSelector+")",this.bound.headClick)},detachSorts:function(){this.element.removeEvents("click:relay("+this.options.thSelector+")")},setHeaders:function(){this.previous.apply(this,arguments),this.sortable&&this.setParsers()},setParsers:function(){this.parsers=this.detectParsers()},detectParsers:function(){return this.head&&this.head.getElements(this.options.thSelector).flatten().map(this.detectParser,this)},detectParser:function(t,e){if(t.hasClass(this.options.classNoSort)||t.retrieve("htmltable-parser"))return t.retrieve("htmltable-parser");var i=new Element("div");i.adopt(t.childNodes).inject(t);var n=new Element("span",{"class":this.options.classSortSpan}).inject(i,"top");this.sortSpans.push(n);var s,r=this.options.parsers[e],o=this.body.rows;switch(typeOf(r)){case"function":r={convert:r},s=!0;break;case"string":r=r,s=!0}return s||HtmlTable.ParserPriority.some(function(t){var i=HtmlTable.Parsers[t],n=i.match;if(!n)return!1;for(var s=0,a=o.length;a>s;s++){var h=document.id(o[s].cells[e]),l=h?h.get("html").clean():"";if(l&&n.test(l))return r=i,!0}}),r||(r=this.options.defaultParser),t.store("htmltable-parser",r),r},headClick:function(t,e){return this.head&&!e.hasClass(this.options.classNoSort)?this.sort(Array.indexOf(this.head.getElements(this.options.thSelector).flatten(),e)%this.body.rows[0].cells.length):void 0},serialize:function(){var t=this.previous.apply(this,arguments)||{};return this.options.sortable&&(t.sortIndex=this.sorted.index,t.sortReverse=this.sorted.reverse),t},restore:function(t){this.options.sortable&&t.sortIndex&&this.sort(t.sortIndex,t.sortReverse),this.previous.apply(this,arguments)},setSortedState:function(t,e){null!=e?this.sorted.reverse=e:this.sorted.index==t?this.sorted.reverse=!this.sorted.reverse:this.sorted.reverse=null==this.sorted.index,null!=t&&(this.sorted.index=t)},setHeadSort:function(t){var e=$$(this.head.length?this.head.map(function(t){return t.getElements(this.options.thSelector)[this.sorted.index]},this).clean():this.head.cells[this.sorted.index]);e.length&&(t?(e.addClass(this.options.classHeadSort),this.sorted.reverse?e.addClass(this.options.classHeadSortRev):e.removeClass(this.options.classHeadSortRev)):e.removeClass(this.options.classHeadSort).removeClass(this.options.classHeadSortRev))},setRowSort:function(t,e){for(var i,n,s=t.length,r=this.body;s;){var o=t[--s],a=o.position,h=r.rows[a];if(!h.disabled)for(e||(i=this.setGroupSort(i,h,o),this.setRowStyle(h,s)),r.appendChild(h),n=0;s>n;n++)t[n].position>a&&t[n].position--}},setRowStyle:function(t,e){this.previous(t,e),t.cells[this.sorted.index].addClass(this.options.classCellSort)},setGroupSort:function(t,e,i){return t==i.value?e.removeClass(this.options.classGroupHead).addClass(this.options.classGroup):e.removeClass(this.options.classGroup).addClass(this.options.classGroupHead),i.value},getParser:function(){var t=this.parsers[this.sorted.index];return"string"==typeOf(t)?HtmlTable.Parsers[t]:t},sort:function(e,i,n,s){if(this.head){n||(this.clearSort(),this.setSortedState(e,i),this.setHeadSort(!0));var r=this.getParser();if(r){var o;t||(o=this.body.getParent(),this.body.dispose());var a=this.parseData(r).sort(s?s:function(t,e){return t.value===e.value?0:t.value>e.value?1:-1}),h=this.sorted.reverse==(r==HtmlTable.Parsers["input-checked"]);return h&&a.reverse(!0),this.setRowSort(a,n),o&&o.grab(this.body),this.fireEvent("stateChanged"),this.fireEvent("sort",[this.body,this.sorted.index,h?"asc":"desc"])}}},parseData:function(t){return Array.map(this.body.rows,function(e,i){var n=t.convert.call(document.id(e.cells[this.sorted.index]));return{position:i,value:n}},this)},clearSort:function(){this.setHeadSort(!1),this.body.getElements("td").removeClass(this.options.classCellSort)},reSort:function(){return this.sortable&&this.sort.call(this,this.sorted.index,this.sorted.reverse),this},enableSort:function(){return this.element.addClass(this.options.classSortable),this.attachSorts(!0),this.setParsers(),this.sortable=!0,this},disableSort:function(){return this.element.removeClass(this.options.classSortable),this.attachSorts(!1),this.sortSpans.each(function(t){t.destroy()}),this.sortSpans.empty(),this.sortable=!1,this}}),HtmlTable.ParserPriority=["date","input-checked","input-value","float","number"],HtmlTable.Parsers={date:{match:/^\d{2}[-\/ ]\d{2}[-\/ ]\d{2,4}$/,convert:function(){var t=Date.parse(this.get("text").stripTags());return"date"==typeOf(t)?t.format("db"):""},type:"date"},"input-checked":{match:/ type="(radio|checkbox)"/,convert:function(){return this.getElement("input").checked}},"input-value":{match:/<input/,convert:function(){return this.getElement("input").value}},number:{match:/^\d+[^\d.,]*$/,convert:function(){return this.get("text").stripTags().toInt()},number:!0},numberLax:{match:/^[^\d]+\d+$/,convert:function(){return this.get("text").replace(/[^-?^0-9]/,"").stripTags().toInt()},number:!0},"float":{match:/^[\d]+\.[\d]+/,convert:function(){return this.get("text").replace(/[^-?^\d.e]/,"").stripTags().toFloat()},number:!0},floatLax:{match:/^[^\d]+[\d]+\.[\d]+$/,convert:function(){return this.get("text").replace(/[^-?^\d.]/,"").stripTags().toFloat()},number:!0},string:{match:null,convert:function(){return this.get("text").stripTags().toLowerCase()}},title:{match:null,convert:function(){return this.title}}},HtmlTable.defineParsers=function(t){HtmlTable.Parsers=Object.append(HtmlTable.Parsers,t);for(var e in t)HtmlTable.ParserPriority.unshift(e)}}(),HtmlTable=Class.refactor(HtmlTable,{options:{classZebra:"table-tr-odd",zebra:!0,zebraOnlyVisibleRows:!0},initialize:function(){return this.previous.apply(this,arguments),this.occluded?this.occluded:void(this.options.zebra&&this.updateZebras())},updateZebras:function(){var t=0;Array.each(this.body.rows,function(e){(!this.options.zebraOnlyVisibleRows||e.isDisplayed())&&this.zebra(e,t++)},this)},setRowStyle:function(t,e){this.previous&&this.previous(t,e),this.zebra(t,e)},zebra:function(t,e){return t[(e%2?"remove":"add")+"Class"](this.options.classZebra)},push:function(){var t=this.previous.apply(this,arguments);return this.options.zebra&&this.updateZebras(),t}}),function(){this.Scroller=new Class({Implements:[Events,Options],options:{area:20,velocity:1,onChange:function(t,e){this.element.scrollTo(t,e)},fps:50},initialize:function(t,e){this.setOptions(e),this.element=document.id(t),this.docBody=document.id(this.element.getDocument().body),this.listener="element"!=typeOf(this.element)?this.docBody:this.element,this.timer=null,this.bound={attach:this.attach.bind(this),detach:this.detach.bind(this),getCoords:this.getCoords.bind(this)}},start:function(){return this.listener.addEvents({mouseover:this.bound.attach,mouseleave:this.bound.detach}),this},stop:function(){return this.listener.removeEvents({mouseover:this.bound.attach,mouseleave:this.bound.detach}),this.detach(),this.timer=clearInterval(this.timer),this},attach:function(){this.listener.addEvent("mousemove",this.bound.getCoords)},detach:function(){this.listener.removeEvent("mousemove",this.bound.getCoords),this.timer=clearInterval(this.timer)},getCoords:function(t){this.page="body"==this.listener.get("tag")?t.client:t.page,this.timer||(this.timer=this.scroll.periodical(Math.round(1e3/this.options.fps),this))},scroll:function(){var t=this.element.getSize(),e=this.element.getScroll(),i=this.element!=this.docBody&&this.element!=window?this.element.getOffsets():{x:0,y:0},n=this.element.getScrollSize(),s={x:0,y:0},r=this.options.area.top||this.options.area,o=this.options.area.bottom||this.options.area;for(var a in this.page)this.page[a]<r+i[a]&&0!=e[a]?s[a]=(this.page[a]-r-i[a])*this.options.velocity:this.page[a]+o>t[a]+i[a]&&e[a]+t[a]!=n[a]&&(s[a]=(this.page[a]-t[a]+o-i[a])*this.options.velocity),s[a]=s[a].round();(s.y||s.x)&&this.fireEvent("change",[e.x+s.x,e.y+s.y])}})}(),Locale.define("en-GB","Date",{dateOrder:["date","month","year"],shortDate:"%d/%m/%Y",shortTime:"%H:%M"}).inherit("en-US","Date"),Locale.define("en-US","Number",{decimal:".",group:",",currency:{prefix:"$ "}}),Request.JSONP=new Class({Implements:[Chain,Events,Options],options:{onRequest:function(t){this.options.log&&window.console&&console.log&&console.log("JSONP retrieving script with url:"+t)},onError:function(t){this.options.log&&window.console&&console.warn&&console.warn("JSONP "+t+" will fail in Internet Explorer, which enforces a 2083 bytes length limit on URIs")},url:"",callbackKey:"callback",injectScript:document.head,data:"",link:"ignore",timeout:0,log:!1},initialize:function(t){this.setOptions(t)},send:function(t){if(!Request.prototype.check.call(this,t))return this;this.running=!0;var e=typeOf(t);("string"==e||"element"==e)&&(t={data:t}),t=Object.merge(this.options,t||{});var i=t.data;switch(typeOf(i)){case"element":i=document.id(i).toQueryString();break;case"object":case"hash":i=Object.toQueryString(i)}var n=this.index=Request.JSONP.counter++,s="request_"+n,r=t.url+(t.url.test("\\?")?"&":"?")+t.callbackKey+"=Request.JSONP.request_map.request_"+n+(i?"&"+i:"");r.length>2083&&this.fireEvent("error",r),Request.JSONP.request_map[s]=function(){delete Request.JSONP.request_map[s],this.success(arguments,n)}.bind(this);var o=this.getScript(r).inject(t.injectScript);return this.fireEvent("request",[r,o]),t.timeout&&this.timeout.delay(t.timeout,this),this},getScript:function(t){return this.script||(this.script=new Element("script",{type:"text/javascript",async:!0,src:t})),this.script},success:function(t){this.running&&this.clear().fireEvent("complete",t).fireEvent("success",t).callChain()},cancel:function(){return this.running&&this.clear().fireEvent("cancel"),this},isRunning:function(){return!!this.running},clear:function(){return this.running=!1,this.script&&(this.script.destroy(),this.script=null),this},timeout:function(){return this.running&&(this.running=!1,this.fireEvent("timeout",[this.script.get("src"),this.script]).fireEvent("failure").cancel()),this}}),Request.JSONP.counter=0,Request.JSONP.request_map={},Request.implement({options:{initialDelay:5e3,delay:5e3,limit:6e4},startTimer:function(t){var e=function(){this.running||this.send({data:t})};return this.lastDelay=this.options.initialDelay,this.timer=e.delay(this.lastDelay,this),this.completeCheck=function(t){clearTimeout(this.timer),this.lastDelay=t?this.options.delay:(this.lastDelay+this.options.delay).min(this.options.limit),this.timer=e.delay(this.lastDelay,this)},this.addEvent("complete",this.completeCheck)},stopTimer:function(){return clearTimeout(this.timer),this.removeEvent("complete",this.completeCheck)}}),Request.Queue=new Class({Implements:[Options,Events],Binds:["attach","request","complete","cancel","success","failure","exception"],options:{stopOnFailure:!0,autoAdvance:!0,concurrent:1,requests:{}},initialize:function(t){var e;t&&(e=t.requests,delete t.requests),this.setOptions(t),this.requests={},this.queue=[],this.reqBinders={},e&&this.addRequests(e)},addRequest:function(t,e){return this.requests[t]=e,this.attach(t,e),this},addRequests:function(t){return Object.each(t,function(t,e){this.addRequest(e,t)},this),this},getName:function(t){return Object.keyOf(this.requests,t)},attach:function(t,e){return e._groupSend?this:(["request","complete","cancel","success","failure","exception"].each(function(i){this.reqBinders[t]||(this.reqBinders[t]={}),this.reqBinders[t][i]=function(){this["on"+i.capitalize()].apply(this,[t,e].append(arguments))}.bind(this),e.addEvent(i,this.reqBinders[t][i])},this),e._groupSend=e.send,e.send=function(i){return this.send(t,i),e}.bind(this),this)},removeRequest:function(t){var e="object"==typeOf(t)?this.getName(t):t;return(e||"string"==typeOf(e))&&(t=this.requests[e])?(["request","complete","cancel","success","failure","exception"].each(function(i){t.removeEvent(i,this.reqBinders[e][i])},this),t.send=t._groupSend,delete t._groupSend,this):this},getRunning:function(){return Object.filter(this.requests,function(t){return t.running})},isRunning:function(){return!!Object.keys(this.getRunning()).length},send:function(t,e){var i=function(){this.requests[t]._groupSend(e),this.queue.erase(i)}.bind(this);return i.name=t,Object.keys(this.getRunning()).length>=this.options.concurrent||this.error&&this.options.stopOnFailure?this.queue.push(i):i(),this},hasNext:function(t){return t?!!this.queue.filter(function(e){return e.name==t}).length:!!this.queue.length},resume:function(){return this.error=!1,(this.options.concurrent-Object.keys(this.getRunning()).length).times(this.runNext,this),this},runNext:function(t){if(!this.queue.length)return this;if(t){var e;this.queue.each(function(i){e||i.name!=t||(e=!0,i())})}else this.queue[0]();return this},runAll:function(){return this.queue.each(function(t){t()}),this},clear:function(t){return t?this.queue=this.queue.map(function(e){return e.name!=t?e:!1}).filter(function(t){return t}):this.queue.empty(),this},cancel:function(t){return this.requests[t].cancel(),this},onRequest:function(){this.fireEvent("request",arguments)},onComplete:function(){this.fireEvent("complete",arguments),this.queue.length||this.fireEvent("end")},onCancel:function(){this.options.autoAdvance&&!this.error&&this.runNext(),this.fireEvent("cancel",arguments)},onSuccess:function(){this.options.autoAdvance&&!this.error&&this.runNext(),this.fireEvent("success",arguments)},onFailure:function(){this.error=!0,!this.options.stopOnFailure&&this.options.autoAdvance&&this.runNext(),this.fireEvent("failure",arguments)},onException:function(){this.error=!0,!this.options.stopOnFailure&&this.options.autoAdvance&&this.runNext(),this.fireEvent("exception",arguments)}}),function(t){Array.implement({min:function(){return Math.min.apply(null,this)},max:function(){return Math.max.apply(null,this)},average:function(){return this.length?this.sum()/this.length:0},sum:function(){var t=0,e=this.length;if(e)for(;e--;)null!=this[e]&&(t+=parseFloat(this[e]));return t},unique:function(){return[].combine(this)},shuffle:function(){for(var t=this.length;t&&--t;){var e=this[t],i=Math.floor(Math.random()*(t+1));this[t]=this[i],this[i]=e}return this},reduce:function(e,i){for(var n=0,s=this.length;s>n;n++)n in this&&(i=i===t?this[n]:e.call(null,i,this[n],n,this));return i},reduceRight:function(e,i){for(var n=this.length;n--;)n in this&&(i=i===t?this[n]:e.call(null,i,this[n],n,this));return i},pluck:function(t){return this.map(function(e){return e[t]})}})}(),Date.implement({timeDiffInWords:function(t){return Date.distanceOfTimeInWords(this,t||new Date)},timeDiff:function(t,e){null==t&&(t=new Date);for(var i,n,s=((t-this)/1e3).floor().abs(),r=[],o=[60,60,24,365,0],a=["s","m","h","d","y"],h=0;h<o.length&&(!h||s);h++)i=s,(n=o[h])&&(i=s%n,s=(s/n).floor()),r.unshift(i+(a[h]||""));return r.join(e||":")}}).extend({distanceOfTimeInWords:function(t,e){return Date.getTimePhrase(((e-t)/1e3).toInt())},getTimePhrase:function(t){var e=0>t?"Until":"Ago";0>t&&(t*=-1);var i={minute:60,hour:60,day:24,week:7,month:52/12,year:12,eon:1/0},n="lessThanMinute";for(var s in i){var r=i[s];if(1.5*r>t){t>.75*r&&(n=s);break}t/=r,n=s+"s"}return t=t.round(),Date.getMsg(n+e,t).substitute({delta:t})}}).defineParsers({re:/^(?:tod|tom|yes)/i,handler:function(t){var e=(new Date).clearTime();switch(t[0]){case"tom":return e.increment();case"yes":return e.decrement();default:return e}}},{re:/^(next|last) ([a-z]+)$/i,handler:function(t){var e=(new Date).clearTime(),i=e.getDay(),n=Date.parseDay(t[2],!0),s=n-i;return i>=n&&(s+=7),"last"==t[1]&&(s-=7),e.set("date",e.getDate()+s)}}).alias("timeAgoInWords","timeDiffInWords"),function(){if(!this.Hash){var t=this.Hash=new Type("Hash",function(t){"hash"==typeOf(t)&&(t=Object.clone(t.getClean()));for(var e in t)this[e]=t[e];return this});this.$H=function(e){return new t(e)},t.implement({forEach:function(t,e){Object.forEach(this,t,e)},getClean:function(){var t={};for(var e in this)this.hasOwnProperty(e)&&(t[e]=this[e]);return t},getLength:function(){var t=0;for(var e in this)this.hasOwnProperty(e)&&t++;return t}}),t.alias("each","forEach"),t.implement({has:Object.prototype.hasOwnProperty,keyOf:function(t){return Object.keyOf(this,t)},hasValue:function(t){return Object.contains(this,t)},extend:function(e){return t.each(e||{},function(e,i){t.set(this,i,e)},this),this},combine:function(e){return t.each(e||{},function(e,i){t.include(this,i,e)},this),this},erase:function(t){return this.hasOwnProperty(t)&&delete this[t],this},get:function(t){return this.hasOwnProperty(t)?this[t]:null},set:function(t,e){return(!this[t]||this.hasOwnProperty(t))&&(this[t]=e),this},empty:function(){return t.each(this,function(t,e){delete this[e]},this),this},include:function(t,e){return void 0==this[t]&&(this[t]=e),this},map:function(e,i){return new t(Object.map(this,e,i))},filter:function(e,i){return new t(Object.filter(this,e,i))},every:function(t,e){return Object.every(this,t,e)},some:function(t,e){return Object.some(this,t,e)},getKeys:function(){return Object.keys(this)},getValues:function(){return Object.values(this)},toQueryString:function(t){return Object.toQueryString(this,t)}}),t.alias({indexOf:"keyOf",contains:"hasValue"})}}(),Hash.implement({getFromPath:function(t){return Object.getFromPath(this,t)},cleanValues:function(t){return new Hash(Object.cleanValues(this,t))},run:function(){Object.run(arguments)}}),Number.implement({format:function(t){var e=this;t=t?Object.clone(t):{};var i=function(e){return null!=t[e]?t[e]:Locale.get("Number."+e)},n=0>e,s=i("decimal"),r=i("precision"),o=i("group"),a=i("decimals");if(n){var h=i("negative")||{};null==h.prefix&&null==h.suffix&&(h.prefix="-"),["prefix","suffix"].each(function(e){h[e]&&(t[e]=i(e)+h[e])}),e=-e}var l=i("prefix"),u=i("suffix");""!==a&&a>=0&&20>=a&&(e=e.toFixed(a)),r>=1&&21>=r&&(e=(+e).toPrecision(r)),e+="";var c;if(i("scientific")===!1&&e.indexOf("e")>-1){var d=e.split("e"),f=+d[1];if(e=d[0].replace(".",""),0>f){for(f=-f-1,c=d[0].indexOf("."),c>-1&&(f-=c-1);f--;)e="0"+e;e="0."+e}else for(c=d[0].lastIndexOf("."),c>-1&&(f-=d[0].length-c-1);f--;)e+="0"}if("."!=s&&(e=e.replace(".",s)),o){c=e.lastIndexOf(s),c=c>-1?c:e.length;for(var p=e.substring(c),m=c;m--;)(c-m-1)%3==0&&m!=c-1&&(p=o+p),p=e.charAt(m)+p;e=p}return l&&(e=l+e),u&&(e+=u),e},formatCurrency:function(t){var e=Locale.get("Number.currency")||{};return null==e.scientific&&(e.scientific=!1),e.decimals=null!=t?t:null==e.decimals?2:e.decimals,this.format(e)},formatPercentage:function(t){var e=Locale.get("Number.percentage")||{};return null==e.suffix&&(e.suffix="%"),e.decimals=null!=t?t:null==e.decimals?2:e.decimals,this.format(e)}}),function(){var t=function(){return this.get("value")},e=this.URI=new Class({Implements:Options,options:{},regex:/^(?:(\w+):)?(?:\/\/(?:(?:([^:@\/]*):?([^:@\/]*))?@)?(\[[A-Fa-f0-9:]+\]|[^:\/?#]*)(?::(\d*))?)?(\.\.?$|(?:[^?#\/]*\/)*)([^?#]*)(?:\?([^#]*))?(?:#(.*))?/,
parts:["scheme","user","password","host","port","directory","file","query","fragment"],schemes:{http:80,https:443,ftp:21,rtsp:554,mms:1755,file:0},initialize:function(t,i){this.setOptions(i);var n=this.options.base||e.base;t||(t=n),t&&t.parsed?this.parsed=Object.clone(t.parsed):this.set("value",t.href||t.toString(),n?new e(n):!1)},parse:function(t,e){var i=t.match(this.regex);return i?(i.shift(),this.merge(i.associate(this.parts),e)):!1},merge:function(t,e){return t&&t.scheme||e&&e.scheme?(e&&this.parts.every(function(i){return t[i]?!1:(t[i]=e[i]||"",!0)}),t.port=t.port||this.schemes[t.scheme.toLowerCase()],t.directory=t.directory?this.parseDirectory(t.directory,e?e.directory:""):"/",t):!1},parseDirectory:function(t,i){if(t=("/"==t.substr(0,1)?"":i||"/")+t,!t.test(e.regs.directoryDot))return t;var n=[];return t.replace(e.regs.endSlash,"").split("/").each(function(t){".."==t&&n.length>0?n.pop():"."!=t&&n.push(t)}),n.join("/")+"/"},combine:function(t){return t.value||t.scheme+"://"+(t.user?t.user+(t.password?":"+t.password:"")+"@":"")+(t.host||"")+(t.port&&t.port!=this.schemes[t.scheme]?":"+t.port:"")+(t.directory||"/")+(t.file||"")+(t.query?"?"+t.query:"")+(t.fragment?"#"+t.fragment:"")},set:function(t,i,n){if("value"==t){var s=i.match(e.regs.scheme);s&&(s=s[1]),s&&null==this.schemes[s.toLowerCase()]?this.parsed={scheme:s,value:i}:this.parsed=this.parse(i,(n||this).parsed)||(s?{scheme:s,value:i}:{value:i})}else"data"==t?this.setData(i):this.parsed[t]=i;return this},get:function(t,e){switch(t){case"value":return this.combine(this.parsed,e?e.parsed:!1);case"data":return this.getData()}return this.parsed[t]||""},go:function(){document.location.href=this.toString()},toURI:function(){return this},getData:function(t,e){var i=this.get(e||"query");if(!i&&0!==i)return t?null:{};var n=i.parseQueryString();return t?n[t]:n},setData:function(t,e,i){if("string"==typeof t){var n=this.getData();n[arguments[0]]=arguments[1],t=n}else e&&(t=Object.merge(this.getData(null,i),t));return this.set(i||"query",Object.toQueryString(t))},clearData:function(t){return this.set(t||"query","")},toString:t,valueOf:t});e.regs={endSlash:/\/$/,scheme:/^(\w+):/,directoryDot:/\.\/|\.$/},e.base=new e(Array.convert(document.getElements("base[href]",!0)).getLast(),{base:document.location}),String.implement({toURI:function(t){return new e(this,t)}})}(),URI=Class.refactor(URI,{combine:function(t,e){if(!e||t.scheme!=e.scheme||t.host!=e.host||t.port!=e.port)return this.previous.apply(this,arguments);var i=t.file+(t.query?"?"+t.query:"")+(t.fragment?"#"+t.fragment:"");if(!e.directory)return(t.directory||(t.file?"":"./"))+i;var n,s=e.directory.split("/"),r=t.directory.split("/"),o="",a=0;for(n=0;n<s.length&&n<r.length&&s[n]==r[n];n++);for(a=0;a<s.length-n-1;a++)o+="../";for(a=n;a<r.length-1;a++)o+=r[a]+"/";return(o||(t.file?"":"./"))+i},toAbsolute:function(t){return t=new URI(t),t&&t.set("directory","").set("file",""),this.toRelative(t)},toRelative:function(t){return this.get("value",new URI(t))}}),function(){var t=this.Asset={javascript:function(t,e){e||(e={});var i=new Element("script",{src:t,type:"text/javascript"}),n=e.document||document,s=e.onload||e.onLoad;return delete e.onload,delete e.onLoad,delete e.document,s&&(i.addEventListener?i.addEvent("load",s):i.addEvent("readystatechange",function(){["loaded","complete"].contains(this.readyState)&&s.call(this)})),i.set(e).inject(n.head)},css:function(t,e){e||(e={});var i=e.onload||e.onLoad,n=e.document||document,s=e.timeout||3e3;["onload","onLoad","document"].each(function(t){delete e[t]});var r=new Element("link",{type:"text/css",rel:"stylesheet",media:"screen",href:t}).setProperties(e).inject(n.head);if(i){var o=!1,a=0,h=function(){for(var t=document.styleSheets,e=0;e<t.length;e++){var n=t[e],l=n.ownerNode?n.ownerNode:n.owningElement;if(l&&l==r)return o=!0,i.call(r)}return a++,!o&&s/50>a?setTimeout(h,50):void 0};setTimeout(h,0)}return r},image:function(t,e){e||(e={});var i=new Image,n=document.id(i)||new Element("img");return["load","abort","error"].each(function(t){var s="on"+t,r="on"+t.capitalize(),o=e[s]||e[r]||function(){};delete e[r],delete e[s],i[s]=function(){i&&(n.parentNode||(n.width=i.width,n.height=i.height),i=i.onload=i.onabort=i.onerror=null,o.delay(1,n,n),n.fireEvent(t,n,1))}}),i.src=n.src=t,i&&i.complete&&i.onload.delay(1),n.set(e)},images:function(e,i){e=Array.convert(e);var n=function(){},s=0;return i=Object.merge({onComplete:n,onProgress:n,onError:n,properties:{}},i),new Elements(e.map(function(n,r){return t.image(n,Object.append(i.properties,{onload:function(){s++,i.onProgress.call(this,s,r,n),s==e.length&&i.onComplete()},onerror:function(){s++,i.onError.call(this,s,r,n),s==e.length&&i.onComplete()}}))}))}}}(),function(){var t=this.Color=new Type("Color",function(t,e){switch(arguments.length>=3?(e="rgb",t=Array.slice(arguments,0,3)):"string"==typeof t&&(t=t.match(/rgb/)?t.rgbToHex().hexToRgb(!0):t.match(/hsb/)?t.hsbToRgb():t.hexToRgb(!0)),e=e||"rgb"){case"hsb":var i=t;t=t.hsbToRgb(),t.hsb=i;break;case"hex":t=t.hexToRgb(!0)}return t.rgb=t.slice(0,3),t.hsb=t.hsb||t.rgbToHsb(),t.hex=t.rgbToHex(),Object.append(t,this)});t.implement({mix:function(){var e=Array.slice(arguments),i="number"==typeOf(e.getLast())?e.pop():50,n=this.slice();return e.each(function(e){e=new t(e);for(var s=0;3>s;s++)n[s]=Math.round(n[s]/100*(100-i)+e[s]/100*i)}),new t(n,"rgb")},invert:function(){return new t(this.map(function(t){return 255-t}))},setHue:function(e){return new t([e,this.hsb[1],this.hsb[2]],"hsb")},setSaturation:function(e){return new t([this.hsb[0],e,this.hsb[2]],"hsb")},setBrightness:function(e){return new t([this.hsb[0],this.hsb[1],e],"hsb")}}),this.$RGB=function(e,i,n){return new t([e,i,n],"rgb")},this.$HSB=function(e,i,n){return new t([e,i,n],"hsb")},this.$HEX=function(e){return new t(e,"hex")},Array.implement({rgbToHsb:function(){var t=this[0],e=this[1],i=this[2],n=0,s=Math.max(t,e,i),r=Math.min(t,e,i),o=s-r,a=s/255,h=0!=s?o/s:0;if(0!=h){var l=(s-t)/o,u=(s-e)/o,c=(s-i)/o;n=t==s?c-u:e==s?2+l-c:4+u-l,n/=6,0>n&&n++}return[Math.round(360*n),Math.round(100*h),Math.round(100*a)]},hsbToRgb:function(){var t=Math.round(this[2]/100*255);if(0==this[1])return[t,t,t];var e=this[0]%360,i=e%60,n=Math.round(this[2]*(100-this[1])/1e4*255),s=Math.round(this[2]*(6e3-this[1]*i)/6e5*255),r=Math.round(this[2]*(6e3-this[1]*(60-i))/6e5*255);switch(Math.floor(e/60)){case 0:return[t,r,n];case 1:return[s,t,n];case 2:return[n,t,r];case 3:return[n,s,t];case 4:return[r,n,t];case 5:return[t,n,s]}return!1}}),String.implement({rgbToHsb:function(){var t=this.match(/\d{1,3}/g);return t?t.rgbToHsb():null},hsbToRgb:function(){var t=this.match(/\d{1,3}/g);return t?t.hsbToRgb():null}})}(),function(){this.Group=new Class({initialize:function(){this.instances=Array.flatten(arguments)},addEvent:function(t,e){var i=this.instances,n=i.length,s=n,r=new Array(n),o=this;i.each(function(a,h){a.addEvent(t,function(){r[h]||s--,r[h]=arguments,s||(e.call(o,i,a,r),s=n,r=new Array(n))})})}})}(),Hash.Cookie=new Class({Extends:Cookie,options:{autoSave:!0},initialize:function(t,e){this.parent(t,e),this.load()},save:function(){var t=JSON.encode(this.hash);return!t||t.length>4096?!1:("{}"==t?this.dispose():this.write(t),!0)},load:function(){return this.hash=new Hash(JSON.decode(this.read(),!0)),this}}),Hash.each(Hash.prototype,function(t,e){"function"==typeof t&&Hash.Cookie.implement(e,function(){var e=t.apply(this.hash,arguments);return this.options.autoSave&&this.save(),e})}),function(){var t=this.Table=function(){this.length=0;var t=[],e=[];this.set=function(i,n){var s=t.indexOf(i);if(-1==s){var r=t.length;t[r]=i,e[r]=n,this.length++}else e[s]=n;return this},this.get=function(i){var n=t.indexOf(i);return-1==n?null:e[n]},this.erase=function(i){var n=t.indexOf(i);return-1!=n?(this.length--,t.splice(n,1),e.splice(n,1)[0]):null},this.each=this.forEach=function(i,n){for(var s=0,r=this.length;r>s;s++)i.call(n,t[s],e[s],this)}};this.Type&&new Type("Table",t)}();;
/*************************************************************************************************************************/
/**                            *******************************************************************************************/
/**   UI FRAMEWORK             *******************************************************************************************/
/**                            *******************************************************************************************/
/*************************************************************************************************************************/
/**                                                                                                                     **/
/**   This script belongs to no package and is intended to be included in all docs.                                     **/
/**                                                                                                                     **/
/**   common.js: Common inline scripts and functions used in all cases and docs.                                        **/
/**   Includes overrides, prototypes and extended behaviors.                                                            **/
/**   The following code assumes MooTools Core 1.4.5 has been included.                                                 **/
/**   The following code assumes MooTools More 1.4.0.1' has been included.                                              **/
/**                                                                                                                     **/
/*************************************************************************************************************************/

if (!('Affinity' in window)) { window.Affinity = {}; }

/**   OVERRIDE MISSING CONSOLE   *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

if (typeof console === "undefined") { console = { log: function () { } }; }

/**   CHECK FOR MOOTOOLS         *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

if (typeof MooTools === "undefined") {
    throw new ReferenceError('This site requires MooTools 1.4.5 and MooTools.More 1.4.0.1');
}

/**   SET USER AGENT             *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

var doc = document.documentElement;
doc.setAttribute('data-useragent', navigator.userAgent);

/*************************************************************************************************************************/
/**                            *******************************************************************************************/
/**   MOUSE / TOUCH EVENTS     *******************************************************************************************/
/**                            *******************************************************************************************/
/*************************************************************************************************************************/
/**                                                                                                                     **/
/**   These values get overridden by values in the touch.js script which should be included in the cassette bundles     **/
/**   when a mobile (touch) device is detected. See _Layout.cshtm. See docs on page setup.                              **/
/**                                                                                                                     **/
/*************************************************************************************************************************/


//console.time('framework_init');

if (!('events' in Affinity)) { Affinity.events = {}; }
Affinity.mobile = false;
Affinity.events = {
    over: 'mouseover',
    out: 'mouseout',
    overAll: 'mouseenter',
    outAll: 'mouseleave',
    start: 'mousedown',
    move: 'mousemove',
    end: 'mouseup',
    click: 'click'
}

/*************************************************************************************************************************/
/**                            *******************************************************************************************/
/**   ICONS FROM ICON FONT     *******************************************************************************************/
/**                            *******************************************************************************************/
/*************************************************************************************************************************/


Affinity.icons = {
    AddToList: '&#xe096;',
    Air: '&#xe047;',
    Alarm: '&#xe855;',
    AlarmAdd: '&#xe856;',
    Archive: '&#xe0a2;',
    ArrowDown: '&#xe0c0;',
    ArrowDownCircle: '&#xe0c8;',
    ArrowDownSmall: '&#xe0c4;',
    ArrowLeft: '&#xe0bf;',
    ArrowLeftCircle: '&#xe0c7;',
    ArrowLeftSmall: '&#xe0c3;',
    ArrowLineBigDown: '&#xe0d8;',
    ArrowLineBigLeft: '&#xe0d7;',
    ArrowLineBigRight: '&#xe0da;',
    ArrowLineBigUp: '&#xe0d9;',
    ArrowLineDown: '&#xe0d0;',
    ArrowLineLeft: '&#xe0cf;',
    ArrowLineRight: '&#xe0d2;',
    ArrowLineSmallDown: '&#xe0d4;',
    ArrowLineSmallLeft: '&#xe0d3;',
    ArrowLineSmallRight: '&#xe0d6;',
    ArrowLineSmallUp: '&#xe0d5;',
    ArrowLineUp: '&#xe0d1;',
    ArrowLongDown: '&#xe0dc;',
    ArrowLongLeft: '&#xe0db;',
    ArrowLongRight: '&#xe0de;',
    ArrowLongUp: '&#xe0dd;',
    ArrowRight: '&#xe0c2;',
    ArrowRightCircle: '&#xe0ca;',
    ArrowRightSmall: '&#xe0c6;',
    ArrowUp: '&#xe0c1;',
    ArrowUpCircle: '&#xe0c9;',
    ArrowUpSmall: '&#xe0c5;',
    ArrowheadDown: '&#xe0cc;',
    ArrowheadLeft: '&#xe0cb;',
    ArrowheadRight: '&#xe0ce;',
    ArrowheadUp: '&#xe0cd;',
    ArrowheadUpDown: '&#xe0df;',
    Back: '&#xe093;',
    Bag: '&#xe03b;',
    Barcode: '&#xe0fc;',
    Battery: '&#xe04d;',
    Bell: '&#xe029;',
    Blocked: '&#xe084;',
    Book: '&#xe039;',
    Book2: '&#xe0ac;',
    Bookmark: '&#xe0aa;',
    Bookmarks: '&#xe0ab;',
    Box: '&#xe06a;',
    Braces: '&#xe104;',
    Briefcase: '&#xe046;',
    Brightness: '&#xe060;',
    BrogressThird: '&#xe05c;',
    Browser: '&#xe058;',
    Brush: '&#xe053;',
    Bucket: '&#xe04e;',
    BulletList: '&#xe095;',
    Calendar: '&#xe041;',
    Camera: '&#xe030;',
    Cancel: '&#xe083;',
    Car: '&#xe909;',
    Cart: '&#xe069;',
    Cc: '&#xe0e3;',
    CcBy: '&#xe0e4;',
    CcNc: '&#xe0e5;',
    CcNcEu: '&#xe0e6;',
    CcNcJp: '&#xe0e7;',
    CcNd: '&#xe0e9;',
    CcPd: '&#xe0ea;',
    CcSa: '&#xe0e8;',
    CcShare: '&#xe0ec;',
    CcShare3: '&#xe0ed;',
    CcZero: '&#xe0eb;',
    Ccw: '&#xe08c;',
    Cd: '&#xe045;',
    Chat: '&#xe021;',
    Clipboard: '&#xe068;',
    Clock: '&#xe03f;',
    Cloud: '&#xe0a8;',
    Code: '&#xe061;',
    CodeA: '&#xe0ee;',
    CodeD: '&#xe0f0;',
    CodeH: '&#xe0ef;',
    CodeM: '&#xe10e;',
    CodeP: '&#xe10f;',
    CodeR: '&#xe0f1;',
    CodeS: '&#xe0f2;',
    Cog: '&#xe02c;',
    Comment: '&#xe022;',
    Compare: '&#xe103;',
    Compass: '&#xe016;',
    Cone: '&#xe055;',
    CreditCard: '&#xe065;',
    Cross: '&#xe07a;',
    CrossRound: '&#xe080;',
    CrossSquare: '&#xe07d;',
    Csharp: '&#xe0ff;',
    Cup: '&#xe051;',
    Cw: '&#xe08b;',
    Cycle: '&#xe08a;',
    Database: '&#xe066;',
    Directions: '&#xe005;',
    Docs: '&#xe09c;',
    DollarRound: '&#xe0fe;',
    Dot: '&#xe0e2;',
    Dots: '&#xe0e1;',
    DotsVert: '&#xe000;',
    Download: '&#xe0a5;',
    Drive: '&#xe050;',
    Droplet: '&#xe044;',
    Droplets: '&#xe06f;',
    Earth: '&#xe056;',
    Education: '&#xe038;',
    Eightball: '&#xe901;',
    Ellipsis: '&#xe0e0;',
    EmptyInbox: '&#xe00b;',
    Export: '&#xe013;',
    Extension: '&#xe87b;',
    Eye: '&#xe03e;',
    Feather: '&#xe009;',
    FieldEdit: '&#xe001;',
    FileExcel: '&#xe908;',
    FilePdf: '&#xe902;',
    FileWord: '&#xe907;',
    First: '&#xe0b3;',
    Flag: '&#xe02b;',
    Flashlight: '&#xe027;',
    FlowBranch: '&#xe0bb;',
    FlowCascade: '&#xe0ba;',
    FlowLine: '&#xe0bd;',
    FlowParallel: '&#xe0be;',
    FlowTree: '&#xe0bc;',
    Folder: '&#xe0a1;',
    Forward: '&#xe00e;',
    Gauge: '&#xe049;',
    Ghost: '&#xe0fa;',
    Gift: '&#xe105;',
    GraphBars: '&#xe073;',
    GraphLinefill: '&#xe074;',
    GraphPie: '&#xe072;',
    GraphStatistics: '&#xe071;',
    Grid: '&#xe070;',
    HeartEmpty: '&#xe01c;',
    HeartFull: '&#xe01b;',
    HelpRound: '&#xe088;',
    History: '&#xe092;',
    Hourglass: '&#xe048;',
    House: '&#xe024;',
    Incident: '&#xe548;',
    Infinity: '&#xe063;',
    Info: '&#xe085;',
    InfoRound: '&#xe086;',
    Install: '&#xe0a7;',
    Key: '&#xe04c;',
    Keyboard: '&#xe057;',
    Kiwi: '&#xe102;',
    Lab: '&#xe903;',
    Landscape: '&#xe09d;',
    Language: '&#xe04a;',
    Last: '&#xe0b4;',
    Layout: '&#xe097;',
    Leaf: '&#xe034;',
    LifeRing: '&#xe03d;',
    LightBulb: '&#xe064;',
    Lightning: '&#xe042;',
    Link: '&#xe02a;',
    List: '&#xe098;',
    Location: '&#xe014;',
    LocationArrow: '&#xe017;',
    Lock: '&#xe075;',
    LockApproved: '&#xe90c;',
    LockDeclined: '&#xe90d;',
    LockOpen: '&#xe90a;',
    LockPaid: '&#xe90e;',
    LockSubmitted: '&#xe90b;',
    Login: '&#xe078;',
    Logout: '&#xe077;',
    Loop: '&#xe091;',
    Magnet: '&#xe04f;',
    Mail: '&#xe006;',
    Map: '&#xe015;',
    Megaphone: '&#xe031;',
    Microphone: '&#xe040;',
    Minus: '&#xe081;',
    MinusRound: '&#xe07e;',
    MinusSquare: '&#xe07b;',
    Mobile: '&#xe003;',
    Moneybag: '&#xe0fd;',
    Moon: '&#xe032;',
    MoreLeft: '&#xe10a;',
    MoreRight: '&#xe10d;',
    Mouse: '&#xe004;',
    Music: '&#xe036;',
    MusicSemi: '&#xe035;',
    MusicSquare: '&#xe0a0;',
    Mute: '&#xe0b9;',
    Network: '&#xe04b;',
    New: '&#xe037;',
    Newspaper: '&#xe03a;',
    Next: '&#xe0b1;',
    Page: '&#xe099;',
    PageEmpty: '&#xe09b;',
    PageFull: '&#xe09a;',
    Palette: '&#xe033;',
    Paperclip: '&#xe00a;',
    Paperplane: '&#xe007;',
    Pause: '&#xe0ae;',
    Pencil: '&#xe008;',
    Phone: '&#xe002;',
    Pictures: '&#xe09e;',
    Pin: '&#xe904;',
    Plane: '&#xe03c;',
    Play: '&#xe0ad;',
    Plugin: '&#xe905;',
    Plus: '&#xe082;',
    PlusRound: '&#xe07f;',
    PlusSquare: '&#xe07c;',
    Poop: '&#xe101;',
    Popup: '&#xe025;',
    Previous: '&#xe0b2;',
    Printer: '&#xe028;',
    ProgressEmpty: '&#xe05d;',
    ProgressFull: '&#xe05a;',
    ProgressHalf: '&#xe05b;',
    Prompt: '&#xe109;',
    PromptAlert: '&#xe10c;',
    PromptInfo: '&#xe10b;',
    Publish: '&#xe059;',
    Qrcode: '&#xe0fb;',
    Question: '&#xe087;',
    Quote: '&#xe023;',
    Record: '&#xe0af;',
    Repeat: '&#xe090;',
    Reply: '&#xe00c;',
    ReplyAll: '&#xe00d;',
    ResizeEnlarge: '&#xe0b5;',
    ResizeShrink: '&#xe0b6;',
    Return: '&#xe08f;',
    ReturnBack: '&#xe08e;',
    Rocket: '&#xe052;',
    Rss: '&#xe06c;',
    Save: '&#xe0a6;',
    Scaledown: '&#xe107;',
    Scaleup: '&#xe108;',
    Schedule: '&#xe900;',
    Screen: '&#xe062;',
    Search: '&#xe026;',
    Sharable: '&#xe01a;',
    Share: '&#xe019;',
    Shield: '&#xe906;',
    Shuffle: '&#xe08d;',
    Sound: '&#xe0b8;',
    StarEmpty: '&#xe01e;',
    StarFull: '&#xe01d;',
    Stop: '&#xe0b0;',
    Suitcase: '&#xe054;',
    Sun: '&#xe05f;',
    SunSmall: '&#xe05e;',
    Switch: '&#xe094;',
    Sync: '&#xe100;',
    Tag: '&#xe02f;',
    Target: '&#xe018;',
    Thermometer: '&#xe06e;',
    ThumbsDown: '&#xe020;',
    ThumbsUp: '&#xe01f;',
    Thunder: '&#xe043;',
    Tick: '&#xe079;',
    Ticket: '&#xe06b;',
    Tools: '&#xe02d;',
    Traffic: '&#xe565;',
    Trash: '&#xe0a3;',
    Trophy: '&#xe02e;',
    Upload: '&#xe0a4;',
    Upload2: '&#xe0a9;',
    User: '&#xe0f3;',
    UserAdd: '&#xe0f5;',
    UserAddOld: '&#xe011;',
    UserBlock: '&#xe0f7;',
    UserBoss: '&#xe0f8;',
    UserCheck: '&#xe18a;',
    UserCheckOutline: '&#xe18b;',
    UserDel: '&#xe0f6;',
    UserOld: '&#xe00f;',
    Users: '&#xe0f4;',
    UsersOld: '&#xe010;',
    Vcard: '&#xe012;',
    Video: '&#xe09f;',
    Voicemail: '&#xe067;',
    Volume: '&#xe0b7;',
    Warning: '&#xe089;',
    Wireless: '&#xe06d;',
    Wrench: '&#xe0f9;',
    Zzz: '&#xe106;'
};

if (!window['UIIcons']) {
    window.UIIcons = Affinity.icons;
}

/**   GEt ICON                   *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

Affinity.icons.getIcon = function (str, defaultStr) {
    if (str && str in Affinity.icons) {
        return Affinity.icons[str];
}
    if (str) {
        str = str.replace('icon', '').trim().camelCase();
        if (str in Affinity.icons) {
            return Affinity.icons[str];
}
}
    if (defaultStr && defaultStr in Affinity.icons) {
        return Affinity.icons[defaultStr];
}
    return '';
};

/*************************************************************************************************************************/
/**                            *******************************************************************************************/
/**   GLOABL CONFIG SETTINGS   *******************************************************************************************/
/**                            *******************************************************************************************/
/*************************************************************************************************************************/

Affinity.appname = 'none';
Affinity.apiversion = 1;
Affinity.urlroot = '';
Affinity.authroot = '';
Affinity.apiroot = '';
Affinity.zelosroot = '';
Affinity.lookupapi = '';

Affinity.uisession = String.uniqueID();
Affinity.uiready = false;
Affinity.login = null;
Affinity.datalist = false;
Affinity.loaders = {};
Affinity.loaders.dark = 'data:image/gif;base64,R0lGODlhEAAQAPQAADMzM8zMzDs7O3h4eERERKGhoYKCgszMzJaWlra2tmNjY1lZWb+/v21tbcjIyKqqqoyMjAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAAFdyAgAgIJIeWoAkRCCMdBkKtIHIngyMKsErPBYbADpkSCwhDmQCBethRB6Vj4kFCkQPG4IlWDgrNRIwnO4UKBXDufzQvDMaoSDBgFb886MiQadgNABAokfCwzBA8LCg0Egl8jAggGAA1kBIA1BAYzlyILczULC2UhACH5BAkKAAAALAAAAAAQABAAAAV2ICACAmlAZTmOREEIyUEQjLKKxPHADhEvqxlgcGgkGI1DYSVAIAWMx+lwSKkICJ0QsHi9RgKBwnVTiRQQgwF4I4UFDQQEwi6/3YSGWRRmjhEETAJfIgMFCnAKM0KDV4EEEAQLiF18TAYNXDaSe3x6mjidN1s3IQAh+QQJCgAAACwAAAAAEAAQAAAFeCAgAgLZDGU5jgRECEUiCI+yioSDwDJyLKsXoHFQxBSHAoAAFBhqtMJg8DgQBgfrEsJAEAg4YhZIEiwgKtHiMBgtpg3wbUZXGO7kOb1MUKRFMysCChAoggJCIg0GC2aNe4gqQldfL4l/Ag1AXySJgn5LcoE3QXI3IQAh+QQJCgAAACwAAAAAEAAQAAAFdiAgAgLZNGU5joQhCEjxIssqEo8bC9BRjy9Ag7GILQ4QEoE0gBAEBcOpcBA0DoxSK/e8LRIHn+i1cK0IyKdg0VAoljYIg+GgnRrwVS/8IAkICyosBIQpBAMoKy9dImxPhS+GKkFrkX+TigtLlIyKXUF+NjagNiEAIfkECQoAAAAsAAAAABAAEAAABWwgIAICaRhlOY4EIgjH8R7LKhKHGwsMvb4AAy3WODBIBBKCsYA9TjuhDNDKEVSERezQEL0WrhXucRUQGuik7bFlngzqVW9LMl9XWvLdjFaJtDFqZ1cEZUB0dUgvL3dgP4WJZn4jkomWNpSTIyEAIfkECQoAAAAsAAAAABAAEAAABX4gIAICuSxlOY6CIgiD8RrEKgqGOwxwUrMlAoSwIzAGpJpgoSDAGifDY5kopBYDlEpAQBwevxfBtRIUGi8xwWkDNBCIwmC9Vq0aiQQDQuK+VgQPDXV9hCJjBwcFYU5pLwwHXQcMKSmNLQcIAExlbH8JBwttaX0ABAcNbWVbKyEAIfkECQoAAAAsAAAAABAAEAAABXkgIAICSRBlOY7CIghN8zbEKsKoIjdFzZaEgUBHKChMJtRwcWpAWoWnifm6ESAMhO8lQK0EEAV3rFopIBCEcGwDKAqPh4HUrY4ICHH1dSoTFgcHUiZjBhAJB2AHDykpKAwHAwdzf19KkASIPl9cDgcnDkdtNwiMJCshACH5BAkKAAAALAAAAAAQABAAAAV3ICACAkkQZTmOAiosiyAoxCq+KPxCNVsSMRgBsiClWrLTSWFoIQZHl6pleBh6suxKMIhlvzbAwkBWfFWrBQTxNLq2RG2yhSUkDs2b63AYDAoJXAcFRwADeAkJDX0AQCsEfAQMDAIPBz0rCgcxky0JRWE1AmwpKyEAIfkECQoAAAAsAAAAABAAEAAABXkgIAICKZzkqJ4nQZxLqZKv4NqNLKK2/Q4Ek4lFXChsg5ypJjs1II3gEDUSRInEGYAw6B6zM4JhrDAtEosVkLUtHA7RHaHAGJQEjsODcEg0FBAFVgkQJQ1pAwcDDw8KcFtSInwJAowCCA6RIwqZAgkPNgVpWndjdyohACH5BAkKAAAALAAAAAAQABAAAAV5ICACAimc5KieLEuUKvm2xAKLqDCfC2GaO9eL0LABWTiBYmA06W6kHgvCqEJiAIJiu3gcvgUsscHUERm+kaCxyxa+zRPk0SgJEgfIvbAdIAQLCAYlCj4DBw0IBQsMCjIqBAcPAooCBg9pKgsJLwUFOhCZKyQDA3YqIQAh+QQJCgAAACwAAAAAEAAQAAAFdSAgAgIpnOSonmxbqiThCrJKEHFbo8JxDDOZYFFb+A41E4H4OhkOipXwBElYITDAckFEOBgMQ3arkMkUBdxIUGZpEb7kaQBRlASPg0FQQHAbEEMGDSVEAA1QBhAED1E0NgwFAooCDWljaQIQCE5qMHcNhCkjIQAh+QQJCgAAACwAAAAAEAAQAAAFeSAgAgIpnOSoLgxxvqgKLEcCC65KEAByKK8cSpA4DAiHQ/DkKhGKh4ZCtCyZGo6F6iYYPAqFgYy02xkSaLEMV34tELyRYNEsCQyHlvWkGCzsPgMCEAY7Cg04Uk48LAsDhRA8MVQPEF0GAgqYYwSRlycNcWskCkApIyEAOwAAAAAAAAAAAA==';
Affinity.loaders.light = 'data:image/gif;base64,R0lGODlhEAAQAPQAAP///zMzM/Ly8qGhoebm5mpqapSUlDMzM3l5eU9PT7y8vMrKykJCQq+vrzY2Nl5eXoaGhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAAFdyAgAgIJIeWoAkRCCMdBkKtIHIngyMKsErPBYbADpkSCwhDmQCBethRB6Vj4kFCkQPG4IlWDgrNRIwnO4UKBXDufzQvDMaoSDBgFb886MiQadgNABAokfCwzBA8LCg0Egl8jAggGAA1kBIA1BAYzlyILczULC2UhACH5BAkKAAAALAAAAAAQABAAAAV2ICACAmlAZTmOREEIyUEQjLKKxPHADhEvqxlgcGgkGI1DYSVAIAWMx+lwSKkICJ0QsHi9RgKBwnVTiRQQgwF4I4UFDQQEwi6/3YSGWRRmjhEETAJfIgMFCnAKM0KDV4EEEAQLiF18TAYNXDaSe3x6mjidN1s3IQAh+QQJCgAAACwAAAAAEAAQAAAFeCAgAgLZDGU5jgRECEUiCI+yioSDwDJyLKsXoHFQxBSHAoAAFBhqtMJg8DgQBgfrEsJAEAg4YhZIEiwgKtHiMBgtpg3wbUZXGO7kOb1MUKRFMysCChAoggJCIg0GC2aNe4gqQldfL4l/Ag1AXySJgn5LcoE3QXI3IQAh+QQJCgAAACwAAAAAEAAQAAAFdiAgAgLZNGU5joQhCEjxIssqEo8bC9BRjy9Ag7GILQ4QEoE0gBAEBcOpcBA0DoxSK/e8LRIHn+i1cK0IyKdg0VAoljYIg+GgnRrwVS/8IAkICyosBIQpBAMoKy9dImxPhS+GKkFrkX+TigtLlIyKXUF+NjagNiEAIfkECQoAAAAsAAAAABAAEAAABWwgIAICaRhlOY4EIgjH8R7LKhKHGwsMvb4AAy3WODBIBBKCsYA9TjuhDNDKEVSERezQEL0WrhXucRUQGuik7bFlngzqVW9LMl9XWvLdjFaJtDFqZ1cEZUB0dUgvL3dgP4WJZn4jkomWNpSTIyEAIfkECQoAAAAsAAAAABAAEAAABX4gIAICuSxlOY6CIgiD8RrEKgqGOwxwUrMlAoSwIzAGpJpgoSDAGifDY5kopBYDlEpAQBwevxfBtRIUGi8xwWkDNBCIwmC9Vq0aiQQDQuK+VgQPDXV9hCJjBwcFYU5pLwwHXQcMKSmNLQcIAExlbH8JBwttaX0ABAcNbWVbKyEAIfkECQoAAAAsAAAAABAAEAAABXkgIAICSRBlOY7CIghN8zbEKsKoIjdFzZaEgUBHKChMJtRwcWpAWoWnifm6ESAMhO8lQK0EEAV3rFopIBCEcGwDKAqPh4HUrY4ICHH1dSoTFgcHUiZjBhAJB2AHDykpKAwHAwdzf19KkASIPl9cDgcnDkdtNwiMJCshACH5BAkKAAAALAAAAAAQABAAAAV3ICACAkkQZTmOAiosiyAoxCq+KPxCNVsSMRgBsiClWrLTSWFoIQZHl6pleBh6suxKMIhlvzbAwkBWfFWrBQTxNLq2RG2yhSUkDs2b63AYDAoJXAcFRwADeAkJDX0AQCsEfAQMDAIPBz0rCgcxky0JRWE1AmwpKyEAIfkECQoAAAAsAAAAABAAEAAABXkgIAICKZzkqJ4nQZxLqZKv4NqNLKK2/Q4Ek4lFXChsg5ypJjs1II3gEDUSRInEGYAw6B6zM4JhrDAtEosVkLUtHA7RHaHAGJQEjsODcEg0FBAFVgkQJQ1pAwcDDw8KcFtSInwJAowCCA6RIwqZAgkPNgVpWndjdyohACH5BAkKAAAALAAAAAAQABAAAAV5ICACAimc5KieLEuUKvm2xAKLqDCfC2GaO9eL0LABWTiBYmA06W6kHgvCqEJiAIJiu3gcvgUsscHUERm+kaCxyxa+zRPk0SgJEgfIvbAdIAQLCAYlCj4DBw0IBQsMCjIqBAcPAooCBg9pKgsJLwUFOhCZKyQDA3YqIQAh+QQJCgAAACwAAAAAEAAQAAAFdSAgAgIpnOSonmxbqiThCrJKEHFbo8JxDDOZYFFb+A41E4H4OhkOipXwBElYITDAckFEOBgMQ3arkMkUBdxIUGZpEb7kaQBRlASPg0FQQHAbEEMGDSVEAA1QBhAED1E0NgwFAooCDWljaQIQCE5qMHcNhCkjIQAh+QQJCgAAACwAAAAAEAAQAAAFeSAgAgIpnOSoLgxxvqgKLEcCC65KEAByKK8cSpA4DAiHQ/DkKhGKh4ZCtCyZGo6F6iYYPAqFgYy02xkSaLEMV34tELyRYNEsCQyHlvWkGCzsPgMCEAY7Cg04Uk48LAsDhRA8MVQPEF0GAgqYYwSRlycNcWskCkApIyEAOwAAAAAAAAAAAA==';
Affinity.loaders.blue = 'data:image/gif;base64,R0lGODlhEAAQAPQAAJrS7v///5/U7sfm9aXX7+Lx+c3o9v///9vu+O/3+7rg87Pd8vb6/MDi9Pz9/ej0+tXr9wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAAFdyAgAgIJIeWoAkRCCMdBkKtIHIngyMKsErPBYbADpkSCwhDmQCBethRB6Vj4kFCkQPG4IlWDgrNRIwnO4UKBXDufzQvDMaoSDBgFb886MiQadgNABAokfCwzBA8LCg0Egl8jAggGAA1kBIA1BAYzlyILczULC2UhACH5BAkKAAAALAAAAAAQABAAAAV2ICACAmlAZTmOREEIyUEQjLKKxPHADhEvqxlgcGgkGI1DYSVAIAWMx+lwSKkICJ0QsHi9RgKBwnVTiRQQgwF4I4UFDQQEwi6/3YSGWRRmjhEETAJfIgMFCnAKM0KDV4EEEAQLiF18TAYNXDaSe3x6mjidN1s3IQAh+QQJCgAAACwAAAAAEAAQAAAFeCAgAgLZDGU5jgRECEUiCI+yioSDwDJyLKsXoHFQxBSHAoAAFBhqtMJg8DgQBgfrEsJAEAg4YhZIEiwgKtHiMBgtpg3wbUZXGO7kOb1MUKRFMysCChAoggJCIg0GC2aNe4gqQldfL4l/Ag1AXySJgn5LcoE3QXI3IQAh+QQJCgAAACwAAAAAEAAQAAAFdiAgAgLZNGU5joQhCEjxIssqEo8bC9BRjy9Ag7GILQ4QEoE0gBAEBcOpcBA0DoxSK/e8LRIHn+i1cK0IyKdg0VAoljYIg+GgnRrwVS/8IAkICyosBIQpBAMoKy9dImxPhS+GKkFrkX+TigtLlIyKXUF+NjagNiEAIfkECQoAAAAsAAAAABAAEAAABWwgIAICaRhlOY4EIgjH8R7LKhKHGwsMvb4AAy3WODBIBBKCsYA9TjuhDNDKEVSERezQEL0WrhXucRUQGuik7bFlngzqVW9LMl9XWvLdjFaJtDFqZ1cEZUB0dUgvL3dgP4WJZn4jkomWNpSTIyEAIfkECQoAAAAsAAAAABAAEAAABX4gIAICuSxlOY6CIgiD8RrEKgqGOwxwUrMlAoSwIzAGpJpgoSDAGifDY5kopBYDlEpAQBwevxfBtRIUGi8xwWkDNBCIwmC9Vq0aiQQDQuK+VgQPDXV9hCJjBwcFYU5pLwwHXQcMKSmNLQcIAExlbH8JBwttaX0ABAcNbWVbKyEAIfkECQoAAAAsAAAAABAAEAAABXkgIAICSRBlOY7CIghN8zbEKsKoIjdFzZaEgUBHKChMJtRwcWpAWoWnifm6ESAMhO8lQK0EEAV3rFopIBCEcGwDKAqPh4HUrY4ICHH1dSoTFgcHUiZjBhAJB2AHDykpKAwHAwdzf19KkASIPl9cDgcnDkdtNwiMJCshACH5BAkKAAAALAAAAAAQABAAAAV3ICACAkkQZTmOAiosiyAoxCq+KPxCNVsSMRgBsiClWrLTSWFoIQZHl6pleBh6suxKMIhlvzbAwkBWfFWrBQTxNLq2RG2yhSUkDs2b63AYDAoJXAcFRwADeAkJDX0AQCsEfAQMDAIPBz0rCgcxky0JRWE1AmwpKyEAIfkECQoAAAAsAAAAABAAEAAABXkgIAICKZzkqJ4nQZxLqZKv4NqNLKK2/Q4Ek4lFXChsg5ypJjs1II3gEDUSRInEGYAw6B6zM4JhrDAtEosVkLUtHA7RHaHAGJQEjsODcEg0FBAFVgkQJQ1pAwcDDw8KcFtSInwJAowCCA6RIwqZAgkPNgVpWndjdyohACH5BAkKAAAALAAAAAAQABAAAAV5ICACAimc5KieLEuUKvm2xAKLqDCfC2GaO9eL0LABWTiBYmA06W6kHgvCqEJiAIJiu3gcvgUsscHUERm+kaCxyxa+zRPk0SgJEgfIvbAdIAQLCAYlCj4DBw0IBQsMCjIqBAcPAooCBg9pKgsJLwUFOhCZKyQDA3YqIQAh+QQJCgAAACwAAAAAEAAQAAAFdSAgAgIpnOSonmxbqiThCrJKEHFbo8JxDDOZYFFb+A41E4H4OhkOipXwBElYITDAckFEOBgMQ3arkMkUBdxIUGZpEb7kaQBRlASPg0FQQHAbEEMGDSVEAA1QBhAED1E0NgwFAooCDWljaQIQCE5qMHcNhCkjIQAh+QQJCgAAACwAAAAAEAAQAAAFeSAgAgIpnOSoLgxxvqgKLEcCC65KEAByKK8cSpA4DAiHQ/DkKhGKh4ZCtCyZGo6F6iYYPAqFgYy02xkSaLEMV34tELyRYNEsCQyHlvWkGCzsPgMCEAY7Cg04Uk48LAsDhRA8MVQPEF0GAgqYYwSRlycNcWskCkApIyEAOwAAAAAAAAAAAA==';
Affinity.loaders.large = {};
Affinity.loaders.large.light = 'data:image/gif;base64,R0lGODlhIAAgAPMAAO/v7wAAALq6unx8fKurq5CQkDIyMlBQUMvLy9bW1rCwsBwcHAMDAwAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAIAAgAAAE5xDISWlhperN52JLhSSdRgwVo1ICQZRUsiwHpTJT4iowNS8vyW2icCF6k8HMMBkCEDskxTBDAZwuAkkqIfxIQyhBQBFvAQSDITM5VDW6XNE4KagNh6Bgwe60smQUB3d4Rz1ZBApnFASDd0hihh12BkE9kjAJVlycXIg7CQIFA6SlnJ87paqbSKiKoqusnbMdmDC2tXQlkUhziYtyWTxIfy6BE8WJt5YJvpJivxNaGmLHT0VnOgSYf0dZXS7APdpB309RnHOG5gDqXGLDaC457D1zZ/V/nmOM82XiHRLYKhKP1oZmADdEAAAh+QQJCgAAACwAAAAAIAAgAAAE6hDISWlZpOrNp1lGNRSdRpDUolIGw5RUYhhHukqFu8DsrEyqnWThGvAmhVlteBvojpTDDBUEIFwMFBRAmBkSgOrBFZogCASwBDEY/CZSg7GSE0gSCjQBMVG023xWBhklAnoEdhQEfyNqMIcKjhRsjEdnezB+A4k8gTwJhFuiW4dokXiloUepBAp5qaKpp6+Ho7aWW54wl7obvEe0kRuoplCGepwSx2jJvqHEmGt6whJpGpfJCHmOoNHKaHx61WiSR92E4lbFoq+B6QDtuetcaBPnW6+O7wDHpIiK9SaVK5GgV543tzjgGcghAgAh+QQJCgAAACwAAAAAIAAgAAAE7hDISSkxpOrN5zFHNWRdhSiVoVLHspRUMoyUakyEe8PTPCATW9A14E0UvuAKMNAZKYUZCiBMuBakSQKG8G2FzUWox2AUtAQFcBKlVQoLgQReZhQlCIJesQXI5B0CBnUMOxMCenoCfTCEWBsJColTMANldx15BGs8B5wlCZ9Po6OJkwmRpnqkqnuSrayqfKmqpLajoiW5HJq7FL1Gr2mMMcKUMIiJgIemy7xZtJsTmsM4xHiKv5KMCXqfyUCJEonXPN2rAOIAmsfB3uPoAK++G+w48edZPK+M6hLJpQg484enXIdQFSS1u6UhksENEQAAIfkECQoAAAAsAAAAACAAIAAABOcQyEmpGKLqzWcZRVUQnZYg1aBSh2GUVEIQ2aQOE+G+cD4ntpWkZQj1JIiZIogDFFyHI0UxQwFugMSOFIPJftfVAEoZLBbcLEFhlQiqGp1Vd140AUklUN3eCA51C1EWMzMCezCBBmkxVIVHBWd3HHl9JQOIJSdSnJ0TDKChCwUJjoWMPaGqDKannasMo6WnM562R5YluZRwur0wpgqZE7NKUm+FNRPIhjBJxKZteWuIBMN4zRMIVIhffcgojwCF117i4nlLnY5ztRLsnOk+aV+oJY7V7m76PdkS4trKcdg0Zc0tTcKkRAAAIfkECQoAAAAsAAAAACAAIAAABO4QyEkpKqjqzScpRaVkXZWQEximw1BSCUEIlDohrft6cpKCk5xid5MNJTaAIkekKGQkWyKHkvhKsR7ARmitkAYDYRIbUQRQjWBwJRzChi9CRlBcY1UN4g0/VNB0AlcvcAYHRyZPdEQFYV8ccwR5HWxEJ02YmRMLnJ1xCYp0Y5idpQuhopmmC2KgojKasUQDk5BNAwwMOh2RtRq5uQuPZKGIJQIGwAwGf6I0JXMpC8C7kXWDBINFMxS4DKMAWVWAGYsAdNqW5uaRxkSKJOZKaU3tPOBZ4DuK2LATgJhkPJMgTwKCdFjyPHEnKxFCDhEAACH5BAkKAAAALAAAAAAgACAAAATzEMhJaVKp6s2nIkolIJ2WkBShpkVRWqqQrhLSEu9MZJKK9y1ZrqYK9WiClmvoUaF8gIQSNeF1Er4MNFn4SRSDARWroAIETg1iVwuHjYB1kYc1mwruwXKC9gmsJXliGxc+XiUCby9ydh1sOSdMkpMTBpaXBzsfhoc5l58Gm5yToAaZhaOUqjkDgCWNHAULCwOLaTmzswadEqggQwgHuQsHIoZCHQMMQgQGubVEcxOPFAcMDAYUA85eWARmfSRQCdcMe0zeP1AAygwLlJtPNAAL19DARdPzBOWSm1brJBi45soRAWQAAkrQIykShQ9wVhHCwCQCACH5BAkKAAAALAAAAAAgACAAAATrEMhJaVKp6s2nIkqFZF2VIBWhUsJaTokqUCoBq+E71SRQeyqUToLA7VxF0JDyIQh/MVVPMt1ECZlfcjZJ9mIKoaTl1MRIl5o4CUKXOwmyrCInCKqcWtvadL2SYhyASyNDJ0uIiRMDjI0Fd30/iI2UA5GSS5UDj2l6NoqgOgN4gksEBgYFf0FDqKgHnyZ9OX8HrgYHdHpcHQULXAS2qKpENRg7eAMLC7kTBaixUYFkKAzWAAnLC7FLVxLWDBLKCwaKTULgEwbLA4hJtOkSBNqITT3xEgfLpBtzE/jiuL04RGEBgwWhShRgQExHBAAh+QQJCgAAACwAAAAAIAAgAAAE7xDISWlSqerNpyJKhWRdlSAVoVLCWk6JKlAqAavhO9UkUHsqlE6CwO1cRdCQ8iEIfzFVTzLdRAmZX3I2SfZiCqGk5dTESJeaOAlClzsJsqwiJwiqnFrb2nS9kmIcgEsjQydLiIlHehhpejaIjzh9eomSjZR+ipslWIRLAgMDOR2DOqKogTB9pCUJBagDBXR6XB0EBkIIsaRsGGMMAxoDBgYHTKJiUYEGDAzHC9EACcUGkIgFzgwZ0QsSBcXHiQvOwgDdEwfFs0sDzt4S6BK4xYjkDOzn0unFeBzOBijIm1Dgmg5YFQwsCMjp1oJ8LyIAACH5BAkKAAAALAAAAAAgACAAAATwEMhJaVKp6s2nIkqFZF2VIBWhUsJaTokqUCoBq+E71SRQeyqUToLA7VxF0JDyIQh/MVVPMt1ECZlfcjZJ9mIKoaTl1MRIl5o4CUKXOwmyrCInCKqcWtvadL2SYhyASyNDJ0uIiUd6GGl6NoiPOH16iZKNlH6KmyWFOggHhEEvAwwMA0N9GBsEC6amhnVcEwavDAazGwIDaH1ipaYLBUTCGgQDA8NdHz0FpqgTBwsLqAbWAAnIA4FWKdMLGdYGEgraigbT0OITBcg5QwPT4xLrROZL6AuQAPUS7bxLpoWidY0JtxLHKhwwMJBTHgPKdEQAACH5BAkKAAAALAAAAAAgACAAAATrEMhJaVKp6s2nIkqFZF2VIBWhUsJaTokqUCoBq+E71SRQeyqUToLA7VxF0JDyIQh/MVVPMt1ECZlfcjZJ9mIKoaTl1MRIl5o4CUKXOwmyrCInCKqcWtvadL2SYhyASyNDJ0uIiUd6GAULDJCRiXo1CpGXDJOUjY+Yip9DhToJA4RBLwMLCwVDfRgbBAaqqoZ1XBMHswsHtxtFaH1iqaoGNgAIxRpbFAgfPQSqpbgGBqUD1wBXeCYp1AYZ19JJOYgH1KwA4UBvQwXUBxPqVD9L3sbp2BNk2xvvFPJd+MFCN6HAAIKgNggY0KtEBAAh+QQJCgAAACwAAAAAIAAgAAAE6BDISWlSqerNpyJKhWRdlSAVoVLCWk6JKlAqAavhO9UkUHsqlE6CwO1cRdCQ8iEIfzFVTzLdRAmZX3I2SfYIDMaAFdTESJeaEDAIMxYFqrOUaNW4E4ObYcCXaiBVEgULe0NJaxxtYksjh2NLkZISgDgJhHthkpU4mW6blRiYmZOlh4JWkDqILwUGBnE6TYEbCgevr0N1gH4At7gHiRpFaLNrrq8HNgAJA70AWxQIH1+vsYMDAzZQPC9VCNkDWUhGkuE5PxJNwiUK4UfLzOlD4WvzAHaoG9nxPi5d+jYUqfAhhykOFwJWiAAAIfkECQoAAAAsAAAAACAAIAAABPAQyElpUqnqzaciSoVkXVUMFaFSwlpOCcMYlErAavhOMnNLNo8KsZsMZItJEIDIFSkLGQoQTNhIsFehRww2CQLKF0tYGKYSg+ygsZIuNqJksKgbfgIGepNo2cIUB3V1B3IvNiBYNQaDSTtfhhx0CwVPI0UJe0+bm4g5VgcGoqOcnjmjqDSdnhgEoamcsZuXO1aWQy8KAwOAuTYYGwi7w5h+Kr0SJ8MFihpNbx+4Erq7BYBuzsdiH1jCAzoSfl0rVirNbRXlBBlLX+BP0XJLAPGzTkAuAOqb0WT5AH7OcdCm5B8TgRwSRKIHQtaLCwg1RAAAOwAAAAAAAAAAAA==';
Affinity.loaders.large.dark = 'data:image/gif;base64,R0lGODlhIAAgAPMAADMzM////19fX5SUlGxsbIKCgtLS0rm5uVFRUUdHR2dnZ+bm5vr6+gAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAIAAgAAAE5xDISWlhperN52JLhSSdRgwVo1ICQZRUsiwHpTJT4iowNS8vyW2icCF6k8HMMBkCEDskxTBDAZwuAkkqIfxIQyhBQBFvAQSDITM5VDW6XNE4KagNh6Bgwe60smQUB3d4Rz1ZBApnFASDd0hihh12BkE9kjAJVlycXIg7CQIFA6SlnJ87paqbSKiKoqusnbMdmDC2tXQlkUhziYtyWTxIfy6BE8WJt5YJvpJivxNaGmLHT0VnOgSYf0dZXS7APdpB309RnHOG5gDqXGLDaC457D1zZ/V/nmOM82XiHRLYKhKP1oZmADdEAAAh+QQJCgAAACwAAAAAIAAgAAAE6hDISWlZpOrNp1lGNRSdRpDUolIGw5RUYhhHukqFu8DsrEyqnWThGvAmhVlteBvojpTDDBUEIFwMFBRAmBkSgOrBFZogCASwBDEY/CZSg7GSE0gSCjQBMVG023xWBhklAnoEdhQEfyNqMIcKjhRsjEdnezB+A4k8gTwJhFuiW4dokXiloUepBAp5qaKpp6+Ho7aWW54wl7obvEe0kRuoplCGepwSx2jJvqHEmGt6whJpGpfJCHmOoNHKaHx61WiSR92E4lbFoq+B6QDtuetcaBPnW6+O7wDHpIiK9SaVK5GgV543tzjgGcghAgAh+QQJCgAAACwAAAAAIAAgAAAE7hDISSkxpOrN5zFHNWRdhSiVoVLHspRUMoyUakyEe8PTPCATW9A14E0UvuAKMNAZKYUZCiBMuBakSQKG8G2FzUWox2AUtAQFcBKlVQoLgQReZhQlCIJesQXI5B0CBnUMOxMCenoCfTCEWBsJColTMANldx15BGs8B5wlCZ9Po6OJkwmRpnqkqnuSrayqfKmqpLajoiW5HJq7FL1Gr2mMMcKUMIiJgIemy7xZtJsTmsM4xHiKv5KMCXqfyUCJEonXPN2rAOIAmsfB3uPoAK++G+w48edZPK+M6hLJpQg484enXIdQFSS1u6UhksENEQAAIfkECQoAAAAsAAAAACAAIAAABOcQyEmpGKLqzWcZRVUQnZYg1aBSh2GUVEIQ2aQOE+G+cD4ntpWkZQj1JIiZIogDFFyHI0UxQwFugMSOFIPJftfVAEoZLBbcLEFhlQiqGp1Vd140AUklUN3eCA51C1EWMzMCezCBBmkxVIVHBWd3HHl9JQOIJSdSnJ0TDKChCwUJjoWMPaGqDKannasMo6WnM562R5YluZRwur0wpgqZE7NKUm+FNRPIhjBJxKZteWuIBMN4zRMIVIhffcgojwCF117i4nlLnY5ztRLsnOk+aV+oJY7V7m76PdkS4trKcdg0Zc0tTcKkRAAAIfkECQoAAAAsAAAAACAAIAAABO4QyEkpKqjqzScpRaVkXZWQEximw1BSCUEIlDohrft6cpKCk5xid5MNJTaAIkekKGQkWyKHkvhKsR7ARmitkAYDYRIbUQRQjWBwJRzChi9CRlBcY1UN4g0/VNB0AlcvcAYHRyZPdEQFYV8ccwR5HWxEJ02YmRMLnJ1xCYp0Y5idpQuhopmmC2KgojKasUQDk5BNAwwMOh2RtRq5uQuPZKGIJQIGwAwGf6I0JXMpC8C7kXWDBINFMxS4DKMAWVWAGYsAdNqW5uaRxkSKJOZKaU3tPOBZ4DuK2LATgJhkPJMgTwKCdFjyPHEnKxFCDhEAACH5BAkKAAAALAAAAAAgACAAAATzEMhJaVKp6s2nIkolIJ2WkBShpkVRWqqQrhLSEu9MZJKK9y1ZrqYK9WiClmvoUaF8gIQSNeF1Er4MNFn4SRSDARWroAIETg1iVwuHjYB1kYc1mwruwXKC9gmsJXliGxc+XiUCby9ydh1sOSdMkpMTBpaXBzsfhoc5l58Gm5yToAaZhaOUqjkDgCWNHAULCwOLaTmzswadEqggQwgHuQsHIoZCHQMMQgQGubVEcxOPFAcMDAYUA85eWARmfSRQCdcMe0zeP1AAygwLlJtPNAAL19DARdPzBOWSm1brJBi45soRAWQAAkrQIykShQ9wVhHCwCQCACH5BAkKAAAALAAAAAAgACAAAATrEMhJaVKp6s2nIkqFZF2VIBWhUsJaTokqUCoBq+E71SRQeyqUToLA7VxF0JDyIQh/MVVPMt1ECZlfcjZJ9mIKoaTl1MRIl5o4CUKXOwmyrCInCKqcWtvadL2SYhyASyNDJ0uIiRMDjI0Fd30/iI2UA5GSS5UDj2l6NoqgOgN4gksEBgYFf0FDqKgHnyZ9OX8HrgYHdHpcHQULXAS2qKpENRg7eAMLC7kTBaixUYFkKAzWAAnLC7FLVxLWDBLKCwaKTULgEwbLA4hJtOkSBNqITT3xEgfLpBtzE/jiuL04RGEBgwWhShRgQExHBAAh+QQJCgAAACwAAAAAIAAgAAAE7xDISWlSqerNpyJKhWRdlSAVoVLCWk6JKlAqAavhO9UkUHsqlE6CwO1cRdCQ8iEIfzFVTzLdRAmZX3I2SfZiCqGk5dTESJeaOAlClzsJsqwiJwiqnFrb2nS9kmIcgEsjQydLiIlHehhpejaIjzh9eomSjZR+ipslWIRLAgMDOR2DOqKogTB9pCUJBagDBXR6XB0EBkIIsaRsGGMMAxoDBgYHTKJiUYEGDAzHC9EACcUGkIgFzgwZ0QsSBcXHiQvOwgDdEwfFs0sDzt4S6BK4xYjkDOzn0unFeBzOBijIm1Dgmg5YFQwsCMjp1oJ8LyIAACH5BAkKAAAALAAAAAAgACAAAATwEMhJaVKp6s2nIkqFZF2VIBWhUsJaTokqUCoBq+E71SRQeyqUToLA7VxF0JDyIQh/MVVPMt1ECZlfcjZJ9mIKoaTl1MRIl5o4CUKXOwmyrCInCKqcWtvadL2SYhyASyNDJ0uIiUd6GGl6NoiPOH16iZKNlH6KmyWFOggHhEEvAwwMA0N9GBsEC6amhnVcEwavDAazGwIDaH1ipaYLBUTCGgQDA8NdHz0FpqgTBwsLqAbWAAnIA4FWKdMLGdYGEgraigbT0OITBcg5QwPT4xLrROZL6AuQAPUS7bxLpoWidY0JtxLHKhwwMJBTHgPKdEQAACH5BAkKAAAALAAAAAAgACAAAATrEMhJaVKp6s2nIkqFZF2VIBWhUsJaTokqUCoBq+E71SRQeyqUToLA7VxF0JDyIQh/MVVPMt1ECZlfcjZJ9mIKoaTl1MRIl5o4CUKXOwmyrCInCKqcWtvadL2SYhyASyNDJ0uIiUd6GAULDJCRiXo1CpGXDJOUjY+Yip9DhToJA4RBLwMLCwVDfRgbBAaqqoZ1XBMHswsHtxtFaH1iqaoGNgAIxRpbFAgfPQSqpbgGBqUD1wBXeCYp1AYZ19JJOYgH1KwA4UBvQwXUBxPqVD9L3sbp2BNk2xvvFPJd+MFCN6HAAIKgNggY0KtEBAAh+QQJCgAAACwAAAAAIAAgAAAE6BDISWlSqerNpyJKhWRdlSAVoVLCWk6JKlAqAavhO9UkUHsqlE6CwO1cRdCQ8iEIfzFVTzLdRAmZX3I2SfYIDMaAFdTESJeaEDAIMxYFqrOUaNW4E4ObYcCXaiBVEgULe0NJaxxtYksjh2NLkZISgDgJhHthkpU4mW6blRiYmZOlh4JWkDqILwUGBnE6TYEbCgevr0N1gH4At7gHiRpFaLNrrq8HNgAJA70AWxQIH1+vsYMDAzZQPC9VCNkDWUhGkuE5PxJNwiUK4UfLzOlD4WvzAHaoG9nxPi5d+jYUqfAhhykOFwJWiAAAIfkECQoAAAAsAAAAACAAIAAABPAQyElpUqnqzaciSoVkXVUMFaFSwlpOCcMYlErAavhOMnNLNo8KsZsMZItJEIDIFSkLGQoQTNhIsFehRww2CQLKF0tYGKYSg+ygsZIuNqJksKgbfgIGepNo2cIUB3V1B3IvNiBYNQaDSTtfhhx0CwVPI0UJe0+bm4g5VgcGoqOcnjmjqDSdnhgEoamcsZuXO1aWQy8KAwOAuTYYGwi7w5h+Kr0SJ8MFihpNbx+4Erq7BYBuzsdiH1jCAzoSfl0rVirNbRXlBBlLX+BP0XJLAPGzTkAuAOqb0WT5AH7OcdCm5B8TgRwSRKIHQtaLCwg1RAAAOwAAAAAAAAAAAA==';
Affinity.agent = window.navigator.userAgent;
Affinity.oldess = false;
Affinity.oldessLaunched = false;
Affinity.oldessFrame = false;
Affinity.oldessWindow = false;

Affinity.UI = {};

Affinity.UI.lookups = {};
Affinity.UI.lookupLoaders = [];

Affinity.UI.displaylookups = {};
Affinity.UI.displaylookupLoaders = [];

Affinity.UI.dependancies = {};
Affinity.UI.dependancyLoaders = [];

Affinity.UI.autocomplete = {};

Affinity.UI.lastAutoKill = {};
Affinity.UI.delayAutoKill = function (uuid, killid) {
    if (document.getElement('.' + killid)) {
        document.getElement('.' + killid).removeEvents();
        document.getElement('.' + killid).destroy();
    }
    window.Affinity.UI.lastAutoKill[uuid] = null;
    delete window.Affinity.UI.lastAutoKill[uuid];
}

/**   IS DATALIST                *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

var datalistTest = document.createElement('datalist');
if ('options' in datalistTest) {
    Affinity.datalist = true;
}
datalistTest = null;
delete datalistTest;

/**   AUTOSCROLL ON DRAG TO BOTTOM  **************************************************************************************/
/**   ----------------------------  **************************************************************************************/

Affinity.UI.scrolling = false;

Affinity.UI.autoscroll = function (delta) {
    var win = window;
    if (Affinity.oldessFrame) { // if in OLD ESS iframe
        try {
            win = window.parent.window;
        } catch (e) { }
    }
    try {
        var doc = win.document.documentElement, body = win.document.body;
        var scroll = (doc && doc.scrollTop || body && body.scrollTop || 0);
        if (delta > 0) { win.scrollTo(0, scroll + 10); }
        if (delta < 0) { win.scrollTo(0, scroll - 10); }
    } catch (e) { }
};

document.addEvent(Affinity.events.move, function (e) {
    if (Affinity.UI.drageventFired) {
        var mousey = e.client.y;
        var winheight = window.innerHeight || window.document.documentElement.clientHeight;
        var topCheck = 50;
        var bottomCheck = winheight - 50;
        if (Affinity.oldessFrame) { // if in OLD ESS iframe
            try {
                var win = window.parent;
                var doc = win.document.documentElement, body = win.document.body;
                winheight = win.innerHeight || win.document.documentElement.clientHeight;
                var parentScroll = (doc && doc.scrollTop || body && body.scrollTop || 0);
                var contentBox;
                var mainPanel = win.document.getElementById('ctl00_MainPanel');
                if (document.documentMode && document.documentMode < 9) {
                    contentBox = mainPanel.querySelectorAll(".ContentBody")[0];
                } else {
                    contentBox = mainPanel.getElementsByClassName("ContentBody")[0];
                }
                var framePosition = contentBox.offsetTop;
                var relativeTop = parentScroll - framePosition;
                var topCheck = 50 + relativeTop;
                var bottomCheck = (relativeTop + winheight) - 50;
            } catch (e) { }
        }
        if (mousey > bottomCheck) {
            if (!Affinity.UI.scrolling) {
                if (document.getElement('.dragger')) { document.getElement('.dragger').setStyle('display', 'none'); }
                Affinity.UI.scrolling = true;
                Affinity.UI.scroller = Affinity.UI.autoscroll.periodical(25, window, [1]);
            }
        } else if (mousey < topCheck) {
            if (!Affinity.UI.scrolling) {
                if (document.getElement('.dragger')) { document.getElement('.dragger').setStyle('display', 'none'); }
                Affinity.UI.scrolling = true;
                Affinity.UI.scroller = Affinity.UI.autoscroll.periodical(25, window, [-1]);
            }
        } else {
            if (Affinity.UI.scrolling) {
                if (document.getElement('.dragger')) { document.getElement('.dragger').setStyle('display', 'block'); }
                Affinity.UI.scrolling = false;
                clearInterval(Affinity.UI.scroller);
            }
        }
    }
});
document.addEvent(Affinity.events.end, function () {
    Affinity.UI.drageventFired = false;
    if (Affinity.UI.scrolling) {
        if (document.getElement('.dragger')) { document.getElement('.dragger').setStyle('display', 'block'); }
        Affinity.UI.scrolling = false;
        clearInterval(Affinity.UI.scroller);
    }
});

/*************************************************************************************************************************/
/**                            *******************************************************************************************/
/**   KANOMI CODE              *******************************************************************************************/
/**                            *******************************************************************************************/
/*************************************************************************************************************************/
/**                                                                                                                     **/
/**   Creates silent listener for passive key entry of the Konami code                                                  **/
/**   Code: up, up, down, down, left, right, left, right, A, B                                                          **/
/**   As used by Error page Stack Trace reveal.                                                                         **/
/**                                                                                                                     **/
/*************************************************************************************************************************/

Affinity.Konami = new Class({
    Implements: [Options],
    options: { onSuccess: function () { } },
    input: "",
    pattern: "38384040373937396665",
    initialize: function (options) {
        this.setOptions(options);
        document.addEvent('keydown', function (e) {
            this.input += e.code;
            if (this.input.length > this.pattern.length) { this.input = this.input.substr((this.input.length - this.pattern.length)); }
            if (this.input == this.pattern) { this.options.onSuccess(); }
        }.bind(this));
    }
});

/*************************************************************************************************************************/
/**                            *******************************************************************************************/
/**   RICK ROLL EASTER EGG     *******************************************************************************************/
/**                            *******************************************************************************************/
/*************************************************************************************************************************/
/**                                                                                                                     **/
/**   Creates silent listener for passive key entry of the Rick Astley                                                  **/
/**   Code: R, I, C, K, R, O, L, L                                                                                      **/
/**                                                                                                                     **/
/*************************************************************************************************************************/

Affinity.RickRoll = new Class({
    Implements: [Options],
    Binds: ['inject', 'destroy'],
    options: {},
    input: "",
    ytBox: false,
    pattern: "8273677582797676",
    initialize: function (options) {
        this.setOptions(options);
        document.addEvent('keydown', function (e) {
            this.input += e.code;
            if (this.input.length > this.pattern.length) { this.input = this.input.substr((this.input.length - this.pattern.length)); }
            if (this.input == this.pattern) { this.inject(); }
        }.bind(this));
    },
    inject: function () {
        this.destroy();
        this.ytBox = new Element('div').setStyles({ 'position': 'fixed', 'top': 0, 'left': 0, 'width': '100%', 'height': '100%', 'background': 'rgba(255,255,255,0.8)', 'text-align': 'center', 'z-index': 99999999999 })
        .inject(document.body, 'bottom')
        .set('html', '<iframe width="420" height="315" style="position:fixed;top:50%;left:50%;margin:-157px 0 0 -210px;" src="https:/' + '/www.youtube-nocookie.com/embed/dQw4w9WgXcQ?rel=0&amp;autoplay=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>')
        .addEvent('click', this.destroy);
    },
    destroy: function () {
        if (this.ytBox) { this.ytBox.removeEvents(); this.ytBox.destroy(); }
    }
});

new Affinity.RickRoll();

/*************************************************************************************************************************/
/**                            *******************************************************************************************/
/**   COOKIE MONSTER           *******************************************************************************************/
/**                            *******************************************************************************************/
/*************************************************************************************************************************/
/**                                                                                                                     **/
/**   Cookie wrapper for handling stupid IE cookie bugs :(                                                              **/
/**                                                                                                                     **/
/**   CookieMonster.Read({string:cookie_name});                                                                         **/
/**   CookieMonster.Write({string:cookie_name}, {mixed:value}, {float:expires in minutes - optional});                  **/
/**   CookieMonster.Delete({string:cookie_name});                                                                       **/
/**                                                                                                                     **/
/*************************************************************************************************************************/

Affinity.CookieMonster = new (new Class({
    Read: function (cookiename) {
        var raw;
        if (Affinity.isie) {
            var offset = document.cookie.indexOf(cookiename + '=');
            if (offset != -1) { // if cookie exists
                offset += cookiename.length + 1;
                var end = document.cookie.indexOf(";", offset);
                if (end == -1) { end = document.cookie.length; }
                // IE hates some chars in cookies, so we unescape the escaped data
                return unescape(document.cookie.substring(offset, end));
            }
        } else {
            return Cookie.read(cookiename);
        }
    },
    Write: function (cookiename, data, expires) {
        // IE hates some chars in cookies, so we escape the data. IE also requires a full date rather than a day value for 'expires'
        var domain = new URI(window.location.href).parsed.host;
        var dateNow = new Date();
        if (typeOf(expires) !== 'null' && !isNaN(expires) && parseFloat(expires) > 0) {
            var dateExpires = new Date(dateNow.getTime() + (expires * 60000));
            var dateNowStr = dateNow.toUTCString();
            var dateExpiresStr = dateExpires.toUTCString();
            log('&#169; Cookie Write Expires - name: ' + cookiename + ', value: ' + data);
            log('  expires: ' + dateExpiresStr + ', now: ' + dateNowStr + ', expires value: ' + expires + ', in days: ' + (parseFloat(expires) / 1440) + ', domain: ' + domain);
            if (Affinity.isie) {
                document.cookie = cookiename + '=' + escape(data) + '; expires=' + dateExpiresStr + '; domain:' + domain;
            } else {
                Cookie.write(cookiename, data, { duration: parseFloat(expires) / 1440 }); // expires is in mins - convert to days
            }
        } else {
            log('&#169; Cookie Write - name: ' + cookiename + ', value: ' + data);
            if (Affinity.isie) {
                document.cookie = cookiename + '=' + escape(data) + ';';
            } else {
                Cookie.write(cookiename, data);
            }
        }
    },
    Delete: function (cookiename) {
        log('&#169; Cookie Delete - name: ' + cookiename);
        if (Affinity.isie) {
            document.cookie = cookiename + '=; expires=Thu, 01-Jan-70 00:00:01 GMT;';
            try {
                Cookie.dispose(cookiename);
            } catch (e) { }
        } else {
            Cookie.dispose(cookiename);
        }
    }
}));

/*************************************************************************************************************************/
/**                            *******************************************************************************************/
/**   CONSOLE FREE LOGGER      *******************************************************************************************/
/**                            *******************************************************************************************/
/*************************************************************************************************************************/
/**                                                                                                                     **/
/**   A DOM based logger injector                                                                                       **/
/**   Required for logging and debugging as IE console changes IE cache and DOM behavior.                               **/
/**   Adds hidden button top left corner of any app.                                                                    **/
/**                                                                                                                     **/
/**   logger.enable(); Creates and enables logger                                                                       **/
/**   logger.disable(); Destroys and disables logger                                                                    **/
/**   logger.log({mixed}); Logs objects, array, strings, etc                                                            **/
/**   log({mixed}); global of above (set as blank method if disabled)                                                   **/
/**                                                                                                                     **/
/*************************************************************************************************************************/

Affinity.logger = new (new Class({
    Binds: ['build', 'enable', 'disable', 'log', 'clear', 'open', 'close'],
    enabled: false,
    initialize: function () {
        window.log = function () { };
    },
    build: function () {
        if (!Affinity.uiready) {
            window.removeEvent('UiReady', this.build);
            window.addEvent('UiReady', this.build);
            return;
        }
        window.removeEvent('UiReady', this.build);
        if (document.id('_log')) { document.id('_log').destroy(); }
        if (document.id('_logbutton')) { document.id('_logbutton').destroy(); }
        this.logBox = new Element('div', { 'id': '_log' }).inject(document.body, 'bottom');
        this.logsBox = new Element('div', { 'html': '', 'class': 'logs' }).inject(this.logBox, 'top');
        this.closeButton = new Element('div', { 'html': 'close', 'class': 'close' }).inject(this.logBox, 'top');
        this.clearButton = new Element('div', { 'html': 'clear', 'class': 'clear' }).inject(this.logBox, 'top');
        this.hiddenButton = new Element('div', { 'id': '_logbutton' }).inject(this.logBox, 'after');
        this.hiddenButton.setStyles({ 'position': 'absolute', 'top': 5, 'left': 5, 'width': 30, 'height': 30, 'z-index': 9999999998 });
        this.logBox.setStyles({ 'position': 'absolute', 'top': 40, 'left': 5, 'width': '80%', 'height': '80%', 'border': '1px solid black', 'background-color': '#fff', 'color': '000', 'z-index': 9999999999, '-webkit-transform': 'translateX(0)', 'transform': 'translateX(0)', 'display': 'none' });
        this.logsBox.setStyles({ 'width': '100%', 'height': '100%', 'padding': 10, 'overflow': 'scroll', '-webkit-box-sizing': 'border-box', '-moz-box-sizing': 'border-box', 'box-sizing': 'border-box' });
        this.clearButton.setStyles({ 'position': 'absolute', 'top': 10, 'right': 80, 'padding': 5, 'background-color': '#fff', 'cursor': 'pointer' });
        this.closeButton.setStyles({ 'position': 'absolute', 'top': 10, 'right': 30, 'padding': 5, 'background-color': '#fff', 'cursor': 'pointer' });
        this.closeButton.addEvent(Affinity.events.click, this.close);
        this.clearButton.addEvent(Affinity.events.click, this.clear);
        this.hiddenButton.addEvent(Affinity.events.click, this.open);
        this.log('/' + '/ log started ' + new Date());
        window.log = this.log;
        this.enabled = true;
        window.fireEvent('LogReady');
    },
    enable: function () {
        this.destroy();
        this.build();
        this.open();
    },
    disable: function () {
        this.destroy();
    },
    log: function (mixed) {
        if (this.enabled) {
            var outStr = typeOf(mixed) === 'object' || typeOf(mixed) === 'array' ? JSON.stringify(mixed, null, 2) : typeOf(mixed) === 'element' ? 'element type: ' + mixed.get('tag') + '\r\n' + JSON.stringify(mixed.getProperties('id', 'class', 'style', 'src', 'title', 'alt'), null, 2) : mixed;
            this.logsBox.adopt(new Element('<pre>', { 'html': outStr }));
        }
    },
    clear: function () {
        if (this.enabled) {
            this.logsBox.empty();
            this.log('/' + '/ log cleared ' + new Date());
        }
    },
    open: function () {
        if (this.enabled) {
            if (this.logBox.getStyle('display') === 'none') {
                this.logBox.setStyle('display', 'block');
            } else {
                this.logBox.setStyle('display', 'none');
            }
        }
    },
    close: function () {
        if (this.enabled) {
            if (this.logBox.getStyle('display') === 'block') {
                this.logBox.setStyle('display', 'none');
            } else {
                this.logBox.setStyle('display', 'block');
            }
        }
    },
    destroy: function () {
        window.removeEvent('UiReady', this.build);
        this.enabled = false;
        if (this.closeButton) { this.closeButton.remveEvents(); }
        if (this.clearButton) { this.clearButton.remveEvents(); }
        if (this.hiddenButton) { this.hiddenButton.remveEvents(); }
        if (this.logBox) { this.logBox.destroy(); }
        window.log = function () { };
    }
}));

/*************************************************************************************************************************/
/**                            *******************************************************************************************/
/**   SMART CLOSE              *******************************************************************************************/
/**                            *******************************************************************************************/
/*************************************************************************************************************************/
/**                                                                                                                     **/
/**   A Class that helps auto close of 'popped' elements such as calendar and autocomplete.                             **/
/**   Ensures 'click outside' auto closes.                                                                              **/
/**   Ensures IE click on scroll bar or buttons does snot auto close                                                    **/
/**                                                                                                                     **/
/*************************************************************************************************************************/

Affinity.SmartClose = new Class({
    Binds: ['isActive', 'checkActive', 'isOver', 'setClose', 'overAll', 'outAll', 'windowClick'],
    over: false,
    isOverCheckTimer: false,
    initialize: function (element, options) {
        if(Affinity.mobile){
            return 'is mobile';
        }
        this.class = 'smart-close-' + String.uniqueID();
        this.element = element;
        this.element.addClass(this.class);
        this.element.isOver = this.isOver;
        this.element.addEvent(Affinity.events.overAll, this.overAll);
        this.element.addEvent(Affinity.events.outAll, this.outAll);
        this.element.addEvent('focus', this.setClose);
    },
    isActive: function(){
        if (!document.activeElement) {
            return false;
        } else {
            if (document.activeElement === this.element || document.activeElement.getParent('.' + this.class) === this.element) {
                return true;
            }
        }
        return true;
    },
    checkActive: function () {
        if (!this.isActive()) {
            this.over = false;
            this.windowClick();
        }
    },
    isOver: function () {
        if (!this.isActive()) {
            this.over = false;
        }
        return this.over;
    },
    setClose: function () {
        window.removeEvent(Affinity.events.click, this.windowClick);
        window.addEvent(Affinity.events.click, this.windowClick);
    },
    overAll: function () {
        clearTimeout(this.isOverCheckTimer);
        this.setClose();
        this.over = true;
        this.isOverCheckTimer = this.checkActive.delay(1000, this);
    },
    outAll: function () {
        clearTimeout(this.isOverCheckTimer);
        this.over = false;
    },
    windowClick: function () {
        if (!this.over) {
            this.element.fireEvent('SmartClose');
            window.removeEvent(Affinity.events.click, this.windowClick);
        }
    }
});

/**   TRIGGER RESIZE ON PINCH    *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

Affinity.UI.mobileZooming = false;
if (Affinity.mobile) {
    window.addEvents({
        'touchmove': function (e) {
            if (e.touches.length === 2) {
                Affinity.UI.mobileZooming = true;
            }
        },
        'touchend': function (e) {
            if (Affinity.UI.mobileZooming) {
                var evt = document.createEvent('HTMLEvents');
                evt.initEvent('resize', true, false);
                window.dispatchEvent(evt);
            }
            Affinity.UI.mobileZooming = false;
        }
    });
}

/**   CACHE DEFEATIING PATH      *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

Affinity.GetCacheSafePath = function (path) {
    if (!Affinity.isie || typeOf(path) !== 'string') { return path; }
    return path + (path.contains('?') ? '&ran=' : '?ran=') + String.uniqueID() + '-' + Date.parse(new Date()).format('%s');
};

/*************************************************************************************************************************/
/**                              *****************************************************************************************/
/**   MOOTOOLS MORE EXTENTIONS   *****************************************************************************************/
/**                              *****************************************************************************************/
/*************************************************************************************************************************/

/**   FORCE NZ TIME              *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

Locale.define('en-NZ', 'Date', {
    dateOrder: ['date', 'month', 'year', '/'],
    shortDate: '%D/%M/%Y',
    shortTime: '%I:%M%p',
    AM: "am",
    PM: "pm"
}).inherit('en-US', 'Date');

Locale.define('en-AU').inherit('en-NZ', 'Date');

Locale.use('en-NZ');

/**   DATES                      *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

Date.implement({

    /* convert date object to zelos date string */
    toZelos: function () {
        // force date based on user local time, and convert to ISO string *WITH NO OFFSET*
        return Date.parse(this.format('%d/%m/%Y %H:%M:%S')).format('%Y-%m-%dT%H:%M:%S');
    },

    /* convert date object to readable 24 hour time string */
    toTime: function(){
        try {
            return this.format('%k:%M:%S');
        }catch(e){ return "Invalid Date"; }
    },   	
	
    /* convert date object to readable 24 hour time string */   
    toTime24: function(){
        this.toTime();
    },
	
    /* convert date object to readable 12 hour time string with am/pm */
    toTime12: function(){
        try {
            return this.format('%l:%M:%S %p').toLowerCase();
        }catch(e){ return "Invalid Date"; }
    },
	
    /* convert date object to readable string: 01.02.2020 */
    toSimple: function(){
        try {
            return this.format('%d-%m-%Y');
        }catch(e){ return "Invalid Date"; }
    },

    /* convert date object to readable string: 01.02.2020 00:00:00 */
    toSimpleDateTime: function () {
        try {
            return this.format('%d-%m-%Y %k:%M:%S');
        } catch (e) { return "Invalid Date"; }
    },
	
    /* convert date object to server / database safe string: 01.01.2020 00:00:00 +1300 */
    toServer: function(){
        try {
            return this.format('%d.%m.%Y %k:%M:%S %z');
        }catch(e){ return "Invalid Date"; }
    },
	
    /* convert date object to friendly readable string: Monday 1st January 2020 */
    toFriendly: function(){
        try {
            return this.format('%A %B %e%o %Y').replace(/  /gi,' ');
        }catch(e){ return "Invalid Date"; }
    },
	
    /* convert date object to friendly readable string: Mon 1st Jan 2020 */
    toFriendlyShort: function(){
        try {
            return this.format('%a %b %e%o %Y').replace(/  /gi, ' ');;
        }catch(e){ return "Invalid Date"; }
    },
	
    /* convert date object to friendly string: about 2 minutes ago */
    toWords: function(){
        try {
            return this.timeDiffInWords();
        }catch(e){ return "Invalid Date"; }
    },
	
    /* convert date object to friendly string: 2 mins ago */
    toWordsShort: function(){
        try {
            return this.timeDiffInWords().replace(/year/g,'yr').replace(/month/g,'mnth').replace(/hour/g,'hr').replace(/minute/g,'min').replace(/second/g,'sec').replace(/about/g,'');
        }catch(e){ return "Invalid Date"; }
    },

    /* checks if two dates match */
    matches: function (compare, excludeSeconds, excludeMilliseconds) {
        if (typeOf(compare) !== 'null') {
            var d1 = Date.parse(this);
            var d2 = Date.parse(compare);
            if (d1 && d2 && typeOf(d1) == 'date' && typeOf(d2) === 'date' && d1.isValid() && d2.isValid()) {
                if(typeOf(excludeSeconds)==='boolean' && excludeSeconds){
                    d1 = d1.setSeconds(0);
                    d2 = d2.setSeconds(0);
                }
                if (typeOf(excludeMilliseconds) === 'boolean' && excludeMilliseconds) {
                    d1 = d1.setMilliseconds(0);
                    d2 = d2.setMilliseconds(0);
                }
                d1 = d1.getTime();
                d2 = d2.getTime();
                if (d1 === d2) {
                    return true;
                }
            }
        }
        return false;
    },

    /* checks if two dates are on the same day */
    sameDay: function (compare) {
        if (typeOf(compare) !== 'null') {
            var d1 = Date.parse(this);
            var d2 = Date.parse(compare);
            if (d1 && d2 && typeOf(d1) == 'date' && typeOf(d2) === 'date' && d1.isValid() && d2.isValid()) {
                d1 = d1.clearTime().getTime();
                d2 = d2.clearTime().getTime();
                if (d1 === d2) {
                    return true;
                }
            }
        }
        return false;
    }

});

Date.defineFormat('zelos', function (date) {
    // force date based on user local time, and convert to ISO string *WITH NO OFFSET*
    return date.toZelos();
});

Date.CurentYear = new Date().get('year');

Date.FormatStrings = [
    ['christmas', '12.25.' + (Date.CurentYear + 1)],
    ['xmas', '12.25.' + (Date.CurentYear + 1)],
    ['newyear', '1.1.' + (Date.CurentYear + 1)],
    ['new year', '1.1.' + (Date.CurentYear + 1)]
];

Date.TimeTravel = [
    ['second', /(\+|\-)\s*[0-9]+( )*(seconds|second|sec|s)/],
    ['minute', /(\+|\-)\s*[0-9]+( )*(minutes|minute|min|m)/],
    ['hour', /(\+|\-)\s*[0-9]+( )*(hours|hour|h)/],
    ['day', /(\+|\-)\s*[0-9]+( )*(days|day|d)/],
    ['week', /(\+|\-)\s*[0-9]+( )*(weeks|week|w)/],
    ['month', /(\+|\-)\s*[0-9]+( )*(months|month)/],
    ['year', /(\+|\-)\s*[0-9]+( )*(years|year|y)/]
];

/**   STRING TO DATE             *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

String.implement({

    toDate: function () {
        Locale.use("en-GB");
        var i, m, v, d;
        s = this.toLowerCase().trim();
        if (s === 'now') {
            return new Date();
        }
        if (s.contains('now ')) {
            s = s.replace(/(now |today )/, new Date().format('%k:%H:%S '));
        }
        if (/^\d+$/.test(s) && s.length >= 6) {
            s = s.length > 8 ? (parseInt(s, 10) * 1000) + '' : s.substr(0, 2) + '.' + s.substr(2, 2) + '.' + s.substr(4);
        }
        for (i = 0; i < Date.FormatStrings.length; i++) {
            if (s.contains(Date.FormatStrings[i][0])) {
                s = s.replace(Date.FormatStrings[i][0], Date.FormatStrings[i][1]);
                break;
            }
        }
        for (i = 0; i < Date.TimeTravel.length; i++) {
            if (s.test(Date.TimeTravel[i][1])) {
                m = s.match(Date.TimeTravel[i][1])[0];
                v = m.match(/[0-9]+/)[0];
                if (m.indexOf('+')) { d = Date.parse(s.replace(m, '').trim()).decrement(Date.TimeTravel[i][0], parseFloat(v)); }
                if (m.indexOf('-')) { d = Date.parse(s.replace(m, '').trim()).increment(Date.TimeTravel[i][0], parseFloat(v)); }
            }
        }
        d = d == null ? Date.parse(s) : d;
        try {
            if (d.format('%s') == 0) {
                return "Invalid Date";
            } else { return d; }
        } catch (e) { return "Invalid Date"; }
    }

});

/**   OBJECT VALUE FROM KEY      *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

Object.valueFromKeyString = function (o, s) {
    s = s.replace(/\[(\w+)\]/g, '.$1'); // convert indexes to properties
    s = s.replace(/^\./, '');           // strip a leading dot
    var a = s.split('.');
    for (var i = 0, n = a.length; i < n; ++i) {
        var k = a[i];
        if (k in o) {
            o = o[k];
        } else {
            return false;
        }
    }
    return o;
}

/**   JSON HAS 401 UNAUTHORISED  *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

JSON.Unauthorized = function (json, reference) {
    var unauthorized = false;
    var type = typeOf(json);
    var check = '';
    if (type === 'object' || type === 'array') {
        json = JSON.encode(json);
        type = 'string';
    }
    if (
        type === 'string' &&
        (
            json.test('unauthorized', 'gi') ||
            json.test('unauthorised', 'gi') ||
            json.test('/(401/)', 'gi') ||
            json.test('/(403/)', 'gi')
        )
    ) {

        log('&#x270B; json response is unauthorized' + (typeOf(reference) !== null ? ' (' + unescape(reference) + ')' : '') + ' &#x270B;');

        if (window.prompts) {Affinity.prompts.hide(); }
        window.fireEvent('unauthorized');
        unauthorized = true;
    }
    json = null;
    return unauthorized;
};

/**   ELEMENT WIDGET             *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

Element.implement({

    hasWidget: function(name){
        if (this.retrieve(name)) {
            return true;
        }
        return false;
    },

    getWidget: function (name) {
        if (this.retrieve(name)) {
            return this.retrieve(name);
        }
        if (this.retrieve('widget')) {
            return this.retrieve('widget');
        }
        return false;
    },

    destroyWidget: function (name) {
        var widget = this.getWidget(name);
        if (widget && 'destroy' in widget) {
            widget.destroy();
        }
        delete widget;
        return null;
    },

    exists: function () {
        try{
            if (document.contains(this)) {
                return this;
            }
        } catch (e) {}
        return false;
    }

});

/**   EVENT - GET TRUE TARGET    *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

DOMEvent.implement({

    /* gets a specific target from an event.
	   Consider a element with a span as a child. If a click event is
	   added tio the element, event.target may be button or label.
	   This allows the user to specify a class or id of the
	   parent to return
	*/
    getTarget: function (mixed) {
        return this.target.hasClass(mixed) ? this.target : this.target.get('id') === mixed ? this.target : this.target.getParent('.' + mixed) ? this.target.getParent('.' + mixed) : this.target.getParent('#' + mixed) ? this.target.getParent('#' + mixed) : this.target;
    }

});


/**   ELEMENT HAS EVENT          *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

/**
* element.hasEvent
*
* Extends MooTools Element to include hasEvent.
* Used to check if an event.
*
* @type function implements
* @param {String event name, function}.
* @use myElement.hasEvent('click',myclickFunction);
* @ Returns true, false
*
*/

Element.implement({

    hasEvent: function (eventType, fn) {
        //get the element's events
        var myEvents = this.retrieve('events');
        //can we shoot this down?
        switch (myEvents && myEvents[eventType] && (fn == undefined || myEvents[eventType].keys.contains(fn))) {
            case null:
            case false:
            case undefined:
            case 0:
                return false;
            default:
                return true;
        }
    }

});

/**   MAKE FORM ELEMENT          *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

/**
* element.makeFormElement
*
* Extends MooTools Element to include makeFormElement.
* If element is type input, select or textarea, extend with FormElement class to include change events.
*
*/

Affinity.FormElement = new Class({
    Implements: [Options, Events],
    Binds: ['clearEvents', 'setEvents', 'setValue', 'getValue', 'getDisplayValue', 'checkChanged', 'lookup', 'lookupComplete', 'destroy'],
    options: {
    },
    element: false,
    dynamicContents: false,
    dynamicFirstLoad: true,
    defaultValue: '',
    changed: false,
    initialize: function (element, options) {
        this.setOptions(options);
        this.element = element;
        if (!element.retrieve('defaultValue')) {
            this.element = element;
            this.setEvents();
            this.defaultValue = element.value;
            this.element.store('defaultValue', this.defaultValue);
        }
        this.element.store('widget', this);
        this.element.store('elementWidget', this);
        this.element.addClass('widget');
        this.lastValue = this.element.value;
    },
    clearEvents: function () {
        this.element.removeEvent('input', this.checkChanged);
        this.element.removeEvent('lookup', this.lookup);
        this.element.removeEvent('lookupComplete', this.lookupComplete);
        this.element.removeEvent('change', this.checkChanged);
        this.element.removeEvent('blur', this.checkChanged);
    },
    setEvents: function () {
        this.clearEvents();
        if (this.element.get('list')) {
            this.element.addEvent('input', this.checkChanged);
        } else {
            this.element.addEvent('lookup', this.lookup);
            this.element.addEvent('lookupComplete', this.lookupComplete);
            this.element.addEvent('change', this.checkChanged);
            this.element.addEvent('blur', this.checkChanged);
        }
    },
    getValue: function () {
        return this.element.value;
    },
    setValue: function (value) {
        this.element.value = value;
        this.defaultValue = this.element.value;
        this.lastValue = this.element.value;
        this.element.store('defaultValue', this.defaultValue);
        this.changed = false;
    },
    getDisplayValue: function () {
        return this.element.value;
    },
    checkChanged: function (e) {
        var val;
        if (typeOf(e) !== 'null' && typeOf(e.target) !== 'null') {
            val = e.target.value;
        } else {
            val = this.element.value;
        }
        if (val + '' !== this.defaultValue + '') {
            this.changed = true;
            if (this.lastValue = this.element.value) {
                this.element.fireEvent('changed', { target: this.element, defaultValue: this.defaultValue, value: this.element.value, type: 'changed', originalEvent: e });
            }
            this.lastValue = this.element.value;
        } else {
            this.changed = false;
            this.element.fireEvent('restored', { target: this.element, defaultValue: this.defaultValue, value: this.element.value, type: 'restored', originalEvent: e });
            this.lastValue = this.element.value;
        }
        return this.changed;
    },
    lookup: function () {
        this.dynamicContents = true;
    },
    lookupComplete: function (lookupEvent) {
        if (this.dynamicFirstLoad) {
            this.defaultValue = lookupEvent.defaultValue;
            this.element.store('defaultValue', this.defaultValue);
            this.dynamicFirstLoad = false;
        }
        this.checkChanged({ target: this.element });
    },
    destroy: function () {
        this.clearEvents();
        this.element.eliminate('defaultValue');
        this.element.eliminate('elementWidget');
    }
});

Element.implement({
    makeFormElement: function () {
        if (this.get('tag').test('select|input|textarea|datalist', 'gi')) {
            new Affinity.FormElement(this);
        }
        return this;
    }
});

/***/

Affinity.ElementValueTracker = new Class({
    Implements: [Options, Events],
    Binds: ['__removeEvents', '__addEvents', '__elementChanged', '__elementBlured', '__doChangeCheck', '__doChangeCheckThrottled', 'addElement', 'removeElement', 'setValue', 'hasChanged', 'hasRestored', 'getValue', 'getDefault', 'getLast', 'changeStatus'],
    options: {},
    elements: [],
    values: [],
    valuesDefault: [],
    valuesLast: [],
    id: false,
    initialize: function (element) {
        this.id = String.uniqueID();
        if (element && !element.hasClass('has-change-tracker')) {
            this.addElement(element);
        }
    },
    /** PRIVATES **/
    __removeEvents: function (element) {
        element.removeEvent('change', this.__elementChanged);
        element.removeEvent('blur', this.__elementBlured);
    },
    __addEvents: function (element) {
        element.addEvent('change', this.__elementChanged);
        element.addEvent('blur', this.__elementBlured);
    },
    __cloneValue: function (val) {
        var isnum = typeOf(val) === 'number' ? true : false;
        var clone = (val + '').trim();
        return isnum ? parseFloat(clone) : clone;
    },
    __sanatiseValue: function (val) {
        try {
            return val === null || val === undefined || val.trim() === '' ? '' : val;
        } catch (er) {
            return val;
        }
    },
    __isSame: function (val1, val2) {
        return (val1 + '').trim().toLowerCase() === (val2 + '').trim().toLowerCase();
    },
    __doChangeCheck: function (ev) {
        clearTimeout(this.__doChangeCheckThrottle);
        this.__doChangeCheckThrottle = this.__doChangeCheckThrottled.delay(100, this, [ev]);
    },
    __doChangeCheckThrottle: false,
    __doChangeCheckThrottled: function (ev) {
        if (ev && ['object', 'event', 'domevent'].contains(typeOf(ev)) && 'target' in ev && this.elements.indexOf(ev.target) > -1) {
            var changed, restored;
            Array.each(this.elements, function (element, index) {
                changed = restored = false;
                this.values[index] = this.__sanatiseValue(element.value);
                if (!this.__isSame(this.values[index], this.valuesDefault[index])) {
                    changed = true;
                } else {
                    restored = true;
                }
                if (changed) {
                    element.removeClass('value-restored').addClass('value-changed');
                    element.fireEvent('ElementChanged', { value: this.values[index], last: this.valuesLast[index], default: this.valuesDefault[index] });
                    this.fireEvent('ElementChanged', { value: this.values[index], last: this.valuesLast[index], default: this.valuesDefault[index] });
                    window.fireEvent('AnElementChanged', { target: this.elements[index], value: this.values[index], last: this.valuesLast[index], default: this.valuesDefault[index] });
                }
                if (restored) {
                    element.removeClass('value-changed').addClass('value-restored');
                    element.fireEvent('ElementRestored', { value: this.values[index], last: this.valuesLast[index], default: this.valuesDefault[index] });
                    this.fireEvent('ElementRestored', { value: this.values[index], last: this.valuesLast[index], default: this.valuesDefault[index] });
                    window.fireEvent('AnElementRestored', { target: this.elements[index], value: this.values[index], last: this.valuesLast[index], default: this.valuesDefault[index] });
                }
                this.valuesLast[index] = this.values[index];
            }.bind(this));
        }
    },
    __elementChanged: function (ev) {
        this.__doChangeCheck(ev);
    },
    __elementBlured: function (ev) {
        this.__doChangeCheck(ev);
    },
    /** PUBLICS **/
    addElement: function (element) {
        if (!element.retrieve('changetracker')) {
            var val = 'value' in element ? element.value : '',
                def = element.get('data-default-value') ? element.get('data-default-value') : val;
            if (this.elements.indexOf(element) === -1) {
                this.elements.push(element);
                this.values.push(val);
                this.valuesDefault.push(def);
                this.valuesLast.push(val);
                this.__removeEvents(element);
                this.__addEvents(element);
                element.addClass('has-change-tracker');
                element.store('changetracker', this);
            } else {
                this.setValue(element, val);
            }
        }
    },
    removeElement: function (element) {
        if (this.elements.indexOf(element) !== -1) {
            var index = this.elements.indexOf(element);
            this.elements.splice(index, 1);
            this.values.splice(index, 1);
            this.valuesLast.splice(index, 1);
            this.valuesDefault.splice(index, 1);
            this.__removeEvents(element);
            element.removeClass('value-restored').removeClass('value-changed').removeClass('has-change-tracker');
            element.eliminate('changetracker');
        }
    },
    setValue: function (element, val) {
        if (this.elements.indexOf(element) !== -1) {
            var index = this.elements.indexOf(element);
            element.value = val;
            element.removeClass('value-restored').removeClass('value-changed');
            this.values[index] = val;
            this.valuesDefault[index] = val;
            this.valuesLast[index] = val;
            this.__removeEvents(element);
            this.__addEvents(element);
        } else {
            this.addElement(element);
        }
    },
    hasChanged: function () {
        var changed = false;
        Array.each(this.elements, function (element, index) {
            if (element.hasClass('value-changed')) {
                changed = true;
            }
            /* manual detection for non-change elements - do I need this? */
            if (!this.__isSame(this.values[index], this.valuesDefault[index])) {
                changed = true;
            }
        }.bind(this));
        return changed;
    },
    hasRestored: function () {
        var restored = false;
        Array.each(this.elements, function (element) {
            if (element.hasClass('value-restored')) {
                restored = true;
            }
        }.bind(this));
        return restored;
    },
    getValue: function (element) {
        var index = this.elements.indexOf(element);
        if (index !== -1) {
            return this.values[index];
        } else {
            throw new Error("Target element not tracked");
        }
    },
    getDefault: function (element) {
        var index = this.elements.indexOf(element);
        if (index !== -1) {
            return this.valuesDefault[index];
        } else {
            throw new Error("Target element not tracked");
        }
    },
    getLast: function (element) {
        var index = this.elements.indexOf(element);
        if (index !== -1) {
            return this.valuesLast[index];
        } else {
            throw new Error("Target element not tracked");
        }
    },
    changeStatus: function () {
        return { changed: this.hasChanged(), restored: this.hasRestored(), values: this.values, last: this.valuesLast, defaults: this.valuesDefault };
    },
    destroy: function () {
        Array.each(this.elements, function (element) {
            this.__removeEvents(element);
            element.removeClass('value-restored').removeClass('value-changed').removeClass('has-change-tracker');
            element.eliminate('changetracker');
        }.bind(this));
    }
});

Element.implement({
    addChangeTracker: function () {
        if (this.get('tag').test('select|input|textarea|datalist', 'gi')) {
            new Affinity.ElementValueTracker(this);
        }
        return this;
    },
    hasChanged: function () {
        if (this.retrieve('changetracker')) {
            return this.retrieve('changetracker').hasChanged();
        } else {
            //throw new Error("No Change Tracker on target element");
        }
    },
    getTrackedValue: function () {
        if (this.retrieve('changetracker')) {
            return this.retrieve('changetracker').getValue(this);
        } else {
            //throw new Error("No Change Tracker on target element");
        }
    },
    getTrackedDefault: function () {
        if (this.retrieve('changetracker')) {
            return this.retrieve('changetracker').getDefault(this);
        } else {
            //throw new Error("No Change Tracker on target element");
        }
    },
    getTrackedLast: function () {
        if (this.retrieve('changetracker')) {
            return this.retrieve('changetracker').getLast(this);
        } else {
            //throw new Error("No Change Tracker on target element");
        }
    },
    fireTrackedChange: function () {
        if (this.retrieve('changetracker')) {
            this.retrieve('changetracker').__elementChanged({ target: this });
            return this.retrieve('changetracker').getValue(this);
        } else {
            //throw new Error("No Change Tracker on target element");
        }
    }
});

/***/

/**   Element Exists + Events    *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

Element.implement({

    exists: function () {
        try {
            if (document.body.contains(this) || (this.ownerDocument && this.ownerDocument.body.contains(this))) {
                return this;
            }
        } catch (e) {
            return false;
        }
        return false;
    }

});

Element.Events.added = {
    onAdd: function () {
        if (this.exists()) {
            this.fireEvent('exists', this);
        } else {
            this.store('_exists_method', function () {
                if (this.exists()) {
                    clearInterval(this.retrieve('_exists_timer'));
                    this.eliminate('_exists_timer');
                    this.eliminate('_exists_method');
                    this.fireEvent('exists', this);
                }
            });
            this.store('_exists_timer', this.retrieve('_exists_method').periodical(100, this));
        }
    },
    onRemove: function () {
        clearInterval(this.retrieve('_exists_timer'));
        this.eliminate('_exists_timer');
        this.eliminate('_exists_method');
    }
};

Element.Events.removed = {
    onAdd: function () {
        if (!this.exists()) {
            this.fireEvent('notexists', true);
        } else {
            this.store('_not_exists_method', function () {
                if (!this.exists()) {
                    clearInterval(this.retrieve('_not_exists_timer'));
                    this.eliminate('_not_exists_timer');
                    this.eliminate('_not_exists_method');
                    this.fireEvent('notexists', true);
                }
            });
            this.store('_not_exists_timer', this.retrieve('_not_exists_method').periodical(1000, this));
        }
    },
    onRemove: function () {
        clearInterval(this.retrieve('_not_exists_timer'));
        this.eliminate('_not_exists_method');
        this.eliminate('_not_exists_method');
    }
};


/*************************************************************************************************************************/
/**                              *****************************************************************************************/
/**   MOOTOOLS MORE OVERWRITES   *****************************************************************************************/
/**                              *****************************************************************************************/
/*************************************************************************************************************************/

if (MooTools && 'version' in MooTools && parseFloat(MooTools.version) >= 1.4 && parseFloat(MooTools.version) < 1.5) {


    /*
    ---
    
    script: Drag.js
    
    name: Drag
    
    description: The base Drag Class. Can be used to drag and resize Elements using mouse events.
    
    license: MIT-style license
    
    authors:
      - Valerio Proietti
      - Tom Occhinno
      - Jan Kassens
    
    requires:
      - Core/Events
      - Core/Options
      - Core/Element.Event
      - Core/Element.Style
      - Core/Element.Dimensions
      - /MooTools.More
    
    provides: [Drag]
    ...
    
    */

    var Drag = new Class({

        Implements: [Events, Options],

        options: {/*
		onBeforeStart: function(thisElement){},
		onStart: function(thisElement, event){},
		onSnap: function(thisElement){},
		onDrag: function(thisElement, event){},
		onCancel: function(thisElement){},
		onComplete: function(thisElement, event){},*/
            snap: 6,
            unit: 'px',
            grid: false,
            style: true,
            limit: false,
            handle: false,
            invert: false,
            preventDefault: false,
            stopPropagation: false,
            modifiers: { x: 'left', y: 'top' }
        },

        initialize: function () {

            var params = Array.link(arguments, {
                'options': Type.isObject,
                'element': function (obj) {
                    return obj != null;
                }
            });

            this.element = document.id(params.element);
            this.document = this.element.getDocument();
            this.setOptions(params.options || {});
            var htype = typeOf(this.options.handle);
            this.handles = ((htype == 'array' || htype == 'collection') ? $$(this.options.handle) : document.id(this.options.handle)) || this.element;
            this.mouse = { 'now': {}, 'pos': {} };
            this.value = { 'start': {}, 'now': {} };

            this.selection = (Browser.ie) ? 'selectstart' : Affinity.events.start;

            if (Browser.ie && !Drag.ondragstartFixed) {
                document.ondragstart = Function.from(false);
                Drag.ondragstartFixed = true;
            }

            this.bound = {
                start: this.start.bind(this),
                check: this.check.bind(this),
                drag: this.drag.bind(this),
                stop: this.stop.bind(this),
                cancel: this.cancel.bind(this),
                eventStop: Function.from(false)
            };
            this.attach();
        },

        attach: function () {
            this.handles.addEvent(Affinity.events.start, this.bound.start);
            return this;
        },

        detach: function () {
            this.handles.removeEvent(Affinity.events.start, this.bound.start);
            return this;
        },

        start: function (event) {
            var options = this.options;

            if (event.rightClick) return;

            if (options.preventDefault) event.preventDefault();
            if (options.stopPropagation) event.stopPropagation();
            this.mouse.start = event.page;

            this.fireEvent('beforeStart', this.element);

            var limit = options.limit;
            this.limit = { x: [], y: [] };

            var z, coordinates;
            for (z in options.modifiers) {
                if (!options.modifiers[z]) continue;

                var style = this.element.getStyle(options.modifiers[z]);

                // Some browsers (IE and Opera) don't always return pixels.
                if (style && !style.match(/px$/)) {
                    if (!coordinates) coordinates = this.element.getCoordinates(this.element.getOffsetParent());
                    style = coordinates[options.modifiers[z]];
                }

                if (options.style) this.value.now[z] = (style || 0).toInt();
                else this.value.now[z] = this.element[options.modifiers[z]];

                if (options.invert) this.value.now[z] *= -1;

                this.mouse.pos[z] = event.page[z] - this.value.now[z];

                if (limit && limit[z]) {
                    var i = 2;
                    while (i--) {
                        var limitZI = limit[z][i];
                        if (limitZI || limitZI === 0) this.limit[z][i] = (typeof limitZI == 'function') ? limitZI() : limitZI;
                    }
                }
            }

            if (typeOf(this.options.grid) == 'number') this.options.grid = {
                x: this.options.grid,
                y: this.options.grid
            };

            var events = {};
            events[Affinity.events.move] = this.bound.check;
            events[Affinity.events.end] = this.bound.cancel;
            events[this.selection] = this.bound.eventStop;
            this.document.addEvents(events);
        },

        check: function (event) {

            if (Affinity.mobile && Affinity.UI.scrolling) { return; }

            if (this.options.preventDefault) event.preventDefault();
            var distance = Math.round(Math.sqrt(Math.pow(event.page.x - this.mouse.start.x, 2) + Math.pow(event.page.y - this.mouse.start.y, 2)));
            if (distance > this.options.snap || Affinity.mobile) {
                this.cancel();
                var events = {};
                events[Affinity.events.move] = this.bound.drag;
                events[Affinity.events.end] = this.bound.stop;
                this.document.addEvents(events);
                this.fireEvent('start', [this.element, event]).fireEvent('snap', this.element);
            }
        },

        drag: function (event) {

            Affinity.UI.drageventFired = true;

            if (Affinity.mobile && Affinity.UI.scrolling) { return; }

            var options = this.options;

            if (options.preventDefault) event.preventDefault();
            this.mouse.now = event.page;

            for (var z in options.modifiers) {
                if (!options.modifiers[z]) continue;
                this.value.now[z] = this.mouse.now[z] - this.mouse.pos[z];

                if (options.invert) this.value.now[z] *= -1;

                if (options.limit && this.limit[z]) {
                    if ((this.limit[z][1] || this.limit[z][1] === 0) && (this.value.now[z] > this.limit[z][1])) {
                        this.value.now[z] = this.limit[z][1];
                    } else if ((this.limit[z][0] || this.limit[z][0] === 0) && (this.value.now[z] < this.limit[z][0])) {
                        this.value.now[z] = this.limit[z][0];
                    }
                }

                if (options.grid[z]) this.value.now[z] -= ((this.value.now[z] - (this.limit[z][0] || 0)) % options.grid[z]);

                if (options.style) this.element.setStyle(options.modifiers[z], this.value.now[z] + options.unit);
                else this.element[options.modifiers[z]] = this.value.now[z];
            }

            this.fireEvent('drag', [this.element, event]);
        },

        cancel: function (event) {
            this.document.removeEvent(Affinity.events.move, this.bound.check);
            this.document.removeEvent(Affinity.events.end, this.bound.cancel);
            if (event) {
                this.document.removeEvent(this.selection, this.bound.eventStop);
                this.fireEvent('cancel', this.element);
            }
        },

        stop: function (event) {
            var events = {};
            events[Affinity.events.move] = this.bound.drag;
            events[Affinity.events.end] = this.bound.stop;
            events[this.selection] = this.bound.eventStop;
            this.document.removeEvents(events);
            if (event) this.fireEvent('complete', [this.element, event]);
        }

    });

    Element.implement({

        makeResizable: function (options) {
            var drag = new Drag(this, Object.merge({
                modifiers: {
                    x: 'width',
                    y: 'height'
                }
            }, options));

            this.store('resizer', drag);
            return drag.addEvent('drag', function () {
                this.fireEvent('resize', drag);
            }.bind(this));
        }

    });


    /*
    ---
    
    script: Drag.Move.js
    
    name: Drag.Move
    
    description: A Drag extension that provides support for the constraining of draggables to containers and droppables.
    
    license: MIT-style license
    
    authors:
      - Valerio Proietti
      - Tom Occhinno
      - Jan Kassens
      - Aaron Newton
      - Scott Kyle
    
    requires:
      - Core/Element.Dimensions
      - /Drag
    
    provides: [Drag.Move]
    
    ...
    */

    Drag.Move = new Class({

        Extends: Drag,

        options: {/*
		onEnter: function(thisElement, overed){},
		onLeave: function(thisElement, overed){},
		onDrop: function(thisElement, overed, event){},*/
            droppables: [],
            container: false,
            precalculate: false,
            includeMargins: true,
            checkDroppables: true
        },

        initialize: function (element, options) {
            this.parent(element, options);
            element = this.element;

            this.droppables = $$(this.options.droppables);
            this.container = document.id(this.options.container);

            if (this.container && typeOf(this.container) != 'element')
                this.container = document.id(this.container.getDocument().body);

            if (this.options.style) {
                if (this.options.modifiers.x == 'left' && this.options.modifiers.y == 'top') {
                    var parent = element.getOffsetParent(),
                        styles = element.getStyles('left', 'top');
                    if (parent && (styles.left == 'auto' || styles.top == 'auto')) {
                        element.setPosition(element.getPosition(parent));
                    }
                }

                if (element.getStyle('position') == 'static') element.setStyle('position', 'absolute');
            }

            this.addEvent('start', this.checkDroppables, true);
            this.overed = null;
        },

        start: function (event) {
            if (this.container) this.options.limit = this.calculateLimit();

            if (this.options.precalculate) {
                this.positions = this.droppables.map(function (el) {
                    return el.getCoordinates();
                });
            }

            this.parent(event);
        },

        calculateLimit: function () {
            var element = this.element,
                container = this.container,

                offsetParent = document.id(element.getOffsetParent()) || document.body,
                containerCoordinates = container.getCoordinates(offsetParent),
                elementMargin = {},
                elementBorder = {},
                containerMargin = {},
                containerBorder = {},
                offsetParentPadding = {};

            ['top', 'right', 'bottom', 'left'].each(function (pad) {
                elementMargin[pad] = element.getStyle('margin-' + pad).toInt();
                elementBorder[pad] = element.getStyle('border-' + pad).toInt();
                containerMargin[pad] = container.getStyle('margin-' + pad).toInt();
                containerBorder[pad] = container.getStyle('border-' + pad).toInt();
                offsetParentPadding[pad] = offsetParent.getStyle('padding-' + pad).toInt();
            }, this);

            var width = element.offsetWidth + elementMargin.left + elementMargin.right,
                height = element.offsetHeight + elementMargin.top + elementMargin.bottom,
                left = 0,
                top = 0,
                right = containerCoordinates.right - containerBorder.right - width,
                bottom = containerCoordinates.bottom - containerBorder.bottom - height;

            if (this.options.includeMargins) {
                left += elementMargin.left;
                top += elementMargin.top;
            } else {
                right += elementMargin.right;
                bottom += elementMargin.bottom;
            }

            if (element.getStyle('position') == 'relative') {
                var coords = element.getCoordinates(offsetParent);
                coords.left -= element.getStyle('left').toInt();
                coords.top -= element.getStyle('top').toInt();

                left -= coords.left;
                top -= coords.top;
                if (container.getStyle('position') != 'relative') {
                    left += containerBorder.left;
                    top += containerBorder.top;
                }
                right += elementMargin.left - coords.left;
                bottom += elementMargin.top - coords.top;

                if (container != offsetParent) {
                    left += containerMargin.left + offsetParentPadding.left;
                    top += ((Browser.ie6 || Browser.ie7) ? 0 : containerMargin.top) + offsetParentPadding.top;
                }
            } else {
                left -= elementMargin.left;
                top -= elementMargin.top;
                if (container != offsetParent) {
                    left += containerCoordinates.left + containerBorder.left;
                    top += containerCoordinates.top + containerBorder.top;
                }
            }

            return {
                x: [left, right],
                y: [top, bottom]
            };
        },

        getDroppableCoordinates: function (element) {
            var position = element.getCoordinates();
            if (element.getStyle('position') == 'fixed') {
                var scroll = window.getScroll();
                position.left += scroll.x;
                position.right += scroll.x;
                position.top += scroll.y;
                position.bottom += scroll.y;
            }
            return position;
        },

        checkDroppables: function () {
            var overed = this.droppables.filter(function (el, i) {
                el = this.positions ? this.positions[i] : this.getDroppableCoordinates(el);
                var now = this.mouse.now;
                return (now.x > el.left && now.x < el.right && now.y < el.bottom && now.y > el.top);
            }, this).getLast();

            if (this.overed != overed) {
                if (this.overed) this.fireEvent('leave', [this.element, this.overed]);
                if (overed) this.fireEvent('enter', [this.element, overed]);
                this.overed = overed;
            }
        },

        drag: function (event) {
            this.parent(event);
            if (this.options.checkDroppables && this.droppables.length) this.checkDroppables();
        },

        stop: function (event) {
            this.checkDroppables();
            this.fireEvent('drop', [this.element, this.overed, event]);
            this.overed = null;
            return this.parent(event);
        }

    });

    Element.implement({

        makeDraggable: function (options) {
            var drag = new Drag.Move(this, options);
            this.store('dragger', drag);
            return drag;
        }

    });


    /*
    ---
    
    script: Slider.js
    
    name: Slider
    
    description: Class for creating horizontal and vertical slider controls.
    
    license: MIT-style license
    
    authors:
      - Valerio Proietti
    
    requires:
      - Core/Element.Dimensions
      - /Class.Binds
      - /Drag
      - /Element.Measure
    
    provides: [Slider]
    
    ...
    */

    var Slider = new Class({

        Implements: [Events, Options],

        Binds: ['clickedElement', 'draggedKnob', 'scrolledElement'],

        options: {/*
		onTick: function(intPosition){},
		onChange: function(intStep){},
		onComplete: function(strStep){},*/
            onTick: function (position) {
                this.setKnobPosition(position);
            },
            initialStep: 0,
            snap: false,
            offset: 0,
            range: false,
            wheel: false,
            steps: 100,
            mode: 'horizontal'
        },

        initialize: function (element, knob, options) {
            this.setOptions(options);
            options = this.options;
            this.element = document.id(element);
            knob = this.knob = document.id(knob);
            this.previousChange = this.previousEnd = this.step = -1;

            var limit = {},
                modifiers = { x: false, y: false };

            switch (options.mode) {
                case 'vertical':
                    this.axis = 'y';
                    this.property = 'top';
                    this.offset = 'offsetHeight';
                    break;
                case 'horizontal':
                    this.axis = 'x';
                    this.property = 'left';
                    this.offset = 'offsetWidth';
            }

            this.setSliderDimensions();
            this.setRange(options.range);

            if (knob.getStyle('position') == 'static') knob.setStyle('position', 'relative');
            knob.setStyle(this.property, -options.offset);
            modifiers[this.axis] = this.property;
            limit[this.axis] = [-options.offset, this.full - options.offset];

            var dragOptions = {
                snap: 0,
                limit: limit,
                modifiers: modifiers,
                onDrag: this.draggedKnob,
                onStart: this.draggedKnob,
                onBeforeStart: (function () {
                    this.isDragging = true;
                }).bind(this),
                onCancel: function () {
                    this.isDragging = false;
                }.bind(this),
                onComplete: function () {
                    this.isDragging = false;
                    this.draggedKnob();
                    this.end();
                }.bind(this)
            };
            if (options.snap) this.setSnap(dragOptions);

            this.drag = new Drag(knob, dragOptions);
            this.attach();
            if (options.initialStep != null) this.set(options.initialStep);
        },

        attach: function () {
            this.element.addEvent('mousedown', this.clickedElement);
            if (this.options.wheel) this.element.addEvent('mousewheel', this.scrolledElement);
            this.drag.attach();
            return this;
        },

        detach: function () {
            this.element.removeEvent('mousedown', this.clickedElement)
                .removeEvent('mousewheel', this.scrolledElement);
            this.drag.detach();
            return this;
        },

        autosize: function () {
            this.setSliderDimensions()
                .setKnobPosition(this.toPosition(this.step));
            this.drag.options.limit[this.axis] = [-this.options.offset, this.full - this.options.offset];
            if (this.options.snap) this.setSnap();
            return this;
        },

        setSnap: function (options) {
            if (!options) options = this.drag.options;
            options.grid = Math.ceil(this.stepWidth);
            options.limit[this.axis][1] = this.full;
            return this;
        },

        setKnobPosition: function (position) {
            if (this.options.snap) position = this.toPosition(this.step);
            this.knob.setStyle(this.property, position);
            return this;
        },

        setSliderDimensions: function () {
            this.full = this.element.measure(function () {
                this.half = this.knob[this.offset] / 2;
                return this.element[this.offset] - this.knob[this.offset] + (this.options.offset * 2);
            }.bind(this));
            return this;
        },

        set: function (step) {
            if (!((this.range > 0) ^ (step < this.min))) step = this.min;
            if (!((this.range > 0) ^ (step > this.max))) step = this.max;

            this.step = Math.round(step);
            return this.checkStep()
                .fireEvent('tick', this.toPosition(this.step))
                .end();
        },

        setRange: function (range, pos) {
            this.min = Array.pick([range[0], 0]);
            this.max = Array.pick([range[1], this.options.steps]);
            this.range = this.max - this.min;
            this.steps = this.options.steps || this.full;
            this.stepSize = Math.abs(this.range) / this.steps;
            this.stepWidth = this.stepSize * this.full / Math.abs(this.range);
            if (range) this.set(Array.pick([pos, this.step]).floor(this.min).max(this.max));
            return this;
        },

        clickedElement: function (event) {
            if (this.isDragging || event.target == this.knob) return;

            var dir = this.range < 0 ? -1 : 1,
                position = event.page[this.axis] - this.element.getPosition()[this.axis] - this.half;

            position = position.limit(-this.options.offset, this.full - this.options.offset);

            this.step = Math.round(this.min + dir * this.toStep(position));

            this.checkStep()
                .fireEvent('tick', position)
                .end();
        },

        scrolledElement: function (event) {
            var mode = (this.options.mode == 'horizontal') ? (event.wheel < 0) : (event.wheel > 0);
            this.set(this.step + (mode ? -1 : 1) * this.stepSize);
            event.stop();
        },

        draggedKnob: function () {
            var dir = this.range < 0 ? -1 : 1,
                position = this.drag.value.now[this.axis];

            position = position.limit(-this.options.offset, this.full - this.options.offset);

            this.step = Math.round(this.min + dir * this.toStep(position));
            this.checkStep();
        },

        checkStep: function () {
            var step = this.step;
            if (this.previousChange != step) {
                this.previousChange = step;
                this.fireEvent('change', step);
            }
            return this;
        },

        end: function () {
            var step = this.step;
            if (this.previousEnd !== step) {
                this.previousEnd = step;
                this.fireEvent('complete', step + '');
            }
            return this;
        },

        toStep: function (position) {
            var step = (position + this.options.offset) * this.stepSize / this.full * this.steps;
            return this.options.steps ? Math.round(step -= step % this.stepSize) : step;
        },

        toPosition: function (step) {
            return (this.full * Math.abs(this.min - step)) / (this.steps * this.stepSize) - this.options.offset;
        }

    });


    /*
    ---
    
    script: Sortables.js
    
    name: Sortables
    
    description: Class for creating a drag and drop sorting interface for lists of items.
    
    license: MIT-style license
    
    authors:
      - Tom Occhino
    
    requires:
      - Core/Fx.Morph
      - /Drag.Move
    
    provides: [Sortables]
    
    ...
    */

    var Sortables = new Class({

        Implements: [Events, Options],

        options: {/*
		onSort: function(element, clone){},
		onStart: function(element, clone){},
		onComplete: function(element){},*/
            opacity: 1,
            clone: false,
            revert: false,
            handle: false,
            dragOptions: {}
        },

        initialize: function (lists, options) {

            this.setOptions(options);

            this.elements = [];
            this.lists = [];
            this.idle = true;

            this.addLists($$(document.id(lists) || lists));

            if (!this.options.clone) this.options.revert = false;
            if (this.options.revert) this.effect = new Fx.Morph(null, Object.merge({
                duration: 250,
                link: 'cancel'
            }, this.options.revert));
        },

        attach: function () {
            this.addLists(this.lists);
            return this;
        },

        detach: function () {
            this.lists = this.removeLists(this.lists);
            return this;
        },

        addItems: function () {
            Array.flatten(arguments).each(function (element) {
                this.elements.push(element);
                var start = element.retrieve('sortables:start', function (event) {
                    this.start.call(this, event, element);
                }.bind(this));
                (this.options.handle ? element.getElement(this.options.handle) || element : element).addEvent(Affinity.events.start, start);
            }, this);
            return this;
        },

        addLists: function () {
            Array.flatten(arguments).each(function (list) {
                this.lists.include(list);
                this.addItems(list.getChildren());
            }, this);
            return this;
        },

        removeItems: function () {
            return $$(Array.flatten(arguments).map(function (element) {
                this.elements.erase(element);
                var start = element.retrieve('sortables:start');
                (this.options.handle ? element.getElement(this.options.handle) || element : element).removeEvent(Affinity.events.start, start);

                return element;
            }, this));
        },

        removeLists: function () {
            return $$(Array.flatten(arguments).map(function (list) {
                this.lists.erase(list);
                this.removeItems(list.getChildren());

                return list;
            }, this));
        },

        getClone: function (event, element) {
            if (!this.options.clone) return new Element(element.tagName).inject(document.body);
            if (typeOf(this.options.clone) == 'function') return this.options.clone.call(this, event, element, this.list);
            var clone = element.clone(true).setStyles({
                margin: 0,
                position: 'absolute',
                visibility: 'hidden',
                width: element.getStyle('width')
            }).addEvent(Affinity.events.start, function (event) {
                element.fireEvent(Affinity.events.start, event);
            });
            //prevent the duplicated radio inputs from unchecking the real one
            if (clone.get('html').test('radio')) {
                clone.getElements('input[type=radio]').each(function (input, i) {
                    input.set('name', 'clone_' + i);
                    if (input.get('checked')) element.getElements('input[type=radio]')[i].set('checked', true);
                });
            }

            return clone.inject(this.list).setPosition(element.getPosition(element.getOffsetParent()));
        },

        getDroppables: function () {
            var droppables = this.list.getChildren().erase(this.clone).erase(this.element);
            if (!this.options.constrain) droppables.append(this.lists).erase(this.list);
            return droppables;
        },

        insert: function (dragging, element) {
            var where = 'inside';
            if (this.lists.contains(element)) {
                this.list = element;
                this.drag.droppables = this.getDroppables();
            } else {
                where = this.element.getAllPrevious().contains(element) ? 'before' : 'after';
            }
            this.element.inject(element, where);
            this.fireEvent('sort', [this.element, this.clone]);
        },

        start: function (event, element) {
            if (
                !this.idle ||
                event.rightClick ||
                ['button', 'input', 'a', 'textarea'].contains(event.target.get('tag'))
            ) return;

            if (Affinity.mobile) {
                event.preventDefault();
                event.stopPropagation();
            }

            this.idle = false;
            this.element = element;
            this.opacity = element.getStyle('opacity');
            this.list = element.getParent();
            this.clone = this.getClone(event, element);

            this.drag = new Drag.Move(this.clone, Object.merge({

                droppables: this.getDroppables()
            }, this.options.dragOptions)).addEvents({
                onSnap: function () {
                    event.stop();
                    this.clone.setStyle('visibility', 'visible');
                    this.element.setStyle('opacity', this.options.opacity || 0);
                    this.fireEvent('start', [this.element, this.clone]);
                }.bind(this),
                onEnter: this.insert.bind(this),
                onCancel: this.end.bind(this),
                onComplete: this.end.bind(this)
            });

            this.clone.inject(this.element, 'before');
            this.drag.start(event);
        },

        end: function () {
            this.drag.detach();
            this.element.setStyle('opacity', this.opacity);
            if (this.effect) {
                var dim = this.element.getStyles('width', 'height'),
                    clone = this.clone,
                    pos = clone.computePosition(this.element.getPosition(this.clone.getOffsetParent()));

                var destroy = function () {
                    this.removeEvent('cancel', destroy);
                    clone.destroy();
                };

                this.effect.element = clone;
                this.effect.start({
                    top: pos.top,
                    left: pos.left,
                    width: dim.width,
                    height: dim.height,
                    opacity: 0.25
                }).addEvent('cancel', destroy).chain(destroy);
            } else {
                this.clone.destroy();
            }
            this.reset();
        },

        reset: function () {
            this.idle = true;
            this.fireEvent('complete', this.element);
        },

        serialize: function () {
            var params = Array.link(arguments, {
                modifier: Type.isFunction,
                index: function (obj) {
                    return obj != null;
                }
            });
            var serial = this.lists.map(function (list) {
                return list.getChildren().map(params.modifier || function (element) {
                    return element.get('id');
                }, this);
            }, this);

            var index = params.index;
            if (this.lists.length == 1) index = 0;
            return (index || index === 0) && index >= 0 && index < this.lists.length ? serial[index] : serial;
        }

    });

}

/*************************************************************************************************************************/
/**                        ***********************************************************************************************/
/**   STRING SOUNDEX       ***********************************************************************************************/
/**                        ***********************************************************************************************/
/*************************************************************************************************************************/

String.prototype.soundex = function (LengthOption, CensusOption) {
    var WordString = this;
    var SoundExLen = 5;
    var TmpStr;
    var WordStr = "";
    var CurChar;
    var LastChar;
    var WSLen;
    var FirstLetter;
    WordString = WordString.toUpperCase();
    WordStr = WordString;
    WordStr = WordStr.replace(/[^A-Z]/gi, " ");
    WordStr = WordStr.replace(/^\s*/g, "");
    WordStr = WordStr.replace(/\s*$/g, "");
    WordStr = WordStr.replace(/^GH/g, "G");
    WordStr = WordStr.replace(/DG/g, "G");
    WordStr = WordStr.replace(/GH/g, "H");
    WordStr = WordStr.replace(/GN/g, "N");
    WordStr = WordStr.replace(/KN/g, "N");
    WordStr = WordStr.replace(/PH/g, "F");
    WordStr = WordStr.replace(/MP([STZ])/g, "M$1");
    WordStr = WordStr.replace(/^PS/g, "S");
    WordStr = WordStr.replace(/^PF/g, "F");
    WordStr = WordStr.replace(/MB/g, "M");
    WordStr = WordStr.replace(/TCH/g, "CH");
    FirstLetter = WordStr.substr(0, 1);
    if (FirstLetter == "H" || FirstLetter == "W") {
        WordStr = "-" + WordStr.substr(1);
    }
    WordStr = WordStr.replace(/[AEIOUYHW]/g, "0");
    WordStr = WordStr.replace(/[BPFV]/g, "1");
    WordStr = WordStr.replace(/[CSGJKQXZ]/g, "2");
    WordStr = WordStr.replace(/[DT]/g, "3");
    WordStr = WordStr.replace(/[L]/g, "4");
    WordStr = WordStr.replace(/[MN]/g, "5");
    WordStr = WordStr.replace(/[R]/g, "6");
    WSLen = WordStr.length;
    LastChar = "";
    TmpStr = "";
    for (i = 0; i < WSLen; i++) {
        CurChar = WordStr.charAt(i);
        if (CurChar == LastChar) {
            TmpStr += " ";
        } else {
            TmpStr += CurChar;
            LastChar = CurChar;
        }
    }
    WordStr = TmpStr;
    WordStr = WordStr.substr(1);
    WordStr = WordStr.replace(/\s/g, "");
    WordStr = WordStr.replace(/0/g, "");
    WordStr += "0000000000";
    WordStr = FirstLetter + WordStr;
    WordStr = WordStr.substr(0, SoundExLen);

    return (WordStr);

};

/*************************************************************************************************************************/
/**                                 **************************************************************************************/
/**   STRING LEVENSHTEIN DISTANCE   **************************************************************************************/
/**                                 **************************************************************************************/
/*************************************************************************************************************************/

String.prototype.distance = function (compare) {
    var a = this.toLowerCase();
    var b = compare.toLowerCase();
    if (a.length === 0) return b.length;
    if (b.length === 0) return a.length;
    var matrix = [];
    var i;
    for (i = 0; i <= b.length; i++) {
        matrix[i] = [i];
    }
    var j;
    for (j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
    }
    for (i = 1; i <= b.length; i++) {
        for (j = 1; j <= a.length; j++) {
            if (b.charAt(i - 1) == a.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, // substitution
                Math.min(matrix[i][j - 1] + 1, // insertion
                matrix[i - 1][j] + 1)); // deletion
            }
        }
    }

    return matrix[b.length][a.length];
};



/*************************************************************************************************************************/
/**                        ***********************************************************************************************/
/**   GLOBALS AND CONFIG   ***********************************************************************************************/
/**                        ***********************************************************************************************/
/*************************************************************************************************************************/

/**
* Request.File
*/

if (typeOf(File) == 'null') { var File = {}; } // IE is a dick
if (typeOf(Request) == 'null') { var File = {}; } // IE is a dick

File.Upload = new Class({

    Implements: [Options, Events],

    options: {
        onComplete: function () { }
    },

    initialize: function (options) {
        var self = this;
        this.setOptions(options);
        this.uploadReq = new Request.File({
            onComplete: function () {
                self.fireEvent('complete', arguments);
                this.reset();
            }
        });
        if (this.options.data) this.data(this.options.data);
        if (this.options.images) this.addMultiple(this.options.images);
    },

    data: function (data) {
        var self = this;
        if (this.options.url.indexOf('?') < 0) this.options.url += '?';
        Object.each(data, function (value, key) {
            if (self.options.url.charAt(self.options.url.length - 1) != '?') self.options.url += '&';
            self.options.url += encodeURIComponent(key) + '=' + encodeURIComponent(value);
        });
    },

    addMultiple: function (inputs) {
        var self = this;
        inputs.each(function (input) {
            self.add(input);
        });
    },

    add: function (input) {
        var test = input;
        if (typeOf(input) !== 'null') {
            var input = document.id(input),
			    name = input.get('name'),
			    file = input.files[0];
            this.uploadReq.append('fileData', file);
        }
    },

    addPostData: function (object) {
        this.uploadReq.addPostData(object);
    },

    send: function (input) {
        if (input) this.add(input);
        this.uploadReq.send({
            url: this.options.url
        });
    }

});

Request.File = new Class({

    Extends: Request,

    options: {
        emulation: false,
        urlEncoded: false
    },

    initialize: function (options) {
        this.xhr = new Browser.Request();
        this.formData = new FormData();
        this.setOptions(options);
        this.headers = this.options.headers;
    },

    append: function (key, value) {
        this.formData.append(key, value);
        return this.formData;
    },

    addPostData: function (object) {
        var self = this;
        Object.each(object, function (value, key) {
            self.formData.append(key, value);
        });
    },

    reset: function () {
        this.formData = new FormData();
    },

    send: function (options) {
        var url = options.url || this.options.url;

        this.options.isSuccess = this.options.isSuccess || this.isSuccess;
        this.running = true;

        var xhr = this.xhr;
        xhr.open('POST', url, true);
        xhr.onreadystatechange = this.onStateChange.bind(this);

        Object.each(this.headers, function (value, key) {
            try {
                xhr.setRequestHeader(key, value);
            } catch (e) {
                this.fireEvent('exception', [key, value]);
            }
        }, this);

        this.fireEvent('request');
        xhr.send(this.formData);

        if (!this.options.async) this.onStateChange();
        if (this.options.timeout) this.timer = this.timeout.delay(this.options.timeout, this);
        return this;
    }

});

/**
* Element Shaker
*/

Affinity.Shake = new Class({
    Implements: Options,
    options: {
        distance: 4,
        duration: 50,
        transition: Fx.Transitions.Sine.easeInOut,
        loops: 2
    },
    initialize: function (element, options) {
        this.setOptions(options);
        this.element = element;
        //if(this.element.getStyle('position')!='absolute') this.element.setStyle('position','relative');
        this.tween = new Fx.Tween(this.element, {
            link: 'chain',
            duration: this.options.duration,
            transition: this.options.transition,
            property: 'margin-left'
        });
    },
    shake: function () {
        var d = this.options.distance;
        for (this.loops = 0; this.loops < this.options.loops; this.loops++) {
            this.tween.start('left', d).start('left', -d);
            this.tween.start('left', d).start('left', 0)
        };
        delete d;
    },
    stop: function () {
        this.loops = this.options.loops;
        this.tween.cancel();
        this.element.setStyle('margin-left', 0);
    }
});


/*************************************************************************************************************************/
/**                            *******************************************************************************************/
/**   ESTABLISH UI FRAMEWORK   *******************************************************************************************/
/**                            *******************************************************************************************/
/*************************************************************************************************************************/
/**                                                                                                                     **/
/**   UiReady fired by JS UIFramework when initialized (ui.init.js). JS UIFramework initialized on event PageReady      **/
/**   (fired by the app using this framework)                                                                           **/
/**                                                                                                                     **/
/*************************************************************************************************************************/

window.addEvent('UiReady', function () {

    /**   REDRAW ESS IFRAME WIN8     *****************************************************************************************/
    /**   ------------------------   *****************************************************************************************/
    /**   Check if nested in ESS, browser is Chrome and OS is Win 8                                                         **/

    if (Affinity.oldess && Affinity.oldessFrame && Affinity.agent.contains('Chrome') && Affinity.agent.contains('Windows NT 6.2')) {
        /* old ess nested iframe redraw issue for chrome on win 8 */
        window.addEvent('click', function () {
            if (document.getElement('body').className.contains('redraw')) {
                document.getElement('body').setStyle('width', '100%');
                document.getElement('body').className = 'newui';
            } else {
                document.getElement('body').setStyle('width', '99.9%');
                document.getElement('body').className = 'newui redraw';
            }
        });
    }

    /**   OLD IE MASTER MESSAGE    *******************************************************************************************/
    /**   ------------------------   *****************************************************************************************/
    /**   Creates a master message that loads over top of any app warning of OLD IE.                                        **/

    //if (typeof window.masterMessage !== 'undefined' && Affinity.isie && Affinity.ieversion < 9) {
    //    masterMessage({
    //        message: '<strong class="color red large">Warning!</strong><br /><br />We do not support Internet Explorer 8 and less<br />Some functionality may not work.<br /><br />We recommend <a href="https:/' + '/www.google.com/chrome/browser/desktop/" target="_blank" class="color green">Chrome</a> or updating to at least IE9.<br /><br />Continue at your own risk.',
    //        okText: 'Accept and Continue'
    //    });
    //}


});



/**   OLD IE MASTER MESSAGE    *******************************************************************************************/
/**   ------------------------   *****************************************************************************************/
/**   Creates a master message that loads over top of any app warning of OLD IE.                                        **/

Affinity.ShowIeWarning = Affinity.CookieMonster.Read('DoNotShowIeWarning') ? false : true;
Affinity.SetNoIeWarning = function ()
{
  Affinity.CookieMonster.Write('DoNotShowIeWarning', 'Do not show IE warning');
  Affinity.ShowIeWarning = false;
};
Affinity.IeWarning = function ()
{
  // remove debug when ready for TE / PROD
  //Affinity.isie = true;
  //Affinity.isEdge = false;

  if (typeof window.masterMessage !== 'undefined' && Affinity.isie && !Affinity.isEdge)
  {
    var message = '';
    message += 'Due to security concerns, your browser is not supported and some features may not work correctly.';
    message += '<br><br>For a secure and smooth experience, switch to a different browser and log in again. On a work device? Ask your employer for an alternative browser. Otherwise, we suggest using either ';
    message += '<a href="https://www.microsoft.com/en-us/edge/download/" target="_blank" class="color blue">Microsoft Edge</a>';
    message += ' or ';
    message += '<a href="https://www.google.com/chrome/" target="_blank" class="color orange">Google Chrome</a>.';
    message += '<br><br>';
    message += '<input type="checkbox" id="SetNoIeWarning">';
    message += ' <label for="SetNoIeWarning">Do not warn me again.</label>';
    masterMessage({
      message: message,
      okText: 'Accept and Continue',
      onOk: function ()
      {
        if (document.querySelector('input[type="checkbox"]#SetNoIeWarning') && document.querySelector('input[type="checkbox"]#SetNoIeWarning').checked)
        {
          Affinity.SetNoIeWarning();
        }
      }
    });
  }
  window.removeEvent('UiReady', Affinity.IeWarning);
  Affinity.IeWarning = null;
  delete Affinity.IeWarning;
};
window.addEvent('UiReady', Affinity.IeWarning);


/*************************************************************************************************************************/
/**                        ***********************************************************************************************/
/**   ON PAGE READY        ***********************************************************************************************/
/**                        ***********************************************************************************************/
/*************************************************************************************************************************/

Affinity.PageReady = function () {

    window.removeEvent('PageReady', Affinity.PageReady);

    if (Affinity.apiversion > 1) {
        Affinity.zelosroot = Affinity.apiroot;
        Affinity.lookupapi = Affinity.apiroot + '/api/Lookup/Get';
    } else {
        Affinity.lookupapi = Affinity.zelosroot + '/api/Lookup/Get';
    }

    if (document.documentMode && document.documentMode == 8) {
        document.getElement('body').addClass('ie8');
    }

    if (Affinity.mobile) {
        //document.config.selectToAutoNum = 999999; // no autocompletes - rely on mobile select mechanism
    }

    /**   TYPE DETECTION     *********************************************************************************************/
    /**   ------------------------   *************************************************************************************/
    /*    collect information from body class                                                                            */

    var klass = document.getElement('body').get('class').toLowerCase();

    Affinity.ismac = klass.contains('mac') ? true : false;
    Affinity.isie = klass.contains('ie') ? true : false;
    Affinity.isEdge = klass.contains('edge');
    if (Affinity.isie) Affinity.ieversion = parseInt(String(klass.match(/ie[0-9]+/i)[0]).substr(2));
    if (Affinity.isie) Affinity.iedocmode = document.documentMode ? document.documentMode : false;
    Affinity.ismobile = klass.contains('mobile') ? true : false;
    if (Affinity.mobile) Affinity.ismobile = true; // override from included touch.js libs - see above.

    /**   IE FIXES     **************************************************************************************************/
    /**   ------------------------   ************************************************************************************/
    /**   Prevent backspace performing history back in IE8 when select is focused                                      **/

    if (Affinity && Affinity.isie && Affinity.ieversion < 9) {
        document.addEvent('keydown', function (e) {
            if (e.key == 8 || e.key === 'backspace') {
                if (e.target.get('tag').test('select', 'gi') || e.target.disabled || e.target.readOnly) {
                    e.preventDefault();
                }
            }
        });
    }
    
    /**   REFRESH PROTECTION     ****************************************************************************************/
    /**   ------------------------   ************************************************************************************/
    /**   Stop aggressive refreshing!                                                                                  **/

    Affinity.refreshControll = {};
    Affinity.refreshControll.initialLoad = true;
    Affinity.refreshControll.lastRefresh = new Date().getTime();
    window.addEvent('keydown', function (e) {
        if (
            e.key === 'f5' || e.key === 'F5' || 
            (e.control && (e.key === 'r' || e.key === 'R'))
        ) {
            var time = new Date().getTime();
            var timeout = Affinity.refreshControll.initialLoad ? 10000 : 5000;
            if (time - Affinity.refreshControll.lastRefresh < timeout) {
                // refresh was pressed less than 5 or 10 seconds ago - stop event propagation
                e.stop();
                uialert({ 'message': 'Refreshing this often can slow things down.<br />If you believe the page is not responding,<br />please contact Affinity Help desk.', showButtons: true })
            }
            Affinity.refreshControll.lastRefresh = new Date().getTime();
            Affinity.refreshControll.initialLoad = false;
        }
    });

    /**   SET GLOBAL DISPLAY NAME    ************************************************************************************/
    /**   ------------------------   ************************************************************************************/
    /**   If login is implemented, populate global 'employee name' DOM elements                                        **/

    window.addEvent('userComplete', function (user) {
        document.getElements('.displayname').set('html', user.commonName ? user.commonName : user.displayName ? user.displayName : '');
    });

    /**   BARAN ESS CHECK            *****************************************************************************************/
    /**   ------------------------   *****************************************************************************************/

    Affinity.essmessage = '';
    window.Affinity.oldess = false;
    var esscheckdone = (function () {
        var uirObj = new URI(window.location.href);
        var queryObj = uirObj && typeOf(uirObj) === 'object' && typeOf(uirObj.parsed.query) === 'null' ? {} : uirObj.parsed.query.parseQueryString();
        if ('sessionKey' in queryObj || 'isEss' in queryObj) {
            window.Affinity.oldess = true;
            if ('iframe' in queryObj) {
                window.Affinity.oldessLaunched = false;
                window.Affinity.oldessFrame = true;
                window.Affinity.oldessWindow = window.parent;
            }
            if ('external' in queryObj) {
                window.Affinity.oldessLaunched = true;
                window.Affinity.oldessFrame = false;
                window.Affinity.oldessWindow = window.opener;
            }
            if (window.Affinity.oldess && !'external' in queryObj && !'iframe' in queryObj) {
                window.addEvent('UiReady', function () {
                    if (window.Affinity.appname === 'cleverforms') {
                        window.Affinity.oldessLaunched = false;
                        window.Affinity.oldessFrame = true;
                        window.Affinity.oldessWindow = window.parent;
                    } else {
                        window.Affinity.oldessLaunched = true;
                        window.Affinity.oldessFrame = false;
                        window.Affinity.oldessWindow = window.opener;
                    }
                });
            }
        } else {
            /* try old ess check method */
            try{
                if (parent && 'parentFrameResize' in parent) {
                    window.Affinity.oldess = true;
                    window.Affinity.oldessLaunched = false;
                    window.Affinity.oldessFrame = true;
                    window.Affinity.oldessWindow = window.parent;
                }
            } catch (e) { log('!!! old ess check try failed'); }
        }
        return true;
    })();

    /**   BARAN ESS FRAME RESIZE     ************************************************************************************/
    /**   ------------------------   ************************************************************************************/
    /**   Fire frame resize events (used when nested in Baran ESS iFrame)                                              **/

    try{
        if (window.Affinity.oldessFrame) {
            window.addEvent('ResizeFrame', function () {
                if (document.getElement('.content')) {
                    var content = document.getElement('.content');
                    var contentSize = content.getScrollSize();
                    if (Affinity.oldessFrame && 'parentFrameResize' in parent) {
                        var parentWidth = window.parent.window.innerWidth ? window.parent.window.innerWidth - 70 : window.parent.window.document.body.offsetWidth - 70;
                        contentSize.x = parentWidth && parentWidth > 0 ? parentWidth : 1000;
                        parent.parentFrameResize({
                            x: contentSize.x,
                            y: contentSize.y + 100
                        });
                    }
                }
            });
            window.fireEvent('ResizeFrame');
            (function () {
                window.fireEvent('ResizeFrame');
            }).delay(500); // allow for section hide / show animations
        }
    } catch (e) { }

};

window.addEvent('PageReady', Affinity.PageReady);

/**   AUTOFIRE PAGEREADY         *****************************************************************************************/
/**   ------------------------   *****************************************************************************************/

Affinity.disableAutoPageReady = false;
window.addEvent('load', function () {
    (function () {
        if (!Affinity.disableAutoPageReady && !Affinity.uiready) {
            // If on load, we still have not fired 'PageReady' (developer forgot?) Fire it manually
            window.fireEvent('PageReady');
        }
    }).delay(1000, this);
});

/*************************************************************************************************************************/
/*************************************************************************************************************************/

/**
* Config
*
* A generic global object to hold global information and vars.
*
* @type object
*
*/

Affinity.log = true;
Affinity.prettyuploads = true;
Affinity.selectToAutoNum = 0;
Affinity.selectmax = 1000;
Affinity.enableSelectLimit = true;

// TODO: Remove this! When we are done 'testing in production' (grrrr), use console to enable logger
Affinity.logger.enable();

// TODO: Remove this when all legacy UI has replaced document with window
window.config = document.config = Affinity;;
var UIAddress = new Class({

    Implements: [Options],

    Binds: [
        'processNew',
        'process'
    ],

    options: {
        postId: '',
        target: null
    },

    lists: {},
    initialize: function (options) {
        this.setOptions(options);
        if (!window.googleAddressAutocompletes) {
            window.googleAddressAutocompletes = {};
            window.googleAddressApiScripts = false;
            window.googleAddressWidgetCount = 0;
        }
        window.googleAddressStartTime = (new Date).getTime();
        this.processNew();

    },

    processNew: function () {
        Array.each(document.getElements('.ui-address'), this.process);
    },

    process: function (el) {
        (function () {
            el.removeClass('ui-address');
            new UIAddressWidget({
                element: el,
                index: window.googleAddressWidgetCount
            });
            window.googleAddressWidgetCount++;
        }).delay(250 * window.googleAddressWidgetCount);
    }

});

var UIAddressWidget = new Class({

    Implements: [Options, Events],

    Binds: [
        'revert',
        'destroy',
        'findComponent',
        'getCityFromLatLong',
        'getClosestLocation',
        'clearValues',
        'updatePropertyValue',
        'fillInAddress',
        'loadScript',
        'addressInit',
        'getPlaceFromValue',
        'setPlaceValues',
        'mainAddressFocus',
        'mainAddressBlur',
        'checkForError',
        'setPlaceValuesEvent', 'getCityFromLatLongEvent', 'fireCityFromLatLong'
    ],

    options: {
        element: null,
        index: 0
    },

    element: null,
    index: 0,
    type: 'address',
    uuid: '',

    place: false,

    initialize: function (options) {

        this.setOptions(options);

        if (this.options.element === null || typeOf(this.options.element) !== 'element') {
            throw ('No valid element passed in, dummy');
            return;
        }

        this.apikey = 'AIzaSyDX7vRyaNWfkZQfj0xx9Kthii3HBXk5DGc';

        this.originalElement = this.options.element;

        this.disabled = this.originalElement.get('disabled') ? true : false;

        this.uuid = String.uniqueID();
        this.index = this.options.index;
        this.element = new Element('div', {
            'class': 'addressbox ui-validate',
            'data-validate-method': 'address'
        }).inject(this.options.element, 'before');

        window.googleAddressAutocompletes['address_' + this.uuid] = this;

        this.options.element.removeClass('ui-address').addClass('ui-address-done full-address');

        this.addressinput = new Element('input', {
            'class': 'googleAddress',
            'type': 'text',
            'id': 'googleAddress_' + this.uuid,
            'placeholder': 'Enter your address to fill the fields below'
        }).inject(this.element, 'top');

        this.errorIcon = new Element('span', {
            'class': 'addressbox-error-icon icon-warning ui-has-tooltip hidden',
            'data-tooltip': 'This is not a valid Address'
        }).inject(this.element);

        this.addressComponentWrapper = new Element('div').set('reveal', { duration: 250, transition: Fx.Transitions.Sine.easeInOut }).inject(this.element).toggle();

        this.addressNumber = new Element('input', {
            'class': 'number',
            'type': 'text',
            'id': 'street_number_' + this.uuid,
            'placeholder': 'Number',
            'onfocus': 'this.placeholder = \'\'',
            'onblur': 'this.placeholder = "Number"'
        }).inject(this.addressComponentWrapper);

        this.addressStreet = new Element('input', {
            'class': 'street',
            'type': 'text',
            'id': 'street_address_' + this.uuid,
            'placeholder': 'Street',
            'onfocus': 'this.placeholder = \'\'',
            'onblur': 'this.placeholder = "Street"'
        }).inject(this.addressComponentWrapper);

        this.addressSuburb = new Element('input', {
            'class': 'suburb',
            'type': 'text',
            'id': 'suburb_' + this.uuid,
            'placeholder': 'Suburb',
            'onfocus': 'this.placeholder = \'\'',
            'onblur': 'this.placeholder = "Suburb"'
        }).inject(this.addressComponentWrapper);

        this.addressCity = new Element('input', {
            'class': 'city',
            'type': 'text',
            'id': 'city_' + this.uuid,
            'placeholder': 'City',
            'onfocus': 'this.placeholder = \'\'',
            'onblur': 'this.placeholder = "City"'
        }).inject(this.addressComponentWrapper);

        this.addressState = new Element('input', {
            'class': 'state',
            'type': 'text',
            'id': 'state_' + this.uuid,
            'placeholder': 'State',
            'onfocus': 'this.placeholder = \'\'',
            'onblur': 'this.placeholder = "State"'
        }).inject(this.addressComponentWrapper);

        this.addressCountry = new Element('input', {
            'class': 'country',
            'type': 'text',
            'id': 'country_' + this.uuid,
            'placeholder': 'Country',
            'onfocus': 'this.placeholder = \'\'',
            'onblur': 'this.placeholder = "Country"'
        }).inject(this.addressComponentWrapper);

        this.addressPostcode = new Element('input', {
            'class': 'postcode',
            'type': 'text',
            'id': 'postal_code_' + this.uuid,
            'placeholder': 'Postcode',
            'onfocus': 'this.placeholder = \'\'',
            'onblur': 'this.placeholder = "Postcode"'
        }).inject(this.addressComponentWrapper);

        this.hiddenWrapper = new Element('div', {
            'class': 'subhidden',
            'id': 'subhidden_' + this.uuid
        }).inject(this.options.element, 'after');

        this.subhiddenaddress1 = new Element('input', {
            'class': 'address1 validate ui-address-done',
        }).inject(this.hiddenWrapper);

        this.subhiddenaddress2 = new Element('input', {
            'class': 'address2 validate ui-address-done',
        }).inject(this.hiddenWrapper);

        this.subhiddenaddress3 = new Element('input', {
            'class': 'address3 validate ui-address-done',
        }).inject(this.hiddenWrapper);

        this.subhiddenaddress4 = new Element('input', {
            'class': 'address4 validate ui-address-done',
        }).inject(this.hiddenWrapper);

        this.hiddenWrapper.adopt(this.options.element);

        this.element.inject(this.hiddenWrapper, 'before');

        this.loadScript();

        if (this.disabled) {
            this.addressinput.addClass('hidden');
        } else {
            this.addressNumber.addEvent('keyup', this.updatePropertyValue);
            this.addressStreet.addEvent('keyup', this.updatePropertyValue);
            this.addressSuburb.addEvent('keyup', this.updatePropertyValue);
            this.addressCity.addEvent('keyup', this.updatePropertyValue);
            this.addressState.addEvent('keyup', this.updatePropertyValue);
            this.addressCountry.addEvent('keyup', this.updatePropertyValue);
            this.addressPostcode.addEvent('keyup', this.updatePropertyValue);
            this.addressinput.addEvent('focus', this.mainAddressFocus);
            this.addressinput.addEvent('blur', this.mainAddressBlur);
        }

        Affinity.tooltips.processNew();


    },
    revert: function () {

        if (this.displayElement) {
            this.displayElement.removeEvent('keyup', this.doKeyUp);
            this.iconElement.destroy();
            this.displayElement.destroy();
        }

        this.addressNumber.removeEvent('keyup', this.updatePropertyValue).destroy();
        this.addressStreet.removeEvent('keyup', this.updatePropertyValue).destroy();
        this.addressSuburb.removeEvent('keyup', this.updatePropertyValue).destroy();
        this.addressCity.removeEvent('keyup', this.updatePropertyValue).destroy();
        this.addressState.removeEvent('keyup', this.updatePropertyValue).destroy();
        this.addressCountry.removeEvent('keyup', this.updatePropertyValue).destroy();
        this.addressPostcode.removeEvent('keyup', this.updatePropertyValue).destroy();

        this.selectElement.inject(this.hiddenWrapper, 'before');
        this.hiddenWrapper.destroy();
        this.selectElement.eliminate('widget');
        var select = this.selectElement;

        Object.each(this, function (key, val) {
            this[key] = null;
            delete this[key];
        }.bind(this));

        return select;

    },

    destroy: function () {

        clearTimeout(this.checkExistsPeriodical);
        var select = this.revert();
        select.destroy();

    },

    findComponent: function (places, componentId) {
        var result = false;
        for (var i = 0; i < places.length; i++) {
            if ('address_components' in places[i]) {
                for (var j = 0; j < places[i].address_components.length; j++) {
                    if (places[i].address_components[j].types.contains(componentId)) {
                        result = places[i].address_components[j];
                        break;
                    }
                }
            }
        }
        return result;
    },

    getLatLong: function (location) {
        var latlong = [];
        Object.each(location, function (value, key) {
            if (typeOf(value) === 'function') {
                latlong.push(this.place.geometry.location[key]());
            } else {
                if (typeOf(value !== 'object')) {
                    latlong.push(value);
                }
            }
        }.bind(this));
        return latlong.slice(0, 2);
    },

    /**/

    fireCityFromLatLong: function (lat, lng) {
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({ "latLng": new google.maps.LatLng(lat, lng) }, function (results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                this.fireEvent('gotCity', { uuid: this.uuid, city: this.findComponent(results, 'colloquial_area') })
            }
            else if (status == 'OVER_QUERY_LIMIT') {
                if ('warn' in console) { console.warn(this.index + ' received google status in "fireCityFromLatLong" with "' + status + '"'); }
                this.fireCityFromLatLong.delay(500, this, [lat, lng]);
            }
        }.bind(this));
    },

    /**/

    getCityFromLatLong: function (lat, lng) {
        this.addEvent('gotCity', this.getCityFromLatLongEvent);
        this.fireCityFromLatLong(lat, lng);
    },

    getCityFromLatLongEvent: function (e) {
        if (e.uuid !== this.uuid) {
            return;
        }
        this.removeEvent('gotCity', this.getCityFromLatLongEvent);
        this.place.address_components.push(e.city);
        this.setPlaceValues();
    },

    /**/

    getPlaceFromValue: function (value) {
        var address;

        try {

            address = JSON.parse(value);

            if (address.street) {
                var firstSpace = address.street.indexOf(' ');
                this.addressNumber.value = address.street.substring(0, firstSpace);
                this.addressStreet.value = address.street.substring(firstSpace + 1, address.street.length);
            }

            this.addressSuburb.value = address.suburb ? address.suburb : '';
            this.addressCity.value = address.city ? address.city : '';
            this.addressState.value = address.state ? address.state : '';
            this.addressCountry.value = address.country ? address.country : '';
            this.addressPostcode.value = address.postcode ? address.postcode : ''

        } catch (e) {

            address = value.split(',');

            var firstSpace = address[0].indexOf(' ');
            this.addressNumber.value = address[0].substring(0, firstSpace);
            this.addressStreet.value = address[0].substring(firstSpace + 1, address[0].length);
            this.addressSuburb.value = address[1];
            this.addressCountry.value = address[4] ? address[4] : '';
            this.addressPostcode.value = address[3];

            switch (this.addressCountry.value) {
                case 'New Zealand':
                    this.addressCity.value = address[2];
                    break;
                case 'Australia':
                    this.addressState.value = address[2];
                    break;
                default:
                    this.addressCity.value = address[2];
                    break;
            }
        }
    },

    clearValues: function () {
        this.addressNumber.value = '';
        this.addressStreet.value = '';
        this.addressSuburb.value = '';
        this.addressCity.value = '';
        this.addressState.value = '';
        this.addressCountry.value = '';
        this.addressPostcode.value = '';
    },

    setPlaceValues: function () {

        // Get each component of the address from the place details
        // and fill the corresponding field on the form.

        this.values = {};
        Array.each(this.place.address_components, function (component) {

            try {
                this.values[component.types[0]] = {};
                this.values[component.types[0]].long = component.long_name;
                this.values[component.types[0]].short = component.short_name;
            }
            catch (e) {
            }

        }.bind(this));

        this.countryCode = false;

        var countryObj = this.findComponent([this.place], 'country');

        if (countryObj) {
            this.countryCode = countryObj.short_name;
        }

        if (!this.countryCode || this.countryCode == '') return;

        var latlong = this.getLatLong(this.place.geometry.location);

        if (latlong.length >= 2 && !isNaN(latlong[0]) && !isNaN(latlong[1])) {

            this.addEvent('gotCity', this.setPlaceValuesEvent);

            this.fireCityFromLatLong(latlong[0], latlong[1]); // calls 'setPlaceValues'

        }

    },

    setPlaceValuesEvent: function (e) {

        if (e.uuid !== this.uuid) {
            return;
        }

        this.removeEvent('gotCity', this.setPlaceValuesEvent);

        if (e && 'city' in e) {
            try {
                this.values[e.city.types[0]] = {};
                this.values[e.city.types[0]].long = e.city.long_name;
                this.values[e.city.types[0]].short = e.city.short_name;
            } catch (e) { }
        }

        switch (this.countryCode) {

            case 'AU':

                this.addressNumber.value = (this.values['subpremise'] ? this.values['subpremise'].long + '/' : '') + (this.values['street_number'] ? this.values['street_number'].long : '');
                this.addressStreet.value = this.values['route'] ? this.values['route'].long : '';
                this.addressSuburb.value = this.values['locality'] ? this.values['locality'].long : this.values['political'] ? this.values['political'].long : '';
                this.addressCity.value = this.values['colloquial_area'] ? this.values['colloquial_area'].long : '';
                this.addressState.value = this.values['administrative_area_level_1'] ? this.values['administrative_area_level_1'].short : '';
                this.addressCountry.value = this.values['country'] ? this.values['country'].long : '';
                this.addressPostcode.value = this.values['postal_code'] ? this.values['postal_code'].long : '';

                break;

            case 'NZ':

                this.addressNumber.value = (this.values['subpremise'] ? this.values['subpremise'].long + '/' : '') + (this.values['street_number'] ? this.values['street_number'].long : '');
                this.addressStreet.value = this.values['route'] ? this.values['route'].long : '';
                this.addressSuburb.value = this.values['sublocality_level_1'] ? this.values['sublocality_level_1'].long : this.values['political'] ? this.values['political'].long : '';
                this.addressCity.value = this.values['locality'] ? this.values['locality'].long : '';
                this.addressState.value = '';
                this.addressCountry.value = this.values['country'] ? this.values['country'].long : '';
                this.addressPostcode.value = this.values['postal_code'] ? this.values['postal_code'].long : '';

                break;

            case 'GB':

                this.addressNumber.value = (this.values['subpremise'] ? this.values['subpremise'].long + '/' : '') + (this.values['street_number'] ? this.values['street_number'].long : '');
                this.addressStreet.value = this.values['route'] ? this.values['route'].long : '';
                this.addressSuburb.value = this.values['sublocality_level_1'] ? this.values['sublocality_level_1'].long : this.values['political'] ? this.values['political'].long : '';
                this.addressCity.value = this.values['locality'] ? this.values['locality'].long : '';
                this.addressState.value = this.values['administrative_area_level_2'] ? this.values['administrative_area_level_2'].long : '';
                this.addressCountry.value = this.values['country'] ? this.values['country'].long : '';
                this.addressPostcode.value = this.values['postal_code_prefix'] ? this.values['postal_code_prefix'].long : '';

                break;

            case 'US':

                this.addressNumber.value = (this.values['subpremise'] ? this.values['subpremise'].long + '/' : '') + (this.values['street_number'] ? this.values['street_number'].long : '');
                this.addressStreet.value = this.values['route'] ? this.values['route'].long : '';
                this.addressSuburb.value = this.values['neighborhood'] ? this.values['neighborhood'].long : '';
                this.addressSuburb.value = this.values['sublocality_level_1'] ? this.values['sublocality_level_1'].long : this.values['political'] ? this.values['political'].long : '';
                this.addressState.value = this.values['administrative_area_level_1'] ? this.values['administrative_area_level_1'].short : '';
                this.addressCountry.value = this.values['country'] ? this.values['country'].long : '';
                this.addressPostcode.value = this.values['postal_code'] ? this.values['postal_code'].long : '';

                break;

            default:

                this.addressNumber.value = (this.values['subpremise'] ? this.values['subpremise'].long + '/' : '') + (this.values['street_number'] ? this.values['street_number'].long : '');
                this.addressStreet.value = this.values['route'] ? this.values['route'].long : '';
                this.addressSuburb.value = this.values['neighborhood'] ? this.values['neighborhood'].long : '';
                this.addressCity.value = this.values['locality'] ? this.values['locality'].long : '';
                this.addressState.value = this.values['administrative_area_level_1'] ? this.values['administrative_area_level_1'].short : '';
                this.addressCountry.value = this.values['country'] ? this.values['country'].long : '';
                this.addressPostcode.value = this.values['postal_code'] ? this.values['postal_code'].long : '';

                break;

        }

        this.updatePropertyValue();

    },

    mainAddressFocus: function (e) {
        this.addressinput.set('placeholder', '');
    },

    mainAddressBlur: function (e) {
        this.addressinput.set('placeholder', 'Enter your address to fill the fields below');
        this.checkForError();
    },

    checkForError: function () {
        var valuesArray1 = [
            this.addressNumber.value + ' ' + this.addressStreet.value,
            this.addressSuburb.value
        ];

        var valuesArray2 = [
            this.addressCity.value,
            this.addressState.value,
            this.addressCountry.value,
            this.addressPostcode.value
        ];

        var valuesArray = Array.clone(valuesArray1).combine(Array.clone(valuesArray2));

        if (valuesArray.join('').trim() === '' || valuesArray1.join('').trim() === '') {
            this.errorIcon.removeClass('hidden');
        } else {
            this.errorIcon.addClass('hidden');
        }

    },

    addressInit: function () {

        if (!document.id('googleAddress_' + this.uuid)) {
            throw ('target google autocomplete input can not be found');
            return;
        }

        if (!('google' in window && 'maps' in window.google)) {
            throw ('google maps implementation cannot be found');
            return;
        }

        if (!('maps' in Affinity.UI)) { Affinity.UI.maps = {}; }
        if (!('autocompleteBounds' in Affinity.UI.maps)) {
            Affinity.UI.maps.autocompleteBounds = false;
            // Center autocomplete on Affinity Head Office
            var geolocation = new google.maps.LatLng(-36.847605, 174.7485493);
            var circle = new google.maps.Circle({
                center: geolocation,
                radius: 15
            });
            Affinity.UI.maps.autocompleteBounds = circle.getBounds();
        }

        if (!this.disabled) {
            document.id('googleAddress_' + this.uuid).set('disabled', null);
        }

        this.addressComponentWrapper.reveal();

        var autocomplete;

        /** DEFEAT AUTO FILL ON ADDRESS BOX **/

        if (!document.config.ismobile) {
            document.id('googleAddress_' + this.uuid).set('autocomplete', 'off');
            new Element('input', { type: 'text', name: 'address_fake_' + this.uuid, id: 'address_fake_' + this.uuid, value: '', style: 'display:none;' }).inject(document.id('googleAddress_' + this.uuid), 'before');
            new Element('input', { type: 'text', name: 'prevent_autofill_' + this.uuid, id: 'prevent_autofill_' + this.uuid, value: '', style: 'display:none;' }).inject(document.id('googleAddress_' + this.uuid), 'before');
        }

        /***/

        // Create the autocomplete object, restricting the search
        // to geographical location types.
        autocomplete = new google.maps.places.Autocomplete(document.id('googleAddress_' + this.uuid), {
            types: ['geocode'],
            componentRestrictions: {
                country: ["nz", "au"]
            }
        });
        if (typeOf(window.autocompleteBounds) !== 'null') {
            autocomplete.setBounds(Affinity.UI.maps.autocompleteBounds);
        }
        // When the user selects an address from the dropdown,
        // populate the address fields in the form.
        google.maps.event.addListener(autocomplete, 'place_changed', function () {

            this.clearValues();
            this.place = autocomplete.getPlace();

            var addressString = document.id('googleAddress_' + this.uuid).value.trim();
            axios.get('https:/' + '/maps.googleapis.com/maps/api/geocode/json?address=' + addressString + '&key=' + this.apikey)
                .then(function (response) {
                    if (response.hasOwnProperty('data') && response.data.hasOwnProperty('results')) {
                        this.place = response.data.results[0];
                        this.setPlaceValues();
                    }
                }.bind(this))
                .catch(function (error) {
                    console.log(error);
                });
        }.bind(this));

        var previousAddress = document.id('subhidden_' + this.uuid).getElement('.full-address').value;
        if (typeOf(previousAddress) !== 'null' && typeOf(previousAddress) === 'string' && previousAddress.trim() !== '') {
            this.getPlaceFromValue(previousAddress);
        }

        this.updatePropertyValue();
    },

    updatePropertyValue: function () {

        var result = JSON.stringify({
            "street": this.addressNumber.value + ' ' + this.addressStreet.value,
            "suburb": this.addressSuburb.value,
            "city": this.addressCity.value,
            "state": this.addressState.value,
            "country": this.addressCountry.value,
            "postcode": this.addressPostcode.value
        });

        document.id('subhidden_' + this.uuid).getElement('.full-address').value = result;

        this.checkForError();

    },

    isGoogleApiready: function () {
        if (
            'google' in window && typeOf(google) === 'object' &&
            'maps' in google && typeOf(google.maps) === 'object' &&
            'places' in google.maps && typeOf(google.maps.places) === 'object' &&
            'Autocomplete' in google.maps.places && typeOf(google.maps.places.Autocomplete) === 'function'
        ) {
            return true;
        }
        return false;
    },

    maybeLoadTimer: false,
    loadScript: function () {
        //once page is loaded create a script element to load in Google API
        if (this.isGoogleApiready()) {
            this.addressInit();
        } else {
            if (!window.googleAddressApiScripts) {
                window.googleAddressApiScripts = true;
                var callback = 'window.googleAddressAutocompletes.address_' + this.uuid + '.addressInit';
                var gs = new Element('script',
                    {
                        'src': 'https://maps.googleapis.com/maps/api/js?v=3.exp' + '&libraries=places&callback=' + callback + '&key=' + this.apikey
                    }).inject(document.getElement('head'), 'bottom');
            } else {
                // wait for who ever kicked this off ...
                this.maybeLoadTimer = (function () {
                    if (this.isGoogleApiready()) {
                        clearInterval(this.maybeLoadTimer);
                        this.addressInit();
                    }
                }).periodical(500, this);
            }
        }
    }
});;


var UIAutoComplete = new Class({

    Version: '1.0.9.2',
    File: 'ui.autocomplete.js',
    Notes: 'Position including scroll',

    Implements: [Options],

    Binds: [
        'processNew',
        'doAutoComplete',
        'hideAll'
    ],

    options: {

    },

    widgets: {},

    initialize: function (options)
    {
        if (window.hasOwnProperty('autocompletes')) return;
        Affinity.events.click = "click"; // Override if mobile property is true
        this.setOptions(options);
        if (!Affinity.UI.autocomplete) { Affinity.UI.autocomplete = {}; }
        Affinity.UI.lastAutoKill = {};
        if (typeOf(Affinity.UI.ghostFocus) === 'null') {
            Affinity.UI.ghostFocus = new Element('input', { 'type': 'text' });
            new Element('div', { 'class': 'subhidden' }).adopt(Affinity.UI.ghostFocus).inject(document.body, 'bottom');
        }
        window.autocompletes = this;
        this.processNew();
    },

    processNew: function () {
        Array.each(document.getElements('.ui-autocomplete'), function (el) {
            /*
            IF this is an autocomplete, but is a lookup, we can only build the autocomplete ui when we have option values.
            So, break out if we are not sure. lookup will re-fire ui-autocomplete builds when they are complete.
            */
            if (!el.hasClass('has-lookup') && !el.hasClass('lookup-loading')) {
                el.removeClass('ui-autocomplete');
                if (Affinity.mobile && 'UIAutoCompleteMobileWidget' in window) {
                    ac = new UIAutoCompleteMobileWidget({
                        selectElement: el
                    });
                } else {
                    ac = new UIAutoCompleteWidget({
                        selectElement: el
                    });
                }
                if (!this.widgets[ac.uuid]) {
                    this.widgets[ac.uuid] = ac;
                }
            }
        }.bind(this));
    },

    doAutoComplete: function (el) {
        var ac = new UIAutoCompleteWidget({
            selectElement: el
        });
        if (!this.widgets[ac.uuid]) {
            this.widgets[ac.uuid] = ac;
        }
    },

    hideAll: function (except) {
        Object.each(this.widgets, function (widget) {
            if (typeOf(except) !== 'null' && except.uuid) {
                if (widget.uuid !== except.uuid) {
                    widget.hide('master hide all');
                }
            } else {
                widget.hide('master hide all');
            }
        }.bind(this));
    }

});

var UIAutoCompleteWidget = new Class({

    debug: false,

    Implements: [Options, Events],

    Binds: [
        'fuzzyWorkerComplete',
        'cleanDisplay',
        'processOptions',
        'updateOptions',
        'stopEvent',
        'getValue', 'setValue', 'getDisplayValue',
        'position',
        'windowClickStart', 'windowClickEnd',
        'listOver', 'listOut', 'elementOver', 'elementOut',
        'doFocus', 'doClick', 'doKeyUp', 'doKeyDown',
        'fuzzySearch', 'continueWithFuzzySearch',
        'itemClicked',
        'escapeRegExp',
        'obscure', 'reveal',
        'hide', 'show',
        'clearList',
        'revert',
        'destroy',
        'searchMode_fireChangeEvents', 'searchMode_valueToOption', 'searchMode_iconClicked', 'searchMode_displayBlur',
    ],

    options: {
        stopInitialChange: false,
        selectElement: null
    },

    webworkerpath: './scripts/common/ui.autocomplete.web.worker.js',

    list: [],

    selectElement: null,
    listElement: null,
    displayElement: null,

    changed: false,
    defaultChangeValue: null,

    center: false,
    autowidth: false,

    uuid: '',
    killid: '',

    type: 'autocomplete',

    initialize: function (options) {

        if (Affinity.mobile && 'UIAutoCompleteMobileWidget' in window) {
            return new UIAutoCompleteMobileWidget(options);
        }

        this.setOptions(options);

        this.useWebWorkers = Affinity.useWebWorkers ? typeof (Worker) !== "undefined" ? true : false : false;
        if (this.useWebWorkers) {
            this.fuzzyWorker = new Worker(this.webworkerpath);
            this.fuzzyWorker.onmessage = this.fuzzyWorkerComplete;
        }

        this.searchMode = false;
        if (Affinity && Affinity.mobile) {
            this.searchMode = true;
        }

        this.icons = {};
        this.icons.search = Affinity.icons.Search;

        this.selectElement = this.options.selectElement;

        if (this.selectElement.hasClass('ui-autocomplete-center')) {
            this.center = true;
        }
        if (this.selectElement.hasClass('ui-autocomplete-autowidth')) {
            this.autowidth = true;
        }

        this.bestguess = null;

        this.selectElement.set('tabindex', 5000);

        this.hiddenWrapper = new Element('div', { 'class': 'subhidden' }).inject(this.selectElement, 'after');

        this.selectElement.inject(this.hiddenWrapper);

        this.uuid = this.selectElement.get('id') == null ? String.uniqueID() : this.selectElement.get('id');
        this.killid = 'ac-destroy-' + String.uniqueID();
        
        if (!window.autocompletes.widgets[this.uuid]) {
            window.autocompletes.widgets[this.uuid] = this;
        }

        this.selectElement.set('id', this.uuid);

        this.processOptions.delay(100, this);

        this.selectElement.store('widget', this);

        /** universal change manager - see commons.x.x.x.js */

        if (this.selectElement.retrieve('changetracker')) {
            this.valuetracker = this.selectElement.retrieve('changetracker');
        } else {
            this.valuetracker = new Affinity.ElementValueTracker();
        }

        this.valuetracker.addElement(this.selectElement);

        /**/

        document.addEvent('scroll', this.position);
        document.addEvent('resize', this.position);

    },

    fuzzyWorkerComplete: function (returnedData) {

        var workerData = returnedData.data;
            
        switch (workerData.job) {

            case 'getOptions':

                if (this.searchMode) {

                    this.massiveSelect.innerHTML = workerData.html;

                    Affinity.prompts.adopt(this.massiveSelect);
                    this.massiveSelect.removeClass('hidden');

                    new UIAutoCompleteWidget({
                        selectElement: this.massiveSelect,
                        onComplete: function (w) {
                            this.massiveLoader.destroy();
                            Affinity.prompts.center();
                            Affinity.prompts.showButtons();
                            Affinity.prompts.show();
                            w.position();
                        }.bind(this)
                    });

                } else {



                }

                break;

            case 'getList':

                var defaultSelected = null;

                if (this.listElement.getElements('li')) {
                    this.listElement.getElements('li').removeEvent(Affinity.events.click, this.itemClicked);
                }

                this.listElement.innerHTML = workerData.html;
                this.fuzzySearchItemsTotal = workerData.data.total;
                this.fuzzySearchItems = workerData.data.items;
                this.items = this.listElement.getElements('li');
                this.items.addEvent(Affinity.events.click, this.itemClicked);

                if (workerData.data.defaultID) {
                    defaultSelected = this.listElement.getElement('#' + returnedData.data.data.defaultID);
                    this.defaultValue = defaultSelected;
                    this.lastSelected = defaultSelected;
                    this.defaultChangeValue = defaultSelected.get('data-value');
                }

                this.continueProcessOptsions(defaultSelected);

                break;

            case 'resetList':

                this.listElement.innerHTML = workerData.html;

                if (this.iconElement) {
                    this.iconElement.removeClass('working');
                }

                if (workerData.select) {
                    this.lastSelected = document.id(workerData.select);
                    this.defaultValue = document.id(workerData.select);
                    this.bestguess = document.id(workerData.select);
                    this.selectElement.value = '';
                }

                this.selectElement.selectedIndex = 0;
                this.listElement.scrollTo(0, 0);
                this.defaultChangeValue = this.defaultValue.value;

                if (this.listElement.getElements('li')) {
                    this.listElement.getElements('li').removeEvent(Affinity.events.click, this.itemClicked);
                }
                this.fuzzySearchItemsTotal = workerData.data.total;
                this.fuzzySearchItems = workerData.data.items;
                this.items = this.listElement.getElements('li');
                this.items.addEvent(Affinity.events.click, this.itemClicked);

                window.fireEvent('elementChanged', { element: this.selectElement });

                break;

            case 'doSearch':

                var returnData = [];

                if (this.listElement.getElements('li')) {
                    this.listElement.getElements('li').removeEvent(Affinity.events.click, this.itemClicked);
                }

                this.listElement.innerHTML = workerData.html;

                if (workerData.bestguess) {
                    this.bestguess = document.id(workerData.bestguess);
                }

                if (this.iconElement) {
                    this.iconElement.removeClass('working');
                }

                this.items = this.listElement.getElements('li');
                this.items.addEvent(Affinity.events.click, this.itemClicked);

                break;

        }
    },

    cleanDisplay: function (str) {
        if (typeOf(str) === 'string' && str.trim() !== '') {
            var result = str.split(',').filter(function (val) { return val !== ''; }).join(', ');
            return result.trim().replace(/&amp;/gi, '&');
        }
        return str;
    },

    getValue: function () {
        return this.selectElement.value;
    },

    setValue: function (value, fireEvents) {
        fireEvents = fireEvents || true;
        value = this.cleanDisplay(value);
        if (typeOf(this.listElement) !== 'null') {
            if (this.searchMode) {
                if (this.datalistElement.getElement('option[value=' + value + ']')) {
                    this.displayElement.value = value;
                    this.mobileChange();
                }
            } else {
                if (!value || value === '' || typeOf(this.fuzzySearchItems) === 'null' || this.fuzzySearchItems === false) {
                    this.itemClicked({ target: this.listElement.getElement('li'), fireEvents: fireEvents });
                    return;
                }
                var element = false;

                // TODO: Web Worker here

                for (var i = 0; i < this.fuzzySearchItems.length; i++) {
                    if (this.fuzzySearchItems[i].value + '' === value + '') {
                        element = document.id(this.fuzzySearchItems[i].id);
                        break;
                    }
                }
                if (element) {
                    this.itemClicked({ target: element, fireEvents: fireEvents });
                } else {
                    this.itemClicked({ target: this.listElement.getElement('li'), fireEvents: fireEvents });
                }
            }
        }
    },

    getDisplayValue: function () {
        return this.cleanDisplay(this.displayElement.value);
    },

    /* NOTE: Now uses 'Auto Close Handlers'
    mouseIsOver: false,
    dontClose: false,
    */
    status: 'closed',

    /** SEARCH MODE **/

    searchMode_firstPass: true,
    searchMode_lastKnownValue: '',
    searchMode_fireChangeEvents: function (force) {
        this.changed = typeOf(force) === 'boolean' && force === true ? true : false;
        if (this.defaultChangeValue !== this.selectElement.value) {
            this.defaultChangeValue = this.selectElement.value;
            this.changed = true;
        }
        if (!this.searchMode_firstPass && this.changed && this.searchMode_lastKnownValue === this.selectElement.value) {
            this.changed = false;
        }
        if (this.changed) {
            this.defaultChangeValue = this.selectElement.value;
            if (this.selectElement.get('onChange') || this.selectElement.get('onchange')) {
                this.selectElement.onChange();
            } else {
                this.selectElement.fireEvent('change', { target: this.selectElement });
            }
            window.fireEvent('elementChanged', { element: this.selectElement, callee: 'autocomplete search mode' });
        }
        this.searchMode_firstPass = false;
    },

    searchMode_valueToOption: function (value, label, forceEvent) {
        forceEvent = forceEvent || false;
        if (this.selectElement.retrieve('data-store') && this.selectElement.retrieve('data-key')) { // is a lookup or dependency, so empty select as this will re load later, otherwise leave the list that existed at render time
            this.selectElement.empty();
            new Element('option', { value: value, html: label }).inject(this.selectElement);
            this.selectElement.value = value;
            this.selectElement.selectedIndex = 0;
        } else {
            this.selectElement.value = value;
            var options = this.selectElement.getElements('options');
            for (var i = 0; i < options.length; i++) {
                if (options[i].value === value) {
                    this.selectElement.selectedIndex = i;
                    break;
                }
            }
        }
        this.displayElement.value = value;
        this.displayElement.store('data-search-value', value);
        this.searchMode_fireChangeEvents(forceEvent);
    },

    searchMode_iconClicked: function () {

        var searchFor = this.cleanDisplay(this.displayElement.value);

        if (
            (!Affinity.mobile && searchFor.trim() !== '' && searchFor.length > 1) ||
            Affinity.mobile
        ) {

            var select = new Element('select', { 'class': 'override ui-autocomplete-center hidden' });
            var loader = new Element('span', { 'html': 'Loading list <img src="' + Affinity.loaders.dark + '" />' });

            uialert({
                message: 'Set Value<br /><br />',
                showButtons: true,
                showCancel: true,
                canClose: !Affinity.mobile,
                position: {
                    position: 'fixed',
                    top: 10
                },
                onOk: function () {

                    var select = document.id('UIPromtBox').getElement('select'),
                        selectedIndex = select.selectedIndex || 0,
                        options = select.getElements('option'),
                        option = options[selectedIndex],
                        value = option.get('value');

                    this.searchMode_valueToOption(option.get('value'), option.get('html'), true);

                    if (select.getWidget()) {
                        select.getWidget().destroy();
                    }
                    select.destroy();
                }.bind(this),
                onCancel: function () {
                    if (select.getWidget()) {
                        select.getWidget().destroy();
                    }
                    select.destroy();
                },
                onClose: function () {
                    if (select.getWidget()) {
                        select.getWidget().destroy();
                    }
                    select.destroy();
                }
            });

            Affinity.prompts.adopt(loader);
            Affinity.prompts.hideButtons();

            (function () {

                if (this.selectElement.retrieve('data-store') && this.selectElement.retrieve('data-key')) { // we need to go fetch or use the data store from lookups or dependencies store

                    var option;
                    var apiStore = this.selectElement.retrieve('data-store');
                    var apiKey = this.selectElement.retrieve('data-key');
                    var api = Affinity.UI[apiStore][apiKey].api;
                    api = api.contains('limit') ? api.substr(0, api.indexOf('limit') - 1) : api

                    if (Affinity.UI[apiStore][apiKey].data.length === 0) {

                        new Request.JSONP({
                            callbackKey: 'jsoncallback',
                            url: api,
                            method: 'get',
                            timeout: 30000,
                            onComplete: function (jsonData) {
                                if (!JSON.Unauthorized(jsonData, Affinity.UI[apiStore][apiKey].id + ', lookup massive loader')) {
                                    if ('error' in jsonData) {
                                        loader.set('html', 'Failed loading list. Please refresh and try again.');
                                    } else {

                                        if (typeOf(jsonData) === 'array' && jsonData.length > 0) {

                                            Affinity.UI[apiStore][apiKey].data = jsonData;
                                            Affinity.UI[apiStore][apiKey].loaded = true;

                                            if (this.useWebWorkers) {

                                                this.massiveSelect = select;
                                                this.massiveLoader = loader;
                                                this.fuzzyWorker.postMessage({ job: 'getOptions', data: Affinity.UI[apiStore][apiKey].data, searchFor: searchFor, ismobile: Affinity.mobile });

                                            } else {

                                                Array.each(Affinity.UI[apiStore][apiKey].data, function (dataPair) {
                                                    if (dataPair.Value.toLowerCase().indexOf(searchFor.toLowerCase()) > -1 || Affinity.mobile) {
                                                        option = new Element('option', {
                                                            'value': dataPair.Key,
                                                            'html': this.cleanDisplay(dataPair.Value)
                                                        }).inject(select);
                                                        if (dataPair.Value === searchFor) {
                                                            option.set('selected', 'selected');
                                                        }
                                                    }
                                                }.bind(this));
    
                                                Affinity.prompts.adopt(select);
                                                select.removeClass('hidden');
    
                                                new UIAutoCompleteWidget({
                                                    selectElement: select,
                                                    onComplete: function (w) {
                                                        loader.destroy();
                                                        Affinity.prompts.center();
                                                        Affinity.prompts.showButtons();
                                                        Affinity.prompts.show();
                                                        w.position();
                                                        if (Affinity.oldess)
                                                            Affinity.oldessWindow.scrollTo(0, 0);
                                                    }
                                                });

                                            }

                                        }

                                    }
                                }
                            }.bind(this),
                            onError: function (error) {
                                loader.set('html', 'Failed loading list. Please refresh and try again.');
                                Affinity.prompts.showButtons();
                            }.bind(this),
                            onFailure: function (xhr) {
                                loader.set('html', 'Failed loading list. Please refresh and try again.');
                                Affinity.prompts.showButtons();
                            }.bind(this),
                            onTimeout: function () {
                                loader.set('html', 'List loader timed out. Please refresh and try again.');
                                Affinity.prompts.showButtons();
                            }.bind(this)
                        }).send();

                    } else {

                        if (this.useWebWorkers) {

                            this.massiveSelect = select;
                            this.massiveLoader = loader;
                            this.fuzzyWorker.postMessage({ job: 'getOptions', data: Affinity.UI[apiStore][apiKey].data, searchFor: searchFor, ismobile: Affinity.mobile });

                        } else {

                            Array.each(Affinity.UI[apiStore][apiKey].data, function (dataPair) {
                                if (dataPair.Value.toLowerCase().indexOf(searchFor.toLowerCase()) > -1 || Affinity.mobile) {
                                    option = new Element('option', {
                                        'value': dataPair.Key,
                                        'html': this.cleanDisplay(dataPair.Value)
                                    }).inject(select);
                                    if (dataPair.Value === searchFor) {
                                        option.set('selected', 'selected');
                                    }
                                }
                            }.bind(this));
    
                            Affinity.prompts.adopt(select);
                            select.removeClass('hidden');
    
                            new UIAutoCompleteWidget({
                                selectElement: select,
                                onComplete: function (w) {
                                    loader.destroy();
                                    Affinity.prompts.center();
                                    Affinity.prompts.showButtons();
                                    Affinity.prompts.show();
                                    w.position();
                                    if (Affinity.oldess)
                                        Affinity.oldessWindow.scrollTo(0, 0);
                                }
                            });

                        }

                    }

                } else { // even though we are in massive mode, we are not a lookup. Select options are provided on page at render, so just grab what we need from the original select.

                    if (this.useWebWorkers) {

                        this.massiveSelect = select;
                        this.massiveLoader = loader;
                        this.fuzzyWorker.postMessage({ job: 'getOptions', data: Affinity.UI[apiStore][apiKey].data, searchFor: searchFor, ismobile: Affinity.mobile });

                    } else {

                        var val;
                        Array.each(this.selectElement.getElements('option'), function (option) {
                            if (option.get('html').stripTags().toLowerCase().indexOf(searchFor.toLowerCase()) > -1 || Affinity.mobile) {
                                option = new Element('option', {
                                    'value': option.get('value') ? option.get('value') : option.get('html').stripTags(),
                                    'html': this.cleanDisplay(option.get('html'))
                                }).inject(select);
                                if (option.get('html') === searchFor) {
                                    option.set('selected', 'selected');
                                }
                            }
                        }.bind(this));

                        Affinity.prompts.adopt(select);
                        select.removeClass('hidden');

                        new UIAutoCompleteWidget({
                            selectElement: select,
                            onComplete: function (w) {
                                loader.destroy();
                                Affinity.prompts.center();
                                Affinity.prompts.showButtons();
                                Affinity.prompts.show();
                                w.position();
                                if (Affinity.oldess)
                                    Affinity.oldessWindow.scrollTo(0, 0);
                            }
                        });

                    }

                }

            }).delay(300, this);

        } else if (searchFor.trim() !== '' && searchFor.length === 1) {
            uialert({
                message: 'You must enter more than 1 character',
                showButtons: true
            });
        } else {
            uialert({
                message: 'You must enter a search term',
                showButtons: true
            });
        }

    },

    searchMode_displayBlur: function () {
        var searchFor = this.cleanDisplay(this.displayElement.value);
        var value = this.displayElement.retrieve('data-search-value');
        if (value === '' || searchFor !== value) {
            value = searchFor;
        }
        if (this.selectElement.retrieve('data-store') && this.selectElement.retrieve('data-key')) { // is a lookup or dependency, so empty select as this will re load later, otherwise leave the list that existed at render time
            this.selectElement.empty();
            this.searchMode_valueToOption(value, searchFor);
        }
    },

    /****/

    updateOptions: function () {
        this.clearList();
        this.processOptions();
    },

    processCount: 0,
    processOptions: function () {

        if (typeOf(this.selectElement) === 'null' || !this.selectElement || !('getElements' in this.selectElement)) {
            // console.log('There is no select element', this);
            return;
        }

        //this.processCount++;
        //console.log(this.uuid, this.processCount);

        var options = this.selectElement.getElements('option');

        if (options.length > Affinity.selectmax || this.selectElement.hasClass('massive')) {
            this.searchMode = true;
        }

        if (this.searchMode && this.selectElement.hasClass('override')) {
            this.searchMode = false;
        }

        var buildNewDisplay = true;
        var buildNewIcon = true;

        var __uuidCheck;

        if (this.searchMode) {

            /** SEARCH MODE **/

            /* display element */

            __uuidCheck = this.uuid;
            if (Affinity.UI.lastAutoKill[__uuidCheck]) {
                if (document.getElement('.' + Affinity.UI.lastAutoKill[__uuidCheck].killid)) {
                    clearTimeout(Affinity.UI.lastAutoKill[__uuidCheck].destroy);
                    this.displayElement = document.getElement('.' + Affinity.UI.lastAutoKill[__uuidCheck].killid).removeClass(Affinity.UI.lastAutoKill[__uuidCheck].killid).set('id', __uuidCheck + '-Display').inject(this.hiddenWrapper, 'before');
                    this.displayElement.destroyWidget('elementWidget');
                    this.displayElement.removeEvents();
                    buildNewDisplay = false;
                }
                Affinity.UI.lastAutoKill[__uuidCheck] = null;
                delete Affinity.UI.lastAutoKill[__uuidCheck];
            }
            if (buildNewDisplay) {
                this.displayElement = new Element('input', { 'type': 'text', 'class': 'ui-autocomplete-display', 'id': __uuidCheck + '-Display' }).inject(this.hiddenWrapper, 'before');
            }
            this.displayElement.addClass(this.killid);

            /* icon / loader element */

            __uuidCheck = this.uuid + '_icon';
            if (Affinity.UI.lastAutoKill[__uuidCheck]) {
                if (document.getElement('.' + Affinity.UI.lastAutoKill[__uuidCheck].killid)) {
                    clearTimeout(Affinity.UI.lastAutoKill[__uuidCheck].destroy);
                    this.iconElement = document.getElement('.' + Affinity.UI.lastAutoKill[__uuidCheck].killid).removeClass(Affinity.UI.lastAutoKill[__uuidCheck].killid).set('id', __uuidCheck + '-Display-Icon').inject(this.hiddenWrapper, 'before');
                    this.iconElement.removeEvents();
                    buildNewIcon = false;
                }
                Affinity.UI.lastAutoKill[__uuidCheck] = null;
                delete Affinity.UI.lastAutoKill[__uuidCheck];
            }
            if (buildNewIcon) {
                this.iconElement = new Element('span', { 'class': 'ui-autocomplete-display-icon searchmode', 'id': __uuidCheck + '-Display-Icon', 'html': Affinity.icons.Search }).inject(this.displayElement, 'after');
            }
            this.iconElement.addClass(this.killid + '_icon');
            this.iconElement.removeClass('loading');

            if (this.selectElement.hasClass('massive') && this.selectElement.retrieve('data-store') && this.selectElement.retrieve('data-key')) {
                this.displayElement.addEvent('blur', this.searchMode_displayBlur);
                this.iconElement.addEvent(Affinity.events.click, this.searchMode_iconClicked);
                this.searchMode_valueToOption(this.selectElement.retrieve('data-value'), this.selectElement.retrieve('data-label'));
            }

            /* SUPPORT CLEVER FORMS AND OTHER STANDALONE IMPLEMENTATIONS */

            if (!this.selectElement.hasClass('massive')) {
                this.selectElement.addClass('massive');
                this.displayElement.addEvent('blur', this.searchMode_displayBlur);
                this.iconElement.addEvent(Affinity.events.click, this.searchMode_iconClicked);
                if (this.selectElement.retrieve('data-store') && this.selectElement.retrieve('data-key')) {
                    this.searchMode_valueToOption(this.selectElement.retrieve('data-value'), this.selectElement.retrieve('data-label'));
                } else {
                    if (options.length > 0) {
                        var sindex = this.selectElement.selectedIndex && this.selectElement.selectedIndex > 0 ? this.selectElement.selectedIndex : 0;
                        this.searchMode_valueToOption(options[sindex].get('value') || '', options[sindex].get('html'));
                    }
                }
            }

            this.selectElement.set('data-display-id', this.uuid + '-Display');

            /**/

            this.fireEvent('complete', this);

        } else {

            if (!this.displayElement) {

                /* display element */

                __uuidCheck = this.uuid;
                if (Affinity.UI.lastAutoKill[__uuidCheck]) {
                    if (document.getElement('.' + Affinity.UI.lastAutoKill[__uuidCheck].killid)) {
                        clearTimeout(Affinity.UI.lastAutoKill[__uuidCheck].destroy);
                        this.displayElement = document.getElement('.' + Affinity.UI.lastAutoKill[__uuidCheck].killid);
                        this.displayElement.removeClass(Affinity.UI.lastAutoKill[__uuidCheck].killid).set('id', __uuidCheck + '-Display').cloneEvents(this.selectElement);
                        this.displayElement.destroyWidget('elementWidget');
                        this.displayElement.removeEvents();
                        buildNewDisplay = false;
                    }
                    Affinity.UI.lastAutoKill[__uuidCheck] = null;
                    delete Affinity.UI.lastAutoKill[__uuidCheck];
                }
                if (buildNewDisplay) {
                    this.displayElement = new Element('input', { 'type': 'text', 'class': 'ui-autocomplete-display', 'id': this.uuid + '-Display' }).cloneEvents(this.selectElement).inject(this.hiddenWrapper, 'before');
                }
                this.displayElement.addClass(this.selectElement.get('class'));
                this.displayElement.addClass(this.killid);

                /* icon / loader element */

                __uuidCheck = this.uuid + '_icon';
                if (Affinity.UI.lastAutoKill[__uuidCheck]) {
                    if (document.getElement('.' + Affinity.UI.lastAutoKill[__uuidCheck].killid)) {
                        clearTimeout(Affinity.UI.lastAutoKill[__uuidCheck].destroy);
                        this.iconElement = document.getElement('.' + Affinity.UI.lastAutoKill[__uuidCheck].killid).removeClass(Affinity.UI.lastAutoKill[__uuidCheck].killid).set('id', __uuidCheck + '-Display-Icon').inject(this.hiddenWrapper, 'before');
                        this.iconElement.removeEvents();
                        buildNewIcon = false;
                    }
                    Affinity.UI.lastAutoKill[__uuidCheck] = null;
                    delete Affinity.UI.lastAutoKill[__uuidCheck];
                }
                if (buildNewIcon) {
                    this.iconElement = new Element('span', { 'class': 'ui-autocomplete-display-icon', 'id': __uuidCheck + '-Display-Icon', 'html': this.icons.search }).inject(this.displayElement, 'after');
                }
                this.iconElement.addClass(this.killid + '_icon');
                this.iconElement.removeClass('loading');

                /**/

                this.displayElement.makeFormElement();
                this.displayElement.addClass('widget');
                this.displayElement.store('widget', this);

                if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1) {
                    this.displayElement.set('autocomplete', 'off');
                }

                if (this.selectElement.hasClass('has-message-icon')) {
                    this.displayElement.addClass('has-message-icon');
                }

                this.selectElement.set('data-display-id', this.uuid + '-Display');

                this.listElement = new Element('ul', { 'class': 'ui-autocomplete-list', 'id': this.domid }).inject(document.body, 'bottom');

                if (this.autowidth) {
                    this.listElement.addClass('auto-width');
                }

                /* SMART CLOSE */

                if (Affinity.mobile) {

                    window.addEvent('mobileback', function () {
                        this.hide();
                    }.bind(this));

                } else {

                    new Affinity.SmartClose(this.displayElement);
                    new Affinity.SmartClose(this.listElement);

                    this.displayElement.addEvent('SmartClose', function () {
                        if (!this.listElement.isOver()) {
                            this.hide();
                        }
                    }.bind(this));

                    this.listElement.addEvent('SmartClose', function () {
                        if (!this.displayElement.isOver()) {
                            this.hide();
                        }
                    }.bind(this));

                }

                /**/

                if (this.displayElement.hasClass('width-auto') || this.displayElement.hasClass('width-full')) {
                    this.listElement.setStyle('width', this.displayElement.getSize().x);
                }

                this.listElement.set('tween', { duration: 100 });
                this.listElement.fade('hide');

                this.displayElement.addEvent('focus', this.doFocus);

                this.listElement.set('tween', {
                    duration: 100,
                    onComplete: function (el) {
                        if (el.getStyle('opacity') === 0) {
                            el.addClass('hidden');
                        } else {
                            el.removeClass('hidden');
                        }
                    }
                });
                this.listElement.fade('hide');

            } else {

                this.listElement.empty();

            }

            /**/

            var html, li;

            this.items = [];
            this.fuzzySearchItems = [];

            var defaultSelected = null;
            this.defaultValue = null;

            if (this.useWebWorkers) {

                if (this.iconElement) {
                    this.iconElement.addClass('working');
                }

                this.fuzzyWorker.postMessage({
                    job: 'getList',
                    html: this.selectElement.innerHTML,
                    defaultValue: this.selectElement.get('data-default-value') || false,
                    uuid: this.uuid
                });

            } else {

                Array.each(this.selectElement.getElements('option'), function (option, index) {
                    html = this.cleanDisplay(option.get('html'));
                    value = option.get('value');
                    li = new Element('li', { 'html': html, 'data-value': value, 'class': 'visible', 'id': this.uuid + '-li-' + index });
                    li.set('data-index', index);
                    li.set('data-value', value);
                    li.addEvent(Affinity.events.click, this.itemClicked);
                    li.inject(this.listElement);
                    if (option.selected) {
                        defaultSelected = li;
                        this.defaultValue = li;
                        li.addClass('selected');
                        this.lastSelected = li;
                        this.defaultChangeValue = option.value;
                    }
                    this.items.push(li);
                    this.fuzzySearchItems.push({
                        //element: li,
                        id: this.uuid + '-li-' + index,
                        html: html,
                        klass: 'visible',
                        searchstr: html,
                        value: option.value
                    });
                }.bind(this));

                this.continueProcessOptsions(defaultSelected);
            }

        }
     },

    continueProcessOptsions: function (defaultSelected) {

        if (!this.searchMode) {

            if (!this.useWebWorkers) {
                this.fuzzySearchItemsTotal = this.fuzzySearchItems.length;
            }
            if (this.iconElement) {
                this.iconElement.removeClass('working');
            }
            this.fuzzySearchLargeDataDelay = false;
            //if (this.fuzzySearchItemsTotal >= 1000 && this.fuzzySearchItemsTotal < 2000) {
            if (true) {
                this.fuzzySearchLargeDataDelay = 100;
            }
            if (this.fuzzySearchItemsTotal >= 2000 && this.fuzzySearchItemsTotal < 3000) {
                this.fuzzySearchLargeDataDelay = 250;
            }
            if (this.fuzzySearchItemsTotal >= 3000 && this.fuzzySearchItemsTotal < 5000) {
                this.fuzzySearchLargeDataDelay = 500;
            }
            if (this.fuzzySearchItemsTotal >= 5000) {
                this.fuzzySearchLargeDataDelay = 1000;
            }
            if (Affinity.isie && Affinity.ieversion === 11) {
                this.fuzzySearchLargeDataDelay = 1001;
            }

            if (this.defaultValue === null) {
                this.defaultValue = this.listElement.getElement('li');
            }

            /**/

            this.keyHeldCheck = false;
            this.keyHeld = false;
            this.keyHeldDelay = null;

            this.displayElement.addEvent('keyup', this.doKeyUp);
            this.displayElement.addEvent('keydown', this.doKeyDown);

            /**/

            if (defaultSelected !== null) {
                this.defaultSelected({ target: defaultSelected });
            }

            /**/

            this.fireEvent('complete', this);

            /**/

            /* this should only call 'change' IF it has changed, otherwise, don't but  */
            /* because I do not know the impact this will have, just change anyway     */
            /*
            if (this.selectElement.value !== this.defaultChangeValue) {
                this.defaultChangeValue = this.selectElement.value;
                this.changed = true;
                this.selectElement.fireEvent('change');
            } else {
                this.changed = false;
            }
            */
            if (this.selectElement.value !== this.defaultChangeValue) {
                this.defaultChangeValue = this.selectElement.value;
                this.changed = true;
            } else {
                this.changed = false;
            }
            if (this.options.stopInitialChange) {
                this.selectElement.fireEvent('change', { target: this.selectElement });
            }

            /**/

            this.checkExistsPeriodical = this.checkExists.periodical(1000, this);

        }

        if (this.displayElement) {
            this.valuetracker.addElement(this.displayElement);
        }

    },

    stopEvent: function (e) {
        e.stop();
    },

    /**/

    reset: function () {
        if (!this.searchMode) {
            var select = false;
            if (typeOf(this.defaultValue) !== 'null' && this.defaultValue && this.defaultValue.get('tag') === 'li') {
                select = this.defaultValue;
            }
            if (typeOf(this.lastSelected) !== 'null' && this.lastSelected && this.lastSelected.get('tag') === 'li') {
                select = this.lastSelected;
            }
            Array.each(this.items, function (li, index) {
                li.inject(this.listElement);
                li.removeClass('selected');
                li.removeClass('hidden');
                li.addClass('visible');
                if (!this.fuzzySearchLargeDataDelay) {
                    li.set('html', this.cleanDisplay(li.get('html').stripTags()));
                }
                if (select && li === select) {
                    li.addClass('selected');
                    this.listElement.scrollTo(0, li.getPosition(this.listElement).y - 5);
                    this.displayElement.value = this.cleanDisplay(select.get('html').stripTags());
                }
            }.bind(this));
        }
    },

    checkExists: function () {
        if (!document.contains(this.selectElement)) {
            clearInterval(this.checkExistsPeriodical);
            this.destroy();
        }
    },

    /** EVENT FUNCTIONS **/

    doFocusDelay: false,
    doFocus: function () {
        clearTimeout(this.doFocusDelay);
        this.doFocusDelay = (function () {
            // console.log('displayElement focus : autocomplate ' + this.uuid + ' : ' + (this.mouseIsOver ? 'is over' : 'is NOT over'));
            if (this.status == 'closed') {
                this.show('displayElement focus');
            }
        }.delay(100, this));

        if (Affinity.mobile) {
            this.displayElement.selectionStart = 0;
            this.displayElement.selectionEnd = 999999;
        }

    },

    doClick: function (e) {
        this.stopEvent(e);
        this.displayElement.select();
    },

    doKeyUp: function (e) {
        if (e.key == 'tab' || e.shift) {
            return;
        }
        if (e.key == 'tab') {
            this.hide('on key up tab');
        }
        clearTimeout(this.keyHeldDelay);
        if (!this.keyHeld) {
            this.elementKeyUp(e);
        }
        this.keyHeld = false;
        this.keyHeldCheck = false;
    },

    doKeyDown: function (e) {
        if (e.key == 'tab') {
            this.hide('on key down tab');
        }
        //if (e.key == 'tab' || e.shift) {
        if (e.key == 'tab') {
            return;
        }
        if (e.key == 'enter') {
            this.stopEvent(e);
            return;
        }
        if (e.key == 'down' || e.key == 'up') {
            if (this.keyHeldCheck || this.keyHeld) {
                this.stopEvent(e);
                return;
            }
            if (!this.keyHeldCheck && !this.keyHeld) {
                this.keyHeldCheck = true;
                this.keyHeldDelay = this.elementKeySetHeld.delay(500, this, [e]);
            }
        }
    },

    /**/

    elementKeySetHeld: function (e) {

        this.keyHeld = true;
        this.elementKeyUp(e);

    },

    getTopVisibleElement: function () {

        var items = this.listElement.getElements('li.visible');
        var i, li, pos;

        for (i = 0; i < items.length; i++) {

            li = items[i];

            pos = li.getPosition(this.listElement);

            if (pos.y > 0) {

                return li;

            }

        }

    },

    getBottomVisibleElement: function () {

        var height = this.listElement.getSize().y;
        var items = this.listElement.getElements('li.visible');
        var i, li, pos;

        for (i = items.length - 1; i > 0; i--) {

            li = items[i];

            pos = li.getPosition(this.listElement);

            if (pos.y < height) {

                return li;

            }

        }

    },

    scrollToTop: function (li) {

        var scroll = this.listElement.getScroll().y;
        var pos = li.getPosition(this.listElement).y;
        var size = li.getSize().y;

        if (pos < 0) {

            this.listElement.scrollTo(0, (scroll + pos) - size + 10);

        }

    },

    scrollToBottom: function (li) {

        var scroll = this.listElement.getScroll().y;
        var height = this.listElement.getSize().y;
        var pos = li.getPosition(this.listElement).y;
        var size = li.getSize().y;

        if (pos > (height - size)) {

            this.listElement.scrollTo(0, scroll + (pos - height) + size + 5);

        }

    },

    escapeRegExp: function (str) {

        return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");

    },
    
    //fuzzyWorker: false,
    fuzzyRunning: false,
    fuzzySearch: function (searchData, searchKey, searchFor, target) {
        if (this.fuzzyRunning) {
            return;
        }

        this.fuzzyRunning = true;

        var returnData = [],
            workerData, element;

        if (this.useWebWorkers) {

            this.fuzzyDoSearchData = {
                searchData: searchData,
                target: target
            };

            if (this.iconElement) {
                this.iconElement.addClass('working');
            }

            this.fuzzyWorker.postMessage({
                job: 'doSearch',
                data: searchData,
                searchKey: searchKey,
                searchFor: searchFor,
                perfDelay: this.fuzzySearchLargeDataDelay
            });

        } else {

            var results = [];
            var data, element;
            var score, wordScore, wordScores, searchIn, isMatch, hasMatch, totalWordsToSearch, totalWordMatch;
            var searchForWords, searchInWords, soundexFor, soundexIn, soundexScore;
            var html;

            if (!isNaN(searchFor)) {

                Array.each(searchData, function (data, index) {
                    element = document.id(data.id);
                    if (data[searchKey].contains(searchFor)) {
                        wordScore = data[searchKey].split(searchFor).length - 1 || 0;
                        searchInWords = data[searchKey].split(' ');
                        results.push({
                            originalIndex: index,
                            score: wordScore,
                            wordScore: wordScore / searchInWords
                        });
                        element.removeClass('hidden').addClass('visible');
                    } else {
                        element.addClass('hidden').removeClass('visible');
                    }
                });

            } else {

                Array.each(searchData, function (dataItem, index) {
                    element = document.id(dataItem.id);
                    score = 0;
                    wordScores = [];
                    searchFor = searchFor.toLowerCase();
                    searchIn = dataItem[searchKey].toLowerCase().trim();
                    isMatch = searchFor === searchIn;
                    hasMatch = searchIn.indexOf(searchFor) > -1 ? true : false;

                    searchForWords = searchFor.split(' ');
                    totalWordsToSearch = searchForWords.length;

                    if (isMatch) {

                        totalWordMatch = totalWordsToSearch;
                        wordScore = 99999;
                        score = 99999;

                        if (this.fuzzySearchLargeDataDelay) {
                            element.removeClass('hidden').addClass('visible');
                        } else {
                            html = '<strong>' + this.cleanDisplay(element.get('html').stripTags()) + '</strong>';
                            element.set('html', html).removeClass('hidden').addClass('visible');
                        }

                    } else if (!isMatch && hasMatch) {

                        totalWordMatch = searchIn.split(searchFor).length - 1 || 0;

                        wordScore = totalWordMatch;
                        score = wordScore + 100;

                        if (this.fuzzySearchLargeDataDelay) {
                            element.removeClass('hidden').addClass('visible');
                        } else {
                            html = this.cleanDisplay(element.get('html').stripTags()).replace(new RegExp('(' + this.escapeRegExp(searchFor) + ')', 'gi'), "<strong>$1</strong>");
                            element.set('html', html).removeClass('hidden').addClass('visible');
                        }

                    } else {

                        if (this.fuzzySearchLargeDataDelay < 1001) {

                            searchInWords = searchIn.split(' ');
                            totalWordMatch = 0;
                            Array.each(searchForWords, function (searchForWord) {
                                Array.each(searchInWords, function (searchInWord) {
                                    if (searchForWord != ' ' && searchForWord != '') {
                                        soundexFor = searchForWord.soundex();
                                        soundexIn = searchInWord.soundex();
                                        soundexScore = soundexFor.distance(soundexIn);
                                        if (soundexScore == 0) {
                                            totalWordMatch += 1;
                                        }
                                    }
                                });
                            });
                            score = totalWordMatch;
                            wordScore = Number.round(totalWordMatch / totalWordsToSearch, 2) || 0;

                            if (score >= 0) {

                                if (this.fuzzySearchLargeDataDelay) {
                                    element.removeClass('hidden').addClass('visible');
                                } else {
                                    html = this.cleanDisplay(element.get('html').stripTags());
                                    element.set('html', html).removeClass('hidden').addClass('visible');
                                }

                            }

                        }

                    }
                    data = {
                        originalIndex: index,
                        score: score,
                        wordScore: wordScore
                    };
                    results.push(data);

                }.bind(this));

            }

            results.sort(function (a, b) {
                if (parseFloat(a.score) === parseFloat(b.score)) {
                    return parseFloat(a.wordScore) < parseFloat(b.wordScore) ? 1 : -1;
                }
                return parseFloat(a.score) < parseFloat(b.score) ? 1 : -1;
            });

            var gotone = false;
            Array.each(results, function (result) {
                data = searchData[result.originalIndex];
                data.score = result.score;
                data.wordScore = result.wordScore;
                returnData.push(data);
                element = document.id(data.id);
                if (result.score > 0) {
                    element.inject(target);
                    gotone = true;
                } else {
                    element.addClass('hidden').removeClass('visible');
                }
            });

            if (!gotone && results.length > 0 && results[0].originalIndex && searchData[results[0].originalIndex] && searchData[results[0].originalIndex].id) {
                this.bestguess = document.id(searchData[results[0].originalIndex].id);
            }
        }

        this.fuzzyRunning = false;

        return returnData;

    },

    elementKeyUp: function (e) {

        var compstr = this.cleanDisplay(this.displayElement.value.toLowerCase());
        var selected = this.listElement.getElement('li.visible.selected') || false;

        if (e.key == 'enter' && selected) {
            this.stopEvent(e);
            this.itemClicked({ target: selected });
            return;
        }

        if (e.key == 'down' || e.key == 'up') {

            if (this.status == 'closed') {
                this.show();
            }

            e.preventDefault();

            if (e.key == 'down') {
                this.elementDown(e);
            }

            if (e.key == 'up') {
                this.elementUp(e);
            }

            if (this.keyHeld) {
                this.elementKeyUp.delay(50, this, [e]);
            }

            return;

        }

        if (
            (e.code === 8) || // backspace
            (e.code === 16) || // shift
            (e.code === 32) || // delete
            (e.code === 46) || // space
            (e.code >= 48 && e.code <= 57) || // a-z upper
            (e.code >= 65 && e.code <= 90) || // a-z lower
            (e.code >= 96 && e.code <= 105) // num pad
        ) {

            if (this.status == 'closed') {
                this.show();
            }

            /* search when key pressed is space, backspace, delete, a-z, 0-9 or num pad 0-9 */

        } else {

            return;

        }

        if (compstr === '') {

            if (this.useWebWorkers) {

                this.fuzzyWorker.postMessage({ job: 'resetList' });

            } else {

                Array.each(this.items, function (li, index) {
                    li.inject(this.listElement);
                    li.set('html', this.cleanDisplay(li.get('html').stripTags()));
                    li.removeClass('selected').removeClass('hidden').addClass('visible');
                    if (li.get('html').trim() === '') {
                        li.addClass('selected');
                        if (selected !== li) {
                            this.changed = true;
                        }
                        this.lastSelected = li;
                        this.defaultValue = li;
                        this.selectElement.value = '';
                        this.selectElement.selectedIndex = 0;
                        this.listElement.scrollTo(0, 0);
                        this.defaultChangeValue = this.selectElement.getElements('option')[0].value;
                    }
                }.bind(this));

                this.bestguess = this.defaultValue;

                window.fireEvent('elementChanged', { element: this.selectElement });

            }

            return;

        }

        /* filter search */

        this.listElement.getElements('li').removeClass('selected');

        this.listElement.scrollTo(0, 0);

        /* FUZZY SEARCH */

        if (selected) {
            this.lastSelected = selected;
        }

        if (this.fuzzySearchLargeDataDelay) {
            clearTimeout(this.fuzzySearchDelay);
            this.fuzzySearchDelay = this.continueWithFuzzySearch.delay(this.fuzzySearchLargeDataDelay, this);
        } else {
            this.continueWithFuzzySearch();
        }

        /* OLD SEARCH *

        var sortdata = [];
        var compwith, i, html, score;

        Array.each(this.items, function (li, index) {

            html = li.get('html').stripTags();

            li.set('html', html);

            score = 0;

            compwith = html.toLowerCase();

            li.addClass('hidden');
            li.removeClass('visible');

            if (compwith != '' && compwith.indexOf(compstr) > -1) {

                html = html.replace(new RegExp('(' + this.escapeRegExp(compstr) + ')', 'gi'), "<b>$1</b>");

                li.set('html', html);

                score = Math.round((compstr.length / compwith.length) * compwith.length) * 100;

                if (compwith.indexOf(compstr) === 0) {
                    score += 100;
                }

                sortdata.push([score, li]);

                li.removeClass('hidden');
                li.addClass('visible');

            }

        }.bind(this));

        sortdata.sort(function (a, b) {
            return a[0] - b[0];
        });

        for (i = 0; i < sortdata.length; i++) {
            sortdata[i][1].inject(this.listElement, 'top');
        }

        if(sortdata.length>0){
            this.bestguess = sortdata[0][1];
        }

        /**/

        this.position();

    },

    continueWithFuzzySearch: function () {
        var result = this.fuzzySearch(this.fuzzySearchItems, 'searchstr', this.cleanDisplay(this.displayElement.value.toLowerCase()), this.listElement);
        this.position();
    },

    elementUp: function () { /* keypress - up arrow */

        if (this.listElement.getElements('li.visible').length === 0) {
            this.hide('elementUp with empty list');
            return;
        }

        var selected = this.listElement.getElement('li.visible.selected');
        var topElement = this.getTopVisibleElement();
        var bottomElement = this.getBottomVisibleElement();
        var index = -1;
        var items = this.listElement.getElements('li.visible');

        if (selected) { /* previous item has been selected */
            index = items.indexOf(selected);
            selected.removeClass('selected');
        }

        if (index > items.indexOf(bottomElement)) {
            if (bottomElement && 'addClass' in bottomElement) {
                bottomElement.addClass('selected');
            }
        } else {
            if (index > 0) {
                if (items[index - 1] && 'addClass' in items[index - 1]) {
                    items[index - 1].addClass('selected');
                    this.scrollToTop(items[index - 1]);
                }
            } else {
                if (this.listElement.scrollHeight == this.listElement.clientHeight) {
                    if (bottomElement && 'addClass' in bottomElement) {
                        bottomElement.addClass('selected');
                    }
                } else {
                    if (topElement && 'addClass' in topElement) {
                        topElement.addClass('selected');
                    }
                }
            }
        }

        window.fireEvent('elementChanged', { element: this.selectElement });

    },

    elementDown: function () { /* keypress - down arrow */

        if (this.listElement.getElements('li.visible').length === 0) {
            this.hide('elementDown with empty list');
            return;
        }

        var selected = this.listElement.getElement('li.visible.selected');
        var topElement = this.getTopVisibleElement();
        var bottomElement = this.getBottomVisibleElement();
        var index = -1;
        var items = this.listElement.getElements('li.visible');

        if (selected && 'addClass' in selected) { /* previous item has been selected */
            index = items.indexOf(selected);
            selected.removeClass('selected');
        }

        if (index < items.indexOf(topElement)) {
            if (topElement && 'addClass' in topElement) {
                topElement.addClass('selected');
            }
        } else {
            if (index < items.length - 1) {
                if (items[index + 1] && 'addClass' in items[index + 1]) {
                    items[index + 1].addClass('selected');
                    this.scrollToBottom(items[index + 1]);
                }
            } else {
                if (this.listElement.scrollHeight == this.listElement.clientHeight) {
                    if (topElement && 'addClass' in topElement) {
                        topElement.addClass('selected');
                    }
                } else {
                    if (bottomElement && 'addClass' in bottomElement) {
                        bottomElement.addClass('selected');
                    }
                }
            }
        }

    },

    defaultSelected: function (e) {
        var html = this.cleanDisplay(e.target.get('html').stripTags());
        this.listElement.getElements('li').removeClass('selected');
        e.target.addClass('selected');
        this.displayElement.value = html;
        this.selectElement.selectedIndex = e.target.get('data-index');
        this.selectElement.value = e.target.get('data-value');
    },

    itemClicked: function (e) {
        this.hide('item clicked');
        var target = e.target.get('tag') == 'li' ? e.target : e.target.getParent('li');
        var fireEvents = e.hasOwnProperty('fireEvents') && e.fireEvents === false ? false : true;
        this.listElement.getElements('li').removeClass('selected');
        target.addClass('selected');
        this.lastSelected = target;
        this.displayElement.value = this.cleanDisplay(target.get('html').stripTags());
        this.selectElement.selectedIndex = target.get('data-index');
        this.selectElement.value = target.get('data-value');
        /* this should only call 'change' IF it has changed, otherwise, don't but  */
        /* because I do not know the impact this will have, just change anyway     */
        /*
        if (this.selectElement.value !== this.defaultChangeValue) {
            this.defaultChangeValue = this.selectElement.value;
            this.changed = true;
            if (this.selectElement.get('onChange') || this.selectElement.get('onchange')) {
                this.selectElement.onChange();
            } else {
                this.selectElement.fireEvent("change");
            }
            window.fireEvent('elementChanged', { element: this.selectElement, callee: 'autocomplete itemClicked' });
        } else {
            this.changed = false;
        }
        */
        if (this.selectElement.value !== this.defaultChangeValue) {
            this.defaultChangeValue = this.selectElement.value;
            this.changed = true;
        } else {
            this.changed = false;
        }
        if (fireEvents) {
            if (this.selectElement.get('onChange') || this.selectElement.get('onchange')) {
                this.selectElement.onChange();
            } else {
                this.selectElement.fireEvent('change', { target: this.selectElement });
            }
            window.fireEvent('elementChanged', { element: this.selectElement, callee: 'autocomplete itemClicked' });
            this.fireEvent('elementChanged', this.selectElement.value);
        }
    },

    position: function () {
        if (this.displayElement && this.listElement) {;

            try {

                var position = this.displayElement.getPosition();
                var size = this.displayElement.measure(function () { return this.getSize(); });
                var windwSize = window.getSize();
                var scroll = document.body.scrollTop || 0;
                var top = position.y + size.y + scroll + 5;
                var left = position.x;
                var listSize = this.listElement.measure(function () {
                    return this.getSize();
                });
                if (this.center) {
                    left = (position.x + (size.x / 2)) - (listSize.x / 2);
                }
                if (windwSize.y - position.y < listSize.y) {
                    top = (position.y - listSize.y - 5) + scroll;
                }
                if (position.x + listSize.x > windwSize.x) {
                    left = windwSize.x - listSize.x - 5;
                }

                this.listElement.setStyles({
                    'position': Affinity.mobile ? 'fixed' : 'absolute',
                    'top': top,
                    'left': left
                });

            } catch (e) { }
        }
    },

    obscure: function () {
        this.hide();
        if (this.iconElement) {
            this.iconElement.addClass('hidden');
        }
        if (this.displayElement) {
            this.displayElement.addClass('hidden');
        }
    },

    reveal: function () {
        if (this.iconElement) {
            this.iconElement.removeClass('hidden');
        }
        this.displayElement.removeClass('hidden');
    },

    hide: function (calledFrom) {
        if (this.status !== 'closed') {
            //console.log('hide called from : ' + calledFrom);
            clearTimeout(this.doFocusDelay);
            clearTimeout(this.fuzzySearchDelay);
            var listbox = this.listElement;
            listbox.fade('out');
            this.status = 'closed';
            (function () {
                listbox.addClass('hidden');
                if (this.listElement && 'getElement' in this.listElement && !this.listElement.getElement('li.visible.selected')) {
                    this.lastSelected = this.listElement.getElement('li.visible.selected');
                }
                this.reset();
            }).delay(250, this);
        }
    },

    show: function (calledFrom) {
        if (this.status !== 'open' && this.listElement && 'getElements' in this.listElement && this.listElement.getElements('li.visible').length > 0) {
            //console.log('show called from : ' + calledFrom);
            window.autocompletes.hideAll(this);
            clearTimeout(this.doFocusDelay);
            var listbox = this.listElement;
            listbox.removeClass('hidden');
            this.position();
            listbox.fade('in');
            this.status = 'open';
            this.position.delay(250, this);
            if (this.listElement && 'getElement' in this.listElement && this.listElement.getElement('li.visible.selected')) {
                var li = this.listElement.getElement('li.visible.selected');
                this.listElement.scrollTo(0, li.getPosition(this.listElement).y - 5);
            }
        }
    },

    clearList: function () {
        if (this.listElement) {
            Array.each(this.listElement.getElements('li'), function (li) {
                li.removeEvents();
            }.bind(this));
            this.listElement.empty();
        }
    },

    revert: function (destroy) {

        var killSelect = typeOf(destroy) === 'null' ? false : destroy;

        if (this.useWebWorkers && this.fuzzyWorker && 'terminate' in this.fuzzyWorker) {
            this.fuzzyWorker.terminate();
            this.fuzzyWorker = false;
        }

        /*
        var method = 'native remove';
        var method = 'native remove children';
        var method = 'moo remove';
        var method = 'moo remove children';
        */

        var method = 'moo remove children';

        clearTimeout(this.doFocusDelay);
        clearTimeout(this.fuzzySearchDelay);
        clearInterval(this.checkExistsPeriodical);

        this.doFocusDelay = null;
        this.fuzzySearchDelay = null;
        this.checkExistsPeriodical = null;

        if (this.displayElement) {
            //this.displayElement.destroyWidget('elementWidget');
            //this.displayElement.removeEvents();
            Affinity.UI.lastAutoKill[this.uuid] = {};
            Affinity.UI.lastAutoKill[this.uuid].id = this.uuid + '';
            Affinity.UI.lastAutoKill[this.uuid].killid = this.killid + '';
            Affinity.UI.lastAutoKill[this.uuid].destroy = Affinity.UI.delayAutoKill.delay(2000, window, [this.uuid + '', this.killid + '']);

            if (this.iconElement) {
                //this.iconElement.removeEvents();
                this.iconElement.addClass('loading');
                Affinity.UI.lastAutoKill[this.uuid + '_icon'] = {};
                Affinity.UI.lastAutoKill[this.uuid + '_icon'].id = this.uuid + '_icon';
                Affinity.UI.lastAutoKill[this.uuid + '_icon'].killid = this.killid + '_icon';
                Affinity.UI.lastAutoKill[this.uuid + '_icon'].destroy = Affinity.UI.delayAutoKill.delay(2000, window, [this.uuid + '_icon', this.killid + '_icon']);
            }

        }

        if (!Affinity.mobile) {
            document.removeEvent('scroll', this.position);
            document.removeEvent('resize', this.position);
        }

        if (this.listElement) {

            this.listElement.set('tween', null);
            this.listElement.removeEvents();

            if (method === 'native remove') {
                try {
                    this.listElement.parentNode.removeChild(this.listElement);
                } catch (e) { };
            }

            if (method === 'native remove children') {
                while (this.listElement.lastChild) {
                    this.listElement.lastChild.removeEventListener(Affinity.events.click, this.itemClicked);
                    this.listElement.removeChild(this.listElement.lastChild);
                }
                try {
                    this.listElement.parentNode.removeChild(this.listElement);
                } catch (e) { };
            }

            if (method === 'moo remove') {
                this.listElement.destroy();
            }

            if (method === 'moo remove children') {
                this.clearList();
                this.listElement.destroy();
            }

        }

        if (this.displayElement) {
            this.displayElement.removeEvents();
            if (this.displayElement.getWidget('elementWidget')) {
                this.displayElement.getWidget('elementWidget').destroy();
            }
            if (this.searchMode) {
                this.displayElement.eliminate('value');
            }
        }

        if (this.selectElement) {
            this.selectElement.inject(this.hiddenWrapper, 'before');
            this.selectElement.eliminate('widget');
            if (killSelect) {
                if (this.selectElement.retrieve('changetracker')) {
                    this.selectElement.retrieve('changetracker').destroy();
                }
                this.selectElement.destroy();
            }
        }
        if (this.hiddenWrapper) {
            this.hiddenWrapper.destroy();
        }

        if (window.autocompletes.widgets[this.uuid]) {
            window.autocompletes.widgets[this.uuid] = null;
            delete window.autocompletes.widgets[this.uuid];
        }

        Object.each(this, function (val, key) {
            this[key] = null;
            delete this[key];
        }.bind(this));

        return true;

    },

    destroy: function () {
        if (this.useWebWorkers && this.fuzzyWorker) {
            this.fuzzyWorker.terminate();
            this.fuzzyWorker = false;
        }
        this.revert(true);
    }

});
;
var UIBankNumber = new Class({

    Implements: [Options],

    Binds: [
        'processNew',
        'process'
    ],

    options: {
        postId: '',
        target: null
    },

    lists: {},

    initialize: function (options) {
        this.setOptions(options);
        this.processNew();
    },

    processNew: function () {

        Array.each(document.getElements('.ui-banknumber'), this.process);

    },

    process: function (el) {

        el.removeClass('ui-banknumber');
        new UIBankNumberWidget({
            element: el
        });

    }

});

var UIBankNumberWidget = new Class({

    Implements: [Options, Events],

    Binds: [
        'bankFieldChange',
        'currentLocation',
        'bankFields',
        'buildNZBank',
        'buildAUBank',
        'bankValidation',
        'processValidation',
        'processKeyUp',
        'setFromInitialValue',
        'copyToHidden',
        'success',
        'failed',
        'revert',
        'destroy',
        'padLeft'
    ],

    options: {
        element: null,
        hasPayPoint: true
    },

    element: null,

    type: 'banknumber',

    initialize: function (options) {

        this.setOptions(options);

        this.uuid = String.uniqueID();

        this.originalElement = this.options.element;

        this.postname = this.originalElement.get('name') || '';

        this.disabled = this.originalElement.get('disabled') ? true : false;

        if (this.options.element === null || typeOf(this.options.element) !== 'element') {
            throw ('No valid element passed in, dummy');
            return;
        }

        this.dropdownDiv = new Element('div', {
            'class': 'countryselector',
        }).inject(this.options.element, 'before');

        this.dropdownDiv.set('tabindex', 5000);

        var isRequired = this.originalElement.get('data-required');
        if (isRequired === 'True') {
            this.dropdown = new Element('select', {
                'class': 'selector validate',
                'data-validate-method': 'bankNumberCountry'
            }).inject(this.dropdownDiv);
        } else {
            this.dropdown = new Element('select', {
                'class': 'selector'
            }).inject(this.dropdownDiv);
        }

        this.dropdownoption1 = new Element('option', {
            'html': '',
            'value': ''
        }).inject(this.dropdown);

        this.dropdownoption2 = new Element('option', {
            'html': 'AU',
            'value': 'AU'
        }).inject(this.dropdown);

        this.dropdownoption3 = new Element('option', {
            'html': 'NZ',
            'value': 'NZ',
        }).inject(this.dropdownoption2, 'after');

        var location = this.originalElement.get('data-country');

        if (Affinity.CF.hasOwnProperty('hasPayPoint') && typeof Affinity.CF.hasPayPoint == 'boolean') this.options.hasPayPoint = Affinity.CF.hasPayPoint;
        if (location !== 'AU' && location !== 'NZ') location = this.currentLocation();
        if (location.trim() === '') this.options.hasPayPoint = false;

        if (this.dropdown)
        {
            if (this.options.hasPayPoint) this.dropdown.addClass('subhidden');
            else this.dropdown.removeClass('subhidden');
            this.dropdown.value = location;
        }

        if (this.disabled) {
            this.countrySelectEl = new Element('input', {
                'type': 'text',
                'class': 'selector',
                'disabled': 'disabled',
                'value': this.dropdown.value
            }).inject(this.dropdown, 'after');
            this.dropdown.destroy();
        } else {
            this.countrySelectEl = this.dropdown;
            this.dropdown.onchange = this.bankFieldChange;
            window.addEvent('bankValidationReturned', this.processValidation);
        }

        this.countrySelectEl.set('name', this.postname + '_country').set('id', this.postname + '_country');
        this.bankFields(location);
    },

    bankFieldChange: function () {

        if (this.element != null) {
            this.element.destroy();
        }

        this.bankFields(this.currentLocation());
    },

    currentLocation: function () {
        if (this.countrySelectEl) {
            if (this.countrySelectEl.get('tag') === 'select' && this.countrySelectEl.selectedIndex != '-1') {
                return this.countrySelectEl.options[this.countrySelectEl.selectedIndex].value;
            }
            return this.countrySelectEl.value;
        } else {
            return 'NZ';
        }
    },

    bankFields: function (location) {
        if (location === 'NZ') {
            this.buildNZBank();
            this.originalElement.removeClass('hidden');
        } else if (location === 'AU') {
            this.buildAUBank();
            this.originalElement.removeClass('hidden');
        } else {
            this.originalElement.value = '';
            this.originalElement.addClass('hidden');
            window.fireEvent('bankValidationError', {
                target: this.originalElement,
                silent: true
            });
        }
    },

    buildNZBank: function () {

        this.element = new Element('div', {
            'class': 'banknumberbox ui-validate nz',
            'data-validate-method': 'banknumber'
        }).inject(this.dropdownDiv, 'after');

        this.element.set('tabindex', 5000);

        this.bankNumberPart1 = new Element('input', {
            'class': 'bank',
            'id': 'bank',
            'type': 'text',
            'maxlength': '2'
        }).inject(this.element);

        new Element('span', {
            'html': '-'
        }).inject(this.element);

        this.bankNumberPart2 = new Element('input', {
            'class': 'branch',
            'id': 'branch',
            'type': 'text',
            'maxlength': '4'
        }).inject(this.element);

        new Element('span', {
            'html': '-'
        }).inject(this.element);

        this.bankNumberPart3 = new Element('input', {
            'class': 'account',
            'id': 'account',
            'type': 'text',
            'maxlength': '7'
        }).inject(this.element);

        new Element('span', {
            'html': '-'
        }).inject(this.element);

        this.bankNumberPart4 = new Element('input', {
            'class': 'suffix',
            'id': 'suffix',
            'type': 'text',
            'maxlength': '3'
        }).inject(this.element);

        this.tickcross = new Element('span', {
            'class': 'tickcross font-icons color',
        }).inject(this.element);

        this.name = new Element('span', {
            'class': 'names'
        }).inject(this.element);
        this.bankname = new Element('span', {
            'class': 'bankname'
        }).inject(this.name);
        this.branchname = new Element('span', {
            'class': 'branchname'
        }).inject(this.name);

        if (this.hiddenWrapper) {
            this.element.inject(this.hiddenWrapper, 'before');
        } else {
            this.hiddenWrapper = new Element('div', {
                'class': 'subhidden',
                'id': 'subhidden_' + this.uuid
            }).inject(this.options.element, 'after');

            this.hiddenWrapper.adopt(this.options.element);

            this.element.inject(this.hiddenWrapper, 'before');
        }

        if (this.disabled) {
            this.bankNumberPart1.set('disabled', 'disabled');
            this.bankNumberPart2.set('disabled', 'disabled');
            this.bankNumberPart3.set('disabled', 'disabled');
            this.bankNumberPart4.set('disabled', 'disabled');
            this.tickcross.addClass('hidden');
        } else {
            this.bankNumberPart1.onkeyup = this.processKeyUp;
            this.bankNumberPart2.onkeyup = this.processKeyUp;
            this.bankNumberPart3.onkeyup = this.processKeyUp;
            this.bankNumberPart3.onblur = this.padLeft;
            this.bankNumberPart4.onkeyup = this.processKeyUp;
            this.tickcross.set('html', Affinity.icons.Blocked);
        }

        this.setFromInitialValue();

    },

    buildAUBank: function () {

        this.element = new Element('div', {
            'class': 'banknumberbox ui-validate au',
            'data-validate-method': 'banknumber'
        }).inject(this.dropdownDiv, 'after');

        this.element.set('tabindex', 5000);

        this.bankNumberPart1 = new Element('input', {
            'class': 'bank',
            'id': 'bank',
            'type': 'text',
            'maxlength': '3'
        }).inject(this.element);

        new Element('span', {
            'html': '-'
        }).inject(this.element);

        this.bankNumberPart2 = new Element('input', {
            'class': 'branch',
            'id': 'branch',
            'type': 'text',
            'maxlength': '3'
        }).inject(this.element);

        new Element('span', {
            'html': '-'
        }).inject(this.element);

        this.bankNumberPart3 = new Element('input', {
            'class': 'account',
            'id': 'account',
            'type': 'text',
            'maxlength': '14'
        }).inject(this.element);

        this.tickcross = new Element('span', {
            'class': 'tickcross font-icons color'
        }).inject(this.element);

        this.name = new Element('span', {
            'class': 'names'
        }).inject(this.element);
        this.bankname = new Element('span', {
            'class': 'bankname'
        }).inject(this.name);
        this.branchname = new Element('span', {
            'class': 'branchname'
        }).inject(this.name);

        if (this.hiddenWrapper) {
            this.element.inject(this.hiddenWrapper, 'before');
        } else {
            this.hiddenWrapper = new Element('div', {
                'class': 'subhidden',
                'id': 'subhidden_' + this.uuid
            }).inject(this.options.element, 'after');

            this.hiddenWrapper.adopt(this.options.element);

            this.element.inject(this.hiddenWrapper, 'before');
        }

        if (this.disabled) {
            this.bankNumberPart1.set('disabled', 'disabled');
            this.bankNumberPart2.set('disabled', 'disabled');
            this.bankNumberPart3.set('disabled', 'disabled');
            this.tickcross.addClass('hidden');
        } else {
            this.bankNumberPart1.onkeyup = this.processKeyUp;
            this.bankNumberPart2.onkeyup = this.processKeyUp;
            this.bankNumberPart3.onkeyup = this.processKeyUp;
            this.tickcross.set('html', Affinity.icons.Blocked);
        }

        this.setFromInitialValue();

    },

    processKeyUp: function () {
        this.copyToHidden();
        this.bankValidation();
    },

    padLeft: function () {
        if (this.bankNumberPart3 && this.bankNumberPart3.value !== '') {
            this.bankNumberPart3.value = this.bankNumberPart3.value.padStart(7, '0');
        }
    },

    setFromInitialValue: function () {

        var bits = this.hiddenWrapper.getElement('input').value.split('-');

        if (this.currentLocation() == 'NZ') {
            this.bankNumberPart1.value = bits[0] ? (bits[0].length > 2 ? bits[0].substring(0, 2) : bits[0]) : '';
            this.bankNumberPart2.value = bits[1] ? bits[1] : '';
            this.bankNumberPart3.value = bits[2] ? bits[2] : '';
            if (this.bankNumberPart4) {
                if (bits[2] && bits[2].length > 7) {
                    this.bankNumberPart3.value = bits[2].substring(0, 7);
                    this.bankNumberPart4.value = bits[2].substring(7, bits[2].length);
                } else {
                    this.bankNumberPart4.value = bits[3] ? bits[3] : '';
                }
            }
        } else if (this.currentLocation() == 'AU') {
            this.bankNumberPart1.value = bits[0] ? bits[0] : '';
            this.bankNumberPart2.value = bits[1] ? bits[1] : '';
            this.bankNumberPart3.value = (bits[2] ? bits[2] : '') + (bits[3] ? bits[3] : '');
        } else {
            this.bankNumberPart1.value = '';
            this.bankNumberPart2.value = '';
            this.bankNumberPart3.value = '';
            if (this.bankNumberPart4) {
                this.bankNumberPart4.value = '';
            }
        }

        this.bankValidation();
    },

    copyToHidden: function () {

        var bankNum = '';

        if (this.currentLocation() == 'NZ') {
            var b1 = this.bankNumberPart1.value != '' ? this.bankNumberPart1.value + '-' : '';
            var b2 = this.bankNumberPart2.value != '' ? this.bankNumberPart2.value + '-' : '';
            var b3 = this.bankNumberPart3.value != '' ? this.bankNumberPart3.value + '-' : '';
            var b4 = this.bankNumberPart4.value != '' ? this.bankNumberPart4.value : '';
            bankNum = b1 + b2 + b3 + b4;
        } else if (this.currentLocation() == 'AU') {
            var b1 = this.bankNumberPart1.value != '' ? this.bankNumberPart1.value + '-' : '';
            var b2 = this.bankNumberPart2.value != '' ? this.bankNumberPart2.value + '-' : '';
            var b3 = this.bankNumberPart3.value != '' ? this.bankNumberPart3.value : '';
            bankNum = b1 + b2 + b3;
        }

        this.hiddenWrapper.getElement('input').value = bankNum;
        this.hiddenWrapper.getElement('input').set('data-country', this.dropdown.value);

    },

    bankValidationDelay: false,
    bankValidation: function () {
        clearTimeout(this.bankValidationDelay);
        this.bankValidationDelay = function () {
            var el = this.hiddenWrapper.getElement('input');
            var form = el.getParent('form');
            if (form != null && form.retrieve('validation')) {
                var validator = form.retrieve('validation');
                validator.validateBankNumber(el, this.currentLocation(), el.get('name'));
            }
        }.delay(500, this);
    },

    processValidation: function (result) {
        var el = result.el;
        var jsonData = result.data;

        if (el !== this.originalElement) {
            return;
        }

        this.bankname.set('html', jsonData.bankName)
        this.branchname.set('html', jsonData.branchName);

        if (jsonData.success) {
            this.success();
        } else {
            if (el.value) {
                this.failed();
            } else {
                window.fireEvent('bankValidationSuccess');
                this.tickcross.set('html', Affinity.icons.Blocked);
                this.tickcross.removeClass('red');
                this.tickcross.removeClass('green');
            }
        }
    },

    success: function (jsonData) {

        var tickcross = this.tickcross;

        tickcross.set('html', Affinity.icons.Tick);
        tickcross.removeClass('red').addClass('green');

    },

    failed: function (jsonData) {

        var tickcross = this.tickcross;

        tickcross.set('html', Affinity.icons.Cross);
        tickcross.removeClass('green').addClass('red');

    },

    revert: function () {

        if (this.displayElement) {
            this.displayElement.removeEvent('keyup', this.doKeyUp);
            this.iconElement.destroy();
            this.displayElement.destroy();
        }

        this.selectElement.inject(this.hiddenWrapper, 'before');
        this.hiddenWrapper.destroy();
        this.selectElement.eliminate('widget');
        var select = this.selectElement;

        Object.each(this, function (key, val) {
            this[key] = null;
            delete this[key];
        }.bind(this));

        return select;

    },

    destroy: function () {

        clearTimeout(this.checkExistsPeriodical);
        var select = this.revert();
        select.destroy();

    }

});
;


var UIDateCalendar = new Class({

    Version: '1.0.0.0',
    File: 'ui.date.calendar.js',

	Implements: [Options, Events],

	Binds: [
		'processNew',
		'processDateInput',
		'hideAll'
	],

	options: {
		outputFormat: '%d.%m.%Y',
		displayFormat: '%a the %e%o of %b %Y'
	},

	widgets: {},

	initialize: function (options) {

		this.setOptions(options);

		if (!Affinity.UI) { Affinity.UI = {}; }

		Affinity.UI.calendars = this;

		this.processNew();

	},

	processNew: function () {
		Array.each(document.getElements('input.uidate-calendar'), this.processDateInput);
	},

	processDateInput: function (el) {

		if (el.hasClass('uidone')) {
			return;
		}

		el.addClass('uidone');

		var calendarOptions = {
			target: el,
			postName: el.get('name') || '',
			postId: el.get('id') || '',
			startDate: el.get('data-start-date') || new Date(),
			validationMethods: el.get('data-validate-method') || '',
			validationErrorStr: el.get('data-validate-error-str') || '',
			showInline: el.hasClass('show-inline') ? true : false,
			nullable: false
		};

		switch (el.get('data-calendar-type')) {
			case 'date':
				calendarOptions.showCalendar = true;
				calendarOptions.showTime = false;
				break;
			case 'time':
				calendarOptions.showCalendar = false;
				calendarOptions.showTime = true;
				break;
			case 'datetime':
				calendarOptions.showCalendar = true;
				calendarOptions.showTime = true;
				break;
            case 'hoursmins':
                calendarOptions.showCalendar = true;
                calendarOptions.showTime = true;
                calendarOptions.hoursmins = true;
                break;
			default:
				calendarOptions.showCalendar = true;
				calendarOptions.showTime = false;
				break;
		}

		if (el.get('data-calendar-display-format')) {
			calendarOptions.displayFormat = el.get('data-calendar-display-format');
		}

		if (el.get('data-calendar-return-format')) {
			calendarOptions.outputFormat = el.get('data-calendar-return-format');
		}

		if (el.get('data-calendar-nullable')) {
			calendarOptions.nullable = el.get('data-calendar-nullable').trim().toLowerCase() === 'true' ? true : false;
		}

		if (el.get('data-calendar-hoursmins')) {
		    calendarOptions.hoursmins = el.get('data-calendar-hoursmins').trim().toLowerCase() === 'true' ? true : false;
		}

		if (el.hasClass('preserve-original-input')) {
		    calendarOptions.preserveOriginalInput = true;
		}

		if (calendarOptions.hoursmins && !el.get('data-start-date')) {
		    calendarOptions.startDate.setMinutes(0);
		    calendarOptions.startDate.setHours(0);
		    calendarOptions.startDate.setSeconds(0);
		    calendarOptions.startDate.setMilliseconds(0);
		}

		var ca = new UIDateTimeWidget(calendarOptions);

		if (!this.widgets[ca.uuid]) {
			this.widgets[ca.uuid] = ca;
		}

		delete ca;
		delete calendarOptions;

	},

	hideAll: function (except) {
		Object.each(this.widgets, function (widget) {
			if (typeOf(except) !== 'null' && except.uuid) {
				if (widget.uuid !== except.uuid) {
					widget.hide();
				}
			} else {
				widget.hide();
			}
		}.bind(this));
	}

});


var UIDateTimeWidget = new Class({

	Implements: [Options, Events],

	options: {
	    target: null,
	    preserveOriginalInput: false,
		outputFormat: '%d.%m.%Y',
		displayFormat: '%a %e %b %Y',
		showCalendar: true,
		showTime: false,
		startDate: null,
		labelName: '',
		postId: '',
		postName: '',
		validationMethods: '',
		validationErrorStr: '',
		cssPosition: 'absolute',
		watchOutput: false,
		nullable: false,
		hoursmins: false,
        showInline: false
	},

	Binds: [
		'getDate', 'getDateObject',
		'getValue', 'getDisplayValue',
		'documentClick', 'calendarClick', 'calendarEnter', 'calendarLeave', 'monthElementClicked', 'yearElementClicked', 'monthSelectorClicked', 'yearSelectorClicked',
		'lastMonth', 'nextMonth', 'resetCalendar',
		'nextMonthDown', 'lastMonthDown',
		'dayClicked', 'timeChanged',
		'setCalendarDate',
		'changeMonth', 'changeYear',
		'attemptParse',
		'setToday', 'setNone',
		'externalShow',
		'watchOutputChanges',
		'obscure', 'reveal',
		'show', 'hide',
		'destroy'
	],

	row: null,

	date: null,

	__uiDate: null,
	__selectedDate: null,

	getValue: function () {
		return this.date.format(this.options.displayFormat);
	},

	getDisplayValue: function () {
		return this.date.format(this.options.outputFormat);
	},

	initialize: function (options) {

	    this.setOptions(options);

	    this.showDefault = this.options.startDate == 'none' ? false : true;

	    var now = new Date();

	    this.__uiDate = now.clone();
	    this.__selectedDate = this.date = false;

	    if (this.options.startDate == 'none') {
	        if (this.options.target && 'value' in this.options.target && this.options.target.value.trim() !== '') {
	            if (Date.parse(this.options.target.value).isValid()) {
	                //this.date = Date.parse(this.options.target.value);
	                //this.selectedDate = this.date.clone();

	                this.__uiDate = Date.parse(this.options.target.value);
	                this.__selectedDate = this.__uiDate.clone();
	                this.date = this.__uiDate.clone();

	                this.showDefault = true;

	            } else {
	                this.showDefault = false;
	            }
	        } else {
	            //this.date = false;
	            //this.selectedDate = false;
	            this.showDefault = false;
	        }
	    } else if (this.options.startDate == 'today') {
	        //this.date = new Date();
	        //this.selectedDate = this.date.clone();

	        this.__uiDate = now.clone();
	        this.__selectedDate = this.__uiDate.clone();
	        this.date = this.__uiDate.clone();

	    } else {
	        if (this.options.startDate && this.options.startDate !== null && Date.parse(this.options.startDate).isValid()) {
	            //this.date = Date.parse(this.options.startDate);

	            this.__uiDate = Date.parse(this.options.startDate);
	            this.__selectedDate = this.__uiDate.clone();
	            this.date = this.__uiDate.clone();

	        }
	    }

	    if (this.options.hoursmins && now.getTime() === this.__uiDate.getTime()) {
	        this.__uiDate.setMinutes(0);
	        this.__uiDate.setHours(0);
	        this.__uiDate.setSeconds(0);
	        this.__uiDate.setMilliseconds(0);
	        this.__selectedDate = this.__uiDate.clone();
	        this.date = this.__uiDate.clone();
	    }

	    if (this.options.nullable) {
	        this.showDefault = false;
	    }

	    this.id = this.options.target != null ? this.options.target.get('id') ? this.options.target.get('id') : String.uniqueID() : String.uniqueID();
	    this.uuid = this.id;

	    if (!Affinity.UI.calendars.widgets[this.uuid]) {
	        Affinity.UI.calendars.widgets[this.uuid] = this;
	    }

        this.display = new Element('input', { 'type': 'text', 'class': 'ui-calendar-display data-hj-whitelist widget', 'id': this.id + '-Display' }).store('widget', this);
	    this.output = new Element('input', { 'type': 'hidden', 'name': this.options.postName, 'id': this.options.postId, 'data-display-id': this.id + '-Display' });

	    if(Affinity.mobile){
	        this.display.set('readonly', 'true');
	    }

	    if (this.options.validationMethods != '') {
	        this.output.addClass('validate');
	        this.output.set('data-validate-method', this.options.validationMethods);
	        if (this.options.validationErrorStr) {
	            this.output.set('data-validate-error-str', this.options.validationErrorStr);
	        }
	    }

	    /* should I watch the master input for changes? */
	    this.watch = this.options.watchOutput || false;
	    if (typeOf(this.options.target) !== 'null' && this.options.target.hasClass('uidate-watch')) {
	        this.watch = true;
	    }
	    if (this.watch) {
	        this.watchTimer = this.watchOutputChanges.periodical(500, this);

	    }

	    /* choose to replace original input or reuse ... */
	    this.reuse = this.options.preserveOriginalInput || false;

	    if (typeOf(this.options.target) !== 'null' && this.options.target.hasClass('uidate-preserve')) {
	        this.reuse = true;
	    }

	    if (this.reuse) {

	        if (typeOf(this.options.target) === 'null') {

	            this.row = new Element('div');

	            this.label = new Element('label', { 'html': this.options.labelName }).inject(this.row);

	            this.target = new Element('div', { 'class': 'hidden' }).inject(this.label, 'after');

	        } else {

	            this.row = this.options.target.getParent('.form-row') || false;

	            this.target = this.options.target;
	            this.output = this.target;
	            //this.output.addClass('hidden');

	            var wrapper = new Element('div', { 'class': 'subhidden' });

	            //this.display.cloneEvents(this.options.target);
	            this.target.store('widget', this);//.addClass('hidden');

	            if (this.row) {
	                wrapper.inject(this.row, 'top');
	                this.display.inject(this.row, 'bottom');
	            } else {
	                wrapper.inject(this.output, 'before');
	                this.display.inject(this.output, 'after');
	            }
	            this.output.inject(wrapper);

	        }

	    }else{

	        if (this.options.target == null) {

	            this.row = new Element('div');

	            this.label = new Element('label', { 'html': this.options.labelName }).inject(this.row);

	            this.target = new Element('div', { 'class': 'hidden' }).inject(this.label, 'after');

	        } else {

	            this.target = new Element('div', { 'class': 'hidden' }).inject(this.options.target, 'after');

	            var attempt;
	            if (this.options.target.value) {
	                attempt = Date.parse(this.options.target.value);
	                if (attempt.isValid()) {
	                    this.options.startDate = attempt;
	                }
	            }

	            this.row = this.options.target.getParent('.form-row');

	            this.options.postId = this.options.target.get('id');

	            if (this.options.postName == '') {
	                this.options.postName = this.options.target.get('name');
	                this.output.set('name', this.options.postName);
	            }

	            this.display.cloneEvents(this.options.target);

	            /** Jordan's Leave can ONLY work if the original input is left intact.
				//this.options.target.destroy();

				/** Avoid ID conflicts for ID specific calls (Eg: timesheet dependencies) **/
	            this.options.target.set('id', '__' + this.options.target.get('id'));
	            /** Remove name from original so it is not posted twice **/
	            this.options.target.set('name', null);
	            /** remove events from original to avoid multiples **/
	            this.options.target.removeEvents();
	            /** store widget against original for Jordan's Leave **/
	            this.options.target.store('widget', this).addClass('hidden');

	        }

	        /**/

	        if (this.row !== null) {
	            this.row.set('class', 'form-row ui-calendar-row ' + this.id);
	        }
	        this.display.inject(this.target, 'after');
	        this.output.inject(this.target, 'after');

	        this.target.destroy();

	    }

	    /**/

	    this.icons = {};
	    this.icons.Open = Affinity.icons.Popup || '&#xe012;';
	    this.icons.Today = Affinity.icons.Calendar || '&#xe02e;';
	    this.icons.Clear = Affinity.icons.Cross || '&#xe067;';
	    this.icons.Tick = Affinity.icons.Tick;

	    this.dontClose = false; // used to stop auto closing on some internal events
	    this.calendarOver = false; // used to determine if the mouse is within the calendar widget

	    this.buttons = new Element('span', { 'class': 'ui-calendar-buttons' }).inject(this.display, 'after');

	    this.showbutton = new Element('span', { 'class': 'ui-calendar-button button w-icon-only blue ui-has-tooltip', 'html': '<span>' + this.icons.Open + '</span>', 'data-calendar': this.id, 'data-tooltip': 'Open', 'data-tooltip-dir': 'top' }).inject(this.buttons);
	    this.todaybutton = new Element('span', { 'class': 'ui-calendar-button button w-icon-only green ui-has-tooltip', 'html': '<span>' + this.icons.Today + '</span>', 'data-calendar': this.id, 'data-tooltip': 'Set date to today', 'data-tooltip-dir': 'top' }).inject(this.buttons);
	    this.clearbutton = new Element('span', { 'class': 'ui-calendar-button button w-icon-only orange ui-has-tooltip', 'html': '<span>' + this.icons.Clear + '</span>', 'data-calendar': this.id, 'data-tooltip': 'Clear the date', 'data-tooltip-dir': 'top' }).inject(this.buttons);

	    this.calendarBox = new Element('div', { 'class': 'ui-calendar', 'id': this.domid }).inject(document.body);
	    this.calendarBox.set('reveal', { duration: 250 });

	    /** BUILD EVENTS **/

	    if (!this.options.showInline) {
	        this.calendarBox.addEvent(Affinity.events.click, this.calendarClick);
	    }

	    if (!Affinity.mobile || !this.options.showInline) {
	        this.calendarBox.addEvent(Affinity.events.overAll, this.calendarEnter);
	        this.calendarBox.addEvent(Affinity.events.outAll, this.calendarLeave);
	    }

	    if (!this.options.showInline) {
	        this.display.addEvent(Affinity.events.click, this.externalShow);
	        this.showbutton.addEvent(Affinity.events.click, this.externalShow);
	        this.display.addEvent('blur', this.attemptParse);
	        document.addEvent(Affinity.events.click, this.documentClick);
	        this.todaybutton.addEvent(Affinity.events.click, this.setToday);
	        this.clearbutton.addEvent(Affinity.events.click, this.setNone);
	    }

		if (this.output && this.date && typeOf(this.output) === 'element' && typeOf(this.date) === 'date' && this.options.outputFormat) {
			this.output.store('defaultValue', this.date.format(this.options.outputFormat));
		}

	    /* check for print only field */

		this.printField = false;
		if (this.display.getParent('.ui-calendar-row') && this.display.getParent('.ui-calendar-row').getElement('.print-field')) {
		    this.printField = this.display.getParent('.ui-calendar-row').getElement('.print-field');
		}

        /**/

		this.buildCalendar();

		window.addEvent('resize', function () {
		    if (this.status = 'open') {
		        this.position();
		    }
		}.bind(this));
		if (Affinity.mobile) {
		    window.addEvent('mobileback', this.documentClick);
		    if ('onorientationchange' in window) {
		        window.addEvent('orientationchange', function () {
		            if (this.status = 'open') {
		                this.position();
		            }
		        }.bind(this));
		    }
		}


	    /**/

		this.valuetracker = new Affinity.ElementValueTracker();
		if (this.display) this.valuetracker.addElement(this.display);
		if (this.output) this.valuetracker.addElement(this.output);

        /**/

		this.checkExistsPeriodical = this.checkExists.periodical(1000, this);

	    /** INLINE **/

		if (this.options.showInline) {
		    this.buttons.addClass('hidden');
		    this.display.addClass('hidden');
		    this.calendarBox.addClass('inline');
		    this.calendarBox.inject(this.display.getParent(), 'bottom');
		    this.show();
		}

	},

	checkExists: function () {
		if (!document.contains(this.output)) {
			clearInterval(this.checkExistsPeriodical);
			this.destroy();
		}
	},

	/** EVENT METHODS **/

	documentClick: function (e) {
		if (this.status == 'open') {
			this.hide(null, 'doc ' + this.id);
		}
	},

	calendarClick: function (e) {
		e.stopPropagation();
		e.preventDefault();
	},

	calendarEnter: function (e) {
		this.calendarOver = true;
	},

	calendarLeave: function (e) {
		this.calendarOver = false;
	},

	monthElementClicked: function (e) {
		this.calendarContainer.reveal();
		this.monthbox.dissolve();
		this.changeMonth(e.target.get('data-value'));
		this.monthbox.getElements('.active').removeClass('active');
		e.target.addClass('active');
		if (this.options.showTime && this.timeWidget) {
			this.timeWidget.showDisplay();
		}
	},

	yearElementClicked: function (e) {
		this.calendarContainer.reveal();
		this.yearbox.dissolve();
		this.changeYear(e.target.get('data-value'));
		this.yearbox.getElements('.active').removeClass('active');
		e.target.addClass('active');
		if (this.options.showTime && this.timeWidget) {
			this.timeWidget.showDisplay();
		}
	},

	monthSelectorClicked: function (e) {
		this.monthbox.reveal();
		if (this.options.showTime && this.timeWidget) {
			this.timeWidget.hide();
			this.timeWidget.hideDisplay();
		}
		this.calendarContainer.dissolve();
	},

	yearSelectorClicked: function (e) {
		this.yearbox.reveal();
		if (this.options.showTime && this.timeWidget) {
			this.timeWidget.hide();
			this.timeWidget.hideDisplay();
		}
		this.calendarContainer.dissolve();
		(function () {
			var active_y = this.yearbox.getElement('.active').getPosition(this.yearbox).y;
			this.yearbox.scrollTo(0, active_y - 5);
		}).delay(500, this);
	},

	nextMonthDown: function (e) {
		e.preventDefault();
		e.stopPropagation();
	},

	lastMonthDown: function (e) {
		e.preventDefault();
		e.stopPropagation();
	},

	/* END EVENT METHODS */

	getHumanHour: function (n) {
		return n == 0 ? 'Midnight' : n < 12 ? n + ' am' : n > 12 ? (n - 12) + ' pm' : 'Midday';
	},

	buildCalendar: function () {

		var setupdate = new Date();

		var i, dayel;

		if (this.options.showCalendar) {

			this.calendarContainer = new Element('div').inject(this.calendarBox);

			this.lastButton = new Element('span', { 'html': '&#9668;', 'class': 'ui-calendar-nextlast' }).inject(this.calendarContainer);
			var monthyear = new Element('span', { 'html': '', 'class': 'ui-calendar-monthyear' }).inject(this.calendarContainer);
			this.nextButton = new Element('span', { 'html': '&#9658;', 'class': 'ui-calendar-nextlast' }).inject(this.calendarContainer);

			this.monthButton = new Element('span', { 'class': 'ui-calendar-month' }).inject(monthyear);
			this.yearButton = new Element('span', { 'class': 'ui-calendar-year' }).inject(monthyear);

			this.monthbox = new Element('div', { 'class': 'ui-calendar-monthbox' }).inject(this.calendarBox);
			this.monthbox.set('reveal', { duration: 250 });
			this.monthbox.toggle();

			this.yearbox = new Element('div', { 'class': 'ui-calendar-yearbox' }).inject(this.calendarBox);
			this.yearbox.set('reveal', { duration: 250 });
			this.yearbox.toggle();

			for (i = 0; i < 12; i++) {
				this.monthbox.adopt(
					new Element('span', { 'class': 'm' + i + (i === setupdate.getMonth() ? ' today' : ''), 'html': setupdate.clone().set('month', i).format('%b'), 'data-value': i }).addEvent(Affinity.events.click, this.monthElementClicked)
				);
			}
			var selectdate = setupdate.clone();
			for (i = selectdate.getFullYear() - 100; i < selectdate.getFullYear() + 50; i++) {
				new Element('span', { 'class': 'y' + i + (i === setupdate.getFullYear() ? ' today' : ''), 'html': i, 'data-value': i }).addEvent(Affinity.events.click, this.yearElementClicked).inject(this.yearbox, 'top');
			}

			for (i = 0; i < 7; i++) {
				setupdate.set('day', i);
				new Element('span', { 'html': setupdate.format('%a'), 'class': 'ui-calendar-daylabel' }).inject(this.calendarContainer);
			}

			for (i = 0; i < 6 * 7; i++) {
				dayel = new Element('span', { 'class': 'ui-calendar-day' }).adopt(new Element('span')).inject(this.calendarContainer);
				this.setupClickable(dayel);
			}

			this.nextButton.addEvent(Affinity.events.click, this.nextMonth);
			this.lastButton.addEvent(Affinity.events.click, this.lastMonth);
			this.monthButton.addEvent(Affinity.events.click, this.monthSelectorClicked);
			this.yearButton.addEvent(Affinity.events.click, this.yearSelectorClicked);

			if (!Affinity.mobile) {
				this.nextButton.addEvent('mousedown', this.nextMonthDown);
				this.lastButton.addEvent('mousedown', this.lastMonthDown);
			}

		}

		if (this.options.showTime) {

			var width = 150;
			if (this.options.showCalendar) {
				/*
				this.date = new Date();
				this.date.setHours(0);
				this.date.setMinutes(0);
				this.date.setSeconds(0);
				this.date.setMilliseconds(0);
				*/
				this.calendarContainer.set('reveal', { duration: 250 });
				width = this.calendarContainer.measure(function () { return this.getSize(); }).x - 20;
			}

			var timeWidgetDate = this.__selectedDate ? this.__selectedDate.clone() : false;

			this.timeWidget = new UITimePickerWidget({
			    target: this.calendarBox,
			    displayInput: this.display,
				timeonly: this.options.showCalendar ? false : true,
				date: timeWidgetDate,
				hoursmins: this.options.hoursmins,
                dateWidget: this,
                onTimeSet: function (date) {
					if (typeOf(date) === 'date' && date.isValid()) {
						if (this.__selectedDate) {
							if (date.getTime() !== this.__selectedDate.getTime()) {
								this.date.setHours(date.getHours());
								this.date.setMinutes(date.getMinutes());
								this.__selectedDate = this.date.clone();
								this.__uiDate = this.date.clone();
								this.setCalendarDate();
							}
						} else if(this.date) {
							if (date.getTime() !== this.date.getTime()) {
								this.date.setHours(date.getHours());
								this.date.setMinutes(date.getMinutes());
								this.__uiDate = this.date.clone();
								this.__selectedDate = this.date.clone();
								this.setCalendarDate();
							}
						} else {
							if(!this.options.nullable){
								this.date = date;
								this.date.setHours(date.getHours());
								this.date.setMinutes(date.getMinutes());
								this.__uiDate = this.date.clone();
								this.__selectedDate = this.date.clone();
								this.setCalendarDate();
							} else {
								if (!this.options.showCalendar) {
									this.date = date;
									this.date.setHours(date.getHours());
									this.date.setMinutes(date.getMinutes());
									this.__uiDate = this.date.clone();
									this.__selectedDate = this.date.clone();
									this.setCalendarDate();
								}
							}
						}
					}
				}.bind(this),
				onOpen: function () {
					if (this.options.showCalendar) {
						this.calendarContainer.dissolve();
					}
				}.bind(this),
				onDone: function (e) {
					if (this.options.showCalendar) {
						this.calendarContainer.reveal();
					} else {
						this.hide(e, 'timeWidget');
					}
					this.output.fireEvent('change', { target: this.output });
				}.bind(this),
				width: width
			});
		}

		this.setupCalendar(this.options.startDate == null ? false : true);

	},

	setupCalendar: function (userEvent) {

		var doSetCalendarDate = typeOf(userEvent) !== 'null' ? userEvent : false;

		var today = new Date();

		if (this.options.showCalendar) {

			var day = 1;
			var month = this.__uiDate.get('month');
			var year = this.__uiDate.get('year');
			var lastday = this.__uiDate.get('lastdayofmonth');
			var firstday = this.__uiDate.clone().set('date', 1).get('day');
			var klass;

			this.calendarBox.getElement('.ui-calendar-month').set('html', this.__uiDate.format('%B'));
			this.calendarBox.getElement('.ui-calendar-year').set('html', this.__uiDate.getFullYear());

			this.calendarBox.getElements('.ui-calendar-day').removeClass('today').removeClass('selected').removeClass('active');

			Array.each(this.calendarBox.getElements('.ui-calendar-day'), function (dayel, index) {

				dayel.set('class', 'ui-calendar-day');
				dayel.getElement('span').set('html', '&nbsp;');

				if (index >= firstday && index < firstday + lastday && day == today.get('date') && month == today.get('month') && year == today.get('year')) {
					dayel.addClass('today');
				}

				if (index >= firstday && index < firstday + lastday && day == this.__uiDate.get('date') && month == this.__uiDate.get('month') && year == this.__uiDate.get('year')) {
					dayel.addClass('selected');
				}

				if (index >= firstday && index < firstday + lastday) {
					klass = this.__uiDate.clone().set('date', day).format('%b%d%Y');
					dayel.getElement('span').set('html', day);
					dayel.addClass(klass);
					dayel.addClass('active');
					dayel.store('date', this.__uiDate.clone().set('date', day));
					day++;
				}

			}.bind(this));

			this.monthbox.getElements('.active').removeClass('active');
			this.monthbox.getElement('.m' + this.__uiDate.getMonth()).addClass('active');

			this.yearbox.getElements('.active').removeClass('active');
			this.yearbox.getElement('.y' + this.__uiDate.getFullYear()).addClass('active');

		}

		if (this.options.showTime) {
			this.timeWidget.setTime(this.__uiDate);
		}

		if (doSetCalendarDate) {
			this.setCalendarDate();
		}

	},

	setupClickable: function (dayel) {
		dayel.addEvent(Affinity.events.click, this.dayClicked);
	},

	dayClicked: function (e) {

		var date;
		var dayel = e.target.hasClass('ui-calendar-day') ? e.target : e.target.getParent('.ui-calendar-day');

		if (dayel.hasClass('active')) {

			this.calendarBox.getElements('.ui-calendar-day.selected').removeClass('selected');

			date = dayel.retrieve('date');

			this.date = date.clone();
			this.__uiDate = date.clone();
			this.__selectedDate = date.clone();

			dayel.addClass('selected');

			var setSuccess = this.setCalendarDate(); // defeat race conditions

			this.fireEvent('dateClicked', this.date);

			if (!this.options.showTime) {
				this.hide();
			}

		}

	},

	nextMonth: function (e) {
		var currentValue = this.__uiDate.get('month');
		var value = currentValue;
		value = value + 1 > 11 ? 0 : value + 1;
		this.changeMonth(value);
		if (value === 0) {
			this.changeYear(this.__uiDate.get('year') + 1);
		}
	},

	lastMonth: function (e) {
		var currentValue = this.__uiDate.get('month');
		var value = currentValue;
		value = value - 1 < 0 ? 11 : value - 1;
		this.changeMonth(value);
		if (value === 11) {
			this.changeYear(this.__uiDate.get('year') - 1);
		}
	},

	changeMonth: function (value) {
		this.doEvent = false;
		var temp = this.__uiDate.clone().set('date', 1).set('month', value);
		var lastday = temp.get('lastdayofmonth');
		var currentday = this.__uiDate.get('date');
		currentday = currentday > lastday ? lastday : currentday;
		this.__uiDate.set('date', 1).set('month', value).set('date', currentday);
		this.setupCalendar();
		this.setCalendarDate();
	},

	changeYear: function (value) {
		this.doEvent = false;
		var temp = this.__uiDate.clone().set('date', 1).set('month', value);
		var lastday = temp.get('lastdayofmonth');
		var currentday = this.__uiDate.get('date');
		currentday = currentday > lastday ? lastday : currentday;
		this.__uiDate.set('date', 1).set('year', value).set('date', currentday);
		this.setupCalendar();
		this.setCalendarDate();
	},

	/** process date values **/
	doEvent: true,
	setCalendarDate: function () {
		var fireGlobalChangeEvent = false;
		if (this.__selectedDate) {
			if (this.__selectedDate.format(this.options.outputFormat) !== this.output.value) {
				fireGlobalChangeEvent = true;
			}
			this.display.value = this.__selectedDate.format(this.options.displayFormat);
			this.output.value = this.__selectedDate.format(this.options.outputFormat);
			if (this.printField) {
			    this.printField.set('html', this.display.value);
			}
		}
		if (this.doEvent) {
			if (fireGlobalChangeEvent) {
				window.fireEvent('formElementChanged', { element: this.output });
			}
			this.fireEvent('dateChanged', this.date);
			window.fireEvent('elementChanged', { element: this.output });
			this.output.fireEvent('change', { target: this.output });
		}
		this.doEvent = true;
		return true;
	},

	getDate: function () {
		var date = this.getDateObject();
		if(date){
			return date.format(this.options.outputFormat);
		}
		return false;
	},

	getDateObject: function () {
		if (this.__selectedDate) {
			return this.__selectedDate;
		}
		if (!this.options.nullable) {
			if (this.date) {
				return this.date;
			}
			if (this.__uiDate) {
				return this.__uiDate;
			}
		}
		return false;
	},

	getRawDate: function () {
		if (!this.__selectedDate) {
			return false;
		}
		if (this.output.value === '') {
			return false;
		}
		var check = Date.parse(this.output.value);
		if (check !== null && typeOf(check) && check.isValid()) {
			return check;
		}
		return false;
	},

	setDate: function (passedDate, doEvent) {

		if (passedDate && typeOf(passedDate) !== 'date') {
			try {
				passedDate = Date.parse(passedDate);
			} catch (e) {
				return;
			}
		}

		if (passedDate && typeOf(passedDate) === 'date' && passedDate.isValid()) {

			/* If we have passed a date to set, use that */

			if (typeOf(doEvent) === 'boolean' && doEvent === false) {
				this.doEvent = false;
			}
			this.date = passedDate;
			this.__uiDate = passedDate.clone();
			this.__selectedDate = passedDate.clone();

			this.setupCalendar();
			this.setCalendarDate();
			this.doEvent = true;

		} else {

			if (this.options.nullable) {

				/* If we have NOT passed a date to set, and we are nullable, re-set to init settings */

				if (typeOf(doEvent) === 'boolean' && doEvent === false) {
					this.doEvent = false;
				}

				this.__uiDate = new Date();
				this.date = this.__selectedDate = false;

				this.setupCalendar();

        this.output.value = '';
				this.display.value = '';
				this.doEvent = true;

			} else {

				/* If we have NOT passed a date to set, and we are NOT nullable, re-set to today */

				this.date = new Date();
				this.__uiDate = this.date.clone();
				this.__selectedDate = this.date.clone();

				this.setupCalendar();
				this.setCalendarDate();
				this.doEvent = true;

			}
		}
	},

	setToday: function (e) {
		this.date = new Date();
		this.__uiDate = this.date.clone();
		this.__selectedDate = this.date.clone();
		this.dontClose = false;
		this.setupCalendar(true);
	},

	setNone: function (e) {
	    this.date = this.__uiDate = new Date();
		this.__selectedDate = false;
		this.output.value = '';
		this.display.value = '';
		this.showDefault = false;
		this.dontClose = false;
		this.output.fireEvent('change', { target: this.output });
	},

	attemptParse: function (e) {

	    if (typeOf(e) !== 'null' && e.type && e.type === 'blur') {
	        if (this.status === 'open' && this.calendarOver) {
	            return;
	        }
	    }

	    if (!this.options.showCalendar && this.options.showTime && this.timeWidget) {
	        //this.timeWidget.addEvent('timeSet', function () { this.attemptParseCont(e); });
	        /* This is now handled by TimePiccker (as it should!) */
	    } else {

	        var attemptStr = this.display.value;
	        var attemptedDate = false;

	        try {
	            attemptedDate = Date.parse(attemptStr);
	        } catch (e) {
	            console.log(e);
	        }

	        if (attemptedDate && typeOf(attemptedDate) == 'date') {
	            if (!attemptedDate.isValid()) {
	                this.__selectedDate = false;
	                this.display.value = 'Invalid Date. No date set.';
	                this.output.value = '';
	                this.output.fireEvent('change', { target: this.output });
	            } else {

	                var tempdate = this.__selectedDate ? this.__selectedDate.clone() : false;

	                this.date = attemptedDate;
	                this.__uiDate = attemptedDate.clone();
	                this.__selectedDate = attemptedDate.clone();

	                if (typeOf(e) !== 'null') {
	                    this.setupCalendar(true);
	                } else {
	                    this.setupCalendar();
	                }

	                if (!tempdate || attemptedDate.setMilliseconds(0) !== this.date.setMilliseconds(0)) {
	                    this.setCalendarDate();
	                    this.output.fireEvent('change', { target: this.output });
	                }
	            }
	        } else {
	            if (this.options.nullable) {
	                this.output.value = '';
	                this.__uiDate = new Date();
	                this.date = this.__selectedDate = false;
	                this.output.fireEvent('change', { target: this.output });
	            } else {
	                if (this.__selectedDate) {
	                    this.display.value = this.__selectedDate.format(this.options.displayFormat);
	                } else {
	                    this.display.value = this.__uiDate.format(this.options.displayFormat);
	                }
	                if (this.printField) {
	                    this.printField.set('html', this.display.value);
	                }
	            }
	        }

	        this.hide(null, 'attemptParse ' + this.id);

	    }
	},

	/* process UI components */

	positionOverride: false,
	position: function () {
		var position = this.positionOverride ? this.positionOverride.getPosition() : this.display.getPosition();
		var size = this.positionOverride ? this.positionOverride.getSize() : this.display.getSize();
		//var parent = /*this.display.getParent('#uimodal') ? this.display.getParent('#uimodal') : */window;
		var windwSize = window.getSize();
		var top = position.y + size.y + 5;
		var left = position.x;
		var scale, styles;
		var cssPosition = this.options.cssPosition;

		var calendarSize = this.calendarBox.measure(function () {
			return this.getSize();
		});

		if (Affinity.mobile) {

			if (!this.calendarBox.hasClass('scaled')) {

				left = 0;

				size = calendarSize;
				var windwSize = parent.getSize();
				windwSize.x -= 40;
				windwSize.y -= 40;

				if (size.x > size.y) {
					scale = Number(windwSize.x / size.x).round(2);
				} else {
					scale = Number(windwSize.y / size.y).round(2);
				}

				if ((size.y * scale) > windwSize.y) {
					scale = Number(windwSize.y / size.y).round(2);
				}

				if ((size.x * scale) > windwSize.x) {
					scale = Number(windwSize.x / size.x).round(2);
				}

				if ((windwSize.x + 40) > (size.x * scale)) {
					left = ((windwSize.x + 40) - (size.x * scale)) / 2;
				}

				styles = {
					'position': 'fixed',
					'top': left,
					'left': left,
					'-webkit-transform': 'scale(' + scale + ')',
					'-webkit-transform-origin': '0 0',
					'transform': 'scale(' + scale + ')',
					'transform-origin': '0 0'
				};

				this.calendarBox.setStyles(styles);
				this.calendarBox.addClass('scaled');

			}

			return;

		} else {
		    if (windwSize.y - (position.y - window.getScroll().y) < calendarSize.y) {
				top = position.y - calendarSize.y - 5;
			}
		    if ((position.x - window.getScroll().x) + calendarSize.x > windwSize.x) {
				left = windwSize.x - calendarSize.x - 5;
			}
			if (cssPosition === 'fixed') {
			    top -= window.getScroll().y;
			}
			styles = {
				'position': cssPosition,
				'top': top,
				'left': left
			};
		}

		this.calendarBox.setStyles(styles);

		if (this.delayedRePosition) {
		    clearTimeout(this.delayedRePosition);
		}

		this.delayedRePosition = setTimeout(function () {
		    this.calendarBox.setStyles(styles);
		}.bind(this), 500);

	},

	/**/

	watchOutputChanges: function(){
		var value = this.output.value;
		var attempt = Date.parse(value);
		if (attempt && attempt.hasOwnProperty('isValid') && attempt.isValid() && attempt!==this.date) {
			this.setDate(attempt, false);
		}
	},

	/**/

	externalShow: function (e) {
		e.stopPropagation();
		Affinity.UI.calendars.hideAll(this);
		if (Affinity.mobile) {
			this.display.blur();
		}
		this.show();
	},

	obscure: function () {
		this.hide();
		if (this.showbutton) { this.showbutton.addClass('hidden'); }
		if (this.todaybutton) { this.todaybutton.addClass('hidden'); }
		if (this.clearbutton) { this.clearbutton.addClass('hidden'); }
		if (this.display) { this.display.addClass('hidden'); }
	},

	reveal: function () {
		if (this.showbutton) { this.showbutton.removeClass('hidden'); }
		if (this.todaybutton) { this.todaybutton.removeClass('hidden'); }
		if (this.clearbutton) { this.clearbutton.removeClass('hidden'); }
		if (this.display) { this.display.removeClass('hidden'); }
	},

	show: function (e) {
        if (!this.options.showInline) {
            Affinity.UI.calendars.hideAll(this);
            this.position();
        }
		this.calendarBox.reveal();
		this.status = 'open';
	},

	hide: function (e, who) {
	    if (this.options.showInline) {
	        return;
	    }
		if (!this.dontClose) {
			if (this.monthbox) {
				this.monthbox.dissolve();
			}
			if (this.yearbox) {
				this.yearbox.dissolve();
			}
			if (this.calendarContainer) {
				this.calendarContainer.reveal();
			}
			if (this.calendarBox) {
				this.calendarBox.dissolve();
			}
			this.status = 'closed';
		}
	},

	destroy: function () {
		clearInterval(this.checkExistsPeriodical);
		if (this.showbutton) { this.showbutton.removeEvents(); }
		if (this.todaybutton) { this.todaybutton.removeEvents(); }
		if (this.clearbutton) { this.clearbutton.removeEvents(); }
		if (this.display) { this.display.removeEvents(); }
		document.removeEvent(Affinity.events.click, this.documentClick);
		if (this.options.showCalendar) {
			if (this.calendarContainer) {
				Array.each(this.calendarContainer.getElements('.ui-calendar-day'), function (el) {
					el.removeEvents();
					el.destroy();
				}.bind(this));
				this.calendarContainer.set('reveal', null);
				this.calendarContainer.set('tween', null);
				this.calendarContainer.removeEvents();
			}
			if (this.monthbox) {
				Array.each(this.monthbox.getElements('span'), function (el) {
					el.removeEvents();
					el.destroy();
				}.bind(this));
				this.monthbox.set('reveal', null);
				this.monthbox.set('tween', null);
				this.monthbox.removeEvents();
			}
			if (this.yearbox) {
				Array.each(this.yearbox.getElements('span'), function (el) {
					el.removeEvents();
					el.destroy();
				}.bind(this));
				this.yearbox.set('reveal', null);
				this.yearbox.set('tween', null);
				this.yearbox.removeEvents();
			}
			if (this.nextButton) { this.nextButton.removeEvents(); }
			if (this.lastButton) { this.lastButton.removeEvents(); }
			if (this.yearButton) { this.yearButton.removeEvents(); }
			if (this.monthButton) { this.monthButton.removeEvents(); }
		}
		if (this.options.showTime) {
			this.timeWidget.destroy();
		}
		if (Affinity.UI.calendars.widgets[this.uuid]) {
			Affinity.UI.calendars.widgets[this.uuid] = null;
			delete Affinity.UI.calendars.widgets[this.uuid];
		}
		if (this.buttons) {
			this.buttons.empty();
			this.buttons.destroy();
		}
		if (this.display) { this.display.destroy(); }
		if (this.output) { this.output.destroy(); }
		if (this.calendarBox) {
			this.calendarBox.set('reveal', null);
			this.calendarBox.set('tween', null);
			this.calendarBox.removeEvents();
			this.calendarBox.empty();
			this.calendarBox.destroy();
		}
		if(this.options.target){
			try{
				this.options.target.eliminate('widget');
				this.options.target.destroy();
			}catch(e){}
		}
		Object.each(this, function (val, key) {
			this[key] = null;
			delete this[key];
		}.bind(this));
	}

});
;
var UIDateDropDowns = new Class({

    Implements: [Options],

    Binds: [
        'processDates', 'setDate'
    ],

    options: {
        dateMooFormat: '%d.%m.%Y'
    },

    initialize: function (options) {

        this.setOptions(options);

        this.days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        this.months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];

        this.today = new Date();

        this.dateInputs = document.getElements('input.date-drops');

        Array.each(this.dateInputs, this.processDates);

    },

    processDates: function (dateInput) {

        dateInput.set('type', 'hidden');

        var i, year, checkdate;
        if (dateInput.value != '') {
            checkdate = Date.parse(dateInput.value);
            if(checkdate.isValid()){
                this.today = checkdate;
            }
        }

        var dateDiv = new Element('div', { 'class': 'datepicker' }).inject(dateInput, 'before');
        var daydrop = new Element('select', { 'class': 'date-day' }).inject(dateDiv);
        var monthdrop = new Element('select', { 'class': 'date-month' }).inject(dateDiv);
        var yeardrop = new Element('select', { 'class': 'date-year' }).inject(dateDiv);
        new Element('br').inject(dateDiv);
        new Element('span').inject(dateDiv);
        dateDiv.adopt(dateInput);

        /**/

        var defaultdate = false;
        if (dateDiv.getElement('input').value != '') {
            defaultdate = Date.parse(dateDiv.getElement('input').value);
            if (defaultdate === null) {
                defaultdate = false;
            }
        }

        /**/

        new Element('option', { value: '', html: '' }).inject(daydrop);
        for (i = 0; i < 31; i++) {
            new Element('option', { value: i + 1, html: i + 1 }).inject(daydrop);
        }
        if (defaultdate) {
            daydrop.value = parseInt(this.today.format('%e'), 10);
        }

        /**/

        new Element('option', { value: '', html: '' }).inject(monthdrop);
        for (i = 0; i < 12; i++) {
            new Element('option', { value: i, html: this.months[i].capitalize() }).inject(monthdrop);
        }
        if (defaultdate) {
            monthdrop.value = parseInt(this.today.format('%m'), 10) - 1;
        }

        /**/

        new Element('option', { value: '', html: '' }).inject(yeardrop);
        year = parseInt(this.today.format('%Y'), 10);
        for (i = year - 100; i < year+10 ; i++) {
            new Element('option', { value: i, html: i }).inject(yeardrop);
        }
        if (defaultdate) {
            yeardrop.value = year;
        }

        /**/

        daydrop.addEvent('change', this.setDate);
        monthdrop.addEvent('change', this.setDate);
        yeardrop.addEvent('change', this.setDate);

        this.setDate(null, dateDiv);

    },

    setDate: function (e, dateDiv) {

        if (e != null) {
            dateDiv = e.target.getParent();
        }

        var drops = dateDiv.getElements('select');

        if (drops[0].value === '' || drops[1].value === '' || drops[2].value === '') {

            dateDiv.getElement('input').value = '';
            dateDiv.getElement('span').set('html', '');
            return;

        }else{

            var mydate = new Date().set('year', drops[2].value).set('month', drops[1].value).set('date', drops[0].value).set('hr', 0).set('min', 0).set('sec', 0).set('ms', 0);

            if (mydate.isValid()) {
                dateDiv.getElement('input').value = mydate.format(this.options.dateMooFormat);
                dateDiv.getElement('span').set('html', mydate.format('%A the %e%o of %B %Y'));
            }

            delete mydate;

        }

        delete drops;

    }


});;

var UIDisplayLookup = new Class({

    Version: '1.0.2.0',
    File: 'ui.display.lookup.js',

    Implements: [Options],

    Binds: [
		'processLookup', 'requestLookup', 'populateSelect',
        'processNew',
        'setValue',
        'refreshQueue', 'cancelQueue',
        'processQueue'
    ],

    options: {
        jsonp: false
    },

    enabled: false,

    initialize: function (options) {

        this.setOptions(options);

        if (!Affinity.UI) { Affinity.UI = {}; }
        if (!Affinity.UI.displaylookups) { Affinity.UI.displaylookups = {}; }

        Affinity.UI.displaylookupLoaders = [];

        window.addEvent('refreshQueues', this.refreshQueue);
        window.addEvent('loggedout', this.cancelQueue);
        window.addEvent('loggedin', function () {
            this.enabled = true;
            this.processNew();
        }.bind(this));

        this.processNew();

    },

    processNew: function (options) {

        this.setOptions(options);

        var lookups = document.getElements('.has-display-lookup');

        Array.each(lookups, this.processLookup);

        this.processQueue();

        delete lookups;

    },

    processLookup: function (element) {

        var id, api, apiKey;
        if (element.get('data-lookup-api')) {
            element.removeClass('has-display-lookup');
            if (element.get('data-lookup-api') !== '') {
                api = element.get('data-lookup-api');
				api = Affinity.GetCacheSafePath(api);
				/*
                if (Affinity && Affinity.isie && Affinity.ieversion <= 9) { /* Defeat IE9 and less from caching (IE9 ignores headers) *
                    if (api.contains('?')) {
                        api += '&ran=' + String.uniqueID() + Date.parse(new Date()).format('%s');
                    } else {
                        api += '?ran=' + String.uniqueID() + Date.parse(new Date()).format('%s');
                    }
                }
				*/
                apiKey = this.getApiKey(api);
                if(Affinity.UI.displaylookups[apiKey]){
                    if (!Affinity.UI.displaylookups[apiKey].elements.contains[element]) {
                        Affinity.UI.displaylookups[apiKey].elements.push(element);
                    }
                }else{
                    Affinity.UI.displaylookups[apiKey] = {
                        api: api,
                        id: 'dis_lookup_' + String.uniqueID(),
                        type: 'display',
                        loaded: false,
                        elements: [element]
                    };
                }
            }
        }
    },

    getApiKey: function (api) {

        var uri = new URI(api.toLowerCase()),
            qBits = uri.get('query').parseQueryString(),
            qBitsArray = [],
            paramsStrArray = [],
            params = false,
            paramsStr = '',
            paramsArray, uriStr, key;

        Object.each(qBits, function (val, key) {
            if (key.toLowerCase() !== 'ran') {
                if (key !== 'parameters') {
                    qBitsArray.push(key + '-' + val);
                } else {
                    params = JSON.parse(val);
                }
            }
        });
        qBitsArray = qBitsArray.sort();

        if (params && typeOf(params) === 'object' && 'parameter' in params && typeOf(params.parameter) === 'array') {
            Array.each(params.parameter, function (paramObj) {
                paramsArray = [];
                Object.each(paramObj, function (val, key) {
                    if (key.toLowerCase() !== 'ran') {
                        paramsArray.push(key + '-' + val);
                    }
                });
                paramsArray.sort();
                paramsStrArray.push(paramsArray.join('|'));
            });
            paramsStrArray.sort();
            paramsStr = '|parameters|' + paramsStrArray.join('||');
        }

        uriStr = qBitsArray.join('|') + paramsStr;
        key = 'display-' + uriStr.replace(/\//g, '.');

        return key;

        //return 'display-' + api.replace(/[^a-zA-Z0-9_-]/g, '-') + '-' + Affinity.uisession;
    },
    
    refreshQueue: function () {

        log('&#171; REFRESH ALL DISPLAY LOOKUPS &#187;');

        this.enabled = false;

        Array.each(Affinity.UI.displaylookupLoaders, function (loader) {
            if ('cancel' in loader) {
                loader.cancel();
            }
            loader.removeEvents();
            loader = null;
        });
        Affinity.UI.displaylookupLoaders = [];
        Object.each(Affinity.UI.displaylookups, function (value, apiKey) {
            Affinity.UI.displaylookups[apiKey].loaded = false;
            Affinity.UI.displaylookups[apiKey].data = null;
        });

        this.enabled = true;

        window.fireEvent('lookupCacheClear');
    },

    cancelQueue: function () {

        log('&#171; CANCEL AND CLEAR ALL DISPLAY LOOKUPS &#187;');

        this.enabled = false;

        Array.each(Affinity.UI.displaylookupLoaders, function (loader) {
            if ('cancel' in loader) {
                loader.cancel();
            }
            if ('removeEvents' in loader) {
                loader.removeEvents();
            }
            loader = null;
        });
        Affinity.UI.displaylookupLoaders = [];
        Object.each(Affinity.UI.displaylookups, function (value, apiKey) {
            Affinity.UI.displaylookups[apiKey].loaded = false;
            Affinity.UI.displaylookups[apiKey].data = null;
            Affinity.UI.displaylookups[apiKey].elements = [];
            Affinity.UI.displaylookups[apiKey] = null;
            delete Affinity.UI.displaylookups[apiKey];
        });
        Affinity.UI.displaylookups = {};

    },

    processQueue: function () {

        var loader, url;
        
        try {

            Object.each(Affinity.UI.displaylookups, function (value, apiKey) {

                if (!this.enabled) {
                    log('! display lookup queue disabled - process stooped !');
                    throw('break Object.each');
                    return;
                }

                if (Affinity.UI.displaylookups[apiKey].loaded === true) {
                    this.setElements(apiKey);
                }
                if (Affinity.UI.displaylookups[apiKey].loaded === false) {

                    url = Affinity.UI.displaylookups[apiKey].api;

                    if (!url.contains('ran=')) {
                        if (url.contains('?')) {
                            url = url += '&ran=' + String.uniqueID();
                        } else {
                            url = url += '?ran=' + String.uniqueID();
                        }
                    }

                    Affinity.UI.displaylookups[apiKey].loaded = 'loading...';

                    /* TODO: REMOVE THIS!! For debugging 'lookup unauthorised' auto log out *

                    var uriObj = new URI(url);
                    var query = uriObj.parsed.query.parseQueryString();

                    log('&#x2794; attempting display lookup (id: ' + Affinity.UI.displaylookups[apiKey].id + ', data: ' + unescape(Object.toQueryString(query)) + ', apiKey: ' + apiKey + ' )...');

                    /**/

                    if (this.options.jsonp) {

                        loader = new Request.JSONP({
                            callbackKey: 'jsoncallback',
                            url: url,
                            method: 'get',
                            noCache: true,
                            onComplete: function (jsonData) {
                                if (!JSON.Unauthorized(jsonData, Affinity.UI.displaylookups[apiKey].id)) {
                                    Affinity.UI.displaylookups[apiKey].data = jsonData;
                                    if (typeOf(jsonData.success) !== 'null' && jsonData.success === false) {

                                        //log('&#x2718; attempted display lookup (id: ' + Affinity.UI.displaylookups[apiKey].id + ') succeeded with errors - ' + jsonData.error);

                                        this.setError(apiKey, jsonData.error && jsonData.error !== '' ? jsonData.error : 'There was an error retrieving this data');
                                    } else {

                                        //log('&#x2714; attempted display lookup (id: ' + Affinity.UI.displaylookups[apiKey].id + ')  succeeded');

                                        Affinity.UI.displaylookups[apiKey].loaded = true;
                                        this.setElements(apiKey);
                                    }
                                }
                            }.bind(this)
                        });

                    } else {

                        loader = new Request.JSON({
                            url: url,
                            method: 'get',
                            noCache: true,
                            onSuccess: function (jsonData) {
                                if (!JSON.Unauthorized(jsonData, Affinity.UI.displaylookups[apiKey].id)) {
                                    Affinity.UI.displaylookups[apiKey].data = jsonData;
                                    if (typeOf(jsonData.success) !== 'null' && jsonData.success === false) {

                                        //log('&#x2718; attempted display lookup (id: ' + Affinity.UI.displaylookups[apiKey].id + ') succeeded with errors - ' + jsonData.error);

                                        this.setError(apiKey, jsonData.error && jsonData.error !== '' ? jsonData.error : 'There was an error retrieving this data');
                                    } else {

                                        //log('&#x2714; attempted display lookup (id: ' + Affinity.UI.displaylookups[apiKey].id + ')  succeeded');

                                        Affinity.UI.displaylookups[apiKey].loaded = true;
                                        this.setElements(apiKey);
                                    }
                                }
                            }.bind(this)
                        });

                    }

                    if (loader) {
                        Affinity.UI.displaylookupLoaders.push(loader);
                        loader.send();
                    }

                }

            }.bind(this));

        } catch (e) { }

    },

    setError: function (apiKey, error) {
        Array.each(Affinity.UI.displaylookups[apiKey].elements, function (element) {
            new Element('span', { 'class': 'errorstr inplace-of-input', 'html': error }).inject(element, 'after');
            element.addClass('hidden');
        }.bind(this));
    },

    setElements: function (apiKey) {

        Array.each(Affinity.UI.displaylookups[apiKey].elements, function (element) {
            if (typeOf(element) !== 'null' && typeOf(element.get) === 'function' && element.get('data-lookup-api')) {
                this.setValue(Affinity.UI.displaylookups[apiKey].data, element);
                //element.erase('data-lookup-api');
            }
        }.bind(this));

    },

    setValue: function(jsonData, element){

        if (typeOf(jsonData) === 'array' && jsonData.length > 0 && typeOf(jsonData[0].Value) !== 'null' && jsonData[0].Value !== '') {

            var value = jsonData[0].Value.trim();
            if (Affinity.appname!=='cleverforms') {
                value = (jsonData[0].Value.split(',').sort(function (a, b) { return b.length - a.length; })[0]).trim();
            }

            if (element.getElement('.display') || element.hasClass('display')) {
                if (element.getElement('.display')) {
                    element.getElement('.display').set('html', value);
                }
                if (element.hasClass('display')) {
                    element.set('html', value);
                }
            }else{
                if('value' in element){
                    element.value = value;
                } else {
                    element.set('html', value);
                }
            }

            element.fireEvent('lookupComplete', { defaultValue: value, value: value, target: element });

            delete value;

        }


    }

});;

var UIDrawPanels = new Class({

    Version: '1.0.0.0',
    File: 'ui.drawpanel.js',

    Implements: [Options],

    Binds: [
        'init','processDrawPad'
    ],

    options: {
    },

    initialize: function (options) {

        this.setOptions(options);

        this.init();

    },

    canvasSupported: function(){

        if(Browser.IE && Borwser.version<9){
            return false; // will not work for old browsers
        }
        var canvasTest = document.createElement('canvas');

        if (typeof (canvasTest.getContext) == 'undefined' || typeOf(canvasTest.getContext('2d')) == 'undefined') {
            delete canvasTest;
            return false; // Canvas must be supported
        }

        canvasTest.destroy();
        delete canvasTest;
        return true;
    },

    processNew: function () {
        this.init();
    },

    init: function () {

        if (this.canvasSupported()) {

            Array.each(document.getElements('.ui-drawpad'), this.processDrawPad);

        }

    },

    processDrawPad: function (element, index) {

        element.removeClass('ui-drawpad');

        var bgimages = '';
        var bgwidths = '';
        var bgheights = '';

        var bgImageData = [];

        if (element.get('data-bg-image') != null && element.get('data-bg-image') != "") {
            bgnames = element.get('data-bg-name').split('||');
            bgimages = element.get('data-bg-image').split('||');
            bgwidths = element.get('data-bg-image-width').split('||');
            bgheights = element.get('data-bg-image-height').split('||');
            Array.each(bgimages, function (bgimage, index){
                bgImageData.push({
                    name: bgnames[index],  
                    image: bgimages[index],
                    width: bgwidths[index],
                    height: bgheights[index] 
                });
            });
        }

        new UIDrawPanel({
            element: element,
            bgImageData: bgImageData
        });

    }

});

var UIDrawPanel = new Class({

    Implements: [Options],

    Binds: [
        'changeBgImage',
        'canvasDown','canvasUp',
        'setData','clear'
    ],

    options: {
        element: null,
        bgImageData: []
    },

    initialize: function (options) {

        this.setOptions(options);

        this.icons = {};
        this.icons.clear = Affinity.icons.CrossRound || '@Html.Raw(Affinity.UIFramework.Icons.CrossRound)';

        if(this.options.element==null){
            throw new Error('element must be set in options.') ;
            return;
        }

        var name = this.options.element.get('name');
        var id = this.options.element.get('id');
        var value = this.options.element.value;

        this.element = new Element('input', { 'type': 'hidden', 'value': value }).inject(this.options.element, 'after');
        this.options.element.destroy();
        delete this.options.element;

        if (name) { this.element.set('name', name); }
        if (id) { this.element.set('id', id); }

        var canvaswidth = 500;
        var canvasheight = Affinity.mobile ? 250 : 120;

        if (this.options.bgImageData.length>0) {
            canvaswidth = this.options.bgImageData[0].width;
            canvasheight = this.options.bgImageData[0].height;
        }
        this.canvas = new Element('canvas', { 'class': 'uidrawpanel', 'width': canvaswidth, 'height': canvasheight }).inject(this.element, 'after');

        this.canvas.width = canvaswidth;
        this.canvas.height = canvasheight;
        this.canvas.style.width = canvaswidth + 'px';
        this.canvas.style.height = canvasheight + 'px';

        this.drawPanel = new SignaturePad(this.canvas, {

        });
        this.canvas.addEventListener('CanvasReady', this.setData);

        if (this.options.bgImageData.length > 0) {
            if (this.options.bgImageData.length > 1) {

                new Element('br').inject(this.canvas, 'before');
                new Element('label', { 'html': 'Select Background' }).inject(this.canvas, 'before');
                this.imageSelect = new Element('select').addEvent('change', this.changeBgImage).inject(this.canvas, 'before');

                Array.each(this.options.bgImageData, function (imageData, index) {
                    this.imageSelect.adopt(new Element('option', { 'html': imageData.name, 'value': index}));
                }.bind(this));
                this.imageSelect.adopt(new Element('option', { 'html': 'No Image', 'value': -1 }));
            }
            this.changeBgImage({ target: { "value": 0 } });
        }

        this.clearButton = new Element('span', { 'html': '<span>' + this.icons.clear + '</span>Clear', 'class': 'button orange w-icon' }).inject(this.canvas, 'after');

        new Element('br').inject(this.element, 'before');
        new Element('br').inject(this.canvas, 'before');
        new Element('br').inject(this.canvas, 'after');

        this.clearButton.addEvent(Affinity.events.click, this.clear);
        
        this.canvas.addEvent(Affinity.events.start, this.canvasDown);
        this.canvas.addEvent(Affinity.events.end, this.canvasUp);
        document.addEvent(Affinity.events.end, this.canvasUp);

    },

    changeBgImage: function (e) {

        var imageData = this.options.bgImageData[e.target.value];

        if (imageData==null) {
            imageData = {
                width: 500,
                height: Affinity.mobile ? 250 : 120,
                image: null
            };
        }

        this.drawPanel.clear();
        this.element.value = '';

        this.canvas.width = imageData.width;
        this.canvas.height = imageData.height;
        this.canvas.style.width = imageData.width + 'px';
        this.canvas.style.height = imageData.height + 'px';

        if (imageData.image!==null) {
            this.drawPanel.fromDataURL(imageData.image);
        }

    },

    canvasDown: function(){
        this.eventIsDown = true;
    },

    canvasUp: function () {
        if (this.eventIsDown) {
            this.eventIsDown = false;
            this.setData();
        }
    },

    setData: function () {

        this.element.value = this.drawPanel.toDataURL();

    },

    clear: function () {

        this.drawPanel.clear();
        this.element.value = '';
        var index = {value: 0};
        if (this.options.bgImageData.length > 0) {
            if (this.options.bgImageData.length > 1) {
                index = this.imageSelect;
            }
            this.changeBgImage({ target: index });
        }
    }

});


/*
 * Signature Pad v1.2.4
 * https://github.com/szimek/signature_pad
 */
var SignaturePad = (function (document) {
    "use strict";

    var SignaturePad = function (canvas, options) {
        var self = this,
            opts = options || {};

        this.velocityFilterWeight = opts.velocityFilterWeight || 0.7;
        this.minWidth = opts.minWidth || 0.5;
        this.maxWidth = opts.maxWidth || 2.5;
        this.dotSize = opts.dotSize || function () {
            return (this.minWidth + this.maxWidth) / 2;
        };
        this.penColor = opts.penColor || "black";
        this.backgroundColor = opts.backgroundColor || "rgba(0,0,0,0)";

        this._canvas = canvas;
        this._ctx = canvas.getContext("2d");
        this.clear();

        this._handleMouseEvents();
        this._handleTouchEvents();
    };

    SignaturePad.prototype.clear = function () {
        var ctx = this._ctx,
            canvas = this._canvas;

        ctx.fillStyle = this.backgroundColor;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        this._reset();
    };

    SignaturePad.prototype.toDataURL = function (imageType, quality) {
        var canvas = this._canvas;
        return canvas.toDataURL.apply(canvas, arguments);
    };

    SignaturePad.prototype.fromDataURL = function (dataUrl) {
        var self = this,
            image = new Image();

        this._reset();
        image.src = dataUrl;
        image.onload = function () {
            self._ctx.drawImage(image, 0, 0, self._canvas.width, self._canvas.height);
            self._canvas.dispatchEvent(new CustomEvent('CanvasReady'));
        };
        this._isEmpty = false;
    };

    SignaturePad.prototype._strokeUpdate = function (event) {
        var point = this._createPoint(event);
        this._addPoint(point);
    };

    SignaturePad.prototype._strokeBegin = function (event) {
        this._reset();
        this._strokeUpdate(event);
    };

    SignaturePad.prototype._strokeDraw = function (point) {
        var ctx = this._ctx,
            dotSize = typeof (this.dotSize) === 'function' ? this.dotSize() : this.dotSize;

        ctx.beginPath();
        this._drawPoint(point.x, point.y, dotSize);
        ctx.closePath();
        ctx.fill();
    };

    SignaturePad.prototype._strokeEnd = function (event) {
        var canDrawCurve = this.points.length > 2;
        var point = this.points[0];
        if (!canDrawCurve && point) {
            this._strokeDraw(point);
        }
    };

    SignaturePad.prototype._handleMouseEvents = function () {
        var self = this;
        this._mouseButtonDown = false;

        this._canvas.addEventListener("mousedown", function (event) {
            if (event.which === 1) {
                self._mouseButtonDown = true;
                self._strokeBegin(event);
            }
        });

        this._canvas.addEventListener("mousemove", function (event) {
            if (self._mouseButtonDown) {
                self._strokeUpdate(event);
            }
        });

        document.addEventListener("mouseup", function (event) {
            if (event.which === 1 && self._mouseButtonDown) {
                self._mouseButtonDown = false;
                self._strokeEnd(event);
            }
        });
    };

    SignaturePad.prototype._handleTouchEvents = function () {
        var self = this;

        this._canvas.addEventListener("touchstart", function (event) {
            var touch = event.changedTouches[0];
            self._strokeBegin(touch);
        });

        this._canvas.addEventListener("touchmove", function (event) {
            // Prevent scrolling;
            event.preventDefault();

            var touch = event.changedTouches[0];
            self._strokeUpdate(touch);
        });

        document.addEventListener("touchend", function (event) {
            var wasCanvasTouched = event.target === self._canvas;
            if (wasCanvasTouched) {
                self._strokeEnd();
            }
        });
    };

    SignaturePad.prototype.isEmpty = function () {
        return this._isEmpty;
    };

    SignaturePad.prototype._reset = function () {
        this.points = [];
        this._lastVelocity = 0;
        this._lastWidth = (this.minWidth + this.maxWidth) / 2;
        this._isEmpty = true;
        this._ctx.fillStyle = this.penColor;
    };

    SignaturePad.prototype._createPoint = function (event) {
        var rect = this._canvas.getBoundingClientRect();
        return new Point(
            event.clientX - rect.left,
            event.clientY - rect.top
        );
    };

    SignaturePad.prototype._addPoint = function (point) {
        var points = this.points,
            c2, c3,
            curve, tmp;

        points.push(point);

        if (points.length > 2) {
            // To reduce the initial lag make it work with 3 points
            // by copying the first point to the beginning
            if (points.length === 3) points.unshift(points[0]);

            tmp = this._calculateCurveControlPoints(points[0], points[1], points[2]);
            c2 = tmp.c2;
            tmp = this._calculateCurveControlPoints(points[1], points[2], points[3]);
            c3 = tmp.c1;
            curve = new Bezier(points[1], c2, c3, points[2]);
            this._addCurve(curve);

            // Remove the first element from the list,
            // so that we always have no more than 4 points in points array.
            points.shift();
        }
    };

    SignaturePad.prototype._calculateCurveControlPoints = function (s1, s2, s3) {
        var dx1 = s1.x - s2.x, dy1 = s1.y - s2.y,
            dx2 = s2.x - s3.x, dy2 = s2.y - s3.y,

            m1 = { x: (s1.x + s2.x) / 2.0, y: (s1.y + s2.y) / 2.0 },
            m2 = { x: (s2.x + s3.x) / 2.0, y: (s2.y + s3.y) / 2.0 },

            l1 = Math.sqrt(dx1 * dx1 + dy1 * dy1),
            l2 = Math.sqrt(dx2 * dx2 + dy2 * dy2),

            dxm = (m1.x - m2.x),
            dym = (m1.y - m2.y),

            k = l2 / (l1 + l2),
            cm = { x: m2.x + dxm * k, y: m2.y + dym * k },

            tx = s2.x - cm.x,
            ty = s2.y - cm.y;

        return {
            c1: new Point(m1.x + tx, m1.y + ty),
            c2: new Point(m2.x + tx, m2.y + ty)
        };
    };

    SignaturePad.prototype._addCurve = function (curve) {
        var startPoint = curve.startPoint,
            endPoint = curve.endPoint,
            velocity, newWidth;

        velocity = endPoint.velocityFrom(startPoint);
        velocity = this.velocityFilterWeight * velocity
            + (1 - this.velocityFilterWeight) * this._lastVelocity;

        newWidth = this._strokeWidth(velocity);
        this._drawCurve(curve, this._lastWidth, newWidth);

        this._lastVelocity = velocity;
        this._lastWidth = newWidth;
    };

    SignaturePad.prototype._drawPoint = function (x, y, size) {
        var ctx = this._ctx;

        ctx.moveTo(x, y);
        ctx.arc(x, y, size, 0, 2 * Math.PI, false);
        this._isEmpty = false;
    };

    SignaturePad.prototype._drawCurve = function (curve, startWidth, endWidth) {
        var ctx = this._ctx,
            widthDelta = endWidth - startWidth,
            drawSteps, width, i, t, tt, ttt, u, uu, uuu, x, y;

        drawSteps = Math.floor(curve.length());
        ctx.beginPath();
        for (i = 0; i < drawSteps; i++) {
            // Calculate the Bezier (x, y) coordinate for this step.
            t = i / drawSteps;
            tt = t * t;
            ttt = tt * t;
            u = 1 - t;
            uu = u * u;
            uuu = uu * u;

            x = uuu * curve.startPoint.x;
            x += 3 * uu * t * curve.control1.x;
            x += 3 * u * tt * curve.control2.x;
            x += ttt * curve.endPoint.x;

            y = uuu * curve.startPoint.y;
            y += 3 * uu * t * curve.control1.y;
            y += 3 * u * tt * curve.control2.y;
            y += ttt * curve.endPoint.y;

            width = startWidth + ttt * widthDelta;
            this._drawPoint(x, y, width);
        }
        ctx.closePath();
        ctx.fill();
    };

    SignaturePad.prototype._strokeWidth = function (velocity) {
        return Math.max(this.maxWidth / (velocity + 1), this.minWidth);
    };


    var Point = function (x, y, time) {
        this.x = x;
        this.y = y;
        this.time = time || new Date().getTime();
    };

    Point.prototype.velocityFrom = function (start) {
        return (this.time !== start.time) ? this.distanceTo(start) / (this.time - start.time) : 1;
    };

    Point.prototype.distanceTo = function (start) {
        return Math.sqrt(Math.pow(this.x - start.x, 2) + Math.pow(this.y - start.y, 2));
    };

    var Bezier = function (startPoint, control1, control2, endPoint) {
        this.startPoint = startPoint;
        this.control1 = control1;
        this.control2 = control2;
        this.endPoint = endPoint;
    };

    // Returns approximated length
    Bezier.prototype.length = function () {
        var steps = 10,
            length = 0,
            i, t, cx, cy, px, py, xdiff, ydiff;

        for (i = 0; i <= steps; i++) {
            t = i / steps;
            cx = this._point(t, this.startPoint.x, this.control1.x, this.control2.x, this.endPoint.x);
            cy = this._point(t, this.startPoint.y, this.control1.y, this.control2.y, this.endPoint.y);
            if (i > 0) {
                xdiff = cx - px;
                ydiff = cy - py;
                length += Math.sqrt(xdiff * xdiff + ydiff * ydiff);
            }
            px = cx;
            py = cy;
        }
        return length;
    };

    Bezier.prototype._point = function (t, start, c1, c2, end) {
        return start * (1.0 - t) * (1.0 - t) * (1.0 - t)
               + 3.0 * c1 * (1.0 - t) * (1.0 - t) * t
               + 3.0 * c2 * (1.0 - t) * t * t
               + end * t * t * t;
    };

    return SignaturePad;
})(document);;
/* FileSaver.js
 *  A saveAs() & saveTextAs() FileSaver implementation.
 *  2014-06-24
 *
 *  Modify by Brian Chen
 *  Author: Eli Grey, http://eligrey.com
 *  License: X11/MIT
 *    See https://github.com/eligrey/FileSaver.js/blob/master/LICENSE.md
 */

/*global self */
/*jslint bitwise: true, indent: 4, laxbreak: true, laxcomma: true, smarttabs: true, plusplus: true */

/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */

var saveAs = saveAs
  // IE 10+ (native saveAs)
  || (typeof navigator !== "undefined" &&
      navigator.msSaveOrOpenBlob && navigator.msSaveOrOpenBlob.bind(navigator))
  // Everyone else
  || (function (view) {
      "use strict";
      // IE <10 is explicitly unsupported
      if (typeof navigator !== "undefined" &&
          /MSIE [1-9]\./.test(navigator.userAgent)) {
          return;
      }
      var
            doc = view.document
            // only get URL when necessary in case Blob.js hasn't overridden it yet
          , get_URL = function () {
              return view.URL || view.webkitURL || view;
          }
          , save_link = doc.createElementNS("http://www.w3.org/1999/xhtml", "a")
          , can_use_save_link = !view.externalHost && "download" in save_link
          , click = function (node) {
              var event = doc.createEvent("MouseEvents");
              event.initMouseEvent(
                  "click", true, false, view, 0, 0, 0, 0, 0
                  , false, false, false, false, 0, null
              );
              node.dispatchEvent(event);
          }
          , webkit_req_fs = view.webkitRequestFileSystem
          , req_fs = view.requestFileSystem || webkit_req_fs || view.mozRequestFileSystem
          , throw_outside = function (ex) {
              (view.setImmediate || view.setTimeout)(function () {
                  throw ex;
              }, 0);
          }
          , force_saveable_type = "application/octet-stream"
          , fs_min_size = 0
          , deletion_queue = []
          , process_deletion_queue = function () {
              var i = deletion_queue.length;
              while (i--) {
                  var file = deletion_queue[i];
                  if (typeof file === "string") { // file is an object URL
                      get_URL().revokeObjectURL(file);
                  } else { // file is a File
                      file.remove();
                  }
              }
              deletion_queue.length = 0; // clear queue
          }
          , dispatch = function (filesaver, event_types, event) {
              event_types = [].concat(event_types);
              var i = event_types.length;
              while (i--) {
                  var listener = filesaver["on" + event_types[i]];
                  if (typeof listener === "function") {
                      try {
                          listener.call(filesaver, event || filesaver);
                      } catch (ex) {
                          throw_outside(ex);
                      }
                  }
              }
          }
          , FileSaver = function (blob, name) {
              // First try a.download, then web filesystem, then object URLs
              var
                    filesaver = this
                  , type = blob.type
                  , blob_changed = false
                  , object_url
                  , target_view
                  , get_object_url = function () {
                      var object_url = get_URL().createObjectURL(blob);
                      deletion_queue.push(object_url);
                      return object_url;
                  }
                  , dispatch_all = function () {
                      dispatch(filesaver, "writestart progress write writeend".split(" "));
                  }
                  // on any filesys errors revert to saving with object URLs
                  , fs_error = function () {
                      // don't create more object URLs than needed
                      if (blob_changed || !object_url) {
                          object_url = get_object_url(blob);
                      }
                      if (target_view) {
                          target_view.location.href = object_url;
                      } else {
                          window.open(object_url, "_blank");
                      }
                      filesaver.readyState = filesaver.DONE;
                      dispatch_all();
                  }
                  , abortable = function (func) {
                      return function () {
                          if (filesaver.readyState !== filesaver.DONE) {
                              return func.apply(this, arguments);
                          }
                      };
                  }
                  , create_if_not_found = { create: true, exclusive: false }
                  , slice
              ;
              filesaver.readyState = filesaver.INIT;
              if (!name) {
                  name = "download";
              }
              if (can_use_save_link) {
                  object_url = get_object_url(blob);
                  save_link.href = object_url;
                  save_link.download = name;
                  click(save_link);
                  filesaver.readyState = filesaver.DONE;
                  dispatch_all();
                  return;
              }
              // Object and web filesystem URLs have a problem saving in Google Chrome when
              // viewed in a tab, so I force save with application/octet-stream
              // http://code.google.com/p/chromium/issues/detail?id=91158
              if (view.chrome && type && type !== force_saveable_type) {
                  slice = blob.slice || blob.webkitSlice;
                  blob = slice.call(blob, 0, blob.size, force_saveable_type);
                  blob_changed = true;
              }
              // Since I can't be sure that the guessed media type will trigger a download
              // in WebKit, I append .download to the filename.
              // https://bugs.webkit.org/show_bug.cgi?id=65440
              if (webkit_req_fs && name !== "download") {
                  name += ".download";
              }
              if (type === force_saveable_type || webkit_req_fs) {
                  target_view = view;
              }
              if (!req_fs) {
                  fs_error();
                  return;
              }
              fs_min_size += blob.size;
              req_fs(view.TEMPORARY, fs_min_size, abortable(function (fs) {
                  fs.root.getDirectory("saved", create_if_not_found, abortable(function (dir) {
                      var save = function () {
                          dir.getFile(name, create_if_not_found, abortable(function (file) {
                              file.createWriter(abortable(function (writer) {
                                  writer.onwriteend = function (event) {
                                      target_view.location.href = file.toURL();
                                      deletion_queue.push(file);
                                      filesaver.readyState = filesaver.DONE;
                                      dispatch(filesaver, "writeend", event);
                                  };
                                  writer.onerror = function () {
                                      var error = writer.error;
                                      if (error.code !== error.ABORT_ERR) {
                                          fs_error();
                                      }
                                  };
                                  "writestart progress write abort".split(" ").forEach(function (event) {
                                      writer["on" + event] = filesaver["on" + event];
                                  });
                                  writer.write(blob);
                                  filesaver.abort = function () {
                                      writer.abort();
                                      filesaver.readyState = filesaver.DONE;
                                  };
                                  filesaver.readyState = filesaver.WRITING;
                              }), fs_error);
                          }), fs_error);
                      };
                      dir.getFile(name, { create: false }, abortable(function (file) {
                          // delete file if it already exists
                          file.remove();
                          save();
                      }), abortable(function (ex) {
                          if (ex.code === ex.NOT_FOUND_ERR) {
                              save();
                          } else {
                              fs_error();
                          }
                      }));
                  }), fs_error);
              }), fs_error);
          }
          , FS_proto = FileSaver.prototype
          , saveAs = function (blob, name) {
              return new FileSaver(blob, name);
          }
      ;
      FS_proto.abort = function () {
          var filesaver = this;
          filesaver.readyState = filesaver.DONE;
          dispatch(filesaver, "abort");
      };
      FS_proto.readyState = FS_proto.INIT = 0;
      FS_proto.WRITING = 1;
      FS_proto.DONE = 2;

      FS_proto.error =
      FS_proto.onwritestart =
      FS_proto.onprogress =
      FS_proto.onwrite =
      FS_proto.onabort =
      FS_proto.onerror =
      FS_proto.onwriteend =
          null;

      view.addEventListener("unload", process_deletion_queue, false);
      saveAs.unload = function () {
          process_deletion_queue();
          view.removeEventListener("unload", process_deletion_queue, false);
      };
      return saveAs;
  }(
	   typeof self !== "undefined" && self
	|| typeof window !== "undefined" && window
	|| this.content
));
// `self` is undefined in Firefox for Android content script context
// while `this` is nsIContentFrameMessageManager
// with an attribute `content` that corresponds to the window

if (typeof module !== "undefined" && module !== null) {
    module.exports = saveAs;
} else if ((typeof define !== "undefined" && define !== null) && (define.amd != null)) {
    define([], function () {
        return saveAs;
    });
}

String.prototype.endsWithAny = function () {
    var strArray = Array.prototype.slice.call(arguments),
        $this = this.toLowerCase().toString();
    for (var i = 0; i < strArray.length; i++) {
        if ($this.indexOf(strArray[i], $this.length - strArray[i].length) !== -1) return true;
    }
    return false;
};

var saveTextAs = saveTextAs
|| (function (textContent, fileName, charset) {
    fileName = fileName || 'download.txt';
    charset = charset || 'utf-8';
    textContent = (textContent || '').replace(/\r?\n/g, "\r\n");
    if (saveAs && Blob) {
        var blob = new Blob([textContent], { type: "text/plain;charset=" + charset });
        saveAs(blob, fileName);
        return true;
    } else {//IE9-
        var saveTxtWindow = window.frames.saveTxtWindow;
        if (!saveTxtWindow) {
            saveTxtWindow = document.createElement('iframe');
            saveTxtWindow.id = 'saveTxtWindow';
            saveTxtWindow.style.display = 'none';
            document.body.insertBefore(saveTxtWindow, null);
            saveTxtWindow = window.frames.saveTxtWindow;
            if (!saveTxtWindow) {
                saveTxtWindow = window.open('', '_temp', 'width=100,height=100');
                if (!saveTxtWindow) {
                    window.alert('Sorry, download file could not be created.');
                    return false;
                }
            }
        }

        var doc = saveTxtWindow.document;
        doc.open('text/plain', 'replace');
        doc.charset = charset;
        if (fileName.endsWithAny('.htm', '.html')) {
            doc.close();
            doc.body.innerHTML = '\r\n' + textContent + '\r\n';
        } else {
            if (!fileName.endsWithAny('.txt')) fileName += '.txt';
            doc.write(textContent);
            doc.close();
        }

        var retValue = doc.execCommand('SaveAs', null, fileName);
        saveTxtWindow.close();
        return retValue;
    }
});
var UIFormatDate = new Class({

    Implements: [Options],
  
    Binds: [
      'init',
      'processDate'
    ],
  
    options:
    {
    },
  
    initialize: function (options)
    {
      this.setOptions(options);
      this.init();
    },
  
    processNew: function ()
    {
      this.init()
    },
  
    init: function ()
    {
      Array.each(document.getElements('.ui-format-date'), this.processDate);
    },
  
    processDate: function (el)
    {
      var isUTC = false, format, dateStr, date;
  
      format = '%I:%M:%S %p, %A %B %e%o %Y';
  
      if (el.get('data-date-format') && el.get('data-date-format').trim() !== '')
      {
        format = el.get('data-date-format').trim();
      }
  
      dateStr = el.get('html').trim();
  
      if (document.config.isie && dateStr.toLowerCase().contains('gmt'))
      {
        dateStr = dateStr.replace(/GMT/gi, 'UTC');
      }
  
      if (dateStr.toLowerCase().contains('.'))
      {
        dateStr = dateStr.replace(/\./gi, '/');
      }
  
      if (new RegExp('[0-9]T[0-9]', 'i').test(dateStr)) // has T time separator
      {
        dateStr = dateStr.replace(/(.*[0-9])t([0-9].*)/i, '$1 $2');
      }
  
      if (new RegExp('[0-9]Z', 'i').test(dateStr)) // has Z UTC placeholder
      {
        dateStr = dateStr.replace(/(.*[0-9])Z/i, '$1 UTC');
      }
  
      if (dateStr.toLowerCase().contains('utc'))
      {
        dateStr = dateStr.trim().replace(/(.*[0-9]) UTC/i, '$1'); // remove UTC again so we can offset with getTimezoneOffset and not rely on browser
        isUTC = true;
      }
  
      //date = Date.parse(dateStr);
      date = new Date(Date.parse(dateStr));
      if (isUTC) date = new Date(date.getTime() - date.getTimezoneOffset() * 60 * 1000); // localise from UTC
  
      if (date.isValid())
      {
        el.set('html', date.format(format));
      }
      
    }
  
  });;
/*                                                                                  *
 * This script belongs to the ui (user interface) package.                          *
 *                                                                                  *
 * The following code assumes MooTools Core 1.4.5 has been included.                *
 *                                                                                  */

/* USAGE

<table class="dynamic">
    <tr>
        <th data-name="id">
            Table ID
        </th>
        <th data-name="uuid">
            User ID
        </th>
        <th data-name="count">
            Count
        </th>
        <th data-name="date">
            Date
        </th>
    </tr>
    
    <tr>
        <td class="dynamic">
            -1
        </td>
        <td class="dynamic">
            6f5d4gs65g4
        </td>
        <td class="dynamic">
            123
        </td>
        <td class="dynamic">
            Thu 25th Jul 2013 15:19:19
        </td>
    </tr>
    
</table>

*/

/**
 * @class UIDynamicGrid
 *
 * Searches for dynamic tables.
 *
 */
var UIDynamicGrid = new Class({

    Implements: [Options],

    Binds: [
        'init',
        'moveUp','moveDn',
        'delRow', 'newRow',
        'inputReplace', 'inputReturn',
        'setOutputData', 'returnData',
        'handleCSVFile','saveCSV'
    ],

    options: {
        container: null
    },

    tables: {

    },

    initialize: function (options) {
        this.setOptions(options);

        this.docsv = false;
        this.iemode = false;
        if (document.config && document.config.isie && document.config.ieversion && document.config.ieversion > 10) {
            if (window.encodeURIComponent && window.FileReader) {
                this.docsv = true;
                this.iemode = true;
            }
        } else {
            if (window.encodeURIComponent && window.FileReader) {
                this.docsv = true;
            }
        }

        this.focused = null;

        this.input = new Element('input', {
            type: 'text',
            events: {
                'focus': function (e) {
                    this.focused = e.target;
                }.bind(this),
                'blur': function (e) {
                    this.focused = null;
                    this.inputReturn(e.target);
                }.bind(this)
            }
        });

        this.input.addEvent('keydown', function (e) {
            if (e.event.keyCode == 13) {
                e.stopPropagation();
                e.preventDefault();
                if (this.focused == e.target) {
                    this.focused.blur();
                }
            }
        }.bind(this));

        this.init();

    },

    init: function () {

        if (this.options.container == null) {
            this.options.container = document.body;
        }

        Array.each(document.getElements('table.dynamic'), function (el) {
            var table = el;
            var tableid = table.get('id');
            if (tableid == null) { tableid = String.uniqueID(); table.set('id', tableid); }
            if (!this.tables[tableid]) {
                this.tables[tableid] = table;
                if (this.docsv) {
                    this.csvUploader = new Element('input', { type: 'file', 'accept': '.csv' }).store('id', tableid).addEvent('change', this.handleCSVFile);
                    if (this.iemode) {
                        new Element('span', { 'class': 'csvdrop-ie button green', 'html': 'Load CSV' }).adopt(
                            this.csvUploader
                        ).inject(table.getElement('.new'), 'before');
                    } else {
                        new Element('span', { 'class': 'csvdrop ui-has-tooltip', 'data-tooltip': 'Drop CSV file here', 'data-tooltip-dir': 'top', 'html': Affinity.icons.Upload2 }).adopt(
                            this.csvUploader
                        ).inject(table.getElement('.new'), 'before');
                    }
                }
                if (document.id('listdata')) {
                    this.outputdatafield = document.id('listdata');
                }else{
                    this.outputdatafield = new Element('input', { id: 'listdata', name: 'listdata', type: 'hidden' });
                    this.outputdatafield.inject(table, 'after');
                }
                Array.each(table.getElements('td.dynamic'), function (tdel) {
                    tdel.addEvent('click', this.inputReplace);
                }.bind(this));
            }
            if (this.docsv) {
                new Element('span', { 'class': 'button w-icon green save' }).adopt(
                    new Element('span', {'html': Affinity.icons.Save}),
                    new Element('span', { 'html': 'Save list as CSV file' })
                ).store('id', tableid).addEvent('click', this.saveCSV).inject(table.getParent(), 'after');
            }
            Affinity.tooltips.processNew();
            this.zebra(table);
            this.setOutputData(table);
        }.bind(this));

        Array.each(document.getElements('table.dynamic .new, table.dynamic .del, table.dynamic .up, table.dynamic .dn'), function (el) {
            if (el.hasClass('new')) {
                el.addEvent('click', this.newRow);
            }
            if (el.hasClass('del')) {
                el.addEvent('click', this.delRow);
            }
            if (el.hasClass('up')) {
                el.addEvent('click', this.moveUp);
            }
            if (el.hasClass('dn')) {
                el.addEvent('click', this.moveDn);
            }
        }.bind(this));
    },

    inputReplace: function (e, td) {
        if (e !== null) {
            element = e.target.get('tag') == 'td' ? e.target : e.target.getParent('td');
            e.preventDefault();
            e.stopPropagation();
        } else {
            element = td;
        }
        if (!element.getElement('input')) {
            var content = element.get('html').stripTags().trim();
            element.empty();
            var dims = element.getComputedSize();
            this.input.setStyles({ width: dims.width - 10, height: dims.height - 2 });
            this.input.inject(element);
            content = content == 'Enter a value' ? '' : content;
            this.input.value = content;
            this.input.focus();
            element.setStyles({ width: dims.width, height: dims.height });
            delete content;
            delete dims;
        } else {
            this.input.focus();
        }
    },

    inputReturn: function (input) {
        if (input && input.get('tag') == 'input') {
            var parent = input.getParent();
            var table = input.getParents('table')[0];
            var content = input.value.stripTags().trim();
            content = content == '' ? 'Enter a value' : content;
            parent.empty();
            parent.set('html', content);
            this.setOutputData(table);
            delete content;
            delete parent;
            delete table;
        }
    },

    moveUp: function (e) {
        e.preventDefault();
        var table = e.target.getParent('table');
        var tbody = table.getElement('tbody');
        var template = table.getElement('.template').clone();
        table.getElement('.template').destroy();
        var row = e.target.getParent('tr');
        var rows = tbody.getElements('tr');
        var index = rows.indexOf(row);
        if(index>1){
            row.inject(rows[index - 1], 'before');
        }
        this.setOutputData(table);
        this.zebra(row.getParent('table'));
        template.inject(tbody);
        delete table;
        delete tbody;
        delete template;
        delete row;
        delete rows;
        delete index;
    },
        
    moveDn: function (e) {
        e.preventDefault();
        var table = e.target.getParent('table');
        var tbody = table.getElement('tbody');
        var template = table.getElement('.template').clone();
        table.getElement('.template').destroy();
        var row = e.target.getParent('tr');
        var rows = tbody.getElements('tr');
        var index = rows.indexOf(row);
        if (index < rows.length-1) {
            row.inject(rows[index + 1], 'after');
        }
        this.setOutputData(table);
        this.zebra(row.getParent('table'));
        template.inject(tbody);
        delete table;
        delete tbody;
        delete template;
        delete row;
        delete rows;
        delete index;
    },

    delRow: function (e) {
        e.preventDefault();
        var table = e.target.getParents('table')[0];
        e.target.getParents('tr')[0].destroy();
        this.setOutputData(table);
        this.zebra(table);
        delete table;
    },

    newRow: function (e) {
        try{e.preventDefault();}catch(err){}
        var table = e.target.getParents('table')[0];
        var tr = table.getElement('.template').clone();
        var target, where;
        if (e.target.getParents('th')[0]) {
            target = table;
            where = 'bottom';
        } else {
            target = e.target.getParents('tr')[0];
            where = 'after';
        }
        tr.removeClass('template');
        tr.removeClass('hidden');
        tr.inject(target, where);
        Array.each(tr.getElements('.new,.del,.up,.dn'), function (el) {
            if (el.hasClass('up')) { el.addEvent('click', this.moveUp); }
            if (el.hasClass('dn')) { el.addEvent('click', this.moveDn); }
            if (el.hasClass('new')) { el.addEvent('click', this.newRow); }
            if (el.hasClass('del')) { el.addEvent('click', this.delRow); }
        }.bind(this));
        Array.each(tr.getElements('td.dynamic'), function (el) {
            el.empty();
            el.addEvent('click', this.inputReplace);
        }.bind(this));
        this.inputReplace(null, tr.getElement('td.dynamic'));
        this.zebra(table);
    },

    zebra: function (table) {
        Array.each(table.getElements('tr'), function (row, index) {
            if (index > 0) {
                row.addClass('odd');
                if (index % 2 == 0) {
                    row.removeClass('odd');
                }
            }
        }.bind(this));
    },

    setOutputData: function (table) {
        var data = this.returnData(table, true);
        this.outputdatafield.value = data;
        return data;
    },

    returnData: function (table, json) {
        json = typeof json !== 'undefined' ? json : false;

        var row;
        var data = [];
        var datanames = table.getElements('tr th.has-data-name');
        var value;

        if (datanames.length > 1) {

            Array.each(table.getElements('tr'), function (tr, i) {
                if (i > 0) {
                    row = {};
                    Array.each(tr.getElements('td'), function (td, ii) {
                        if (td.hasClass('dynamic')) {
                            value = td.getElement('input') ? td.getElement('input').value.trim() : td.get('html').trim();
                            if (value != '' && value != 'Enter a value') {
                                row[datanames[ii].get('data-name')] = escape(value);
                            }
                        }
                    }.bind(this));
                    if (Object.getLength(row) > 0) {
                        data.push(row);
                    }
                }
            }.bind(this));

        } else {

            Array.each(table.getElements('tr'), function (tr, i) {
                Array.each(tr.getElements('td'), function (td, ii) {
                    if (td.hasClass('dynamic')) {
                        value = td.getElement('input') ? td.getElement('input').value.trim() : td.get('html').trim();
                        if (value != '' && value != 'Enter a value') {
                            data.push(escape(value));
                        }
                    }
                }.bind(this));
            }.bind(this));

        }

        if (json) {
            data = JSON.stringify(data);
        }

        return data;
    },

    handleCSVFile: function (e) {
        var input = e.target;
        var tableid = input.retrieve('id');
        var table = this.tables[tableid];
        var tbody = table.getElement('tbody');
        Affinity.prompts.hide();
        var reader = new FileReader();     
        reader.readAsText(input.files[0]);
        reader.onload = function(e){
            var csv = e.target.result;
            var allTextLines = csv.split(/\r\n|\n/);
            var i, tr;
            for (i = 0; i < allTextLines.length; i++) {
                if (allTextLines[i]!='') {
                    tr = table.getElement('.template').clone().removeClass('template').removeClass('hidden').inject(tbody, 'bottom');
                    Array.each(tr.getElements('.new,.del,.up,.dn'), function (el) {
                        if (el.hasClass('up')) { el.addEvent('click', this.moveUp); }
                        if (el.hasClass('dn')) { el.addEvent('click', this.moveDn); }
                        if (el.hasClass('new')) { el.addEvent('click', this.newRow); }
                        if (el.hasClass('del')) { el.addEvent('click', this.delRow); }
                    }.bind(this));
                    Array.each(tr.getElements('td.dynamic'), function (el) {
                        el.set('html', allTextLines[i]);
                        el.addEvent('click', this.inputReplace);
                    }.bind(this));
                }
            }
            this.zebra(table);
            input.files = [];
            input.value = '';
            this.setOutputData(table);
        }.bind(this);
        reader.onerror = function(e){
            if(e.target.error.name == "NotReadableError") {
                console.log("Can't read file!");
            }
        }.bind(this);
    },

    saveCSV: function (e) {

        var button = e.target.hasClass('save') ? e.target : e.target.getParent('.button.save');
        var tableid = button.retrieve('id');
        var table = this.tables[tableid];
        var tbody = table.getElement('tbody');

        var data = this.setOutputData(table);
        var plainText = unescape(data).replace('[', '').replace(']', '').split(',').join('\r\n');

        uiprompt({
            'message': 'Please enter a name for your file',
            onOk: function (filename) {

                if (this.iemode) {
                    saveTextAs(plainText, filename + '.csv');
                } else {
                    var blob = new Blob([plainText], { type: "text/plain;charset=utf-8" });
                    saveAs(blob, filename + '.csv');
                }

                //var dl = new Element('a', { 'download': filename + '.csv', 'href': 'data:text/plain;charset=utf-8,' + encodeURIComponent(plainText) });//.inject(document.body);
                //dl.click();

            }.bind(this)
        });

    }

});;
var UIGrid = new Class({

    Version: '1.0.0.0',
    File: 'ui.grid.js',

    Implements: [Options],

    Binds: [
        'processTables','setupTable','zebra'
    ],

    options: {

    },

    tables: {},

    initialize: function (options) {
        this.setOptions(options);
        this.processTables();
        Affinity.UI.Grids = {};
        Affinity.UI.Grids.Zebra = this.zebra;
    },

    processTables: function (table, zebraOnClass) {
        var id;
        if (table == null) {
            Array.each(document.getElements('table.ui-grid'), function (table) {
                id = table.get('id') == '' ? String.uniqueID() : table.get('id');
                if (typeOf(this.tables[id]) == 'null') {
                    this.tables[id] = table;
                    this.setupTable(table, zebraOnClass);
                } else {
                    this.zebra(table, zebraOnClass);
                }
            }.bind(this));
        } else {
			if(table.hasClass('ui-grid')){
				id = table.get('id') == '' ? String.uniqueID() : table.get('id');
				if (typeOf(this.tables[id]) == 'null') {
					this.tables[id] = table;
					this.setupTable(table, zebraOnClass);
				} else {
				    this.zebra(table, zebraOnClass);
				}
			}
        }
        delete id;
    },

    setupTable: function (table, zebraOnClass) {
        /*
        if (table.getElement('thead')) {
            table.getElement('thead').setStyles({
                'position': 'absolute',
                'width': table.getSize().x
            });
        }
        */
        this.zebra(table, zebraOnClass);
    },

    zebra: function (table, zebraOnClass) {
        var zebraOn = 'tr';
        if (typeof zebraOnClass !== 'undefined' && typeof zebraOnClass === 'string') {
            zebraOn = 'tr.' + zebraOnClass;
        }
		var tables = (table==null)?document.getElements('table.ui-grid'):[table];
		var oddind = 0;
		Array.each(tables, function (table) {
		    oddind = 0;
		    if ('getElements' in table) {
		        table.getElements(zebraOn).removeClass('odd');
		        Array.each(table.getElements('tbody ' + zebraOn), function (row, index) {
		            if (!row.hasClass('hidden')) {
		                row.addClass((oddind % 2 == 0) ? '' : 'odd');
		                oddind++;
		            }
		        }.bind(this));	
		    }
		}.bind(this));
        delete oddind;
    }

});;
var UISortableGrid = new Class({

    Version: '1.0.0.0',
    File: 'ui.grid.sortable.js',

    Implements: [Options, Events],

    Binds: [
        'checkTables', 'processTable',
        'multisort', 'sortColumn', 'clearSorting'
    ],

    options: {

    },

    tables: {},

    initialize: function (options)
    {

        this.setOptions(options);

        if (typeOf(UIGrid) != 'class' || typeOf(Affinity.uiGrid) == 'null')
        {
            throw new Error({ 'Missing Component': 'UISortableGrid requires UIGrid' });
        }

        this.icons = {};
        this.icons.unsorted = Affinity.icons.ArrowheadUpDown || '&#xe0cc;';
        this.icons.sortup = Affinity.icons.ArrowheadUp || '&#xe0ba;';
        this.icons.sortdn = Affinity.icons.ArrowheadDown || '&#xe0b9;';

        Array.each(document.getElements('table'), this.checkTables);

    },

    checkTables: function (table)
    {
        if (table.getElements('thead th.sort-on').length > 0)
        {
            this.processTable(table);
        }
    },

    processTable: function (table, zebraOnClass)
    {

        var id, cell;
        this.headers = table.getElements('thead th');
        var rows = table.getElements('tbody tr');
        var tableid = table.get('id') ? table.get('id') : String.uniqueID();

        if (table.get('data-icon'))
        {
            this.icons.unsorted = table.get('data-icon');
        }
        if (table.get('data-up-icon'))
        {
            this.icons.sortup = table.get('data-up-icon');
        }
        if (table.get('data-down-icon'))
        {
            this.icons.sortdn = table.get('data-down-icon');
        }

        table.set('id', tableid);

        this.tables[tableid] = {};
        this.tables[tableid].table = table;
        this.tables[tableid].columns = {};

        var headercount = 0;
        var cellcount = 0;

        Array.each(this.headers, function (header, index)
        {
            if (header.hasClass('sort-on'))
            {
                if (!header.getElement('div.icon'))
                {
                    header.adopt(new Element('div', { 'class': 'icon', 'html': this.icons.unsorted }));
                    header.addEvent('mousedown', function (e) { e.preventDefault(); })
                    header.addEvent('click', this.sortColumn);
                }
                this.tables[tableid].columns['h' + index] = {
                    method: header.get('data-sort-method'),
                    direction: -1,
                    sortables: []
                };
            }
        }.bind(this));

        var sortdata, method, content, date, number, numberStr;
        Array.each(rows, function (row, index)
        {
            Array.each(row.getElements('td'), function (cell, index)
            {
                sortdata = this.tables[tableid].columns['h' + index];
                if (sortdata)
                {
                    method = sortdata.method;
                    if (method === 'string')
                    {
                        content = cell.get('html').trim();
                        this.tables[tableid].columns['h' + index].sortables.push([content, cell]);
                    }
                    if (method === 'date')
                    {
                        content = cell.get('html').trim();
                        date = Date.parse(0);
                        if (content !== '') date = Date.parse(content);
                        this.tables[tableid].columns['h' + index].sortables.push([date, cell]);
                    }
                    if (method === 'float' || method === 'integer')
                    {
                        //console.log(cell.get('html').replace(/[\s,$]/g, ''));
                        content = cell.get('html').trim();
                        number = 0;
                        if (cell.get('html').trim() !== '')
                        {
                            numberStr = cell.get('html').replace(/[\s,$]/g, '');
                            number = Number.from(numberStr);
                        }
                        this.tables[tableid].columns['h' + index].sortables.push([number, cell]);
                    }
                }
                cellcount++;
            }.bind(this));
        }.bind(this));

        this.tables[tableid].total = cellcount;

        table.set('tween', { duration: 250 });

        Affinity.uiGrid.zebra(table, zebraOnClass);

        /* check last sort */

        if (Affinity.hasOwnProperty('pageId') || this.tables[tableid].table.classList.contains('resort'))
        {
            var key = 'AffinityLastSortGridData-' + tableid;
            if (Affinity.hasOwnProperty('pageId'))
            {
                key = 'AffinityLastSortGridData-' + Affinity.login.companyNumber + '-' + Affinity.login.profile.employeeNumber + '-' + Affinity.pageId;
            }  
            var lastSortData = Affinity.CookieMonster.Read(key),
                currenturl = (document.location.href.contains('?') ? document.location.href.split('?')[0] : document.location.href).toLowerCase(),
                lastMaxSortAgeInMins = 1,
                lastSortDate;

            if (lastSortData)
            {
                lastSortData = JSON.parse(lastSortData);
                lastSortDate = Date.parse(lastSortData.date);
                if (
                    lastSortData.href === currenturl
                    && new Date().getTime() - lastSortDate.getTime() < lastMaxSortAgeInMins * 60 * 30000
                )
                {
                    this.tables[table.get('id')].columns['h' + lastSortData.columnIndex].direction = lastSortData.direction * -1;
                    this.sortColumn({ target: table.getElements('th')[lastSortData.columnIndex] });
                }
                if (new Date().getTime() - lastSortDate.getTime() > lastMaxSortAgeInMins * 60 * 30000)
                {
                    Affinity.CookieMonster.Delete(key);
                }
            }
        }
    },

    multisort: function (a, b)
    {
        if (a[0] == b[0]) return 0;
        return a[0] < b[0] ? -1 : 1;
    },

    sortColumn: function (e)
    {
        if (this.tables[e.target.getParent('table').get('id')].total > 5000)
        {
            e.target.getParent('table').fade(0.25);
            this.continueSort.delay(500, this, [e]);
        }
        else
        {
            this.continueSort(e);
        }
    },

    continueSort: function (e)
    {

        var header = e.target.get('tag') === 'th' ? e.target : e.target.getParent('th');
        var table = header.getParent('table');
        var tablebody = table.getElement('tbody');
        var tableid = table.get('id');
        var sortable = this.tables[tableid].columns['h' + table.getElements('th').indexOf(header)];

        Array.each(table.getElements('thead th'), function (th)
        {
            if (th.getElement('.icon'))
            {
                th.getElement('.icon').set('html', this.icons.unsorted);
            }
        }.bind(this));

        sortable.direction *= -1;
        sortable.sortables.sort(this.multisort);
        if (sortable.direction < 0) sortable.sortables.reverse();
        header.getElement('.icon').set('html', sortable.direction > 0 ? this.icons.sortup : this.icons.sortdn);

        Array.each(sortable.sortables, function (data)
        {
            data[1].getParent('tr').inject(tablebody, 'top');
        }.bind(this));

        Affinity.uiGrid.zebra(table);

        table.fade(1);

        /* store last sort for pagination */

        if (Affinity.hasOwnProperty('pageId') || this.tables[tableid].table.classList.contains('resort'))
        {
            var lastSortData = {}, lastSortDataStr;
            lastSortData.date = new Date();
            lastSortData.href = (document.location.href.contains('?') ? document.location.href.split('?')[0] : document.location.href).toLowerCase();
            lastSortData.direction = sortable.direction;
            lastSortData.columnIndex = table.getElements('th').indexOf(header);
            lastSortDataStr = JSON.stringify(lastSortData);
            var key = 'AffinityLastSortGridData-' + tableid;
            if (Affinity.hasOwnProperty('pageId'))
            {
                key = 'AffinityLastSortGridData-' + Affinity.login.companyNumber + '-' + Affinity.login.profile.employeeNumber + '-' + Affinity.pageId;
            }
            Affinity.CookieMonster.Write(key, lastSortDataStr);
        }

    },

    clearSorting: function (table)
    {
        var tableid = table.get('id');
        for (var colKey in this.tables[tableid].columns)
        {
            if (this.tables[tableid].columns.hasOwnProperty(colKey) && this.tables[tableid].columns[colKey].hasOwnProperty('sortables'))
            {
                this.tables[tableid].columns[colKey].direction = -1;
                this.tables[tableid].columns[colKey].sortables = [];
            }
        }
        this.tables[tableid].table.classList.remove('resort');
        var key = 'AffinityLastSortGridData-' + tableid;
        if (Affinity.hasOwnProperty('pageId'))
        {
            key = 'AffinityLastSortGridData-' + Affinity.login.companyNumber + '-' + Affinity.login.profile.employeeNumber + '-' + Affinity.pageId;
        }
        Affinity.CookieMonster.Delete(key);
    },


    returnData: function (table, json)
    {
        json = typeof json !== 'undefined' ? json : false;
        var row;
        var data = [];
        var datanames = table.getElements('tr th');

        Array.each(table.getElements('tr'), function (tr)
        {
            row = {};
            Array.each(tr.getElements('td'), function (td, index)
            {
                row[datanames[index].get('data-name')] = td.get('html');
            }.bind(this));
            if (Object.getLength(row) > 0)
            {
                data.push(row);
            }
        }.bind(this));
        if (json)
        {
            return JSON.stringify(data);
        }
        return data;
    }

});;

var UIHelpBubble = new Class({

    Version: '1.0.0.0',
    File: 'ui.help.bubble.js',

    Implements: [Options],

    Binds: [
		'populate','alignTo','position',
		'hide','show'
    ],

    options: {
        fadeTime: 100
    },

    initialize: function (options) {
        this.setOptions(options);
        if(!document.getElement('.helpBubble.float')){
            this.helpBubble = new Element('div',{
                //'class': 'helpBubble right float shadow'
                'class': 'helpBubble right float'
            }).inject(document.body, 'bottom');
            this.helpBubble.set('tween', { duration: this.options.fadeTime });
            this.helpBubble.fade('hide');
			//this.helpBubble.addEvent(Affinity.events.outAll, function(e){ this.hide(); }.bind(this));
            //this.helpBubble.addEvent(Affinity.events.overAll, function(e){ this.show(); }.bind(this));
		}
	},
	
    populate: function (content) {
        if (this.helpBubble) {
            this.helpBubble.empty();
            if (typeOf(content) == 'element') {
                this.helpBubble.adopt(content);
            }
            if (typeOf(content) == 'string') {
                this.helpBubble.set('html', content);
            }
            this.addClass('right');
            this.setDirection('left');
        }
	},
	
	alignTo: function(el){
		var pos = el.getPosition();
		var size = el.getSize();
		this.position({x:pos.x+size.x+5,y:pos.y+(size.y/2)-15});
	},

	setDirection: function (direction) {
	    if (this.helpBubble) {
	        direction = direction.toLowerCase().trim() || 'left';
	        var directions = ['top', 'left', 'right', 'bottom', 'bottom-right', 'top-right'];
	        if (directions.contains(direction)) {
	            Array.each(directions, function (dir) {
	                this.helpBubble.removeClass(dir);
	            }.bind(this));
	            this.addClass(direction);
	        }
	    }
	},

    addClass: function (klass) {
        if (this.helpBubble) {
            this.helpBubble.addClass(klass);
        }
	},
	
	position: function(xyObj){
	    if (this.helpBubble) {
	        this.helpBubble.setStyles({
	            top: xyObj.y,
	            left: xyObj.x
	        });
	    }
	},
	
	show: function (selectable) {
	    if (this.helpBubble) {
	        if (selectable && selectable === true) {
	            this.helpBubble.addEvent(Affinity.events.outAll, this.hide);
	            this.helpBubble.addEvent(Affinity.events.overAll, this.show);
	        }
	        this.helpBubble.fade('in');
	    }
	},
	
	hide: function () {
	    if (this.helpBubble) {
	        this.helpBubble.removeEvents();
	        this.helpBubble.fade('out');
	        /*(function () { this.helpBubble.removeClass('showclose');  }).delay(500, this);*/
	    }
	},

	getSize: function () {
	    if (this.helpBubble) {
	        return this.helpBubble.measure(function () {
	            return this.getSize();
	        });
	    }
	}
	
});;
var UIHelpIcon = new Class({

    Version: '1.0.0.0',
    File: 'ui.help.bubble.js',

    Implements: [Options],

    Binds: [
    ],

    options: {

    },

    initialize: function (options) {
        this.setOptions(options);
        if (Affinity.tooltips) {
            Array.each(document.getElements('.indicator.help'), function (el) {
                if (el.get('data-help')) {
                    el.set('data-tooltip', el.get('data-help'));
                    el.addClass('ui-has-tooltip');
                    el.erase('data-help');
                }
            }.bind(this));
            Affinity.tooltips.init();
        } else {
            throw "UI Help Icon requires UI Tooltips";
        }
    }

});;
/*                                                                                  *
 * This script belongs to the ui (user interface) package.                          *
 *                                                                                  *
 * The following code assumes MooTools Core 1.4.5 has been included.                *
 *                                                                                  */


/**
 * @class UIHidables
 *
 * searches for data-hidable attributes (hidable triggers) and set up appropriate
 * hide show processes.
 * Class looks for class values of 'has-hidable'.
 * data-hidable-trigger-id = element id
 * If element with id data-hidable-trigger-id exists we set up events on triggers
 * and fx on data-hidable-trigger-id elements.
 *
 */
var UIHidables = new Class({

    Version: '1.0.0.0',
    File: 'ui.hidables.js',

    Implements: [Options],

    Binds: [
        'processNew', 'process',
        'processTriggers','processEachTrigger','triggerClicked'
    ],

    options: {
        
    },

    initialize: function (options) {
        this.setOptions(options);
        
        //create fx container foreach hidable target
        this.hidableFxs = {};

        this.processTriggers();

    },

    processNew: function () {
        this.processTriggers();
    },

    /**
    * Function : prcessHidableTriggers
    * searches for 'has-hidable' values in elements class attribute and set up appropriate hide show processes
    */
    processTriggers: function () {

        // look for elements with 'has-hidable' classes
        var hidables = document.getElements('.has-hidable');

        // if we have some, process
        if (hidables.length > 0) {

            // loop through hidable trigger elements
            Array.each(hidables, this.processEachTrigger);

        }
    },

    process: function (el) {
        this.processEachTrigger(el);
    },
    
    /**
    * Function : processEachTrigger
    * Create FxTweens for each triggers target and setup mouse events for each trigger
    */
    processEachTrigger: function (el, index) {

        var target, targetHeight;
        var targetid = el.get('data-hidable-trigger-id');

        // if trigger elements target exists
        if (document.id(targetid)) {

            //if (typeOf(this.hidableFxs[targetid + 'open']) == 'null') { // commented out as we need to rebuild for dynamically loaded partial views in modal boxes

            target = document.id(el.get('data-hidable-trigger-id'));
            target.store('hidableFx', new Fx.Reveal(target, { duration: 250, mode: 'vertical' }));

            // add click event to the trigger
            el.addEvent('click', this.triggerClicked);

            target.setStyle('display', 'none');
            target.removeClass('hidden');

            if (!target.hasClass('auto-hide')) {
                target.retrieve('hidableFx').reveal();
            }

            //}

        }

    },
    
    triggerClicked: function (e) {

        var reveal = true;

        var trigger = e.target;
        var target = document.id(e.target.get('data-hidable-trigger-id'));

        if (e.target.get('type') == "checkbox" && !e.target.checked) {
            reveal = false;
        }

        if (reveal) {

            target.retrieve('hidableFx').reveal();

            if (e.target.get('name')) {
                Array.each(document.getElements('input[name=' + e.target.get('name') + ']'), function (el) {
                    if (el != e.target) {
                        document.id(el.get('data-hidable-trigger-id')).retrieve('hidableFx').dissolve();
                    }
                }.bind(this));
            }

        }else{

            target.retrieve('hidableFx').dissolve();

        }
        
    }

});;
var UIHideToggle = new Class({

    Implements: [Options],

    Binds: [
        'init', 'processNew', 'processToggle'
    ],

    options: {

    },

    initialize: function (options) {
        this.setOptions(options);

        this.init();

    },

    init: function () {
        this.processNew();
    },

    processNew: function () {

        Array.each(document.getElements('.ui-hide-toggle'), this.processToggle);

    },

    processToggle: function (element, index) {

        if (!element.hasClass('ui-hide-toggle')) {
            return;
        }

        element.removeClass('ui-hide-toggle');

        new UIHideToggleWidget({
            element: element
        });

    }


});

var UIHideToggleWidget = new Class({

    Implements: [Options],

    Binds: [
        'childFocus',
        'toggle', 'hide', 'show'
    ],

    options: {
        element: null
    },

    isHidden: false,

    initialize: function (options) {

        this.setOptions(options);

        this.element = this.options.element;

        this.toggleid = this.element.get('data-hide-toggle-id');

        this.togglelement = document.id(this.toggleid);

        this.icons = {};
        this.icons.hide = Affinity.icons.ResizeShrink || '&#xe0b4;';
        this.icons.show = Affinity.icons.ResizeEnlarge || '&#xe0b3;';

        if (this.togglelement) {

            this.element.set('reveal', {
                duration: 250,
                onHide: function (target) {
                    target.addClass('subhidden');
                }.bind(this)
            });

            this.togglelement.set('html', this.icons.hide);

            this.togglelement.addEvent('click', this.toggle);

            Array.each(this.element.getElements('input,textarea,select'), function (input) {
                input.addEvent('focus', this.childFocus);
            }.bind(this));



        }

        var startState = this.element.get('data-hide-toggle-state');

        if (startState && startState == 'hidden') {
            this.element.addClass('subhidden');
            this.element.setStyle('display', 'none');
            this.isHidden = true;
            this.togglelement.set('html', this.icons.show);
        }

        this.element.removeClass('hidden');

    },

    childFocus: function(e){
        if (this.isHidden && this.element.contains(e.target)) {
            this.show();
        }
    },

    toggle: function () {
        if (this.isHidden) {
            this.show();
        } else {
            this.hide();
        }
    },

    hide: function () {
        this.isHidden = true;
        this.togglelement.set('html', this.icons.show);
        this.element.dissolve();
    },

    show: function () {
        this.element.removeClass('subhidden');
        this.isHidden = false;
        this.togglelement.set('html', this.icons.hide);
        this.element.reveal();
    }

});



;

var UIInbox = new Class({

    Implements: [Options, Events],

    Binds: [
        'processBox',
        'selectBox',
        'rowClicked',
        'refreshInbox',
        'refresh',
        'setError'
    ],

    options: {
    },

    initialize: function (options) {

        this.setOptions(options);

        Array.each(document.getElements('.ui-inbox'), function (inbox) {
            var errorBox = new Element('div', {
                'class': 'hidden', 'html': 'no errors', 'styles': {
                    'position': 'absolute',
                    'top': '10px',
                    'right': '10px',
                    'padding': '10px',
                    'background': 'white',
                    'border': '5px solid black',
                    'border-radius': '10px',
                    'z-index': '9999999999'
                }
            }).inject(inbox, 'after');
            inbox.store('errors', errorBox);
            inbox.getElement('.ui-inbox-labels h2').addEvent(Affinity.events.click, function () { errorBox.toggleClass('hidden'); });
            var id = inbox.get('id') || String.uniqueID();
            var tabApi = inbox.get('data-tab-api');

            var refreshFrequency = inbox.get('data-refresh-frequency');
            if (refreshFrequency) {
                refreshFrequency = parseFloat(refreshFrequency) || 5;
                refreshFrequency = refreshFrequency < 0.5 ? 0.5 : refreshFrequency;
            }

            var boxbuttoons = inbox.getElements('.ui-inbox-labels li');
            var boxes = inbox.getElements('.ui-inbox-box');
            var readpane = inbox.getElement('.ui-inbox-readpane');
            var inboxObj = {};
            inbox.set('id', id);
            inboxObj.tabApi = tabApi || false;
            inboxObj.tabIndex = Cookie.read('uiInboxIndex') || 0;
            inboxObj.frequency = refreshFrequency;
            inboxObj.element = inbox;
            inboxObj.stoprefresh = false;
            boxes.addClass('hidden');
            Array.each(boxbuttoons, function (button, index) {
                button.store('box', boxes[index]);
                this.processBox(boxes[index]);
                button.addEvent(Affinity.events.click, function (e) {
                    var el = e.target.get('tag') == 'li' ? e.target : e.target.getParent('li');
                    this.selectBox(el);
                    delete el;
                }.bind(this));
            }.bind(this));
            inbox.getElement('.ui-inbox-labels li').addClass('selected');
            inbox.getElement('.ui-inbox-box').removeClass('hidden');
            new Fx.Reveal(readpane, { duration: 250, mode: 'vertical' });
            readpane.setStyle('display', 'none');
            readpane.removeClass('hidden');
            if (tabApi) {
                inboxObj.refreshRequest = new CFRequest.JSON({
                    url: tabApi,
                    onSuccess: function (jsonData) {
                        this.refreshInbox(inboxObj, jsonData);
                    }.bind(this),
                    onError: function (err) {
                        this.setError(inbox, err);
                    }.bind(this),
                    onFailure: function (err) {
                        this.setError(inbox, err);
                    }.bind(this)
                });

                if (inbox.getElement('.ui-inbox-loader')) {
                    inbox.getElement('.ui-inbox-loader').removeClass('hidden');
                }
                if (inbox.hasClass('ui-inbox-requires-login')) {
                    window.addEvent('loggedin', function () {
                        inboxObj.refreshRequest.send();
                    }.bind(this));
                } else {
                    inboxObj.refreshRequest.send();
                }
            }
            inbox.store('inboxObj', inboxObj);
        }.bind(this));
    },

    selectBox: function (menuItem) {
        var inbox = menuItem.getParent('.ui-inbox');
        var inboxObj = inbox.retrieve('inboxObj');
        inboxObj.tabIndex = inbox.getElements('.ui-inbox-labels li').indexOf(menuItem);
        inbox.store('inboxObj', inboxObj);
        inbox.getElements('.ui-inbox-labels li').removeClass('selected');
        inbox.getElements('.ui-inbox-box').addClass('hidden');
        menuItem.retrieve('box').removeClass('hidden');
        menuItem.addClass('selected');
        if (inboxObj.tabApi) {
            this.startRefresh(inbox);
        }
        window.fireEvent('inboxSelected', { 'menuItem': menuItem, 'box': menuItem.retrieve('box') });
    },

    processBox: function (box) {
        Array.each(box.getElements('tbody tr'), function (row) {
            if (row.get('data-itemdata')) {
                row.addEvent(Affinity.events.click, this.rowClicked);
            }
        }.bind(this));
    },

    rowClicked: function (e) {
        var row = e.target.get('tag') == 'tr' ? e.target : e.target.getParent('tr');
        var data = JSON.parse(row.get('data-itemdata').replace(/'/g, '"'));
        var readpane = row.getParent('.ui-inbox').getElement('.ui-inbox-readpane');

        readpane.getElement('.ui-inbox-date-display').set('html', data.date ? unescape(data.date) : '');
        readpane.getElement('.ui-inbox-from').set('html', data.from ? unescape(data.from) : '');
        readpane.getElement('.ui-inbox-subject').set('html', data.subject ? unescape(data.subject) : '');
        readpane.getElement('.ui-inbox-message').set('html', data.details ? unescape(data.details) : '');

        readpane.reveal();

        delete row;
        delete data;
        delete readpane;
    },

    stopRefresh: function (inbox) {
        if (inbox) {
            var inboxObj = inbox.retrieve('inboxObj');
            if (inboxObj) {
                inboxObj.stoprefresh = true;
                if (inboxObj.refreshRequest.isRunning()) {
                    inboxObj.refreshRequest.cancel();
                }
            }
        }
    },

    startRefresh: function (inbox) {
        if (inbox) {
            var inboxObj = inbox.retrieve('inboxObj');
            if (inboxObj) {
                if (inbox.getElement('.ui-inbox-loader')) {
                    inbox.getElement('.ui-inbox-loader').removeClass('hidden');
                }
                inboxObj.stoprefresh = false;
                if (inboxObj.refreshRequest.isRunning()) {
                    inboxObj.refreshRequest.cancel();
                }
                inboxObj.refreshRequest.send();
            }
        }
    },

    refreshInbox: function (inboxObj, data) {
        this.fireEvent('refresh');
        if (inboxObj.element && inboxObj.element.getElement('.ui-inbox-loader')) {
            inboxObj.element.getElement('.ui-inbox-loader').addClass('hidden');
        }
        if (inboxObj.stoprefresh) {
            return;
        }
        window.fireEvent('inboxUpdated', { elementid: inboxObj.element.get('id'), inbox: inboxObj, data: data });
        if (inboxObj.frequency) {
            (function () {
                if (inboxObj.element && inboxObj.element.getElement('.ui-inbox-loader')) {
                    inboxObj.element.getElement('.ui-inbox-loader').removeClass('hidden');
                }
                inboxObj.refreshRequest.send();
            }).delay(inboxObj.frequency * 60 * 1000, this);
        }
    },

    refresh: function () {
        var box, rows, rowcount, labels, boxes;
        Array.each(document.getElements('.ui-inbox'), function (inbox) {
            lables = inbox.getElements('.ui-inbox-labels li');
            boxes = inbox.getElements('.ui-inbox-boxes .ui-inbox-box');
            Array.each(lables, function (lable, index) {
                box = boxes[index];
                rows = box.getElements('tbody tr');
                rowcount = rows.length;
                if (box.getElement('tbody tr.empty')) {
                    rowcount--;
                    if (rowcount == 0) {
                        box.getElement('tbody tr.empty').removeClass('hidden');
                    }
                }
                lable.getElement('.indicator').set('html', rowcount);
            }.bind(this));
        }.bind(this));
        delete boxes;
        delete lables;
        delete rowcount;
        delete rows;
        delete box;
    },

    setError: function (inbox, err) {
        var message = '';
        if (typeOf(err) === 'object' || typeOf(err) === 'array') {
            message = JSON.stringify(err, null, 2);
        } else {
            message = err;
        }
        inbox.retrieve('errors').set('html', '<pre>' + message + '</pre>');
        this.fireEvent('error', message);
    }

});;

Locale.define('en-NZ', 'Date', {
    months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
    days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
    dateOrder: ['date', 'month', 'year', '/'],
    ordinal: function (dayOfMonth) {
        return (dayOfMonth > 3 && dayOfMonth < 21) ? 'th' : ['th', 'st', 'nd', 'rd', 'th'][Math.min(dayOfMonth % 10, 4)];
    },
    AM: "am",
    PM: "pm"
});

Locale.use('en-NZ');

window.components = [
    ['UIHelpBubble','helpbubble'],
    ['UIGrid'],
    ['UISortableGrid'],
    ['UIDynamicGrid'],
    ['UIScrollableGrid'],
    ['UITabs'],
    ['UIInbox'],
    ['UIHidables'],
    ['UIFormHideables', 'formhideables'],
    ['UISectionHideables', 'sectionHidables'],
    ['UIHideToggle', 'hidetoggle'],
    ['UIUplaoders'],
    ['UIUplaodersMulti', 'uploaders'],
    ['UIReplaceArrows', 'arrows'],
    ['UIValidation'],
    ['UISanitise'],
    ['UIDateDropDowns'],
    ['UISelectLookup', 'lookups'],
    ['UIDisplayLookup', 'displaylookups'],
    ['UIDateCalendar'],
    ['UIListBuilder'],
    ['UIDateCleverInput'],
	['UIAutoComplete'],
	['UIQuickSearch'],
    ['UIModal','modal'],
	['UIDrawPanels'],
    ['UITooltips', 'tooltips'],
    ['UIHelpIcon', 'helpicon'],
    ['UIPompts', 'prompts'],
    ['UIFormatDate'],
	['UIBankNumber', 'banknumber'],
    ['UITaxNumber', 'taxnumber'],
    ['UIMasterMessage', 'masterMessage'],
    ['UIAddress', 'address'],
    ['UIPager'],
    ['UITextareaAutoSize', 'textAutoSize']
];

var mybasepath = window.basepath || '';

window.addEvent('PageReady', function () {
    if (!("Affinity" in window)) {
        window.Affinity = {};
    }
    if (!Affinity.uiready) {
        var namelist;
        for (var i = 0; i < window.components.length; i++) {
            namelist = window.components[i];
            if (typeof (window[namelist[0]]) !== 'undefined' && typeOf(window[namelist[0]]) === 'class') {
                var shortname;
                var classname = namelist[0].replace('UI', 'ui');
                if (classname in Affinity) {
                    console.log('name collision in Affinity for "' + classname + '"');
                }else{
                    Affinity[classname] = new window[namelist[0]]();
                    Affinity.Components[classname] = {};
                    Affinity.Components[classname].Version = Affinity[classname].Version || '';
                    Affinity.Components[classname].Name = Affinity[classname].Name || namelist[0].replace(new RegExp('UI', 'gi'), '').split(/(?=[A-Z])/).join(" ");
                    Affinity.Components[classname].File = Affinity[classname].File || '';
                    Affinity.Components[classname].Jira = Affinity[classname].Jira || '';
                    if (namelist.length > 1) {
                        for (var j = 1; j < namelist.length; j++) {
                            shortname = namelist[j];
                            if (shortname in Affinity) {
                                console.log('name collision in Affinity for "' + shortname + '"');
                            } else {
                                Affinity[shortname] = Affinity[classname];
                            }
                        }
                    }
                }
            }
        }
        classname = null;
        shortname = null;
        namelist = null;
        Affinity.useWebWorkers = Affinity.isie && Affinity.ieversion <= 11 ? false : Affinity.useWebWorkers;
        Affinity.uiready = true;
        window.fireEvent('UiReady');
    }
});;

var UIMasterMessageObject = new Class({
    message: 'Message!',
    okText: 'Ok',
    okIcon: '',
    onOk: function(){}
});

var UIMasterMessage = new Class({

    Version: '1.0.0.0',
    File: 'ui.master.message.js',

    Implements: [Options],

    Binds: [
        'message',
        'center', 'show', 'hide'
    ],

    options: {
    },

    status: 'closed',
    message: '',

    initialize: function (options) {

        this.setOptions(options);

        this.messageBoxBG = new Element('div', { 'id': 'UIMasterBoxBG', 'class': 'UIPromtBoxBG master' }).inject(document.body, 'bottom');
        this.messageBoxBG.set('tween', { duration: 250 });
        this.messageBoxBG.fade('hide');

        this.messageBox = new Element('div', { 'id': 'UIMasterBox', 'class': 'UIPromtBox master' }).inject(document.body, 'bottom');
        this.messageBox.set('tween', { duration: 250 });
        this.messageBox.fade('hide');

        this.trueButton = new Element('span', { 'class': 'button green w-icon', 'tabindex': 99999998 }).adopt(
			new Element('span', { 'html': Affinity.icons.Tick || '&#xe066;' }),
			new Element('span', { 'class': 'label', 'html': '' })
		);

        window.masterMessage = this.message;

    },

    message: function (options) {
        var obj = new UIMasterMessageObject();
        if (typeOf(options) === 'string') {
            obj.message = options;
        }else{
            obj.message = options.message ? options.message : obj.message;
            obj.onOk = options.onOk ? options.onOk : obj.onOk;
            obj.okText = options.okText ? options.okText : obj.okText;
            obj.okIcon = options.okIcon ? options.okIcon : Affinity.icons.Tick;
        }
        this.messageBox.empty();
        this.messageBox.adopt(
			new Element('span', { 'html': obj.message, 'class': 'content alignleft' })
		);
        this.onEnterMethod = function () {
            this.hide();
            obj.onOk();
        }.bind(this);
        this.messageBox.adopt(
            new Element('div', { 'class': 'promptButtons' }).adopt(
                this.trueButton.clone().addEvent('click', this.onEnterMethod)
            )
        );
        this.messageBox.getElement('.green span').set('html', obj.okIcon);
        this.messageBox.getElement('.green .label').set('html', obj.okText);
        this.center();
        this.show();
        delete obj;
    },

    getCalculatedTop: function () {
        var size = this.messageBox.getSize();
        var boxMiddle = (size.y / 2);
        if (Affinity.oldess && Affinity.oldessFrame) { // nested frames make life difficult
            var win = window.parent;
            var doc = win.document.documentElement, body = win.document.body;
            var parentScroll = (doc && doc.scrollTop || body && body.scrollTop || 0);
            var parentHeight = win.innerHeight || win.document.documentElement.clientHeight;
            //var framePosition = window.frameElement.offsetTop; // ????????

            var framePosition;
            if (document.documentMode && document.documentMode < 9) {
                framePosition = window.parent.document.getElementById("ctl00_MainPanel").querySelectorAll(".ContentBody")[0].offsetTop;
            } else {
                framePosition = window.parent.document.getElementById("ctl00_MainPanel").getElementsByClassName("ContentBody")[0].offsetTop;
            }

            var top = (parentScroll + (parentHeight / 2)) - framePosition;
            if (top < boxMiddle + 10) {
                top = boxMiddle + 10;
            }
            return top;
        }
        var docsize = document.getSize();
        var scrollOffsets = document.getScroll();
        return (docsize.y / 2) + scrollOffsets.y;
    },

    center: function () {
        var size = this.messageBox.getSize();
        this.messageBox.setStyles({ 'margin': (0 - (size.y / 2)) + 'px 0 0 ' + (0 - (size.x / 2)) + 'px', 'top': this.getCalculatedTop() });
        delete size;
    },

    show: function () {
        this.messageBoxBG.fade('in');
        this.messageBox.fade('in');
        this.status = 'open';
    },

    hide: function () {
        this.messageBoxBG.fade('out');
        this.messageBox.fade('out');
        this.status = 'closed';
        this.message = '';
        window.removeEvent('keyup', this.okKeyUp);
        try {
            this.messageBoxBG.removeEvent(Affinity.events.click, this.hide);
        } catch (e) { }
    }

});;
/*                                                                                  *
 * This script belongs to the ui (user interface) package.                          *
 *                                                                                  *
 * The following code assumes MooTools Core 1.4.5 has been included.                *
 *                                                                                  */


/**
 * @class UIModal
 *
 * Modal (light box) handler
 *
 */
var UIModal = new Class({

    Version: '1.0.0.0',
    File: 'ui.modal.js',

    Implements: [Options],

    Binds: [
		'setElement', 'setString',
        'adopt',
		'position',
        'clear',
        'closeButtonCloser', 'backgroundCloser',
        'show', 'hide'
    ],

    Options: {
		
    },
    
    backgroundCloses: true,

    initialize: function (options) {
        this.setOptions(options);

        this.icons = {};
        this.icons.del = Affinity.icons.CrossRound;
		
		if(!document.id('uimodalbg')){
			this.modalbg = new Element('div', {
				id:'uimodalbg',
				'class':'white hidden'
			}).inject(document.body, 'bottom');
		}
		
		if(!document.id('uimodal')){
			this.modal = new Element('div', {
				id:'uimodal',
				'class': 'shadow hidden'
			}).inject(document.body, 'bottom');
			this.modalclose = new Element('div', {
			    'class': 'uimodalclose'
			}).inject(this.modal);
			new Element('span', { 'class': 'icon-cross' }).inject(this.modalclose);
			this.modalbody = new Element('div', {
				'class':'uimodalbody'
			}).inject(this.modal);
		}
		
		this.modalbg = document.id('uimodalbg');
		this.modal = document.id('uimodal');

		this.modalbg.set('tween', { duration: 250 });
		this.modal.set('tween', { duration: 250 });
		
		this.modalclose = this.modal.getElement('.uimodalclose');
		this.modalbody = this.modal.getElement('.uimodalbody');

		this.modalbg.addEvent('click', this.backgroundCloser);
        
		this.modalclose.addEvent('click', this.closeButtonCloser);

		this.modalbg.removeClass('hidden').fade('hide');
		this.modal.removeClass('hidden').fade('hide');
		
		window.addEvent('resize',function(e){this.position();}.bind(this));
		this.position();

        /**/

		this.scroll = {};
		this.scroll.enable = function () {
		    this.modal.addClass('scroll');
		}.bind(this);
		this.scroll.disable = function () {
		    this.modal.removeClass('scroll');
        }.bind(this);

        /**/

		this.close = {};
		this.close.enable = function () {
		    this.modalclose.removeClass('hidden');
		}.bind(this);
		this.close.disable = function () {
		    this.modalclose.addClass('hidden');
		}.bind(this);

        /**/

		
    },

    getCalculatedTop: function () {
        if (Affinity.oldess && Affinity.oldessFrame) { // nested frames make life difficult
            var win = window.parent.window;
            var doc = win.document.documentElement, body = win.document.body;
            var parentScroll = (doc && doc.scrollTop || body && body.scrollTop || 0);
            //var framePosition = window.frameElement.offsetTop; // ????????
            var framePosition = 0;
            var frame = window.parent.document.getElementById("ctl00_MainPanel");
            if (frame) {
                if (document.documentMode && document.documentMode < 9) {
                    framePosition = frame.querySelectorAll(".ContentBody")[0].offsetTop;
                } else {
                    framePosition = frame.getElementsByClassName("ContentBody")[0].offsetTop;
                }
            }
            var top = parentScroll - framePosition;
            if (top < 10) {
                top = 10;
            }
            return top + 10;
        }
        return 10;
    },
	
	position: function(){
	    var size = window.getSize();
        
		this.modalbg.setStyles({
			width: size.x,
			height: size.y
		});
        
		this.modal.setStyles({
		    left: (size.x / 2) - (this.modal.getDimensions().width / 2),
		    top: this.getCalculatedTop()
		});

		this.modalbody.setStyles({
		    'max-height': size.y - 60
		});

		delete size;
	},
	
	setElement: function(el){
		this.modalbody.empty();
		el.inject(this.modalbody);
		this.position();
		this.close.enable();
		this.scroll.enable();
	},

	adopt: function (el) {
	    this.setElement(el);
	},
	
	setString: function (str) {
		this.modalbody.empty();
		this.modalbody.set('html',str);
		this.position();
		this.close.enable();
		this.scroll.enable();
	},
    
    backgroundCloser: function (e) {
        this.closeButtonCloser(e);
    },

    closeButtonCloser: function (e) {
        window.fireEvent("leaveEditDetailCloses");
        if (this.backgroundCloses) {
            this.hide();
        }
    },
	
    hide: function () {
        if ('beforeClose' in this && typeOf(this.beforeClose) === 'function') {
            this.beforeClose();
            this.beforeClose = null;
            delete this.beforeClose;
        }
		document.body.removeClass('uimodal-open');
		this.modalbg.fade('out');
		this.modal.fade('out');
	    this.clear.delay(500, this);
	},
	
	show: function (backgroundCloses) {

	    if (backgroundCloses == null) {
	        backgroundCloses = true;
	        this.modalclose.fade('show');
	    }else {
	        this.modalclose.fade('hide');
	    }
		document.body.addClass('uimodal-open');
	    this.backgroundCloses = backgroundCloses;

	    this.modalbg.fade('in');
		this.modal.fade('in');
	},
    
    clear: function () {
        this.modalbody.empty();
    }
	
});;

var UIPromptPositionObject = {
    position: 'absolute',
    top: false,
    left: false
};

var UILoaderObject = {
    message: 'Loading',
    onClose: function () { },
    timeout: null,
    position: {},
    showButtons: false,
    showLoader: true,
    noClose: true,
    cssSelector: ''
};

var UIMessageObject = {
    message: 'Message!',
    onClose: function () { },
    timeout: null,
    position: {},
    cssSelector: ''
};

var UIAlertObject = {
    message: 'Alert!',
    messageAlign: 'center',
    okText: 'Ok',
    okIcon: '',
    okColor: 'green',
    cancelText: 'Cancel',
    cancelIcon: '',
    cancelColor: 'grey',
    onOk: function () { },
    onCancel: function () { },
    onClose: function () { },
    showButtons: true,
    showCancel: false,
    noClose: false,
    showLoader: false,
    append: false,
    position: {},
    cssSelector: '',
    showHiddenInfo: false,
    hiddenInfoMessage: '',
    hiddenInfoButtonText: '',
};

var UIConfirmObject = {
    message: 'Yes or No?',
    messageAlign: 'center',
    okText: 'Yes',
    okIcon: '',
    okColor: 'green',
    cancelText: 'No',
    cancelIcon: '',
    cancelColor: 'grey',
    onOk: function () { },
    onCancel: function () { },
    onClose: function () { },
    noClose: true,
    position: {},
    cssSelector: ''
};

var UIPromptObject = {
    message: 'Enter text',
    messageAlign: 'center',
    lines: 1,
    okText: 'Ok',
    okIcon: '',
    okColor: 'green',
    cancelText: 'Cancel',
    cancelIcon: '',
    cancelColor: 'grey',
    value: '',
    onOk: function () { },
    onCancel: function () { },
    onClose: function () { },
    noClose: true,
    position: {},
    cssSelector: ''
};

var UIPompts = new Class({

    Version: '1.0.4.0',
    Sequence: 1050,
    Name: 'Prompts',
    File: 'ui.prompts.js',
    Jira: '',
    Notes: 'Added value for TS Favs edit',

    Implements: [Options],

    Binds: [
    'returnOptionsObject',
    'message', 'alert', 'prompt', 'confirm', 'loader',
    'center', 'show',
    'escape', 'hide',
    'hideDelay', 'clearHideDelay',
    'okKeyUp'
    ],

    options: {

    },

    status: 'closed',
    message: '',

    currentObj: false,
    container: false,

    currentType: '',

    initialize: function (options) {

        this.setOptions(options);

        if (document.id('UIPromtBoxBG')) {
            this.promptBoxBG = document.id('UIPromtBoxBG');
        }
        else {
            this.promptBoxBG = new Element('div', { 'id': 'UIPromtBoxBG', 'class': 'UIPromtBoxBG' }).inject(document.body, 'bottom');
        }
        this.promptBoxBG.set('tween', { duration: 250 });
        this.promptBoxBG.fade('hide');

        if (document.id('UIPromtBox')) {
            this.promptBox = document.id('UIPromtBox');
        }
        else {
            var mobileWrap = new Element('div', { 'class': 'mobile-wrap' }).inject(document.body, 'bottom');
            this.promptBox = new Element('div', { 'id': 'UIPromtBox', 'class': 'UIPromtBox' }).inject(mobileWrap);
        }
        this.promptBox.set('tween', { duration: 250 });
        this.promptBox.fade('hide');

        this.container = this.promptBox;

        this.trueButton = new Element('span', { 'class': 'button true-button w-icon', 'tabindex': 9999998 }).adopt(
        new Element('span', { 'html': Affinity.icons.Tick || '&#xe066;' }),
        new Element('span', { 'class': 'label', 'html': '' })
        );

        this.falseButton = new Element('span', { 'class': 'button false-button w-icon', 'tabindex': 9999999 }).adopt(
        new Element('span', { 'html': Affinity.icons.Cancel || '&#xe070;' }),
        new Element('span', { 'class': 'label', 'html': '' })
        );

        /**/

        this.promptBoxBG.removeEvents();
        this.promptBoxBG.addEvent('keyup', function (e) {
            e.stop();
            if (!this.obj.noClose && e.key == 'esc') {
                this.hide();
                return;
            }
            if (e.key == 'enter') {
                this.obj.onOk();
            }
        }.bind(this));

        /**/

        if (Affinity.mobile) {
            window.removeEvent('mobileback', this.escape);
            window.addEvent('mobileback', this.escape);
        }

        /**/

        window.prompts = this;
        window.uimessage = this.message;
        window.uialert = this.alert;
        window.uiconfirm = this.confirm;
        window.uiprompt = this.prompt;
        window.uiloader = this.loader;

    },

    returnOptionsObject: function (object) {
        var obj = {};
        var clone = Object.clone(object);
        var newObj = Object.merge(obj, clone);
        return newObj;
    },

    message: function (options) {

        var obj = this.returnOptionsObject(UIMessageObject);
        obj.message = options.message ? options.message : obj.message;
        obj.messageAlign = options.messageAlign ? options.messageAlign : obj.messageAlign;
        obj.timeout = options.timeout ? options.timeout : obj.timeout;
        obj.cssSelector = options.cssSelector ? options.cssSelector : obj.cssSelector;
        window.onPromptClose = options.onClose ? options.onClose : obj.onClose;

        obj.position = this.returnOptionsObject(UIPromptPositionObject);
        if (options.position) {
            obj.position.position = options.position.position ? options.position.position : obj.position.position;
            obj.position.top = options.position.top ? options.position.top : obj.position.top;
            obj.position.left = options.position.left ? options.position.left : obj.position.left;
        }

        this.currentObj = obj;

        if (obj.cssSelector !== '') this.promptBox.className = 'UIPromtBox ' + obj.cssSelector;
        else this.promptBox.className = 'UIPromtBox';

        this.promptBox.empty();
        this.promptBox.adopt(
        new Element('span', { 'html': obj.message, 'class': 'content align' + obj.messageAlign })
        );

        this.center();

        this.show();

        if (obj.timeout !== null) {
            this.hide.delay(obj.timeout, this);
        }

    },

    addLargeMessage: function (message) {
        var largeMessage = new Element('div', {
            'html': message,
            'styles': {
                'width': '100%',
                'max-height': 150,
                'overflow': 'auto',
                'text-align': 'left',
                'margin': '10px 0'
            }
        });
        if (this.promptBox.getElement('.promptButtons')) {
            largeMessage.inject(this.promptBox.getElement('.promptButtons'), 'before');
        }
        else {
            largeMessage.inject(this.promptBox);
        }
        this.center();
        largeMessage = null;
    },

    adopt: function () {
        var content = this.promptBox.getElement('.content');
        for (var i = 0; i < arguments.length; i++) {
            content.adopt(arguments[i]);
        }
        i = content = null;
        this.center();
    },

    alert: function (options) {

        this.currentType = options.type || '';

        var obj = this.returnOptionsObject(UIAlertObject);
        obj.message = options.message ? options.message : obj.message;
        obj.messageAlign = options.messageAlign ? options.messageAlign : obj.messageAlign;
        obj.okText = options.okText ? options.okText : obj.okText;
        obj.okIcon = options.okIcon ? options.okIcon : Affinity.icons.Tick;
        obj.okColor = options.okColor ? options.okColor : obj.okColor;
        obj.cancelText = options.cancelText ? options.cancelText : obj.cancelText;
        obj.cancelIcon = options.cancelIcon ? options.cancelIcon : Affinity.icons.Cancel;
        obj.cancelColor = options.cancelColor ? options.cancelColor : obj.cancelColor;
        obj.onOk = options.onOk ? options.onOk : obj.onOk;
        obj.onCancel = options.onCancel ? options.onCancel : obj.onCancel;
        obj.showButtons = typeOf(options.showButtons) === 'boolean' ? options.showButtons : obj.showButtons;
        obj.showCancel = typeOf(options.showCancel) === 'boolean' ? options.showCancel : obj.showCancel;
        obj.noClose = typeOf(options.noClose) === 'boolean' ? options.noClose : obj.noClose;
        obj.showLoader = typeOf(options.showLoader) === 'boolean' ? options.showLoader : obj.showLoader;
        obj.append = options.append ? options.append : obj.append;
        obj.cssSelector = options.cssSelector ? options.cssSelector : obj.cssSelector;
        window.onPromptClose = options.onClose ? options.onClose : obj.onClose;
        obj.showHiddenInfo = typeOf(options.showHiddenInfo) === 'boolean' ? options.showHiddenInfo : obj.showHiddenInfo;
        obj.hiddenInfoMessage = options.hiddenInfoMessage ? options.hiddenInfoMessage : obj.hiddenInfoMessage;
        obj.hiddenInfoButtonText = options.hiddenInfoButtonText ? options.hiddenInfoButtonText : obj.hiddenInfoButtonText;

        if (options.isCloseOnClick !== undefined) {
            obj.isCloseOnClick = options.isCloseOnClick;
        }

        obj.position = this.returnOptionsObject(UIPromptPositionObject);
        if (options.position) {
            obj.position.position = options.position.position ? options.position.position : obj.position.position;
            obj.position.top = options.position.top ? options.position.top : obj.position.top;
            obj.position.left = options.position.left ? options.position.left : obj.position.left;
        }

        this.currentObj = obj;

        if (obj.cssSelector !== '') this.promptBox.className = 'UIPromtBox ' + obj.cssSelector;
        else this.promptBox.className = 'UIPromtBox';

        this.onEnterMethod = function () {
            obj.onOk();
            this.hide();
        }.bind(this);

        this.onCancelMethod = function () {
            obj.onCancel();
            this.hide();
        }.bind(this);

        

        var cancelButton = this.falseButton.clone().removeEvents().addClass(obj.cancelColor).addClass('hidden').addEvent('click', this.onCancelMethod);
        cancelButton.getElement('span').set('html', obj.cancelIcon);
        cancelButton.getElement('.label').set('html', obj.cancelText);

        var spacer = new Element('span', { 'html': '&nbsp;', 'class': 'hidden' });

        this.message = obj.append ? this.message + (this.message !== '' ? '<br />' : '') + obj.message : obj.message;

        this.promptBox.empty();
        this.promptBox.adopt(
        new Element('span', { 'html': this.message, 'class': 'content align' + obj.messageAlign })
        );

        if (obj.showHiddenInfo) {
            
            var hiddenInfoContainer = new Element('div', { 'class': 'hiddenInfoContainer', 'style': 'display: none;', 'html': '<br />' + obj.hiddenInfoMessage }).inject(this.promptBox);


                var hiddenInfoButton = new Element('div', {
                    'class': 'tooltip-view ui-has-tooltip more-button tile-more-button', 'style': 'text-align: center;', 'html': '<br /><span class="button more w-icon more-info-button"><span class="icon-info"></span><span class="btn-tag tile-more">' + obj.hiddenInfoButtonText + '</span></span>'
                }).inject(this.promptBox);

            var closehiddenInfoButton = new Element('div', {
                    'style': 'text-align: center;',
                'class': 'tooltip-view ui-has-tooltip more-button tile-more-button',
                'html': '<span class="button more w-icon more-info-button"><span></span><span class="btn-tag tile-more">Hide</span></span>'
                }).inject(hiddenInfoContainer);

            hiddenInfoButton.addEvent(Affinity.events.click, function (e) {
                    hiddenInfoContainer.style.display = "block";
                hiddenInfoButton.style.display = "none";
                }.bind(this));

            closehiddenInfoButton.addEvent(Affinity.events.click, function (e) {
                    hiddenInfoContainer.style.display = "none";
                hiddenInfoButton.style.display = "block";
                }.bind(this));
        }

        if (obj.showLoader) {
            this.promptBox.adopt(
                new Element('img', { 'src': Affinity.loaders.blueico, class: 'blue-ico-loader' })
            );
            this.promptBox.addClass('loader');
        }
        else {
            this.promptBox.removeClass('loader');
        }
        if (obj.noClose) {
            if (this.promptBox.getElement('promptButtons')) {
                this.promptBox.getElement('promptButtons').destroy();
            }
        }
        else {
            if (obj.showButtons) {
                this.promptBox.adopt(
                new Element('div', { 'class': 'promptButtons' }).adopt(
                this.trueButton.clone().removeEvents().addClass(obj.okColor).addEvent('click', this.onEnterMethod),
                spacer,
                cancelButton
                )
                );
                this.promptBox.getElement('.true-button span').set('html', obj.okIcon);
                this.promptBox.getElement('.true-button .label').set('html', obj.okText);
            }
        }

        this.promptBoxBG.removeEvent(Affinity.events.click, this.hide);
        if (!obj.showButtons && !obj.noClose) {
            this.promptBoxBG.addEvent(Affinity.events.click, this.hide);
        }
        else {
            if (obj.showCancel) {
                spacer.removeClass('hidden');
                cancelButton.removeClass('hidden');
            }
        }

        window.removeEvent('keyup', this.okKeyUp);
        window.addEvent('keyup', this.okKeyUp);

        this.center();

        this.show();

        return this;

    },

    prompt: function (options) {

        this.currentType = options.type || '';

        var obj = this.returnOptionsObject(UIPromptObject);
        obj.message = options.message ? options.message : obj.message;
        obj.messageAlign = options.messageAlign ? options.messageAlign : obj.messageAlign;
        obj.value = options.value ? options.value : obj.value;
        obj.lines = options.lines ? options.lines : obj.lines;
        obj.okText = options.okText ? options.okText : obj.okText;
        obj.okIcon = options.okIcon ? options.okIcon : Affinity.icons.Tick;
        obj.okColor = options.okColor ? options.okColor : obj.okColor;
        obj.onOk = options.onOk ? options.onOk : obj.onOk;
        obj.cancelText = options.cancelText ? options.cancelText : obj.cancelText;
        obj.cancelIcon = options.cancelIcon ? options.cancelIcon : Affinity.icons.Cancel;
        obj.cancelColor = options.cancelColor ? options.cancelColor : obj.cancelColor;
        obj.onCancel = options.onCancel ? options.onCancel : obj.onCancel;
        obj.noClose = typeOf(options.noClose) === 'boolean' ? options.noClose : obj.noClose;
        obj.cssSelector = options.cssSelector ? options.cssSelector : obj.cssSelector;
        window.onPromptClose = options.onClose ? options.onClose : obj.onClose;

        obj.position = this.returnOptionsObject(UIPromptPositionObject);
        if (options.position) {
            obj.position.position = options.position.position ? options.position.position : obj.position.position;
            obj.position.top = options.position.top ? options.position.top : obj.position.top;
            obj.position.left = options.position.left ? options.position.left : obj.position.left;
        }

        this.currentObj = obj;

        if (obj.cssSelector !== '') this.promptBox.className = 'UIPromtBox ' + obj.cssSelector;
        else this.promptBox.className = 'UIPromtBox';

        this.onEnterMethod = function () {
            var value = document.id('UIPromtBox').getElement('.promptinput').value;
            this.hide();
            obj.onOk(value);
        }.bind(this);

        this.onCancelMethod = function () {
            var value = document.id('UIPromtBox').getElement('.promptinput').value;
            this.hide();
            obj.onCancel(value);
        }.bind(this);

        var input;
        if (obj.lines < 2) {
            input = new Element('input', { 'type': 'text', 'class': 'promptinput data-hj-whitelist', 'tabindex': 9999997 });
        } else {
            input = new Element('textarea', { 'rows': obj.lines, 'class': 'promptinput data-hj-whitelist', 'tabindex': 9999997 });
        }
        input.value = obj.value;

        this.promptBox.empty();
        this.promptBox.adopt(
        new Element('span', { 'html': obj.message, 'class': 'content align' + obj.messageAlign }),
        new Element('div', { 'class': 'promptButtons' }).adopt(
        input
        ),
        new Element('div', { 'class': 'promptButtons' }).adopt(
        this.trueButton.clone().removeEvents().addClass(obj.okColor).addEvent('click', this.onEnterMethod),
        new Element('span', { 'html': '&nbsp;' }),
        this.falseButton.clone().removeEvents().addClass(obj.cancelColor).addEvent('click', this.onCancelMethod)
        )
        );

        this.promptBoxBG.removeEvent(Affinity.events.click, this.hide);
        if (!obj.noClose) {
            this.promptBoxBG.addEvent(Affinity.events.click, this.hide);
        }

        window.removeEvent('keyup', this.okKeyUp);
        window.addEvent('keyup', this.okKeyUp);

        this.promptBox.getElement('.true-button span').set('html', obj.okIcon);
        this.promptBox.getElement('.true-button .label').set('html', obj.okText);
        this.promptBox.getElement('.false-button span').set('html', obj.cancelIcon);
        this.promptBox.getElement('.false-button .label').set('html', obj.cancelText);

        this.center();

        this.show();

        this.promptBox.getElement('.promptinput').focus();

        return this;

    },

    confirm: function (options) {

        this.currentType = options.type || '';

        var obj = this.returnOptionsObject(UIConfirmObject);
        obj.message = options.message ? options.message : obj.message;
        obj.messageAlign = options.messageAlign ? options.messageAlign : obj.messageAlign;
        obj.okText = options.okText ? options.okText : obj.okText;
        obj.okIcon = options.okIcon ? options.okIcon : Affinity.icons.Tick;
        obj.okColor = options.okColor ? options.okColor : obj.okColor;
        obj.onOk = options.onOk ? options.onOk : obj.onOk;
        obj.cancelText = options.cancelText ? options.cancelText : obj.cancelText;
        obj.cancelIcon = options.cancelIcon ? options.cancelIcon : Affinity.icons.Cancel;
        obj.cancelColor = options.cancelColor ? options.cancelColor : obj.cancelColor;
        obj.onCancel = options.onCancel ? options.onCancel : obj.onCancel;
        obj.noClose = typeOf(options.noClose) === 'boolean' ? options.noClose : obj.noClose;
        obj.cssSelector = options.cssSelector ? options.cssSelector : obj.cssSelector;
        window.onPromptClose = options.onClose ? options.onClose : obj.onClose;

        obj.position = this.returnOptionsObject(UIPromptPositionObject);
        if (options.position) {
            obj.position.position = options.position.position ? options.position.position : obj.position.position;
            obj.position.top = options.position.top ? options.position.top : obj.position.top;
            obj.position.left = options.position.left ? options.position.left : obj.position.left;
        }

        this.currentObj = obj;

        if (obj.cssSelector !== '') this.promptBox.className = 'UIPromtBox ' + obj.cssSelector;
        else this.promptBox.className = 'UIPromtBox';

        this.onEnterMethod = function () {
            this.hide();
            obj.onOk(true);
        }.bind(this);

        this.onCancelMethod = function () {
            this.hide();
            obj.onCancel(false);
        }.bind(this);

        this.promptBox.empty();
        this.promptBox.adopt(
        new Element('span', { 'html': obj.message, 'class': 'content align' + obj.messageAlign }),
        new Element('div', { 'class': 'promptButtons' }).adopt(
        this.trueButton.clone().removeEvents().addClass(obj.okColor).addEvent('click', this.onEnterMethod),
        new Element('span', { 'html': '&nbsp;' }),
        this.falseButton.clone().removeEvents().addClass(obj.cancelColor).addEvent('click', this.onCancelMethod)
        )
        );

        this.promptBoxBG.removeEvent(Affinity.events.click, this.hide);
        if (!obj.noClose) {
            this.promptBoxBG.addEvent(Affinity.events.click, this.hide);
        }

        this.currentObj = obj;

        window.removeEvent('keyup', this.okKeyUp);
        window.addEvent('keyup', this.okKeyUp);

        this.promptBox.getElement('.true-button span').set('html', obj.okIcon);
        this.promptBox.getElement('.true-button .label').set('html', obj.okText);
        this.promptBox.getElement('.false-button span').set('html', obj.cancelIcon);
        this.promptBox.getElement('.false-button .label').set('html', obj.cancelText);

        this.center();

        this.show();

        return this;

    },

    loader: function (options) {

        this.currentType = options.type || '';

        var obj = this.returnOptionsObject(UILoaderObject);
        obj.message = options.message ? options.message : obj.message;
        obj.messageAlign = options.messageAlign ? options.messageAlign : obj.messageAlign;
        obj.cssSelector = options.cssSelector ? options.cssSelector : obj.cssSelector;
        window.onPromptClose = options.onClose ? options.onClose : obj.onClose;

        obj.position = this.returnOptionsObject(UIPromptPositionObject);
        if (options.position) {
            obj.position.position = options.position.position ? options.position.position : obj.position.position;
            obj.position.top = options.position.top ? options.position.top : obj.position.top;
            obj.position.left = options.position.left ? options.position.left : obj.position.left;
        }

        this.currentObj = obj;

        if (obj.cssSelector !== '') this.promptBox.className = 'UIPromtBox ' + obj.cssSelector;
        else this.promptBox.className = 'UIPromtBox';

        this.message = obj.append ? this.message + (this.message !== '' ? '<br />' : '') + obj.message : obj.message;

        this.promptBox.empty();
        this.promptBox.adopt(
        new Element('span', { 'html': this.message, 'class': 'content align' + obj.messageAlign })
        );

        this.promptBox.adopt(
            new Element('img', { 'src': Affinity.loaders.blueico, class: 'blue-ico-loader' })
        );
        this.promptBox.addClass('loader');

        window.removeEvent('keyup', this.okKeyUp);
        this.promptBoxBG.removeEvent(Affinity.events.click, this.hide);

        this.center();

        this.show();

    },

    getCalculatedTop: function () {
        if (Affinity.oldess && Affinity.oldessFrame) {
            /* nested frames make life difficult */
            var size = this.promptBox.getSize();
            var boxMiddle = (size.y / 2);
            var win = window.parent.window;
            var doc = win.document.documentElement, body = win.document.body;
            var parentScroll = (doc && doc.scrollTop || body && body.scrollTop || 0);
            var parentHeight = win.innerHeight || win.document.documentElement.clientHeight;
            var framePosition = 0;
            var frame = window.parent.document.getElementById("ctl00_MainPanel");
            if (frame) {
                if (document.documentMode && document.documentMode < 9) {
                    framePosition = frame.querySelectorAll(".ContentBody")[0].offsetTop;
                } else {
                    framePosition = frame.getElementsByClassName("ContentBody")[0].offsetTop;
                }
            }
            if (this.promptBox.getStyle('position') === 'fixed') {
                return (parentHeight / 2) - framePosition;
            } else {
                var top = (parentScroll + (parentHeight / 2)) - framePosition;
                if (top < boxMiddle + 10) {
                    top = boxMiddle + 10;
                }
                return top + 10;
            }
        }
        var docsize = document.getSize();
        if (this.promptBox.getStyle('position') === 'fixed') {
            return (docsize.y / 2);
        } else {
            var scrollOffsets = document.getScroll();
            return (docsize.y / 2) + scrollOffsets.y;
        }
    },

    center: function () {
        if (Affinity.mobile) return;


        var size = this.promptBox.getSize();
        var top = this.getCalculatedTop();
        var left = '50%';
        var marginTop = (0 - (size.y / 2));
        var marginLeft = (0 - (size.x / 2));
        var cssposition = 'absolute';
        if (typeOf(this.currentObj) !== 'null' && typeOf(this.currentObj.position) !== 'null') {
            var position = this.currentObj.position;
            cssposition = position.position ? position.position : 'absolute';
            top = position.top ? position.top : top;
            left = position.left ? position.left : left;
            marginTop = position.top ? 0 : marginTop;
            marginLeft = position.left ? 0 : marginLeft;
        }
        this.promptBox.setStyles({
            'position': cssposition,
            'top': top,
            'left': left,
            'margin': marginTop + 'px 0 0 ' + marginLeft + 'px'
        });
    },

    okKeyUp: function (e) {
        if (e.key == 'enter' && this.status == 'open') {
            if (this.promptBox.getElement('.promptinput')) {
                if (this.promptBox.getElement('.promptinput') != document.activeElement) {
                    this.onEnterMethod();
                }
            } else {
                this.onEnterMethod();
            }
        }
    },

    showButtons: function () {
        if (this.promptBox.getElement('.promptButtons')) {
            this.promptBox.getElement('.promptButtons').removeClass('hidden');
            if (this.promptBoxBG) {
                this.promptBoxBG.removeEvent(Affinity.events.click, this.hide);
                this.promptBoxBG.addEvent(Affinity.events.click, this.hide);
            }
        }
    },

    hideButtons: function () {
        if (this.promptBox.getElement('.promptButtons')) {
            this.promptBox.getElement('.promptButtons').addClass('hidden');
            if (this.promptBoxBG) {
                this.promptBoxBG.removeEvent(Affinity.events.click, this.hide);
            }
        }
    },

    show: function () {
        document.body.addClass('uiprompt-open')
        this.promptBoxBG.fade('in');
        this.promptBox.fade('in');
        this.status = 'open';
    },

    escape: function () {
        if (this.currentOb && !this.currentOb.noClose) {
            this.hide();
        }
    },

    clearOnClose: function () {


        window.onPromptClose = function () { };
    },

    hide: function (type) {
        document.body.removeClass('uiprompt-open')
        if (typeof type === 'string' && type !== '' && type !== this.currentType) return;
        if ('onPromptClose' in window) window.onPromptClose();
        this.clearOnClose();
        this.promptBoxBG.fade('out');
        this.promptBox.fade('out');
        this.status = 'closed';
        this.message = '';
        window.removeEvent('keyup', this.okKeyUp);
        try {
            this.promptBoxBG.removeEvent(Affinity.events.click, this.hide);
        } catch (e) { }
        this.currentObj = false;
        this.currentType = '';
    },

    hideDelayTimer: false,

    hideDelay: function (delay) {
        this.clearHideDelay();
        this.hideDelayTimer = this.hide.delay(delay);
    },

    clearHideDelay: function () {
        clearTimeout(this.hideDelayTimer);
    }

});;
/*                                                                                  *
 * This script belongs to the ui (user interface) package.                          *
 *                                                                                  *
 * The following code assumes MooTools Core 1.4.5 has been included.                *
 *                                                                                  */


/**
 * @class UIReplaceArrows
 *
 * Replaces text arrows (->/-$agt;) with graphical component
 *
 */
var UIReplaceArrows = new Class({

    Implements: [Options],

    Binds: [
        'processArrows', 'processInlineArrows'
    ],

    Options: {
    },

    initialize: function (options) {
        this.setOptions(options);
        this.processArrows();
    },
    
    /**
    * Function : processArrows
    * replaces text arrows with arrow icon and align content width
    */
    processArrows: function () {
        var max = 0;
        var sects, strs, tabel, row, lefttd;
        Array.each(document.getElements('.ui-replace-arrows td').combine(document.getElements('.ui-replace-arrows th')), function (el, index) {
            if (el.getElements('.button,button').length == 0) {
                sects = el.get('html').split(',');
                el.empty();
                Array.each(sects, function (str, index) {
                    if (str.contains('-&gt;') || str.contains('->')) {
                        if (str.contains('-&gt;')) { strs = str.split('-&gt;'); }
                        if (str.contains('->')) { strs = str.split('->'); }
                        tabel = new Element('table', { 'class': 'arrow-table' }).inject(el);
                        row = new Element('tr').inject(tabel);
                        lefttd = new Element('span', { html: strs[0].trim() }).inject(new Element('td', { 'class': 'left' }).inject(row));
                        new Element('span', { 'class': 'smicon arrow' }).inject(new Element('td', { 'class': 'arrow' }).inject(row));
                        new Element('td', { html: strs[1].trim() }).inject(row);
                        w = lefttd.getSize().x;
                        max = (w > max) ? max = w : max;
                    } else {
                        new Element('span', { html: str.trim() }).inject(el);
                        if (sects.length > 1) { new Element('br').inject(el); }
                    }
                });
            }
        });
        if (max > 0) { document.getElements('td.left').setStyle('width', max); }
        delete sects;
        delete strs;
        delete tabel;
        delete row;
        delete lefttd;
    },

    /**
    * Function : processInlineArrows
    * replaces text arrows with arrow icon inline
    */
    processInlineArrows: function () {
        var els = [];
        els.combine(document.getElements('.ui-replace-arrows td'));
        els.combine(document.getElements('.ui-replace-arrows li'));
        Array.each(els, function (el, index) {
            if ((el.get('tag')=='td' && el.getElements('.button,button').length == 0) || el.get('tag')!='td') {
                if (el.get('html').contains('-&gt;')) {
                    el.set('html', el.get('html').replace(/-&(gt);/g, '<span class="smicon arrow"></span>'));
                }
                if (el.get('html').contains('->')) {
                    el.set('html', el.get('html').replace(/->/g, '<span class="smicon arrow"></span>'));
                }
            }
        });
        els = null;
        delete els;
    }

});;

var UISelectLookup = new Class({

    Version: '1.0.4.0',
    File: 'ui.select.lookups.js',
    Notes: 'remove superfluous logging',

    Implements: [Options],

    Binds: [
		'processLookup', 'requestLookup', 'populateSelect',
        'processNew',
        'refreshQueue', 'cancelQueue',
        'processQueue',
        'removeFromQueue', 'addToQueue', 'addDefaultOption', 'addFilterOption'
    ],

    options: {
        jsonp: false
    },

    enabled: false,

    initialize: function (options) {

        this.setOptions(options);

        if (!Affinity.UI) { Affinity.UI = {}; }
        if (!Affinity.UI.lookups) { Affinity.UI.lookups = {}; }

        Affinity.UI.lookups.processLookup = this.processLookup;

        Affinity.UI.lookupLoaders = [];

        window.addEvent('refreshQueues', this.refreshQueue);

        if (Affinity.login) {
            window.addEvent('loggedout', this.cancelQueue);
            window.addEvent('loggedin', function () {
                this.enabled = true;
                this.processNew();
            }.bind(this));
        } else {
            this.enabled = true;
            this.processNew();
        }

    },

    processNew: function (options) {

        this.setOptions(options);

        var lookups = document.getElements('select.has-lookup');

        Array.each(lookups, this.processLookup);

        this.processQueue();

        delete lookups;

    },

    processLookup: function (select) {

        select.removeClass('has-lookup').addClass('was-lookup');

        if (select.hasClass('has-dependencies')) {
            return;
        }

        select.addClass('lookup-loading');

        if (select.get('data-lookup-api')) {
            var api, apiKey;
            if (select.get('data-lookup-api')) {
                select.removeClass('has-display-lookup');
                if (select.get('data-lookup-api') !== '') {

                    api = select.get('data-lookup-api');

                    if (!select.retrieve('original-lookup-url')) {
                        select.store('original-lookup-url', api);
                    }
					
					api = Affinity.GetCacheSafePath(api);
					
					/*
                    if (Affinity && Affinity.isie && Affinity.ieversion <= 9) { /* Defeat IE9 and less from caching (IE9 ignores headers) *
                        if (api.contains('?')) {
                            api += '&ran=' + String.uniqueID() + Date.parse(new Date()).format('%s');
                        } else {
                            api += '?ran=' + String.uniqueID() + Date.parse(new Date()).format('%s');
                        }
                    }
					*/
                    apiKey = this.getApiKey(api);
                    if (Affinity.UI.lookups[apiKey]) {
                        if (!Affinity.UI.lookups[apiKey].elements.contains[select]) {
                            Affinity.UI.lookups[apiKey].elements.push(select);
                        }
                    } else {
                        Affinity.UI.lookups[apiKey] = {
                            api: api,
                            id: 'lookup_' + String.uniqueID(),
                            type: 'select',
                            loaded: false,
                            massive: false,
                            elements: [select]
                        };
                    }
                }
            }

            select.addClass('hidden');

            if (!select.getParent().getElement('.lookup-spinner')) {
                var spinner = new Element('span', { 'html': '<img src="' + Affinity.loaders.light + '" />', 'class': 'lookup-spinner hidden' }).inject(select, 'after');
                select.store('spinner', spinner);
                if (!select.getParent().getElement('.ui-autocomplete-display')) {
                    spinner.removeClass('hidden');
                }
            }

            if (!select.getParent().getElement('.errorstr')) {
                var error = new Element('span', { 'class': 'errorstr inplace-of-input hidden' }).inject(select, 'after');
                select.store('error', error);
            }

            window.fireEvent('lookupComplete', select); /* used for tabbing fixes */

            //select.makeFormElement();
            select.addChangeTracker();
            select.fireEvent('lookup');

        }

    },

    getApiKey: function (api) {

        var uri = new URI(api.toLowerCase()),
            qBits = uri.get('query').parseQueryString(),
            qBitsArray = [],
            paramsStrArray = [],
            params = false,
            paramsStr = '',
            paramsArray, uriStr, key;

        Object.each(qBits, function (val, key) {
            if (key.toLowerCase() !== 'ran') {
                if (key !== 'parameters') {
                    qBitsArray.push(key + '-' + val);
                } else {
                    params = JSON.parse(val);
                }
            }
        });
        qBitsArray = qBitsArray.sort();

        if (params && typeOf(params) === 'object' && 'parameter' in params && typeOf(params.parameter) === 'array') {
            Array.each(params.parameter, function (paramObj) {
                paramsArray = [];
                Object.each(paramObj, function (val, key) {
                    if (key.toLowerCase() !== 'ran') {
                        paramsArray.push(key + '-' + val);
                    }
                });
                paramsArray.sort();
                paramsStrArray.push(paramsArray.join('|'));
            });
            paramsStrArray.sort();
            paramsStr = '|parameters|' + paramsStrArray.join('||');
        }

        uriStr = qBitsArray.join('|') + paramsStr;
        key = 'display-' + uriStr.replace(/\//g, '.');

        return key;

        //return api.replace(/[^a-zA-Z0-9_-]/g, '-') + '-' + Affinity.uisession;

    },

    refreshQueue: function () {

        log('&#171; REFRESH ALL LOOKUPS &#187;');

        this.enabled = false;

        Array.each(Affinity.UI.lookupLoaders, function (loader) {
            if ('cancel' in loader) {
                loader.cancel();
            }
            loader.removeEvents();
            loader = null;
        });
        Affinity.UI.lookupLoaders = [];
        Object.each(Affinity.UI.lookups, function (value, apiKey) {
            Affinity.UI.lookups[apiKey].loaded = false;
            Affinity.UI.lookups[apiKey].data = null;
        });

        this.enabled = true;

        window.fireEvent('lookupCacheClear');
    },

    cancelQueue: function () {

        //log('&#171; CANCEL AND CLEAR ALL LOOKUPS &#187;');

        this.enabled = false;

        Array.each(Affinity.UI.lookupLoaders, function (loader) {
            if ('cancel' in loader) {
                loader.cancel();
            }
            if ('removeEvents' in loader) {
                loader.removeEvents();
            }
            loader = null;
        });
        Affinity.UI.lookupLoaders = [];
        Object.each(Affinity.UI.lookups, function (value, apiKey) {
            Affinity.UI.lookups[apiKey].loaded = false;
            Affinity.UI.lookups[apiKey].data = null;
            Affinity.UI.lookups[apiKey].elements = [];
            Affinity.UI.lookups[apiKey] = null;
            delete Affinity.UI.lookups[apiKey];
        });
        Affinity.UI.lookups = {};

        return true;

    },

    processQueue: function () {

        var loader, url;

        try {

            Object.each(Affinity.UI.lookups, function (value, apiKey) {

                if (!this.enabled) {
                    //log('! lookup queue disabled - process stooped !');
                    //throw ('break Object.each');
                    return;
                }

                if (Affinity.UI.lookups[apiKey].loaded === true) {
                    this.setElements(apiKey);
                }

                if (Affinity.UI.lookups[apiKey].loaded === false) {

                    url = Affinity.UI.lookups[apiKey].api;

                    Affinity.UI.lookups[apiKey].loaded = 'loading...';

                    /* TODO: REMOVE THIS!! For debugging 'lookup unauthorised' auto log out *

                    var uriObj = new URI(url);
                    var query = uriObj.parsed.query.parseQueryString();

                    log('&#x2794; attempting lookup (id: ' + Affinity.UI.lookups[apiKey].id + ', data: ' + unescape(Object.toQueryString(query)) + ', apiKey: ' + apiKey + ' )...');

                    /**/

                    if (this.options.jsonp) {

                        loader = new Request.JSONP({
                            callbackKey: 'jsoncallback',
                            url: url,
                            method: 'get',
                            timeout: 60000,
                            onComplete: function (jsonData) {
                                if (!JSON.Unauthorized(jsonData, Affinity.UI.lookups[apiKey].id)) {

                                    Affinity.UI.lookups[apiKey].data = jsonData;

                                    if ('error' in jsonData) {

                                        /* limit exceeded */
                                        if (jsonData.error.test('limit', 'gi')) {

                                            Affinity.UI.lookups[apiKey].data = [];
                                            Affinity.UI.lookups[apiKey].massive = true;
                                            Affinity.UI.lookups[apiKey].loaded = true;
                                            this.setElements(apiKey);

                                        } else {

                                            //log('&#x2718; attempted lookup (id: ' + Affinity.UI.lookups[apiKey].id + ') succeeded with errors - ' + jsonData.error);

                                            this.setError(apiKey, jsonData.error && jsonData.error !== '' ? jsonData.error : 'There was an error retrieving this data');
                                            Affinity.UI.lookups[apiKey].loaded = false;

                                        }


                                    } else {

                                        //log('&#x2714; attempted lookup (id: ' + Affinity.UI.lookups[apiKey].id + ')  succeeded');

                                        if (typeOf(jsonData) === 'array' && jsonData.length > 0) {
                                            Affinity.UI.lookups[apiKey].loaded = true;
                                            this.setElements(apiKey);
                                        } else {
                                            Affinity.UI.lookups[apiKey].loaded = false;
                                            this.hideLoader(apiKey);
                                            this.setError(apiKey, 'Data returned as empty array');
                                            Array.each(Affinity.UI.lookups[apiKey].elements, function (element) {
                                                element.fireEvent('emptyData');
                                            }.bind(this));
                                        }
                                    }
                                }
                            }.bind(this),
                            onError: function (error) {

                                //log('&#x2718; attempted lookup (id: ' + Affinity.UI.lookups[apiKey].id + ')  failed with errors - ' + error);

                                this.setError(apiKey, 'There was an error retrieving this data');
                                Affinity.UI.lookups[apiKey].loaded = false;

                            }.bind(this),
                            onFailure: function (xhr) {

                                //log('&#x2718; attempted lookup (id: ' + Affinity.UI.lookups[apiKey].id + ')  failed with errors - ' + xhr.statusText);

                                this.setError(apiKey, 'There was an error retrieving this data');
                                Affinity.UI.lookups[apiKey].loaded = false;
                            }.bind(this),
                            onTimeout: function () {

                                //log('&#x2718; attempted lookup (id: ' + Affinity.UI.dependancies[apiKey].id + ') timed out');

                                this.setError(apiKey, 'lookup timed out');
                                Affinity.UI.dependancies[apiKey].loaded = false;

                            }.bind(this)
                        });

                    } else {

                        loader = new Request.JSON({
                            url: url,
                            method: 'get',
                            timeout: 60000,
                            onSuccess: function (jsonData) {
                                if (!JSON.Unauthorized(jsonData, Affinity.UI.lookups[apiKey].id)) {

                                    Affinity.UI.lookups[apiKey].data = jsonData;

                                    if ('error' in jsonData) {

                                        /* limit exceeded */
                                        if (jsonData.error.test('limit', 'gi')) {

                                            Affinity.UI.lookups[apiKey].data = [];
                                            Affinity.UI.lookups[apiKey].massive = true;
                                            Affinity.UI.lookups[apiKey].loaded = true;
                                            this.setElements(apiKey);

                                        } else {

                                            //log('&#x2718; attempted lookup (id: ' + Affinity.UI.lookups[apiKey].id + ') succeeded with errors - ' + jsonData.error);

                                            this.setError(apiKey, jsonData.error && jsonData.error !== '' ? jsonData.error : 'There was an error retrieving this data');
                                            Affinity.UI.lookups[apiKey].loaded = false;

                                        }


                                    } else {

                                        //log('&#x2714; attempted lookup (id: ' + Affinity.UI.lookups[apiKey].id + ')  succeeded');

                                        if (typeOf(jsonData) === 'array' && jsonData.length > 0) {
                                            Affinity.UI.lookups[apiKey].loaded = true;
                                            this.setElements(apiKey);
                                        } else {
                                            Affinity.UI.lookups[apiKey].loaded = false;
                                            this.hideLoader(apiKey);
                                            this.setError(apiKey, 'Data returned as empty array');
                                            Array.each(Affinity.UI.lookups[apiKey].elements, function (element) {
                                                element.fireEvent('emptyData');
                                            }.bind(this));
                                        }
                                    }
                                }
                            }.bind(this),
                            onError: function (error) {

                                //log('&#x2718; attempted lookup (id: ' + Affinity.UI.lookups[apiKey].id + ')  failed with errors - ' + error);

                                this.setError(apiKey, 'There was an error retrieving this data');
                                Affinity.UI.lookups[apiKey].loaded = false;

                            }.bind(this),
                            onFailure: function (xhr) {

                                //log('&#x2718; attempted lookup (id: ' + Affinity.UI.lookups[apiKey].id + ')  failed with errors - ' + xhr.statusText);

                                this.setError(apiKey, 'There was an error retrieving this data');
                                Affinity.UI.lookups[apiKey].loaded = false;
                            }.bind(this),
                            onTimeout: function () {

                                //log('&#x2718; attempted lookup (id: ' + Affinity.UI.lookups[apiKey].id + ') timed out');

                                this.setError(apiKey, 'lookup timed out');
                                Affinity.UI.dependancies[apiKey].loaded = false;

                            }.bind(this)
                        });

                    }

                    if (loader) {
                        Affinity.UI.lookupLoaders.push(loader);
                        loader.send();
                    }

                }

            }.bind(this));

        } catch (e) { }

    },

    /**/

    removeFromQueue: function (url, element, clear) {
        var widget, reverted, lookupIndex;
        if (element && element.getWidget()) {
            widget = element.getWidget();
            if (widget.hasOwnProperty('revert')) {
                reverted = widget.revert();
                if (typeOf(clear) === 'boolean' && clear === true) {
                    if ('empty' in element) {
                        element.empty();
                    }
                    if ('value' in element) {
                        element.value = '';
                    }
                }
            }
        }
        if (element.retrieve('spinner')) {
            spinner = element.retrieve('spinner');
            if (spinner && 'destroy' in spinner) {
                spinner.destroy();
            }
        }
        if (element.retrieve('error')) {
            error = element.retrieve('error');
            if (error && 'destroy' in error) {
                error.destroy();
            }
        }
        Array.each(Affinity.UI.lookups, function (obj, key) {
            if (obj.elements.contains(element)) {
                lookupIndex = obj.elements.indexOf(element);
                array.splice(lookupIndex, 1);
            }
        });
        return true;
    },

    addFilterOption: function(select, option) {
        select.set('filter-option', option);
        return true;
    },

    addDefaultOption: function (select, currentSelected) {
        if (currentSelected) {
            select.adopt(currentSelected);
        } else {
            var noneOption = new Element('option', {
                'value': '',
                'html': 'None'
            });
    
            select.adopt(noneOption);
        }
    },

    addToQueue: function (url, element) {
        element.set('data-lookup-api', url);
        this.processLookup(element);
        return true;
    },

    /**/

    hideLoader: function (apiKey) {
        Array.each(Affinity.UI.lookups[apiKey].elements, function (element) {
            if (element.retrieve('spinner')) {
                element.retrieve('spinner').addClass('hidden');
            }
        }.bind(this));
    },

    setError: function (apiKey, error) {
        Array.each(Affinity.UI.lookups[apiKey].elements, function (element) {
            if (element.retrieve('spinner')) {
                element.retrieve('spinner').addClass('hidden');
            }
            if (element.retrieve('error')) {
                if (element.get('data-lookup-error-str') && element.get('data-lookup-error-str').trim() !== '') {
                    element.retrieve('error').set('html', element.get('data-lookup-error-str').trim()).removeClass('hidden');
                } else {
                    element.retrieve('error').set('html', error).removeClass('hidden');
                }
            }
        }.bind(this));
    },

    setElements: function (apiKey) {
        Array.each(Affinity.UI.lookups[apiKey].elements, function (element) {
            if (typeOf(element) !== 'null' && typeOf(element.get) === 'function' && element.get('data-lookup-api')) {
                var filteredData = this.filterSelect(element, Affinity.UI.lookups[apiKey].data)
                this.populateSelect(element, filteredData, apiKey);
                element.erase('data-lookup-api');
            }
        }.bind(this));
    },

    filterSelect: function(select, jsonData) {
        var filterOption = select.get('filter-option')
        if (filterOption) {
            return jsonData.filter(function(data) {return data.Value.indexOf(filterOption) > -1})
        } else {
            return jsonData;
        }
    },

    populateSelect: function (select, jsonData, apiKey) {
        var option, html;
        var doEvent = false;
        var defaultValue = select.get('data-default-value') || '';
        var rules = select.get('data-lookup-rules') ? select.get('data-lookup-rules').split(',') : [];
        var hasInitalData = select.getElements('option').length > 0 && select.getElements('option')[0].get('html').trim() !== '';

        if (typeOf(jsonData) === 'array' /*&& jsonData.length > 0*/) {

            var selectedValue = typeOf(jsonData[0]) !== 'null' ? jsonData[0].Value : '';

            select.removeClass('lookup-loading');

            if (Affinity.UI.lookups[apiKey].massive || jsonData.length > Affinity.selectmax) {

                select.addClass('massive').store('data-store', 'lookups').store('data-key', apiKey).store('data-value', defaultValue).store('data-label', defaultValue);

            } else {

                var existingData = {};
                var existingOptions = select.getElements('option');
                if (existingOptions && existingOptions.length > 0) {
                    Array.each(existingOptions, function (option) {
                        existingData[option.get('value')] = option;
                    });
                }
                existingOptions = null;

                Array.each(jsonData, function (data, index) {
                    option = false;
                    html = data.Value;
                    if (existingData[data.Key]) {
                        option = existingData[data.Key];
                    } else {
                        if (rules.contains('hasValue')) {
                            if (data.Value.trim() !== '') {
                                option = new Element('option', {
                                    'value': data.Key,
                                    'html': html
                                });
                            }
                        } else {
                            option = new Element('option', {
                                'value': data.Key,
                                'html': html
                            });
                        }
                    }
                    if (option) {
                        if (data.Key == defaultValue) {
                            option.set('selected', 'selected');
                            selectedValue = defaultValue;
                            doEvent = true;
                        } else {
                            if (rules.contains('hasValue') && defaultValue === '' && index === 0) {
                                defaultValue = data.Key;
                                option.set('selected', 'selected');
                                select.set('data-default-value', defaultValue)
                                selectedValue = defaultValue;
                                doEvent = true;
                            }
                        }
                        if (true) {
                            select.adopt(
                                option
                            );
                        }
                    }
                });
            }

            var hasAutoceomple = 'UIAutoComplete' in window && typeOf(window['UIAutoComplete']) == 'class' ? true : false;
            var hasAutoceompleWidget = 'UIAutoCompleteWidget' in window && typeOf(window['UIAutoCompleteWidget']) == 'class' ? true : false;

            if (!doEvent && defaultValue == '' && typeOf(jsonData) == 'array' && jsonData.length > 0) {
                doEvent = true;
            }

            if (select.retrieve('spinner')) {
                select.retrieve('spinner').destroy();
            }
            select.removeClass('hidden');

            if (jsonData.length >= Affinity.selectToAutoNum && hasAutoceomple) {
                select.addClass('ui-autocomplete');
            }

            if (select.hasClass('ui-autocomplete') && hasAutoceompleWidget) {
                select.removeClass('ui-autocomplete');
                new UIAutoCompleteWidget({
                    selectElement: select
                });
            }

            if (!hasInitalData && select.retrieve('changetracker')) {
                select.retrieve('changetracker').setValue(select, defaultValue);
            }

            if (doEvent) {
                if (select.get('onChange') || select.get('onchange')) {
                    select.onChange();
                } else {
                    select.fireEvent('change', { target: select });
                }
            }

            select.fireEvent('lookupComplete', { defaultValue: defaultValue, value: selectedValue, target: select });

        }

        delete doEvent;
        delete option;
        delete defaultValue;

    }

});;

var UITabs = new Class({

    Version: '1.0.0.0',
    File: 'ui.tabs.js',

    Implements: [Options],

    Binds: [
        'init', 'processNew'
    ],

    options: {
    },

    initialize: function (options) {

        this.setOptions(options);

        this.init();

    },

    processNew: function () {

        this.init();
    },

    init: function () {

        Array.each(document.getElements('.ui-tab-container'), function (tabcontainer) {

            if (!tabcontainer.hasClass('ui-done')) {

                tabcontainer.addClass('ui-done');

                var tabs = tabcontainer.getElements('.ui-tab');

                tabs.addClass('hidden');

                Array.each(tabcontainer.getElements('.ui-tab-title'), function (tabtitle, index) {
                    tabtitle.store('tab', tabs[index]);
                    tabtitle.addEvents({
                        'click': function (e) {
                            var el = e.target.hasClass('ui-tab-title') ? e.target : e.target.getParent('.ui-tab-title');
                            el.getParent('.ui-tab-container').getElements('.ui-tab-title').removeClass('selected');
                            el.getParent('.ui-tab-container').getElements('.ui-tab').addClass('hidden');
                            el.retrieve('tab').removeClass('hidden');
                            el.addClass('selected');
                        }
                    });
                }.bind(this));

                tabcontainer.getElement('.ui-tab-title').addClass('selected');
                tabcontainer.getElement('.ui-tab').removeClass('hidden');

            }

        }.bind(this));

    }

});;
var UITaxNumber = new Class({

    Implements: [Options],

    Binds: [
		'processNew',
		'process'
    ],

    options: {
        postId: '',
        target: null
    },

    lists: {},

    initialize: function (options)
    {
        this.setOptions(options);
        this.processNew();
    },

    processNew: function ()
    {
        Array.each(document.getElements('.ui-taxnumber'), this.process);
    },

    process: function (el)
    {
        el.removeClass('ui-taxnumber');
        new UITaxNumberWidget({
            element: el
        });
    }

});

var UITaxNumberWidget = new Class({

    Implements: [Options, Events],

    Binds: [
		'taxFieldChange',
		'currentLocation',
		'taxFields',
		'buildNZTax',
		'buildAUTax',
		'taxValidation',
		'processValidation',
		'processKeyUp',
		'setFromInitialValue',
		'copyToHidden',
		'success',
		'failed',
		'revert',
		'destroy'
    ],

    options: {
        element: null,
        hasPayPoint: true
    },

    element: null,

    type: 'taxnumber',

    initialize: function (options)
    {
        this.setOptions(options);

        this.originalElement = this.options.element;

        this.postname = this.originalElement.get('name') || '';

        this.disabled = this.originalElement.get('disabled') ? true : false;

        if (this.options.element === null || typeOf(this.options.element) !== 'element') {
            throw ('No valid element passed in, dummy');
            return;
        }

        this.dropdownDiv = new Element('div', {
            'class': 'countryselector',
        }).inject(this.originalElement, 'before');

        this.dropdownDiv.set('tabindex', 5000);

        var isRequired = this.originalElement.get('data-required');
        if (isRequired === 'True') {
            this.dropdown = new Element('select', {
                'class': 'selector validate',
                'data-validate-method': 'taxNumberCountry'
            }).inject(this.dropdownDiv);
        } else {
            this.dropdown = new Element('select', {
                'class': 'selector'
            }).inject(this.dropdownDiv);
        }

        this.dropdownoption1 = new Element('option', {
            'html': '',
            'value': ''
        }).inject(this.dropdown);

        this.dropdownoption2 = new Element('option', {
            'html': 'AU',
            'value': 'AU'
        }).inject(this.dropdownoption1, 'after');

        this.dropdownoption3 = new Element('option', {
            'html': 'NZ',
            'value': 'NZ',
        }).inject(this.dropdownoption2, 'after');

        var location = this.originalElement.get('data-country');

        if (Affinity.CF.hasOwnProperty('hasPayPoint') && typeof Affinity.CF.hasPayPoint == 'boolean') this.options.hasPayPoint = Affinity.CF.hasPayPoint;
        if (location !== 'AU' && location !== 'NZ') location = this.currentLocation();
        if (location.trim() === '') this.options.hasPayPoint = false;

        if (this.dropdown)
        {
            if (this.options.hasPayPoint) this.dropdown.addClass('subhidden');
            else this.dropdown.removeClass('subhidden');
            this.dropdown.value = location;
        }

        if (this.disabled) {
            this.countrySelectEl = new Element('input', {
                'type': 'text',
                'class': 'selector',
                'disabled': 'disabled',
                'value': this.dropdown.value
            }).inject(this.dropdown, 'after');
            this.dropdown.destroy();
        } else {
            this.countrySelectEl = this.dropdown;
            this.dropdown.onchange = this.taxFieldChange;
            window.addEvent('taxValidationReturned', this.processValidation);
        }

        this.countrySelectEl.set('name', this.postname + '_country').set('id', this.postname + '_country');
        this.taxFields(location);
    },

    taxFieldChange: function ()
    {
        if (this.element != null) {
            this.element.destroy();
        }

        var form, fields, fieldId, displayField, url, uriObj, queryObj, country, canceled, removed, added, currentSelection;

        if (this.dropdown.getParent('form')) {

            form = this.dropdown.getParent('form');

            fields = [];
            Array.each(form.getElements('input, select, textarea'), function (input)
            {
                if (input.get('name') && input.get('name').contains('TaxCode')) {
                    fields.push(input);
                }
            }.bind(this));

            if (fields.length > 0) {

                Array.each(fields, function (field)
                {

                    fieldId = field.get('data-display-id');
                    url = field.retrieve('original-lookup-url');
                    currentSelection = field.options[field.selectedIndex];

                    canceled = Affinity.lookups.cancelQueue();
                    removed = Affinity.lookups.removeFromQueue(url, field, true);

                    country = this.dropdown.value;
                    if (currentSelection.text.indexOf('- ' + country) === -1) {
                        currentSelection = null;
                    }

                    uriObj = new URI(url);
                    queryObj = uriObj.parsed.query.parseQueryString();
                    queryObj.payPointCountry = country;

                    uriObj.parsed.query = Object.toQueryString(queryObj);
                    url = uriObj.toString();
                    Affinity.lookups.addDefaultOption(field, currentSelection);
                    Affinity.lookups.addFilterOption(field, '- ' + country);
                    added = Affinity.lookups.addToQueue(url, field);
                    Affinity.lookups.refreshQueue();
                    Affinity.lookups.processQueue();

                }.bind(this));
            }
        }

        this.taxFields(this.currentLocation());
    },

    currentLocation: function ()
    {
        if (this.countrySelectEl) {
            if (this.countrySelectEl.get('tag') === 'select') {
                return this.countrySelectEl.options[this.countrySelectEl.selectedIndex].value;
            }
            return this.countrySelectEl.value;
        } else {
            return 'NZ';
        }
    },

    taxFields: function (location)
    {
        if (location === 'NZ') {
            this.buildNZTax();
            this.originalElement.removeClass('hidden');
        } else if (location === 'AU') {
            this.buildAUTax();
            this.originalElement.removeClass('hidden');
        } else {
            this.originalElement.value = '';
            this.originalElement.addClass('hidden');
            window.fireEvent('taxValidationError', {
                target: this.originalElement,
                silent: true
            });
        }
    },

    buildNZTax: function ()
    {
        this.element = new Element('div', {
            'class': 'taxnumberbox ui-validate nz',
            'data-validate-method': 'taxnumber'
        }).inject(this.dropdownDiv, 'after');

        this.element.set('tabindex', 5000);

        this.taxNumberPart1 = new Element('input', {
            'class': 'tax1',
            'type': 'text',
            'maxlength': '3'
        }).inject(this.element);

        new Element('span', {
            'html': ' - '
        }).inject(this.element);

        this.taxNumberPart2 = new Element('input', {
            'class': 'tax2',
            'type': 'text',
            'maxlength': '3'
        }).inject(this.element);

        new Element('span', {
            'html': ' - '
        }).inject(this.element);

        this.taxNumberPart3 = new Element('input', {
            'class': 'tax3',
            'type': 'text',
            'maxlength': '3'
        }).inject(this.element);

        this.tickcross = new Element('span', {
            'class': 'tickcross font-icons color',
        }).inject(this.element);

        if (this.hiddenWrapper) {
            this.element.inject(this.hiddenWrapper, 'before');
        } else {
            this.hiddenWrapper = new Element('div', {
                'class': 'subhidden'
            }).inject(this.originalElement, 'after');

            this.hiddenWrapper.adopt(this.originalElement);

            this.element.inject(this.hiddenWrapper, 'before');
        }

        if (this.disabled) {
            this.taxNumberPart1.set('disabled', 'disabled');
            this.taxNumberPart2.set('disabled', 'disabled');
            this.taxNumberPart3.set('disabled', 'disabled');
            this.tickcross.addClass('hidden');
        } else {
            this.taxNumberPart1.onkeyup = this.processKeyUp;
            this.taxNumberPart2.onkeyup = this.processKeyUp;
            this.taxNumberPart3.onkeyup = this.processKeyUp;
            this.tickcross.set('html', Affinity.icons.Blocked);
        }

        this.setFromInitialValue();
    },

    buildAUTax: function ()
    {

        var disabled = this.originalElement.get('disabled') ? true : false;

        this.element = new Element('div', {
            'class': 'taxnumberbox ui-validate au',
            'data-validate-method': 'taxnumber'
        }).inject(this.dropdownDiv, 'after');

        this.element.set('tabindex', 5000);

        this.taxNumberPart1 = new Element('input', {
            'class': 'tax1',
            'type': 'text',
            'maxlength': '3'
        }).inject(this.element);

        new Element('span', {
            'html': ' - '
        }).inject(this.element);

        this.taxNumberPart2 = new Element('input', {
            'class': 'tax2',
            'type': 'text',
            'maxlength': '3'
        }).inject(this.element);

        new Element('span', {
            'html': ' - '
        }).inject(this.element);

        this.taxNumberPart3 = new Element('input', {
            'class': 'tax3',
            'type': 'text',
            'maxlength': '3'
        }).inject(this.element);

        this.tickcross = new Element('span', {
            'class': 'tickcross font-icons color',
        }).inject(this.element);

        if (this.hiddenWrapper) {
            this.element.inject(this.hiddenWrapper, 'before');
        } else {
            this.hiddenWrapper = new Element('div', {
                'class': 'subhidden'
            }).inject(this.originalElement, 'after');

            this.hiddenWrapper.adopt(this.originalElement);

            this.element.inject(this.hiddenWrapper, 'before');
        }

        if (this.disabled) {
            this.taxNumberPart1.set('disabled', 'disabled');
            this.taxNumberPart2.set('disabled', 'disabled');
            this.taxNumberPart3.set('disabled', 'disabled');
            this.tickcross.addClass('hidden');
        } else {
            this.taxNumberPart1.onkeyup = this.processKeyUp;
            this.taxNumberPart2.onkeyup = this.processKeyUp;
            this.taxNumberPart3.onkeyup = this.processKeyUp;
            this.tickcross.set('html', Affinity.icons.Blocked);
        }

        this.setFromInitialValue();
    },

    processKeyUp: function ()
    {
        this.copyToHidden();
        this.taxValidation();
    },

    setFromInitialValue: function ()
    {
        var taxNum = this.hiddenWrapper.getElement('input').value;
        this.taxNumberPart3.value = taxNum.substr(taxNum.length - 3);
        this.taxNumberPart2.value = taxNum.substr(taxNum.length - 6, 3);
        this.taxNumberPart1.value = taxNum.replace(taxNum.substr(taxNum.length - 6), '');
        this.taxValidation();
    },

    copyToHidden: function ()
    {
        var b1 = this.taxNumberPart1.value != '' ? this.taxNumberPart1.value : '';
        var b2 = this.taxNumberPart2.value != '' ? this.taxNumberPart2.value : '';
        var b3 = this.taxNumberPart3.value != '' ? this.taxNumberPart3.value : '';

        var taxNum = b1 + b2 + b3;
        this.hiddenWrapper.getElement('input').value = taxNum;
        this.hiddenWrapper.getElement('input').set('data-country', this.dropdown.value);
    },

    taxValidationDelay: false,
    taxValidation: function ()
    {
        clearTimeout(this.taxValidationDelay);
        this.taxValidationDelay = function ()
        {
            var el = this.hiddenWrapper.getElement('input');
            var form = el.getParent('form');
            if (form != null && form.retrieve('validation')) {
                var validator = form.retrieve('validation');
                validator.validateTaxNumber(el, this.currentLocation(), el.get('name'));
            }
        }.delay(500, this);
    },

    processValidation: function (result)
    {
        var el = result.el;
        var jsonData = result.data;

        if (el !== this.originalElement) {
            return;
        }

        if (jsonData.success) {
            this.success();
        } else {
            if (el.value) {
                this.failed();
            } else {
                window.fireEvent('taxValidationSuccess');
                this.tickcross.set('html', Affinity.icons.Blocked);
                this.tickcross.removeClass('red');
                this.tickcross.removeClass('green');
            }
        }
    },

    success: function (jsonData)
    {

        var tickcross = this.tickcross;

        tickcross.set('html', Affinity.icons.Tick);
        tickcross.removeClass('red').addClass('green');

    },

    failed: function (jsonData)
    {

        var tickcross = this.tickcross;

        tickcross.set('html', Affinity.icons.Cross);
        tickcross.removeClass('green').addClass('red');

    },

    revert: function ()
    {

        if (this.displayElement) {
            this.displayElement.removeEvent('keyup', this.doKeyUp);
            this.iconElement.destroy();
            this.displayElement.destroy();
        }

        this.selectElement.inject(this.hiddenWrapper, 'before');
        this.hiddenWrapper.destroy();
        this.selectElement.eliminate('widget');
        var select = this.selectElement;

        Object.each(this, function (key, val)
        {
            this[key] = null;
            delete this[key];
        }.bind(this));

        return select;

    },

    destroy: function ()
    {

        clearTimeout(this.checkExistsPeriodical);
        var select = this.revert();
        select.destroy();

    }

});;
var UITextareaAutoSize = new Class({

    Implements: [Options],

    Binds: [
        'processNew',
        'process'
    ],

    options: {
        postId: '',
        target: null
    },

    initialize: function (options) {
        this.setOptions(options);
        this.processNew();
    },

    processNew: function () {
        Array.each(document.getElements('.ui-textarea-autosize'), this.process);
    },

    process: function (el) {
        el.removeClass('ui-textarea-autosize');
        new UITextareaAutoSizeWidget({
            element: el
        });
    }

});

var UITextareaAutoSizeWidget = new Class({

    Implements: [Options, Events],

    Binds: [
        'checkContent',
        'hasContent',
        'resize',
        'revert',
        'destroy'
    ],

    options: {
        element: null
    },

    element: null,
    initialContent: false,
    initialContentInterval: false,

    initialize: function (options) {

        this.setOptions(options);

        this.originalElement = this.options.element;

        this.postname = this.originalElement.get('name') || '';

        this.disabled = this.originalElement.get('disabled') ? true : false;

        if (this.options.element === null || typeOf(this.options.element) !== 'element') {
            throw ('No valid element passed in, dummy');
            return;
        }

        if (this.originalElement.value === '') {
            this.initialContentInterval = this.checkContent.periodical(100, this);
        } else {
            this.hasContent();
        }

    },

    checkContent: function () {
        if (this.originalElement.value !== '') {
            clearInterval(this.initialContentInterval);
            this.hasContent();
        }
    },

    hasContent: function () {
        clearInterval(this.initialContentInterval);
        this.initialHeight = this.originalElement.getSize().y;
        this.originalElement.addEvent('keyup', this.resize);
        this.resize();
    },

    resize: function () {
        // TODO: Maybe ... set height to 0 and then resize to allow shrinking as well as growing???
        var currentHeight = this.originalElement.getSize().y;
        var scrollHeight = this.originalElement.getScrollSize().y;
        if (scrollHeight > currentHeight && scrollHeight > this.initialHeight) {
            this.originalElement.setStyle('height', scrollHeight);
        }
    },

    revert: function () {
        clearInterval(this.initialContentInterval);
        this.originalElement.removeEvent('keyup', this.resize);
        Object.each(this, function (key, val) {
            this[key] = null;
            delete this[key];
        }.bind(this));
    },

    destroy: function () {
        this.revert();
    }

});;
var UITimePickerWidget = new Class({

    Version: '1.0.0.0',
    File: 'ui.time.picker.js',

    Implements: [Options, Events],

    options: {
        target: null,
        displayInput: false,
        timeonly: true,
        date: null,
        dateWidget: null,
        width: 150,
        hoursmins: false
    },

    Binds: [
        'swapHours', 'swapMinutes', 'setAMPM', 'setAM', 'setPM', 'done',
        'tileOver', 'tileOut', 'setMinute', 'swapHours', 'setHour', 'swapMinutes',
        'setLastValue','attemptParse'
    ],

    row: null,

    initialize: function (options) {

        this.setOptions(options);

        if (this.options.width < 150) {
            this.options.width = 150;
        }

        this.icons = {};
        this.icons.done = Affinity.icons.Tick;

        this.target = this.options.target;

        this.timeTarget = new Element('div', { 'class': 'ui-calendar-time' }).setStyles({
            width: this.options.width
        }).inject(this.target);

        this.displayTarget = new Element('div', { 'class': 'ui-calendar-time-display', 'html': '<span></span>:<span></span> <span></span>' }).inject(this.timeTarget);
        this.displayTarget.set('reveal', { duration: 250 });

        this.containerBox = new Element('div', { 'class': 'ui-calendar-time-container' }).setStyles({
            width: this.options.width
        }).inject(this.timeTarget);
        this.containerBox.set('reveal', { duration: 250 });

        this.hoursTarget = new Element('div', { 'class': 'ui-calendar-time-circle hours' }).inject(this.containerBox);
        this.minutesTarget = new Element('div', { 'class': 'ui-calendar-time-circle minutes' }).inject(this.containerBox);

        this.hoursTarget.set('reveal', { duration: 250 });
        this.minutesTarget.set('reveal', { duration: 250 });
        //this.hoursTarget.toggle();
        this.minutesTarget.toggle();

        var bits = this.displayTarget.getElements('span');
        this.hourDisplay = bits[0];
        this.minDisplay = bits[1];
        this.ampmDisplay = bits[2];
        delete bits;

        this.doneButton = new Element('div', { 'class': 'button green w-icon done', 'html': '<span>' + this.icons.done + '</span> Done' }).inject(this.containerBox);

        this.amButton = new Element('div', { 'class': 'am', 'html': 'am' }).inject(this.containerBox);
        this.pmButton = new Element('div', { 'class': 'pm', 'html': 'pm' }).inject(this.containerBox);

        /**/

        this.hourDisplay.addEvent(Affinity.events.click, this.swapHours);
        this.minDisplay.addEvent(Affinity.events.click, this.swapMinutes);

        if (this.options.hoursmins) {
            this.amButton.addClass('hidden');
            this.pmButton.addClass('hidden');
            this.ampmDisplay.addClass('hidden');
        } else {
            this.ampmDisplay.addEvent(Affinity.events.click, this.setAMPM);
            this.amButton.addEvent(Affinity.events.click, this.setAM);
            this.pmButton.addEvent(Affinity.events.click, this.setPM);
        }

        this.doneButton.addEvent(Affinity.events.click, this.done);

        /**/

        //this.size = this.timeTarget.getSize();
        this.size = { x: 170, y: 170 };
        this.width = this.size.x - 50;
        this.height = this.width;
        this.radius = this.width / 2;

        /**/

        this.center = new Element('div', { 'class': 'circle-center' }).setStyles({
            top: (this.size.x / 2) - 15,
            left: this.options.width > 150 ? ((this.size.x / 2) - 15) + ((this.options.width - 150) / 2) : (this.size.x / 2) - 15
        }).inject(this.containerBox, 'top');

        this.marker = new Element('div', { 'class': 'circle-hover-marker' }).inject(this.containerBox, 'top');
        this.marker.set('tween', { duration: 250 });
        this.marker.fade('hide');

        this.canvasOK = true;
        this.canvas = new Element('canvas', { width: 150, height: 150 }).setStyles({
            position: 'absolute',
            top: 0,
            left: this.options.width > 150 ? (this.options.width - 150) / 2 : 0,
            width: 150,
            height: 150
        }).inject(this.containerBox, 'top');
        try {
            this.canvasContext = this.canvas.getContext("2d");
        } catch (e) {
            this.canvasOK = false;
        }
        if (this.canvasOK) {
            this.canvasContext.lineWidth = 2;
            this.canvasContext.strokeStyle = this.center.getStyle('background-color');
        } else {
            this.canvas.destroy();
        }

        var circlebg = new Element('div', { 'class': 'ui-calendar-time-circle-bg' }).inject(this.containerBox, 'top');
        if (this.options.width > 150) {
            circlebg.setStyle('left', (this.options.width - 150) / 2);
        }

        /**/

        this.fireSet = true;
        if (this.options.date === null || this.options.date === false) {
            this.fireSet = false;
            this.date = new Date();
            this.date.setSeconds(0);
            this.date.setMilliseconds(0);
        } else {
            this.date = this.options.date.clone();
        }

        this.hour = this.date.getHours();
        this.minunte = this.date.getMinutes();

        this.ampm = this.hour >= 12 ? 'pm' : 'am';

        this.hoursTargetStatus = 'closed';
        this.minutesTargetStatus = 'closed';

        this.buildTimeElements();

        this.hide();

        /** if time only AND we have been passed a display input, update based on user inputs **/

        if (this.options.timeonly && this.options.displayInput) {
            this.options.displayInput.addEvent(Affinity.events.click, this.setLastValue);
            this.options.displayInput.addEvent('focus', this.setLastValue);
            this.options.displayInput.addEvent('blur', this.attemptParse);
        }

    },

    buildTimeElements: function () {

        var angle = 0;
        var elements, size, markvalue;

        /**/

        var container = this.hoursTarget;

        markvalue = 3;
        for (i = 0; i < 12; i++) {
            new Element('div', { 'html': markvalue, 'class': 'time-circle-tile h-' + markvalue }).inject(container);
            markvalue++;
            if (markvalue >= 13) {
                markvalue = 1;
            }
            if (this.options.hoursmins && markvalue === 12) {
                markvalue = 0;
            }
        }

        elements = this.hoursTarget.getElements('div');
        angle = 0;
        step = (2 * Math.PI) / elements.length;

        Array.each(elements, function (element) {
            var size = element.getSize();
            var x = Math.round(this.width / 2 + this.radius * Math.cos(angle) - 10) + 15;
            var y = Math.round(this.height / 2 + this.radius * Math.sin(angle) - 10) + 15;
            element.setStyles({
                left: x + 'px',
                top: y + 'px'
            });
            angle += step;
            element.addEvent(Affinity.events.overAll, this.tileOver);
            element.addEvent(Affinity.events.outAll, this.tileOut);
            element.addEvent(Affinity.events.click, this.setHour);
            element.addEvent(Affinity.events.click, this.swapMinutes);
        }.bind(this));

        /**/

        container = this.minutesTarget;

        markvalue = 15;
        for (i = 0; i < 60; i++) {
            new Element('div', { 'html': markvalue, 'class': 'time-circle-tile m-' + markvalue }).inject(container);
            i += 4;
            markvalue += 5;
            if (markvalue >= 60) {
                markvalue = 0;
            }
        }

        elements = this.minutesTarget.getElements('div');
        angle = 0;
        step = (2 * Math.PI) / elements.length;

        Array.each(elements, function (element) {
            var x = Math.round(this.width / 2 + this.radius * Math.cos(angle) - 10) + 15;
            var y = Math.round(this.height / 2 + this.radius * Math.sin(angle) - 10) + 15;
            element.setStyles({
                left: x + 'px',
                top: y + 'px'
            });
            angle += step;

            element.addEvent(Affinity.events.overAll, this.tileOver);
            element.addEvent(Affinity.events.outAll, this.tileOut);
            element.addEvent(Affinity.events.click, this.setMinute);
            element.addEvent(Affinity.events.click, this.swapHours);
        }.bind(this));

    },

    setDisplayTime: function () {
        if (this.options.hoursmins) {
            this.hourDisplay.set('html', this.date.format('%H'));
            this.minDisplay.set('html', this.date.format('%M'));
        } else {
            this.hourDisplay.set('html', this.date.format('%l'));
            this.minDisplay.set('html', this.date.format('%M'));
            this.ampmDisplay.set('html', this.date.format('%p').toLowerCase());
        }
        if (this.fireSet) {
            this.fireEvent('timeSet', this.date);
        }
        this.fireSet = true;

        /** if time only, update based oin user inputs **/

        if (this.options.timeonly && this.displayTarget) {
            //this.attemptParse();
        }

    },

    setHour: function (e) {
        this.hour = parseInt(e.target.get('html'));
        this.date.setHours(this.hour);
        this.setDisplayTime();
        this.hoursTarget.getElements('.active').removeClass('active');
        e.target.addClass('active');
    },

    setMinute: function (e) {
        this.minunte = parseInt(e.target.get('html'));
        this.date.setMinutes(this.minunte);
        this.setDisplayTime();
        this.minutesTarget.getElements('.active').removeClass('active');
        e.target.addClass('active');
    },

    setAMPM: function () {
        this.containerBox.reveal();
        this.hourDisplay.removeClass('active');
        this.minDisplay.removeClass('active');
        this.ampmDisplay.addClass('active');
        if (this.ampm == 'am') {
            this.setPM();
        } else {
            this.setAM();
        }
    },

    setAM: function (e) {
        this.hourDisplay.removeClass('active');
        this.minDisplay.removeClass('active');
        this.ampmDisplay.addClass('active');
        this.ampm = 'am';
        if (this.date.getHours() >= 12) {
            this.date.setHours(this.date.getHours() - 12);
        }
        this.setDisplayTime();
    },

    setPM: function (e) {
        this.hourDisplay.removeClass('active');
        this.minDisplay.removeClass('active');
        this.ampmDisplay.addClass('active');
        this.ampm = 'pm';
        if (this.date.getHours() < 12) {
            this.date.setHours(this.date.getHours() + 12);
        }
        this.setDisplayTime();
    },

    swapMinutes: function (e) {
        this.show();
        this.hourDisplay.removeClass('active');
        this.minDisplay.addClass('active');
        this.ampmDisplay.removeClass('active');
        this.hoursTargetStatus = 'closed';
        this.minutesTargetStatus = 'open';
        this.hoursTarget.dissolve();
        this.minutesTarget.reveal();
        this.marker.fade('out');
        (function () {
            if (this.minutesTarget.getElement('.active')) {
                this.positionMarker(this.minutesTarget.getElement('.active'));
            }
        }).delay(300, this);
    },

    swapHours: function (e) {
        this.show();
        this.hourDisplay.addClass('active');
        this.minDisplay.removeClass('active');
        this.ampmDisplay.removeClass('active');
        this.hoursTargetStatus = 'open';
        this.minutesTargetStatus = 'closed';
        this.hoursTarget.reveal();
        this.minutesTarget.dissolve();
        this.marker.fade('out');
        (function () {
            if (this.hoursTarget.getElement('.active')) {
                this.positionMarker(this.hoursTarget.getElement('.active'));
            }
        }).delay(300, this);
    },

    positionMarker: function (element) {
        var pos = element.getPosition(this.containerBox);
        this.marker.setPosition({ x: pos.x - 4, y: pos.y - 4 });
        this.marker.fade('in');
        delete pos;
    },

    tileOver: function (e) {
        //this.positionMarker(e.target);
        if (this.canvasOK) {
            var start = this.center.getPosition(this.canvas);
            var end = e.target.getPosition(this.canvas);
            this.canvasContext.clearRect(0, 0, 150, 150);
            this.canvasContext.beginPath();
            this.canvasContext.moveTo(start.x + 5, start.y + 5);
            this.canvasContext.lineTo(end.x + 10, end.y + 10);
            this.canvasContext.stroke();
            delete start;
            delete end;
        }
    },

    tileOut: function (e) {
        if (this.canvasOK) {
            this.canvasContext.clearRect(0, 0, 150, 150);
        }
        this.marker.fade('out');
        if (this.hoursTargetStatus == 'open') {
            if (this.hoursTarget.getElement('.active')) {
                this.positionMarker(this.hoursTarget.getElement('.active'));
            }
        }
        if (this.minutesTargetStatus == 'open') {
            if (this.minutesTarget.getElement('.active')) {
                this.positionMarker(this.minutesTarget.getElement('.active'));
            }
        }
    },

    show: function () {
        clearTimeout(this.autoHideDelay);
        if (!this.options.hoursmins) {
            this.containerBox.reveal();
            this.showDisplay();
            this.fireEvent('open', this.date);
        }
    },

    hide: function () {
        if (this.hourDisplay) this.hourDisplay.removeClass('active');
        if (this.minDisplay) this.minDisplay.removeClass('active');
        if (this.ampmDisplay) this.ampmDisplay.removeClass('active');
        if (!this.options.timeonly) {
            this.containerBox.dissolve();
        } else {
            if(this.options.dateWidget){
                try {
                    this.options.dateWidget.hide();
                }catch(e){}
            }
        }
    },

    showDisplay: function () {
        this.displayTarget.reveal();
    },

    hideDisplay: function () {
        this.displayTarget.dissolve();
    },

    done: function () {
        this.hide();
        this.fireEvent('timeSet', this.date);
        this.fireEvent('done', this.date);
    },

    setTime: function (date) {
        this.date = date.clone();
        this.setDisplayTime();
    },

    getTime: function () {
        return this.date;
    },

    /**

    updateUI: function (date) {

        // reset UI //

        this.hourDisplay.removeClass('active');
        this.minDisplay.removeClass('active');
        this.ampmDisplay.removeClass('active');
        this.hoursTarget.getElements('.active').removeClass('active');
        this.minutesTarget.getElements('.active').removeClass('active')

        //

        this.hour = date.getHours();
        this.date.setHours(this.hour);
 
        this.minunte = date.getMinutes();
        this.date.setMinutes(this.minunte);


        if(this.hours < 12){
            this.ampm = 'am';
        }else{
            this.ampm = 'pm';
        }

        // set active elements //

        var hourClassId = this.hour > 12 ? this.hour - 12 : this.hour, hourClassId = hourClassId === 0 ? 12 : hourClassId;
        var minClassId = this.minunte;

        var hourClass = '.h-' + parseInt(hourClassId, 10);
        var minClass = '.m-' + parseInt(minClassId, 10);

        var selectHour = this.hoursTarget.getElement(hourClass);
        var selectMin = this.minutesTarget.getElement(minClass);

        if (selectHour) {
            selectHour.addClass('active');
        }
        if (selectMin) {
            selectMin.addClass('active');
        }

        this.swapHours();

        this.setDisplayTime();

    },

    /**/

    lastValue: false,
    setLastValue: function () {
        if (this.options.displayInput && this.options.displayInput.get('tag') === 'input') {
            this.lastValue = this.options.displayInput.value;
        }
    },

    autoHideDelay: null,
    attemptParse: function (e) {

        clearTimeout(this.autoHideDelay);

        if(this.options.displayInput && this.options.displayInput.get('tag') === 'input'){

            var attemptStr = this.options.displayInput.value,
                attempt = false,
                hours = false,
                mins = false,
                bits, hourStr, minStr;

            attemptStr = attemptStr.trim();

            if (this.options.timeonly && this.options.hoursmins) {

                bits = attemptStr.toLowerCase().replace(/m/, ' m ').replace(/h/, ' h ').split(/[^0-9mh]/i);

                bits = bits.filter(function (val) {
                    if (val === 'h' || val === 'm') {
                        return val;
                    }
                    return !isNaN(parseFloat(val, 10))
                });

                if (bits.contains('m') && !isNaN(bits[bits.indexOf('m') - 1])) {
                    mins = parseFloat(bits[bits.indexOf('m') - 1], 10);
                    bits.splice(bits.indexOf('m'), 1);
                }

                if (bits.contains('h') && !isNaN(bits[bits.indexOf('h') - 1])) {
                    hours = parseFloat(bits[bits.indexOf('h') - 1], 10);
                    bits.splice(bits.indexOf('h'), 1);
                }

                if (mins || hours) {
                    bits = [];

                    if (hours) {
                        bits.push(hours)
                    } else {
                        bits.push(0);
                    }

                    if (mins) {
                        bits.push(mins);
                    } else {
                        bits.push(0);
                    }

                } else {

                    if (attemptStr.charAt(0) === ':' || attemptStr.charAt(0) === '.') {
                        bits.unshift(0);
                    }

                    if (bits.length === 1) {
                        bits[1] = '0';
                    }

                }

                hours = parseInt(bits[0], 10);
                mins = parseInt(bits[1], 10);

                if (parseInt(hours, 10) > 11) {
                    hours = '11';
                }

                // decimal conversion
                if (attemptStr.contains('.')) {
                    mins = Math.round(parseFloat('0.' + mins) * 60);
                }

                if (parseInt(mins, 10) > 59) {
                    hours = '59';
                }

                attemptStr = (hours + '').pad(2, '0', 'left') + ':' + (mins + '').pad(2, '0', 'left');

                try {
                    attempt = Date.parse(attemptStr);
                } catch (ex) {
                    attempt = false;
                }

                if (attempt && typeOf(attempt) === 'date' && attempt.isValid()) {
                    if (this.options.timeonly && this.options.displayInput) {
                        this.options.displayInput.value = attemptStr;
                    }
                    this.setTime(attempt);
                }

            } else {

                if (this.options.timeonly) {
                    attemptStr = attemptStr.replace(new RegExp(/[^0-9.\:]/gi), '');
                }

                if (attemptStr !== '') {

                    if (attemptStr.contains(':')) {

                        bits = attemptStr.split(':');

                        hourStr = bits[0];

                        if (parseInt(hourStr, 10) > 24) {
                            hourStr = '24';
                        }
                        if (parseInt(hourStr, 10) < 0) {
                            hourStr = '00';
                        }

                        hourStr = hourStr.pad(2, '0', 'left');

                        /**/

                        minStr = bits[1].pad(2, '0', 'right');

                        if (parseInt(minStr, 10) > 60) {
                            hourStr = '00';
                        }
                        if (parseInt(hourStr, 10) < 0) {
                            hourStr = '00';
                        }

                        /**/

                        attemptStr = hourStr + ':' + minStr;

                    } else if (attemptStr.contains('.')) {

                        bits = attemptStr.split('.');

                        hourStr = bits[0];

                        if (parseInt(hourStr, 10) > 24) {
                            hourStr = '24';
                        }
                        if (parseInt(hourStr, 10) < 0) {
                            hourStr = '00';
                        }

                        hourStr = hourStr.pad(2, '0', 'left');

                        /**/

                        minStr = bits[1].pad(2, '0', 'right');

                        mins = parseInt(minStr, 10);

                        if (mins > 99) {
                            mins = 0;
                        }

                        if (mins < 0) {
                            mins = 0;
                        }

                        minStr = (Math.round((60 / 100) * mins) + '').pad(2, '0', 'left');

                        /**/

                        attemptStr = hourStr + ':' + minStr;

                    } else {

                        if (attemptStr.length === 4) {

                            attemptStr = attemptStr.substring(0, 2) + ':' + attemptStr.substring(2);

                        } else if (attemptStr.length > 4) {

                            attemptStr = attemptStr.substring(0, 2) + ':' + attemptStr.substring(2, 2);

                        } else if (attemptStr.length < 4) {

                            if (attemptStr.length === 1) {
                                attemptStr = '0' + attemptStr + '00';
                            }

                            if (attemptStr.length === 2) {
                                attemptStr = attemptStr + '00';
                            }

                            if (attemptStr.length === 3) {
                                attemptStr = '0' + attemptStr;
                            }

                            attemptStr = attemptStr.substring(0, 2) + ':' + attemptStr.substring(2);

                        }

                    }

                    /* sanatise */

                    if (this.options.timeonly) {

                        var h = parseInt(attemptStr.split(':')[0], 10);
                        var m = parseInt(attemptStr.split(':')[1], 10);

                        h = h > 24 ? 0 : h;
                        m = m > 59 ? 0 : m;

                        attemptStr = (h + '').pad(2, '0', 'left') + ':' + (m + '').pad(2, '0', 'left');

                    }

                    /**/

                    try {
                        attempt = Date.parse(attemptStr);
                    } catch (ex) {
                        attempt = false;
                    }

                    if (attempt && typeOf(attempt) === 'date' && attempt.isValid()) {
                        if (this.options.timeonly && this.options.displayInput) {
                            this.options.displayInput.value = attemptStr;
                        }
                        this.setTime(attempt);
                        //this.updateUI(attempt);
                    }

                } else {

                    if (this.lastValue) {
                        this.options.displayInput.value = this.lastValue;
                    }

                }
            }

        }

        if(e && (typeOf(e) === 'object' || typeOf(e) === 'domevent') && 'type' in e && e.type === 'blur'){
            this.autoHideDelay = this.hide.delay(250, this);
        }

    },

    /**/

    destroy: function () {

        if (this.options.timeonly && this.options.displayInput) {
            this.options.displayInput.removeEvent(Affinity.events.click, this.setLastValue);
            this.options.displayInput.removeEvent('focus', this.setLastValue);
            this.options.displayInput.removeEvent('blur', this.attemptParse);
        }

        this.hourDisplay.removeEvents();
        this.minDisplay.removeEvents();
        this.ampmDisplay.removeEvents();
        this.amButton.removeEvents();
        this.pmButton.removeEvents();
        this.doneButton.removeEvents();

        this.displayTarget.set('reveal', null);
        this.displayTarget.set('tween', null);
        this.containerBox.set('reveal', null);
        this.containerBox.set('tween', null);
        this.hoursTarget.set('reveal', null);
        this.hoursTarget.set('tween', null);
        this.minutesTarget.set('reveal', null);
        this.minutesTarget.set('tween', null);

        this.hourDisplay.destroy();
        this.minDisplay.destroy();
        this.ampmDisplay.destroy();
        this.amButton.destroy();
        this.pmButton.destroy();
        this.doneButton.destroy();

        if (this.canvasOK) {
            this.canvas.destroy();
            this.canvasContext = null;
        }

        Array.each(this.hoursTarget.getElements('div'), function (element) {
            element.removeEvents();
        }.bind(this));
        this.hoursTarget.empty();
        this.hoursTarget.destroy();

        Array.each(this.minutesTarget.getElements('div'), function (element) {
            element.removeEvents();
        }.bind(this));
        this.minutesTarget.empty();
        this.minutesTarget.destroy();

        this.displayTarget.empty();
        this.displayTarget.destroy();

        Object.each(this, function (val, key) {
            this[key] = null;
            delete this[key];
        }.bind(this));

    }

});

;
var UITooltips = new Class({

    Version: '1.0.2.0',
    File: 'ui.tooltip.js',

    Implements: [Options],

    Binds: [
        'processNew',
        'init',
        'processTooltip', 'removeTooltip',
        'itemOver', 'itemOut'
    ],

    options: {
    },

    initialize: function (options) {
        this.setOptions(options);
        Affinity.UI.Tooltips = {};
        Affinity.UI.Tooltips.Process = this.processNew;
        Affinity.UI.Tooltips.Remove = this.removeTooltip;
        Affinity.UI.Tooltips.Hide = this.hideAll;
        this.init();
    },

    processNew: function () {
        this.init();
    },

    init: function () {
        if (Affinity.helpbubble) {
            Array.each(document.getElements('.ui-has-tooltip'), this.processTooltip.bind(this));
        } else {
            throw "UI Tooltips requires UI Help Bubble";
        }
    },

    processTooltip: function (el, show, addclose) {
        if (el.get('data-tooltip')) {
            if (!el.hasEvent(Affinity.events.overAll, this.itemOver)) {
                el.addEvent(Affinity.events.overAll, this.itemOver);
                el.addEvent(Affinity.events.outAll, this.itemOut);
                if(el.get('tag')==='input'){
                    el.addEvent('blur', this.itemOut);
                }
            }
            if(typeOf(show)==='boolean' && show){
                this.itemOver({ target: el });
            }
            /*
            if (typeOf(addclose) === 'boolean' && addclose) {
                Affinity.helpbubble.addClass('showclose');
            }
            */
        }
    },

    removeTooltip: function(element){
        element.removeClass('ui-has-tooltip');
        element.erase('data-tooltip');
        element.erase('data-tooltip-dir');
        element.removeEvent(Affinity.events.overAll, this.itemOver);
        element.removeEvent(Affinity.events.outAll, this.itemOut);
        if (element.get('tag') === 'input') {
            element.removeEvent('blur', this.itemOut);
        }
    },

    itemOver: function (e) {
        var button = e.target.hasClass('ui-has-tooltip') ? e.target : e.target.getParent('ui-has-tooltip');
        if (button){
            Affinity.helpbubble.populate(button.get('data-tooltip'));
            var tipsize = Affinity.helpbubble.getSize();
            if (typeOf(tipsize) === 'object' && 'y' in tipsize) {

                var direction = button.get('data-tooltip-dir') ? button.get('data-tooltip-dir').toLowerCase().trim() : 'right';

                var docsize = document.getScrollSize();
                var buttonpos = button.getPosition();
                var buttonsize = button.getSize();
                var scrollOffsets = document.getScroll();

                var arrowDirection;
                var position = { x: 0, y: 0 };

                switch (direction) {

                    case 'top':
                        arrowDirection = 'bottom';
                        position.x = buttonpos.x;
                        position.y = buttonpos.y - tipsize.y - 10;
                        break;

                    case 'bottom':
                        arrowDirection = 'top';
                        position.x = buttonpos.x;
                        position.y = buttonpos.y + tipsize.y - 5;
                        break;

                    case 'right':
                        arrowDirection = 'left';
                        position.x = buttonpos.x + buttonsize.x + 5;
                        position.y = buttonpos.y + (buttonsize.y / 2) - 20;
                        break;

                    case 'left':
                        arrowDirection = 'right';
                        position.x = buttonpos.x - tipsize.x - 5;
                        position.y = buttonpos.y + (buttonsize.y / 2) - 20;
                        break;

                    case 'top,left':
                        arrowDirection = 'bottom-right';
                        position.x = (buttonpos.x + buttonsize.x) - tipsize.x;
                        position.y = buttonpos.y - tipsize.y - 10;
                        break;

                    case 'top,right':
                        arrowDirection = 'bottom';
                        position.x = buttonpos.x;
                        position.y = buttonpos.y - tipsize.y - 10;
                        break;

                    case 'bottom,left':
                        arrowDirection = 'top-right';
                        position.x = (buttonpos.x + buttonsize.x) - tipsize.x;
                        position.y = buttonpos.y + tipsize.y;
                        break;

                    case 'bottom,right':
                        arrowDirection = 'top';
                        position.x = buttonpos.x;
                        position.y = buttonpos.y + tipsize.y;
                        break;

                    case 'top,center':
                        arrowDirection = 'bottom';
                        position.x = buttonpos.x;
                        position.y = buttonpos.y - tipsize.y - 10;
                        break;

                    case 'bottom,center':
                        arrowDirection = 'top';
                        position.x = buttonpos.x;
                        position.y = buttonpos.y + tipsize.y - 5;
                        break;

                }

                Affinity.helpbubble.setDirection(arrowDirection);

                if (position.x + tipsize.x > docsize.x) {
                    position.x = (docsize.x - tipsize.x) - 5;
                }

                if (position.y + tipsize.y > docsize.y) {
                    position.y = (docsize.y - tipsize.y) - 5;
                }

                Affinity.helpbubble.position(position);

                Affinity.helpbubble.show(button.hasClass('ui-tooltip-selectable') ? true : false);

            }

        }
        
    },

    itemOut: function () {
        Affinity.helpbubble.hide();
    },

    hideAll: function () {
        Affinity.helpbubble.hide();
    }

});;

var UIUplaoders = new Class({

    Implements: [Options],

    Binds: [
		'processUploaders',
        'setFakeLabel'
    ],

    options: {
    },

    uploaders: {

    },

    initialize: function (options) {
        this.setOptions(options);

        this.processUploaders();

    },

    processNew: function () {
        processUploaders();
    },

    processUploaders: function () {
        this.ignoreUpload = false;
        if(!document.config.prettyuploads){ return; }

        var uploaders = document.getElements('.upload');

        Array.each(uploaders, function (uploader) {

            if (!uploader.hasClass('uidone')) {

                uploader.addClass('uidone');

                var uploadInput = uploader.getElement('input');
                uploadInput.fade('hide');
            
                var label = new Element('label').inject(uploader);
                label.adopt(uploadInput);
                var button = new Element('span', {
                    'class': 'button blue',
                    'html':'Choose File'
                }).inject(label);


                var uploadLabel = new Element('span', {
                    'html': '',
                    'class': 'uploadlabel hidden'
                }).inject(label);

                var spacer = new Element('i', {
                    'html': ' ',
                    'class': ''
                }).inject(label, "after");

                if (
                    uploader.get('data-show-delete') &&
                    uploader.get('data-show-delete') == 'true'
                ) {
                    var deleteButton = new Element('span', {
                        'class': 'button red',
                        'html': 'Delete',
                    }).inject(uploader);


                    deleteButton.addEvent(Affinity.events.click, this.deleteFile);
                }


                var defaultFile = new Element('div', {
                    'html': '',
                    'class': 'currentFileLabel'
                }).inject(uploader);

                uploader.getElement('input').addEvent('change', this.setFakeLabel);

                if (uploader.getElement('input').get('data-default-file-name')) {
                    if (uploader.getElement('input').get('data-default-file-path')) {
                        defaultFile.set('html', 'Current File: ');
                        new Element('a', { 'href': uploader.getElement('input').get('data-default-file-path'), 'html': uploader.getElement('input').get('data-default-file-name') }).inject(defaultFile);
                    }else{
                        defaultFile.set('html', 'Current File: ' + uploader.getElement('input').get('data-default-file-name'));
                    }
                }
            }

        }.bind(this));

        delete button;
    },
    
    deleteFile: function (e) {
        document.getElements('.uploadlabel').set('html', "");
        document.getElements('.currentFileLabel').set('html', "");
        document.getElementById("hiddenDeleteAttachment").set('value', 'true');
        document.getElementById("files").set('value', '');
    },


    setFakeLabel: function (e) {
        var file = e.target.value;
        if(file.contains('fakepath')){ file = file.substring(e.target.value.indexOf('fakepath') + 9); }
        e.target.getParent().getLast('span').set('html', file);
    }
});;

var UIUplaodersMulti = new Class({

    Version: '1.0.0.0',
    File: 'ui.upload.multi.js',

    Implements: [Options, Events],

    Binds: [
        'processNew',
		'processUploader',
        'addFile', 'addFileCont', 'addFileRow', 'deleteFile'
    ],

    options: {
        auto: true,
        maxsize: 20971520,
        samenames: true
    },

    uploaders: {

    },

    initialize: function (options) {

        this.setOptions(options);

        this.icons = {};
        this.icons.del = Affinity.icons.CrossRound || '&#xe06d;';

        if (!Affinity.prettyuploads) { return; }

        if(this.options.auto){
            Array.each(document.getElements('.uploadmulti'), this.processUploader);
        }

    },

    processNew: function () {
        Array.each(document.getElements('.uploadmulti'), this.processUploader);
    },

    processUploader: function (uploader) {

        if (!Affinity.prettyuploads) { return; }

        if (!uploader.hasClass('uidone')) {

            uploader.store('count', 1);

            /**/

            var table = new HtmlTable({
                properties: {
                    'class': 'ui-grid'
                },
                headers: ['File', ''],
                rows: []
            });

            new Element('div', { 'class': 'upload-table hidden' }).adopt(table.element).inject(uploader);

            uploader.addClass('uidone');

            /**/

            var isrequired = uploader.hasClass('isrequired') ? true : false;

            var lebel = new Element('label').inject(uploader);

            var inputId = uploader.get('data-question-name') + '_file0';

            uploader.getElement('input').set('name', inputId).set('id', inputId).addEvent('change', this.addFile).inject(lebel).fade('hide');

            //var button = new Element('span', {
            //    'class': 'button green',
            //    'html': 'Add File'
            //}).inject(lebel);

            var button = new Element('span', {
                'class': 'button blue',
            }).adopt(
                new Element('span', {
                    'class': 'icon-add-to-list',
                }),
                new Element('span', {
                    'html': 'Add&nbsp;File'
                })
            ).inject(lebel);

            new Element('span', {
                'html': '',
                'class': 'uploadlabel'
            }).inject(lebel);

            /**/

            var initialValuesObj = uploader.getElement('.initialValues');

            if (initialValuesObj) {

                var initialValues = initialValuesObj.value.trim();

                if (initialValues !== '') {

                    var fileIds = initialValues.split(',');

                    Array.each(fileIds, function (fileId) {
                        this.addFileRow(table.element, fileId, fileId);
                    }.bind(this));

                    window.fireEvent('multiFileDefaults', { initialValues: initialValues, table: table.element });

                }
            }

            delete table;
            delete lebel;
            delete inputId;
            delete button;
            delete initialValues;

            Affinity.uiGrid.processTables(table.element);
            //Affinity.uiUplaodersMulti.processNew();

            /**/

        }

    },

    addFile: function (e) {

        e.stop();

        var data = {};

        data.uploadInput = e.target;
        data.uploader = data.uploadInput.getParent('.uploadmulti');
        data.table = data.uploader.getElement('table');
        data.questionName = data.uploader.get('data-question-name');
        data.filePath = data.uploadInput.value;
        data.fileName = data.filePath;
        data.count = data.uploader.retrieve('count') + 1;
        data.inputId = data.questionName + '_file' + data.count;
        data.fileEventData = {
            fileElement: data.uploadInput,
            questionName: data.questionName,
            table: data.table
        };

        if (data.filePath === '' || typeOf(data.filePath) == 'null') { delete data; return; }

        if (data.uploadInput.files) {
            if (data.uploadInput.files[0].size > this.options.maxsize) {
                window.fireEvent('multiFileTooLarge', { fileElement: data.uploadInput, maxsize: this.options.maxsize, size: data.uploadInput.files[0].size, table: data.table });
                data.uploadInput.value = "";
                try { delete data.uploadInput.files; } catch (e) { }
                delete data;
                return;
            }
        }

        /* clean file name */

        if (data.fileName.contains('fakepath')) { data.fileName = data.fileName.substring(data.uploadInput.value.indexOf('fakepath') + 9); }
        if (data.fileName.contains('/')) { data.fileName = data.fileName.substring(data.uploadInput.value.lastIndexOf('/') + 1); }
        if (data.fileName.contains('\\')) { data.fileName = data.fileName.substring(data.uploadInput.value.lastIndexOf('\\') + 1); }

        /**/

        var hasname = false;
        Array.each(data.table.getElements('tr'), function (row) {
            if (row.retrieve('fileName') && row.retrieve('fileName').trim() === data.fileName.trim()) {
                hasname = true;
            }
        });

        if (hasname) {
            if (!this.options.samenames) {
                uialert({
                    message: 'Filenames must be different.<br />You already have a file with name \'' + data.fileName + '\'.'
                });
                data.uploadInput.value = "";
                try { delete data.uploadInput.files; } catch (e) { }
                delete data;
                return;
            } else {
                uiconfirm({
                    message: 'You already have a file named \'' + data.fileName + '\'.<br />Would you like to continue anyway?',
                    onOk: function () {
                        this.addFileCont(e, data);
                    }.bind(this),
                    onCancel: function () {
                        data.uploadInput.value = "";
                        try { delete data.uploadInput.files; } catch (e) { }
                        delete data;
                    }.bind(this)
                });
            }
        } else {
            this.addFileCont(e, data);
        }

    },

    addFileCont: function (e, data) {

        e.stop();

        this.addFileRow(data.table, data.fileName, null, data.inputId);

        var upload = data.table.getParent('.uploadmulti');

        /**/

        //data.uploadInput.set('class', '').addClass('subhidden').addClass('should-have-file-' + data.file).set('name', data.inputId).set('id', data.inputId);
        data.uploadInput.set('class', '').addClass('subhidden').set('name', data.inputId).set('id', data.inputId).removeEvents();
        (function () {
            data.uploadInput = data.uploadInput.clone().set('name', data.questionName + '_file0').set('id', data.questionName + '_file0').set('class', '').addClass('new-master').inject(data.uploadInput, 'before').fade('hide');
            data.uploadInput.removeEvents();
            data.uploadInput.addEvent('change', this.addFile);
            data.uploadInput.value = "";
            data.uploader.store('count', data.count);

            window.fireEvent('multiFileAdded', data.fileEventData);
            upload.fireEvent('multiFileAdded', data.fileEventData);

        }).delay(50, this);

        //

        delete data;

    },

    addFileRow: function (table, fileName, fileId, inputId, fileLink) {

        var button, row;

        if (fileId !== null) {
            button = '<span class="button orange delete w-icon-only"><span>' + this.icons.del + '</span></span>';
        } else {
            button = '<span class="button orange delete new w-icon-only"><span>' + this.icons.del + '</span></span>';
        }

        table.retrieve('HtmlTable').push([fileName, button]);

        row = table.getElements('tbody tr').getLast();

        row.store('fileName', fileName);

        if (fileId !== null) {
            row.store('fileId', fileId);
            row.addEvent('click', this.downloadFile.bind(this));
            row.addClass('saved');
        }

        if (fileLink) {
            row.removeEvents();
            row.getElement('td').empty();
            new Element('a', { 'href': fileLink, 'target': '_blank', 'html': fileName }).inject(row.getElement('td'));
        }

        if (inputId !== null) {
            row.store('inputId', inputId);
        }

        row.getElements('.delete').addEvent('click', this.deleteFile);

        Affinity.uiGrid.zebra(table);

        table.getParent().removeClass('hidden');

        delete button;
        delete row;

    },

    deleteFile: function (e) {

        e.stop();

        
        var preventDeletion = false;
        var button = e.target.hasClass('button') ? e.target : e.target.getParent('.button');
        var upload = e.target.getParent('.uploadmulti');
        var row = e.target.getParent('tr');
        var table = row.getParent('table');
        var questionName = upload.get('data-question-name');
        var deletedId = false;
        if (row.retrieve('fileId')) {
            deletedId = row.retrieve('fileId');
        }

       

        if (button.hasClass('new')) {

            var inputId = row.retrieve('inputId');
            if (upload.getElement('#' + inputId)) {
                upload.getElement('#' + inputId).destroy();
            }

        } else {

            window.fireEvent('validateMultiFileDelete', { row: row, table: table, deletionTarget: { deleteName: deleteName, deletedId: deletedId, questionName: questionName, table: table } });
            upload.fireEvent('validateMultiFileDelete', { row: row, table: table, deletionTarget: { deleteName: deleteName, deletedId: deletedId, questionName: questionName, table: table } });

            preventDeletion = row.hasClass("preventDeletion");
           
            /*
            var input = table.getParent('.uploadmulti').getElement('input[type=file]');
            var inputid = input.get('id');
            var newInput = input.clone().set('id', inputid).inject(input, 'after');
            newInput.addEvent('change', this.addFile);
            input.destroy();
            */
            if (!preventDeletion) {
                
                if (row.retrieve('fileId')) {
                    deletedId = row.retrieve('fileId');
                }
                var deleteName = row.getElement('td').get('html');

                window.fireEvent('multiFileDeleted', { deleteName: deleteName, deletedId: deletedId, questionName: questionName, table: table });
                upload.fireEvent('multiFileDeleted', { deleteName: deleteName, deletedId: deletedId, questionName: questionName, table: table });

                delete deletedId;
                delete deleteName;
            }
            

        }

        if (!preventDeletion) {
            row.destroy();
            Affinity.uiGrid.zebra(table);

            if (table.getElements('tbody tr').length == 0) {
                table.getParent().addClass('hidden');
            }

            delete button;
            delete upload;
            delete row;
            delete table;
            delete questionName;
        } else {
            row.removeClass("preventDeletion");
        }
        

    },

    downloadFile: function (e) {

        e.stop();

        var target = e.target.get('tag') == 'td' ? e.target : e.target.getParent('td');

        var documentId = target.getParent('tr').retrieve('fileId');
        var downloadUrl = target.getParent('tr').retrieve('dowloadUrl');

        if (documentId && downloadUrl) {
            window.open(downloadUrl + '?documentId=' + documentId, '_blank');
        }
    },
    setMaxSize: function (maxSize) {
        this.options.maxsize = maxSize;
    },
    reset: function (mixed) {

        var uploadBox = false;
        var uploadInput = false;

        /*
        if (typeOf(uploader) === 'element' && uploader.get('type') && (uploader.get('type') === 'input' || uploader.get('type') === 'file')) {
            uploadInput = uploader;
            uploader = uploadInput.getParent('.uploadmulti');
        }

        if (uploader.hasClass('uploadmulti')) {
            uploadInput = uploader.getElement('label input');
        }
        */

        if (typeOf(mixed) === 'element') {
            if (mixed.hasClass('uploadmulti')) {
                uploadBox = mixed;
            }
            if (typeOf(mixed) === 'element' && mixed.get('type') && (mixed.get('type') === 'input' || mixed.get('type') === 'file')) {
                uploadBox = mixed.getParent('.uploadmulti');
            }
        }

        if (uploadBox && uploadBox.getElement('label input')) {
            uploadInput = uploadBox.getElement('label input');
        }

        if (uploadBox) {
            var table = uploadBox.getElement('table');
            var questionName = uploadBox.get('data-question-name');
            Array.each(uploadBox.getElements('label input'), function (input) {
                if (input !== uploadInput) {
                    input.destroy();
                }
            });
            uploadBox.store('count', 1);
            if (uploadInput) {
                uploadInput.set('name', questionName + '_file0').set('id', questionName + '_file0').set('class', null).set('type', 'file').removeEvents().addEvent('change', this.addFile.bind(this)).fade('hide');
                uploadInput.value = '';
                if ('files' in uploadInput) {
                    try{
                        uploadInput.files = [];
                    }catch(e){}
                }
            }
            table.getElement('tbody').empty();
            table.getParent().addClass('hidden');
        }

    }

});
;
/*                                                                                  *
 * This script belongs to the ui (user interface) package.                          *
 *                                                                                  *
 * The following code assumes MooTools Core 1.4.5 has been included.                *
 *                                                                                  */
/**
 * @class UIValidation
 *
 * Searches for data-validation attributes and sets up appropriate high level validation.
 * Class looks for class values of 'validate' on form elements.
 * Class looks for data elements:
 * data-validate-error-str = String - String to display to the user on validation failure
 * data-validate-method = String - One or more validation method. Defines validation method.
 * Validation method are: hasvalue, alpha, numeric, alphanumeric, length, email, linked,
 * date, checked
 * (checked is reserved for radios and checkboxes)
 * (if data-validate-method includes length) data-validate-length = Number - Min number of
 * characters
 * (if data-validate-method includes linked) data-validate-link = String - Id of another
 * element that must pass validation for this to pass. If link is a readio, checkbox or
 * select, providing a link makes this only required if user has set the linked element.
 *
 */
var UIValidation = new Class({

    Version: '1.0.2.0',
    File: 'ui.validation.js',
    Notes: 'API Structure change',

    initialize: function(options) {
        if (typeOf(options) === 'object' && (typeOf(options.target) == 'element' || typeOf(options.target) == 'form')) {
            return new UIFormValidation(options);
        } else {
            this.processNew();
        }
    },

    processNew: function() {
        Array.each(document.getElements('form.validate-form'), function(form) {
            if (!form.retrieve('validation')) {
                new UIFormValidation({
                    target: form
                });
            }
        }.bind(this));
    }

});

var UIFormValidation = new Class({

    Implements: [Options],

    Binds: [
        'disable', 'enable',
        'ignoreRequired', 'doRequired',
        'submitButtonMouseDown',
        'validateForm', 'validate',
        'processForm', 'validateForm', 'processErrors', 'validateElement', 'processError',
        'validateHasvalue',
        'validateSentence',
        'validateString',
        'validateNumber',
        'validateInt',
        'validateFloat',
        'validateCurrency',
        'validateEmail',
        'validateChecked',
        'validateMultiChecked',
        'validateRadioSelected',
        'validateLength',
        'validateRange',
        'validateDate',
        'validateLinked',
        'validateNomatch',
        'validateUrl',
        'validateFile',
        'checkNum',
        'validateBankNumber',
        'validateTaxCode',
        'validateTaxNumber',
        'validateTaxNumberCountry',
        'validateBankNumberCountry'
    ],

    options: {
        target: null,
        onPost: null,
        onValidateCallback: null,
        onValidateFailCallback: null
    },

    approvedElements: [
        'input',
        'textarea',
        'select'
    ],

    approvedValidations: [
        'file',
        'banknumber',
        'bankNumber',
        'taxcode',
        'taxnumber',
        'taxNumber'
    ],

    initialize: function(options) {
        this.setOptions(options);
        if (this.options.target.retrieve('validation')) {
            this.options.target.retrieve('validation').destroy();
        }
        this.options.target.store('validation', this);
        this.options.target.addEvent('submit', this.validateForm);

        Array.each(this.options.target.getElements('*[type="submit"]'), function(submitButton) {
            submitButton.addEvent(Affinity.events.start, this.submitButtonMouseDown);
        }.bind(this));

        this.taxValidationRequests = {};
        this.banknumValidationRequests = {};
    },

    ignoreHasValue: false,
    disaabled: false,
    disable: function() {
        this.disaabled = true;
    },
    enable: function() {
        this.disaabled = false;
    },
    ignoreRequired: function() {
        this.ignoreHasValue = true;
    },
    doRequired: function() {
        this.ignoreHasValue = false;
    },

    destroy: function() {
        this.options.target.removeEvent('submit', this.validateForm);
        this.options.target.eliminate('validation');
        this.options = null;
    },

    submitButtonMouseDown: function(e) {
        var button = e.target.hasClass('.button') ? e.target :
            e.target.get('tag') === 'button' ? e.target :
            e.target.getParent('.button') ? e.target.getParent('.button') :
            e.target.getParent('button') ? e.target.getParent('button') :
            false;
        this.ignoreHasValue = false;
        if (button && button.hasClass('ignore-required')) {
            this.ignoreHasValue = true;
        }
    },

    validateForm: function(e) {
        if (!this.disaabled) {
            e.preventDefault();
            e.stopPropagation();
            e.stop();
            this.validate();
        }
    },

    validate: function() {

        if (this.options.target === null) {
            throw ("Can not validate on no form");
            return;
        }

        document.getElements('.error').removeClass('error');
        document.getElements('.errorstr').destroy();

        if (this.options.onPost && typeOf(this.options.onPost) === 'function') {
            this.options.onPost();
        }

        this.errors = [];

        Array.each(this.options.target.getElements('.validate'), this.validateElement);

        document.getElements('.validated').removeClass('validated');

        if (this.errors.length > 0) {
            this.processErrors();
        } else {
            if (this.options.onValidateCallback && typeOf(this.options.onValidateCallback) == 'function') {
                this.options.onValidateCallback();
            } else {
                this.options.target.submit();
            }
        }

    },

    processErrors: function() {
        var target;
        Array.each(this.errors, function(error, index) {
            target = error[0];
            if (this.approvedElements.contains(target.get('tag'))) {
                target.addClass('error');
            }
            if (error[0].getPrevious('label')) {
                target = error[0].getPrevious('label');
            }
            if (error[0].getParent().hasClass('currencybox')) {
                target = error[0].getParent().getPrevious('label');
            }
            if (error[0].getParent().hasClass('countryselector')) {
                target = error[0].getParent().getPrevious('label');
            }
            if (error[0].getParent().hasClass('subhidden')) {
                target = error[0].getParent().getPrevious('label');
            }
            // TODO: Ben? Use this.getChild('label') rather then looking in parent.
            // If there is no child, we must be currencybox or countryselector, ect, so try recursive parents until we find the correct label element.
            // OR, go back to form-row if exists as parent, then get FIRST label (getElements('label')[0])
            new Element('div', {
                'class': 'errorstr',
                'html': error[1]
            }).inject(target, 'before');
            if (error[0].getParent('.form-row')) {
                error[0].getParent('.form-row').removeClass('valid').addClass('invalid');
            }
        }.bind(this));
        if (this.options.onValidateFailCallback && typeOf(this.options.onValidateFailCallback) == 'function') {
            this.options.onValidateFailCallback(this.errors);
        }
        delete target;
    },

    processError: function(errorStr, el) {
        if (el.getAttribute('data-validate-error-str')) {
            errorStr = errorStr + '<br />' + el.getAttribute('data-validate-error-str');
        }
        if (el.get('data-display-id')) {
            el = document.id(el.get('data-display-id'));
        }
        if (!this.errors.contains([el, errorStr])) {
            this.errors.push([el, errorStr]);
        }
    },

    validateElement: function(el, index) {
        if (el.getAttribute('data-validate-method')) {
            if (this.approvedElements.contains(el.get('tag')) || this.approvedValidations.contains(el.get('data-validate-method'))) {
                var functionName, functionExists;
                var methods = el.getAttribute('data-validate-method').split(',');
                Array.each(methods, function(method, index) {
                    functionName = 'validate' + method.capitalize();
                    functionExists = typeOf(this[functionName]) == 'function' ? true : false;
                    if (functionExists) {
                        if (el.getParent('.form-row')) {
                            el.getParent('.form-row').removeClass('invalid').addClass('valid');
                        }

                        if (functionName === 'validateTaxNumber' || functionName === 'validateBankNumber') {
                            // bypass validation (no client error shown. TODO: Add error message in Gen2 )
                        } else {
                            this[functionName](el);
                        }

                    }
                }.bind(this));
            }
        }
    },

    validateHasvalue: function(el) { // Not blank
        if (this.ignoreHasValue) {
            return;
        }
        if (typeOf(el) == 'element') {
            if (el.hasClass('hidden')) {
                return;
            }
            if (typeOf(el.value) !== 'null') {
                if (el.value != '' && el.value.trim() !== '') {
                    return;
                } else {
                    this.processError('This must have a value', el);
                }
            } else {
                // input has no value
            }
        }
    },
    validateSentence: function(el) { // a-b A-B 0-9 _ - . , : ; ( ) ? $ * % @ # ! ' " \ / | whitespace
        var pattern = /^[a-zA-Z0-9_\-.,:;'\"!?@#$%\*\/\\|()\s]*$/g;
        var re = new RegExp(pattern);
        if (el.value.length > 0) {
            if (!re.test(el.value)) {
                var max = 255;
                max = el.getAttribute('data-validate-length') ? el.getAttribute('data-validate-length') : max;
                max = el.getAttribute('data-validate-max') ? el.getAttribute('data-validate-max') : max;
                max = parseInt(max) || 255;
                if (el.value.length > max) {
                    this.processError('The text is too large. The maximum length allowed is 255 characters.', el);
                } else {
                    this.processError('Some of the symbols used are invalid (ok symbols: . , _ - ; : ( ) ? $ * % @ # ! \\ \' " )', el);
                }
            }
        }
    },
    validateString: function(el) { // a-b A-B 0-9 _ - . ,
        var pattern = /^[A-Za-z0-9_\-.]+$/g;
        var re = new RegExp(pattern);
        if (el.value.length > 0) {
            if (!re.test(el.value)) {
                this.processError('This may not have spaces and can only have numbers, letters and some symbols (ok symbols: _ - . )', el);
            }
        }
    },
    validateNumber: function(el) { // 0-9 . , I don't think validateNumber is being used currently (12.10.2015)?
        var max = 2147483647;
        var pattern = /^[-+]?[0-9,.]+$/g;
        var re = new RegExp(pattern);
        if (el.value.length > 0) {
            if (parseInt(el.value.replace(/[^0-9.]/g, '')) > max) {
                this.processError('Number values can be no greater than ' + max, el);
                return;
            }
            if (!re.test(el.value)) {
                this.processError('This must only be numbers and may have commas and points', el);
            }
        }
    },
    validateInt: function(el) { // 0-9
        var max = 2147483647;
        var min = -2147483647;
        var pattern = /^[-+]?[0-9]+$/g;
        var re = new RegExp(pattern);
        if (el.value.length > 0) {
            if (parseInt(el.value) > max) {
                this.processError('Int values can be no greater than ' + max, el);
                return;
            }
            if (parseInt(el.value) < min) {
                this.processError('Int values can be no smaller than ' + min, el);
                return;
            }
            if (!re.test(el.value)) {
                this.processError('This must be an integer value', el);
            }
        }
    },
    validateFloat: function(el) {
        var max = 2147483647;
        var min = -2147483647;
        var pattern = /^[-+]?[0-9]*\.?[0-9]+$/g;
        var re = new RegExp(pattern);
        if (el.value.length > 0) {
            if (parseFloat(el.value) > max) {
                this.processError('Float values can be no greater than ' + max, el);
                return;
            }
            if (parseFloat(el.value) < min) {
                this.processError('Float values can be no smaller than ' + min, el);
                return;
            }
            if (!re.test(el.value)) {
                this.processError('This must be a float value with maximum 5 decimal places', el);
            }
        }
    },
    validateAlphanumeric: function(el) {
        var pattern = /^[a-zA-Z0-9_\-.,:'!?$%\*\/\\|\s]+$/g;
        var re = new RegExp(pattern);
        if (el.value.length > 0) {
            if (el.value.replace(/[^a-zA-Z]+/g, '') === '') {
                this.processError('This must have letters', el);
                return;
            }
            if (!re.test(el.value)) {
                this.processError('This must have letters and can have numbers, spaces and some symbols . , _ - : ? $ * % ! \\ / \' |', el);
            }
        }
    },
    validateCurrency: function(el) {
        var max = 2147483647;
        var min = -2147483647;
        var pattern = /^\-?[0-9]{1,3}(?:[0-9]*(?:[.,][0-9]{1,5})?|(?:,[0-9]{3})*(?:\.[0-9]{1,5})?|(?:\.[0-9]{3})*(?:,[0-9]{1,5})?)$/g;
        var re = new RegExp(pattern);
        el.value = el.value.replace(/\$|\s/gi, '');
        if (el.value.length > 0) {
            if (parseFloat(el.value.replace(/[^0-9.]/g, '')) > max) {
                this.processError('Currency values can be no greater than ' + max, el);
                return;
            }
            if (parseFloat(el.value.replace(/[^0-9.-]/g, '')) < min) {
                this.processError('Currency values can be no smaller than ' + min, el);
                return;
            }
            if (!re.test(el.value)) {
                this.processError('This must be a valid currency value (without the currency symbol). Eg:<br />123,456,789.12<br />OR<br />123456789.12<br />Mind your commas and decimals!<br />Up to 5 decimal places is permitted.', el);
            }
        }
    },
    validateEmail: function(el) { // basic check only
        var pattern = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        var re = new RegExp(pattern);
        if (el.value.length > 0) {
            if (!re.test(el.value)) {
                this.processError('This must be a valid email address', el);
            }
        }
    },
    validateChecked: function(el) { // checkboxes is checked
        if (this.ignoreHasValue) { //(Zoho#31232)Save button is clicked, allow empty input
            return;
        }
        if (el.get('type') == 'checkbox' && !el.checked) {
            this.processError('This must be checked', el);
        }
    },
    validateMultiChecked: function(el) { // one of many checkboxes is checked
        if (this.ignoreHasValue) { //(Zoho#31232)Save button is clicked, allow empty input
            return;
        }
        if (!el.hasClass('validated') && el.get('type') == 'checkbox' && el.get('data-validation-multicheck-id')) {
            if (!el.checked) {
                checked = false;
                Array.each(el.getParents('form')[0].getElements('input[type=checkbox]'), function(cb) {
                    if (cb.get('data-validation-multicheck-id') == el.get('data-validation-multicheck-id') && cb.checked) {
                        checked = true;
                    }
                    cb.addClass('validated');
                }.bind(this));
                if (checked == false) {
                    this.processError('One of these must be checked', el);
                }
            }
        }
    },
    validateRadioSelected: function(el) {
        if (this.ignoreHasValue) { //(Zoho#31232)Save button is clicked, allow empty input
            return;
        }
        if (!el.hasClass('validated') && el.get('type') == 'radio' && el.get('name')) {
            if (!el.checked) {
                checked = false;
                Array.each(el.getParents('form')[0].getElements('input[name=' + el.get('name') + ']'), function(rb) {
                    if (rb.checked) {
                        checked = true;
                    }
                    rb.addClass('validated');
                }.bind(this));
                if (checked == false) {
                    this.processError('One of these must be selected', el);
                }
            }
        }
    },
    validateLength: function(el) {
        if (el.value.length > 0) {
            var length = el.getAttribute('data-validate-length') ? el.getAttribute('data-validate-length') : false;
            var max = el.getAttribute('data-validate-max') ? el.getAttribute('data-validate-max') : false;
            var min = el.getAttribute('data-validate-min') ? el.getAttribute('data-validate-min') : false;
            // check for min length
            if (min && el.value.length < parseInt(min)) {
                this.processError('This must be longer than ' + min + 'character(s)', el);
            }
            // check for max length
            if (max && el.value.length > parseInt(max)) {
                this.processError('This must be shorter than ' + max + ' character(s)', el);
            }
            // check for min length from length (old version of min)
            if (length && el.value.length < parseInt(length)) {
                this.processError('This must be at least ' + length + ' character(s)', el);
            }
        }
    },
    validateRange: function(el) {
        if (el.value.length > 0) {
            var max = el.getAttribute('data-validate-max') ? el.getAttribute('data-validate-max') : false;
            var min = el.getAttribute('data-validate-min') ? el.getAttribute('data-validate-min') : false;
            if (isNaN(el.value)) {
                this.processError('This must be a number', el);
                return;
            }
            if (max && parseFloat(el.value) > parseFloat(max)) {
                this.processError('This must be less than or equal to ' + max, el);
            }
            if (min && parseFloat(el.value) < parseFloat(min)) {
                this.processError('This must be greater than or equal to ' + min, el);
            }
        }
    },
    validateDate: function(el) {
        if (el.value.length > 0) {
            if (!Date.parse(el.value).isValid()) {
                this.processError('This must be a valid date', el);
            }
        }
    },
    validateLinked: function(el) {

    },
    validateNomatch: function(el) {
        var compareThis,
            withThat,
            thatLabel,
            form = el.getParent('.default-form');
        if (el.get('data-validate-match') && form.getElement('.' + el.get('data-validate-match'))) {
            compareThis = el.value;
            withThat = form.getElement('.' + el.get('data-validate-match')).value;
            thatLabel = form.getElement('.' + el.get('data-validate-match')).getParent('.form-row').getElement('label');
            if (compareThis === withThat) {
                this.processError('This must not match ' + thatLabel.get('html').stripTags(), el);
            }
        }

    },
    validateUrl: function (el) {
        if (el.value.startsWith('mailto:')) {
            el.value = el.value.substring(7);
            this.validateEmail(el);
            el.value = 'mailto:' + el.value;
            return;
        }
        var pattern = /(http|ftp|https|ftps):\/\/+([\w.,@?^=%&:\/~+#-]*[\w@?^=%&\/~+#-])?/;
        var re = new RegExp(pattern);
        if (el.value.length > 0) {
            if (!re.test(el.value)) {
                this.processError('This must be a valid URL (try adding http:// to the start of the url)', el);
            }
        }
    },
    validateFile: function (el) {
        if (this.ignoreHasValue) {
            return;
        }

        var hasFile = false;
        var i;
        if (typeOf(el) == 'element') {
            var files = el.getElements('input[type=file]');
            if (files.length > 0) {
                for (i = 0; i < files.length; i++) {
                    if (files[i].value !== '') {
                        hasFile = true;
                        break;
                    }
                }
            }
            var initialValues = el.getElements('input.initialValues');
            try {
                if (initialValues) {
                    if (typeOf(initialValues) === 'string') {
                        if (initialValues.trim() !== '') {
                            hasFile = true;
                        }
                    } else {
                        if (initialValues.length > 0) {
                            for (i = 0; i < initialValues.length; i++) {
                                if (initialValues[i].value !== null && initialValues[i].value !== '') {
                                    hasFile = true;
                                    break;
                                }
                            }
                        }
                    }
                }
            } catch (e) {}
        }
        if (hasFile) {
            return;
        }
        this.processError('You must upload a file', el);
    },
    checkNum: function(num) {
        if (isNaN(num)) {
            return false;
        }
    },
    validateBankNumber: function(el, countryCode, key) {
        if (this.ignoreHasValue) {
            return;
        }

        var request = this.banknumValidationRequests[key];
        if (request && request.isRunning()) {
            request.cancel();
        }

        this.banknumValidationRequests[key] = new Request.JSON({
            url: Affinity.zelosroot + '/ValidateBankNumber',
            method: 'post',
            onSuccess: function(result) {
                if ('success' in result && result.success) {
                    window.fireEvent('bankValidationSuccess');
                } else {
                    window.fireEvent('bankValidationError');
                }
                window.fireEvent('bankValidationReturned', {
                    el: el,
                    data: result
                });
            },
            onError: function() {
                window.fireEvent('bankValidationError');
            },
            onFailure: function() {
                window.fireEvent('bankValidationError');
            }
        }).post({
            BankNumber: el.value,
            CountryCode: countryCode
        });
    },
    validateTaxNumberCountry: function (el) {
        if (this.ignoreHasValue) {
            return;
        }
        if (el.value.trim() === '') {
            this.processError('You must select a country', el);
            return false;
        }
    },
    validateBankNumberCountry: function (el) {
        if (this.ignoreHasValue) {
            return;
        }
        if (el.value.trim() === '') {
            this.processError('You must select a country', el);
            return false;
        }
    },
    validateTaxNumber: function (el, countryCode, key) {
        if (this.ignoreHasValue) {
            return;
        }
        var request = this.taxValidationRequests[key];
        if (request && request.isRunning()) {
            request.cancel();
        }

        this.taxValidationRequests[key] = new Request.JSON({
            url: Affinity.zelosroot + '/ValidateTaxNumber',
            method: 'post',
            onSuccess: function(result) {
                if ('success' in result && result.success) {
                    window.fireEvent('taxValidationSuccess');
                } else {
                    window.fireEvent('taxValidationError');
                }
                window.fireEvent('taxValidationReturned', {
                    el: el,
                    data: result
                });
            },
            onError: function ()
            {
                window.fireEvent('taxValidationError');
            },
            onFailure: function ()
            {
                window.fireEvent('taxValidationError');
            }
        }).post({
            TaxNumber: el.value,
            CountryCode: countryCode
        });
    },
    validateText: function(el) {
        var pattern = /^[a-zA-Z0-9_\-.,;'\"!?@#$\\|()\s]*$/g;
        var re = new RegExp(pattern);
        if (el.value.length > 0) {
            if (!re.test(el.value)) {
                var max = 255;
                max = el.getAttribute('data-validate-length') ? el.getAttribute('data-validate-length') : max;
                max = el.getAttribute('data-validate-max') ? el.getAttribute('data-validate-max') : max;
                max = parseInt(max) || 255;
                if (el.value.length > max) {
                    this.processError('The text is too large. The maximum length allowed is 255 characters.', el);
                } else {
                    this.processError('You can only use these symbols: . , _ - ; ( ) ? $ @ # ! \\ \' "', el);
                }
            }
        }
    }
});
;

var CFContentsTable = new Class({

    Implements: [Options],

    Binds: [
        'processSection'
    ],

    options: {
    },

    initialize: function (options) {

        new Element('a', { 'name': '#top' }).inject(document.body, 'top');

        Array.each(document.getElements('.cf-contents-table.hidden'), function (tableofcontents) {

            new CFContentsTableComponent({
                element: tableofcontents
            });

        });

    }

});

var CFContentsTableComponent = new Class({

    Implements: [Options],

    Binds: [
        'processSection'
    ],

    options: {
        element: null
    },

    initialize: function (options) {

        this.setOptions(options);

        this.element = this.options.element;

        this.element.removeClass('hidden');

        this.sectionlist = this.element.getElement('ul');

        this.allrows = document.getElements('.form-row, .title-row');

        this.rowindex = this.allrows.indexOf(this.element);

        Array.each(document.getElements('.section'), this.processSection);
        
    },

    cleanName: function(name){
        name = name.stripTags('span', true).stripTags('div', true).stripTags('a', true).trim();
        if(name.charAt(name.length-1)===':'){
            name = name.substring(0, name.length - 1);
        }
        return name;
    },


    processSection: function (section) {

        var rowindex, name, list, label;

        var rows = section.getElements('.form-row, .title-row');

        if (rows.length > 0) {

            Array.each(rows, function (el, index) {

                rowindex = this.allrows.indexOf(el);

                if (rowindex > this.rowindex) {

                    name = String.uniqueID();

                    if (el.hasClass('title-row')) {

                        if (list == null) {
                            list = new Element('ul');
                        }

                        new Element('a', { 'html': 'Top', 'href': '#top', 'class': 'anchor' }).inject(el);
                        new Element('a', { 'name': name }).inject(el, 'top');

                        list.adopt(
                            new Element('a', { 'href': '#' + name, 'class': 'ui-contents-title' }).adopt(
                                new Element('li', { 'html': this.cleanName(el.get('html')) })
                            )
                        );

                    }

                    if (el.hasClass('form-row')) {

                        label = el.getElement('label,.label');

                        if (label && !label.hasClass('checkbox') && !label.hasClass('radio')) {

                            if (list == null) {
                                list = new Element('ul');
                            }

                            //new Element('a', { 'html': 'Top', 'href': '#top', 'class': 'anchor' }).inject(el, 'bottom');
                            new Element('a', { 'name': name }).inject(el, 'top');

                            list.adopt(
                                new Element('a', { 'href': '#' + name }).adopt(
                                    new Element('li', { 'html': this.cleanName(label.get('html')) })
                                )
                            );

                        }

                    }

                }

            }.bind(this));

            if(list != null){

                name = String.uniqueID();

                this.sectionlist.adopt(
                    new Element('li').adopt(
                        new Element('a', { 'href': '#' + name, 'class': 'ui-contents-section-title' }).adopt(
                            new Element('li', { 'html': section.getElement('.section-header span').get('html') })
                        ),
                        list
                    )
                );

                new Element('a', { 'html': 'Top', 'href': '#top', 'class': 'anchor' }).inject(section.getElement('.section-header'));
                new Element('a', { 'name': name }).inject(section.getElement('.section-header'));

            }

        }


        delete rowindex;
        delete list;
        delete name;
        delete label;
        delete rows;

    }


});;
var CFFormEdit = new Class({

    Implements: [Options],

    Binds: [
        'init', 'initConitnue',
        'onPost', 'validationFailed',
        'taxValidationFail', 'taxValidationSuccess',
        'bankValidationSuccess', 'bankValidationFail'
    ],

    options: {
        instanceId: '',
        addFileApi: '',
        deleteFileApi: '',
        getFileNamesApi: '',
        downloadFileApi: '',
        earlyFileData: []
    },

    taxFail: false,
    bankFail: false,
    done: false,

    initialize: function (options)
    {
        this.setOptions(options);

        this.fileData = this.options.earlyFileData;
        var earlyFileGet = function (data)
        {
            if (this.fileData.filter(function (x) { return x.initialValues === data.initialValues }).length === 0)
            {
                this.fileData.push(data);
                if (this.done)
                {
                    window.fireEvent('multiFileDefaults', data);
                }
            }
        }.bind(this);
        window.addEvent('multiFileDefaults', earlyFileGet);

        if (Affinity.pageReady) this.init();
        window.addEvent('PageReady', this.init);
    },

    init: function ()
    {
        window.removeEvent('PageReady', this.init);
        this.checkFormTimer = null;
        this.formCheck = function ()
        {
          clearTimeout(this.checkFormTimer);
          if (document.querySelector('form')) this.initConitnue();
          else this.checkFormTimer = setTimeout(this.formCheck, 100);
        }.bind(this);
        this.formCheck();
    },

    initConitnue: function ()
    {
        this.form = document.querySelector('form');
        this.formMethod = this.form && this.form.hasAttribute('method') ? this.form.getAttribute('method').toLowerCase() : '';
        this.formAction = this.form && this.form.hasAttribute('action') ? this.form.getAttribute('action').toLowerCase() : '';

        this.buttons = this.form.getElement('.buttons');

        this.loader = new Element('div', { 'class': 'formloader hidden' }).adopt(
            new Element('span', { 'html': '<img src="' + document.config.loaders.light + '" />&nbsp;' }),
            new Element('span', { 'html': 'Processing...' })
        ).inject(this.buttons, 'after');

        this.errorScroll = new Fx.Scroll(window);

        window.addEvent('taxValidationError', this.taxValidationFail);
        window.addEvent('taxValidationSuccess', this.taxValidationSuccess);

        window.addEvent('bankValidationError', this.bankValidationFail);
        window.addEvent('bankValidationSuccess', this.bankValidationSuccess);
      
        this.validation = new UIValidation({
            target: this.form,
            onPost: this.onPost,
            onValidateFailCallback: this.validationFailed.bind(this),
            onValidateCallback: this.submit.bind(this)
        });

        /*
        * We need to check if the user has emptied a value when it was not
        * previously empty so we can send 'NULL' to the database
        */
        Array.each(document.getElements('input[type=text],button[type=password],textarea'), function (input) {
            if (input.value != '' || input.value == 'NULL') {
                input.addClass('isnullable');
                input.addEvent('blur', function (e) {
                    if (this.value == '') {
                        this.addClass('isnull');
                    } else {
                        this.removeClass('isnull');
                    }
                });
                if (this.value == 'NULL') {
                    this.value = '';
                    this.addClass('isnull');
                }
            }
        }.bind(this));

        /*
        * We need to replace the form input submits with span style 'buttons'.
        * From submit button values need to be posted with the form, however, forms 
        * submitted by JS in IE and Firefox do not pass these submit values.
        * This way we can set the submitType from the non posting span buttons in the JS.
        */
        var newel, attributes;
        this.submitvalue = new Element('input', { 'type': 'hidden' }).inject(document.getElement('form'));
        Array.each(document.getElements('input[type=submit],button[type=submit]'), function (input) {
            this.submitvalue.set('name', input.name);
            newel = new Element('span', { 'data-value': input.get('value'), 'html': input.get('html') }).addEvent(Affinity.events.click, function (e) {
                var target = e.target;
                this.submitvalue.value = target.get('data-value') ? target.get('data-value') : target.getParent('span').get('data-value');
                this.buttons.addClass('hidden');
                this.loader.removeClass('hidden');
                if (this.submitvalue.value == "Save Form") {
                    this.validation.ignoreRequired();
                    this.validation.validate();
                } else {
                    this.validation.doRequired();
                    this.validation.validate();
                }
            }.bind(this)).inject(input, 'after');
            attributes = input.getProperties('id', 'class', 'name', 'data-tooltip', 'data-tooltip-dir');
            input.destroy();
            newel.setProperties(attributes);
            newel.addClass('button');
        }.bind(this));
        delete newel;
        delete attributes;
        /**/

        /*
        * Check if we have a Table of Contents element
        */
        new CFContentsTable();

        /**/

        window.addEvent('UiReady', function () {

            window.fireEvent('ResizeFrame');
            (function () {
                window.fireEvent('ResizeFrame');
            }).delay(500); // allow for section hide / show animations

        });

        /*
        * Loop through all milti file uploads so we can use the CFMultiUpload
        * class to handle file add and delete
        */

        if (!(Affinity && Affinity.hasOwnProperty('Uplaoders')))
        {
            Affinity.Uplaoders = new UIUplaodersMulti();
        }
        var nodes = document.querySelectorAll('.uploadmulti:not(.uidone)');
        if (nodes.length > 0)
        {
            Affinity.Uplaoders.processNew();
        }

        if (Affinity && Affinity.hasOwnProperty('Uplaoders'))
        {
            var nodes = document.querySelectorAll('.uploadmulti:not(.uidone)');
            if (nodes.length > 0)
            {
                Affinity.Uplaoders.processNew();
            }
        }

        new CFMulitFileUploaders({
            instanceId: this.options.instanceId,
            addApi: this.options.addFileApi,
            deleteApi: this.options.deleteFileApi,
            getNamesApi: this.options.getFileNamesApi,
            downloadFileApi: this.options.downloadFileApi
        });
        if (this.fileData.length > 0)
        {
            for (var f = 0; f < this.fileData.length; f++)
            {
                window.fireEvent('multiFileDefaults', this.fileData[f]);
            }
        }

        /**/

        if (Affinity.banknumber) Affinity.banknumber.processNew();
        if (Affinity.taxnumber) Affinity.taxnumber.processNew();

        /**/

        this.done = true;
    },

    onPost: function () {
        document.getElements('.upload-table .notsaved').removeClass('notsaved');
        this.buttons.addClass('hidden');
        this.loader.removeClass('hidden');
    },

    validationFailed: function () {
        (function () {
            this.buttons.removeClass('hidden');
            this.loader.addClass('hidden');
            this.errorScroll.toElement(document.getElement('.errorstr').getParent('.form-row'));
        }).delay(1000, this);
    },

    submit: function () {

        var running = false;

        Array.each(Affinity.UI.lookupLoaders, function (lookup) {
            running = running || lookup.running;
        }.bind(this));

        if (running) {
            uialert({
                message: 'You can\'t save or submit until all fields that auto-load data into the form have finished loading.',
                showButtons: true
            });

            this.buttons.removeClass('hidden');
            this.loader.addClass('hidden');
            return;
        }

        var message = 'Click OK to submit this form instance.';

        var isMyDetails = Affinity.app === 'MyDetails';
        if (isMyDetails) {
            message = 'OK, got that. Your changes will be visible soon. Check back later.';
        } else if (this.submitvalue.value === 'Save Form') {
            message = 'Your form will be saved for later editing, but will not be submitted.';
        }

        uialert({
            message: message,
            okText: 'Ok',
            cancelText: 'Cancel',
            showCancel: !isMyDetails,
            onOk: function () {
                this.loader.removeClass('hidden');
                this.form.submit();
            }.bind(this),
            onCancel: function () {
                this.buttons.removeClass('hidden');
                this.loader.addClass('hidden');
            }.bind(this)
        });
    },

    taxValidationFail: function (ev) {
        this.taxFail = true;
    },

    taxValidationSuccess: function () {
        this.taxFail = false;
    },

    bankValidationFail: function (ev) {
        this.bankFail = true;
    },

    bankValidationSuccess: function () {
        this.bankFail = false;
    }

});;

var CFFormTemplateCreate = new Class({
    
    Implements: [Options, Events],

    Binds: [
        'areaSuccess', 'areaChanged','categorySuccess'
    ],

    options: {
        getAreaApi: '',
        getCategoryApi: ''
    },

    initialize: function (options) {
        this.setOptions(options);

        new CFNameCreator({
            nameInput: document.getElement('#name'),
            fromInput: document.getElement('#desc')
        });

        this.areaDrop = document.id('cleverformAreaDrop');
        this.categoryDrop = document.id('cleverformCategoryDrop');

        if (this.areaDrop && this.categoryDrop) {
            this.areaDrop.addEvent('change', this.areaChanged);

            this.areaRequest = new CFRequest.JSON({
                url: this.options.getAreaApi,
                onSuccess: this.areaSuccess
            }).send();

            this.categoryRequest = new CFRequest.JSON({
                url: this.options.getCategoryApi,
                onSuccess: this.categorySuccess
            });
        }

        /**/

        window.fireEvent('ResizeFrame');

    },

    areaChanged: function (e) {
        
        this.categoryRequest.get({
            'area': this.areaDrop.value
        });

    },

    areaSuccess: function (jsonData) {

        var defaultValue = document.id('cleverformAreaDrop').get('data-default-value');
        var opt;
        var hasDefault = false;
        Array.each(jsonData, function (data) {
            opt = new Element('option', { 'html': data, 'value': data });
            if (data == defaultValue) {
                opt.set('selected', 'selected');
                hasDefault = true;
            }
            this.areaDrop.adopt(
                opt
            );
        }.bind(this));
        //If a default value was found, then trigger the onchange event to reflect this value and populate category dropdown.
        if (hasDefault) {
            this.areaDrop.fireEvent('change');
        }
        delete defaultValue;
        delete opt;
        delete hasDefault;
    },


    categorySuccess: function (jsonData) {
        var defaultValue = document.id('cleverformCategoryDrop').get('data-default-value');
        var opt;
        this.categoryDrop.empty();
        this.categoryDrop.adopt(
            new Element('option', { 'html': 'Make a selection', 'value': '' })
        );

        Array.each(jsonData, function (data) {
            opt = new Element('option', { 'html': data, 'value': data });
            if (data == defaultValue) {
                opt.set('selected', 'selected');
            }
            this.categoryDrop.adopt(
                opt
            );

        }.bind(this));

        this.categoryDrop.removeClass('hidden');
        delete defaultValue;
        delete opt;
    }
   
});;
/*                                                                                  *
 * This script belongs to the cf (CleverForms) package.                             *
 *                                                                                  *
 * The following code assumes MooTools Core 1.4.5 has been included.                *
 *                                                                                  */


/**
 * @class CFFormTemplateEdit
 *
 * The UI controller for the form template edit page.
 * Initializes all UI components and interactions.
 *
 */
var CFFormTemplateEdit = new Class({
    
    Implements: [Options, Events],

    Binds: [
        'sortStart', 'sortSorted', 'sortComplete'
    ],

    Options: {
		
    },

    initialize: function (options) {

        this.startlist = null;
        
        this.sortableSections = new Sortables([document.getElement('.from'),document.getElement('.to')], {
            clone: true,
            handle: '.grey',
            onStart: this.sortStart,
            onSort: this.sortSorted,
            onComplete: this.sortComplete
        });

        new CFNameCreator({
            nameInput: document.id('Name'),
            fromInput: document.id('Description')
        });

        /**/

        window.fireEvent('ResizeFrame');

    },

    sortStart: function (element) {
        this.startlist = element.getParent();
    },
    
    sortSorted: function (element, clone) {
        
        if (element.getParent() != this.startlist) {
            var target = element.getParent() == document.getElement('.from') ? document.getElement('.to') : document.getElement('.from');
            if (!target.getElement('.temp')) {
                var temp = element.clone().inject(target);
                temp.addClass('temp');
                temp.removeProperty('style');
                temp.setStyle('opacity', 0.5);
            }
            element.addClass('hidden');
        }

    },
    
    sortComplete: function element(element) {
        element.removeClass('hidden');
        if (document.getElement('.from .temp')) { document.getElement('.from .temp').destroy(); }
        if (document.getElement('.to .temp')) { document.getElement('.to .temp').destroy(); }
    }
   
});;
var CFFormView = new Class({

    Implements: [Options],

    Binds: [
        'init', 'initConitnue',
    ],

    options: {
        instanceId: '',
        addFileApi: '',
        deleteFileApi: '',
        getFileNamesApi: '',
        downloadFileApi: '',
        earlyFileData: []
    },

    done: false,

    initialize: function (options) {

        this.setOptions(options);

        this.fileData = this.options.earlyFileData;
        var earlyFileGet = function (data)
        {
            if (this.fileData.filter(function (x) { return x.initialValues === data.initialValues }).length === 0)
            {
                this.fileData.push(data);
                if (this.done)
                {
                    window.fireEvent('multiFileDefaults', data);
                }
            }
        }.bind(this);
        window.addEvent('multiFileDefaults', earlyFileGet);

        if (Affinity.pageReady) this.init();
        window.addEvent('PageReady', this.init);
    },

    init: function ()
    {
        window.removeEvent('PageReady', this.init);
        this.checkFormTimer = null;
        this.formCheck = function ()
        {
          clearTimeout(this.checkFormTimer);
          if (document.querySelector('div.default-form')) this.initConitnue();
          else this.checkFormTimer = setTimeout(this.formCheck, 100);
        }.bind(this);
        this.formCheck();
    },

    initConitnue: function ()
    {
        /*
        * Check if we have a Table of Contents element
        */
        new CFContentsTable();

        window.addEvent('UiReady', function () {

            window.fireEvent('ResizeFrame');
            (function () {
                window.fireEvent('ResizeFrame');
            }).delay(500); // allow for section hide / show animations

        });

        /*
        * Loop through all milti file uploads so we can use the CFMultiUpload
        * class to handle file add and delete
        */

        if (!(Affinity && Affinity.hasOwnProperty('Uplaoders')))
        {
            Affinity.Uplaoders = new UIUplaodersMulti();
        }
        var nodes = document.querySelectorAll('.uploadmulti:not(.uidone)');
        if (nodes.length > 0)
        {
            Affinity.Uplaoders.processNew();
        }

        new CFMulitFileUploaders({
            instanceId: this.options.instanceId,
            addApi: null,
            deleteApi: null,
            getNamesApi: this.options.getFileNamesApi,
            downloadFileApi: this.options.downloadFileApi
        });
        if (this.fileData.length > 0)
        {
            for (var f = 0; f < this.fileData.length; f++)
            {
                window.fireEvent('multiFileDefaults', this.fileData[f]);
            }
        }

        /**/

        /**/

        if (Affinity.banknumber) Affinity.banknumber.processNew();
        if (Affinity.taxnumber) Affinity.taxnumber.processNew();

        /**/

        this.done = true;
    }

});;

var CFformsAdminDelete = new Class({

    Implements: [Options, Events],

    Binds: [
		'deleteClicked',
        'processButton'
    ],


    Options: {
        nameMaxLength: 100
    },

    initialize: function (options) {

        this.setOptions(options);

        /**/

        this.processButton();

        /**/

        var doToolTips = false;

        Array.each(document.getElements('table .form-desc'), function (td) {
            var html = td.get('html');
            if (html.length > this.options.nameMaxLength) {
                td.set('data-tooltip', html);
                td.set('data-tooltip-dir', 'top');
                td.set('html', html.substr(0,30) + ' ...');
                td.addClass('ui-has-tooltip');
                doToolTips = true;
            }
        }.bind(this));

        if(doToolTips){
            Affinity.tooltips.processNew();
        }

        /**/

        Array.each(document.getElements('table .form-workflow'), function (td) {
            var html = td.get('html');
            if (html == '') {
                td.set('html', 'No Workflow');
            } else {
                td.set('html', html.split(',').join(', '));
            }
        }.bind(this));

    },

    deleteClicked: function (e) {

        uiconfirm({
            message: 'Are you sure you would like to delete this form instance?',
            onOk: function () {

                var button = e.target.hasClass('button') ? e.target : e.target.getParent('.button');
                var form = new Element('form', { 'action': button.get('data-action'), 'method': 'post', 'target': '_self' }).inject(button, 'after');
                new Element('input', { 'type': 'hidden', 'name': 'instanceId', 'value': button.get('data-instanceId') }).inject(form);
                form.submit();

            }.bind(this)
        });

    },

    processButton: function () {
        Array.each(document.getElements('.button.delete'), function (button) {
            button.addEvent(Affinity.events.click, this.deleteClicked);
        }.bind(this));
    }

});;
/*                                                                                  *
 * This script belongs to the cf (CleverForms) package.                             *
 *                                                                                  *
 * The following code assumes MooTools Core 1.4.5 has been included.                *
 *                                                                                  */

/**
 * @class CFFormCreator
 *
 * The UI controller for the form creator page.
 * Initializes all UI components and interactions.
 *
 */

var CFFormDesigner = new Class({

    Implements: [Options, Events],

    Binds: [
		'itemPressed', 'itemOver', 'itemOut', 'draggerStart', 'onDragCalcIndex', 'draggerDroppped', 'draggerEnter', 'draggerLeave', 'dragCanceled',

		'addNewSection', 'addSection', 'editSection', 'deleteSection',
        'addNewItem', 'addItem', 'editItem', 'deleteItem',

		'loadTemplate', 'templateLoaded', 
        'returnRankData', 'postRank',
        'updateDashboardTemplateFlag'
    ],

    singleUseElementTypes: [
        'effectivedate'
    ],

    options: {
        templateid: null,
        rankApi: null,
        itemDeleteApi: null,
        sectionDeleteApi: null,
        updateDashboardTemplateFlagUrl: null
    },

    dragger: null,

    sectionCount: 0,

    initialize: function (options)
    {

        this.setOptions(options);

        this.droppables = [];

        this.sections = document.getElements('#selectedFormItems .form-section');
        this.itemLists = document.getElements('#selectedFormItems .dragto');
        this.items = document.getElements('#selectedFormItems .form-item');

        this.droppables.combine(this.sections);
        this.droppables.combine(this.itemLists);

        this.templateId = document.id('TemplateId');
        this.dashboardTemplate = document.id('DashboardTemplate');
        this.dashboardTemplate.addEvent('change', this.updateDashboardTemplateFlag);

        /**/

        var title, titleStr;
        Array.each(document.getElements('#availableFormItems .form-element'), function (el, index)
        {
            title = el.getElement('.form-element-title');
            if (window.mobile) {
                el.addEvent(Affinity.events.start, this.itemPressed);
            } else {
                el.getElements('.grey').addEvent(Affinity.events.start, this.itemPressed);
            }
            if (window.mobile) { el = title; }
            el.addEvent(Affinity.events.overAll, this.itemOver);
            el.addEvent(Affinity.events.outAll, this.itemOut);
        }.bind(this));

        if (window.mobile) {

            this.sortableSections = new Sortables(document.id('selectedFormItems'), {
                clone: true,
                handle: '.grey',
                onStart: function (el, clone)
                {
                    clone.empty();
                    clone.set('class', 'form-element form-section draggable dragger');
                    el.getElement('.blue').clone().inject(clone);
                    clone.setStyles({
                        'margin-left': el.getElement('.grey').getPosition(el).x,
                        'margin-top': el.getElement('.grey').getPosition(el).y
                    });
                },
                onComplete: this.postRank
            });

            this.sortableItems = new Sortables(this.sections.getElements('.section-list'), {
                clone: true,
                onStart: function (el, clone)
                {
                    clone.empty();
                    clone.set('class', 'form-element form-item draggable dragger');
                    el.getElement('.blue').clone().inject(clone);
                    clone.setStyles({
                        'margin-left': el.getElement('.grey').getPosition(el).x,
                        'margin-top': el.getElement('.grey').getPosition(el).y
                    });
                },
                onComplete: function (el) { el.removeClass('overtop'); this.postRank(); }.bind(this)
            });

        } else {

            this.sortableSections = new Sortables(document.id('selectedFormItems'), {
                clone: true,
                handle: '.grey',
                onComplete: this.postRank,
                onStart: function (el, clone)
                {
                    clone.addClass('dragger');
                }
            });

            this.sortableItems = new Sortables(this.sections.getElements('.section-list'), {
                clone: true,
                handle: '.grey',
                onStart: function (el, clone)
                {
                    el.addClass('overtop');
                    clone.setStyle('opacity', 0.5);
                    clone.addClass('dragger');
                },
                onComplete: function (el) { el.removeClass('overtop'); this.postRank(); }.bind(this)
            });

            Array.each(this.itemLists.getElements('.grid-list'), function (list)
            {
                new Sortables(list, {
                    clone: true,
                    handle: '.grey',
                    onStart: function (el, clone)
                    {
                        el.addClass('overtop');
                        clone.setStyle('opacity', 0.5);
                        clone.addClass('dragger');
                    },
                    onComplete: function (el) { el.removeClass('overtop'); this.postRank(); }.bind(this)
                });
            }.bind(this));

        }

        /* Process existing Items */

        Array.each(this.items, function (el)
        {
            el.getElement('.form-element-edit').addEvent(Affinity.events.click, this.editItem);
            el.getElement('.form-element-close').addEvent(Affinity.events.click, this.deleteItem);
            el.set('data-form-label', el.getElement('.form-element-title').get('html'));
            el.set('data-form-name', el.getElement('.form-element-title').get('html').replace(/ /g, '').toLowerCase());
            this.sortableItems.addItems(el);
            if (this.singleUseElementTypes.contains(el.get('data-type').toLowerCase().trim())) {
                document.getElement('#availableFormItems .master-' + el.get('data-type').toLowerCase().trim()).addClass('disabled');
            }
        }.bind(this));

        /* Process existing Sections */

        Array.each(this.sections, function (el)
        {
            el.getElement('.form-element-edit').addEvent(Affinity.events.click, this.editSection);
            el.getElement('.form-element-close').addEvent(Affinity.events.click, this.deleteSection);
            el.set('data-form-label', el.getElement('.form-element-title').get('html'));
            el.set('data-form-name', el.getElement('.form-element-title').get('html').replace(/ /g, '').toLowerCase());
            this.sortableItems.addItems(el);
        }.bind(this));

        /* Request objects */

        this.templateRequest = new CFRequest.HTML({
            method: 'get',
            onSuccess: this.templateLoaded
        });

        this.itemDeleteRequest = new CFRequest({
            url: this.options.itemDeleteApi,
            method: 'post',
            onRequest: function () { },
            onSuccess: function (response) { /*console.log(response);*/ },
            onFailure: function () { /*console.log('request failed');*/ }
        });

        this.sectionDeleteRequest = new CFRequest({
            url: this.options.sectionDeleteApi,
            method: 'post',
            onRequest: function () { },
            onSuccess: function (response) { /*console.log(response);*/ },
            onFailure: function () { /*console.log('request failed');*/ }
        });

        this.sendOrderRequest = new CFRequest({
            urlEncoded: false,
            url: this.options.rankApi,
            method: 'post',
            onRequest: function () { },
            onSuccess: function (response) { /*console.log(response);*/ },
            onFailure: function () { /*console.log('request failed');*/ }
        });

        this.sendOrderRequest.options.headers = { 'Content-type': 'application/json; charset=utf-8' };
        this.sendOrderRequest.headers = this.sendOrderRequest.options.headers;
        this.sendOrderRequest.options.urlEncoded = false;

        document.getElement('.col2 .section-list').setStyles({
            'min-height': document.getElement('.col1 .section-list').getSize().y - 14
        });

        /**/

        window.fireEvent('ResizeFrame');

    },

    itemOver: function (e)
    {
        var el = e.target.hasClass('form-element') ? e.target : e.target.getParents('.form-element')[0];
        var pos = el.getPosition();
        Affinity.helpbubble.populate(el.get('data-helptext'));
        Affinity.helpbubble.position({ y: pos.y + 4, x: pos.x + el.getSize().x + 10 });
        Affinity.helpbubble.show();
    },

    itemOut: function (e)
    {
        Affinity.helpbubble.hide();
    },

    itemPressed: function (e)
    {

        e.preventDefault();
        e.stopPropagation();

        this.dragger = null;
        if (document.getElements('drag-form-item')) {
            document.getElements('drag-form-item').destroy();
        }

        var el = (e.target.hasClass('draggable')) ? e.target : e.target.getParent('.draggable');

        if (el.hasClass('disabled')) {
            uialert({
                message: 'This element can no longer be used.<br />This may be a single use element only and may already be in your form.',
                showButtons: true,
                showLoader: false
            });
            return;
        }

        if (window.mobile) {

            this.dragger = el.getElement('.blue').clone().setStyles({
                position: 'absolute',
                top: e.page.y - 15,
                left: e.page.x - 15
            }).inject(document.getElement('#availableFormItems'));
            this.dragger.addClass(el.get('class') + ' dragger');
            this.dragger.removeClass('light-shadow');
            this.dragger.store('reference', el);

        } else {

            this.dragger = el.clone().setStyles(el.getCoordinates()).setStyles({
                position: 'absolute',
                'opacity': 0.5
            }).inject(document.getElement('#availableFormItems'));
            this.dragger.addClass('drag-form-item dragger');

            /* border offsets lol */
            var size = this.dragger.getSize();
            this.dragger.setStyles({ 'width': (size.x - 4) + 'px', 'height': (size.y - 4) + 'px' });
            delete size;
            /**/

        }

        window.drageventFired = true;

        var droppables = this.dragger.hasClass('form-section') ? '.section-column.col2' : this.droppables;

        var dragFunction = window.mobile ? function (el, e)
        {
            window.mobileDragY = e.page.y;
        }.bind(this) : this.onDragCalcIndex;

        this.dropwhere = 'before';
        this.droppable = null;
        this.dropablelastindex = -1;
        this.droppableoffset = 0;
        this.draggerrank = 0;
        new Drag.Move(this.dragger, {
            droppables: droppables,
            onStart: this.draggerStart,
            onEnter: this.draggerEnter,
            onLeave: this.draggerLeave,
            onDrop: this.draggerDroppped,
            onCancel: this.dragCanceled,
            onDrag: dragFunction
        }).start(e);

    },

    /* DRAG CONTROLS */

    draggerStart: function (el, e)
    { },

    draggerEnter: function (element, droppable)
    {
        if (this.dragger && droppable) {
            droppable.getElement('ul').addClass('godrop');
            this.droppable = droppable;
            this.indexMax = this.droppable.getElements('.form-element').length - 1;
            if (element.get('data-type') == 'section') {
                this.droppableoffset = document.id('selectedFormItems').getPosition().y;
                this.draggertype = 'section';
                this.sectionPositions = [];
                Array.each(this.sections, function (section)
                {
                    this.sectionPositions.push({
                        y: section.getPosition().y - this.droppableoffset,
                        h: section.getSize().y,
                        el: section
                    });
                }.bind(this));
            } else {
                this.draggertype = 'item';
                this.droppableoffset = droppable.getPosition().y;
            }
        }
    },

    onDragCalcIndex: function (el, e)
    {
        if (this.droppable != null) {
            var y, bottom, index, sections;
            // this.draggertype, this.droppable are set by this.draggerEnter
            // If we are draggin a NEW item, calculate the inex of the drop position and highlight where the drop will occur
            if (this.draggertype == 'item') {
                if (window.mobile) {
                    y = (window.mobileDragY - this.droppableoffset - 55);
                } else {
                    y = (e.page.y - this.droppableoffset - 55);
                }
                index = y / 40;
                index = Math.floor(index);

                index = index > this.indexMax ? this.indexMax : index;
                index = index < 0 ? 0 : index;

                if (index >= 0 && (index != this.dropablelastindex || index == 0)) {
                    if (this.dropEl) {
                        this.dropEl.removeClass('over');
                        this.dropEl.removeClass('overtop');
                    }

                    this.dropEl = this.droppable.getElements('.form-element')[index];

                    if (this.dropEl) {
                        if (y <= 20) {
                            this.dropEl.addClass('overtop');
                            this.dropwhere = 'before';
                            this.draggerrank = 0;
                        } else if (y > 20) {
                            this.dropEl.addClass('over');
                            this.dropwhere = 'after';
                            this.draggerrank = index + 1;
                        }
                        this.dropablelastindex = index;
                    }
                }

                // If we are draggin a NEW section, calculate the inex of the drop position and highlight where the drop will occure
            } else if (this.draggertype == 'section') {
                if (this.sectionPositions && typeOf(this.sectionPositions) == 'array' && this.sectionPositions.length > 0) {
                    bottom = this.sectionPositions[this.sectionPositions.length - 1].h + this.sectionPositions[this.sectionPositions.length - 1].y;
                    y = (e.page.y - this.droppableoffset);
                    if (y > 0 && y < bottom && y % 5 == 0) {
                        Array.each(this.sectionPositions, function (droppos, i)
                        {
                            droppos.el.removeClass('over');
                            droppos.el.removeClass('overtop');
                            if (y >= droppos.y && y < droppos.y + (droppos.h / 2)) {
                                this.dropEl = droppos.el;
                                index = i;
                                this.dropEl.addClass('overtop');
                                this.dropwhere = 'before';
                                this.draggerrank = index;
                            } else if (y >= droppos.y && y < droppos.y + droppos.h) {
                                this.dropEl = droppos.el;
                                index = i;
                                this.dropEl.addClass('over');
                                this.dropwhere = 'after';
                                this.draggerrank = index + 1;
                            }
                            this.dropablelastindex = this.draggerrank;
                        }.bind(this));
                    } else if (this.droppable != null && y < 0) {
                        index = this.draggerrank = this.dropablelastindex = 0;
                        this.dropEl = this.sectionPositions[index].el;
                        this.dropwhere = 'before';
                        this.dropEl.addClass('overtop');
                    } else if (this.droppable != null && y > bottom) {
                        index = this.draggerrank = this.dropablelastindex = this.sectionPositions.length - 1;
                        this.dropEl = this.sectionPositions[index].el;
                        this.dropwhere = 'after';
                        this.dropEl.addClass('over');
                    }
                }

                delete y;
                delete bottom;
                delete index;
                delete sections;;

            }

        }
    },

    draggerDroppped: function (el, droppable, e)
    {

        if (window.mobile) {
            this.onDragCalcIndex(el, e);
        }

        if (this.dropEl) {
            this.dropEl.removeClass('over');
            this.dropEl.removeClass('overtop');
        }

        if (droppable !== null) {

            if (el.hasClass('form-section')) {
                this.addNewSection(this.dragger);
            }
            if (el.hasClass('form-item')) {
                this.addNewItem(this.dragger, droppable.getElement('ul'));
                if (this.singleUseElementTypes.contains(this.dragger.get('data-type').toLowerCase().trim())) {
                    document.getElement('#availableFormItems .master-' + this.dragger.get('data-type').toLowerCase().trim()).addClass('disabled');
                }
            }
            droppable.getElement('ul').removeClass('godrop');
        }

        this.dragCanceled(el, null);

    },

    draggerLeave: function (element, droppable)
    {
        this.draggertype = null;
        if (this.dropEl) { this.dropEl.removeClass('over'); this.dropEl.removeClass('overtop'); }
        if (droppable) {
            droppable.getElement('ul').removeClass('godrop');
            this.droppable = null;
            this.droppableoffset = 0;
        }
    },

    dragCanceled: function (el, e)
    {
        this.draggertype = null;
        el.destroy();
        this.dragger = null;
        if (document.getElements('drag-form-item')) {
            document.getElements('drag-form-item').destroy();
        }
    },

    /* SECTION CONTROLS */

    addNewSection: function (el, target)
    {
        target = this.dropEl ? this.dropEl : target ? target : document.id('selectedFormItems');
        var newel = el.clone().removeProperty('style').removeClass('drag-form-item');
        if (this.dropEl) {
            newel.inject(this.dropEl, this.dropwhere);
        } else {
            newel.inject(target);
        }
        this.sectionCount++;
        newel.getElement('.form-element-title').set('html', newel.getElement('.form-element-title').get('html') + ' ' + this.sectionCount);
        newel.getElement('.form-element-edit').addEvent(Affinity.events.click, this.editSection);
        newel.getElement('.form-element-close').addEvent(Affinity.events.click, this.deleteSection);
        this.sortableSections.addItems(newel);
        this.droppables.push(newel);
        this.sortableItems.addLists(newel.getElement('.section-list'));
        this.addSection(newel);
        delete newel;

    },

    addSection: function (el)
    {
        el = (el.hasClass('form-section')) ? el : el.getParents('.form-section')[0];

        var loader = new Element('div', { 'class': 'spinnerbox large', 'html': '<img src="' + document.config.loaders.large.light + '" />' });

        Affinity.modal.setElement(loader);
        delete loader;

        Affinity.modal.show(false);

        document.callerElement = el;
        this.loadTemplate(el, true, true);

        /**/

        window.fireEvent('ResizeFrame');

    },

    editSection: function (e)
    {
        var el = e.target;
        el = (el.hasClass('form-item')) ? el : el.getParents('.form-section')[0];

        var loader = new Element('div', { 'class': 'spinnerbox large', 'html': '<img src="' + document.config.loaders.large.light + '" />' });

        Affinity.modal.setElement(loader);
        delete loader;

        Affinity.modal.show(false);

        document.callerElement = el;
        this.loadTemplate(el, false, true);
    },

    deleteSection: function (e, el)
    {
        var element = (e != null) ? e.target : el;
        if (!element.hasClass('form-section')) { element = element.getParents('.form-section')[0]; }
        var children = element.getElements('li');
        var childNames = [];
        Array.each(children, function (el, index) { childNames.push(el.getElement('.form-element-title').get('html').trim()); });
        if (childNames.length > 5) {
            childNames = childNames.slice(0, 5);
            childNames.push('...');
        }
        childNames = (childNames.length > 0) ? 'This will delete all ' + children.length + ' elements in this section:<br /><br />' + childNames.join('<br />') + '<br /><br />' : 'This will delete this section. ';

        uiconfirm({
            message: childNames + 'Continue?',
            onOk: function ()
            {

                var postData = {};
                postData.templateid = this.options.templateid;
                postData.sectionname = element.get('data-item-name');

                element.getElements('.form-element').destroy();
                element.destroy();

                this.sectionDeleteRequest.post(postData);

                delete postData;

            }.bind(this)
        });

    },

    /* ITEM CONTROLS */

    addNewItem: function (el, target)
    {
        if (typeOf(this.dropEl) !== 'null') {
            target = this.dropEl;
        }

        var newel;
        if (el.retrieve('reference')) { // referene set if draggable is icon only on mobile
            newel = el.retrieve('reference').clone();
        } else {
            newel = el.clone().removeProperty('style').removeClass('drag-form-item');
        }

        if (this.dropEl) {
            newel.inject(this.dropEl, this.dropwhere);
        } else {
            newel.inject(target);
        }

        if (newel.hasClass('dragto')) {

            this.droppables.push(newel);
            this.sortableItems.addLists(newel.getElement('.grid-list'));

        }


        this.sortableItems.addItems(newel);



        newel.getElement('.form-element-title').set('html', '???');
        newel.getElement('.form-element-edit').addEvent(Affinity.events.click, this.editItem);
        newel.getElement('.form-element-close').addEvent(Affinity.events.click, this.deleteItem);
        this.addItem(newel);
        delete newel;
    },

    addItem: function (el)
    {
        el = (el.hasClass('form-item')) ? el : el.getParents('.form-item')[0];

        var loader = new Element('div', { 'class': 'spinnerbox large', 'html': '<img src="' + document.config.loaders.large.light + '" />' });
        Affinity.modal.setElement(loader);
        delete loader;

        Affinity.modal.show(false);

        document.callerElement = el;
        this.loadTemplate(el, true, false);

        /**/

        window.fireEvent('ResizeFrame');

    },

    editItem: function (e)
    {
        var el = e.target;
        el = (el.hasClass('form-item')) ? el : el.getParents('.form-item')[0];

        var loader = new Element('div', { 'class': 'spinnerbox large', 'html': '<img src="' + document.config.loaders.large.light + '" />' });
        Affinity.modal.setElement(loader);
        delete loader;

        Affinity.modal.show(false);
        document.callerElement = el;
        this.loadTemplate(el, false, false);

    },

    deleteItem: function (e, el)
    {
        var element = (e != null) ? e.target : el;
        if (!element.hasClass('form-item')) { element = element.getParents('.form-item')[0]; }

        uiconfirm({
            message: 'Are you sure you want to delete this item?',
            onOk: function ()
            {

                var postData = {};
                postData.templateid = this.options.templateid;
                postData.elementname = element.get('data-item-name');

                if (this.singleUseElementTypes.contains(element.get('data-type').toLowerCase().trim())) {
                    document.getElement('#availableFormItems .master-' + element.get('data-type').toLowerCase().trim()).removeClass('disabled');
                }

                this.itemDeleteRequest.post(postData);
                element.destroy();

                delete postData;

            }.bind(this)
        });

    },

    /* TEMPLATE CONTROLS */

    loadTemplate: function (el, isnew, isSection)
    {
        var url = isnew ? el.get('data-template-load-create') : el.get('data-template-load-edit');
        if (!isSection) { // we are an item
            if (!isnew) { // we are editing
                url += '&name=' + el.get('data-item-name');
            }
            url += '&section=' + el.getParents('.form-section')[0].get('data-item-name');
        } else { // we are a section
            url += '&sectionName=' + el.get('data-item-name');
        }
        if (typeOf(this.draggerrank) !== 'null') {
            url += '&rank=' + this.draggerrank;
        }
        url += '&ran=' + new Date().format('%s');

        this.templateItemName = el.get('data-template-type');

        this.templateRequest.options.url = url;
        this.templateRequest.send();

    },

    templateLoaded: function (response)
    {
        Affinity.modal.setElement(new Element('div').adopt(response));
        Affinity.modal.show(false);
        (function ()
        {
            if (document.uiHideToggle) {
                document.uiHideToggle.processNew();
                (function ()
                {
                    Affinity.modal.position();
                }).delay(500);
            }

            window.fireEvent('TemplateReady', { type: this.templateItemName });

        }.bind(this).delay(1000, this));
    },

    /* DATA CONTROLS */

    returnRankData: function ()
    {
        var elements;
        var data = {};
        data.TemplateId = this.options.templateid,
        data.Sections = {};
        Array.each(document.getElements('#selectedFormItems .form-section'), function (sectionEl, index)
        {
            data.Sections[sectionEl.get('data-item-name')] = [];
            elements = data.Sections[sectionEl.get('data-item-name')];
            Array.each(sectionEl.getElements('.section-list .form-item'), function (itemEl, index)
            {
                elements.push(itemEl.get('data-item-name'));
            }.bind(this));
        }.bind(this));
        delete elements;

        return JSON.stringify(data);
    },

    postRank: function () {
        this.sendOrderRequest.post(this.returnRankData());
    },

    updateDashboardTemplateFlag: function () {
        new CFRequest.JSON({
            url: this.options.updateDashboardTemplateFlagUrl,
            method: 'POST',
            onSuccess: function (data) {},
            onError: function (data) {
                uialert({
                    message: 'Sorry, an error occurred while processing your request.',
                    showLoader: false,
                    showButtons: true,
                    noClose: false
                });
            }
        }).post({
            templateId: this.templateId.value,
            dashboardTemplate: this.dashboardTemplate.get('checked')
        });
    }
});;

var CFInbox = new Class({

  Implements: [Options, Events],

  Binds: [
    'menuItemclicked',
    'updateInbox','selectInbox',
    'archiveForm','restoreForm','deleteForm',
    'startNewForm',
    'formSelected',
    'mobileIndicateScroll', 'mobileIndicateScrollHide'
  ],

  options: {
    editUrl: '/Instance/Edit/',
    viewUrl: '/Instance/View/',
    deleteUrl: '/Inbox/Delete/',
    archiveUrl: '/Inbox/Archive/',
    restoreUrl: '/Inbox/Restore/',
    expireTabCookie: false,
    expireTabMins: 10
  },

  initialize: function (options)
  {

    this.setOptions(options);

    this.icons = {};
    this.icons.edit = Affinity.icons.Pencil || '&#xe0fd;';
    this.icons.del = Affinity.icons.CrossRound || '&#xe06d;';
    this.icons.view = Affinity.icons.Page || '&#xe086;';
    this.icons.archive = Affinity.icons.Box || '&#xe06a;';
    this.icons.restore = Affinity.icons.Ccw || '&#xe08c;';

    if (Affinity.modernUIEndabled)
    {
      this.icons.del = Affinity.icons.Cross || '&#xe07a;';
    }

    this.labels = {
      edit: 'Edit',
      view: 'View',
      archive: 'Are you sure you want to archive this form?',
      archiving: 'Archiving form. Please wait',
      restore: 'Are you sure you want to restore this form?',
      restoring: 'Restoring form. Please wait',
      delete: 'Are you sure you want to delete this form?',
      deleting: 'Deleting form. Please wait'
    };

    if (this.options.hasOwnProperty('labels'))
    {
      Object.each(this.options.labels, function (str, key)
      {
        this.labels[key] = str;
      }.bind(this));
    }

    document.getElement('.button.startnew').addEvent(Affinity.events.click, this.startNewForm);

    Array.each(document.getElements('.delete'), function (el)
    {
      el.addEvent(Affinity.events.click, this.deleteForm);
    }.bind(this));

    this.inbox = document.getElement('.ui-inbox');
    this.inboxid = this.inbox.get('id');
    this.tabIndex = 0;

    /**/

    var boxes = this.inbox.getElements('.ui-inbox-box');

    this.toActionBox = boxes[0];
    this.inProgressBox = boxes[1];
    this.completedBox = boxes[2];
    this.archivedBox = boxes[3];

    /**/

    var indicators = this.inbox.getElements('.ui-inbox-labels .indicator');

    this.toActionIndicator = indicators[0];
    this.inProgressIndicator = indicators[1];
    this.completedIndicator = indicators[2];
    this.archivedIndicator = indicators[3];
        
    /**/

    var startingIndex = parseInt(Cookie.read('uiInboxIndex'));
    if (startingIndex)
    {
      Affinity.uiInbox.selectBox(this.inbox.getElements('.ui-inbox-labels ul li')[startingIndex]);
    }

    /**/

    var menuItems = this.inbox.querySelectorAll('.table-hover-menu-item');
    for (var e = 0; e < menuItems.length; e++)
    {
      var menuItem = menuItems[e];
      if (menuItem.querySelector('input[type="checkbox"]'))
      {
        var checkbox = menuItem.querySelector('input[type="checkbox"]');
        var table = menuItem.closest('table');
        if (menuItem && table && menuItem.hasAttribute('data-show-name'))
        {
          var showName = menuItem.dataset.showName;
          if (showName !== null && table.querySelector('th[data-name="' + showName + '"]'))
          {
            var selected = this.cookieShowColumn(table.dataset.boxName, showName, checkbox.checked);
            if (selected) 
            {
              checkbox.checked = true;
              this.showColumn(table.dataset.boxName, showName);
            }
            else
            {
              checkbox.checked = false;
              this.hideColumn(table.dataset.boxName, showName);
            }
            menuItem.addEventListener('click', this.menuItemclicked);
          }
        }
      }
    }

    /**/

    this.scrollMessage = false;
    if (Affinity.mobile || Affinity.ismobile)
    {
      this.scrollMessage = document.createElement('div');
      this.scrollMessage.classList.add('scroll-message');
      this.scrollMessage.innerHTML = 'Scroll to see more';
      this.inbox.appendChild(this.scrollMessage);
    }

    /**/

    window.addEvent('inboxUpdated', this.updateInbox);
    window.addEvent('inboxSelected', this.selectInbox);

    /**/

    window.fireEvent('ResizeFrame');

    window.testInbox = this;

  },

  lastdata: {},

  menuItemclicked: function (ev)
  {
    var item = ev.target.closest('.table-hover-menu-item');
    if (item.querySelector('input[type="checkbox"]') && !item.querySelector('input[type="checkbox"]').disabled)
    {
      var table = item.closest('table');
      var showName = item.dataset.showName || null;
      var checkbox = item.querySelector('input[type="checkbox"]');
      //if (showName !== null && table.querySelector('th[data-name="' + showName + '"]'))
      if (showName !== null)
      {
        //if (table.querySelector('td[data-name="' + showName + '"]'))
        //{
          if (checkbox.checked)
          {
            this.hideColumn(table.dataset.boxName, showName);
          }
          else
          {
            this.showColumn(table.dataset.boxName, showName);
          }
        //}
      }
    }
  },

  showColumn(boxName, showName)
  {
    var table = document.querySelector('table[data-box-name="' + boxName + '"]');
    if (table)
    {
      var menuItem = table.querySelector('.table-hover-menu-item[data-show-name="' + showName + '"]');
      if (menuItem)
      {
        var rows = table.querySelectorAll('td[data-name="' + showName + '"],th[data-name="' + showName + '"]'), r;
        for (r = 0; r < rows.length; r++)
        {
          rows[r].classList.remove('hidden');
        }
        menuItem.querySelector('input[type="checkbox"]').checked = true;
        Cookie.write('uiInboxShow_' + boxName + '_' + showName, true); //, { duration: this.options.expireTabCookie ? (1 / 24 / 60) * this.options.expireTabMins : 1 });
      }
    }
  },

  hideColumn(boxName, showName)
  {
    var table = document.querySelector('table[data-box-name="' + boxName + '"]');
    if (table)
    {
      var menuItem = table.querySelector('.table-hover-menu-item[data-show-name="' + showName + '"]');
      if (menuItem)
      {
        var rows = table.querySelectorAll('td[data-name="' + showName + '"],th[data-name="' + showName + '"]'), r;
        for (r = 0; r < rows.length; r++)
        {
          rows[r].classList.add('hidden');
        }
        menuItem.querySelector('input[type="checkbox"]').checked = false;
        Cookie.write('uiInboxShow_' + boxName + '_' + showName, false); //, { duration: this.options.expireTabCookie ? (1 / 24 / 60) * this.options.expireTabMins : 1 });
      }
    }
  },

  cookieShowColumn: function(boxName, showName, defaultValue)
  {
    var isSet = Cookie.read('uiInboxShow_' + boxName + '_' + showName);
    if (isSet !== null)
    {
      return isSet === 'true' || isSet === true;
    }
    return defaultValue;
  },

  updateInbox: function (options)
  {
    var table, row, buttonsHTML, buttons;

    var cols = [];
    var columnStates = {};

    //console.clear();
    //console.log(options);

    if (options.elementid == this.inboxid)
    {

      /* DO ToAction */

      if (typeOf(this.lastdata.ToAction) === 'null')
      {
        this.lastdata.ToAction = {};
      }
      this.toActionIndicator.set('html', options.data.ToActionCount);
      if (this.lastdata.ToAction != options.data.ToAction)
      {
        if (options.data.ToActionCount == 0)
        {
          this.toActionBox.getElement('.empty').removeClass('hidden');
          this.toActionBox.getElements('.form').destroy();
        }
        else
        {
          this.toActionBox.getElement('.empty').addClass('hidden');
          this.toActionBox.getElements('.form').addClass('checking');

          columnStates = {
            name: this.cookieShowColumn('action', 'name', true),
            state: this.cookieShowColumn('action', 'state', true),
            recieved: this.cookieShowColumn('action', 'recieved', true),
            effective: this.cookieShowColumn('action', 'effective', true),
            paypoint: this.cookieShowColumn('action', 'paypoint', false)
          };

          Array.each(options.data.ToAction, function (data, index)
          {
            var effectiveDate = data.hasOwnProperty('EffectiveDate') && data.EffectiveDate !== null && data.EffectiveDate.trim().toLowerCase() !== 'null' ? data.EffectiveDate : '';
            if (this.toActionBox.getElement('#' + data.InstanceId))
            {
              row = this.toActionBox.getElement('#' + data.InstanceId);
              cols = row.getElements('td');

              cols[0].classList.add('hidden');
              if (columnStates.name) cols[0].classList.remove('hidden');

              cols[1].set('html', data.StateName);
              cols[1].classList.add('hidden');
              if (columnStates.state) cols[1].classList.remove('hidden');

              cols[2].set('html', data.StateEnteredAt);
              cols[2].classList.add('hidden');
              if (columnStates.recieved) cols[2].classList.remove('hidden');

              cols[3].set('html', effectiveDate);
              cols[3].classList.add('hidden');
              if (columnStates.effective) cols[3].classList.remove('hidden');

              cols[4].set('html', data.PayPoint);
              cols[4].classList.add('hidden');
              if (columnStates.paypoint) cols[4].classList.remove('hidden');

              row.removeClass('checking');
            }
            else
            {
              data.DisplayName += data.ShareOrDelegate != null ? '<span class="tag ' + data.ShareOrDelegate.toLowerCase() + '">' + data.SharedBy + '</span>' : '';
              if (data.IsStarted)
              {
                buttonsHTML = '';
                buttonsHTML += '<a href="' + this.options.editUrl + '/' + data.InstanceId + '" id=""><span class="button blue w-icon"><span>' + this.icons.edit + '</span>' + this.labels.edit + '</span></a>';
                //buttonsHTML += '<span class="button red w-icon-only delete ui-has-tooltip" data-tooltip-dir="left" data-tooltip="Delete this form" data-action="' + this.options.deleteUrl + '/' + data.InstanceId + '"><span>' + this.icons.del + '</span></span>';
                buttonsHTML += '<span class="button orange w-icon-only archive ui-has-tooltip" data-tooltip-dir="left" data-tooltip="Archive this form" data-action="' + this.options.archiveUrl + '/' + data.InstanceId + '"><span>' + this.icons.archive + '</span></span>';
                buttons = new Element('td', { 'class': 'ui-inbox-actions buttons', 'html': buttonsHTML });
              }
              else
              {
                buttonsHTML = '';
                buttonsHTML += '<a href="' + this.options.editUrl + '/' + data.InstanceId + '" id=""><span class="button blue w-icon"><span>' + this.icons.edit + '</span>' + this.labels.edit + '</span></a>';
                buttons = new Element('td', { 'class': 'ui-inbox-actions buttons', 'html': buttonsHTML })
              }
              row = new Element('tr', { 'id': data.InstanceId, 'class': 'form' }).adopt(
                new Element('td', { 'data-name': 'name', 'class': 'indicate none sort-by' + (columnStates.name ? '' : ' hidden'), 'html': data.DisplayName }),
                new Element('td', { 'data-name': 'state', 'class': 'sort-by' + (columnStates.state ? '' : ' hidden'), 'html': data.StateName }),
                new Element('td', { 'data-name': 'recieved', 'class': 'ui-inbox-date sort-by ui-format-date' + (columnStates.recieved ? '' : ' hidden'), 'html': data.StateEnteredAt, 'data-date-format': '%e.%m.%Y %l:%M%p' }),
                new Element('td', { 'data-name': 'effective', 'class': 'ui-inbox-date-effective' + (columnStates.effective ? '' : ' hidden'), 'html': effectiveDate }),
                new Element('td', { 'data-name': 'paypoint', 'class': 'ui-inbox-paypoint' + (columnStates.paypoint ? '' : ' hidden'), 'html': data.PayPoint }),
                buttons
              ).inject(this.toActionBox.getElement('tbody'));
              if (data.IsStarted)
              {
                //row.getElement('.delete').addEvent(Affinity.events.click, this.deleteForm);
                row.getElement('.archive').addEvent(Affinity.events.click, this.archiveForm);
              }
            }
            row.querySelectorAll('td')[3].className = effectiveDate !== '' ? 'ui-inbox-date sort-by ui-format-date' : 'ui-inbox-date';
            row.querySelectorAll('td')[3].dataset.dateFormat = effectiveDate !== '' ? '%e.%m.%Y' : null;
          }.bind(this));
          this.toActionBox.getElements('.checking').destroy();
        }
        table = this.toActionBox.getElement('table');
        if (Affinity.uiSortableGrid) { Affinity.uiSortableGrid.processTable(table); }
        if (Affinity.uiGrid) { Affinity.uiGrid.zebra(table); }
        this.lastdata.ToAction = options.data.ToAction;
      }

      /* DO InProgress */

      if (typeOf(this.lastdata.InProgress) === 'null')
      {
        this.lastdata.InProgress = {};
      }
      this.inProgressIndicator.set('html', options.data.InProgressCount);
      if (this.lastdata.InProgress != options.data.InProgress)
      {
        if (options.data.InProgressCount == 0)
        {
          this.inProgressBox.getElement('.empty').removeClass('hidden');
          this.inProgressBox.getElements('.form').destroy();
        }
        else
        {
          this.inProgressBox.getElement('.empty').addClass('hidden');
          this.inProgressBox.getElements('.form').addClass('checking');

          columnStates = {
            name: this.cookieShowColumn('progress', 'name', true),
            state: this.cookieShowColumn('progress', 'state', true),
            to: this.cookieShowColumn('progress', 'to', true),
            at: this.cookieShowColumn('progress', 'at', true),
            effective: this.cookieShowColumn('progress', 'effective', true),
            paypoint: this.cookieShowColumn('progress', 'paypoint', false)
          };

          Array.each(options.data.InProgress, function (data, index)
          {
            var effectiveDate = data.hasOwnProperty('EffectiveDate') && data.EffectiveDate !== null && data.EffectiveDate.trim().toLowerCase() !== 'null' ? data.EffectiveDate : '';
            if (this.inProgressBox.getElement('#' + data.InstanceId))
            {
              row = this.inProgressBox.getElement('#' + data.InstanceId);
              cols = row.getElements('td');

              cols[0].classList.add('hidden');
              if (columnStates.name) cols[0].classList.remove('hidden');

              cols[1].set('html', data.StateName);
              cols[1].classList.add('hidden');
              if (columnStates.state) cols[1].classList.remove('hidden');

              cols[2].set('html', data.StateAssigneeName);
              cols[2].classList.add('hidden');
              if (columnStates.to) cols[2].classList.remove('hidden');

              cols[3].set('html', data.StateEnteredAt);
              cols[3].classList.add('hidden');
              if (columnStates.at) cols[3].classList.remove('hidden');

              cols[4].set('html', effectiveDate);
              cols[4].classList.add('hidden');
              if (columnStates.effective) cols[4].classList.remove('hidden');

              cols[5].set('html', data.PayPoint);
              cols[5].classList.add('hidden');
              if (columnStates.paypoint) cols[5].classList.remove('hidden');

              row.removeClass('checking');
            }
            else
            {
              buttonsHTML = '';
              buttonsHTML += '<a href="' + this.options.viewUrl + '/' + data.InstanceId + '" id=""><span class="button blue w-icon"><span>' + this.icons.view + '</span>' + this.labels.view + '</span></a>';
              buttonsHTML += '<span class="button orange w-icon-only archive ui-has-tooltip" data-tooltip-dir="left" data-tooltip="Archive this form" data-action="' + this.options.archiveUrl + '/' + data.InstanceId + '"><span>' + this.icons.archive + '</span></span>';
              data.DisplayName += data.ShareOrDelegate != null && data.ShareOrDelegate != 'null' ? '<span class="tag ' + data.ShareOrDelegate.toLowerCase() + '">' + data.SharedBy + '</span>' : '';
              row = new Element('tr', { 'id': data.InstanceId, 'class': 'form' }).adopt(
                new Element('td', { 'data-name': 'name', 'class': 'indicate none sort-by' + (columnStates.name ? '' : ' hidden'), 'html': data.DisplayName }),
                new Element('td', { 'data-name': 'state', 'class': 'sort-by' + (columnStates.state ? '' : ' hidden'), 'html': data.StateName }),
                new Element('td', { 'data-name': 'to', 'class': 'ui-inbox-date sort-by' + (columnStates.to ? '' : ' hidden'), 'html': data.StateAssigneeName }),
                new Element('td', { 'data-name': 'at', 'class': 'ui-inbox-date sort-by ui-format-date' + (columnStates.at ? '' : ' hidden'), 'html': data.StateEnteredAt, 'data-date-format': '%e.%m.%Y %l:%M%p' }),
                new Element('td', { 'data-name': 'effective', 'class': 'ui-inbox-date-effective' + (columnStates.effective ? '' : ' hidden'), 'html': effectiveDate }),
                new Element('td', { 'data-name': 'paypoint', 'class': 'ui-inbox-paypoint' + (columnStates.paypoint ? '' : ' hidden'), 'html': data.PayPoint }),
                new Element('td', { 'class': 'ui-inbox-actions buttons', 'html': buttonsHTML })
              ).inject(this.inProgressBox.getElement('tbody'));
              row.getElement('.archive').addEvent(Affinity.events.click, this.archiveForm);
            }
            row.querySelectorAll('td')[4].className = effectiveDate !== '' ? 'ui-inbox-date sort-by ui-format-date' : 'ui-inbox-date';
            row.querySelectorAll('td')[4].dataset.dateFormat = effectiveDate !== '' ? '%e.%m.%Y' : null;
          }.bind(this));
          this.inProgressBox.getElements('.checking').destroy();
        }
        table = this.inProgressBox.getElement('table');
        if (Affinity.uiSortableGrid) { Affinity.uiSortableGrid.processTable(table); }
        if (Affinity.uiGrid) { Affinity.uiGrid.zebra(table); }
        this.lastdata.InProgress = options.data.InProgress;
      }

      /* DO Completed */

      if (typeOf(this.lastdata.Completed) === 'null')
      {
        this.lastdata.Completed = {};
      }
      this.completedIndicator.set('html', options.data.CompletedCount > 99 ? '99+' : options.data.CompletedCount);
      if (this.lastdata.Completed != options.data.Completed)
      {
        if (options.data.CompletedCount == 0)
        {
          this.completedBox.getElement('.empty').removeClass('hidden');
          this.completedBox.getElements('.form').destroy();
        }
        else
        {
          this.completedBox.getElement('.empty').addClass('hidden');
          this.completedBox.getElements('.form').addClass('checking');

          columnStates = {
            name: this.cookieShowColumn('completed', 'name', true),
            state: this.cookieShowColumn('completed', 'state', true),
            to: this.cookieShowColumn('completed', 'to', true),
            at: this.cookieShowColumn('completed', 'at', true),
            effective: this.cookieShowColumn('completed', 'effective', true),
            paypoint: this.cookieShowColumn('completed', 'paypoint', false)
          };

          Array.each(options.data.Completed, function (data, index)
          {
            var effectiveDate = data.hasOwnProperty('EffectiveDate') && data.EffectiveDate !== null && data.EffectiveDate.trim().toLowerCase() !== 'null' ? data.EffectiveDate : '';
            if (this.completedBox.getElement('#' + data.InstanceId))
            {
              row = this.completedBox.getElement('#' + data.InstanceId);
              cols = row.getElements('td');

              cols[0].classList.add('hidden');
              if (columnStates.name) cols[0].classList.remove('hidden');

              cols[1].set('html', data.StateName);
              cols[1].classList.add('hidden');
              if (columnStates.state) cols[1].classList.remove('hidden');

              cols[2].set('html', data.CompletedBy);
              cols[2].classList.add('hidden');
              if (columnStates.to) cols[2].classList.remove('hidden');

              cols[3].set('html', data.StateEnteredAt);
              cols[3].classList.add('hidden');
              if (columnStates.at) cols[3].classList.remove('hidden');

              cols[4].set('html', effectiveDate);
              cols[4].classList.add('hidden');
              if (columnStates.effective) cols[4].classList.remove('hidden');

              cols[5].set('html', data.PayPoint);
              cols[5].classList.add('hidden');
              if (columnStates.paypoint) cols[5].classList.remove('hidden');

              row.removeClass('checking');
            }
            else
            {
              buttonsHTML = '';
              buttonsHTML += '<a href="' + this.options.viewUrl + '/' + data.InstanceId + '" id=""><span class="button blue w-icon"><span>' + this.icons.view + '</span>' + this.labels.view + '</span></a>';
              buttonsHTML += '<span class="button orange w-icon-only archive ui-has-tooltip" data-tooltip-dir="left" data-tooltip="Archive this form" data-action="' + this.options.archiveUrl + '/' + data.InstanceId + '"><span>' + this.icons.archive + '</span></span>';
              data.DisplayName += data.ShareOrDelegate != null && data.ShareOrDelegate != 'null' ? '<span class="tag ' + data.ShareOrDelegate.toLowerCase() + '">' + data.SharedBy + '</span>' : '';
              row = new Element('tr', { 'id': data.InstanceId, 'class': 'form' }).adopt(
                new Element('td', { 'data-name': 'name', 'class': 'indicate none sort-by' + (columnStates.name ? '' : ' hidden'), 'html': data.DisplayName }),
                new Element('td', { 'data-name': 'state', 'class': 'sort-by' + (columnStates.state ? '' : ' hidden'), 'html': data.StateName }),
                new Element('td', { 'data-name': 'to', 'class': 'sort-by' + (columnStates.to ? '' : ' hidden'), 'html': data.CompletedBy }),
                new Element('td', { 'data-name': 'at', 'class': 'ui-inbox-date sort-by ui-format-date' + (columnStates.at ? '' : ' hidden'), 'html': data.StateEnteredAt, 'data-date-format': '%e.%m.%Y %l:%M%p' }),
                new Element('td', { 'data-name': 'effective', 'class': 'ui-inbox-date-effective' + (columnStates.effective ? '' : ' hidden'), 'html': effectiveDate }),
                new Element('td', { 'data-name': 'paypoint', 'class': 'ui-inbox-paypoint' + (columnStates.paypoint ? '' : ' hidden'), 'html': data.PayPoint }),
                new Element('td', { 'class': 'ui-inbox-actions buttons', 'html': buttonsHTML })
              ).inject(this.completedBox.getElement('tbody'));
              row.getElement('.archive').addEvent(Affinity.events.click, this.archiveForm);
            }
            row.querySelectorAll('td')[4].className = effectiveDate !== '' ? 'ui-inbox-date sort-by ui-format-date' : 'ui-inbox-date';
            row.querySelectorAll('td')[4].dataset.dateFormat = effectiveDate !== '' ? '%e.%m.%Y' : null;
          }.bind(this));
          this.completedBox.getElements('.checking').destroy();
        }
        table = this.completedBox.getElement('table');
        if (Affinity.uiSortableGrid) { Affinity.uiSortableGrid.processTable(table); }
        if (Affinity.uiGrid) { Affinity.uiGrid.zebra(table); }
        this.lastdata.Completed = options.data.Completed;
      }

      /* DO Archived */

      if (typeOf(this.lastdata.Archived) === 'null')
      {
        this.lastdata.Archived = {};
      }
      this.archivedIndicator.set('html', options.data.ArchivedCount > 99 ? '99+' : options.data.ArchivedCount);
      if (this.lastdata.Archived != options.data.Archived)
      {
        if (options.data.ArchivedCount == 0)
        {
          this.archivedBox.getElement('.empty').removeClass('hidden');
          this.archivedBox.getElements('.form').destroy();
        }
        else
        {
          this.archivedBox.getElement('.empty').addClass('hidden');
          this.archivedBox.getElements('.form').addClass('checking');

          columnStates = {
            name: this.cookieShowColumn('archive', 'name', true),
            state: this.cookieShowColumn('archive', 'state', true),
            to: this.cookieShowColumn('archive', 'to', true),
            at: this.cookieShowColumn('archive', 'at', true),
            effective: this.cookieShowColumn('archive', 'effective', true),
            paypoint: this.cookieShowColumn('archive', 'paypoint', false)
          };

          Array.each(options.data.Archived, function (data, index)
          {
            var effectiveDate = data.hasOwnProperty('EffectiveDate') && data.EffectiveDate !== null && data.EffectiveDate.trim().toLowerCase() !== 'null' ? data.EffectiveDate : '';
            if (this.archivedBox.getElement('#' + data.InstanceId))
            {
              row = this.archivedBox.getElement('#' + data.InstanceId);
              cols = row.getElements('td');

              cols[0].classList.add('hidden');
              if (columnStates.name) cols[0].classList.remove('hidden');

              cols[1].set('html', data.StateName);
              cols[1].classList.add('hidden');
              if (columnStates.state) cols[1].classList.remove('hidden');

              cols[2].set('html', data.CompletedBy);
              cols[2].classList.add('hidden');
              if (columnStates.to) cols[2].classList.remove('hidden');

              cols[3].set('html', data.StateEnteredAt);
              cols[3].classList.add('hidden');
              if (columnStates.at) cols[3].classList.remove('hidden');

              cols[4].set('html', effectiveDate);
              cols[4].classList.add('hidden');
              if (columnStates.effective) cols[4].classList.remove('hidden');

              cols[5].set('html', data.PayPoint);
              cols[5].classList.add('hidden');
              if (columnStates.paypoint) cols[5].classList.remove('hidden');

              row.removeClass('checking');
            }
            else
            {
              buttonsHTML = '';
              buttonsHTML += '<a href="' + this.options.viewUrl + '/' + data.InstanceId + '" id=""><span class="button blue w-icon"><span>' + this.icons.view + '</span>' + this.labels.view + '</span></a>';
              buttonsHTML += '<span class="button green w-icon-only restore ui-has-tooltip" data-tooltip-dir="left" data-tooltip="Restore this form" data-action="' + this.options.restoreUrl + '/' + data.InstanceId + '"><span>' + this.icons.restore + '</span></span>';
              buttonsHTML += '<span class="button red w-icon-only delete ui-has-tooltip" data-tooltip-dir="left" data-tooltip="Delete this form" data-action="' + this.options.deleteUrl + '/' + data.InstanceId + '"><span>' + this.icons.del + '</span></span>';
              data.DisplayName += data.ShareOrDelegate != null && data.ShareOrDelegate != 'null' ? '<span class="tag ' + data.ShareOrDelegate.toLowerCase() + '">' + data.SharedBy + '</span>' : '';
              data.CompletedBy = data.CompletedBy != null && data.CompletedBy != 'null' ? '<span class="tag ' + data.CompletedBy.toLowerCase() + '">' + data.CompletedBy + '</span>' : 'N/A';
              row = new Element('tr', { 'id': data.InstanceId, 'class': 'form' }).adopt(
                new Element('td', { 'data-name': 'name', 'class': 'indicate none sort-by' + (columnStates.name ? '' : ' hidden'), 'html': data.DisplayName }),
                new Element('td', { 'data-name': 'state', 'class': 'sort-by' + (columnStates.state ? '' : ' hidden'), 'html': data.StateName }),
                new Element('td', { 'data-name': 'to', 'class': 'sort-by' + (columnStates.to ? '' : ' hidden'), 'html': data.CompletedBy }),
                new Element('td', { 'data-name': 'at', 'class': 'ui-inbox-date sort-by ui-format-date' + (columnStates.at ? '' : ' hidden'), 'html': data.StateEnteredAt, 'data-date-format': '%e.%m.%Y %l:%M%p' }),
                new Element('td', { 'data-name': 'effective', 'class': 'ui-inbox-date-effective' + (columnStates.effective ? '' : ' hidden'), 'html': effectiveDate }),
                new Element('td', { 'data-name': 'paypoint', 'class': 'ui-inbox-paypoint' + (columnStates.paypoint ? '' : ' hidden'), 'html': data.PayPoint }),
                new Element('td', { 'class': 'ui-inbox-actions buttons', 'html': buttonsHTML })
              ).inject(this.archivedBox.getElement('tbody'));
              row.getElement('.restore').addEvent(Affinity.events.click, this.restoreForm);
              row.getElement('.delete').addEvent(Affinity.events.click, this.deleteForm);
            }
            row.querySelectorAll('td')[4].className = effectiveDate !== '' ? 'ui-inbox-date sort-by ui-format-date' : 'ui-inbox-date';
            row.querySelectorAll('td')[4].dataset.dateFormat = effectiveDate !== '' ? '%e.%m.%Y' : null;
          }.bind(this));
          this.archivedBox.getElements('.checking').destroy();
        }
        table = this.archivedBox.getElement('table');
        if (Affinity.uiSortableGrid) { Affinity.uiSortableGrid.processTable(table); }
        if (Affinity.uiGrid) { Affinity.uiGrid.zebra(table); }
        this.lastdata.Archived = options.data.Archived;
      }

      /**/
      
      Affinity.prompts.hide();
      Affinity.tooltips.processNew();
      Affinity.uiFormatDate.processNew();

      delete table;

    }

    /**/

    this.mobileIndicateScroll();

    window.fireEvent('ResizeFrame');

  },

  selectInbox: function (options)
  {

    var index = this.inbox.getElements('.ui-inbox-labels ul li').indexOf(options.menuItem);

    this.boxCookie = Cookie.write('uiInboxIndex', index, { duration: this.options.expireTabCookie ? (1 / 24 / 60) * this.options.expireTabMins : 1 });

    this.tabIndex = index;

    this.mobileIndicateScroll();

    /**/

    window.fireEvent('ResizeFrame');

  },

  archiveForm: function (e)
  {
    var target = e.target.hasClass('button') ? e.target : e.target.getParent('.button');
    var action = target.get('data-action');
    var row = target.getParent('tr');
    var promptMessage = this.labels.archive;
    var doneMessage = this.labels.archiving;
    var inbox = this.inbox;
    uiconfirm({
      message: promptMessage,
      onOk: function ()
      {
        window.uialert({
          message: doneMessage,
          showLoader: true,
          noClose: true
        });
        new CFRequest({
          method: 'post',
          url: action,
          onSuccess: function ()
          {
            Affinity.prompts.hide();
            row.destroy();
            Affinity.uiGrid.zebra();
            window.uialert({
              message: 'Loading',
              showLoader: true,
              noClose: true
            });
            Affinity.uiInbox.startRefresh(inbox);
          }
        }).send();
      }
    });
  },

  restoreForm: function (e)
  {
    var target = e.target.hasClass('button') ? e.target : e.target.getParent('.button');
    var action = target.get('data-action');
    var row = target.getParent('tr');
    var promptMessage = this.labels.restore;
    var doneMessage = this.labels.restoring;
    var inbox = this.inbox;
    uiconfirm({
      message: promptMessage,
      showLoader: true,
      onOk: function ()
      {
        window.uialert({
          message: doneMessage,
          showLoader: true,
          noClose: true
        });
        new CFRequest({
          method: 'post',
          url: action,
          onSuccess: function ()
          {
            Affinity.prompts.hide();
            row.destroy();
            Affinity.uiGrid.zebra();
            window.uialert({
              message: 'Loading',
              showLoader: true,
              noClose: true
            });
            Affinity.uiInbox.startRefresh(inbox);
          }
        }).send();
      }
    });
  },

  deleteForm: function (e)
  {
    var target = e.target.hasClass('button') ? e.target : e.target.getParent('.button');
    var action = target.get('data-action');
    var row = target.getParent('tr');
    var promptMessage = this.labels.delete;
    var doneMessage = this.labels.deleting;
    uiconfirm({
      message: promptMessage,
      showLoader: true,
      onOk: function ()
      {
        window.uialert({
          message: doneMessage,
          showLoader: true,
          noClose: true
        });
        new CFRequest({
          method: 'post',
          url: action,
          onSuccess: function ()
          {
            Affinity.prompts.hide();
            row.destroy();
            Affinity.uiGrid.zebra();
            Affinity.uiInbox.refresh();
          }
        }).send();
      }
    });
  },

  startNewForm: function ()
  {
    Affinity.modal.setElement(
      document.getElement('.start-template').clone().removeClass('hidden')
    );
    Affinity.modal.modalbody.getElement('.cancel').addEvent(Affinity.events.click, function ()
    {
      Affinity.modal.hide();
    });
    Affinity.modal.modalbody.getElement('.start').addEvent(Affinity.events.click, function ()
    {
      Affinity.modal.modalbody.getElement('.start').addClass('hidden');
      new Element('img', { 'src': document.config.loaders.light , 'style': 'display: inline-block; margin-right:20px;' }).inject(Affinity.modal.modalbody.getElement('.start'), 'after');
    });
    Affinity.modal.scroll.disable();
    Affinity.modal.close.disable();
    Affinity.modal.show();
    if (Affinity.modal.modalbody.getElement('.do-autocomplete'))
    {
      var select = Affinity.modal.modalbody.getElement('.do-autocomplete');
      select.removeClass('do-autocomplete');
      //Affinity.uiAutoComplete.doAutoComplete(select);
      var ac = new UIAutoCompleteWidget({
        selectElement: select,
        onComplete: function ()
        {
          ac.displayElement.focus();
        }
      });
    }
  },

  formSelected: function ()
  {
    document.getElement('.content select').selectedIndex = Affinity.modal.modalbody.getElement('select').selectedIndex;
    Affinity.modal.hide();
    //document.getElement('form').submit();
  },

  /**/

  mobileIndicateScroll: function ()
  {
    clearTimeout(this.scrollMessageAutoClose);
    window.removeEventListener(Affinity.events.click, this.mobileIndicateScrollHide);
    var boxes = this.inbox.querySelectorAll('.ui-inbox-box');
    var box = boxes[this.tabIndex];
    var table = box.querySelector('table');
    if ((Affinity.mobile || Affinity.ismobile) && this.scrollMessage && table.parentNode.scrollWidth > table.parentNode.clientWidth)
    {
      this.scrollMessage.classList.add('show');
      this.scrollMessageAutoClose = setTimeout(this.mobileIndicateScrollHide, 5000);
      window.addEventListener(Affinity.events.click, this.mobileIndicateScrollHide);
    }
  },
  mobileIndicateScrollHide: function ()
  {
    clearTimeout(this.scrollMessageAutoClose);
    window.removeEventListener(Affinity.events.click, this.mobileIndicateScrollHide);
    if (this.scrollMessage) this.scrollMessage.classList.remove('show');
  }

});;
var CFMulitFileUploaders = new Class({

    Implements: [Options, Events],

    Binds: [
        'fileAdded', 'fileDeleted', 'fileDefaultsLoaded',
        'fileAddedComplete',
        'fileTooLarge',
        'deleteNotSaved'
    ],

    options: {
        instanceId: null,
        addApi: '/document/Add',
        deleteApi: '/document/Delete',
        getNamesApi: '/document/GetFileIdNamePairs',
        downloadFileApi: '/document/Download'
    },

    initialize: function (options)
    {

        this.setOptions(options);

        this.deleteMessage = "Deleting File. Please wait...";

        window.addEvent('multiFileAdded', this.fileAdded);

        window.addEvent('multiFileTooLarge', this.fileTooLarge);

        window.addEvent('multiFileDeleted', this.fileDeleted);

        window.addEvent('multiFileDefaults', this.fileDefaultsLoaded);

        if (Affinity && Affinity.hasOwnProperty('Uplaoders'))
        {
            var nodes = document.querySelectorAll('.uploadmulti:not(.uidone)');
            if (nodes.length > 0)
            {
                Affinity.Uplaoders.processNew();
            }
        }

    },

    fileTooLarge: function (data) {

        var maxsize = (data.maxsize / 1024 / 1024).round(2);
        var size = (data.size / 1024 / 1024).round(2);

        window.uialert({
            message: 'This file is too large. The maximum size is ' + maxsize + 'MB and this file is ' + size + 'MB.'
        });

    },


    fileAdded: function (data) {

    },

    fileDefaultsLoaded: function (data)
    {
        this.table = data.table;

        new CFRequest.JSON({
            url: this.options.getNamesApi,
            onSuccess: function (fileNameData) {

                var jsonData = fileNameData;
                if (typeOf(jsonData) == 'string') {
                    jsonData = JSON.parse(jsonData);
                }

                Array.each(data.table.getElements('tbody tr'), function (row) {
                    if (jsonData.data[row.retrieve('fileId')]) {
                        row.getElement('td').set('html', jsonData.data[row.retrieve('fileId')]);
                        row.store('dowloadUrl', this.options.downloadFileApi);
                    }
                }.bind(this));

                if (this.options.deleteApi == '' || this.options.deleteApi == null) {
                    Array.each(data.table.getElements('tbody tr'), function (row) {
                        row.getElements('td').getLast().destroy();
                    });
                    Array.each(data.table.getElements('thead tr'), function (row) {
                        row.getElements('th').getLast().destroy();
                    });
                }

                if (this.options.addApi == '' || this.options.addApi == null)
                {
                    if (data.table.getParent('.uploadmulti').getElement('.button.green')) data.table.getParent('.uploadmulti').getElement('.button.green').destroy();
                    if (data.table.getParent('.uploadmulti').getElement('.button.blue')) data.table.getParent('.uploadmulti').getElement('.button.blue').destroy();
                }

            }.bind(this)

        }).post({
            fileIds: data.initialValues
        });

    },

    fileDeleted: function (data) {

        window.uialert({
            message: this.deleteMessage,
            noClose: true
        });

        this.table = data.table;

        new CFRequest.JSON({
            url: this.options.deleteApi,
            onSuccess: function (result) {
                this.posting = false;
                Affinity.prompts.hide();
                if (result.Success) {
                    if (data.row) {
                        data.row.destroy();
                    }
                } else {
                    window.uialert({
                        message: 'You are not allowed to delete this file.'
                    });
                }
            }
        }).post({
            fileId: data.deletedId,
            questionName: data.questionName,
            instanceId: this.options.instanceId,
            isAuto: false
        });
    }
});;

var CFNameCreator = new Class({

    Implements: [Options],

    Binds: [
        'createName'
    ],

    options: {
        nameInput: null,
        fromInput: null,
        maxLength: 64,
        suffix: '',
        extraEntropy: false,
        camelCase: true,
        onComplete: function () { }
    },

    initialize: function (options) {

        this.setOptions(options);

        if (this.options.nameInput && this.options.nameInput.value == '') {
            this.options.fromInput.addEvent('keyup', this.createName);
            this.options.fromInput.addEvent('blur', this.createName);
            //this.createName();
        }

    },

    createName: function () {
        var length = this.options.maxLength;
        length -= 8; // allow string suffix "{name}-edit" or "{name}-display"
        var str = this.options.fromInput.value.replace(/[^\w\d ]/g, '').trim();
        str = str.length > length ? str.lastIndexOf(' ', length) > -1 ? str.substring(0, str.lastIndexOf(' ', length)) : str.substring(0, length) : str;
        str = str + this.options.suffix;
        if (this.options.camelCase) {
            str = str.replace(/(?:^\w|[A-Z]|\b\w)/g, function (l, i) { return i == 0 ? l.toLowerCase() : l.toUpperCase(); }).replace(/\s+/g, '').trim();
        }else{
            str = str.replace(/\s+/g, '').trim();
        }
        if (this.options.extraEntropy) {
            str += '_' + String.uniqueID() + '_' + new Date().getTime();
        }
        this.options.nameInput.value = str;
        this.options.onComplete(str);
    }
    
    

});;
var CFTemplateBase = new Class({

    Implements: [Options],

    Binds: [
        'killPopup',
        'initted',
        'toggleExample',
        'validationFailed',
        'postForm',
        'postSuccess','postError'
    ],
    
    options: {
        templateCssClass: null,
        autoGenerateName: true,
        nativePost: false
    },

    popupElement: null,
    form: null,
    formMethod: null,
    formAction: null,
    callerItem: null,
    section: null,

    initialize: function (options) {

        this.setOptions(options);

        if (this.options.templateCssClass == null) {
            //throw new ReferenceError('No templateCssClass was specified');
            this.killPopup('There was an error adding this element type to the form.\r\n<!--\r\nNo templateCssClass was specified.\r\n-->');
            return;
        }
        if (!document.callerElement) {
            //throw new ReferenceError('No selected item was specified (document.callerElement)');
            this.killPopup('There was an error adding this element type to the form.\r\n<!--\r\nNo selected item was specified (document.callerElement).\r\n-->');
            return;
        }

        this.popupElement = document.getElement('.question-content.' + this.options.templateCssClass);
        
        if (!this.popupElement) {
            //throw new ReferenceError('Found no popup content with class "question-content ' + this.options.templateCssClass + '"');
            this.killPopup('You can not use this component in this form.\r\n<!--\r\nFound no popup content with class "question-content ' + this.options.templateCssClass + '".\r\nPlease check Requests for 500 errors fetching element content.\r\n-->');
            return;
        }
        if (!this.popupElement.getParent('form')) {
            //throw new ReferenceError('Found no form in popup content with class "question-content ' + this.options.templateCssClass + '"');
            this.killPopup('You can not use this component in this form.\r\n<!--\r\nFound no form in popup content with class "question-content ' + this.options.templateCssClass + '".\r\nPlease check Requests for 500 errors fetching element content.\r\n-->');
            return;
        }

        this.form = this.popupElement.getParent('form');
        this.formMethod = this.form.get('method').toLowerCase();
        this.formAction = this.form.get('action');

        if (!this.options.nativePost) {
            this.formPost = new CFRequest({
                url: this.formAction,
                method: this.formMethod,
                onSuccess: this.postSuccess,
                onError: this.postError,
                onFailure: this.postError
            });

            this.formPost.setHeader('Accept', 'Accept:text/javascript, text/html, application/xml, text/xml, */*');

            this.form.adopt(new Element('input', { type: 'hidden', name: 'ReturnPath', value: 'default' }));

        } else {
            
            this.form.adopt(new Element('input', { type: 'hidden', name: 'ReturnPath', value: 'referrer' }));

        }

        this.callerItem = document.callerElement;
        this.section = this.callerItem.getParents('.form-section')[0];
        this.creating = this.formAction.toLowerCase().indexOf('create')>-1;

        if (this.form.getElement('.cancel')){
            this.form.getElement('.cancel').addEvent('click', function (e) {
                e.preventDefault();
                Affinity.modal.hide();
                if (this.creating && this.callerItem) {
                    document.getElement('#availableFormItems .master-' + this.callerItem.get('data-type').toLowerCase().trim()).removeClass('disabled');
                    this.callerItem.destroy();
                }
            }.bind(this));
        }

        /* hide / show button loaders on click */

        this.save = this.form.getElement('button.save');
        this.cancel = this.form.getElement('button.cancel');

        this.loader = new Element('div', { 'class': 'loader hidden' }).adopt(
            new Element('span', { 'html': '<img src="' + document.config.loaders.light + '" />&nbsp;' }),
            new Element('span', {'html':'Saving...'})
        ).inject(this.cancel, 'after');

        this.save.addEvent(Affinity.events.click, function () {

            this.save.addClass('hidden');
            this.cancel.addClass('hidden');
            this.loader.removeClass('hidden');

        }.bind(this));

        /**/

        if (this.section) {
            this.form.getElement('#hiddenSectionName').value = this.section.get('data-item-name');
        }

        if(this.form.getElement('.hideshowpreview')){
            this.form.getElement('.hideshowpreview').addEvent(Affinity.events.click, this.toggleExample);
            this.exampleFx = new Fx.Reveal(this.form.getElement('.preview'), { duration: 250, mode: 'vertical' });
            this.form.getElement('.preview').setStyle('display','none');
            this.form.getElement('.preview').removeClass('hidden');
        }

        if (this.options.autoGenerateName) {

            var suffix = '';
            if (this.options.templateCssClass.test('fielddisplay', 'gi')) {
                suffix = '-display';
            }
            if (this.options.templateCssClass.test('fieldedit', 'gi')) {
                suffix = '-edit';
            }

            new CFNameCreator({
                nameInput: this.form.getElement('#name'),
                fromInput: this.form.getElements('#text,#shorttext,#title')[0],
                suffix: suffix
            });
        }

        new UIFormValidation({
            target: this.form,
            onValidateCallback: this.postForm,
            onValidateFailCallback: this.validationFailed
        });

        if (this.form && this.save) {
            this.save.removeClass('hidden');
        }

        this.initted();
        
    },

    killPopup: function (message) {
        uialert({
            message: message,
            showButtons: true,
            noClose: false
        });
        if (document.callerElement && typeOf(document.callerElement) === 'element') {
            document.callerElement.destroy();
        }
        Affinity.modal.clear();
        Affinity.modal.hide();
    },

    initted: function () {
    },

    toggleExample: function (e) {
        e.preventDefault();
        this.exampleFx.toggle();
        var toggle = document.getElement('#preview-toggle-icon');
        if (toggle.hasClass('icon-arrow-line-down')) {
            toggle.addClass('icon-arrow-line-up');
            toggle.removeClass('icon-arrow-line-down');
        }
        else if (toggle.hasClass('icon-arrow-line-up')) {
            toggle.addClass('icon-arrow-line-down');
            toggle.removeClass('icon-arrow-line-up');
        }
    },
    
    validationFailed: function() {
        this.save.removeClass('hidden');
        this.cancel.removeClass('hidden');
        this.loader.addClass('hidden');
    },

    postForm: function () {

        var postData = {};
        var inputs = this.form.getElements('input,select,textarea');
        Array.each(inputs, function (input, index) {
            if (input.get('name')) {
                if (input.get('type') == 'checkbox') {
                    postData[input.get('name')] = input.checked;
                } else if (input.get('type') == 'radio') {
                    var radios = this.form.getElements('input[name=' + input.get('name') + ']');
                    var checked = null;
                    Array.each(radios, function (radio, index) {
                        if (radio.checked) {
                            checked = radio;
                        }
                    }.bind(this));
                    if (checked !== null) {
                        postData[checked.get('name')] = checked.value;
                    }
                } else {
                    postData[input.get('name')] = input.value;
                }
            }
        }.bind(this));

        if (postData.type !== undefined) {
            if (postData.type === 'FieldEdit'
                && postData.name.lastIndexOf('_') !== postData.name.length - 1) {
                postData.name = postData.name + '_';
            } else if (postData.type !== 'FieldEdit'
                && postData.type !== 'FieldDisplay'
                && postData.name.lastIndexOf('_') !== postData.name.length - 1) {
                postData.name = postData.name + String.uniqueID() + '_';
            }
        }
       
        this.name = postData.name;

        if (this.options.nativePost) {

            this.form.getElement('#name').value = this.name;
            this.form.submit();

        } else {

            if (this.formMethod == 'get') {
                this.formPost.get(postData);
            } else {
                this.formPost.post(postData);
            }

        }

        delete postData;

    },

    postSuccess: function (response) {

        var name = '';
        var display = '';

        if (this.form.getElement('#title')) {
            this.callerItem.getElement('.form-element-title').set('html', this.form.getElement('#title').value);
            display = this.form.getElement('#title').value;
        } else if (this.form.getElement('#shorttext')) {
            this.callerItem.getElement('.form-element-title').set('html', this.form.getElement('#shorttext').value);
            display = this.form.getElement('#shorttext').value;
        } else if (this.form.getElement('#text')) {
            this.callerItem.getElement('.form-element-title').set('html', this.form.getElement('#text').value);
            display = this.form.getElement('#text').value;
        }

        this.callerItem.set('data-item-name', this.name);

        this.loader.addClass('hidden');

        Affinity.modal.hide();
    },


    postError: function (e) {

        var data = false;
        var message = 'Something went wrong. This is most likely due to a naming conflict. Try changing the \'short display text\'.';

        if (typeOf(e.response)=='string') {
            try{
                data = JSON.decode(e.response);
            }catch(_e){}
        } else if(typeOf(e.responseText)=='string'){
            try{
                data = JSON.decode(e.responseText);
            }catch(_e){}
        }

        if(typeOf(data.message)=='string' && data.message!==''){
            message = data.message;
        }

        if(typeOf(data.systemMessage)=='string' && data.systemMessage!==''){
            message = data.systemMessage;
        }

        window.uialert({
            message: message
        });

        this.save.removeClass('hidden');
        this.cancel.removeClass('hidden');
        this.loader.addClass('hidden');

    }

});

window.cfTemplateTypes = {};
// This object is populated by each template js in the following format:
// window.cfTemplateTypes.eventname = { name: 'eventname', objectname:'CFTemplateObject',  object: CFTemplateObject };

window.addEvent('TemplateReady', function (e) {

    //if (typeOf(console.log) == 'function') { console.log('event heard: "TemplateReady" with type "' + e.type + '"'); }

    if (window.cfTemplateTypes[e.type] !== null && typeOf(window.cfTemplateTypes[e.type].object) === 'class') {

       // if (typeOf(console.log) == 'function') { console.log('Template Object "' + window.cfTemplateTypes[e.type].objectname + '" exists'); }

        window.cfCurrentTemplateObject = new window.cfTemplateTypes[e.type].object({
            templateCssClass: window.cfTemplateTypes[e.type].name
        });


        Affinity.tooltips.processNew();

    }

});;

var CFindex = new Class({

    Implements: [Options, Events],

    Binds: [
		'archiveClicked',
        'archiveDeleteClicked',
        'undoArchiveClicked'
    ],


    Options: {
        nameMaxLength: 100
    },

    initialize: function (options) {

        this.setOptions(options);

        /**/

        Array.each(document.getElements('.button.archive'), function (button) {
            button.addEvent(Affinity.events.click, this.archiveClicked);
        }.bind(this));

        Array.each(document.getElements('.button.archivedelete'), function (button) {
            button.addEvent(Affinity.events.click, this.archiveDeleteClicked);
        }.bind(this));

        Array.each(document.getElements('.button.undoarchive'), function (button) {
            button.addEvent(Affinity.events.click, this.undoArchiveClicked);
        }.bind(this));

        /**/

        var doToolTips = false;

        Array.each(document.getElements('table .form-desc'), function (td) {
            var html = td.get('html');
            if (html.length > this.options.nameMaxLength) {
                td.set('data-tooltip', html);
                td.set('data-tooltip-dir', 'top');
                td.set('html', html.substr(0,30) + ' ...');
                td.addClass('ui-has-tooltip');
                doToolTips = true;
            }
        }.bind(this));

        if(doToolTips){
            Affinity.tooltips.processNew();
        }

        /**/

        Array.each(document.getElements('table .form-workflow'), function (td) {
            var html = td.get('html');
            if (html == '') {
                td.set('html', 'No Workflow');
            } else {
                td.set('html', html.split(',').join(', '));
            }
        }.bind(this));

        /**/

        document.getElements('.button.locked').addEvent(Affinity.events.click, this.unlock);

        /**/

        var unArchivedTemplateId = Affinity.CookieMonster.Read('undo-archive') || false;
        if (unArchivedTemplateId) {
            Affinity.CookieMonster.Delete('undo-archive');
            if (document.id(unArchivedTemplateId)) {
                window.scrollTo(0, document.id(unArchivedTemplateId).getPosition().y);
            }
        }

        /**/

        window.fireEvent('ResizeFrame');

    },

    unlock: function (e) {
        if (e.control) {
            var row = e.target.getParent('tr');
            if(row){
                var lockPlaceholder = row.getElement('.button.locked');
                var deleteButton = row.getElement('.button.archive');
                if (lockPlaceholder && deleteButton) {
                    lockPlaceholder.addClass('hidden');
                    deleteButton.removeClass('hidden');
                    (function () {
                        deleteButton.addClass('hidden');
                        lockPlaceholder.removeClass('hidden');
                    }).delay(2000);
                }
            }
        }
    },

    archiveClicked: function (e) {

        uiconfirm({
            message: 'Are you sure you would like to archive this form?',
            onOk: function () {

                var button = e.target.hasClass('button') ? e.target : e.target.getParent('.button');
                var form = new Element('form', { 'action': button.get('data-action'), 'method': 'post', 'target': '_self' }).inject(button, 'after');
                new Element('input', { 'type': 'hidden', 'name': 'templateId', 'value': button.get('data-templateId') }).inject(form);
                form.submit();

            }.bind(this)
        });

    },

    undoArchiveClicked: function (e) {
        var button = e.target.hasClass('button') ? e.target : e.target.getParent('.button');
        var buttonColumn = button.getParent();
        var form = new Element('form', { 'action': button.get('data-action'), 'method': 'post', 'target': '_self' }).inject(buttonColumn, 'bottom');
        new Element('input', { 'type': 'hidden', 'name': 'templateId', 'value': button.get('data-templateId') }).inject(form);
        uialert({
            message: 'Restoring...',
            showLoader: true,
            showButtons: false
        });
        Affinity.CookieMonster.Write('undo-archive', button.get('data-templateId'));
        form.submit();
    },

    archiveDeleteClicked: function (e) {

        uiconfirm({
            message: 'Are you sure you would like to delete this archived form?',
            onOk: function () {

                var button = e.target.hasClass('button') ? e.target : e.target.getParent('.button');
                var form = new Element('form', { 'action': button.get('data-delete-action'), 'method': 'post', 'target': '_self' }).inject(button, 'after');
                new Element('input', { 'type': 'hidden', 'name': 'templateId', 'value': button.get('data-delete-id') }).inject(form);
                form.submit();

            }.bind(this)
        });

    }

});;
/*                                                                                  *
 * This script belongs to the cf (CleverForms) package.                             *
 *                                                                                  *
 * The following code assumes MooTools Core 1.4.5 has been included.                *
 *                                                                                  */


/**
 * @class CWInit
 *
 * The main frontend initilizer.
 *
 */
var CFInit = new Class({

  Implements: [Options, Events],

  Binds: [
    'init'
  ],

  Options: {

  },

  isProperBrowser: true,
  parentWindow: null,

  initialize: function (options)
  {
    this.setOptions(options);
    if (Browser.ie && Browser.version < 11)
    {
      this.isProperBrowser = false;
    }
    if (this.isProperBrowser)
    {
      this.parentWindow = window.parent.document;
    }
  }

});

if (!('Affinity2018' in window)) Affinity2018 = {};
if (!('Classes' in Affinity2018)) Affinity2018.Classes = {};
if (!('Apps' in Affinity2018.Classes)) Affinity2018.Classes.Apps = {};
if (!('Plugins' in Affinity2018.Classes)) Affinity2018.Classes.Plugins = {};
if (!('CleverForms' in Affinity2018.Classes.Apps)) Affinity2018.Classes.Apps.CleverForms = {};

(function ()
{

  if (!Array.prototype.contains)
  {
    Array.prototype.contains = function (mixed)
    {
      return this.indexOf(mixed) !== -1;
    };
  }
  if (!Array.prototype.includes) Array.prototype.includes = Array.prototype.contains;

  if (!Array.prototype.bindEachToClassScope)
  {
    Array.prototype.bindEachToClassScope = function (bindto)
    {
      this.forEach(function (fn)
      {
        if (
          bindto[fn]
          && typeof bindto[fn] === 'function'
        )
        {
          bindto[fn] = bindto[fn].bind(bindto);
        }
      }.bind(bindto));
    };
  }
  if (!Array.prototype.bindEach) Array.prototype.bindEach = Array.prototype.bindEachToClassScope;

  if (!String.prototype.includes)
  {
    String.prototype.includes = function (search, start)
    {
      'use strict';
      if (typeof start !== 'number') start = 0;
      if (start + search.length > this.length) { return false; } else { return this.indexOf(search, start) !== -1; }
    };
  }

  if (!String.prototype.contains)
  {
    String.prototype.contains = function (str)
    {
      return new RegExp(str.escapeRegExp(), 'gi').test(this);
      //return this.indexOf(str) > -1;
    };
  }

  if (window.NodeList && !NodeList.prototype.forEach && Array.prototype.forEach)
  {
    NodeList.prototype.forEach = Array.prototype.forEach;
  }

  /**/

  if (!Affinity2018.hasOwnProperty('isString'))
  {
    Affinity2018.isString = function (obj)
    {
      return typeof obj === 'string';
    };
  }

  if (!Affinity2018.hasOwnProperty('isEvent'))
  {
    Affinity2018.isEvent = function (ev)
    {
      if (!ev || ev === null || ev === undefined || ev === 'undefined') return false;
      if (Affinity2018.isString(ev) || Affinity2018.isBool(ev) || Affinity2018.isDate(ev) || Affinity2018.isMethod(ev)) return false;
      if (ev && ev instanceof Event) return true;
      if (ev && 'originalEvent' in ev && ev.originalEvent instanceof Event) return true;
      return false;
    };
  }

  if (!Affinity2018.hasOwnProperty('isArray'))
  {
    Affinity2018.isArray = function (obj)
    {
      return Array.isArray(obj);
    };
    Affinity2018.isArrayReturn = function (obj)
    {
      return Affinity2018.isArray(obj) ? obj : false;
    };
  }

  if (!Affinity2018.hasOwnProperty('isBool'))
  {
    Affinity2018.isBool = function (obj)
    {
      return obj !== null && typeof obj === 'boolean';
    };
    Affinity2018.isBoolReturn = function (obj)
    {
      return Affinity2018.isBool(obj) ? obj : false;
    };
  }

  if (!Affinity2018.hasOwnProperty('isWindow'))
  {
    Affinity2018.isWindow = function (obj)
    {
      return obj != null && obj === obj.window;
    };
    Affinity2018.isWindowReturn = function (obj)
    {
      return Affinity2018.isWindow(obj) ? obj : false;
    };
  }

  if (!Affinity2018.hasOwnProperty('isObject'))
  {
    Affinity2018.isObject = function (obj)
    {
      if (obj === null || typeof obj !== "object" || obj.nodeType || Affinity2018.isWindow(obj))
      {
        return false;
      }
      if (
        obj.constructor
        && !hasOwnProperty.call(obj.constructor.prototype, "isPrototypeOf")
      )
      {
        return false;
      }
      return true;
    };
    Affinity2018.isObjectReturn = function (obj)
    {
      return Affinity2018.isObject(obj) ? obj : false;
    };
  }

  if (!Affinity2018.hasOwnProperty('isEmptyObject'))
  {
    Affinity2018.isEmptyObject = function (obj)
    {
      for (var n in obj)
      {
        return false;
      }
      return true;
    };
  }

  /**/

  if (!(Affinity2018.hasOwnProperty('FormatString')))
  {
    Affinity2018.FormatString = function (string, args)
    {
      if (typeof string === 'object')
      {
        string = Object.keys(string).map(function (key)
        {
          return string[key]
        }).join('')
      }
      if (args.length === 1 && Affinity2018.isObject(args[0]))
      {
        var obj = args[0], key, regex, regexp;
        for (key in obj)
        {
          if (obj.hasOwnProperty(key))
          {
            string = string.replace(new RegExp('{' + key + '}', 'g'), obj[key]);
          }
        }
        return string;
      }
      else
      {
        return string.replace(/{(\d+)}/g, function (match, number)
        {
          return typeof args[number] != 'undefined' ? args[number] : match;
        });
      }
    };
  }

  if (!String.prototype.format)
  {
    String.prototype.format = function ()
    {
      var args = [].slice.call(arguments);
      return Affinity2018.FormatString(this, args);
    };
  }
  if (!String.format)
  {
    String.format = function ()
    {
      var args = [].slice.call(arguments);
      return Affinity2018.FormatString(this, args);
    };
  }

  /**/

  Affinity2018.Storage = new class
  {
    constructor()
    {
      this.Session = {};
      this.Session.Has = this.HasSession;
      this.Session.Get = this.GetSession;
      this.Session.Set = this.SetSession;
      this.Session.Del = this.DelSession;
      this.Local = {};
      this.Local.Has = this.HasLocal;
      this.Local.Get = this.GetLocal;
      this.Local.Set = this.SetLocal;
      this.Local.Del = this.DelLocal;
    }
    /**/
    HasSession(name)
    {
      return window.sessionStorage.getItem(name) !== null;
    }
    GetSession(name)
    {
      let data = window.sessionStorage.getItem(name);
      if (data !== null)
      {
        if (Affinity2018.isString(data) && ['true', 'false'].contains(data.trim().toLowerCase()))
        {
          if (data.trim().toLowerCase() === 'true') return true;
          if (data.trim().toLowerCase() === 'false') return false;
        }
        if (Affinity2018.isNumeric(data) && Affinity2018.isString(data) && data.contains('.'))
        {
          return parseFloat(data);
        }
        if (Affinity2018.isNumeric(data) && Affinity2018.isString(data) && !data.contains('.'))
        {
          return parseInt(data);
        }
        try
        {
          return JSON.parse(unescape(data));
        }
        catch (err) { }
        return unescape(data);
      }
      return false;
    }
    SetSession(name, data)
    {
      if (!Affinity2018.isString(data)) data = JSON.stringify(data);
      window.sessionStorage.setItem(name, escape(data));
    }
    DelSession(name)
    {
      window.sessionStorage.removeItem(name);
    }
    /**/
    HasLocal(name)
    {
      return window.localStorage.getItem(name) !== null;
    }
    GetLocal(name)
    {
      let data = window.localStorage.getItem(name);
      if (data !== null)
      {
        try
        {
          return JSON.parse(unescape(data));
        }
        catch (err) { }
        return data;
      }
      return false;
    }
    SetLocal(name, data)
    {
      if (!Affinity2018.isString(data)) data = JSON.stringify(data);
      window.localStorage.setItem(name, escape(data));
    }
    DelLocal(name)
    {
      window.localStorage.removeItem(name);
    }
  };

  /**/

  new class
  {
    constructor()
    {
      ['init', 'onkey', 'set'].bindEach(this);
      this.scrollStyleNode = false;
      Affinity2018.DarkMode = false;
      if (!document.body) document.addEventListener("DOMContentLoaded", this.init);
      else this.init();
    }

    init()
    {
      if (!document.querySelector('style.scrollbars'))
      {
        this.scrollStyleNode = document.createElement('style');
        this.scrollStyleNode.nonce = 'a9e3b03a6fd6ba6582578c3ad5393ee54b2b6acb==';
        document.body.appendChild(this.scrollStyleNode);
      }
      Affinity2018.DarkMode = document.body.classList.contains('dark') ? true : false;
      if (Affinity2018.Storage.Local.Has('dark-mode')) Affinity2018.DarkMode = Affinity2018.Storage.Local.Get('dark-mode');
      if (window.location.href.contains('#dark'))
      {
        Affinity2018.DarkMode = true;
        Affinity2018.Storage.Local.Set('dark-mode', Affinity2018.DarkMode);
      }
      this.set();
      window.addEventListener('keyup', this.onkey);
      Affinity2018.CheckDarkMode = this.set;
    }

    onkey(ev)
    {
      if (ev.ctrlKey && ev.altKey && (ev.key === "d" || ev.key === "D"))
      {
        Affinity2018.DarkMode = !Affinity2018.DarkMode;
        Affinity2018.Storage.Local.Set('dark-mode', Affinity2018.DarkMode);
        this.set();
      }
    }

    set()
    {
      if (Affinity2018.DarkMode)
      {
        var color = '#222';
        if (document.body.classList.contains('dashboard')) color = '#222';
        document.body.classList.add('dark');
        var template = `
        ::-webkit-scrollbar-track {
          background: {0};
        }
        ::-webkit-scrollbar-thumb {
          border: 2px solid {0};
        }
        ::-webkit-resizer {
          background: {0};
        }
        `;
        this.scrollStyleNode.innerHTML = template.format(color);
      }
      else
      {
        var color = '#f5fafe';
        if (document.body.classList.contains('dashboard')) color = '#ddd';
        document.body.classList.remove('dark');
        var template = `
        ::-webkit-scrollbar-track {
          background: {0};
        }
        ::-webkit-scrollbar-thumb {
          border: 2px solid {0};
        }
        ::-webkit-resizer {
          background: {0};
        }
        `;
        this.scrollStyleNode.innerHTML = template.format(color);
      }
    }

  };

})();

window.addEvent('PageReady', function () {
  document.cwInit = new CFInit();
});;
/*                                                                                  *
 * This script belongs to the cf (CleverForms) package.                             *
 *                                                                                  *
 * The following code assumes MooTools Core 1.4.5 has been included.                *
 *                                                                                  */


/**
 * @class CFRequest
 *
 * Cleverforms Request class.
 *
 */

(function () {
    var handleUnauthorized = function (r, scope) {
        if (r == "401 Unauthorized") {
            window.location.href = "/Authentication/SignOut";
        } else {
            scope.parent(r);
        }
    }

    window.CFRequest = new Class({
        Extends: Request,
        success: function (r) { handleUnauthorized(r, this) },
        failure: function (r) { handleUnauthorized(r, this) }
    });

    CFRequest.HTML = new Class({
        Extends: Request.HTML,
        success: function (r) { handleUnauthorized(r, this) },
        failure: function (r) { handleUnauthorized(r, this) }
    });

    CFRequest.JSON = new Class({
        Extends: Request.JSON,
        success: function (r) { handleUnauthorized(r, this) },
        failure: function (r) { handleUnauthorized(r, this) }
    });

    CFRequest.JSONP = new Class({
        Extends: Request.JSON,
        success: function (r) { handleUnauthorized(r, this) },
        failure: function (r) { handleUnauthorized(r, this) }
    });
})();
;

var CFTemplateAddress = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

        Affinity.address.processNew();

    }

});

window.cfTemplateTypes.address = { name: 'address', objectname: 'CFTemplateAddress', object: CFTemplateAddress };;
var CFTemplateAttachInstructions = new Class({

    Extends: CFTemplateBase,

    Implements: [Options],

    options: {
        nativePost: true
    },

    initialize: function (options) {
        this.parent(options);
    },

    initted: function () {
        var uplaoders = new UIUplaoders();
    }

});

window.cfTemplateTypes.attachinstructions = { name: 'attachinstructions', objectname: 'CFTemplateAttachInstructions', object: CFTemplateAttachInstructions };;

var CFTemplateBankNumber = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

        Affinity.banknumber.processNew();

    }

});

window.cfTemplateTypes.banknumber = { name: 'banknumber', objectname: 'CFTemplateBankNumber', object: CFTemplateBankNumber };;
var CFTemplateCheckbox = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    }

});

window.cfTemplateTypes.checkbox = { name: 'checkbox', objectname: 'CFTemplateCheckbox', object: CFTemplateCheckbox };;
var CFTemplateContentsTable = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    },

    initted: function () {

    }

});

window.cfTemplateTypes.contentstable = { name: 'contentstable', objectname: 'CFTemplateContentsTable', object: CFTemplateContentsTable };;

var CFTemplateCurrency = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    }

});

window.cfTemplateTypes.currency = { name: 'currency', objectname: 'CFTemplateCurrency', object: CFTemplateCurrency };;
var CFTemplateDatePicker = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    },

    initted: function () {

        new UIDateCalendar({
            dateMooFormat: '%d.%m.%Y'
        });

        document.id('showcalendar').addEvent(Affinity.events.click, this.setDateTimeType.bind(this));
        document.id('showtime').addEvent(Affinity.events.click, this.setDateTimeType.bind(this));
        document.id('setdefault').addEvent(Affinity.events.click, this.doSetDefaultValue.bind(this));

        this.doSetDefaultValue();

    },

    setDateTimeType: function () {

        var typeString = '';
        if (document.id('showcalendar').checked) {
            typeString += 'date';
        }
        if (document.id('showtime').checked) {
            typeString += 'time';
        }
        if (typeString=='') {
            typeString = 'date';
            document.id('showcalendar').checked = true;
        }
        document.id('DateTimeType').value = typeString;

    },

    doSetDefaultValue: function (e) {
        if (document.id('setdefault').checked) {
            document.id('SetDefaultvalue').value = 'true';
        } else {
            document.id('SetDefaultvalue').value = 'false';
        }
    }

});

window.cfTemplateTypes.date = { name: 'date', objectname: 'CFTemplateDatePicker', object: CFTemplateDatePicker };;
var CFTemplateDrawPanel = new Class({

    Extends: CFTemplateBase,

    options: {
        nativePost: true
    },

    initialize: function (options) {

        this.parent(options);
        Affinity.uiDrawPanels.processNew();

    },

    initted: function () {
        var uploaders = new UIUplaoders();
    }
});

window.cfTemplateTypes.drawpanel = { name: 'drawpanel', objectname: 'CFTemplateDrawPanel', object: CFTemplateDrawPanel };;

var CFTemplateEffectiveDate = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

        Affinity.uiDateCalendar.processNew();
    }

});

window.cfTemplateTypes.effectivedate = { name: 'effectivedate', objectname: 'CFTemplateEffectiveDate', object: CFTemplateEffectiveDate };;
var CFTemplateEmail = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    }

});

window.cfTemplateTypes.email = { name: 'email', objectname: 'CFTemplateEmail', object: CFTemplateEmail };;
var CFTemplateExplanation = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    },

    initted: function () {

        if (this.form.getElement('select') && this.form.getElement('.helpBubble.explain')) {
            this.form.getElement('select').addEvent('change', function () {
                this.form.getElement('.helpBubble.explain').removeClass('top');
                this.form.getElement('.helpBubble.explain').removeClass('left');
                this.form.getElement('.helpBubble.explain').removeClass('bottom');
                this.form.getElement('.helpBubble.explain').removeClass('right');
                if (this.form.getElement('select').value!='none') {
                    this.form.getElement('.helpBubble.explain').addClass(this.form.getElement('select').value);
                }
            });
        }

    }

});

window.cfTemplateTypes.explanation = { name: 'explanation', objectname: 'CFTemplateExplanation', object: CFTemplateExplanation };;

var CFTemplateFielddisplay = new Class({

    Extends: CFTemplateBase,

    Binds: [
        'populateFieldDisplayFields', 'getFieldEditFields',
        'setFieldName'
    ],

    options: {
        autoGenerateName: true
    },

    area: null,
    category: null,

    initialize: function (options) {
        this.parent(options);
    },
  
    initted: function () {

        this.area = document.area;
        this.category = document.category;

        this.fieldDisplayFieldsLoader = document.id('fieldDisplayFieldsLoader');
        new Element('span', { 'html': '<img src="' + document.config.loaders.light + '" />' }).inject(this.fieldDisplayFieldsLoader);

        this.fieldDisplayFields = document.id('fieldDisplayFields');
        this.fieldDisplayFields.addClass('hidden');

        this.fieldDisplayFields.addEvent('change', this.setFieldName);

        this.getDisplayFieldsRequest = new CFRequest.JSON({
            url: this.fieldDisplayFields.get('data-lookup-method') + '?area=' + this.area + '&category=' + this.category + '&parameter=',
            onSuccess: this.populateFieldDisplayFields
        }).send();

    },

    keywordDict: {
        Double: 'float number (allows decimals and comas)',
        Float: 'float number (allows decimals and comas)',
        DateTime: 'date',
        Int: 'int number (no decimals)',
        Lookup: 'dropdown box of choices'
    },

    getKeyword: function (keyword) {
        if (this.keywordDict[keyword]) {
            return this.keywordDict[keyword];
        }
        return keyword;
    },

    populateFieldDisplayFields: function (jsonData) {
        if (jsonData.error) {
            this.fieldDisplayFieldsLoader.destroy();
            var errorMesg = '';
            if (jsonData.error.test(/.*area.*category.*not found/)) {
                errorMesg = 'The area and category were not found. Please try again.<!--' + jsonData.error  + '-->'
            }else{
                errorMesg = 'We could not fetch the required values. Please try again.<!--' + jsonData.error + '-->';
            }
            uialert({ 'message': errorMesg });
            return;
        }

        var defaultValue = this.fieldDisplayFields.get('data-default-value');
        var values, value, option;
        Array.each(jsonData.Properties, function (data) {

            values = [];
            values.push(data.PropertyName ? data.PropertyName : '');
            values.push(data.ModelName ? data.ModelName : ',');
            values.push(data.Attribute.PropertyType ? data.Attribute.PropertyType : '');
            values.push(data.Attribute.DataType ? data.Attribute.DataType : '');
            values.push(data.Attribute.FieldDecimal ? data.Attribute.FieldDecimal : '');
            values.push(data.Attribute.FieldPrecision ? data.Attribute.FieldPrecision : '');

            value = values.join(',');

            option = new Element('option', {
                'value': value, 'html': data.DisplayLabel + ' (' + data.PropertyName + ' from ' + data.ModelName + ')'
            });
            if (defaultValue !== '' && value !== '' && value.indexOf(defaultValue) === 0) {
                option.set('selected', 'selected');
            }

            this.fieldDisplayFields.adopt(
                option
            );

        }.bind(this));

        if (jsonData.Properties.length > 20 && typeOf(UIAutoComplete) == 'class') {
            this.fieldDisplayFields.addClass('ui-autocomplete');
            Affinity.uiAutoComplete.processNew();
        }

        this.fieldDisplayFields.removeClass('hidden');
        this.fieldDisplayFieldsLoader.destroy();

        this.setFieldName(null);

        delete values;
        delete value;
        delete option;

    },

    setFieldName: function (e) {

        if (this.fieldDisplayFields.value == '') {
            return;
        }

        var props = this.fieldDisplayFields.value.split(',');

        this.form.getElement('#name').value = props[0];
        this.form.getElement('#FieldName').value = props[0];
        this.form.getElement('#ModelName').value = props[1];
        this.form.getElement('#PropertyType').value = props[2];
        this.form.getElement('#DataType').value = props[3];
        this.form.getElement('#FieldDecimal').value = props[4];
        this.form.getElement('#FieldPrecision').value = props[5];

        delete props;
    }

});

window.cfTemplateTypes.fielddisplay = { name: 'fielddisplay', objectname: 'CFTemplateFielddisplay', object: CFTemplateFielddisplay };

;

var CFTemplateFieldEdit = new Class({

    Extends: CFTemplateBase,

    Binds: [
        'populateFieldEditTables', 'getFieldEditFields',
        'setFieldName'
    ],

    options:{
        autoGenerateName: false
    },

    area: null,
    category: null,

    initialize: function (options) {
        this.parent(options);
    },

    initted: function () {

        this.area = document.area;
        this.category = document.category;

        this.explainBox = this.form.getElement('.explaination');

        this.fieldEditFieldsLoader = document.id('fieldEditFieldsLoader');
        new Element('span', { 'html': '<img src="' + document.config.loaders.light + '" />' }).inject(this.fieldEditFieldsLoader);

        this.fieldEditFields = document.id('fieldEditFields');
        this.fieldEditFields.addClass('hidden');

        this.fieldEditFields.addEvent('change', this.setFieldName);

        this.getTablesRequest = new CFRequest.JSON({
            url: this.fieldEditFields.get('data-lookup-method') + '?area=' + this.area + '&category=' + this.category + '&parameter=editable',
            onSuccess: this.populateFieldEditTables
        }).send();

    },

    keywordDict: {
        Double: 'float number (allows decimals and comas)',
        Float: 'float number (allows decimals and comas)',
        DateTime: 'date',
        Int: 'int number (no decimals)',
        Lookup: 'dropdown box of choices',
        BankNumber: 'set of bank number fields',
        Address: 'set of address fields with Google Address lookup'
    },

    getKeyword: function(keyword){
        if (this.keywordDict[keyword]) {
            return this.keywordDict[keyword];
        }
        return keyword;
    },

    populateFieldEditTables: function (jsonData) {
        if (jsonData.error) {
            this.fieldEditFieldsLoader.destroy();
            uialert({ 'message': 'We could not fetch the required values. Please try again.<!--' + jsonData.error + '-->' });
            return;
        }

        var defaultValue = this.fieldEditFields.get('data-default-value');
        var values, value, option;

        Array.each(jsonData.Properties, function (data) {
            
            values = [];
            values.push(data.PropertyName ? data.PropertyName : '');
            values.push(data.ModelName ? data.ModelName : ',');
            values.push(data.Attribute.PropertyType ? data.Attribute.PropertyType : '');
            values.push(data.Attribute.MinValue ? data.Attribute.MinValue : '');
            values.push(data.Attribute.MaxValue ? data.Attribute.MaxValue : '');
            values.push(data.Attribute.MinLength ? data.Attribute.MinLength : '');
            values.push(data.Attribute.MaxLength ? data.Attribute.MaxLength : '');
            values.push(data.Attribute.IsRequired ? data.Attribute.IsRequired : '');
            values.push(data.Attribute.DataType ? data.Attribute.DataType : '');
            values.push(data.Attribute.IsKeyField ? data.Attribute.IsKeyField : '');
            values.push(data.Attribute.FieldDecimal ? data.Attribute.FieldDecimal : '');
            values.push(data.Attribute.FieldPrecision ? data.Attribute.FieldPrecision : '');

            value = values.join(',');

            option = new Element('option', {
                'value': value, 'html': data.DisplayLabel + ' (' + data.PropertyName + ' from ' + data.ModelName + ')'
            });
            if (defaultValue!=='' && value !== '' && value.indexOf(defaultValue) === 0) {
                option.set('selected','selected');
            }

            this.fieldEditFields.adopt(
                option
            );

        }.bind(this));

        this.fieldEditFields.removeClass('hidden');
        this.fieldEditFieldsLoader.destroy();

        if (jsonData.Properties.length > 20 && typeOf(UIAutoComplete) == 'class') {
            this.fieldEditFields.addClass('ui-autocomplete');
            Affinity.uiAutoComplete.processNew();
        }

        this.setFieldName(null);

        delete values;
        delete value;
        delete option;

    },

    setExplaination: function () {

        var explaination = "";

        if (this.form.getElement('#IsRequired').value === 'true') {
            this.form.getElement('#required').set('checked', 'checked');
            this.form.getElement('#required').set('disabled', 'disabled');
            explaination += "This field must have a value and has been set as required above.<br /><br />";
        } else {
            this.form.getElement('#required').erase('disabled');
        }

        explaination += "This field will be displayed as a " + this.getKeyword(this.form.getElement('#PropertyType').value) + '.';

        this.explainBox.set('html', explaination);

    },

    setFieldName: function (e) {

        this.explainBox.set('html', '');
        if (this.fieldEditFields.value == '') { return; }

        var props = this.fieldEditFields.value.split(',');
        this.form.getElement('#name').value = props[0];
        this.form.getElement('#FieldName').value = props[0];
        this.form.getElement('#ModelName').value = props[1];
        this.form.getElement('#PropertyType').value = props[2];
        this.form.getElement('#MinValue').value = props[3];
        this.form.getElement('#MaxValue').value = props[4];
        this.form.getElement('#MinLength').value = props[5];
        this.form.getElement('#MaxLength').value = props[6];
        this.form.getElement('#IsRequired').value = props[7] || props[9] || false;
        this.form.getElement('#DataType').value = props[8];
        this.form.getElement('#FieldDecimal').value = props[10];
        this.form.getElement('#FieldPrecision').value = props[11];

        this.setExplaination();
        delete props;
    }

});

window.cfTemplateTypes.fieldedit = { name: 'fieldedit', objectname: 'CFTemplateFieldEdit', object: CFTemplateFieldEdit };
;
var CFTemplateFileUpload = new Class({

    Extends: CFTemplateBase,

    Binds: [
        'loadDropTwoValues',
        'secondDropSuccess'
    ],

    initialize: function (options) {

        this.parent(options);

    },

    initted: function () {

        var uplaoders = new UIUplaoders();

        this.dropOne = this.form.getElement('#DocumentCategory');
        this.dropTwo = this.form.getElement('#DocumentType');

        //this.spinbox = new Element('div', { 'class': 'hidden', styles: { 'display': 'inline-block', 'margin': '0 0 0 10px' } }).inject(this.dropTwo, 'after');
        //new Spinner(document.spinnerOptions).spin(this.spinbox);

        this.spinbox = new Element('div', { 'class': 'formloader hidden', styles: { 'display': 'inline-block', 'margin': '0 0 0 10px' } }).adopt(
            new Element('span', { 'html': '<img src="' + document.config.loaders.light + '" />&nbsp;' })
        ).inject(this.dropTwo, 'after');

        this.dropRequest = new CFRequest.JSON({
            url: this.dropOne.getAttribute('data-secondary-select-lookup'),
            method: (this.dropOne.getAttribute('data-secondary-select-lookup-method') == null) ? 'get' : this.dropOne.getAttribute('data-secondary-select-lookup-method').toLowerCase(),
            onSuccess: this.secondDropSuccess,
            onError: function (error) {
                //console.log("securityGroupsRequest failed:\n" + error);
            },
            onFailure: function (xhr) {
                //console.log("securityGroupsRequest:\n" + xhr.status + ' ' + xhr.statusText);
            }
        });

        this.dropOne.addEvent('change', this.loadDropTwoValues);
        this.loadDropTwoValues();

        Affinity.uiHidables.processTriggers();

    },

    loadDropTwoValues: function (e) {

        this.dropTwo.addClass('hidden');
        this.spinbox.removeClass('hidden');

        if (this.dropRequest.options.method == 'post') {
            this.dropRequest.post({
                DocumentCategory: this.dropOne.value
            });
        } else {
            this.dropRequest.get({
                DocumentCategory: this.dropOne.value
            });
        }
    },

    secondDropSuccess: function (jsonData) {
        this.dropTwo.empty();
        this.dropTwo.removeClass('hidden');
        this.dropTwo.erase('disabled');
        this.spinbox.addClass('hidden');
        var selected = (typeOf(this.dropOne.getAttribute('data-secondary-select-default')) != 'null' ? this.dropOne.getAttribute('data-secondary-select-default') : null);
        if (jsonData.length == 0) {
            this.dropTwo.set('disabled', 'disabled');
        } else {
            new Element('option', { value: '', html: 'Any' }).inject(this.dropTwo);
            Array.each(jsonData, function (data, index) {
                option = new Element('option', {
                    value: data.ID,
                    html: data.Name
                }).inject(this.dropTwo);
                if (selected != null && selected == data.ID) {
                    option.set('selected', 'selected');
                }
            }.bind(this));

        }

    }

});

window.cfTemplateTypes.fileupload = { name: 'fileupload', objectname: 'CFTemplateFileUpload', object: CFTemplateFileUpload };;
var CFTemplateFileUploadMulti = new Class({

    Extends: CFTemplateBase,

    Binds: [
        'fileAdded','fileDeleted',
        'loadDropTwoValues',
        'secondDropSuccess'
    ],

    initialize: function (options) {

        this.parent(options);

    },

    initted: function ()
    {

        if (!(Affinity && Affinity.hasOwnProperty('Uplaoders')))
        {
            Affinity.Uplaoders = new UIUplaodersMulti();
        }

        this.dropOne = this.form.getElement('#DocumentCategory');
        this.dropTwo = this.form.getElement('#DocumentType');

        //this.spinbox = new Element('div', { 'class': 'hidden', styles: { 'display': 'inline-block', 'margin': '0 0 0 10px' } }).inject(this.dropTwo, 'after');
        //new Spinner(document.spinnerOptions).spin(this.spinbox);

        this.spinbox = new Element('div', { 'class': 'formloader hidden', styles: { 'display': 'inline-block', 'margin': '0 0 0 10px' } }).adopt(
            new Element('span', { 'html': '<img src="' + document.config.loaders.light + '" />&nbsp;' })
        ).inject(this.dropTwo, 'after');

        this.dropRequest = new CFRequest.JSON({
            url: this.dropOne.getAttribute('data-secondary-select-lookup'),
            method: (this.dropOne.getAttribute('data-secondary-select-lookup-method') == null) ? 'get' : this.dropOne.getAttribute('data-secondary-select-lookup-method').toLowerCase(),
            onSuccess: this.secondDropSuccess,
            onError: function (error) {
                //console.log("securityGroupsRequest failed:\n" + error);
            },
            onFailure: function (xhr) {
                //console.log("securityGroupsRequest:\n" + xhr.status + ' ' + xhr.statusText);
            }
        });

        this.dropOne.addEvent('change', this.loadDropTwoValues);
        this.loadDropTwoValues();

        Affinity.uiHidables.processTriggers();

    },

    loadDropTwoValues: function (e) {

        this.dropTwo.addClass('hidden');
        this.spinbox.removeClass('hidden');

        if (this.dropRequest.options.method == 'post') {
            this.dropRequest.post({
                DocumentCategory: this.dropOne.value
            });
        } else {
            this.dropRequest.get({
                DocumentCategory: this.dropOne.value
            });
        }
    },

    secondDropSuccess: function (jsonData) {
        this.dropTwo.empty();
        this.dropTwo.removeClass('hidden');
        this.dropTwo.erase('disabled');
        this.spinbox.addClass('hidden');
        var selected = (typeOf(this.dropOne.getAttribute('data-secondary-select-default')) != 'null' ? this.dropOne.getAttribute('data-secondary-select-default') : null);
        if (jsonData.length == 0) {
            this.dropTwo.set('disabled', 'disabled');
        } else {
            new Element('option', { value: '', html: 'Any' }).inject(this.dropTwo);
            Array.each(jsonData, function (data, index) {
                option = new Element('option', {
                    value: data.ID,
                    html: data.Name
                }).inject(this.dropTwo);
                if (selected != null && selected == data.ID) {
                    option.set('selected', 'selected');
                }
            }.bind(this));

        }

    }

});

window.cfTemplateTypes.fileuploadmulti = { name: 'fileuploadmulti', objectname: 'CFTemplateFileUploadMulti', object: CFTemplateFileUploadMulti };;
var CFTemplateFloat = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    }

});

window.cfTemplateTypes.float = { name: 'float', objectname: 'CFTemplateFloat', object: CFTemplateFloat };;
var CFTemplateGridFields = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    }

});

window.cfTemplateTypes.gridfields = { name: 'gridfields', objectname: 'CFTemplateGridFields', object: CFTemplateGridFields };;
var CFTemplateInteger = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    }

});

window.cfTemplateTypes.integer = { name: 'integer', objectname: 'CFTemplateInteger', object: CFTemplateInteger };;
var CFTemplateLink = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    }

});

window.cfTemplateTypes.link = { name: 'link', objectname: 'CFTemplateLink', object: CFTemplateLink };;
var CFTemplateMemo = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {
        this.parent(options);
    },

    initted: function () {
        Affinity.textAutoSize.processNew();
    }

});

window.cfTemplateTypes.memo = { name: 'memo', objectname: 'CFTemplateMemo', object: CFTemplateMemo };;
var CFTemplateMultiselect = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    },

    initted: function () {
        
        Affinity.uiDynamicGrid.init({
            container: this.form
        });

        Affinity.uiHidables.processTriggers();

    }

});

window.cfTemplateTypes.multiselect = { name: 'multiselect', objectname: 'CFTemplateMultiselect', object: CFTemplateMultiselect };;
var CFTemplateParagraph = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    },

    initted: function () {



    }

});

window.cfTemplateTypes.paragraph = { name: 'paragraph', objectname: 'CFTemplateParagraph', object: CFTemplateParagraph };;
var CFTemplateSection = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    }

});

window.cfTemplateTypes.formsection = { name: 'formsection', objectname: 'CFTemplateSection', object: CFTemplateSection };

;
var CFTemplateSeparator = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {
        this.parent(options);
    },

    initted: function () {
        if (this.form.getElement('#name').value === '') {
            this.form.getElement('#name').value = 'seperator_' + String.uniqueID() + '_' + new Date().getTime();
        }
    }

});

window.cfTemplateTypes.separator = { name: 'separator', objectname: 'CFTemplateSeparator', object: CFTemplateSeparator };;
var CFTemplateDropdown = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    },

    initted: function () {

        Affinity.uiDynamicGrid.init();

        Affinity.uiHidables.processTriggers();

    }

});

window.cfTemplateTypes.singleselectdropdown = { name: 'singleselectdropdown', objectname: 'CFTemplateDropdown', object: CFTemplateDropdown };;
var CFTemplateRadioButton = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    },

    initted: function () {

        Affinity.uiDynamicGrid.init();

        Affinity.uiHidables.processTriggers();

    }

});

window.cfTemplateTypes.singleselectradio = { name: 'singleselectradio', objectname: 'CFTemplateRadioButton', object: CFTemplateRadioButton };;

var CFTemplateTaxNumber = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

        Affinity.taxnumber.processNew();

    }

});

window.cfTemplateTypes.taxnumber = { name: 'taxnumber', objectname: 'CFTemplateTaxNumber', object: CFTemplateTaxNumber };;

var CFTemplateText = new Class({
    
    Extends: CFTemplateBase,

    initialize: function (options) {
        
        this.parent(options);
        
    }

});

window.cfTemplateTypes.text = { name: 'text', objectname: 'CFTemplateText', object: CFTemplateText };;
var CFTemplateTitle = new Class({

    Extends: CFTemplateBase,

    initialize: function (options) {

        this.parent(options);

    }

});

window.cfTemplateTypes.title = { name: 'title', objectname: 'CFTemplateTitle', object: CFTemplateTitle };;
var CFTemplateYoutube = new Class({

    Extends: CFTemplateBase,

    Binds: [
        'processYoutubeId', 'returnYoutbeId', 'returnYoutubeEmbed', 'testEmbed'
    ],

    initialize: function (options) {

        this.parent(options);

    },

    youtubeWidth: 446,
    youtubeHeight: 251,

    initted: function () {
        if (document.id('youtubeUrl') && document.id('testYoutubeEmbed') && document.id('youtubeId')) {

            document.id('youtubeUrl').addEvent('keyup', function (e) {
                document.id('youtubeId').value = this.processYoutubeId(document.id('youtubeUrl'), document.id('testYoutubeEmbed'));
            }.bind(this));

          if (document.id('youtubeId').value != "")
          {
            document.id('youtubeUrl').value = document.location.protocol + '//www.youtube.com/watch?v=' + document.id('youtubeId').value;
                this.processYoutubeId(document.id('youtubeUrl'), document.id('testYoutubeEmbed'));
            }

        }
    },

    processYoutubeId: function (input, element) {
        var id = this.returnYoutbeId(input.value);
        if (id) {
            var embed = this.returnYoutubeEmbed(id);
            this.testEmbed(element, embed);
            return id;
        } else {
            return '';
        }
    },

    returnYoutbeId: function (url) {
        if (url == '') { return false; }
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/;
        var match = url.match(regExp);
        if (match && match[7].length >= 11) {
            return match[7];
        } else {
            return false;
        }
    },

    returnYoutubeEmbed: function (id)
    {
        return new Element('iframe', {
            width: this.youtubeWidth,
            height: this.youtubeHeight,
            src: document.location.protocol + '//www.youtube.com/embed/' + id + '?autoplay=0&controls=1&rel=0&showinfo=0&theme=light&modestbranding=1',
            frameborder: 0,
            allowfullscreen: false
        });
    },

    testEmbed: function (target, embed) {
        target.empty();
        target.adopt(embed);
    }

});


window.cfTemplateTypes.video = { name: 'video', objectname: 'CFTemplateYoutube', object: CFTemplateYoutube };;

Affinity.Components = Affinity.Components || {};
Affinity.Components.ZelosInit = {
    Version: '1.0.0.0',
    Name: 'Zelos Init',
    File: 'ui.zelos.init.js',
    Jira: ''
};


if (!'Affinity' in window) { window.Affinity = {}; }
Affinity.zelos = {};
Affinity.zelos.Elements = {};


function ZelosError(message) {
    this.name = "ZelosError";
    this.message = (message || "");
}
ZelosError.prototype = Error.prototype;

var ZelosInit = new Class({

    Implements: [Options, Events],

    Binds: [
        'loadHtmlTemplate', 'htmlTemplateLoadError', 'htmlTemplayeLoaded'
    ],

    options: {
        htmlTemplateUrl: '/Content/html/ZelosHtmlTemplates.html',
        requiredUiComponenets: [
            'UITabs',
            'UIGrid',
            'UIHelpBubble',
            'UIHelpIcon',
            'UITooltips',
            'UIDrawPanels',
            'UIModal',
            'UIPompts',
            'UISelectLookup',
            'UIUplaodersMulti',
            'UIDateCalendar',
            'UIValidation',
            'UIHidables'
        ],
        requiredZelosComponenets: [
            'ZelosTemplateLoad',
            'ZelosTemplateProcess'
        ]
    },

    initialize: function (options) {

        this.setOptions(options);

        var classname;
        var rewuiredComponents = this.options.requiredUiComponenets.combine(this.options.requiredZelosComponenets);
        var missingComponents = [];

        Array.each(rewuiredComponents, function (classname) {
            if (typeOf(window[classname]) != 'class') {
                missingComponents.push(classname);
            }
        });

        if (missingComponents.length > 0) {
            throw new ZelosError("There are components missing that are required for Zelos to run:\n" + missingComponents.join('\n') + "\nPlease refer to 'Setting up Zelos UI' in documentation.");
        }

        delete classname;
        delete rewuiredComponents;
        delete missingComponents;

        Affinity.zelos.getElement = this.getElement;
        Affinity.zelos.getElementFromData = this.getElementFromData;

        this.loadHtmlTemplate();

    },

    loadHtmlTemplate: function () {

        this.fireEvent('request', mybasepath + this.options.htmlTemplateUrl);
        new Request.HTML({
            url: mybasepath + this.options.htmlTemplateUrl,
            evalScripts: false,
            onFailure: this.htmlTemplateLoadError,
            onError: this.htmlTemplateLoadError,
            onSuccess: this.htmlTemplayeLoaded
        }).get();

    },

    htmlTemplateLoadError: function () {
        if (ga) {
            ga('send', 'event', 'Zelos', 'HtmlTemplate', 'load failed (' + mybasepath + this.options.htmlTemplateUrl + ')');
        }
        Affinity.prompts.hide();
        this.fireEvent('error', '"' + mybasepath + this.options.htmlTemplateUrl + '" must exist in your project.');
    },

    htmlTemplayeLoaded: function (responseTree) {
        var tableElement;
        Array.each(responseTree, function (element) {
            if (typeOf(element) == 'element' || typeOf(element) == 'table') {
                if (element.get('data-form-element') && element.get('data-form-element') != '') {
                    if (element.hasClass('get-tr')) {
                        Affinity.zelos.Elements[element.get('data-form-element')] = element.getElement('tr');
                    } else {
                        Affinity.zelos.Elements[element.get('data-form-element')] = element;
                    }
                }
            }
        });
        delete tableElement;
        this.fireEvent('complete');
    },

    setTemplateElement: function (identifier, element) {
        Affinity.zelos.Elements[identifier] = element;
    },

    getElement: function (name) {
        if (Affinity.zelos.Elements[name]) {
            return Affinity.zelos.Elements[name].clone();
        }
        /* console.log('NO template for ' + name + '.'); */
        return false;
    },

    getElementFromData: function (data) {
        if (typeOf(data) !== 'null') {
            var use = data.ElementType ? data.ElementType : data.InputType;
            var from = data.ElementType ? 'ElementType' : 'InputType';
            var el, uuid;
            if (typeOf(Affinity.zelos.Elements[use]) === 'class') {
                return Affinity.zelos.Elements[use];
            }
            if (data.ElementType == "FieldEdit" || data.ElementType == "FieldDisplay") {
                switch (data.InputType) {
                    case 'Currency':
                        if (Affinity.zelos.Elements.CurrencyInput) {
                            return Affinity.zelos.Elements.CurrencyInput.clone();
                        } else {
                            //console.log('NO template for FieldEdit with inputType CurrencyInput found from ' + from + '.'); */
                        }
                    default:
                        return Affinity.zelos.Elements[use].clone();
                }
            }
            if (Affinity.zelos.Elements[use]) {
                return Affinity.zelos.Elements[use].clone();
            }
        }
        /* console.log('NO template for ' + use + ' found from ' + from + '.'); */
        return false;
    }

});

/**/

(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
})(window, document, 'script', '/' + '/www.google-analytics.com/analytics.js', 'ga');

ga('create', 'UA-45869305-1', 'teampayoffice.com');
ga('create', 'UA-45869305-1', {
    'cookieDomain': 'none'
});
ga('send', 'pageview');;

Affinity.Components = Affinity.Components || {};
Affinity.Components.ZelosTemplateLoad = {
    Version: '1.0.0.0',
    Name: 'Zelos Template Load',
    File: 'ui.zelos.template.load.js',
    Jira: ''
};

var ZelosTemplateLoad = new Class({

    Implements: [Options, Events],

    Binds: [
        'loadTemplate', 'templateLoaded', 'loadFailed', 'cancel'
    ],

    options: {
    },

    initialize: function (options) {
        this.setOptions(options);

        var __start = new Date();
        log('&#x2794; attempting ZelosLoader template load (0) ...');

        this.formTemplateRequest = new Request.JSON({
            method: 'get',
            timeout: 1000 * 60 * 2, // 2 minutes
            onRequest: function () {

                log('&#x2794; ZelosLoader template load requested (' + __start.elapsed() + ') - ' + this.logUrl + ' ...', { 'color': 'blue' });

                this.fireEvent('request', this.formTemplateRequest.options.url);
            }.bind(this),
            onFailure: function (xhr) {
                var error = '';
                switch (xhr.status) {
                    case 401:
                        error = 'Api unauthorized.';
                        break;
                    case 404:
                        error = 'API path not found.';
                        break;
                    case 500:
                        var json;
                        try {
                            json = JSON.decode(xhr.responseText);
                        } catch (e) {
                            json = false;
                            error = xhr.responseText
                        }
                        if (json) {
                            if (json.error) {
                                error = json.error;
                            } else {
                                error = xhr.responseText;
                            }
                        }
                        delete json;
                        break;
                    default:
                        error = xhr.statusText;
                }
                if (error.contains(401) || error.toLowerCase().contains('unauthorized')) {

                    log('&#x270B; attempted ZelosLoader template load unauthorized &#x270B;', { 'color': 'red' });

                    window.fireEvent('unauthorized');
                    //if (typeOf(Affinity.login) == 'null') {
                    this.loadFailed(error);
                    //}
                } else {

                    log('&#x2718; attempted ZelosLoader template load failed (' + __start.elapsed() + ') - ' + this.logUrl + ' - ' + error, { 'color': 'red' });

                    this.loadFailed(error);
                }
                delete error;
            }.bind(this),
            onError: function (text, error) {

                log('&#x2718; attempted ZelosLoader template load failed with errors (' + __start.elapsed() + ') - ' + this.logUrl + ' - ' + text, { 'color': 'red' });

                this.loadFailed(text);
            }.bind(this),
            onException: function (headerName, value) {

                log('&#x2718; attempted ZelosLoader template load failed with exception (' + __start.elapsed() + ') - ' + this.logUrl + ' - ' + headerName + ': ' + value, { 'color': 'red' });

                this.loadFailed('Exception on ' + headerName + ': ' + value);
            }.bind(this),
            onTimeout: function () {

                log('&#x2718; attempted ZelosLoader template load timed out (' + __start.elapsed() + ') - ' + this.logUrl, { 'color': 'red' });

                this.loadFailed('Load reached timeout limit.');
            }.bind(this),
            onSuccess: function (jsonData) {
                if (!JSON.Unauthorized(jsonData, 'Zelos Loader, initialize - ' + this.formTemplateRequest.url)) {
                    if (jsonData.error) {
                        if (typeOf(jsonData.error) === 'object') {

                            log('&#x2718; attempted ZelosLoader template load succeeded with errors (' + __start.elapsed() + ') - ' + this.logUrl + ' - ' + JSON.stringify(jsonData.error), { 'color': 'red' });

                            this.loadFailed(JSON.stringify(jsonData.error));
                        } else {

                            log('&#x2718; attempted ZelosLoader template load succeeded with errors (' + __start.elapsed() + ') - ' + this.logUrl + ' - ' + jsonData.error.split('\r\n').join(', '), { 'color': 'red' });

                            this.loadFailed(jsonData.error.split('\r\n').join('<br />'));
                        }
                    } else {

                        log('&#x2714; attempted ZelosLoader template load succeeded (' + __start.elapsed() + ') - ' + this.logUrl, { 'color': 'green' });

                        this.templateLoaded(jsonData);
                    }
                }
            }.bind(this)
        });
    },

    attemptUrl: 'no url set',

    loadFailed: function (error) {
        if (this.formTemplateRequest.isRunning()) {
            this.formTemplateRequest.cancel();
        }
        this.fireEvent('error', error);
        if (ga) { ga('send', 'event', 'Zelos', 'FormTemplate', 'load failed (' + this.attemptUrl + ')'); }
    },

    loadTemplate: function (url) {

        this.attemptUrl = url;
        if (!this.attemptUrl.contains('ran')) {
            this.attemptUrl = Affinity.GetCacheSafePath(this.attemptUrl);
        }
        this.formTemplateRequest.url = this.formTemplateRequest.options.url = this.attemptUrl;

        /*
        var displayUrl = unescape(decodeURI(this.attemptUrl));
        displayUrl = displayUrl.replace(/http\:\/\/|httpa\:\/\//gi, '');
        if (displayUrl.indexOf('api=') > -1) {
            displayUrl = displayUrl.substring(displayUrl.indexOf('api=') + 9);
        }
        if (displayUrl.indexOf('&jsoncallback') > -1) {
            displayUrl = displayUrl.substring(0, displayUrl.indexOf('&jsoncallback'));
        }
        this.logUrl = displayUrl;
        */

        this.formTemplateRequest.send();
    },

    templateLoaded: function (jsonData) {
        if (typeOf(jsonData.success) === 'boolean' && jsonData.success === false) {
            this.loadFailed();
        } else {
            this.template = jsonData;
            this.fireEvent('complete', this.template);
            if (ga) { ga('send', 'event', 'Zelos', 'FormTemplate', 'From Loaded (' + this.attemptUrl + ')'); }
        }
    },

    isRunning: function () {
        if (this.formTemplateRequest && this.formTemplateRequest.isRunning()) {
            return true;
        }
        return false;
    },

    cancel: function () {
        if (this.formTemplateRequest && this.formTemplateRequest.isRunning()) {
            this.formTemplateRequest.cancel();
        }
        this.fireEvent('cancel', 'Form was canceled.');
    },

    destroy: function () {

    }

});;

Affinity.Components = Affinity.Components || {};
Affinity.Components.ZelosTemplateProcess = {
    Version: '1.0.1.1',
    Name: 'Zelos Template Process',
    File: 'ui.zelos.template.process.js',
    Jira: 'Add autocomplete to off on fields and forms'
};

var ZelosTemplateProcess = new Class({

    Implements: [Options, Events],

    Binds: [
        'processTemplate',
        'writeField', 'readField', 'readDirectValue',
        'submit', 'cancel', 'cancelForm', 'validationFailed', 'onPost', 'updateDocument', 'sanatisePostJson', 'validationPassed', 'postFailed', 'postSuccess',
        'getLookupDependancies', 'setLookupDependancies',
        'processChild'
    ],

    options: {
        getApi: null,
        putApi: null,
        getEmptyTimesheetApi: null,
        insertAddTimesheetForm: true,
        target: document.body,
        viewOnly: false,
        frameless: false,
        dateDisplayFormat: '%a %e %b %Y'
    },

    fieldProcessor: false,
    hasValidation: false,

    processorId: false,

    initialize: function (options) {

        this.setOptions(options);

        this.processorId = String.uniqueID();

        this.icons = {};
        this.icons.save = Affinity.icons.Save || '&#xe093;';
        this.icons.cancel = Affinity.icons.Cancel || '&#xe070;';

        if (Affinity.zelos.Elements == null) {
            throw new ZelosError("Zelos HTML Elements must be compiled. See ui.zelos.init.js");
        }

        if (!this.options.viewOnly && this.options.putApi == null) {
            throw new ZelosError("Zelos needs a put API path in options.");
        }

        this.target = this.options.target;

        /** Setup Field manipulation **/

        this.fieldProcessor = new ZelosProcessFileds({
            zelosProcessor: this
        });

        /**/

    },

    getValue: function (question) {
        if (this.fieldProcessor) {
            return this.fieldProcessor.getValue(question);
        }
        return false;
    },
    getAttributes: function (question) {
        if (this.fieldProcessor) {
            return this.fieldProcessor.getValue(question);
        }
        return false;
    },
    getLookupDependancies: function (jsonData) {
        if (this.fieldProcessor) {
            return this.fieldProcessor.getLookupDependancies(jsonData);
        }
        return false;
    },
    setLookupDependancies: function (jsonData, dependencies, element) {
        if (this.fieldProcessor) {
            this.fieldProcessor.setLookupDependancies(jsonData, dependencies, element);
        }
    },

    processTemplate: function (template) {

        if (typeOf(template) == 'string') {
            template = JSON.encode(template);
        }

        if (typeOf(template) === 'object') {

            this.template = template;

            this.fieldProcessor.template = template;

            var docdata = template;

            if (typeOf(docdata.Children) == 'array') {

                docdata.Children.sort(function (a, b) {
                    return parseInt(a.Layout.Rank, 10) - parseInt(b.Layout.Rank, 10);
                });

                Array.each(docdata.Children, this.processSection.bind(this));

            }

            var buttons = this.options.target.getElements('.zelos-button');

            if (buttons.length > 0) {

                this.form = new Element('form');
                this.form.adopt(this.target.getChildren());
                this.form.inject(this.target);
                this.form.set('autocomplete', 'off');

                this.buttonBox = this.options.target.getElement('.form-row.buttons');
                this.loaderBox = new Element('div', { 'class': 'form-row hidden' }).adopt(
                    new Element('img', { 'src': Affinity.loaders.light })
                ).inject(this.buttonBox, 'after')

                this.errorScroll = new Fx.Scroll(window);

                this.validation = new UIFormValidation({
                    target: this.form,
                    onPost: this.onPost,
                    onValidateFailCallback: this.validationFailed,
                    onValidateCallback: this.validationPassed
                });

                buttons.addEvent('click', function (e) {
                    var target = e.target.hasClass('zelos-button') ? e.target : e.target.getParent('.zelos-button');
                    if (target.get('data-type')) {
                        if (target.get('data-type') !== 'Cancel') {
                            this.buttonClickedName = target.get('data-name');
                            this.submit(e);
                        } else {
                            this.cancelForm();
                        }
                    }
                }.bind(this));

            } else {

                this.form = this.target;
                this.form.set('autocomplete', 'off');

            }

            if (this.options.frameless) {

            }

            /* Section Hidables *

            var viewBody, viewSwitch, viewSections = this.options.target.getElements('.view-section');
            if (Affinity.uiHidables && viewSections.length > 0) {
                Array.each(viewSections, function (viewSection) {
                    viewBody = viewSection.getParent('.section');
                    viewSwitch = viewBody.getElement('.is-section-switch')
                    Affinity.sectionHidables.process(viewSwitch);
                }.bind(this));
            }

            /**/

            Array.each(this.form.getElements('.has-dependencies'), function (element) {
                element.retrieve('dependencies').setEvents();
            });

            /**/

            if (Affinity.formhideables) { Affinity.formhideables.processNew(); }
            if (Affinity.tooltips) { Affinity.tooltips.processNew(); }
            if (Affinity.lookups) { Affinity.lookups.processNew({ jsonp: true }); }
            if (Affinity.displaylookups) { Affinity.displaylookups.processNew({ jsonp: true }); }
            if (Affinity.uiDrawPanels) { Affinity.uiDrawPanels.processNew(); }

            this.fireEvent('complete', this.options.target);

        }

    },

    submit: function (e) {
        document.getElements('.error').removeClass('error');
        document.getElements('.errorstr').destroy();
        if (this.loaderBox) { this.loaderBox.removeClass('hidden'); }
        if (this.buttonBox) { this.buttonBox.addClass('hidden'); }

        this.buttonClicked = e.target.hasClass('button') ? e.target : e.target.getParent('.button');

        var canContinue = true;
        if (this.options.beforSave) {
            canContinue = this.options.beforSave({ button: this.buttonClicked });
        }
        if (canContinue) {
            if (this.validation) {
                this.validation.validate();
            } else {
                this.validationPassed();
            }
        } else {
            if (this.loaderBox) { this.loaderBox.addClass('hidden'); }
            if (this.buttonBox) { this.buttonBox.removeClass('hidden'); }
        }
    },

    cancel: function () {
        this.cancelForm();
    },

    cancelForm: function () {
        this.fireEvent('cancel');
    },

    validationFailed: function () {

        (function () {
            if (this.buttonBox) { this.buttonBox.removeClass('hidden'); }
            if (this.loaderBox) { this.loaderBox.addClass('hidden'); }
            this.errorScroll.toElement(document.getElement('.errorstr').getParent('.form-row'));
        }).delay(1000, this);

    },

    onPost: function () {

        this.loaderBox.removeClass('hidden');
        this.buttonBox.addClass('hidden');

    },

    updateDocument: function () {

        var saveDocument = Object.clone(this.template);

        if (saveDocument.Children && typeOf(saveDocument.Children) == 'array') {

            Array.each(saveDocument.Children, function (section, sectionIndex) {

                if (section.Children && typeOf(section.Children) == 'array') {

                    Array.each(section.Children, function (question, questionIndex) {

                        this.readField(saveDocument, sectionIndex, questionIndex, question);

                    }.bind(this));

                }

            }.bind(this));

        }

        return saveDocument;

    },

    sanatisePostJson: function (doc) {
        var json = JSON.encode(doc);
        json = json.replace(new RegExp('&amp;', 'gi'), '%26');
        json = json.replace(new RegExp('&', 'gi'), '%26');
        return escape(json);
    },

    validationPassed: function () {

        var saveDocument = this.updateDocument();
        this.fireEvent('validated', { document: saveDocument, buttonClicked: this.buttonClicked });

        if (this.options.putApi !== 'none') {
            var json = this.sanatisePostJson(saveDocument);
            //console.log(json);
            new Request.JSON({
                method: 'POST',
                url: this.options.putApi,
                onFailure: this.postFailed,
                onError: this.postFailed,
                onSuccess: this.postSuccess
            }).post("=" + json);
        }

    },

    postFailed: function (message) {
        //console.log(message);
        if (this.loaderBox) { this.loaderBox.addClass('hidden'); }
        if (this.buttonBox) { this.buttonBox.removeClass('hidden'); }
        this.fireEvent('saveError');
    },

    postSuccess: function (jsonData) {

        if (typeOf(jsonData) == 'string') {
            jsonData = JSON.decode(jsonData);
        }
        if (typeOf(jsonData) != 'object') {
            throw new ZelosError('returned Json is not a valid object');
        }

        var target, widget, widgeterrors, errorMessage;

        if (this.loaderBox) { this.loaderBox.addClass('hidden'); }
        if (this.buttonBox) { this.buttonBox.removeClass('hidden'); }

        var type = 'cleverform';

        var hasError = false;
        var errors = [];

        if (jsonData.Attribute && jsonData.Attribute.IsError) {
            errors.push(jsonData.Attribute.ErrorMessage);
            hasError = true;
        }
        if (jsonData.Children) {
            /* Main Doc */
            Array.each(jsonData.Children, function (section) {
                if (section.Attribute && section.Attribute.IsError) {
                    errors.push(section.name + ': ' + section.Attribute.ErrorMessage);
                    hasError = true;
                }
                /* sections */
                Array.each(section.Children, function (child, index) {
                    /*
                    if (Affinity.zelos.Widgets && window.zelos.Widgets.contains(child.ElementType)) {
                        if (this.target.getElement('#' + child.Name)) {
                            if ('refresh' in this.target.getElement('#' + child.Name).retrieve('widget')) {
                                this.target.getElement('#' + child.Name).retrieve('widget').refresh(section.Children[index]);
                            }
                        }
                    }
                    */
                    if (child.ElementType && child.ElementType === 'TimesheetTable') {
                        type = 'timesheets'; /* timesheets has it's own error processor for rows */
                        if (child.Attribute && child.Attribute.IsError) {
                            if (hasError) { /* already has an error? no need to continue then, just give it to timesheets */
                                window.fireEvent('processorDocumentError', { document: jsonData, processorId: this.processorId });
                                return;
                            }
                            hasError = true;
                        }
                    } else {
                        if (child.Attribute && child.Attribute.IsError) {
                            hasError = true;
                            target = document.id(child.Name) ? document.id(child.Name) : false;
                            if (target) {
                                if (target.get('data-widget')) {
                                    widget = target.retrieve('widget');
                                    if (widget && 'processErrors' in widget) {
                                        widgeterrors = target.retrieve('widget').processErrors(jsonData);
                                    }
                                    if (widgeterrors.length > 0) {
                                        hasError = true;
                                        errorMessage = widgeterrors.join(', ');
                                    } else {
                                        errorMessage = child.Attribute.ErrorMessage;
                                    }
                                } else {
                                    if (target.getPrevious('label,.lable')) {
                                        target = target.getPrevious('label,.lable');
                                    } else if (target.getParent().getElement('label,.lable')) {
                                        target = target.getParent().getElement('label,.lable');
                                    }
                                    errorMessage = child.Attribute.ErrorMessage;
                                }
                                target.addClass('error');
                                if (!target.hasClass('suppress-errors')) {
                                    new Element('div', { 'class': 'errorstr', 'html': errorMessage }).inject(target, 'before');
                                }
                            } else {
                                errors.push(child.Name + ': ' + child.Attribute.ErrorMessage);
                            }
                        }
                    }
                }.bind(this));
            }.bind(this));
        }

        if (hasError) {
            if (type == 'timesheets') {
                window.fireEvent('processorDocumentError', { document: jsonData, processorId: this.processorId });
            }
            if (errors.length > 0) {
                this.fireEvent('saveError', '<br />' + errors.join('<br />'));
            } else {
                this.fireEvent('saveError', '');
            }
        } else {
            this.fireEvent('save', jsonData);
            window.fireEvent('processorDocumentSaved', { document: jsonData, processorId: this.processorId });
        }

        delete target;
        delete widget;
        delete widgeterrors;
        delete hasError;
        delete errors;

    },

    processChild: function (jsonData, childIndex, section, sectionIndex) {

        section = typeOf(section) === 'null' ? null : section;

        var element = this.fieldProcessor.returnField(jsonData, childIndex, sectionIndex);

        if (section !== null) {
            if (element) {
                section.getElement('.default-form').adopt(element);
                element.fireEvent('inDom');
            }
        }

        return element;

    },

    processSection: function (jsonData, sectionIndex) {

        if (jsonData.ElementType == 'SectionHeading') {

            if (jsonData.Attribute && jsonData.Attribute.IsHidden) {
                return;
            }

            var hasButtons = false;

            var section = Affinity.zelos.getElementFromData(jsonData);

            if (this.options.frameless) {
                section.addClass('frameless');
            }

            this.options.target.adopt(section);

            section.getElement('.section-title').set('html', jsonData.Description.ShortText);

            if (jsonData.Layout && jsonData.Layout.HideTitle && section.getElement('.section-header')) {
                section.getElement('.section-header').addClass('hidden');
            }

            if (typeOf(jsonData.Children) == 'array') {

                jsonData.Children.sort(function (a, b) {
                    return parseInt(a.Layout.Rank, 10) - parseInt(b.Layout.Rank, 10);
                });

                Array.each(jsonData.Children, function (childData, childIndex) {

                    if (childData.ElementType && childData.ElementType == "WorkflowButton") {
                        hasButtons = true;
                    }

                    this.processChild(childData, childIndex, section, sectionIndex);

                }.bind(this));

            }

            if (typeOf(jsonData.Layout.HideMessage) !== 'null' && !jsonData.Layout.HideMessage) {
                section.getElement('.required-message').removeClass('hidden');
            }

            if (section.getElement('.required') && hasButtons) {
                new Element('div', { 'class': 'form-row buttons' }).inject(section.getElement('.required-message'), 'after').adopt(section.getElements('.button-wrapper'));
            }

            if (jsonData.Layout.IsHideable) {
                section.addClass('is-hideable').addClass('ui-hideable-id-' + jsonData.Name.trim().toLowerCase().replace(/ /g, '-'));
            }

        } else {

        }

    },

    readDirectValue: function (question, element) {

        return this.fieldProcessor.readField(question, element);
    },

    writeField: function (question, element) {

        this.fieldProcessor.writeField(question, element);

    },

    readField: function (saveDocument, sectionIndex, questionIndex, question, form) {

        if (typeOf(form) === 'null') {
            form = this.form;
        }

        if (form.getElement('#' + question.Name)) {

            var element = form.getElement('#' + question.Name);

            if (this.buttonClickedName) {
                this.fieldProcessor.buttonClickedName = this.buttonClickedName;
            }

            saveDocument.Children[sectionIndex].Children[questionIndex] = this.fieldProcessor.readField(question, element);

            delete element;

        }

    }

});;
