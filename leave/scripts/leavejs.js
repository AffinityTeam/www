var Leave=new Class({Implements:[Options,Events],Binds:["init","stopEvents","setDates","selectTabsArray","removeTabs","removeTab","returnTab","resetPanels","resetTabs","switchToEmployeeView","doSwitchToEmployeeView","switchToManagerView","doSwitchToManagerView","cleanBadDate","cleanUnit","toFixed","cleanResponse","handleXHRErrors","isErrorInJson","lockui","unlockui","forceunlockui","initLeave","generatePageButtons","checkManagerStatus","populateAttachments","deleteAttachment","logout","loggedin","loggedout","doPositionUpdateOrValidation",],options:{apiroot:"",employeeTarget:null,managerTarget:null,configTarget:null},employee:!1,manager:!1,initialize:function(n){this.setOptions(n);this.apiroot=this.options.apiroot},init:function(){this.apiOverlay=new Element("div",{"class":"leave-api-overlay hidden",tabindex:0}).inject(document.body,"bottom");this.isManager=!1;this.tabBox=document.getElement(".section-nav ul");this.configTabs=["backTab","logoutTab"];this.employeeTabs=["logoutTab"];this.managerTabs=["myTab","teamTab","logoutTab"];this.adminTabs=["teamTab","configTab","logoutTab"];this.isConfig=this.options.configTarget===null?!1:!0;this.managerStatusRequest=new Request.JSON({onRequest:function(){Affinity.leave.lockui("leave-checkManagerStatus")},onFailure:function(n){Affinity.leave.unlockui("leave-checkManagerStatus");Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onException:function(){Affinity.leave.unlockui("leave-checkManagerStatus")},onCancel:function(){Affinity.leave.unlockui("leave-checkManagerStatus")},onSuccess:function(n){Affinity.leave.unlockui("leave-checkManagerStatus");Affinity.leave.isErrorInJson(n,this._api,this._methodName)||this.initLeave(n)}.bind(this)});this.deleteAttachmentRequest=new Request.JSON({onRequest:function(){Affinity.leave.lockui("leave-deleteAttachmentRequest")},onFailure:function(n){Affinity.leave.unlockui("leave-deleteAttachmentRequest");Affinity.leave.handleXHRErrors(n,this._api,this._methodName);"_methodResponse"in this&&typeOf(this._methodResponse)==="function"&&(this._methodResponse(!1),this._methodResponse=null,delete this._methodResponse)}.bind(this),onException:function(){Affinity.leave.unlockui("leave-deleteAttachmentRequest");"_methodResponse"in this&&typeOf(this._methodResponse)==="function"&&(this._methodResponse(!1),this._methodResponse=null,delete this._methodResponse)}.bind(this),onCancel:function(){Affinity.leave.unlockui("leave-deleteAttachmentRequest");"_methodResponse"in this&&typeOf(this._methodResponse)==="function"&&(this._methodResponse(!1),this._methodResponse=null,delete this._methodResponse)}.bind(this),onSuccess:function(n){Affinity.leave.unlockui("leave-deleteAttachmentRequest");Affinity.leave.isErrorInJson(n,this._api,this._methodName)||"_methodResponse"in this&&typeOf(this._methodResponse)==="function"&&(this.isManager?this._methodResponse(n):this._methodResponse(!1),this._methodResponse=null,delete this._methodResponse)}.bind(this)});this.hiddenAttachment=document.getElement("#invisible")},initLeave:function(n){this.isManager=!1;n&&n.Data?(this.isManager=!0,this.switchToManagerView()):this.switchToEmployeeView();this.resetTabs()},selectTabsArray:function(){this.tabs=this.employeeTabs;this.isConfig?this.tabs=this.configTabs:(this.tabs=this.isManager?this.managerTabs:this.employeeTabs,this.isAdmin&&(this.tabs=this.adminTabs))},removeTabs:function(){Array.each(this.tabBox.getElements("li"),function(n){n.removeEvents();n.destroy()});this.tabBox.empty();this.tabs=[]},removeTab:function(n){if(this[n]){switch(n){case"myTab":this[n].removeEvents();break;case"teamTab":this[n].removeEvents();break;case"configTab":this[n].removeEvents();break;case"backTab":this[n].removeEvents();break;case"logoutTab":this[n].removeEvents()}this[n].destroy()}},returnTab:function(n){this.removeTab(n);var t=new Element("li");t.addEvent(Affinity.events.start,this.stopEvents);switch(n){case"myTab":t.addClass("mine u-blue");t.set("html","<span>"+Affinity.icons.User+"<\/span><span>My Leave<\/span>");t.addEvent(Affinity.events.start,this.switchToEmployeeView);break;case"teamTab":t.addClass("manager u-blue");t.set("html","<span>"+Affinity.icons.Users+"<\/span><span>Team Leave<\/span>");t.addEvent(Affinity.events.start,this.switchToManagerView);break;case"configTab":t.addClass("settings link u-yellow");Affinity.mobile?t.set("html",'<a href="./Config"><span>'+Affinity.icons.Cog+"<\/span>Config<\/a>"):(t.addClass("ui-has-tooltip"),t.set("data-tooltip","Leave Configuration"),t.set("data-tooltip-dir","bottom,left"),t.set("html",'<a href="./Config"><span>'+Affinity.icons.Cog+"<\/span><\/a>"));break;case"backTab":t.addClass("back link u-yellow back");t.set("html",'<a href="./"><span>'+Affinity.icons.Return+"<\/span><span>Back to Leave<\/span><\/a>");break;case"logoutTab":t.addClass("logout orange u-orange");t.set("id","logout");this.lanched?t.set("html","<span>"+Affinity.icons.Logout+"<\/span><span>Close<\/span>"):t.set("html","<span>"+Affinity.icons.Logout+"<\/span><span>Logout<\/span>");t.addEvent(Affinity.events.start,this.logoutViaTab)}return this[n]=t,delete t,this[n]},stopEvents:function(n){n.preventDefault();n.stopPropagation()},resetPanels:function(){this.employee&&this.employee.reset();this.manager&&this.manager.reset();this.config&&this.config.reset()},resetTabs:function(){this.removeTabs();this.selectTabsArray();var n;Array.each(this.tabs,function(t){n=this.returnTab(t);n.inject(this.tabBox)}.bind(this));this.tabBox.getElements("li").removeClass("selected");this.isAdmin||this.isManager?this.teamTab&&this.teamTab.addClass("selected"):this.myTab&&this.myTab.addClass("selected")},switchToEmployeeView:function(n){this.doSwitchToEmployeeView(n)},doSwitchToEmployeeView:function(n){typeOf(n)!=="null"&&n.stopPropagation();this.currentView!=="employee"&&(this.currentView="employee",this.employee||(this.employee=new EmployeeLeave({target:this.options.employeeTarget})),this.resetPanels(),this.employee.init(),this.tabBox.getElements("li").removeClass("selected"),this.myTab&&this.myTab.addClass("selected"))},switchToManagerView:function(n){this.doSwitchToManagerView(n)},doSwitchToManagerView:function(n){typeOf(n)!=="null"&&n.stopPropagation();this.currentView!=="manager"&&(this.currentView="manager",this.manager||(this.manager=new TeamLeave({target:this.options.managerTarget})),this.resetPanels(),this.manager.init(),this.tabBox.getElements("li").removeClass("selected"),this.teamTab&&this.teamTab.addClass("selected"))},switchToConfigView:function(n){if(!this.isConfig){this.initLeave();return}this.doSwitchToConfigView(n)},doSwitchToConfigView:function(n){if(!this.isConfig){this.initLeave();return}typeOf(n)!=="null"&&n.stopPropagation();this.currentView!=="config"&&(this.currentView="config",this.config||(this.config=new UILeaveConfig({target:this.options.configTarget})),this.resetPanels(),this.config.init())},checkManagerStatus:function(){var n=Affinity.login.profile.employeeNumber;this._methodName="ui.leave.js -> checkManagerStatus";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"CanManageLeave/"+n);this.managerStatusRequest&&this.managerStatusRequest.isRunning()&&this.managerStatusRequest.cancel();this.managerStatusRequest.url=this.managerStatusRequest.options.url=this._api;this.managerStatusRequest.get()},cleanBadDate:function(n){var i,r,t;if(typeOf(n)==="date"&&"isValid"in n&&n.isValid())return n;if(typeOf(n)==="string"&&isNaN(n.replace(/\W/g,"")))for(n=n.toLowerCase(),r=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],t=0;t<r.length;t++)if(i=r[t],n.contains(i)){n=n.replace(i,t+1);break}return Date.parse(n)},cleanUnit:function(n,t){var i=n===""?"0":n+"";return i=i.trim().replace(/[^0-9.]/g,""),isNaN(parseFloat(i))&&typeOf(t)!=="null"&&(i=t),Affinity.leave.toFixed(i===""?0:i)},toFixed:function(n,t){if(typeOf(parseFloat(n))==="number")return parseFloat(n).toFixed(t||2);try{console.error('Error: Trying to pass "'+n+'" as float with '+t+" decimals")}catch(i){}return n===null||typeOf(n)==="null"?"":n},cleanResponse:function(n){if(typeOf(n)==="string"){var t=n+"";return t=t.replace("\r","<br />"),t=t.replace("\n","<br />"),t=t.replace(". Total",".<br /><br />Total"),t=t.replace(". Reason",".<br /><br />Reason"),t=t.replace(". Your",".<br /><br />Your"),t=t.replace(". Sent",".<br /><br />Sent"),t=t.replace("successfully saved","<strong>successfully saved<\/strong>"),t=t.replace("successfully submitted","<strong>successfully submitted<\/strong>"),t=t.replace("successfully approved","<strong>successfully approved<\/strong>"),t=t.replace("successfully declined","<strong>successfully declined<\/strong>"),t=t.replace("successfully deleted","<strong>successfully deleted<\/strong>"),t=t.replace("..","."),t.contains(" from ")&&t.contains(" to ")&&(t=t.replace(" from "," from <strong>"),t=t.replace(" to "," to <strong>"),t=t.replace(/ a.m./g," am<\/strong>"),t=t.replace(/ p.m./g," pm<\/strong>")),t.replace("for approval.","for approval. <br /><br />")}return n},handleXHRErrors:function(n,t,i,r){if("response"in n){if(this.isErrorInJson(n.response,t,i,r))return!0}else{typeOf(r)!=="null"&&(typeOf(r)!=="boolean"||r)||uialert({message:"Oops! Something went wrong.",showButtons:!0,noClose:!1});try{console.log("// XHR ERROR ///////////////////////////////////////");console.log("Method info  :"+method);console.log("URL called   :"+t);console.log("XHR Object   :");console.log(n);console.log("////////////////////////////////////////////////////");console.log("")}catch(u){}}return n.status===401?(this.logout(),!0):!1},isErrorInJson:function(n,t,i,r){var f=!1,e=!1,s,o,u;if(typeOf(n)==="string"){parsed=!1;try{parsed=JSON.parse(n)}catch(h){}typeOf(parsed)==="object"&&(n=parsed)}if(typeOf(n)==="object"&&(s=[],o=[],"Messages"in n&&typeOf(n.Messages)==="array"&&n.Messages.length>0&&Array.each(n.Messages,function(n){s.push(n.Message);n.MessageType===1?e=!0:n.MessageType===0&&(f=!0)}),"Exception"in n&&typeOf(n.Exception)==="object"&&"Message"in n.Exception&&n.Exception.Message!==""&&(o.push('<span class="color-red">'+n.Exception.Message+"<\/span>"),f=!0),f||e)){u="";f?u+="Oops! Something went wrong.<br />":e&&(u+="Warning!<br />");u+=s.join("<br />");o.length>0&&(u+="<br />",u+=o.join("<br />"));try{f?f&&e?console.log("// JSON ERROR & WARNING ////////////////////////////"):console.log("// JSON ERROR //////////////////////////////////////"):console.log("// JSON WARNING ////////////////////////////////////");console.log("Method info  :"+i);console.log("URL called   :"+t);console.log("Messages     :");console.log(u.replace("<br />","\r\n").stripTags());console.log("Returned Obj :");console.log(n);console.log("")}catch(h){}return(typeOf(r)!=="null"&&(typeOf(r)!=="boolean"||r)||uialert({message:u,showButtons:!0,noClose:!1}),!f)?!1:u}return!1},apiLockTimer:null,apiPendingMap:[],apiOverlayFocus:null,lockui:function(n){this.apiPendingMap.contains(n)||this.apiPendingMap.push(n);this.apiOverlay.removeClass("hidden");this.apiOverlay.addEvent("keyup",function(n){n.stop()});this.apiOverlay.addEvent("keydown",function(n){n.stop()});this.apiOverlay.addEvent("mousedown",function(n){n.stop()});this.apiOverlay.addEvent("click",function(n){n.stop()});this.apiOverlayFocus===null&&(this.apiOverlayFocus=document.activeElement);this.apiOverlay.focus();clearTimeout(this.apiLockTimer);this.apiLockTimer=this.forceunlockui.delay(1e4)},unlockui:function(n){if(this.apiPendingMap.contains(n)){var t=this.apiPendingMap.indexOf(n);t>-1&&this.apiPendingMap.splice(t,1)}this.apiPendingMap.length===0&&(clearTimeout(this.apiLockTimer),this.apiOverlay.addClass("hidden"),this.apiOverlay.removeEvents(),this.apiOverlayFocus!==null&&document.body.contains(this.apiOverlayFocus)&&(this.apiOverlayFocus.focus(),this.apiOverlayFocus=null))},forceunlockui:function(){clearTimeout(this.apiLockTimer);this.apiPendingMap=[];this.apiOverlay.addClass("hidden");this.apiOverlay.removeEvents();this.apiOverlayFocus!==null&&document.body.contains(this.apiOverlayFocus)&&(this.apiOverlayFocus.focus(),this.apiOverlayFocus=null)},logout:function(){window.fireEvent("logout")},logoutViaTab:function(){window.fireEvent("logoutViaTab")},loggedin:function(){this.isAdmin=parseInt(Affinity.login.profile.employeeNumber)>1e6?!0:!1;this.resetPanels();this.isConfig?this.switchToConfigView():this.isAdmin?(this.isManager=!0,this.switchToManagerView(),this.resetTabs()):this.checkManagerStatus();this.config||hj("tagRecording",["emp: "+Affinity.login.profile.employeeNumber,"co: "+Affinity.login.profile.companyNumber])},loggedout:function(){this.managerStatusRequest&&this.managerStatusRequest.isRunning()&&this.managerStatusRequest.cancel();this.currentView="";this.resetPanels();this.manager&&(this.manager.destroy(),this.manager=!1);this.employee&&(this.employee.destroy(),this.employee=!1);this.config&&(this.config.destroy(),this.config=!1);this.forceunlockui()},doPositionUpdateOrValidation:function(n,t,i){this._methodName="ui.leave.js -> doPositionUpdateOrValidation ()";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"DoPositionUpdateOrValidation/"+n);new Request.JSON({url:this._api,onRequest:function(){Affinity.leave.lockui("leave-doPositionUpdateOrValidation");this._noAlerts||uialert({message:" ",showLoader:!0,showButtons:!1,noClose:!0})}.bind(this),onSuccess:function(n){Affinity.leave.unlockui("leave-doPositionUpdateOrValidation");prompts.hide();n.IsValid!=undefined&&n.IsValid?t&&typeof t=="function"&&t(i):n.IsValid==undefined||n.IsValid||uialert({message:n.Message,showButtons:!0,noClose:!1})}.bind(this)}).post()},populateLeaveActivity:function(n,t,i){var u,e;if(n){u=new Element("div",{"class":"leave-activity"});n.adopt(u);var r=new Element("div",{"class":"toggle-button",html:Affinity.icons.ArrowLineSmallDown}),f=new Element("label",{"class":"activity-label details-label",html:"Show Activity"}),o=new Element("div",{"class":"activity-heading form-row ui-has-tooltip","data-tooltip":"Toggle Show Activity","data-tooltip-dir":"top"}).adopt(f,r).inject(u);this.activityEl=new Element("div",{"class":"activity-content",html:"loading ..."}).inject(u);this.activityEl.dissolve();r.store("state","closed");e=function(n){r.retrieve("state")==="closed"?(this.activityEl.reveal(),r.store("state","open"),r.set("html",Affinity.icons.ArrowLineSmallUp),f.set("html","Activity"),this.getLeaveActivity(t,i)):(this.activityEl.dissolve(),r.store("state","closed"),r.set("html",Affinity.icons.ArrowLineSmallDown),f.set("html","Show Activity"),this.activityEl.set("html",""));n.stopPropagation()}.bind(this);o.addEvent(Affinity.events.click,e);r.addEvent(Affinity.events.click,e)}},getLeaveActivity:function(n,t){var r="ui.myLeave.js -> GetLeaveActivity",i=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"LeaveActivity/"+n+"/"+t);new Request.JSON({url:i,onFailure:function(n){Affinity.leave.handleXHRErrors(n,i,r)},onSuccess:function(n){if(!Affinity.leave.isErrorInJson(n,i,r)){var t=new Element("div",{"class":"activity-events"});this.activityEl.set("html","");this.activityEl.adopt(t);n.Data.length==0&&t.set("html","No activity recorded.");Array.each(n.Data,function(n){var u=new Element("div",{"class":"activity-event"}),o=new Element("div",{"class":"activity-event-header"}),i=new Element("div",{"class":"activity-event-description"}),f=new Element("div",{"class":"activity-event-detail"}),s,e,r,h;Affinity.login.profile.employeeNumber==n.EmployeeNo?(u.setStyle("border-color","#7abd2d"),u.setStyle("margin-left","40px"),s=new Element("div").adopt(i,o),o.setStyle("text-align","right")):(u.setStyle("border-color","#44b5ec"),u.setStyle("margin-right","40px"),s=new Element("div").adopt(o,i));o.adopt(new Element("div",{"class":"activity-event-employee",html:"<b>"+n.EmployeeName+"<\/b> ("+n.EmployeeNo+")"}),new Element("div",{"class":"activity-event-time",html:Date.parse(n.EventDateTime).format("%d %b %Y %X")}));e=n.EventText;n.Audits.length>1&&(e+=" ("+n.Audits.length+" changes)",r=new Element("div",{"class":"toggle-button",html:Affinity.icons.ArrowLineSmallDown}).inject(i),i.addClass("ui-has-tooltip"),i.setProperty("data-tooltip","Toggle Show Activity Detail"),i.setProperty("data-tooltip-dir","left"),f.dissolve(),r.store("state","closed"),h=function(n){r.retrieve("state")==="closed"?(f.reveal(),r.store("state","open"),r.set("html",Affinity.icons.ArrowLineSmallUp)):(f.dissolve(),r.store("state","closed"),r.set("html",Affinity.icons.ArrowLineSmallDown));n.stopPropagation()}.bind(this),i.addEvent(Affinity.events.click,h),r.addEvent(Affinity.events.click,h));e="<b>"+e+"<\/b>";i.adopt(new Element("div",{"class":"activity-event-text",html:e}));Array.each(n.Audits,function(n){var t=new Element("div",{"class":"activity-event-audit"}).inject(f),r=new Element("div",{"class":"event-audit-tag"}).inject(t),i=new Element("span",{"class":"tag w-icon",html:'<span class="event-audit-description">'+n.Description+"<\/span>"}).inject(r);n.UpdateType=="Insert"?(i.addClass("green"),new Element("pre",{html:n.NewValue,"class":"event-audit-value"}).inject(t),new Element("span",{html:Affinity.icons.Plus}).inject(i,"top")):n.UpdateType=="Edit"?(i.addClass("blue"),new Element("span",{html:Affinity.icons.Pencil}).inject(i,"top"),new Element("pre",{html:n.OldValue,"class":"event-audit-old"}).inject(t),new Element("span",{"class":"icon-arrow-right color blue event-audit-arrow"}).inject(t),new Element("pre",{html:n.NewValue,"class":"event-audit-new"}).inject(t)):n.UpdateType=="Delete"&&(i.addClass("red"),new Element("span",{html:Affinity.icons.Trash}).inject(i,"top"),new Element("pre",{html:n.OldValue,"class":"event-audit-value"}).inject(t))}.bind(this));u.adopt(s,f).inject(t,"top")}.bind(this))}}.bind(this)}).get()},populateAttachments:function(n,t,i,r){t&&t.length>0&&(Affinity.uploaders.reset(r),function(){var u,r,f=document.getElement(".edit-leave-attachment").getElement(".uidone").getElement("table.ui-grid");Array.each(t,function(t,e){u=Affinity.leave.apiroot+"GetLeaveAttachment/"+n.EmployeeNo+"/"+n.TSGroupId+"/"+t.Id;r=t.Name.contains("fakepath")?t.Name.substring(t.Name.indexOf("fakepath")+9):t.Name;r=t.Name.contains("/")?t.Name.substring(t.Name.lastIndexOf("/")+1):t.Name;r=t.Name.contains("\\")?t.Name.substring(t.Name.lastIndexOf("\\")+1):t.Name;i.addFileRow(f,r,t.Id,"docs_file"+e,u)}.bind(this))}.delay(500,this));prompts.hide()},deleteAttachment:function(n,t,i,r){typeOf(r)==="function"&&(this._methodResponse=r);this._methodName="ui.leave.apply.js -> deleteAttachment";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"DeleteLeaveAttachment/"+n+"/"+t+"/"+i);this.deleteAttachmentRequest&&this.deleteAttachmentRequest.isRunning()&&this.deleteAttachmentRequest.cancel();this.deleteAttachmentRequest.url=this.deleteAttachmentRequest.options.url=this._api;this.deleteAttachmentRequest.get()},postAttachements:function(n,t,i){var f=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"CreateLeaveAttachment/"+n+"/"+t),e=this.hiddenAttachment.contentDocument||this.hiddenAttachment.contentWindow.document,r=new Element("form",{"class":"attachment-form-submit",enctype:"multipart/form-data",method:"post",action:f,target:"_self"}),u=document.getElements(".uploadmulti label input");u.length>0&&(Array.each(u,function(n,t){n.hasClass("initialValues")||n.files.length>0&&n.value!==""&&(n.inject(r),n.set("id","new_file_post_"+t),n.set("name","fileUpload"),n.removeEvents())}),r.inject(e.body),typeOf(i)==="function"?function(){this.hiddenAttachment.addEvent("load",function(){var t=this.hiddenAttachment.contentDocument||this.hiddenAttachment.contentWindow.document,n;try{n=JSON.parse(t.body.innerHTML)}catch(r){n=t.body.innerHTML}i(n);this.hiddenAttachment.removeEvents()}.bind(this));r.submit()}.delay(1e3,this):r.submit())},setDates:function(n,t){if(n&&typeOf(n)==="element"&&n.getElement(".day")&&n.getElement(".date")&&n.getElement(".month")&&n.getElement(".year")){var i="",r="",u="",f="";typeOf(t)==="date"&&t.isValid()&&(i=t.format("%a"),r=t.format("%e"),u=t.format("%b"),f=t.format("%Y"));n.getElement(".day").set("html",i);n.getElement(".date").set("html",r);n.getElement(".month").set("html",u);n.getElement(".year").set("html",f)}}}),UILeaveHistory=new Class({Implements:[Options,Events],Binds:["hide","show","toggle","getHistory","leaveHistoryFilters","teamLeaveHistoryFilters","refreshHistory","applyFilters","generateHistoryRow","generateHistoryRows","clearFilters","clearHistoryRows","historyPaginate","clearPagination","updateEmployeeFilter","reset","destroy",],options:{target:null,isManager:!1},initialize:function(n){var t,i;this.setOptions(n);this.filteredHistoryUri=!1;this.historyCurrentPage=1;this.historyPagingCount=8;this.target=this.options.target;this.isManager=this.options.isManager?!0:!1;this.section=new Element("div",{"class":"section shadow"});this.sectionBody=new Element("div",{"class":"section-body"}).inject(this.section);this.form=new Element("div",{"class":"default-form"}).inject(this.sectionBody);this.leaveHistory=new Element("div",{"class":"leave-history"}).inject(this.form);t=this.isManager?"Team Leave History":"View Leave History";this.titlebar=new Element("div",{"class":"section-title leave-history-title ui-has-tooltip",html:t,"data-tooltip":"Open / Close","data-tooltip-dir":"top"}).addEvent(Affinity.events.click,this.toggle).inject(this.leaveHistory);this.toggleButton=new Element("div",{"class":"toggle-button",html:Affinity.icons.ArrowLineSmallDown}).store("state","closed").inject(this.titlebar);this.leaveHistoryBox=new Element("div",{"class":"history-table",style:"display: block;"}).inject(this.leaveHistory);this.filterBox=new Element("div",{"class":"history-filter-box form-row"}).inject(this.leaveHistoryBox);this.isManager&&this.filterBox.addClass("history-filter-box-manager");this.noHistoryMessage=new Element("div",{"class":"hidden",style:"padding: 10px;",html:"There are no leave applications to show."});this.leaveHistoryTable=new Element("table",{"class":"leave hide-submitted-date"}).adopt(new Element("thead").adopt(this.tableHeaderRow=new Element("tr")),this.historyTableBody=new Element("tbody",{"class":"history-table-body"}));new Element("th",{"class":"active first",html:"Status"}).inject(this.tableHeaderRow);this.isManager&&new Element("th",{"class":"active",html:"Employee"}).inject(this.tableHeaderRow);new Element("th",{"class":"active",html:"Leave Type"}).inject(this.tableHeaderRow);new Element("th",{"class":"active",html:"Start Date"}).inject(this.tableHeaderRow);new Element("th",{"class":"active",html:"End Date"}).inject(this.tableHeaderRow);new Element("th",{"class":"active",html:"Units"}).inject(this.tableHeaderRow);this.isManager?new Element("th",{"class":"active submitted-date",html:"Submitted Date"}).inject(this.tableHeaderRow):new Element("th",{"class":"active",html:"Authoriser"}).inject(this.tableHeaderRow);this.tableSection=new Element("div",{"class":"section-table"}).adopt(this.noHistoryMessage,this.leaveHistoryTable).inject(this.leaveHistoryBox);this.paginateBox=new Element("div",{"class":"paginate-box pagination"}).inject(this.leaveHistoryBox);this.groupStatusType=new Element("div",{"class":"filter-group-box"}).inject(this.filterBox);this.groupDates=new Element("div",{"class":"filter-group-box"}).inject(this.filterBox);this.groupEmployee=new Element("div",{"class":"filter-group-box"}).inject(this.filterBox);this.isManager&&(this.groupSubmittedDate=new Element("div",{"class":"filter-group-box"}).inject(this.filterBox));this.groupOrderButtons=new Element("div",{"class":"filter-group-box"}).inject(this.filterBox);this.panelStatus=new Element("div",{"class":"filter-item"}).inject(this.groupStatusType);this.panelType=new Element("div",{"class":"filter-item"}).inject(this.groupStatusType);this.panelDateTo=new Element("div",{"class":"filter-item"}).inject(this.groupDates);this.panelDateFrom=new Element("div",{"class":"filter-item"}).inject(this.groupDates);this.panelEmployee=new Element("div",{"class":"filter-item"}).inject(this.groupEmployee);this.isManager&&(this.panelIndirect=new Element("div",{"class":"filter-item"}).inject(this.groupEmployee),this.panelShares=new Element("div",{"class":"filter-item"}).inject(this.groupEmployee),this.panelSubmittedDate=new Element("div",{"class":"filter-item"}).inject(this.groupSubmittedDate));this.panelOrder=new Element("div",{"class":"filter-item"}).inject(this.groupOrderButtons);this.panelButtons=new Element("div",{"class":"filter-item "}).inject(this.groupOrderButtons);this.panelButtonWrapper=new Element("div",{"class":"filter-buttons-box"}).inject(this.panelButtons);new Element("span",{"class":"filter-label",html:"Status"}).inject(this.panelStatus);this.leaveStatusFilter=new Element("select",{"class":"history-filter-select status-filter inline"}).adopt(new Element("option",{value:"0",html:"All",id:null}),new Element("option",{value:"1",html:"Approved",id:"3"}),new Element("option",{value:"2",html:"Declined",id:"2"}),new Element("option",{value:"3",html:"Pending",id:"0"}),new Element("option",{value:"4",html:"Cancelled",id:"6"})).inject(this.panelStatus);this.isManager?(new Element("span",{"class":"filter-label",html:"Employee"}).inject(this.panelEmployee),this.employeeFilter=new Element("select",{"class":"history-filter-select data-hj-whitelist leave-employee-filter"}).inject(this.panelEmployee),new Element("span",{"class":"filter-label include-indirect-filter",html:"Include Indirect"}).inject(this.panelIndirect),new Element("span",{"class":"filter-label leave-action-filter",html:"Leave to Action"}).inject(this.panelShares),this.includeIndirectWrapper=new Element("div",{"class":"input-wrapper"}).inject(this.panelIndirect),this.includeIndirect=new Element("input",{type:"checkbox","class":"include-indirect-filter",value:"includeIndirect"}).inject(this.includeIndirectWrapper),this.includeIndirect.addEvent("change",function(){this.employeeFilter&&this.updateEmployeeFilter(this.includeIndirect.checked,this.employeeFilter[this.employeeFilter.selectedIndex].get("id"))}.bind(this)),this.excludeNonApproversWrapper=new Element("div",{"class":"input-wrapper"}).inject(this.panelShares),this.excludeNonApprovers=new Element("input",{type:"checkbox","class":"leave-action-filter-checkbox",value:"excludeNonApprovers"}).inject(this.excludeNonApproversWrapper),this.isManager&&(new Element("span",{"class":"filter-label show-submitted-date",html:"Show Submitted Date"}).inject(this.panelSubmittedDate),this.includeSubmittedDateWrapper=new Element("div",{"class":"input-wrapper"}).inject(this.panelSubmittedDate),this.includeSubmittedDate=new Element("input",{type:"checkbox","class":"show-submitted-date",value:"showSubmittedDate"}).inject(this.includeSubmittedDateWrapper)),this.includeSubmittedDateValue=!1,this.includeSubmittedDate.addEvent("change",function(n){this.includeSubmittedDateValue=n.target.checked;this.includeSubmittedDateValue?this.leaveHistoryTable.removeClass("hide-submitted-date"):this.leaveHistoryTable.addClass("hide-submitted-date")}.bind(this)),i=[2593,6593,5e3],i.indexOf(Affinity.login.profile.companyNumber)>0&&this.panelShares.hide()):(new Element("span",{"class":"filter-label",html:"Submitted To"}).inject(this.panelEmployee),this.leaveSubmittedToFilter=new Element("select",{"class":"history-filter-select data-hj-whitelist submitted-to-filter inline"}).adopt(new Element("option",{value:"0",html:"All",id:null})).inject(this.panelEmployee));new Element("span",{"class":"filter-label",html:"Leave Type"}).inject(this.panelType);this.leaveTypeFilter=new Element("select",{"class":"history-filter-select data-hj-whitelist leave-type-filter inline"}).adopt(new Element("option",{value:"0",html:"All",id:null})).inject(this.panelType);new Element("span",{"class":"filter-label",html:"Date From"}).inject(this.panelDateTo);new Element("span",{"class":"form-row inline"}).adopt(this.dateFromFilter=new Element("input",{type:"text",id:"history-date-from","class":"data-hj-whitelist history-filter-date-from leave-filter-date inline uidate-calendar","data-calendar-display-format":"%d/%m/%y","data-calendar-return-format":"%d/%m/%Y","data-start-date":"none","data-calendar-nullable":"true",value:null})).inject(this.panelDateTo);new Element("span",{"class":"filter-label",html:"Date to"}).inject(this.panelDateFrom);new Element("span",{"class":"form-row inline"}).adopt(this.dateToFilter=new Element("input",{type:"text",id:"history-date-to","class":"data-hj-whitelist history-filter-date-to leave-filter-date inline uidate-calendar","data-calendar-display-format":"%d/%m/%y","data-calendar-return-format":"%d/%m/%Y","data-start-date":"none","data-calendar-nullable":"true",value:null})).inject(this.panelDateFrom);this.dateSubmittedOption=this.isManager?new Element("option",{value:"4",html:"Submitted Date",id:"DateSubmitted"}):null;new Element("span",{"class":"filter-label",html:"Order By"}).inject(this.panelOrder);this.leaveOrderFilter=new Element("select",{"class":"history-filter-select order-filter inline"}).adopt(new Element("option",{value:"0",html:" ",id:null}),new Element("option",{value:"1",html:"Start Date",id:"DateFrom"}),new Element("option",{value:"2",html:"End Date",id:"DateTo"}),new Element("option",{value:"3",html:"Units",id:"Hours"}),this.dateSubmittedOption).inject(this.panelOrder);this.applyFilter=new Element("span",{"class":"history-filter-apply button blue"}).adopt(new Element("span",{html:"Filter"})).inject(this.panelButtonWrapper);this.clearFilter=new Element("span",{"class":"history-filter-clear button grey ml-4"}).adopt(new Element("span",{html:"Clear"})).inject(this.panelButtonWrapper);this.section.inject(this.target);this.getHistoryRequest=new Request.JSON({headers:{Pragma:"no-cache"},onRequest:function(){Affinity.leave.lockui("leaveHistory-getHistoryRequest");this._noAlerts||uialert({message:"Loading History",showLoader:!0,showButtons:!1,noClose:!0})}.bind(this),onFailure:function(n){Affinity.leave.unlockui("leaveHistory-getHistoryRequest");this._noAlerts||prompts.hide();Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this),onException:function(){Affinity.leave.unlockui("leaveHistory-getHistoryRequest")},onCancel:function(){Affinity.leave.unlockui("leaveHistory-getHistoryRequest");this._noAlerts||prompts.hide()},onSuccess:function(n){Affinity.leave.unlockui("leaveHistory-getHistoryRequest");this._noAlerts||prompts.hide();Affinity.leave.isErrorInJson(n,this._api,this._methodName)||(this.data=n.Data,this.isManager&&Affinity.leave.manager?Affinity.leave.manager.applyTeamConfig(this.generateHistoryRows):Affinity.leave.employee&&Affinity.leave.employee.applyConfig(this.generateHistoryRows))}.bind(this)});Affinity.uiDateCalendar.processNew();this.isManager?Affinity.leave.manager.applyTeamConfig(this.teamLeaveHistoryFilters):Affinity.leave.employee.applyConfig(this.leaveHistoryFilters);window.addEvent("DeleteLeaveSuccess",this.refreshHistory);this.getHistory();this.show()},getHistory:function(){var t=Affinity.login.profile.employeeNumber,n,i;this.isManager?(i=new Date((new Date).setFullYear((new Date).getFullYear()-1)).format("%d-%b-%Y"),n="ManagerTeamLeaveHistory/"+t+"?StatusCode=0&dateFrom="+i+"&orderBy=DateSubmitted&isAscending=true"):n="MyLeaveHistory/"+t;this._methodName="ui.leave.history.js -> getHistory";this._api=this.filteredHistoryUri?this.filteredHistoryUri:Affinity.GetCacheSafePath(Affinity.leave.apiroot+n);this.getHistoryRequest&&this.getHistoryRequest.isRunning()&&this.getHistoryRequest.cancel();this.getHistoryRequest.url=this.getHistoryRequest.options.url=this._api;this.getHistoryRequest.get()},applyFilters:function(n){var l=Affinity.login.profile.employeeNumber,i,t,e,o,a,s,h,f,r,u,c;i=this.isManager?new URI(Affinity.leave.apiroot+"ManagerTeamLeaveHistory/"+l):new URI(Affinity.leave.apiroot+"MyLeaveHistory/"+l);t=typeOf(i.parsed.query)==="null"?{}:i.parsed.query.parseQueryString();t.PageNo=n;e=this.leaveStatusFilter[this.leaveStatusFilter.selectedIndex].get("id");e!==null&&(t.StatusCode=e);this.isManager?(o=this.employeeFilter[this.employeeFilter.selectedIndex].get("id"),o&&(t.EmployeeFilter=o),a=this.includeIndirect.checked,this.includeIndirect&&a&&(t.includeIndirect=!0),this.excludeNonApprovers&&this.excludeNonApprovers.checked&&(t.excludeNonApprovers=!0)):(s=this.leaveSubmittedToFilter[this.leaveSubmittedToFilter.selectedIndex].get("id"),s!==null&&(t.submittedTo=s));h=this.leaveTypeFilter[this.leaveTypeFilter.selectedIndex].get("id");h!==null&&(t.LeaveCode=h);r=this.dateFromFilter.getWidget().getRawDate();u=this.dateToFilter.getWidget().getRawDate();r&&typeOf(r)==="date"&&r.isValid()&&(f=r.format("%d-%b-%Y"),t.DateFrom=f);u&&typeOf(u)==="date"&&u.isValid()&&(f=u.format("%d-%b-%Y"),t.DateTo=f);c=this.leaveOrderFilter[this.leaveOrderFilter.selectedIndex].get("id");c!==null?t.orderBy=c:this.isManager&&(t.orderBy="DateSubmitted",t.isAscending=!0);i.parsed.query=Object.toQueryString(t);this._methodName="ui.leave.history.js -> applyFilters";this._api=Affinity.GetCacheSafePath(i.toString());this.filteredHistoryUri=this._api;this.getHistoryRequest&&this.getHistoryRequest.isRunning()&&this.getHistoryRequest.cancel();this.getHistoryRequest.url=this.getHistoryRequest.options.url=this._api;this.getHistoryRequest.get()},refreshHistory:function(n){this._noAlerts=typeOf(n)==="null"?!1:n;this.getHistory()},leaveHistoryFilters:function(n){this.leaveTypeFilter.empty();new Element("option",{value:"0",html:"All",id:null}).inject(this.leaveTypeFilter);Array.each(n.LeaveCodes,function(n,t){new Element("option",{html:n.Description,id:n.LeaveCode,value:t}).inject(this.leaveTypeFilter)}.bind(this));this.leaveSubmittedToFilter.empty();new Element("option",{value:"0",html:"All",id:null}).inject(this.leaveSubmittedToFilter);Array.each(n.Positions,function(n){Array.each(n.SubmittedTos,function(n,t){new Element("option",{html:n.EmployeeName+" ("+n.EmployeeNo+")",id:n.EmployeeNo,value:t}).inject(this.leaveSubmittedToFilter)}.bind(this))}.bind(this));this.applyFilter.removeEvents();this.applyFilter.addEvent(Affinity.events.click,function(){this.applyFilters(1);this.historyCurrentPage=1}.bind(this));this.clearFilter.removeEvents();this.clearFilter.addEvent(Affinity.events.click,function(){this.reset();this.getHistory()}.bind(this))},updateEmployeeFilter:function(n,t){if(this.employeeFilter&&this.Employees){this.employeeFilter.empty();new Element("option",{value:"0",html:"All",id:null}).inject(this.employeeFilter);var i=0,r=0;Array.each(this.Employees,function(u,f){(n||u.IsDirect)&&(new Element("option",{html:u.EmployeeName+" ("+u.EmployeeNo+")",id:u.EmployeeNo,value:f+1}).inject(this.employeeFilter),r++,t==u.EmployeeNo&&(i=r))}.bind(this));this.employeeFilter.selectedIndex=i;this.employeeFilterAutocomplete&&this.employeeFilterAutocomplete.revert();this.employeeFilterAutocomplete=new UIAutoCompleteWidget({stopInitialChange:!0,selectElement:this.employeeFilter})}},teamLeaveHistoryFilters:function(n){this.leaveStatusFilter.selectedIndex=3;this.dateFromFilter.getWidget().setDate(new Date((new Date).setFullYear((new Date).getFullYear()-1)));Array.each(n.AllCompanyLeaveCodes,function(n,t){new Element("option",{html:n.Description,id:n.LeaveCode,value:t}).inject(this.leaveTypeFilter)}.bind(this));this.Employees=n.Employees;this.updateEmployeeFilter(!1);this.applyFilter.removeEvents();this.applyFilter.addEvent(Affinity.events.click,function(){this.applyFilters(1);this.historyCurrentPage=1}.bind(this));this.clearFilter.removeEvents();this.clearFilter.addEvent(Affinity.events.click,function(){this.reset();this.getHistory()}.bind(this))},generateHistoryRows:function(n){this.clearHistoryRows();var t=this.data.History;Array.each(this.data.History,function(t){this.generateHistoryRow(t,n)}.bind(this));t.length>0?(this.leaveHistoryTable.removeClass("hidden"),this.noHistoryMessage.addClass("hidden")):(this.leaveHistoryTable.addClass("hidden"),this.noHistoryMessage.removeClass("hidden"));Affinity.tooltips.processNew();this.historyPaginate()},generateHistoryRow:function(n){var t=new Element("tr",{id:n.TSGroupId,"class":""}),c=!1,o,u,f,y,p,l,w,e,a,v;this.isManager&&(o=!n.AdminView&&n.Authorisations&&n.Authorisations.length>0?n.Authorisations[0]:{AuthorisationId:-1,StatusCode:n.StatusCode});var i="",u="grey",f="grey",r="";switch(n.StatusCode){case-1:i=Affinity.icons.Save;f="orange";u="orange";r="Leave has been saved";break;case 0:f="blue";Array.each(n.Authorisations,function(n){n.StatusCode==3&&(c=!0)});c?(i=Affinity.icons.ThumbsUp,u="green-blue",f="yellow",r="Leave has been partially approved but still pending"):(i=Affinity.icons.Hourglass,u="blue",r="Leave is pending approval");break;case 2:i=Affinity.icons.ThumbsDown;u="red";f="red";r="Leave has been declined";break;case 3:u="green";f="green";n.Status.test(/external/gi)?(i=Affinity.icons.ThumbsUp,r="Leave has been approved",u="grey",f="grey"):n.Status.test(/paid/gi)?(i=Affinity.icons.ThumbsUp,r="Leave has been approved"):(i=Affinity.icons.ThumbsUp,r="Leave has been approved");break;case 6:i=Affinity.icons.Cancel;u="grey";f="grey";r="Leave has been cancelled";break;case 7:i=Affinity.icons.Cancel;u="blue";f="blue";r="Leave cancellation is pending approval"}y=new Element("td",{"class":"active col-id-status indicate first "+u,html:'<div class="message-icon '+f+' print-hidden ui-has-tooltip" data-tooltip="'+r+'">'+i+"<\/div>"}).inject(t);this.isManager&&(p=new Element("td",{"class":"active col-id-employee indicate first",html:n.EmployeeName+" ("+n.EmployeeNo+")"}).inject(t));var b=new Element("td",{"class":"active col-id-type",html:n.CodeDescription}).inject(t),k=new Element("td",{"class":"active col-id-startdate",html:Date.parse(n.DateFrom).format("%d-%b-%Y")}).inject(t),d=new Element("td",{"class":"active col-id-enddate",html:Date.parse(n.DateTo).format("%d-%b-%Y")}).inject(t),s=" hours",h=n.TotalHours;n.UnitType==="D"?(s=" days",h=n.TotalDays):n.UnitType==="W"&&(s=" weeks",h=n.TotalWeeks);l=Affinity.leave.toFixed(h,2)+s;w=new Element("td",{"class":"active col-id-units",html:l}).inject(t);this.isManager?this.submittedDate=new Element("td",{"class":"active col-id-submitted-date",html:n.TimeSubmitted?Date.parse(n.TimeSubmitted).format("%d-%b-%Y %X"):""}).inject(t):(e="",Array.each(n.Authorisations,function(t,i){e+=t.ApprovedBy?t.ApprovedBy==-100?n.ApprovedByName:t.ApprovedByName+" ("+t.ApprovedBy+")":t.SubmittedTo==-100?n.SubmittedToName:t.SubmittedToName+" ("+t.SubmittedTo+")";i<n.Authorisations.length-1&&(e+=", ")}),this.submittedTo=new Element("td",{"class":"active col-id-authoriserid",html:e}).inject(t));a=function(){this.isManager?Affinity.leave.manager.leaveDetail.getDetail(n.EmployeeNo,n.TSGroupId,o):Affinity.leave.employee.leaveDetail.getDetail(n.EmployeeNo,n.TSGroupId,o)}.bind(this);v=this.isManager?function(){Affinity.leave.manager!==undefined&&Affinity.leave.manager!==null&&Affinity.leave.manager.leaveDetail!==undefined&&Affinity.leave.manager.leaveDetail!==null&&Affinity.leave.manager.leaveDetail.tryCreateAuditLogForImportedLeave(n.EmployeeNo,n.TSGroupId)}.bind(this):function(){Affinity.leave.employee!==undefined&&Affinity.leave.employee!==null&&Affinity.leave.employee.leaveDetail!==undefined&&Affinity.leave.employee.leaveDetail!==null&&Affinity.leave.employee.leaveDetail.tryCreateAuditLogForImportedLeave(n.EmployeeNo,n.TSGroupId)}.bind(this);t.addEvent(Affinity.events.click,v);t.addEvent(Affinity.events.click,a);t.inject(this.historyTableBody)},historyPaginate:function(){var n,r,u,e,f,t;for(typeOf(this.historyCurrentPage)!=="null"&&("historyCurrentPage"in this)||(this.historyCurrentPage=1),this.clearPagination(),n=this.data.PageCount,this.pageFirst=new Element("span",{"class":"pagination-first",html:"First"}).inject(this.paginateBox),this.pageBack=new Element("span",{"class":"pagination-back",html:"Previous"}).inject(this.paginateBox),this.pages=new Element("div",{"class":"pagination-pages"}).inject(this.paginateBox),this.pageForward=new Element("span",{"class":"pagination-forward",html:"Next"}).inject(this.paginateBox),this.pageLast=new Element("span",{"class":"pagination-last",html:"Last"}).inject(this.paginateBox),r=this.data.History.length,r>0&&(u=(this.historyCurrentPage-1)*15+1,e="showing "+u+" to "+(u+r-1)+" of "+this.data.Count,this.pageSubText=new Element("div",{"class":"pagination-sub-text",html:e}).inject(this.paginateBox)),f=0,i=1;i<=n;i++)i>this.historyCurrentPage-1-this.historyPagingCount/2&&f<=this.historyPagingCount?(f++,i==this.historyCurrentPage?(t=new Element("input",{type:"text","class":"paginate-page-numbers data-hj-whitelist",value:i}).inject(this.pages),function(t){t.addEvent("change",function(){var r=t.get("value"),i=parseInt(r);i==r&&i>0&&i<=n?(this.applyFilters(i),this.historyCurrentPage=i):uialert({message:"Unable to display page "+r,noClose:!1})}.bind(this))}.bind(this)(t)):(t=new Element("span",{"class":"paginate-page-numbers",html:i}).inject(this.pages),function(n,t){n.addEvent(Affinity.events.click,function(){this.applyFilters(t);this.historyCurrentPage=t}.bind(this))}.bind(this)(t,i))):(i==1||i==n)&&(t=new Element("span",{"class":"paginate-page-numbers not-clickable",html:"..."}).inject(this.pages));n>0&&this.historyCurrentPage!=1?(this.pageFirst.removeEvents(),this.pageFirst.addEvent(Affinity.events.click,function(){this.applyFilters(1);this.historyCurrentPage=1}.bind(this)),this.pageBack.removeEvents(),this.pageBack.addEvent(Affinity.events.click,function(){this.applyFilters(this.historyCurrentPage-1);this.historyCurrentPage=this.historyCurrentPage-1}.bind(this))):(this.pageFirst.addClass("not-active"),this.pageBack.addClass("not-active"));n>0&&this.historyCurrentPage!=this.data.PageCount?(this.pageLast.removeEvents(),this.pageLast.addEvent(Affinity.events.click,function(){this.applyFilters(this.data.PageCount);this.historyCurrentPage=this.data.PageCount}.bind(this)),this.pageForward.removeEvents(),this.pageForward.addEvent(Affinity.events.click,function(){this.applyFilters(this.historyCurrentPage+1);this.historyCurrentPage=this.historyCurrentPage+1}.bind(this))):(this.pageLast.addClass("not-active"),this.pageForward.addClass("not-active"))},clearFilters:function(){if(this.isManager?(this.leaveStatusFilter&&(this.leaveStatusFilter.selectedIndex=3),this.employeeFilter&&(this.employeeFilter.selectedIndex=0),this.employeeFilterAutocomplete&&this.employeeFilterAutocomplete.setValue("0"),this.includeIndirect&&(this.includeIndirect.checked=!1)):(this.leaveSubmittedToFilter&&(this.leaveSubmittedToFilter.selectedIndex=0),this.leaveStatusFilter&&(this.leaveStatusFilter.selectedIndex=0)),this.leaveTypeFilter&&(this.leaveTypeFilter.selectedIndex=0),this.dateFromFilter&&(this.dateFromFilter.value=null),this.dateToFilter&&(this.dateToFilter.value=null),this.dateFromFilter&&"getWidget"in this.dateFromFilter)try{this.dateFromFilter.getWidget().setNone()}catch(n){}if(this.dateToFilter&&"getWidget"in this.dateToFilter)try{this.dateToFilter.getWidget().setNone()}catch(n){}this.leaveOrderFilter&&(this.leaveOrderFilter.selectedIndex=0);this.filteredHistoryUri=!1},clearPagination:function(){this.paginateBox&&(this.pageFirst&&this.pageFirst.removeEvents(),this.pageBack&&this.pageBack.removeEvents(),this.pageForward&&this.pageForward.removeEvents(),this.pageLast&&this.pageLast.removeEvents(),this.pages&&Array.each(this.pages.getElements(".paginate-page-numbers"),function(n){n.removeEvents()}),this.paginateBox.empty())},clearHistoryRows:function(){this.leaveHistoryTable&&this.historyTableBody&&(Array.each(this.historyTableBody.getElements(".button"),function(n){n.removeEvents()}),this.historyTableBody.empty())},hide:function(){this.toggleButton.set("html",Affinity.icons.ArrowLineSmallDown).store("state","closed");this.leaveHistoryBox.dissolve()},show:function(){this.toggleButton.set("html",Affinity.icons.ArrowLineSmallUp).store("state","open");this.leaveHistoryBox.reveal()},toggle:function(){this.toggleButton.retrieve("state")==="open"?this.hide():this.show()},reset:function(n){this.getHistoryRequest&&this.getHistoryRequest.isRunning()&&this.getHistoryRequest.cancel();n||(this.clearFilters(),this.clearPagination());this.clearHistoryRows()},destroy:function(){if(window.removeEvent("DeleteLeaveSuccess",this.refreshHistory),this.reset(),this.applyFilter&&this.applyFilter.removeEvents(),this.clearFilter&&this.clearFilter.removeEvents(),this.IsManager&&this.employeeFilterAutocomplete&&this.employeeFilterAutocomplete.destroy(),this.section){try{this.titlebar.removeEvents()}catch(n){}Array.each(this.section.getElements(".button"),function(n){n.removeEvents()});Array.each(this.section.getElements(".ui-calendar-display"),function(n){n.getWidget().destroy()});this.section.empty();this.section.destroy()}Object.each(this,function(n,t){this[t]=null;delete this[t]}.bind(this))}}),UILeaveApply=new Class({Implements:[Options,Events],Binds:["hide","show","toggle","loadConfig","generatePositions","refreshApprovers","generateLeaveCodes","initiateReasonSelector","initiateDateRange","initiateAttachmentWidget","initiateInputFields","validateTotalUnitsAppliedFor","refreshEmployeeConfig","selectedEmployeeNumber","setLeaveCode","generateCalendar","editTimeModal","edititableDates","updateEditableDays","setHoursEvents","populateEditable","injectEdit","updatePosUnit","checkHours","setDates","leaveUnits","getLeaveUnits","processUnits","createResponseField","generateAttachments","generateApplyButtons","acknowledgementModal","save","submit","resetForm","reset","destroy","generateEmployees","updateEmployeeSelector","setEmployee","setEmployeeAndConfig","updateButtons"],options:{target:null,isManager:!1},hide:function(){this.toggleButton.set("html",Affinity.icons.ArrowLineSmallDown).store("state","closed");this.applyForm.dissolve()},show:function(){this.toggleButton.set("html",Affinity.icons.ArrowLineSmallUp).store("state","open");this.applyForm.reveal()},toggle:function(){this.toggleButton.retrieve("state")==="open"?this.hide():this.show()},refreshEmployeeConfig:function(){if(this.isManager&&this.employeeSelector&&this.Employees){var n=this.employeeSelector[this.employeeSelector.selectedIndex].get("id");this.updateEmployeeSelector(this.includeIndirect.checked,this.employeeSelector[this.employeeSelector.selectedIndex].get("id"));this.setEmployeeAndConfig(this.Employees[this.employeeSelector[this.employeeSelector.selectedIndex].get("value")-1]);this.timeinputs.addClass("hidden")}},createLeaveTypeGroup:function(n){this.leaveTypeGroup=new Element("div",{"class":"leave-apply-group"}).inject(n);this.leaveTypeGroupRow1=new Element("div",{"class":"form-row"}).inject(this.leaveTypeGroup);this.leaveTypeGroupRow2=new Element("div",{"class":"leave-apply-group-row"}).inject(this.leaveTypeGroup);this.leaveTypeGroupRow1Column1=new Element("span").inject(this.leaveTypeGroupRow1);this.leaveTypeGroupRow1Column2=new Element("span").inject(this.leaveTypeGroupRow1);this.leaveTypeGroupRow1Column3=new Element("span").inject(this.leaveTypeGroupRow1);this.leaveTypeGroupRow2Column1=new Element("span",{"class":"leave-apply-group-column-blank-container"}).inject(this.leaveTypeGroupRow2);this.leaveTypeGroupRow2Column2=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.leaveTypeGroupRow2);this.leaveTypeGroupRow2Column3=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.leaveTypeGroupRow2);this.leaveProjectionPlaceHolder=new Element("div",{"class":"leave-apply-leave-projection-placeholder"}).inject(this.leaveTypeGroupRow2);new Element("label",{html:"Leave Type","class":"leave-apply-group-title-label"}).inject(this.leaveTypeGroupRow1Column1);new Element("label",{html:"Leave Type","class":"leave-apply-group-column-label"}).inject(this.leaveTypeGroupRow1Column2);this.reasonLabel=new Element("label",{html:"Reason","class":"leave-apply-group-column-label"}).inject(this.leaveTypeGroupRow1Column3);this.type=new Element("div",{"class":"form-row leave-apply-type"}).inject(this.formData);this.reasonSelector=new Element("select",{"class":"leave-apply-select"}).inject(this.leaveTypeGroupRow2Column3)},createLeavePeriodGroup:function(n){this.leavePeriodGroup=new Element("div",{"class":"leave-apply-group"}).inject(n);this.leavePeriodGroupRow1=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);this.leavePeriodGroupRow2=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);this.leavePeriodGroupRow3=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);this.leavePeriodGroupRow4=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);this.leavePeriodGroupRow5=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);new Element("label",{html:"Leave Period","class":"leave-apply-group-title-label"}).inject(this.leavePeriodGroupRow1);this.dates=new Element("div",{"class":"leave-dates leave-apply-dates"}).inject(this.leavePeriodGroupRow2);this.leavePeriodDaysBox=new Element("div").inject(this.leavePeriodGroupRow3);this.leavPeriodRequestPartDayLabelColumn1=new Element("div",{"class":"leave-apply-group-column-blank-header"}).inject(this.leavePeriodGroupRow4);this.leavPeriodRequestPartDayLabelColumn2=new Element("div",{"class":"leave-apply-group-column-container"}).inject(this.leavePeriodGroupRow4);this.leavPeriodRequestPartDayLabelColumn3=new Element("div",{"class":"leave-apply-group-column-container"}).inject(this.leavePeriodGroupRow4);this.leavePeriodRequestPartDayInputColumn1=new Element("div",{"class":"leave-apply-group-column-blank-header"}).inject(this.leavePeriodGroupRow5);this.leavePeriodRequestPartDayInputColumn2=new Element("div",{"class":"leave-apply-group-column-container"}).inject(this.leavePeriodGroupRow5);this.leavePeriodRequestPartDayInputColumn3=new Element("div",{"class":"leave-apply-group-column-container"}).inject(this.leavePeriodGroupRow5);this.leavePeriodRequestPartDayLabel=new Element("label",{html:"Part Day Reason","class":"leave-apply-group-column-label"}).inject(this.leavPeriodRequestPartDayLabelColumn2);this.partDayReason=new Element("textarea",{"class":"leave-apply-text-area-small",rows:"4",id:"partDayReason",name:"partDayReason"}).inject(this.leavePeriodRequestPartDayInputColumn2);this.leavePeriodDaysBoxHeaderRow=new Element("div").inject(this.leavePeriodDaysBox);this.leavePeriodDaysBlankContainer=new Element("span",{"class":"leave-apply-group-column-blank-header"}).inject(this.leavePeriodDaysBoxHeaderRow);this.leavePeriodDaysDateTitle=new Element("label",{html:"Date","class":"leave-apply-leave-period-header-date"}).inject(this.leavePeriodDaysBoxHeaderRow);this.leavePeriodDaysDaysTitle=new Element("label",{html:"Days","class":"leave-apply-leave-period-header-days"}).inject(this.leavePeriodDaysBoxHeaderRow);this.leavePeriodDaysHoursTitle=new Element("label",{html:"Hours","class":"leave-apply-leave-period-header-hours"}).inject(this.leavePeriodDaysBoxHeaderRow);this.leavePeriodDaysHoursTitle=new Element("label",{html:"Scheduled","class":"leave-apply-leave-period-header-scheduled"}).inject(this.leavePeriodDaysBoxHeaderRow);this.leavePeriodDaysContainer=new Element("div",{"class":"leave-apply-days-value-container"}).inject(this.leavePeriodDaysBox)},createLeaveDetailsGroup:function(n){this.leaveDetailsGroup=new Element("div",{"class":"leave-apply-group"}).inject(n);this.leaveDetailsGroupRow1=new Element("div",{"class":"form-row"}).inject(this.leaveDetailsGroup);this.leaveDetailsGroupRow2=new Element("div",{"class":"leave-apply-group-row"}).inject(this.leaveDetailsGroup);this.leaveDetailsGroupRow3=new Element("div",{"class":"leave-apply-group-row"}).inject(this.leaveDetailsGroup);this.leaveDetailsGroupRow4=new Element("div",{"class":"leave-apply-group-row"}).inject(this.leaveDetailsGroup);this.leaveDetailsGroupRow5=new Element("div",{"class":"leave-apply-group-row"}).inject(this.leaveDetailsGroup);this.leaveDetailsGroupRow6=new Element("div",{"class":"leave-apply-group-row"}).inject(this.leaveDetailsGroup);this.leaveDetailsGroupRow7=new Element("div",{"class":"leave-apply-group-row"}).inject(this.leaveDetailsGroup);this.leaveDetailsGroupRow8=new Element("div",{"class":"leave-apply-group-row"}).inject(this.leaveDetailsGroup);this.leaveDetailsRow1Column1=new Element("span").inject(this.leaveDetailsGroupRow1);this.leaveDetailsRow1Column2=new Element("span").inject(this.leaveDetailsGroupRow1);this.leaveDetailsRow1Column3=new Element("span").inject(this.leaveDetailsGroupRow1);this.leaveDetailsRow2Column1=new Element("span",{"class":"leave-apply-group-column-blank-container"}).inject(this.leaveDetailsGroupRow2);this.leaveDetailsRow2Column2=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.leaveDetailsGroupRow2);this.leaveDetailsRow2Column3=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.leaveDetailsGroupRow2);this.leaveDetailsRow3Column1=new Element("span",{"class":"leave-apply-group-column-blank-container"}).inject(this.leaveDetailsGroupRow3);this.leaveDetailsRow3Column2=new Element("span").inject(this.leaveDetailsGroupRow3);this.leaveDetailsRow4Column1=new Element("span",{"class":"leave-apply-group-column-blank-container-for-attachment"}).inject(this.leaveDetailsGroupRow4);this.leaveDetailsRow4Column2=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.leaveDetailsGroupRow4);this.leaveDetailsRow5Column1=new Element("span",{"class":"leave-apply-group-column-blank-container"}).inject(this.leaveDetailsGroupRow5);this.leaveDetailsRow5Column2=new Element("span",{"class":"leave-apply-group-column-label-container"}).inject(this.leaveDetailsGroupRow5);this.leaveDetailsRow5Column3=new Element("span",{"class":"leave-apply-group-column-label-container"}).inject(this.leaveDetailsGroupRow5);this.leaveDetailsRow6Column1=new Element("span",{"class":"leave-apply-group-column-blank-container"}).inject(this.leaveDetailsGroupRow6);this.leaveDetailsRow6Column2=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.leaveDetailsGroupRow6);this.leaveDetailsRow6Column3=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.leaveDetailsGroupRow6);new Element("label",{html:"Leave Details","class":"leave-apply-group-title-label"}).inject(this.leaveDetailsRow1Column1);new Element("label",{html:"Comments","class":"leave-apply-group-column-label"}).inject(this.leaveDetailsRow1Column2);this.commentBox=new Element("textarea",{"class":"leave-apply-text-area",rows:"4",id:"comment",name:"comment"}).inject(this.leaveDetailsRow2Column2);new Element("label",{html:"Attachments","class":"leave-apply-group-column-label"}).inject(this.leaveDetailsRow3Column2);this.attachment=new Element("div",{"class":"form-row leave-apply-attachment leave-apply-attachment-form"}).inject(this.leaveDetailsRow4Column2);new Element("label",{html:"Approver","class":"leave-apply-group-column-label"}).inject(this.leaveDetailsRow5Column2);this.approverSelector=new Element("select",{"class":"leave-approver-selector leave-apply-select"}).inject(this.leaveDetailsRow6Column2)},createEmployeeDetailsGroup:function(n,t){t?(this.employeeIndirect=new Element("div",{"class":"form-row leave-apply-indirect"}).inject(n),new Element("label",{html:"Include Indirect"}).inject(this.employeeIndirect),this.employeeGroup=new Element("div",{"class":"leave-apply-group"}).inject(n),this.employeeGroupRow1=new Element("div",{"class":"form-row"}).inject(this.employeeGroup),this.employeeInputRow=new Element("div",{"class":"leave-apply-row"}).inject(this.employeeGroup),this.employeeInputColumn1=new Element("span",{"class":"leave-apply-group-column-blank-container"}).inject(this.employeeInputRow),this.employeeInputColumn2=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.employeeInputRow),this.employeeInputColumn3=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.employeeInputRow),this.includeIndirect=new Element("input",{type:"checkbox","class":"include-indirect-filter",value:"includeIndirect"}).inject(this.employeeIndirect),this.includeIndirect.addEvent("change",function(){if(this.employeeSelector&&this.Employees){var n=this.employeeSelector[this.employeeSelector.selectedIndex].get("id");this.updateEmployeeSelector(this.includeIndirect.checked,this.employeeSelector[this.employeeSelector.selectedIndex].get("id"));n!=this.employeeSelector[this.employeeSelector.selectedIndex].get("id")&&this.setEmployee(this.Employees[this.employeeSelector[this.employeeSelector.selectedIndex].get("value")-1])}}.bind(this))):(this.employeeGroup=new Element("div",{"class":"leave-apply-group"}).inject(this.formData),this.employeeGroupRow1=new Element("div",{"class":"form-row"}).inject(this.employeeGroup),this.employeeInputRow=new Element("div",{"class":"leave-apply-row"}).inject(this.employeeGroup),new Element("label",{html:"Employee Details","class":"leave-apply-group-main-label"}).inject(this.employeeGroupRow1),new Element("label",{html:"Position","class":"leave-apply-group-column-label"}).inject(this.employeeGroupRow1),this.employeeInputColumn1=new Element("span",{"class":"leave-apply-group-column-blank-container"}).inject(this.employeeInputRow),this.employeeInputColumn2=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.employeeInputRow),this.employeeInputColumn3=new Element("span",{"class":"leave-apply-group-column-container"}).inject(this.employeeInputRow),this.employeeInput=new Element("div",{style:"margin-right:0"}).inject(this.formData))},getFormTitle:function(n){return n?"Create Team Leave":"Apply for Leave"},initialize:function(n){this.setOptions(n);this.target=this.options.target;this.isManager=this.options.isManager?!0:!1;this.section=new Element("div",{"class":"section shadow"}).inject(this.target);this.sectionBody=new Element("div",{"class":"section-body"}).inject(this.section);this.form=new Element("div",{"class":"default-form"}).inject(this.sectionBody);this.ealInfo=null;var t=this.getFormTitle(this.isManager);this.ealProjectionReturned=!1;this.leaveAvailabilityCounter=0;this.nonconfiguredLeaveTypes=["A","B","C","D","E","S"];this.availableLeaveCodes=["07","09","10","12","13","11"];this.title=new Element("div",{"class":"section-title leave-apply-title ui-has-tooltip",html:t,"data-tooltip":"Open / Close","data-tooltip-dir":"top"}).addEvent(Affinity.events.click,this.toggle).inject(this.form);this.toggleButton=new Element("div",{"class":"toggle-button",html:Affinity.icons.ArrowLineSmallDown}).store("state","closed").inject(this.title);this.applyForm=new Element("div",{style:"display:block;"}).inject(this.form);this.leaveData=new Element("div",{"class":"leave-form default-form"}).inject(this.applyForm);this.formData=new Element("form").inject(this.leaveData);this.createEmployeeDetailsGroup(this.formData,this.isManager);this.createLeaveTypeGroup(this.formData);this.createLeavePeriodGroup(this.formData);this.createLeaveDetailsGroup(this.formData);this.approversForm=new Element("form").inject(this.leaveData);this.approvers=new Element("div",{"class":"form-row leave-apply-approvers"}).inject(this.approversForm);this.hiddenApprovers=new Element("div",{"class":"hidden"}).inject(this.approversForm);this.hiddenResponse=new Element("span",{"class":"leave-response"}).store("data","").inject(this.leaveData);this.buttons=new Element("div",{"class":"form-row apply-buttons"}).inject(this.leaveData);this.applyForm.toggle();this.updateEditableDaysRequest=new Request.JSON({onRequest:function(){Affinity.leave.lockui("leaveApply-updateEditableDaysRequest")},onFailure:function(n){Affinity.leave.unlockui("leaveApply-updateEditableDaysRequest");Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this),onException:function(){Affinity.leave.unlockui("leaveApply-updateEditableDaysRequest")},onCancel:function(){Affinity.leave.unlockui("leaveApply-updateEditableDaysRequest")},onSuccess:function(n){Affinity.leave.unlockui("leaveApply-updateEditableDaysRequest");Affinity.leave.isErrorInJson(n,this._api,this._methodName)||this.populateEditable(n,this._dataDateRange)}.bind(this)});this.projectBalanceRequest=new Request.JSON({headers:{Pragma:"no-cache"},onFailure:function(n){Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onSuccess:function(n){if(!Affinity.leave.isErrorInJson(n,this._api,this._methodName))if(n.Data.ComponentBalances.length>0&&n.Data.ComponentBalances[0].CodeBalances.length>0&&this.typeSelector.selectedIndex!==0){this.ealProjectionReturned=!0;this.ealInfo=n.Data.ComponentBalances[0].CodeBalances[0];var t=document.getElementById("inlineEalSummary"),i=document.getElementById("inlineEalStory");i&&t&&(document.getElementById("inlineProjectionInfo").style.display="inline-block",t.innerText=this.ealInfo.UnitType=="H"?this.ealInfo.TotalHours+" hours":this.ealInfo.TotalDays+" days")}else document.getElementById("inlineProjectionInfo").style.display="none"}.bind(this)});this.leaveUnitsRequest=new Request.JSON({method:"get",onRequest:function(){this.updateButtons(!1);Affinity.leave.lockui("leaveApply-leaveUnitsRequest");Affinity.leave.lockui("leaveApply-leaveUnitsRequest");uialert({message:"Calculating leave units. Please wait",showLoader:!0,showButtons:!1,noClose:!0})}.bind(this),onFailure:function(n){Affinity.leave.unlockui("leaveApply-leaveUnitsRequest");prompts.hide();Affinity.leave.handleXHRErrors(n,this._api,this._methodName)||uialert({message:"We can't load that information. Please try again.",okText:"Retry",showCancel:!0,onOk:function(){this.leaveUnitsRequest.send()}.bind(this)})}.bind(this),onException:function(){Affinity.leave.unlockui("leaveApply-leaveUnitsRequest");prompts.hide()},onCancel:function(){Affinity.leave.unlockui("leaveApply-leaveUnitsRequest");prompts.hide()},onSuccess:function(n){if(Affinity.leave.unlockui("leaveApply-leaveUnitsRequest"),prompts.hide(),!Affinity.leave.isErrorInJson(n,this._api,this._methodName)){if(this.retainTotalUnitsAppliedFor&&this.savedData){if(this.data=this.savedData,this.leaveCode){var t=0,i=this.leaveCode.UnitType,r=n.Data.Days;Array.each(this.data,function(n){var u,f;i==="H"&&n.Hours?(t+=parseFloat(n.Hours),u=r.filter(function(t){if(t.Date==n.Date)return t}),u.length>0&&(u[0].TotalHoursAppliedFor=n.Hours,f=u[0].PositionUnits.filter(function(t){if(t.PositionCode==n.PositionCode)return t}),f.length>0&&(f[0].HoursAppliedFor=n.Hours))):i==="D"&&n.Days?(t+=parseFloat(n.Days),n.Hours=n.Hours*n.Days,u=r.filter(function(t){if(t.Date==n.Date)return t}),u.length>0&&(u[0].TotalDaysAppliedFor=n.Days,f=u[0].PositionUnits.filter(function(t){if(t.PositionCode==n.PositionCode)return t}),f.length>0&&(f[0].DaysAppliedFor=n.Days))):i==="W"&&(t+=parseFloat(n.Weeks))});i=="H"?n.Data.TotalHoursAppliedFor=t:i=="D"&&(n.Data.TotalDaysAppliedFor=t);this.unitInput.set("html",parseFloat(t).toFixed(2));this.unitInput.set("id",t);this.clearBorderHilights();this.calculateLeaveAvailability(t);this.checkHours(this.data)}this.retainTotalUnitsAppliedFor=!1}this.responseData=n.Data;this.processUnits(n.Data)&&(this.checkHours(n.Data),this.createResponseField(n.Data),this.updateButtons(!0),this.createDaysFields(n.Data))}}.bind(this)});this.sendApplicationRequest=new Request.JSON({headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("leaveApply-sendApplicationRequest");uialert({message:"Processing leave application. Please wait",showLoader:!0,showButtons:!1,noClose:!0})},onFailure:function(n){Affinity.leave.unlockui("leaveApply-sendApplicationRequest");prompts.hide();Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this),onException:function(){Affinity.leave.unlockui("leaveApply-sendApplicationRequest");prompts.hide()},onCancel:function(){Affinity.leave.unlockui("leaveApply-sendApplicationRequest");prompts.hide()},onSuccess:function(n){if(Affinity.leave.isErrorInJson(n,this._api,this._methodName,!0))Affinity.leave.unlockui("leaveApply-sendApplicationRequest"),prompts.hide(),this.acknowledgementModal(n);else{var t=this,i=n;Affinity.leave.postAttachements(n.Data.EmployeeNo,n.Data.TSGroupId,function(){Affinity.leave.unlockui("leaveApply-sendApplicationRequest");prompts.hide();t.acknowledgementModal(i)}.bind(this));this.isManager?Affinity.leave.manager.refreshAll():Affinity.leave.employee.refreshAll();this.resetForm();this.initiateInputFields();this.savedData=undefined}}.bind(this)});this.generateAttachments();this.generateApplyButtons();this.isManager?Affinity.leave.manager.applyTeamConfig(this.loadConfig):Affinity.leave.employee.applyConfig(this.loadConfig)},createDaysFields:function(n){n.Days.length>0&&(this.leavePeriodDaysContainer!==undefined&&this.leavePeriodDaysContainer.destroy(),this.leavePeriodDaysContainer=new Element("div",{"class":"leave-apply-days-value-container"}).inject(this.leavePeriodDaysBox),Array.each(n.Days,function(n,t){this.leavePeriodDaysBoxValueRow=new Element("div").inject(this.leavePeriodDaysContainer);this.leavePeriodDaysDateColumnBlankContainer=new Element("span",{"class":"leave-apply-group-column-blank-header"}).inject(this.leavePeriodDaysBoxValueRow);this.leavePeriodDaysDateColumnContainer=new Element("span").inject(this.leavePeriodDaysBoxValueRow);this.leavePeriodDaysDaysColumnContainer=new Element("span").inject(this.leavePeriodDaysBoxValueRow);this.leavePeriodDaysHoursColumnContainer=new Element("span").inject(this.leavePeriodDaysBoxValueRow);this.leavePeriodDaysScheduledColumnContainer=new Element("span").inject(this.leavePeriodDaysBoxValueRow);var u=n.Date,f=u.toDate().toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),i=n.PositionUnits[0].HoursWorkScheduled===null?n.PositionUnits[0].HoursStandard:n.PositionUnits[0].HoursWorkScheduled;i=parseFloat(i).toFixed(2);var e=parseFloat(n.PositionUnits[0].DaysAppliedFor).toFixed(2),o=parseFloat(n.PositionUnits[0].HoursAppliedFor).toFixed(2),r=n.IsPublicHoliday,s=parseFloat(i);r&&(i=parseFloat(0).toFixed(2));this.leavePeriodDaysDateColumnValue=new Element("input",{id:"date-"+t,type:"text","class":"leave-apply-input-date",value:f,readonly:"true"}).inject(this.leavePeriodDaysDateColumnContainer);this.leavePeriodDaysDaysColumnValue=new Element("input",{id:"days-"+t,type:"text","class":"leave-apply-input-days",value:e,readonly:"true"}).inject(this.leavePeriodDaysDaysColumnContainer);this.leavePeriodDaysHoursColumnValue=new Element("input",{id:"hours-"+t,type:"text","class":"leave-apply-input-hours",value:o}).inject(this.leavePeriodDaysHoursColumnContainer);this.leavePeriodDaysScheduledColumnValue=new Element("input",{id:"scheduledHours-"+t,type:"text","class":"leave-apply-input-uneditable-scheduledHours",value:i,readonly:"true"}).inject(this.leavePeriodDaysScheduledColumnContainer);this.leavePeriodDaysDefaultScheduledColumnValue=new Element("input",{id:"defaultScheduledHours-"+t,type:"hidden","class":"leave-detail-input-defaultScheduledHours",value:s}).inject(this.leavePeriodDaysScheduledColumnContainer);this.leavePeriodDaysIsPublicHolidayColumnValue=new Element("input",{id:"isPublicHoliday-"+t,type:"hidden","class":"leave-detail-input-isPublicHoliday",value:r}).inject(this.leavePeriodDaysScheduledColumnContainer);this.isManager&&Affinity.leave.manager.config&&(this.leavePeriodDaysScheduledColumnValue.set("readonly",!1),this.leavePeriodDaysScheduledColumnValue.removeClass("leave-apply-input-uneditable-scheduledHours"),this.leavePeriodDaysScheduledColumnValue.addClass("leave-apply-input-scheduledHours"));r&&(this.leavePeriodDaysHoursColumnValue.set("readonly",!0),this.leavePeriodDaysHoursColumnValue.removeClass("leave-apply-input-hours"),this.leavePeriodDaysHoursColumnValue.addClass("leave-apply-input-uneditable-hours"),this.leavePeriodDaysScheduledColumnValue.set("readonly",!0),this.leavePeriodDaysScheduledColumnValue.removeClass("leave-apply-input-scheduledHours"),this.leavePeriodDaysScheduledColumnValue.addClass("leave-apply-input-uneditable-scheduledHours"))}.bind(this)),this.leavePeriodDaysContainer!==undefined&&(this.totalPeriodDaysDetail!==undefined&&this.totalPeriodDaysDetail.destroy(),this.registerFocusOutEvents(),Affinity.leave.manager&&this.isManager?Affinity.leave.manager.leaveDetail.formatFields(this,this.data):Affinity.leave.employee.leaveDetail.formatFields(this,this.data),this.computeUnitTotals()))},computeUnitTotals:function(){var t,u,f,n;if(this.leavePeriodDaysContainer!==undefined){this.totalPeriodDaysDetail!==undefined&&this.totalPeriodDaysDetail.destroy();var e=this.data,i=0,r=0;for(t=0;t<e.length;t++)u=this.leavePeriodDaysContainer.getElementById("days-"+t),f=this.leavePeriodDaysContainer.getElementById("hours-"+t),i=parseFloat(i)+parseFloat(u.value),r=parseFloat(r)+parseFloat(f.value);n="Total [days] days / [hours] hours";n=n.replace("[days]",parseFloat(i).toFixed(2));n=n.replace("[hours]",parseFloat(r).toFixed(2));this.totalPeriodDaysDetail=new Element("label",{html:n,"class":"leave-apply-total-period-days-detail"}).inject(this.leavePeriodDaysBox)}},registerFocusOutEvents:function(){for(var t,i,u=this.data,r=this,n=0;n<u.length;n++)t=this.leavePeriodDaysContainer.getElementById("hours-"+n),i=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+n),t.removeEvents(),t.addEvent("focusout",function(){Affinity.leave.manager&&this.isManager?Affinity.leave.manager.leaveDetail.formatFields(this,this.data):Affinity.leave.employee.leaveDetail.formatFields(this,this.data);this.computeUnitTotals(r)}.bind(this)),i.removeEvents(),i.addEvent("focusout",function(){Affinity.leave.manager&&this.isManager?Affinity.leave.manager.leaveDetail.formatFields(this,this.data):Affinity.leave.employee.leaveDetail.formatFields(this,this.data);this.computeUnitTotals(r)}.bind(this))},highlightUnitFieldsIfNotEqualToDefaultValue:function(){for(var u,e=this.data,n=0;n<e.length;n++){var i=this.leavePeriodDaysContainer.getElementById("date-"+n),f=this.leavePeriodDaysContainer.getElementById("days-"+n),t=this.leavePeriodDaysContainer.getElementById("hours-"+n),o=this.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+n),r=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+n),s=this.leavePeriodDaysContainer.getElementById("isPublicHoliday-"+n);t.set("style","");f.set("style","");i.set("style","");r.set("style","");u=s.value==="true"?!0:!1;u&&(r.set("readonly",!0),i.set("style","background-color: #C0C0C0 !important;"),f.set("style","background-color: #C0C0C0 !important;"),t.set("style","background-color: #C0C0C0 !important;"),r.set("style","background-color: #C0C0C0 !important;"));(i.value.indexOf("aturday")!==-1||i.value.indexOf("unday")!==-1)&&(i.set("style","background-color: #C0C0C0 !important;"),f.set("style","background-color: #C0C0C0 !important;"),t.set("style","background-color: #C0C0C0 !important;"),r.set("style","background-color: #C0C0C0 !important;"));Affinity.leave.manager&&this.isManager&&!u&&(t.set("style",""),r.set("style",""));!Affinity.leave.employee||this.isManager||u||t.set("style","");u||parseFloat(t.value)!==parseFloat(o.value)&&(t.set("style","background-color: yellow !important;"),f.set("style","background-color: yellow !important;"))}},computeUnitsDaysAppliedFor:function(){for(var n,u=this.data,t=0;t<u.length;t++){var f=this.leavePeriodDaysContainer.getElementById("days-"+t),i=this.leavePeriodDaysContainer.getElementById("hours-"+t),r=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+t);i.value=parseFloat(i.value).toFixed(2);r.value=parseFloat(r.value).toFixed(2);n=parseFloat(i.value)/parseFloat(r.value);n>1?n=1:isNaN(n)&&(n=0);f.value=parseFloat(n).toFixed(2)}},setAllFieldsToReadOnlyIfLeaveCanEditByDays:function(n,t){for(var f=t.data,r=0;r<f.length;r++){var e=f[r],o=this.leavePeriodDaysContainer.getElementById("date-"+r),s=this.leavePeriodDaysContainer.getElementById("days-"+r),u=this.leavePeriodDaysContainer.getElementById("hours-"+r),h=this.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+r),i=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+r);n?(u.set("readonly",!1),Affinity.leave.manager&&this.isManager?(i.set("readonly",!1),i.removeClass("leave-detail-input-uneditable-scheduledHours"),i.addClass("leave-detail-input-scheduledHours")):(i.set("readonly",!0),i.removeClass("leave-detail-input-scheduledHours"),i.addClass("leave-detail-input-uneditable-scheduledHours"))):(u.set("readonly",!0),u.removeClass("leave-apply-input-hours"),u.addClass("leave-apply-input-uneditable-hours"),i.set("readonly",!0),i.removeClass("leave-detail-input-scheduledHours"),i.addClass("leave-detail-input-uneditable-scheduledHours"))}},setScheduledHoursToReadOnlyIfHoursIsZero:function(){for(var i=this.data,n=0;n<i.length;n++){var u=i[n],e=this.leavePeriodDaysContainer.getElementById("date-"+n),o=this.leavePeriodDaysContainer.getElementById("days-"+n),r=this.leavePeriodDaysContainer.getElementById("hours-"+n),f=this.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+n),t=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+n);parseFloat(r.value)===0?(u.isPublicHoliday||(t.value=parseFloat(f.value)),t.set("readonly",!0),t.removeClass("leave-detail-input-scheduledHours"),t.addClass("leave-detail-input-uneditable-scheduledHours")):parseFloat(r.value)>0&&Affinity.leave.manager&&this.isManager&&(t.set("readonly",!1),t.removeClass("leave-detail-input-uneditable-scheduledHours"),t.addClass("leave-detail-input-scheduledHours"))}},formatUnitsToDecimalFormat:function(){for(var u=this.data,n=0;n<u.length;n++){var t=this.leavePeriodDaysContainer.getElementById("days-"+n),i=this.leavePeriodDaysContainer.getElementById("hours-"+n),r=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+n);t.value=parseFloat(t.value).toFixed(2);i.value=parseFloat(i.value).toFixed(2);r.value=parseFloat(r.value).toFixed(2)}},loadConfig:function(n){this.leaveTypeMap=n.LeaveCodes.mapFromKey("LeaveCode");this.generateLeaveCodes(n.LeaveCodes);this.generateCalendar(n);this.setLeaveCode();this.isManager?this.generateEmployees(n.Employees):this.generatePositions(n.Positions)},generatePositions:function(n){var t=n.length>1;n.length===1?this.employeeInputColumn3!==undefined&&(this.positionDescription=new Element("label",{"class":"position",html:n[0].PositionTitle,id:n[0].PositionCode}).inject(this.employeeInputColumn3)):(this.positionSelector=new Element("select",{"class":"leave-position-selector"}).inject(this.position),new Element("option",{value:"0",html:"All",id:"-01"}).inject(this.positionSelector,"top"),Array.each(n,function(n,t){var i=n.PositionTitle;n.IsExpired&&(i+=" (expired)");new Element("option",{value:t+1,html:i,id:n.PositionCode}).inject(this.positionSelector)}.bind(this)),this.positionSelector.addEvent("change",function(t){this.refreshApprovers(n,t.target.selectedIndex-1);this.leaveUnits()}.bind(this)));Array.each(n,function(n){n!==undefined&&n!==null&&n.SubmittedTos!==undefined&&n.SubmittedTos!==null&&n.SubmittedTos.length>1&&(this.def=new Element("option",{value:"0",html:""}).inject(this.approverSelector,"top"));this.approverSelector.selectedIndex=0;this.approverSelector.set("id",n.PositionCode);Array.each(n.SubmittedTos,function(n,t){new Element("option",{value:t+1,html:n.EmployeeName+" ("+n.EmployeeNo+")",id:n.EmployeeNo}).inject(this.approverSelector)}.bind(this))}.bind(this))},refreshApprovers:function(n,t){this.approvers.set("html","");var i=n.length>1;n&&typeOf(n)==="array"&&Array.each(n,function(n,r){(t<0||t==r)&&(this.approverBox=new Element("div",{"class":"leave-approver-box"}).inject(this.approvers),this.label=i?new Element("label",{html:"Approver - "+n.PositionTitle}).inject(this.approverBox):new Element("label",{html:"Approver"}).inject(this.approverBox),this.approverSelector=new Element("select",{"class":"leave-approver-selector"}).inject(this.approverBox),this.approverSelector.selectedIndex=0,this.approverBox.set("id",n.PositionCode),this.approverSelector.set("id",n.PositionCode),Array.each(n.SubmittedTos,function(n,t){this.option=new Element("option",{value:t+1,html:n.EmployeeName+" ("+n.EmployeeNo+")",id:n.EmployeeNo}).inject(this.approverSelector)}.bind(this)))}.bind(this))},updateEmployeeSelector:function(n,t){if(this.employeeSelector&&this.Employees){this.employeeSelector.empty();var u=new Element("option",{value:"0",id:"0",html:""}).inject(this.employeeSelector,"top"),i=0,r=0;Array.each(this.Employees,function(u,f){(n||u.IsDirect)&&(new Element("option",{html:u.EmployeeName+" ("+u.EmployeeNo+")",id:u.EmployeeNo,value:f+1}).inject(this.employeeSelector),r++,t==u.EmployeeNo&&(i=r))}.bind(this));this.employeeSelector.selectedIndex=i;this.employeeSelectorAutocomplete&&this.employeeSelectorAutocomplete.revert()}},generateEmployees:function(n){this.Employees=n;new Element("label",{html:"Employee","class":"leave-apply-group-main-label"}).inject(this.employeeGroupRow1);new Element("label",{html:"Full Name","class":"leave-apply-group-column-label"}).inject(this.employeeGroupRow1);new Element("label",{html:"Position","class":"leave-apply-group-column-label"}).inject(this.employeeGroupRow1);this.employeeSelector=new Element("select",{"class":"leave-apply-select"}).inject(this.employeeInputColumn2);this.employeeSelector.addEvent("change",function(){this.updateButtons(!1),function(){var n=this.Employees[this.employeeSelector[this.employeeSelector.selectedIndex].get("value")-1];this.setEmployee(n);n?(this.positionDescription!==undefined&&this.positionDescription.removeClass!==undefined&&this.positionDescription.removeClass("hidden"),this.selectedEmployeeNumber!==n.EmployeeNo&&this.timeinputs.addClass("hidden")):this.positionDescription.addClass("hidden")}.bind(this).delay(1e3,this)}.bind(this));this.updateEmployeeSelector(!1)},initiateDateRange:function(){var n=new Date,i=String(n.getDate()),r=String(n.getMonth()+1),u=n.getFullYear(),t;n=i+"/"+r+"/"+u;t=Date.parse(n);Affinity.leave.setDates(this.fromDateBox,t);Affinity.leave.setDates(this.toDateBox,t);this.fromDateWidget.setDate(t);this.toDateWidget.setDate(t);this.clearBorderHilights();this.leaveCode!=undefined&&this.leaveCode!==null&&this.leaveUnits()},initiateAttachmentWidget:function(){this.attachWidgetDiv},initiateInputFields:function(){this.typeSelector.selectedIndex=0;this.leaveCode=null;this.initiateReasonSelector();this.initiateDateRange();this.commentBox.value="";this.partDayReason.value="";this.initiateAttachmentWidget();this.updateButtons(!1);this.timeinputs.addClass("hidden");var n=document.getElementById("inlineProjectionInfo");n!==undefined&&n!==null&&n.style!==undefined&&n.style.display!==undefined&&(n.style.display="none");this.leavePeriodDaysContainer!==undefined&&(this.leavePeriodDaysContainer.destroy(),this.totalPeriodDaysDetail!==undefined&&this.totalPeriodDaysDetail.destroy())},setEmployeeAndConfig:function(n){this.positionDescription&&this.positionDescription.destroy();this.positionSelector&&this.positionSelector.destroy();var t=document.getElements(".leave-approver-box");t&&t.length>0&&t.destroy();n&&n.EmployeeNo&&Affinity.leave.manager.getManagerEmployeeConfigFromBackend(n.EmployeeNo,function(n){this.retainTotalUnitsAppliedFor=this.timeinputs!==undefined&&this.timeinputs.hasClass("hidden")?!1:!0;this.generatePositions(n.Positions);this.leaveUnits();this.leaveTypeMap=n.LeaveCodes.mapFromKey("LeaveCode");var t=this.typeSelector.selectedIndex;this.generateLeaveCodes(n.LeaveCodes);this.typeSelector.selectedIndex=t}.bind(this))},setEmployee:function(n){var i=!1,t;n!==undefined&&n.EmployeeNo!==null&&(this.selectedEmployeeNumber!==n.EmployeeNo&&(i=!0),this.selectedEmployeeNumber=n.EmployeeNo);i?(this.positionDescription&&this.positionDescription.destroy(),this.positionSelector&&this.positionSelector.destroy(),t=document.getElements(".leave-approver-box"),t&&t.length>0&&t.destroy(),this.initiateInputFields(),n&&n.EmployeeNo&&Affinity.leave.manager.getManagerEmployeeConfig(n.EmployeeNo,function(n){this.generatePositions(n.Positions);this.leaveUnits();this.leaveTypeMap=n.LeaveCodes.mapFromKey("LeaveCode");this.generateLeaveCodes(n.LeaveCodes);this.leaveCode=null}.bind(this))):n&&n.EmployeeNo&&(this.updateButtons(!0),this.typeSelector.selectedIndex>0)},typeSelectorChanged:function(){var t,n;this.updateButtons(!1);t=this.typeSelector[this.typeSelector.selectedIndex].get("id");this.setLeaveCode(this.leaveTypeMap[t]);n=!0;this.isManager&&(n=this.employeeSelector[this.employeeSelector.selectedIndex].get("id")>0);this.leaveCode&&n||this.timeinputs.addClass("hidden")},generateLeaveCodes:function(n){this.typeSelector&&this.typeSelector.removeEvents();this.leaveTypeGroupRow2Column2.set("html",null);this.typeSelector=new Element("select",{"class":"leave-apply-select"}).inject(this.leaveTypeGroupRow2Column2);this.def=new Element("option",{value:"0",html:""}).inject(this.typeSelector,"top");this.typeSelector.addEvent("change",function(){this.typeSelectorChanged()}.bind(this));[2593,6593,5e3].indexOf(Affinity.login.profile.companyNumber)<0&&(this.label=new Element("br").inject(this.type),this.label=new Element("label",{html:""}).inject(this.type),this.inlineProjectionInfo=new Element("div",{id:"inlineProjectionInfo","class":"projection-controls",style:"display: none; margin-top: 10px; max-width: 415px;"}).adopt(new Element("b",{html:"Available Leave: "}),new Element("span",{id:"inlineEalSummary",html:""}),new Element("span",{"class":"tooltip-view active col-id-employee indicate ui-has-tooltip",html:'<span class="button more w-icon"><span class="icon-info"><\/span><span>More<\/span><\/span>'}).addEvent(Affinity.events.click,function(){var i=this.generateEalTableHtml(this.ealInfo),n=this.ealInfo.PpeTotalsStory,t;this.isManager&&Affinity.leave.manager&&(n=this.ealInfo.PpeTotalsStoryManagerView);t="<div class='eal-ppeTotalStory'><div class='eal-ppeTotalStoryTitle'><b>Totals at last pay period<\/b><\/div> <div>"+n+"<\/div><\/div>";uialert({message:i,okText:"Close",okIcon:" ",cssSelector:"tlbPrompt",showButtons:!0,noClose:!1,showHiddenInfo:!0,hiddenInfoMessage:t,hiddenInfoButtonText:"Totals at last pay period"})}.bind(this)),new Element("div",{id:"inlineEalStory",style:"max-height: 0px; opacity: 0;",html:""})).inject(this.leaveProjectionPlaceHolder));this.outOfRangeInfo=new Element("div",{id:"outOfRangeInfo",style:"display: none; margin-top: 10px; max-width: 415px;",html:"You can only estimate leave up to one year in advance."}).inject(this.type);Array.each(n,function(n,t){this.option=new Element("option",{value:t+1,html:n.Description,id:n.LeaveCode}).inject(this.typeSelector)}.bind(this))},parseISOLocal:function(n){var t=n.split(/\D/);return new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])},evaluateCssClassByValue:function(n){return n<0?"red":""},generateEalTableHtml:function(n){var r,t,i,e;console.log(n);console.log(this.isManager);r="Your";this.isManager&&(r=n.EmployeeFirstName+"'s");var s=n.UnitType=="H"?"Hours":"Days",u=this.parseISOLocal(n.BalanceDate),h=u.getDate()+"/"+(u.getMonth()+1)+"/"+u.getFullYear(),f="<div class='ealStory'><div class='leftText ealTableTitle'>How "+r+" Estimated Leave Is Calculated<\/div> <br /><table class='ealTable popup'><thead><tr><th>Breakdown<\/th><th class='centerText'>"+s+"<\/th><\/tr><\/thead><tbody><tr><td>Leave balance at last period end<\/td><td class='centerText "+this.evaluateCssClassByValue(n.Entitlement)+"'>"+n.Entitlement+"<\/td><\/tr><tr><td>Add leave accruals<\/td><td class='centerText "+this.evaluateCssClassByValue(n.PostProjectedAccruals+n.Accrual)+"'>+"+ +(n.PostProjectedAccruals+n.Accrual).toFixed(2)+"<\/td><\/tr>",o=n.UnitType=="H"?n.TotalHours:n.TotalDays;if(n.LeaveItems!=null)for(t=0;t<n.LeaveItems.length;t++)i=this.parseISOLocal(n.LeaveItems[t].DateFrom),e=i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),f+=n.LeaveItems[t].Credit?"<tr><td>Credit cancelled/declined leave booked on "+e+"<\/td><td class='centerText "+this.evaluateCssClassByValue(n.LeaveItems[t].Units)+"'>+"+n.LeaveItems[t].Units+"<\/td><\/tr>":"<tr><td>Subtract leave booked on "+e+"<\/td><td class='centerText "+this.evaluateCssClassByValue(-n.LeaveItems[t].Units)+"'>-"+n.LeaveItems[t].Units+"<\/td><\/tr>";return f+="<tfoot><tr><th>Total estimated leave available on "+h+"<\/th><th class='centerText "+this.evaluateCssClassByValue(o)+"'>"+o+"<\/th><\/tr> <\/tfoot>",f+"<\/table><br /><\/div>"},initiateReasonSelector:function(){this.reasonSelector.set("html","");this.def=new Element("option",{value:"0",html:"** Please select a leave type first **"}).inject(this.reasonSelector,"top");this.reasonSelector.selectedIndex=0},setLeaveCode:function(n){this.initiateReasonSelector();this.leaveCode=n;var t=document.getElementById("inlineProjectionInfo");n?(t&&(this.checkLeaveIsConfigured(n.LeaveCode,n.Description)||(t.style.display="none")),n.Reasons&&Array.each(n.Reasons,function(n,t){this.option=new Element("option",{value:t,html:n.Description,id:n.ReasonCode}).inject(this.reasonSelector)}.bind(this)),this.editTimeButton&&(this.editTimeButton.removeEvents(),this.editTimeButton.destroy()),this.canEditByDays=n.CanEditByDays,this.requiredReason&&this.requiredReason.destroy(),this.requiredAttachment&&this.requiredAttachment.destroy(),n.MandatoryReason&&(this.requiredReason=new Element("span",{"class":"required",html:"*required"}).inject(this.reasonLabel,"bottom")),n.MandatoryAttachment):t&&(t.style.display="none");this.leaveUnits()},checkLeaveIsConfigured:function(n,t){var i=t.split("Leave "),r=null;return(i.length>1&&(r=i[1]),!(this.nonconfiguredLeaveTypes.indexOf(r)>-1))?!0:!1},generateCalendar:function(){var n=new Date,t=new Date;this.dateBox=new Element("div",{"class":"leave-date-box"}).inject(this.dates);this.leaveStart=new Element("div",{"class":"leave-date leave-start"}).adopt(this.leaveStartLabel=new Element("div",{"class":"title",html:"First Day"}),this.fromDateBox=new Element("div",{"class":"leave-date-picker selectable"}).adopt(this.leaveStartDay=new Element("div",{"class":"day"}),this.leaveStartDate=new Element("div",{"class":"date"}),this.leaveStartMonth=new Element("div",{"class":"month"}),this.leaveStartYear=new Element("div",{"class":"year"}))).inject(this.dateBox);this.leaveStop=new Element("div",{"class":"leave-date leave-stop"}).adopt(this.leaveStopLabel=new Element("div",{"class":"title",html:"Last Day"}),this.toDateBox=new Element("div",{"class":"leave-date-picker selectable"}).adopt(this.leaveStopDay=new Element("div",{"class":"day"}),this.leaveStopDate=new Element("div",{"class":"date"}),this.leaveStopMonth=new Element("div",{"class":"month"}),this.leaveStopYeah=new Element("div",{"class":"year"}))).inject(this.dateBox);this.hiddenDateDiv=new Element("div",{"class":"hidden"}).inject(this.dates,"top");this.hiddenDateDivFrom=new Element("div",{"class":"from-selector"}).inject(this.hiddenDateDiv);this.hiddenDateDivTo=new Element("div",{"class":"to-selector"}).inject(this.hiddenDateDiv);this.hiddenDateInputFrom=new Element("input",{type:"text",id:"apply-date-from","class":"scaled data-hj-whitelist"}).inject(this.hiddenDateDivFrom);this.hiddenDateInputTo=new Element("input",{type:"text",id:"apply-date-to","class":"scaled data-hj-whitelist"}).inject(this.hiddenDateDivTo);this.fromDateWidget=new UIDateTimeWidget({outputFormat:"%d.%m.%Y",displayFormat:"%a %e %b %Y",showCalendar:!0,showTime:!1,startDate:n.clone(),labelName:"",postId:"",postName:"",validationMethods:"",validationErrorStr:"",target:this.hiddenDateInputFrom});this.fromDateWidget.positionOverride=this.fromDateBox;this.fromDateWidget.addEvent("dateClicked",function(){var n=this.fromDateWidget.getRawDate().clone(),t=this.toDateWidget.getRawDate().clone();n.greaterThan(t)&&(this.fromDateWidget.setDate(n),this.toDateWidget.setDate(n));Affinity.leave.setDates(this.fromDateBox,this.fromDateWidget.getRawDate());Affinity.leave.setDates(this.toDateBox,this.toDateWidget.getRawDate());this.leaveUnits()}.bind(this));this.toDateWidget=new UIDateTimeWidget({outputFormat:"%d.%m.%Y",displayFormat:"%a %e %b %Y",showCalendar:!0,showTime:!1,startDate:t.clone(),labelName:"",postId:"",postName:"",validationMethods:"",validationErrorStr:"",target:this.hiddenDateInputTo});this.toDateWidget.positionOverride=this.toDateBox;this.toDateWidget.addEvent("dateClicked",function(){var t=this.fromDateWidget.getRawDate().clone(),n=this.toDateWidget.getRawDate().clone();n.lessThan(t)&&(this.fromDateWidget.setDate(n),this.toDateWidget.setDate(n));Affinity.leave.setDates(this.fromDateBox,this.fromDateWidget.getRawDate());Affinity.leave.setDates(this.toDateBox,this.toDateWidget.getRawDate());this.leaveUnits()}.bind(this));this.fromDateBox.addEvent(Affinity.events.click,function(n){this.toDateWidget.hide();this.fromDateWidget.externalShow(n)}.bind(this));this.toDateBox.addEvent(Affinity.events.click,function(n){this.fromDateWidget.hide();this.toDateWidget.externalShow(n)}.bind(this));Affinity.leave.setDates(this.fromDateBox,n);Affinity.leave.setDates(this.toDateBox,t);this.timeinputs=new Element("div",{"class":"leave-time-inputs hidden"}).inject(this.dates,"top");this.units=new Element("div",{"class":"leave-time-units"}).adopt(this.unitLabel=new Element("span",{"class":"title unit-label units",html:"Total Hours "}),this.unitInput=new Element("span",{"class":"units widget unit-input",id:""})).inject(this.timeinputs);this.leaveUnits()},validateTotalUnitsAppliedFor:function(){if(this.unitInput!==undefined&&this.unitInput!==null){var n=this;Affinity.leave.employee.getConfigWithHandle(function(t){var i,r,u;n.retainTotalUnitsAppliedFor=n.timeinputs!==undefined&&n.timeinputs.hasClass("hidden")?!1:!0;Affinity.leave.employee.config=t;n.positionDescription&&n.positionDescription.destroy();n.positionSelector&&n.positionSelector.destroy();i=document.getElements(".leave-approver-box");i&&i.length>0&&i.destroy();n.generatePositions(t.Positions);n.leaveUnits();n.leaveTypeMap=t.LeaveCodes.mapFromKey("LeaveCode");r=n.typeSelector.selectedIndex;n.generateLeaveCodes(t.LeaveCodes);n.typeSelector.selectedIndex=r;n.clearBorderHilights();n.timeinputs.classList.contains("hidden")||(u=+n.unitInput.get("id"),n.calculateLeaveAvailability(u))})}},editTimeModal:function(){this.leaveCode&&(!this.employeeSelector||this.employeeSelector.selectedIndex>0)&&(Affinity.modal.show(),Affinity.modal.clear(),Affinity.modal.position(),this.modalData=new Element("div",{"class":"modal-data",style:"min-height: 120px; width: 700px;"}),this.unitForm=new Element("div",{"class":"form-row"}).inject(this.modalData),this.unitsBox=new Element("div",{"class":"details-positions-box"}).inject(this.unitForm),this.units=new Element("div",{"class":"details-positions"}).inject(this.unitsBox,"bottom"),this.positionsLabels=new Element("div",{"class":"position-labels"}).inject(this.units),this.unitScrollerBox=new Element("div",{"class":"unit-scroller-box"}).inject(this.units),this.scroller=new Element("div",{"class":"details-units-scroller"}).inject(this.unitScrollerBox),this.updateButton=new Element("button",{"class":"grey",style:"float:right;",html:"Update"}).inject(this.unitForm),this.updateButton.addEvent(Affinity.events.click,function(){this.updatePosUnit()}.bind(this)),function(){Affinity.modal.setElement(this.modalData)}.bind(this).delay(200,this),this.edititableDates())},edititableDates:function(){for(this.dataDateRange=[],this.currentDate=new Date(this.fromDateWidget.getRawDate());this.currentDate.lessThanOrEqualTo(this.toDateWidget.getRawDate());)this.dataDateRange.push(this.currentDate.clone()),this.currentDate.increment("day",1);this.updateEditableDays(this.dataDateRange)},updateEditableDays:function(n){var r,t=!1,u,f,i;this.isManager?(r=this.employeeSelector.getElements("option")[this.employeeSelector.selectedIndex].get("id"),t=this.positionSelector?this.positionSelector.getElements("option")[this.positionSelector.selectedIndex].get("id"):this.positionDescription.get("id")):r=Affinity.login.profile.employeeNumber;u=this.fromDateWidget.getRawDate().format("%d-%b-%Y");f=this.toDateWidget.getRawDate().format("%d-%b-%Y");this._dataDateRange=n;this._methodName="ui.leave.apply.js -> updateEditableDays";i=Affinity.leave.apiroot+"CalculateLeaveUnits/"+r+"/"+u+"/"+f+"/"+this.leaveCode.LeaveCode;t&&t!="-01"&&(i=i+"?positionCode="+encodeURIComponent(t));this._api=Affinity.GetCacheSafePath(i);this.updateEditableDaysRequest&&this.updateEditableDaysRequest.isRunning()&&this.updateEditableDaysRequest.cancel();this.updateEditableDaysRequest.url=this.updateEditableDaysRequest.options.url=this._api;this.updateEditableDaysRequest.get()},setUnitInputEvents:function(n,t,i,r,u){n.addEvent(Affinity.events.start,function(n){n.target.store("initial-value",n.target.value)});n.addEvent("blur",function(f){var c,l,s,h,e,o;f.target.value=parseFloat(typeOf(parseFloat(f.target.value))!=="null"?f.target.value:f.target.retrieve("initial-value")).toFixed(2);f.target.removeClass("error-border");e=n.retrieve("validation");e&&(e.destroy(),n.eliminate("validation"));c=!0;l=document.querySelectorAll(".edit-position-hours, .edit-position-days");Array.each(l,function(n){if(n.retrieve("validation")){c=!1;return}}.bind(this));c&&(this.updateButton.set("disabled",null),this.updateButton.removeClass("disabled"));s=24;h="";u==="H"?(s=r.MaxHours,h=" hours"):u==="D"&&(s=1,h=" day");f.target.value>s?(f.target.addClass("error-border"),this.updateButton.set("disabled","disabled"),this.updateButton.addClass("disabled"),e=new Element("div",{"class":"form-row unit-validation"}).adopt(new Element("span",{"class":"icon-warning"}),new Element("span",{html:"Please enter a value up to "+s+h+" on "+Affinity.leave.cleanBadDate(i.Date).format("%d/%b/%y")+" for "+r.PositionTitle+"."})),this.modalData.adopt(e),n.store("validation",e)):t&&(o=r.HoursWorkScheduled,(!o||o<=0)&&(o=r.HoursStandard),o>0&&t.set("value",(f.target.value*o).toFixed(2)))}.bind(this))},populateEditable:function(n,t){var o=0,i,s,r,u,f,e,h,c;if(this.unitsGrid=new Element("div",{"class":"unit-grid"}).inject(this.scroller),this.gridHeader=new Element("div",{"class":"unit-gridheader"}).inject(this.unitsGrid),this.gridBody=new Element("div",{"class":"unit-gridbody"}).inject(this.unitsGrid),Array.each(t,function(n){i=Affinity.leave.cleanBadDate(n);s=new Element("div",{"class":"day-class d-"+i.format("%d-%b-%y"),id:i.format("%d/%b/%y")}).inject(this.gridHeader);s.adopt(new Element("div",{"class":"day-class-day",html:i.format("%a")}),new Element("div",{"class":"day-class-date",html:i.format("%e")}),new Element("div",{"class":"day-class-my",html:i.format("%b '%y")}),new Element("div",{"class":"hol-icon icon-plane ui-has-tooltip"}));o+=79}.bind(this)),this.scroller.setStyle("width",o),this.scroller.store("scrollerWidth",o),typeOf(n.Data)==="null"){r=[];Array.each(n.Messages,function(n){r.contains(n.Message)||r.push(n.Message)});uialert({message:"Oops! Something went wrong!<br />"+r.join("<br />"),showButtons:!0});Affinity.modal.hide();return}this.days=n.Data.Days;this.savedData=this.data;Array.each(this.savedData,function(n){Array.each(this.days,function(t){n.Date===t.Date&&Array.each(t.PositionUnits,function(t){n.PositionCode===t.PositionCode&&(t.HoursAppliedFor=parseFloat(n.Hours),t.DaysAppliedFor=parseFloat(n.Days),t.WeeksAppliedFor=parseFloat(n.Weeks))}.bind(this))}.bind(this))}.bind(this));u=function(n,t,i){var o=new Element("div",{"class":"position-label"}).inject(this.positionsLabels),h=new Element("div",{"class":"position-title"}).inject(o),f,e,s,r,u;new Element("label",{html:n.get("html")}).inject(h);i==="H"?e=new Element("div",{"class":"positions-hours",id:n.get("id")}).inject(this.gridBody):i==="D"&&(f=new Element("div",{"class":"positions-days",id:n.get("id")}).inject(this.gridBody),s=new Element("div",{"class":"position-unit-label"}).inject(o),new Element("label",{html:"(Days)","class":"position-unit-days"}).inject(s));Array.each(t,function(t){Array.each(this.days,function(o){var h=Affinity.leave.cleanBadDate(o.Date).format("%d/%b/%y"),s=Affinity.leave.cleanBadDate(t.get("id")).format("%d/%b/%y");s===h&&(Array.each(o.PositionUnits,function(t){t.PositionCode===n.get("id")&&(i==="H"?(r=new Element("input",{"class":"edit-position-hours data-hj-whitelist",id:s,value:"0",type:"text"}).inject(e),r.set("value",(t.HoursAppliedFor||0).toFixed(2)),r.store("old",(t.HoursAppliedFor||0).toFixed(2)),this.setUnitInputEvents(r,null,o,t,"H")):i==="D"&&(u=new Element("input",{"class":"edit-position-days data-hj-whitelist",id:s,value:"0",type:"text"}).inject(f),u.set("value",(t.DaysAppliedFor?t.DaysAppliedFor:0).toFixed(2)),u.store("old",(t.DaysAppliedFor?t.DaysAppliedFor:0).toFixed(2)),this.setUnitInputEvents(u,r,o,t,"D")),typeOf(o.IsPublicHoliday)==="boolean"&&o.IsPublicHoliday===!0&&(i==="H"&&r.addClass("public-holiday").addClass("ui-has-tooltip").set("data-tooltip",o.PublicHolidayName).set("data-tooltip-dir","bottom,center"),i==="D"&&u.addClass("public-holiday").addClass("ui-has-tooltip").set("data-tooltip",o.PublicHolidayName).set("data-tooltip-dir","bottom,center"),this.unitsGrid.getElement(".day-class.d-"+h.replace(/\//gi,"-")).addClass("public-holiday").getElement(".hol-icon").set("data-tooltip",o.PublicHolidayName).set("data-tooltip-dir","bottom,center")))}.bind(this)),e&&!r&&new Element("div",{"class":"edit-position-hours",id:s}).inject(e),f&&!u&&new Element("div",{"class":"edit-days-hours",id:s}).inject(f))}.bind(this))}.bind(this))}.bind(this);this.leaveCode&&(f=this.leaveCode.UnitType,e=this.gridHeader.getElements(".day-class"),this.positionSelector?(this.posies=this.positionSelector.getElements("option"),this.selectedPos=this.positionSelector[this.positionSelector.selectedIndex],this.selectedPos.get("id")&&this.selectedPos.get("id").toString()==="-01"?Array.each(this.posies,function(n){n.get("id")!=-01&&u(n,e,f)}.bind(this)):u(this.selectedPos,e,f)):(this.pos=this.position.getElement(".position"),u(this.pos,e,f)));h=this.unitScrollerBox.measure(function(){return this.getSize().x});c=this.scroller.measure(function(){return this.getScrollSize().x});c>h?this.unitScrollerBox.setStyle("overflow-x","scroll"):this.unitScrollerBox.setStyle("overflow-x","hidden");Affinity.tooltips.processNew()},injectEdit:function(){if(!this.editTime&&this.leaveCode){var n=this.leaveCode.CanEditByDays;n&&(this.editTime=new Element("div",{"class":"leave-time-button"}).inject(this.timeinputs),this.editTimeButton&&(this.editTimeButton.removeEvents(),this.editTimeButton.destroy()),this.editTimeButton=new Element("button",{"class":"blue edit-time",html:"Edit"}).inject(this.editTime),this.editTimeButton.addEvent("click",function(){this.editTimeModal()}.bind(this)))}},updatePosUnit:function(){var i,n,t;this.data&&(i=function(n){var t=document.getElements(".positions-"+n.toLowerCase());Array.each(t,function(t){var i=t.getElements(".edit-position-"+n.toLowerCase());Array.each(i,function(i){Array.each(this.data,function(r){var u=Affinity.leave.cleanBadDate(i.get("id")).format("%d/%b/%y"),f=Affinity.leave.cleanBadDate(r.Date).format("%d/%b/%y");u===f&&r.PositionCode===t.get("id")&&(r[n]=parseFloat(i.value))}.bind(this))}.bind(this))}.bind(this))}.bind(this),i("Hours"),i("Days"),this.leaveCode&&(n=0,t=this.leaveCode.UnitType,Array.each(this.data,function(i){t==="H"?n+=parseFloat(i.Hours):t==="D"?(n+=parseFloat(i.Days),i.Hours=i.Hours*i.Days):t==="W"&&(n+=parseFloat(i.Weeks))}),this.unitInput.set("html",parseFloat(n).toFixed(2)),this.unitInput.set("id",n),this.clearBorderHilights(),this.calculateLeaveAvailability(n),this.checkHours(this.data)),Affinity.modal.closeButtonCloser())},updateButtons:function(n){var t=function(t){n?(t.set("disabled",null),t.removeClass("disabled")):(t.set("disabled","disabled"),t.addClass("disabled"))},i=this.buttons.getElementsByClassName("button");Array.each(i,t);this.editTimeButton&&t(this.editTimeButton)},checkHours:function(n){if(this.leaveCode){var r=document.getElements(".leave-approver-box"),t=this.leaveCode.UnitType,i=[];"Days"in n&&typeOf(n.Days)==="array"?Array.each(n.Days,function(n){Array.each(n.PositionUnits,function(n){var u=0,r;Array.each(i,function(i){Object.contains(i,n.PositionCode)&&(t==="H"?i.units+=parseFloat(n.HoursAppliedFor?n.HoursAppliedFor:0):t==="D"?i.units+=parseFloat(n.DaysAppliedFor?n.DaysAppliedFor:0):t==="W"&&(i.units+=parseFloat(n.WeeksAppliedFor?n.WeeksAppliedFor:0)),u=1)});u===0&&(r={},r.positionName=n.PositionCode,t==="H"?r.units=parseFloat(n.HoursAppliedFor?n.HoursAppliedFor:0):t==="D"?r.units=parseFloat(n.DaysAppliedFor?n.DaysAppliedFor:0):t==="W"&&(r.units=parseFloat(n.WeeksAppliedFor?n.WeeksAppliedFor:0)),i.push(r))})}):Array.each(n,function(n){var u=0,r;Array.each(i,function(i){Object.contains(i,n.PositionCode)&&(t==="H"?i.units+=n.Hours?n.Hours:0:t==="D"?i.units+=n.Days?n.Days:0:t==="W"&&(i.units+=n.Weeks?n.Weeks:0),u=1)});u===0&&(r={},r.positionName=n.PositionCode,t==="H"?r.units=n.Hours?n.Hours:0:t==="D"?r.units=n.Days?n.Days:0:t==="W"&&(r.units=n.Weeks?n.Weeks:0),i.push(r))});Array.each(r,function(n){n.getElement(".leave-approver-selector").addClass("hidden");n.getParent().getElement("#hint-"+n.get("id"))&&n.getParent().getElement("#hint-"+n.get("id")).destroy()});Array.each(i,function(n){n.units>0?Array.each(r,function(t){t.get("id")===n.positionName&&(t.getElement(".leave-approver-selector").removeClass("hidden"),t.getElement(".leave-approver-hint")&&t.getElement(".leave-approver-hint").destroy())}):Array.each(r,function(t){t.get("id")===n.positionName&&(t.getElement(".leave-approver-hint")||new Element("span",{"class":"leave-approver-hint"}).inject(t),t.getElement(".leave-approver-hint").set("html","No hours assigned."))})})}},leaveUnits:function(){var n,t,i,r;this.leaveCode?(t=this.fromDateWidget.getRawDate().format("%d-%b-%Y"),i=this.toDateWidget.getRawDate().format("%d-%b-%Y"),this.isManager?(n=this.employeeSelector.getElements("option")[this.employeeSelector.selectedIndex].get("id"),n>0&&(r=!1,Affinity.leave.manager.getManagerEmployeeConfig(n,function(u){if(u.AllPositions)this.getLeaveUnits(n,this.leaveCode,t,i,!1);else if(u.Positions.length>1){var f=new Element("select");new Element("option",{html:"",value:"none"}).inject(f);Array.each(u.Positions,function(n){new Element("option",{html:n.PositionTitle,value:n.PositionCode}).inject(f)});uialert({message:"Choose Position<br /><br />",showButtons:!0,showCancel:!0,onOk:function(){var u=f.getElements("option")[f.selectedIndex];u.value!=="none"&&(r=u.value,this.getLeaveUnits(n,this.leaveCode,t,i,r));f.getWidget()&&f.getWidget().destroy();f.destroy()}.bind(this),onCancel:function(){f.getWidget()&&f.getWidget().destroy();f.destroy()}});Affinity.prompts.adopt(f)}else r=u.Positions[0].PositionCode,this.getLeaveUnits(n,this.leaveCode,t,i,r)}.bind(this)))):(n=Affinity.login.profile.employeeNumber,this.getLeaveUnits(n,this.leaveCode,t,i,!1))):this.timeinputs.addClass("hidden")},getLeaveUnits:function(n,t,i,r,u){var f,e;if((this.clearBorderHilights(),document.getElementById("outOfRangeInfo").style.display="none",this._methodName="ui.leave.apply.js -> getLeaveUnits",f=Affinity.leave.apiroot+"CalculateLeaveUnits/"+n+"/"+i+"/"+r,t.LeaveCode&&(f=f+"/"+t.LeaveCode),u&&(f=f+"?positionCode="+encodeURIComponent(u)),this._api=Affinity.GetCacheSafePath(f),this.leaveUnitsRequest&&this.leaveUnitsRequest.isRunning()&&this.leaveUnitsRequest.cancel(),this.leaveUnitsRequest.url=this.leaveUnitsRequest.options.url=this._api,this.leaveUnitsRequest.send(),e=Date.parse(i.replace(/-/g," ")),!e||typeOf(e)!=="date"||!e.isValid())||e.lessThan(new Date))return document.getElementById("inlineProjectionInfo").style.display="none",!1;if(e.greaterThan(new Date((new Date).setFullYear((new Date).getFullYear()+1))))return document.getElementById("inlineProjectionInfo").style.display="none",this.checkLeaveIsConfigured(t.LeaveCode,t.Description)&&(document.getElementById("outOfRangeInfo").style.display="inline-block"),!1;this.checkLeaveIsConfigured(t.LeaveCode,t.Description)&&this.leaveProjectionRequest(n,t.LeaveCode,r)},leaveProjectionRequest:function(n,t,i){this.ealProjectionReturned=!1;this._methodName="ui.leaveBalances.js -> projectBalances";var r=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"EmployeeLeaveBalance/"+n);r=this.addToApiUrl(r,"dateTo="+i);r=this.addToApiUrl(r,"leaveCode="+t);this.isManager&&(r=this.addToApiUrl(r,"tsGroupIdToIgnore="),r=this.addToApiUrl(r,"firstPerson=false"));this._api=r;this.projectBalanceRequest&&this.projectBalanceRequest.isRunning()&&this.projectBalanceRequest.cancel();this.projectBalanceRequest.url=this.projectBalanceRequest.options.url=this._api;this.projectBalanceRequest.get()},processUnits:function(n){var t,i,r;if(typeOf(n)==="null")return uialert({message:"This user is not setup to process leave totals",showButtons:!0,canClose:!0}),!1;if(t="H",this.leaveCode)t=this.leaveCode.UnitType;else return;return t==="H"?this.unitLabel.set("html","Total Hours "):t==="D"?this.unitLabel.set("html","Total Days "):t==="W"&&this.unitLabel.set("html","Total Weeks "),i=0,r=document.getElements(".leave-position-selector").length>0,Array.each(n.Days,function(u){r?Array.each(u.PositionUnits,function(r){var u=document.getElements(".leave-position-selector");Array.each(u,function(u){var e=u.selectedIndex,f=u[e].get("id");f!=-1?r.PositionCode===f&&(t==="H"?i+=parseFloat(r.HoursAppliedFor?r.HoursAppliedFor:0):t==="D"?i+=parseFloat(r.DaysAppliedFor?r.DaysAppliedFor:0):t==="W"&&(i+=parseFloat(r.WeeksAppliedFor?r.WeeksAppliedFor:0))):t==="H"?i=parseFloat(n.TotalHoursAppliedFor):t==="D"?i=parseFloat(n.TotalDaysAppliedFor):t==="W"&&(i=parseFloat(n.TotalWeeksAppliedFor))})}):document.getElement(".position").get("id")&&Array.each(u.PositionUnits,function(n){var r=document.getElement(".position").get("id");n.PositionCode===r&&(t==="H"?i+=parseFloat(n.HoursAppliedFor?n.HoursAppliedFor:0):t==="D"?i+=parseFloat(n.DaysAppliedFor?n.DaysAppliedFor:0):t==="W"&&(i+=parseFloat(n.WeeksAppliedFor?n.WeeksAppliedFor:0)))});this.unitInput.set("html",parseFloat(i).toFixed(2));this.unitInput.set("id",i);this.unitInput.set("value",i);this.checkLeaveIsConfigured(this.leaveCode.LeaveCode,this.leaveCode.Description)&&this.calculateLeaveAvailability(i)}.bind(this)),!0},calculateLeaveAvailability:function(n){var o=0,i=this.isManager?this.Employees[this.employeeSelector[this.employeeSelector.selectedIndex].get("value")-1]:Affinity.leave.employee.config,r=null,u=!0,f=null,s=0,h=null,e,c,t;if(this.ealProjectionReturned){for(this.leaveAvailabilityCounter=0,s=this.ealInfo.UnitType=="H"?this.ealInfo.TotalHours:this.ealInfo.TotalDays,t=0;t<i.LeaveCodes.length;t++)if(i.LeaveCodes[t].LeaveCode==this.ealInfo.LeaveCode){o=i.LeaveCodes[t].CurrentUnitsBal;r=i.LeaveCodes[t].HoursOverLimit;f=i.LeaveCodes[t].LeaveLimitType;h=i.LeaveCodes[t].ActionOverLimit;break}if(r!=null&&f!=null)switch(f){case"CurrentBalance":n>o+r&&(u=!1);break;case"ProjectedBalance":n>s+r&&(u=!1);break;case"FixedLimit":n>r&&(u=!1);break;default:u=!0}for(e=document.getElementsByClassName("leave-date-picker"),c=h=="Error"?"redBorderHilight":"orangeBorderHilight",t=0;t<e.length;t++)u||e[t].classList.add(c)}else this.leaveAvailabilityCounter<5e3&&(this.leaveAvailabilityCounter++,setTimeout(function(){this.calculateLeaveAvailability(n)}.bind(this),100))},clearBorderHilights:function(){for(var t=document.getElementsByClassName("leave-date-picker"),n=0;n<t.length;n++)t[n].classList.remove("redBorderHilight"),t[n].classList.remove("orangeBorderHilight")},addToApiUrl:function(n,t){return n+=n.indexOf("?")>-1?"&":"?",n+t},createResponseField:function(n){var r,i;if(this.data=null,this.leaveCode)r=this.leaveCode.UnitType;else return;var f=document.getElements(".leave-position-selector").length>0,u=[],e=function(n,t){var i={};i.Date=n.Date;i.PositionCode=t.PositionCode;i.Hours=t.HoursAppliedFor?t.HoursAppliedFor:0;r==="D"&&(i.Days=t.DaysAppliedFor?t.DaysAppliedFor:0);(typeof i!="undefined"||i!=null)&&u.push(i)},t=-1;f&&(i=document.getElement(".leave-position-selector"),t=i[i.selectedIndex].get("id"));Array.each(n.Days,function(n){Array.each(n.PositionUnits,function(i){(t==-1||i.PositionCode===t)&&e(n,i)}.bind(this))}.bind(this));this.data=u},generateAttachments:function(){this.attachWidgetDiv=new Element("div",{"class":"uploadmulti ","data-question-name":"docs"});this.attachment.adopt(this.attachWidgetDiv.adopt(new Element("input",{type:"file"}),new Element("input",{type:"hidden","class":"initialValues"})));new UIUplaodersMulti({maxsize:20963328});window.addEvent("multiFileTooLarge",this.fileTooLarge)},fileTooLarge:function(n){var t=(n.maxsize/1048576).round(2),i=(n.size/1048576).round(2);window.uialert({message:"You can only attach a document that is less than 20MB in size. Please try again."})},generateApplyButtons:function(){var n,t,i;this.buttons&&(new Element("label").inject(this.buttons),n=new Element("span",{"class":"button grey"}).adopt(new Element("span",{"class":"icon-cross"}),new Element("span",{html:"Clear"})).inject(this.buttons),n.addEvent(Affinity.events.click,this.resetForm),t=new Element("span",{"class":"button green",style:"margin-left:10px;"}).adopt(new Element("span",{"class":"icon-paperplane"}),new Element("span",{html:"Submit"})).inject(this.buttons),t.addEvent(Affinity.events.click,function(){this.submit(0)}.bind(this)),this.isManager&&(i=new Element("span",{"class":"button green w-icon-only",style:"margin-left: 10px;"}).adopt(new Element("span",{html:Affinity.icons.ThumbsUp}),new Element("span",{html:"Approve"})).inject(this.buttons),i.addEvent(Affinity.events.click,function(){this.submit(3)}.bind(this))))},acknowledgementModal:function(n){Affinity.modal.show();Affinity.modal.clear();Affinity.modal.position();var t=new Element("div",{"class":"modal-data",style:"width:700px;"}),o=new Element("div",{"class":"acknowledgement-header"}).inject(t),u=new Element("div",{"class":"acknowledgement-content"}).inject(t),i=new Element("div").inject(t),f=new Element("ul").inject(i),r=new Element("div").inject(t),e=new Element("ul").inject(r);n.Messages.length>0&&Array.each(n.Messages,function(n){n.MessageType===1&&(new Element("li",{html:n.Message}).inject(e),r.addClass("acknowledgement-warnings"));n.MessageType===0&&(new Element("li",{html:n.Message}).inject(f),i.addClass("ackfnowledgement-errors"))});n.Exception!=null?(i.addClass("acknowledgement-errors"),i.set("html",n.Exception)):u.set("html",Affinity.leave.cleanResponse(n.Response));Affinity.modal.setElement(t);Affinity.modal.show()},hasAttachedFiles:function(){var n=document.getElementsByClassName("details-attachments"),i,f,r,u,t;if(n&&n.length>0){if(t=n[0].getElements("li"),t!==undefined&&t.length>0)return!0}else if(n=document.getElementsByClassName("upload-table"),n&&n.length>0){for(i=0;i<n.length;i++)if(f=n[i].hasClass("hidden"),!f&&(r=n[i].getElement("table"),r&&(u=r.getElements("tbody tr"),u&&u.length>0)))return!0;if(t=n[0].getElements("li"),t!==undefined&&t.length>0)return!0}return!1},isAttachmentMandatoryForLeaveType:function(){var u=!1,t=null,i,r,f,n,e;if(this.isManager&&Affinity.leave.manager)if(Affinity.leave.manager.config!==undefined&&Affinity.leave.manager.config.Employees!==undefined){for(i=Affinity.leave.manager.config.Employees,n=0;n<i.length;n++)if(i[n].LeaveCodes!==undefined){t=i[n].LeaveCodes;break}}else this.config&&(t=this.config.LeaveCodes);else t=Affinity.leave.employee.config!==undefined&&Affinity.leave.employee.config.LeaveCodes!==undefined?Affinity.leave.employee.config.LeaveCodes:this.config.LeaveCodes;if(t&&(r=document.getElementsByClassName("leave-type-selector")[0],r))for(f=r.getElement("option:selected").get("id"),n=0;n<t.length;n++)if(e=t[n].LeaveCode,f===e){u=t[n].MandatoryAttachment;break}return u},validateAttachmentRequirement:function(){return!this.hasAttachedFiles()&&this.isAttachmentMandatoryForLeaveType()?!1:!0},submit:function(n){var e,i,w,r,f,s,t,h;if(!this.validateAttachmentRequirement()){uialert({message:"You must attach supporting documentation when applying for this type of leave.",showLoader:!1,showButtons:!0,noClose:!1});return}if(e=this.isManager?this.employeeSelector.getElements("option")[this.employeeSelector.selectedIndex].get("id"):Affinity.login.profile.employeeNumber,!e){uialert({message:"Oops! You forgot to chose an employee.",showButtons:!0,noClose:!1,showLoader:!1});return}if(!this.leaveCode){uialert({message:"Oops! You forgot to chose a leave type.",showButtons:!0,noClose:!1,showLoader:!1});return}if(i=this.reasonSelector[this.reasonSelector.selectedIndex].get("id"),this.leaveCode.MandatoryReason&&(typeOf(i)==="null"||i==="null"||i==="")){uialert({message:"Oops! You forgot to chose a leave reason.",showButtons:!0,noClose:!1,showLoader:!1});return}this.updateUnits(this.data,this.leaveCode.UnitType);var k=this.data,c=[],o=0,l=this.leaveCode.UnitType,a="hours";l=="D"&&(a="days");var v=!1,y=0,p="";if(Array.each(k,function(n){if(n.HoursWorkSched<0||n.HoursWorkSched>24){v=!0;y=n.HoursWorkSched;p=Date.parse(n.Date).format("%d/%m/%Y");return}o+=l=="D"?parseFloat(n.Days):parseFloat(n.Hours);(n.Hours>0||n.Days>0)&&c.push(n)}),v){w="Invalid leave units scheduled hours "+y+" applied for on "+p;uialert({message:w,showButtons:!0,noClose:!1,showLoader:!1});return}if(o==0){r="save";switch(n){case 0:r="submit";break;case 3:r="approve"}uialert({message:'<span class="icon-warning"><\/span> You can\'t '+r+" leave for <b>zero "+a+"<\/b>. Please try again.",showButtons:!0,noClose:!1,showLoader:!1});return}var b=[],d=document.getElements(".leave-approver-selector"),g=document.getElements(".leave-approver-selector.hidden"),nt=d.filter(function(n){return g.indexOf(n)<0}),u=!1;if(Array.each(nt,function(n){var t,i;if(n.getElements("option").length===0)u=!0;else if(t={},t.PositionCode=n.get("id"),typeOf(n.selectedIndex)==="number"&&n.selectedIndex>-1){i=n.selectedIndex;try{t.SubmittedTo=n[i].get("id");b.push(t)}catch(r){u=!0}}else u=!0}),u){uialert({message:"Oops! Something went wrong!<br />It would appear there are no valid approvers to choose from.<br />The Leave configuration may be faulty.<br />Please contact your administrator.",showLoader:!1,showButtons:!0,noClose:!1});return}if(this.approverSelector!==undefined&&this.approverSelector!==null&&this.approverSelector.selectedIndex!==undefined&&this.approverSelector.selectedIndex!==null&&this.approverSelector.selectedIndex>=0&&this.approverSelector[this.approverSelector.selectedIndex].innerHTML!==undefined&&this.approverSelector[this.approverSelector.selectedIndex].innerHTML===""){uialert({message:"Oops! You forgot to chose an approver.",showButtons:!0,noClose:!1,showLoader:!1});return}f=null;document.getElement(".position")?f=document.getElement(".position").get("id"):document.getElement(".leave-position-selector")&&(s=document.getElement(".leave-position-selector").selectedIndex,f=s===0?null:document.getElement(".leave-position-selector")[s].get("id"));t={};h=document.getElements(".uploadmulti label input");h.length>0&&Array.each(h,function(n){n.hasClass("initialValues")||n.files.length>0&&n.value!==""&&(t.HasAttachment=!0)});t.EmployeeNo=e;t.PositionCode=f;t.LeaveCode=this.leaveCode.LeaveCode;t.DateFrom=this.fromDateWidget.getRawDate().format("%d/%b/%Y");t.DateTo=this.toDateWidget.getRawDate().format("%d/%b/%Y");t.ReasonCode=i;t.TotalUnits=this.unitInput.get("id");t.SubmittedBy=Affinity.login.profile.employeeNumber;t.Authorisations=b;t.Comment=this.commentBox.value;t.StatusCode=n;t.UnitType=this.leaveCode.UnitType;t.Reply=null;t.Units=c;t.PartDayReason=this.partDayReason.value;this._methodName="ui.leave.apply.js -> submit";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"LeaveApplication/"+t.EmployeeNo);this.sendApplicationRequest&&this.sendApplicationRequest.isRunning()&&this.sendApplicationRequest.cancel();this.sendApplicationRequest.url=this.sendApplicationRequest.options.url=this._api;this.sendApplicationRequest.post(JSON.stringify(t))},updateUnits:function(n,t){for(var r,u,i=0;i<n.length;i++)if(r=n[i],u=Date.parse(this.leavePeriodDaysContainer.getElementById("date-"+i).value).toLocaleString(),u==Date.parse(r.Date).toLocaleString()){var f=parseFloat(this.leavePeriodDaysContainer.getElementById("hours-"+i).value),e=parseFloat(this.leavePeriodDaysContainer.getElementById("days-"+i).value),o=parseFloat(this.leavePeriodDaysContainer.getElementById("scheduledHours-"+i).value);r.HoursWorkSched=o;t==="H"?r.Hours=f:t==="D"&&(r.Days=e)}},resetForm:function(){var n=new Date,t;this.fromDateWidget.setDate(n);this.toDateWidget.setDate(n);document.getElements(".ui-calendar").getElements(".ui-calendar-day.selected")[1].removeClass("selected");Affinity.leave.setDates(this.fromDateBox,n);Affinity.leave.setDates(this.toDateBox,n);this.unitInput.set("html","");this.employeeSelector&&(this.employeeSelector.selectedIndex=0);this.employeeSelectorAutocomplete&&this.employeeSelectorAutocomplete.setValue("0");this.positionSelector&&(this.positionSelector.selectedIndex=0);this.typeSelector&&(this.typeSelector.selectedIndex=0);this.reasonSelector&&(this.reasonSelector.set("html",""),this.def=new Element("option",{value:"0",html:"** Please select a leave type first **"}).inject(this.reasonSelector,"top"));this.approvers&&(t=document.getElements(".leave-approver-selector"),Array.each(t,function(n){n.selectedIndex=0}));this.requiredReason&&this.requiredReason.destroy();this.requiredAttachment&&this.requiredAttachment.destroy();this.attachWidgetDiv&&(Affinity.uploaders.reset(this.attachWidgetDiv),Affinity.uploaders.setMaxSize(20963328));this.commentBox&&(this.commentBox.value="");this.partDayReason&&(this.partDayReason.value="");this.leavePeriodDaysContainer!==undefined&&(this.leavePeriodDaysContainer.destroy(),this.totalPeriodDaysDetail!==undefined&&this.totalPeriodDaysDetail.destroy());this.isManager&&this.positionDescription!==undefined&&this.positionDescription.addClass("hidden");this.timeinputs.addClass("hidden")},reset:function(){this.updateEditableDaysRequest&&this.updateEditableDaysRequest.isRunning()&&this.updateEditableDaysRequest.cancel();this.leaveUnitsRequest&&this.leaveUnitsRequest.isRunning()&&this.leaveUnitsRequest.cancel();this.sendApplicationRequest&&this.sendApplicationRequest.isRunning()&&this.sendApplicationRequest.cancel()},destroy:function(){this.reset();this.employeeSelector&&this.employeeSelector.removeEvents();this.employeeSelectorAutocomplete&&this.employeeSelectorAutocomplete.destroy();this.title&&this.title.removeEvents();this.positionSelector&&this.positionSelector.removeEvents();this.typeSelector&&this.typeSelector.removeEvents();this.editTimeButton&&this.editTimeButton.removeEvents();this.updateButton&&this.updateButton.removeEvents();this.fromDateWidget&&this.fromDateWidget.removeEvents();this.toDateWidget&&this.toDateWidget.removeEvents();this.fromDateBox&&this.fromDateBox.removeEvents();this.toDateBox&&this.toDateBox.removeEvents();this.fromDateWidget&&this.fromDateWidget.destroy();this.toDateWidget&&this.toDateWidget.destroy();this.section&&(Array.each(this.section.getElements(".button"),function(n){n.removeEvents()}),Array.each(this.section.getElements("input"),function(n){n.removeEvents()}),this.section.empty());Object.each(this,function(n,t){this[t]=null;delete this[t]}.bind(this))}}),UILeaveApplyV1=new Class({Implements:[Options,Events],Binds:["hide","show","toggle","loadConfig","generatePositions","refreshApprovers","generateLeaveCodes","initiateReasonSelector","initiateDateRange","initiateAttachmentWidget","initiateInputFields","validateTotalUnitsAppliedFor","refreshEmployeeConfig","selectedEmployeeNumber","setLeaveCode","generateCalendar","editTimeModal","edititableDates","updateEditableDays","setHoursEvents","populateEditable","injectEdit","updatePosUnit","checkHours","setDates","leaveUnits","getLeaveUnits","processUnits","createResponseField","generateAttachments","generateApplyButtons","acknowledgementModal","save","submit","resetForm","reset","destroy","generateEmployees","updateEmployeeSelector","setEmployee","setEmployeeAndConfig","updateButtons"],options:{target:null,isManager:!1},initialize:function(n){this.setOptions(n);this.target=this.options.target;this.isManager=this.options.isManager?!0:!1;this.section=new Element("div",{"class":"section shadow"}).inject(this.target);this.sectionBody=new Element("div",{"class":"section-body"}).inject(this.section);this.form=new Element("div",{"class":"default-form"}).inject(this.sectionBody);this.ealInfo=null;var t;t=this.isManager?"Create Team Leave":"Apply for Leave";this.ealProjectionReturned=!1;this.leaveAvailabilityCounter=0;this.nonconfiguredLeaveTypes=["A","B","C","D","E","S"];this.availableLeaveCodes=["07","09","10","12","13","11"];this.title=new Element("div",{"class":"section-title leave-apply-title ui-has-tooltip",html:t,"data-tooltip":"Open / Close","data-tooltip-dir":"top"}).addEvent(Affinity.events.click,this.toggle).inject(this.form);this.toggleButton=new Element("div",{"class":"toggle-button",html:Affinity.icons.ArrowLineSmallDown}).store("state","closed").inject(this.title);this.applyForm=new Element("div",{"class":"leave-apply-form",style:"display:block;"}).inject(this.form);this.leaveData=new Element("div",{"class":"leave-form default-form"}).inject(this.applyForm);this.formData=new Element("form").inject(this.leaveData);this.isManager&&(this.employee=new Element("div",{"class":"form-row leave-apply-employee"}).inject(this.formData),this.employeeIndirect=new Element("div",{"class":"form-row leave-apply-indirect"}).inject(this.formData),new Element("label",{html:"Include Indirect"}).inject(this.employeeIndirect),this.includeIndirect=new Element("input",{type:"checkbox","class":"include-indirect-filter",value:"includeIndirect"}).inject(this.employeeIndirect),this.includeIndirect.addEvent("change",function(){if(this.employeeSelector&&this.Employees){var n=this.employeeSelector[this.employeeSelector.selectedIndex].get("id");this.updateEmployeeSelector(this.includeIndirect.checked,this.employeeSelector[this.employeeSelector.selectedIndex].get("id"));n!=this.employeeSelector[this.employeeSelector.selectedIndex].get("id")&&this.setEmployee(this.Employees[this.employeeSelector[this.employeeSelector.selectedIndex].get("value")-1])}}.bind(this)));this.position=new Element("div",{"class":"form-row leave-apply-position"}).inject(this.formData);this.isManager&&this.position.addClass("hidden");new Element("label",{html:"Position"}).inject(this.position);this.type=new Element("div",{"class":"form-row leave-apply-type"}).inject(this.formData);this.reason=new Element("div",{"class":"form-row leave-apply-reason"}).inject(this.formData);this.reasonLabel=new Element("label",{html:"Reason"}).inject(this.reason);this.reasonSelector=new Element("select",{"class":"apply-reason-selector"}).inject(this.reason);this.dates=new Element("div",{"class":"leave-dates"}).inject(this.leaveData);this.commentData=new Element("div",{"class":"apply-comment-form default-form"}).inject(this.leaveData);this.commentForm=new Element("form").inject(this.commentData);this.commentRow=new Element("div",{"class":"form-row leave-apply-comment"}).inject(this.commentForm);this.commentTitle=new Element("label",{html:"Comment"}).inject(this.commentRow);this.commentBox=new Element("textarea",{"class":"apply-comment-box data-hj-whitelist",rows:"4",id:"comment",name:"comment"}).inject(this.commentRow);this.attachmentForm=new Element("form",{"class":"apply-attachment-form"}).inject(this.leaveData);this.attachment=new Element("div",{"class":"form-row leave-apply-attachment"}).inject(this.commentForm);this.approversForm=new Element("form").inject(this.leaveData);this.approvers=new Element("div",{"class":"form-row leave-apply-approvers"}).inject(this.approversForm);this.hiddenApprovers=new Element("div",{"class":"hidden"}).inject(this.approversForm);this.hiddenResponse=new Element("span",{"class":"leave-response"}).store("data","").inject(this.leaveData);this.buttons=new Element("div",{"class":"form-row apply-buttons"}).inject(this.leaveData);this.applyForm.toggle();this.updateEditableDaysRequest=new Request.JSON({onRequest:function(){Affinity.leave.lockui("leaveApply-updateEditableDaysRequest")},onFailure:function(n){Affinity.leave.unlockui("leaveApply-updateEditableDaysRequest");Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this),onException:function(){Affinity.leave.unlockui("leaveApply-updateEditableDaysRequest")},onCancel:function(){Affinity.leave.unlockui("leaveApply-updateEditableDaysRequest")},onSuccess:function(n){Affinity.leave.unlockui("leaveApply-updateEditableDaysRequest");Affinity.leave.isErrorInJson(n,this._api,this._methodName)||this.populateEditable(n,this._dataDateRange)}.bind(this)});this.projectBalanceRequest=new Request.JSON({headers:{Pragma:"no-cache"},onFailure:function(n){Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onSuccess:function(n){if(!Affinity.leave.isErrorInJson(n,this._api,this._methodName))if(n.Data.ComponentBalances.length>0&&n.Data.ComponentBalances[0].CodeBalances.length>0&&this.typeSelector.selectedIndex!==0){this.ealProjectionReturned=!0;this.ealInfo=n.Data.ComponentBalances[0].CodeBalances[0];var t=document.getElementById("inlineEalSummary"),i=document.getElementById("inlineEalStory");i&&t&&(document.getElementById("inlineProjectionInfo").style.display="inline-block",t.innerText=this.ealInfo.UnitType=="H"?this.ealInfo.TotalHours+" hours":this.ealInfo.TotalDays+" days")}else document.getElementById("inlineProjectionInfo").style.display="none"}.bind(this)});this.leaveUnitsRequest=new Request.JSON({method:"get",onRequest:function(){this.updateButtons(!1);Affinity.leave.lockui("leaveApply-leaveUnitsRequest")}.bind(this),onFailure:function(n){Affinity.leave.unlockui("leaveApply-leaveUnitsRequest");Affinity.leave.handleXHRErrors(n,this._api,this._methodName)||uialert({message:"We can't load that information. Please try again.",okText:"Retry",showCancel:!0,onOk:function(){this.leaveUnitsRequest.send()}.bind(this)})}.bind(this),onException:function(){Affinity.leave.unlockui("leaveApply-leaveUnitsRequest")},onCancel:function(){Affinity.leave.unlockui("leaveApply-leaveUnitsRequest")},onSuccess:function(n){if(Affinity.leave.unlockui("leaveApply-leaveUnitsRequest"),!Affinity.leave.isErrorInJson(n,this._api,this._methodName)){if(this.retainTotalUnitsAppliedFor&&this.savedData){if(this.data=this.savedData,this.leaveCode){var t=0,i=this.leaveCode.UnitType,r=n.Data.Days;Array.each(this.data,function(n){var u,f;i==="H"&&n.Hours?(t+=parseFloat(n.Hours),u=r.filter(function(t){if(t.Date==n.Date)return t}),u.length>0&&(u[0].TotalHoursAppliedFor=n.Hours,f=u[0].PositionUnits.filter(function(t){if(t.PositionCode==n.PositionCode)return t}),f.length>0&&(f[0].HoursAppliedFor=n.Hours))):i==="D"&&n.Days?(t+=parseFloat(n.Days),n.Hours=n.Hours*n.Days,u=r.filter(function(t){if(t.Date==n.Date)return t}),u.length>0&&(u[0].TotalDaysAppliedFor=n.Days,f=u[0].PositionUnits.filter(function(t){if(t.PositionCode==n.PositionCode)return t}),f.length>0&&(f[0].DaysAppliedFor=n.Days))):i==="W"&&(t+=parseFloat(n.Weeks))});i=="H"?n.Data.TotalHoursAppliedFor=t:i=="D"&&(n.Data.TotalDaysAppliedFor=t);this.unitInput.set("html",parseFloat(t).toFixed(2));this.unitInput.set("id",t);this.clearBorderHilights();this.calculateLeaveAvailability(t);this.checkHours(this.data)}this.retainTotalUnitsAppliedFor=!1}this.responseData=n.Data;this.processUnits(n.Data)&&(this.checkHours(n.Data),this.createResponseField(n.Data),this.updateButtons(!0))}}.bind(this)});this.sendApplicationRequest=new Request.JSON({headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("leaveApply-sendApplicationRequest");uialert({message:"Processing leave application. Please wait",showLoader:!0,showButtons:!1,noClose:!0})},onFailure:function(n){Affinity.leave.unlockui("leaveApply-sendApplicationRequest");prompts.hide();Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this),onException:function(){Affinity.leave.unlockui("leaveApply-sendApplicationRequest");prompts.hide()},onCancel:function(){Affinity.leave.unlockui("leaveApply-sendApplicationRequest");prompts.hide()},onSuccess:function(n){if(Affinity.leave.isErrorInJson(n,this._api,this._methodName,!0))Affinity.leave.unlockui("leaveApply-sendApplicationRequest"),prompts.hide(),this.acknowledgementModal(n);else{var t=this,i=n;Affinity.leave.postAttachements(n.Data.EmployeeNo,n.Data.TSGroupId,function(){Affinity.leave.unlockui("leaveApply-sendApplicationRequest");prompts.hide();t.acknowledgementModal(i)}.bind(this));this.isManager?Affinity.leave.manager.refreshAll():Affinity.leave.employee.refreshAll();this.resetForm();this.initiateInputFields();this.savedData=undefined}}.bind(this)});this.generateAttachments();this.generateApplyButtons();this.isManager?Affinity.leave.manager.applyTeamConfig(this.loadConfig):Affinity.leave.employee.applyConfig(this.loadConfig)},loadConfig:function(n){this.leaveTypeMap=n.LeaveCodes.mapFromKey("LeaveCode");this.generateLeaveCodes(n.LeaveCodes);this.generateCalendar(n);this.setLeaveCode();this.isManager?this.generateEmployees(n.Employees):this.generatePositions(n.Positions)},hide:function(){this.toggleButton.set("html",Affinity.icons.ArrowLineSmallDown).store("state","closed");this.applyForm.dissolve()},show:function(){this.toggleButton.set("html",Affinity.icons.ArrowLineSmallUp).store("state","open");this.applyForm.reveal()},toggle:function(){this.toggleButton.retrieve("state")==="open"?this.hide():this.show()},generatePositions:function(n){var t=n.length>1;n.length===1?this.positionDescription=new Element("span",{"class":"position",html:n[0].PositionTitle,id:n[0].PositionCode}).inject(this.position):(this.positionSelector=new Element("select",{"class":"leave-position-selector"}).inject(this.position),new Element("option",{value:"0",html:"All",id:"-01"}).inject(this.positionSelector,"top"),Array.each(n,function(n,t){var i=n.PositionTitle;n.IsExpired&&(i+=" (expired)");new Element("option",{value:t+1,html:i,id:n.PositionCode}).inject(this.positionSelector)}.bind(this)),this.positionSelector.addEvent("change",function(t){this.refreshApprovers(n,t.target.selectedIndex-1);this.leaveUnits()}.bind(this)));Array.each(n,function(n){this.approverBox=new Element("div",{"class":"leave-approver-box"}).inject(this.approvers);this.label=t?new Element("label",{html:"Approver - "+n.PositionTitle}).inject(this.approverBox):new Element("label",{html:"Approver"}).inject(this.approverBox);this.approverSelector=new Element("select",{"class":"leave-approver-selector"}).inject(this.approverBox);n!==undefined&&n!==null&&n.SubmittedTos!==undefined&&n.SubmittedTos!==null&&n.SubmittedTos.length>1&&(this.def=new Element("option",{value:"0",html:""}).inject(this.approverSelector,"top"));this.approverSelector.selectedIndex=0;this.approverBox.set("id",n.PositionCode);this.approverSelector.set("id",n.PositionCode);Array.each(n.SubmittedTos,function(n,t){new Element("option",{value:t+1,html:n.EmployeeName+" ("+n.EmployeeNo+")",id:n.EmployeeNo}).inject(this.approverSelector)}.bind(this))}.bind(this))},refreshApprovers:function(n,t){this.approvers.set("html","");var i=n.length>1;n&&typeOf(n)==="array"&&Array.each(n,function(n,r){(t<0||t==r)&&(this.approverBox=new Element("div",{"class":"leave-approver-box"}).inject(this.approvers),this.label=i?new Element("label",{html:"Approver - "+n.PositionTitle}).inject(this.approverBox):new Element("label",{html:"Approver"}).inject(this.approverBox),this.approverSelector=new Element("select",{"class":"leave-approver-selector"}).inject(this.approverBox),this.approverSelector.selectedIndex=0,this.approverBox.set("id",n.PositionCode),this.approverSelector.set("id",n.PositionCode),Array.each(n.SubmittedTos,function(n,t){this.option=new Element("option",{value:t+1,html:n.EmployeeName+" ("+n.EmployeeNo+")",id:n.EmployeeNo}).inject(this.approverSelector)}.bind(this)))}.bind(this))},updateEmployeeSelector:function(n,t){if(this.employeeSelector&&this.Employees){this.employeeSelector.empty();var u=new Element("option",{value:"0",id:"0",html:""}).inject(this.employeeSelector,"top"),i=0,r=0;Array.each(this.Employees,function(u,f){(n||u.IsDirect)&&(new Element("option",{html:u.EmployeeName+" ("+u.EmployeeNo+")",id:u.EmployeeNo,value:f+1}).inject(this.employeeSelector),r++,t==u.EmployeeNo&&(i=r))}.bind(this));this.employeeSelector.selectedIndex=i;this.employeeSelectorAutocomplete&&this.employeeSelectorAutocomplete.revert();this.employeeSelectorAutocomplete=new UIAutoCompleteWidget({stopInitialChange:!0,selectElement:this.employeeSelector})}},generateEmployees:function(n){this.Employees=n;var t=new Element("label",{html:"Employee"}).inject(this.employee);this.employeeSelector=new Element("select",{"class":"leave-employee-selector"}).inject(this.employee);this.employeeSelector.addEvent("change",function(){this.updateButtons(!1),function(){var n=this.Employees[this.employeeSelector[this.employeeSelector.selectedIndex].get("value")-1];this.setEmployee(n);n?(this.position.removeClass("hidden"),this.selectedEmployeeNumber!==n.EmployeeNo&&this.timeinputs.addClass("hidden")):this.position.addClass("hidden")}.bind(this).delay(1e3,this)}.bind(this));this.updateEmployeeSelector(!1)},initiateDateRange:function(){var n=new Date,i=String(n.getDate()),r=String(n.getMonth()+1),u=n.getFullYear(),t;n=i+"/"+r+"/"+u;t=Date.parse(n);Affinity.leave.setDates(this.fromDateBox,t);Affinity.leave.setDates(this.toDateBox,t);this.fromDateWidget.setDate(t);this.toDateWidget.setDate(t);this.clearBorderHilights();this.leaveCode!=undefined&&this.leaveCode!==null&&this.leaveUnits()},initiateAttachmentWidget:function(){this.attachWidgetDiv},initiateInputFields:function(){this.typeSelector.selectedIndex=0;this.leaveCode=null;this.initiateReasonSelector();this.initiateDateRange();this.commentBox.value="";this.initiateAttachmentWidget();this.updateButtons(!1);this.timeinputs.addClass("hidden");var n=document.getElementById("inlineProjectionInfo");n!==undefined&&n!==null&&n.style!==undefined&&n.style.display!==undefined&&(n.style.display="none")},setEmployeeAndConfig:function(n){this.positionDescription&&this.positionDescription.destroy();this.positionSelector&&this.positionSelector.destroy();var t=document.getElements(".leave-approver-box");t&&t.length>0&&t.destroy();n&&n.EmployeeNo&&Affinity.leave.manager.getManagerEmployeeConfigFromBackend(n.EmployeeNo,function(n){this.retainTotalUnitsAppliedFor=this.timeinputs!==undefined&&this.timeinputs.hasClass("hidden")?!1:!0;this.generatePositions(n.Positions);this.leaveUnits();this.leaveTypeMap=n.LeaveCodes.mapFromKey("LeaveCode");var t=this.typeSelector.selectedIndex;this.generateLeaveCodes(n.LeaveCodes);this.typeSelector.selectedIndex=t}.bind(this))},setEmployee:function(n){var i=!1,t;n!==undefined&&n.EmployeeNo!==null&&(this.selectedEmployeeNumber!==n.EmployeeNo&&(i=!0),this.selectedEmployeeNumber=n.EmployeeNo);i?(this.positionDescription&&this.positionDescription.destroy(),this.positionSelector&&this.positionSelector.destroy(),t=document.getElements(".leave-approver-box"),t&&t.length>0&&t.destroy(),this.initiateInputFields(),n&&n.EmployeeNo&&Affinity.leave.manager.getManagerEmployeeConfig(n.EmployeeNo,function(n){this.generatePositions(n.Positions);this.leaveUnits();this.leaveTypeMap=n.LeaveCodes.mapFromKey("LeaveCode");this.generateLeaveCodes(n.LeaveCodes);this.leaveCode=null}.bind(this))):n&&n.EmployeeNo&&(this.updateButtons(!0),this.typeSelector.selectedIndex>0&&this.timeinputs.removeClass("hidden"))},typeSelectorChanged:function(){var t,n;this.updateButtons(!1);t=this.typeSelector[this.typeSelector.selectedIndex].get("id");this.setLeaveCode(this.leaveTypeMap[t]);n=!0;this.isManager&&(n=this.employeeSelector[this.employeeSelector.selectedIndex].get("id")>0);this.leaveCode&&n?this.timeinputs.removeClass("hidden"):this.timeinputs.addClass("hidden")},generateLeaveCodes:function(n){this.typeSelector&&this.typeSelector.removeEvents();this.type.set("html",null);this.label=new Element("label",{html:"Leave Type"}).inject(this.type);this.typeSelector=new Element("select",{"class":"leave-type-selector data-hj-whitelist"}).inject(this.type);this.def=new Element("option",{value:"0",html:""}).inject(this.typeSelector,"top");this.typeSelector.addEvent("change",function(){this.typeSelectorChanged()}.bind(this));[2593,6593,5e3].indexOf(Affinity.login.profile.companyNumber)<0&&(this.label=new Element("br").inject(this.type),this.label=new Element("label",{html:""}).inject(this.type),this.inlineProjectionInfo=new Element("div",{id:"inlineProjectionInfo","class":"projection-controls",style:"display: none; margin-top: 10px; max-width: 415px;"}).adopt(new Element("b",{html:"Available Leave: "}),new Element("span",{id:"inlineEalSummary",html:""}),new Element("span",{"class":"tooltip-view active col-id-employee indicate ui-has-tooltip",html:'<span class="button more w-icon"><span class="icon-info"><\/span><span>More<\/span><\/span>'}).addEvent(Affinity.events.click,function(){var i=this.generateEalTableHtml(this.ealInfo),n=this.ealInfo.PpeTotalsStory,t;this.isManager&&Affinity.leave.manager&&(n=this.ealInfo.PpeTotalsStoryManagerView);t="<div class='eal-ppeTotalStory'><div class='eal-ppeTotalStoryTitle'><b>Totals at last pay period<\/b><\/div> <div>"+n+"<\/div><\/div>";uialert({message:i,okText:"Close",okIcon:" ",cssSelector:"tlbPrompt",showButtons:!0,noClose:!1,showHiddenInfo:!0,hiddenInfoMessage:t,hiddenInfoButtonText:"Totals at last pay period"})}.bind(this)),new Element("div",{id:"inlineEalStory",style:"max-height: 0px; opacity: 0;",html:""})).inject(this.type));this.outOfRangeInfo=new Element("div",{id:"outOfRangeInfo",style:"display: none; margin-top: 10px; max-width: 415px;",html:"You can only estimate leave up to one year in advance."}).inject(this.type);Array.each(n,function(n,t){this.option=new Element("option",{value:t+1,html:n.Description,id:n.LeaveCode}).inject(this.typeSelector)}.bind(this))},parseISOLocal:function(n){var t=n.split(/\D/);return new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])},evaluateCssClassByValue:function(n){return n<0?"red":""},generateEalTableHtml:function(n){var r,t,i,e;console.log(n);console.log(this.isManager);r="Your";this.isManager&&(r=n.EmployeeFirstName+"'s");var s=n.UnitType=="H"?"Hours":"Days",u=this.parseISOLocal(n.BalanceDate),h=u.getDate()+"/"+(u.getMonth()+1)+"/"+u.getFullYear(),f="<div class='ealStory'><div class='leftText ealTableTitle'>How "+r+" Estimated Leave Is Calculated<\/div> <br /><table class='ealTable popup'><thead><tr><th>Breakdown<\/th><th class='centerText'>"+s+"<\/th><\/tr><\/thead><tbody><tr><td>Leave balance at last period end<\/td><td class='centerText "+this.evaluateCssClassByValue(n.Entitlement)+"'>"+n.Entitlement+"<\/td><\/tr><tr><td>Add leave accruals<\/td><td class='centerText "+this.evaluateCssClassByValue(n.PostProjectedAccruals+n.Accrual)+"'>+"+ +(n.PostProjectedAccruals+n.Accrual).toFixed(2)+"<\/td><\/tr>",o=n.UnitType=="H"?n.TotalHours:n.TotalDays;if(n.LeaveItems!=null)for(t=0;t<n.LeaveItems.length;t++)i=this.parseISOLocal(n.LeaveItems[t].DateFrom),e=i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),f+=n.LeaveItems[t].Credit?"<tr><td>Credit cancelled/declined leave booked on "+e+"<\/td><td class='centerText "+this.evaluateCssClassByValue(n.LeaveItems[t].Units)+"'>+"+n.LeaveItems[t].Units+"<\/td><\/tr>":"<tr><td>Subtract leave booked on "+e+"<\/td><td class='centerText "+this.evaluateCssClassByValue(-n.LeaveItems[t].Units)+"'>-"+n.LeaveItems[t].Units+"<\/td><\/tr>";return f+="<tfoot><tr><th>Total estimated leave available on "+h+"<\/th><th class='centerText "+this.evaluateCssClassByValue(o)+"'>"+o+"<\/th><\/tr> <\/tfoot>",f+"<\/table><br /><\/div>"},initiateReasonSelector:function(){this.reasonSelector.set("html","");this.def=new Element("option",{value:"0",html:"** Please select a leave type first **"}).inject(this.reasonSelector,"top");this.reasonSelector.selectedIndex=0},setLeaveCode:function(n){this.initiateReasonSelector();this.leaveCode=n;var t=document.getElementById("inlineProjectionInfo");n?(t&&(this.checkLeaveIsConfigured(n.LeaveCode,n.Description)||(t.style.display="none")),n.Reasons&&Array.each(n.Reasons,function(n,t){this.option=new Element("option",{value:t,html:n.Description,id:n.ReasonCode}).inject(this.reasonSelector)}.bind(this)),this.editTimeButton&&(this.editTimeButton.removeEvents(),this.editTimeButton.destroy()),n.CanEditByDays&&(this.editTime||(this.editTime=new Element("div",{"class":"leave-time-button",style:"text-align:right"}).inject(this.timeinputs)),this.editTimeButton=new Element("span",{"class":"button blue"}).adopt(new Element("span",{"class":"icon-pencil"}),new Element("span",{html:"Edit"})).inject(this.editTime),this.editTimeButton.addEvent("click",function(){this.editTimeModal()}.bind(this))),this.requiredReason&&this.requiredReason.destroy(),this.requiredAttachment&&this.requiredAttachment.destroy(),n.MandatoryReason&&(this.requiredReason=new Element("span",{"class":"required",html:"*required"}).inject(this.reasonLabel,"bottom")),n.MandatoryAttachment&&(this.requiredAttachment=new Element("span",{"class":"required",html:"*required"}).inject(this.attachmentLabel,"bottom"))):t&&(t.style.display="none");this.leaveUnits()},checkLeaveIsConfigured:function(n,t){var i=t.split("Leave "),r=null;return(i.length>1&&(r=i[1]),!(this.nonconfiguredLeaveTypes.indexOf(r)>-1))?!0:!1},generateCalendar:function(){var n=new Date,t=new Date;this.dateBox=new Element("div",{"class":"leave-date-box"}).inject(this.dates);this.leaveStart=new Element("div",{"class":"leave-date leave-start"}).adopt(this.leaveStartLabel=new Element("div",{"class":"title",html:"First Day"}),this.fromDateBox=new Element("div",{"class":"leave-date-picker selectable"}).adopt(this.leaveStartDay=new Element("div",{"class":"day"}),this.leaveStartDate=new Element("div",{"class":"date"}),this.leaveStartMonth=new Element("div",{"class":"month"}),this.leaveStartYear=new Element("div",{"class":"year"}))).inject(this.dateBox);this.leaveStop=new Element("div",{"class":"leave-date leave-stop"}).adopt(this.leaveStopLabel=new Element("div",{"class":"title",html:"Last Day"}),this.toDateBox=new Element("div",{"class":"leave-date-picker selectable"}).adopt(this.leaveStopDay=new Element("div",{"class":"day"}),this.leaveStopDate=new Element("div",{"class":"date"}),this.leaveStopMonth=new Element("div",{"class":"month"}),this.leaveStopYeah=new Element("div",{"class":"year"}))).inject(this.dateBox);this.hiddenDateDiv=new Element("div",{"class":"hidden"}).inject(this.dates,"top");this.hiddenDateDivFrom=new Element("div",{"class":"from-selector"}).inject(this.hiddenDateDiv);this.hiddenDateDivTo=new Element("div",{"class":"to-selector"}).inject(this.hiddenDateDiv);this.hiddenDateInputFrom=new Element("input",{type:"text",id:"apply-date-from","class":"scaled data-hj-whitelist"}).inject(this.hiddenDateDivFrom);this.hiddenDateInputTo=new Element("input",{type:"text",id:"apply-date-to","class":"scaled data-hj-whitelist"}).inject(this.hiddenDateDivTo);this.fromDateWidget=new UIDateTimeWidget({outputFormat:"%d.%m.%Y",displayFormat:"%a %e %b %Y",showCalendar:!0,showTime:!1,startDate:n.clone(),labelName:"",postId:"",postName:"",validationMethods:"",validationErrorStr:"",target:this.hiddenDateInputFrom});this.fromDateWidget.positionOverride=this.fromDateBox;this.fromDateWidget.addEvent("dateClicked",function(){var n=this.fromDateWidget.getRawDate().clone(),t=this.toDateWidget.getRawDate().clone();n.greaterThan(t)&&(this.fromDateWidget.setDate(n),this.toDateWidget.setDate(n));Affinity.leave.setDates(this.fromDateBox,this.fromDateWidget.getRawDate());Affinity.leave.setDates(this.toDateBox,this.toDateWidget.getRawDate());this.leaveUnits()}.bind(this));this.toDateWidget=new UIDateTimeWidget({outputFormat:"%d.%m.%Y",displayFormat:"%a %e %b %Y",showCalendar:!0,showTime:!1,startDate:t.clone(),labelName:"",postId:"",postName:"",validationMethods:"",validationErrorStr:"",target:this.hiddenDateInputTo});this.toDateWidget.positionOverride=this.toDateBox;this.toDateWidget.addEvent("dateClicked",function(){var t=this.fromDateWidget.getRawDate().clone(),n=this.toDateWidget.getRawDate().clone();n.lessThan(t)&&(this.fromDateWidget.setDate(n),this.toDateWidget.setDate(n));Affinity.leave.setDates(this.fromDateBox,this.fromDateWidget.getRawDate());Affinity.leave.setDates(this.toDateBox,this.toDateWidget.getRawDate());this.leaveUnits()}.bind(this));this.fromDateBox.addEvent(Affinity.events.click,function(n){this.fromDateWidget.externalShow(n)}.bind(this));this.toDateBox.addEvent(Affinity.events.click,function(n){this.toDateWidget.externalShow(n)}.bind(this));Affinity.leave.setDates(this.fromDateBox,n);Affinity.leave.setDates(this.toDateBox,t);this.timeinputs=new Element("div",{"class":"leave-time-inputs hidden"}).inject(this.dates,"top");this.units=new Element("div",{"class":"leave-time-units"}).adopt(this.unitLabel=new Element("span",{"class":"title unit-label units",html:"Total Hours "}),this.unitInput=new Element("span",{"class":"units widget unit-input",id:""})).inject(this.timeinputs);this.leaveUnits()},validateTotalUnitsAppliedFor:function(){if(this.unitInput!==undefined&&this.unitInput!==null){var n=this;Affinity.leave.employee.getConfigWithHandle(function(t){var i,r,u;n.retainTotalUnitsAppliedFor=n.timeinputs!==undefined&&n.timeinputs.hasClass("hidden")?!1:!0;Affinity.leave.employee.config=t;n.positionDescription&&n.positionDescription.destroy();n.positionSelector&&n.positionSelector.destroy();i=document.getElements(".leave-approver-box");i&&i.length>0&&i.destroy();n.generatePositions(t.Positions);n.leaveUnits();n.leaveTypeMap=t.LeaveCodes.mapFromKey("LeaveCode");r=n.typeSelector.selectedIndex;n.generateLeaveCodes(t.LeaveCodes);n.typeSelector.selectedIndex=r;n.clearBorderHilights();n.timeinputs.classList.contains("hidden")||(u=+n.unitInput.get("id"),n.calculateLeaveAvailability(u))})}},editTimeModal:function(){this.leaveCode&&(!this.employeeSelector||this.employeeSelector.selectedIndex>0)&&(Affinity.modal.show(),Affinity.modal.clear(),Affinity.modal.position(),this.modalData=new Element("div",{"class":"modal-data",style:"min-height: 120px; width: 700px;"}),this.unitForm=new Element("div",{"class":"form-row"}).inject(this.modalData),this.unitsBox=new Element("div",{"class":"details-positions-box"}).inject(this.unitForm),this.units=new Element("div",{"class":"details-positions"}).inject(this.unitsBox,"bottom"),this.positionsLabels=new Element("div",{"class":"position-labels"}).inject(this.units),this.unitScrollerBox=new Element("div",{"class":"unit-scroller-box"}).inject(this.units),this.scroller=new Element("div",{"class":"details-units-scroller"}).inject(this.unitScrollerBox),this.updateButton=new Element("button",{"class":"grey",style:"float:right;",html:"Update"}).inject(this.unitForm),this.updateButton.addEvent(Affinity.events.click,function(){this.updatePosUnit()}.bind(this)),function(){Affinity.modal.setElement(this.modalData)}.bind(this).delay(200,this),this.edititableDates())},edititableDates:function(){for(this.dataDateRange=[],this.currentDate=new Date(this.fromDateWidget.getRawDate());this.currentDate.lessThanOrEqualTo(this.toDateWidget.getRawDate());)this.dataDateRange.push(this.currentDate.clone()),this.currentDate.increment("day",1);this.updateEditableDays(this.dataDateRange)},updateEditableDays:function(n){var r,t=!1,u,f,i;this.isManager?(r=this.employeeSelector.getElements("option")[this.employeeSelector.selectedIndex].get("id"),t=this.positionSelector?this.positionSelector.getElements("option")[this.positionSelector.selectedIndex].get("id"):this.positionDescription.get("id")):r=Affinity.login.profile.employeeNumber;u=this.fromDateWidget.getRawDate().format("%d-%b-%Y");f=this.toDateWidget.getRawDate().format("%d-%b-%Y");this._dataDateRange=n;this._methodName="ui.leave.applyV1.js -> updateEditableDays";i=Affinity.leave.apiroot+"CalculateLeaveUnits/"+r+"/"+u+"/"+f+"/"+this.leaveCode.LeaveCode;t&&t!="-01"&&(i=i+"?positionCode="+encodeURIComponent(t));this._api=Affinity.GetCacheSafePath(i);this.updateEditableDaysRequest&&this.updateEditableDaysRequest.isRunning()&&this.updateEditableDaysRequest.cancel();this.updateEditableDaysRequest.url=this.updateEditableDaysRequest.options.url=this._api;this.updateEditableDaysRequest.get()},setUnitInputEvents:function(n,t,i,r,u){n.addEvent(Affinity.events.start,function(n){n.target.store("initial-value",n.target.value)});n.addEvent("blur",function(f){var c,l,s,h,e,o;f.target.value=parseFloat(typeOf(parseFloat(f.target.value))!=="null"?f.target.value:f.target.retrieve("initial-value")).toFixed(2);f.target.removeClass("error-border");e=n.retrieve("validation");e&&(e.destroy(),n.eliminate("validation"));c=!0;l=document.querySelectorAll(".edit-position-hours, .edit-position-days");Array.each(l,function(n){if(n.retrieve("validation")){c=!1;return}}.bind(this));c&&(this.updateButton.set("disabled",null),this.updateButton.removeClass("disabled"));s=24;h="";u==="H"?(s=r.MaxHours,h=" hours"):u==="D"&&(s=1,h=" day");f.target.value>s?(f.target.addClass("error-border"),this.updateButton.set("disabled","disabled"),this.updateButton.addClass("disabled"),e=new Element("div",{"class":"form-row unit-validation"}).adopt(new Element("span",{"class":"icon-warning"}),new Element("span",{html:"Please enter a value up to "+s+h+" on "+Affinity.leave.cleanBadDate(i.Date).format("%d/%b/%y")+" for "+r.PositionTitle+"."})),this.modalData.adopt(e),n.store("validation",e)):t&&(o=r.HoursWorkScheduled,(!o||o<=0)&&(o=r.HoursStandard),o>0&&t.set("value",(f.target.value*o).toFixed(2)))}.bind(this))},populateEditable:function(n,t){var o=0,i,s,r,u,f,e,h,c;if(this.unitsGrid=new Element("div",{"class":"unit-grid"}).inject(this.scroller),this.gridHeader=new Element("div",{"class":"unit-gridheader"}).inject(this.unitsGrid),this.gridBody=new Element("div",{"class":"unit-gridbody"}).inject(this.unitsGrid),Array.each(t,function(n){i=Affinity.leave.cleanBadDate(n);s=new Element("div",{"class":"day-class d-"+i.format("%d-%b-%y"),id:i.format("%d/%b/%y")}).inject(this.gridHeader);s.adopt(new Element("div",{"class":"day-class-day",html:i.format("%a")}),new Element("div",{"class":"day-class-date",html:i.format("%e")}),new Element("div",{"class":"day-class-my",html:i.format("%b '%y")}),new Element("div",{"class":"hol-icon icon-plane ui-has-tooltip"}));o+=79}.bind(this)),this.scroller.setStyle("width",o),this.scroller.store("scrollerWidth",o),typeOf(n.Data)==="null"){r=[];Array.each(n.Messages,function(n){r.contains(n.Message)||r.push(n.Message)});uialert({message:"Oops! Something went wrong!<br />"+r.join("<br />"),showButtons:!0});Affinity.modal.hide();return}this.days=n.Data.Days;this.savedData=this.data;Array.each(this.savedData,function(n){Array.each(this.days,function(t){n.Date===t.Date&&Array.each(t.PositionUnits,function(t){n.PositionCode===t.PositionCode&&(t.HoursAppliedFor=parseFloat(n.Hours),t.DaysAppliedFor=parseFloat(n.Days),t.WeeksAppliedFor=parseFloat(n.Weeks))}.bind(this))}.bind(this))}.bind(this));u=function(n,t,i){var o=new Element("div",{"class":"position-label"}).inject(this.positionsLabels),h=new Element("div",{"class":"position-title"}).inject(o),f,e,s,r,u;new Element("label",{html:n.get("html")}).inject(h);i==="H"?e=new Element("div",{"class":"positions-hours",id:n.get("id")}).inject(this.gridBody):i==="D"&&(f=new Element("div",{"class":"positions-days",id:n.get("id")}).inject(this.gridBody),s=new Element("div",{"class":"position-unit-label"}).inject(o),new Element("label",{html:"(Days)","class":"position-unit-days"}).inject(s));Array.each(t,function(t){Array.each(this.days,function(o){var h=Affinity.leave.cleanBadDate(o.Date).format("%d/%b/%y"),s=Affinity.leave.cleanBadDate(t.get("id")).format("%d/%b/%y");s===h&&(Array.each(o.PositionUnits,function(t){t.PositionCode===n.get("id")&&(i==="H"?(r=new Element("input",{"class":"edit-position-hours data-hj-whitelist",id:s,value:"0",type:"text"}).inject(e),r.set("value",(t.HoursAppliedFor||0).toFixed(2)),r.store("old",(t.HoursAppliedFor||0).toFixed(2)),this.setUnitInputEvents(r,null,o,t,"H")):i==="D"&&(u=new Element("input",{"class":"edit-position-days data-hj-whitelist",id:s,value:"0",type:"text"}).inject(f),u.set("value",(t.DaysAppliedFor?t.DaysAppliedFor:0).toFixed(2)),u.store("old",(t.DaysAppliedFor?t.DaysAppliedFor:0).toFixed(2)),this.setUnitInputEvents(u,r,o,t,"D")),typeOf(o.IsPublicHoliday)==="boolean"&&o.IsPublicHoliday===!0&&(i==="H"&&r.addClass("public-holiday").addClass("ui-has-tooltip").set("data-tooltip",o.PublicHolidayName).set("data-tooltip-dir","bottom,center"),i==="D"&&u.addClass("public-holiday").addClass("ui-has-tooltip").set("data-tooltip",o.PublicHolidayName).set("data-tooltip-dir","bottom,center"),this.unitsGrid.getElement(".day-class.d-"+h.replace(/\//gi,"-")).addClass("public-holiday").getElement(".hol-icon").set("data-tooltip",o.PublicHolidayName).set("data-tooltip-dir","bottom,center")))}.bind(this)),e&&!r&&new Element("div",{"class":"edit-position-hours",id:s}).inject(e),f&&!u&&new Element("div",{"class":"edit-days-hours",id:s}).inject(f))}.bind(this))}.bind(this))}.bind(this);this.leaveCode&&(f=this.leaveCode.UnitType,e=this.gridHeader.getElements(".day-class"),this.positionSelector?(this.posies=this.positionSelector.getElements("option"),this.selectedPos=this.positionSelector[this.positionSelector.selectedIndex],this.selectedPos.get("id")&&this.selectedPos.get("id").toString()==="-01"?Array.each(this.posies,function(n){n.get("id")!=-01&&u(n,e,f)}.bind(this)):u(this.selectedPos,e,f)):(this.pos=this.position.getElement(".position"),u(this.pos,e,f)));h=this.unitScrollerBox.measure(function(){return this.getSize().x});c=this.scroller.measure(function(){return this.getScrollSize().x});c>h?this.unitScrollerBox.setStyle("overflow-x","scroll"):this.unitScrollerBox.setStyle("overflow-x","hidden");Affinity.tooltips.processNew()},injectEdit:function(){if(!this.editTime&&this.leaveCode){var n=this.leaveCode.CanEditByDays;n&&(this.editTime=new Element("div",{"class":"leave-time-button"}).inject(this.timeinputs),this.editTimeButton&&(this.editTimeButton.removeEvents(),this.editTimeButton.destroy()),this.editTimeButton=new Element("button",{"class":"blue edit-time",html:"Edit"}).inject(this.editTime),this.editTimeButton.addEvent("click",function(){this.editTimeModal()}.bind(this)))}},updatePosUnit:function(){var i,n,t;this.data&&(i=function(n){var t=document.getElements(".positions-"+n.toLowerCase());Array.each(t,function(t){var i=t.getElements(".edit-position-"+n.toLowerCase());Array.each(i,function(i){Array.each(this.data,function(r){var u=Affinity.leave.cleanBadDate(i.get("id")).format("%d/%b/%y"),f=Affinity.leave.cleanBadDate(r.Date).format("%d/%b/%y");u===f&&r.PositionCode===t.get("id")&&(r[n]=parseFloat(i.value))}.bind(this))}.bind(this))}.bind(this))}.bind(this),i("Hours"),i("Days"),this.leaveCode&&(n=0,t=this.leaveCode.UnitType,Array.each(this.data,function(i){t==="H"?n+=parseFloat(i.Hours):t==="D"?(n+=parseFloat(i.Days),i.Hours=i.Hours*i.Days):t==="W"&&(n+=parseFloat(i.Weeks))}),this.unitInput.set("html",parseFloat(n).toFixed(2)),this.unitInput.set("id",n),this.clearBorderHilights(),this.calculateLeaveAvailability(n),this.checkHours(this.data)),Affinity.modal.closeButtonCloser())},updateButtons:function(n){var t=function(t){n?(t.set("disabled",null),t.removeClass("disabled")):(t.set("disabled","disabled"),t.addClass("disabled"))},i=this.buttons.getElementsByClassName("button");Array.each(i,t);this.editTimeButton&&t(this.editTimeButton)},checkHours:function(n){if(this.leaveCode){var r=document.getElements(".leave-approver-box"),t=this.leaveCode.UnitType,i=[];"Days"in n&&typeOf(n.Days)==="array"?Array.each(n.Days,function(n){Array.each(n.PositionUnits,function(n){var u=0,r;Array.each(i,function(i){Object.contains(i,n.PositionCode)&&(t==="H"?i.units+=parseFloat(n.HoursAppliedFor?n.HoursAppliedFor:0):t==="D"?i.units+=parseFloat(n.DaysAppliedFor?n.DaysAppliedFor:0):t==="W"&&(i.units+=parseFloat(n.WeeksAppliedFor?n.WeeksAppliedFor:0)),u=1)});u===0&&(r={},r.positionName=n.PositionCode,t==="H"?r.units=parseFloat(n.HoursAppliedFor?n.HoursAppliedFor:0):t==="D"?r.units=parseFloat(n.DaysAppliedFor?n.DaysAppliedFor:0):t==="W"&&(r.units=parseFloat(n.WeeksAppliedFor?n.WeeksAppliedFor:0)),i.push(r))})}):Array.each(n,function(n){var u=0,r;Array.each(i,function(i){Object.contains(i,n.PositionCode)&&(t==="H"?i.units+=n.Hours?n.Hours:0:t==="D"?i.units+=n.Days?n.Days:0:t==="W"&&(i.units+=n.Weeks?n.Weeks:0),u=1)});u===0&&(r={},r.positionName=n.PositionCode,t==="H"?r.units=n.Hours?n.Hours:0:t==="D"?r.units=n.Days?n.Days:0:t==="W"&&(r.units=n.Weeks?n.Weeks:0),i.push(r))});Array.each(r,function(n){n.getElement(".leave-approver-selector").addClass("hidden");n.getParent().getElement("#hint-"+n.get("id"))&&n.getParent().getElement("#hint-"+n.get("id")).destroy()});Array.each(i,function(n){n.units>0?Array.each(r,function(t){t.get("id")===n.positionName&&(t.getElement(".leave-approver-selector").removeClass("hidden"),t.getElement(".leave-approver-hint")&&t.getElement(".leave-approver-hint").destroy())}):Array.each(r,function(t){t.get("id")===n.positionName&&(t.getElement(".leave-approver-hint")||new Element("span",{"class":"leave-approver-hint"}).inject(t),t.getElement(".leave-approver-hint").set("html","No hours assigned."))})})}},leaveUnits:function(){var n,t,i,r;this.leaveCode?(t=this.fromDateWidget.getRawDate().format("%d-%b-%Y"),i=this.toDateWidget.getRawDate().format("%d-%b-%Y"),this.isManager?(n=this.employeeSelector.getElements("option")[this.employeeSelector.selectedIndex].get("id"),n>0&&(r=!1,Affinity.leave.manager.getManagerEmployeeConfig(n,function(u){if(u.AllPositions)this.getLeaveUnits(n,this.leaveCode,t,i,!1);else if(u.Positions.length>1){var f=new Element("select");new Element("option",{html:"",value:"none"}).inject(f);Array.each(u.Positions,function(n){new Element("option",{html:n.PositionTitle,value:n.PositionCode}).inject(f)});uialert({message:"Choose Position<br /><br />",showButtons:!0,showCancel:!0,onOk:function(){var u=f.getElements("option")[f.selectedIndex];u.value!=="none"&&(r=u.value,this.getLeaveUnits(n,this.leaveCode,t,i,r));f.getWidget()&&f.getWidget().destroy();f.destroy()}.bind(this),onCancel:function(){f.getWidget()&&f.getWidget().destroy();f.destroy()}});Affinity.prompts.adopt(f)}else r=u.Positions[0].PositionCode,this.getLeaveUnits(n,this.leaveCode,t,i,r)}.bind(this)))):(n=Affinity.login.profile.employeeNumber,this.getLeaveUnits(n,this.leaveCode,t,i,!1))):this.timeinputs.addClass("hidden")},getLeaveUnits:function(n,t,i,r,u){var f,e;if((this.clearBorderHilights(),document.getElementById("outOfRangeInfo").style.display="none",this._methodName="ui.leave.applyV1.js -> getLeaveUnits",f=Affinity.leave.apiroot+"CalculateLeaveUnits/"+n+"/"+i+"/"+r,t.LeaveCode&&(f=f+"/"+t.LeaveCode),u&&(f=f+"?positionCode="+encodeURIComponent(u)),this._api=Affinity.GetCacheSafePath(f),this.leaveUnitsRequest&&this.leaveUnitsRequest.isRunning()&&this.leaveUnitsRequest.cancel(),this.leaveUnitsRequest.url=this.leaveUnitsRequest.options.url=this._api,this.leaveUnitsRequest.send(),e=Date.parse(i.replace(/-/g," ")),!e||typeOf(e)!=="date"||!e.isValid())||e.lessThan(new Date))return document.getElementById("inlineProjectionInfo").style.display="none",!1;if(e.greaterThan(new Date((new Date).setFullYear((new Date).getFullYear()+1))))return document.getElementById("inlineProjectionInfo").style.display="none",this.checkLeaveIsConfigured(t.LeaveCode,t.Description)&&(document.getElementById("outOfRangeInfo").style.display="inline-block"),!1;this.checkLeaveIsConfigured(t.LeaveCode,t.Description)&&this.leaveProjectionRequest(n,t.LeaveCode,r)},leaveProjectionRequest:function(n,t,i){this.ealProjectionReturned=!1;this._methodName="ui.leaveBalances.js -> projectBalances";var r=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"EmployeeLeaveBalance/"+n);r=this.addToApiUrl(r,"dateTo="+i);r=this.addToApiUrl(r,"leaveCode="+t);this.isManager&&(r=this.addToApiUrl(r,"tsGroupIdToIgnore="),r=this.addToApiUrl(r,"firstPerson=false"));this._api=r;this.projectBalanceRequest&&this.projectBalanceRequest.isRunning()&&this.projectBalanceRequest.cancel();this.projectBalanceRequest.url=this.projectBalanceRequest.options.url=this._api;this.projectBalanceRequest.get()},processUnits:function(n){var t,i,r;if(typeOf(n)==="null")return uialert({message:"This user is not setup to process leave totals",showButtons:!0,canClose:!0}),!1;if(t="H",this.leaveCode)t=this.leaveCode.UnitType;else return;return t==="H"?this.unitLabel.set("html","Total Hours "):t==="D"?this.unitLabel.set("html","Total Days "):t==="W"&&this.unitLabel.set("html","Total Weeks "),i=0,r=document.getElements(".leave-position-selector").length>0,Array.each(n.Days,function(u){r?Array.each(u.PositionUnits,function(r){var u=document.getElements(".leave-position-selector");Array.each(u,function(u){var e=u.selectedIndex,f=u[e].get("id");f!=-1?r.PositionCode===f&&(t==="H"?i+=parseFloat(r.HoursAppliedFor?r.HoursAppliedFor:0):t==="D"?i+=parseFloat(r.DaysAppliedFor?r.DaysAppliedFor:0):t==="W"&&(i+=parseFloat(r.WeeksAppliedFor?r.WeeksAppliedFor:0))):t==="H"?i=parseFloat(n.TotalHoursAppliedFor):t==="D"?i=parseFloat(n.TotalDaysAppliedFor):t==="W"&&(i=parseFloat(n.TotalWeeksAppliedFor))})}):document.getElement(".position").get("id")&&Array.each(u.PositionUnits,function(n){var r=document.getElement(".position").get("id");n.PositionCode===r&&(t==="H"?i+=parseFloat(n.HoursAppliedFor?n.HoursAppliedFor:0):t==="D"?i+=parseFloat(n.DaysAppliedFor?n.DaysAppliedFor:0):t==="W"&&(i+=parseFloat(n.WeeksAppliedFor?n.WeeksAppliedFor:0)))});this.unitInput.set("html",parseFloat(i).toFixed(2));this.unitInput.set("id",i);this.unitInput.set("value",i);this.checkLeaveIsConfigured(this.leaveCode.LeaveCode,this.leaveCode.Description)&&this.calculateLeaveAvailability(i)}.bind(this)),!0},calculateLeaveAvailability:function(n){var o=0,i=this.isManager?this.Employees[this.employeeSelector[this.employeeSelector.selectedIndex].get("value")-1]:Affinity.leave.employee.config,r=null,u=!0,f=null,s=0,h=null,e,c,t;if(this.ealProjectionReturned){for(this.leaveAvailabilityCounter=0,s=this.ealInfo.UnitType=="H"?this.ealInfo.TotalHours:this.ealInfo.TotalDays,t=0;t<i.LeaveCodes.length;t++)if(i.LeaveCodes[t].LeaveCode==this.ealInfo.LeaveCode){o=i.LeaveCodes[t].CurrentUnitsBal;r=i.LeaveCodes[t].HoursOverLimit;f=i.LeaveCodes[t].LeaveLimitType;h=i.LeaveCodes[t].ActionOverLimit;break}if(r!=null&&f!=null)switch(f){case"CurrentBalance":n>o+r&&(u=!1);break;case"ProjectedBalance":n>s+r&&(u=!1);break;case"FixedLimit":n>r&&(u=!1);break;default:u=!0}for(e=document.getElementsByClassName("leave-date-picker"),c=h=="Error"?"redBorderHilight":"orangeBorderHilight",t=0;t<e.length;t++)u||e[t].classList.add(c)}else this.leaveAvailabilityCounter<5e3&&(this.leaveAvailabilityCounter++,setTimeout(function(){this.calculateLeaveAvailability(n)}.bind(this),100))},clearBorderHilights:function(){for(var t=document.getElementsByClassName("leave-date-picker"),n=0;n<t.length;n++)t[n].classList.remove("redBorderHilight"),t[n].classList.remove("orangeBorderHilight")},addToApiUrl:function(n,t){return n+=n.indexOf("?")>-1?"&":"?",n+t},createResponseField:function(n){var r,i;if(this.data=null,this.leaveCode)r=this.leaveCode.UnitType;else return;var f=document.getElements(".leave-position-selector").length>0,u=[],e=function(n,t){var i={};i.Date=n.Date;i.PositionCode=t.PositionCode;i.Hours=t.HoursAppliedFor?t.HoursAppliedFor:0;r==="D"&&(i.Days=t.DaysAppliedFor?t.DaysAppliedFor:0);(typeof i!="undefined"||i!=null)&&u.push(i)},t=-1;f&&(i=document.getElement(".leave-position-selector"),t=i[i.selectedIndex].get("id"));Array.each(n.Days,function(n){Array.each(n.PositionUnits,function(i){(t==-1||i.PositionCode===t)&&e(n,i)}.bind(this))}.bind(this));this.data=u},generateAttachments:function(){this.attachWidgetDiv=new Element("div",{"class":"uploadmulti ","data-question-name":"docs"});this.attachment.adopt(this.attachmentLabel=new Element("label",{html:"Attach Files "}).adopt(new Element("span",{"class":"indicator grey help print-hidden ui-has-tooltip",html:"?","data-tooltip":"Attach Medical Certificate or ACC forms"})),this.attachWidgetDiv.adopt(new Element("input",{type:"file"}),new Element("input",{type:"hidden","class":"initialValues"})));new UIUplaodersMulti({maxsize:20963328});window.addEvent("multiFileTooLarge",this.fileTooLarge)},fileTooLarge:function(n){var t=(n.maxsize/1048576).round(2),i=(n.size/1048576).round(2);window.uialert({message:"You can only attach a document that is less than 20MB in size. Please try again."})},generateApplyButtons:function(){var n,t,i;this.buttons&&(new Element("label").inject(this.buttons),n=new Element("span",{"class":"button grey"}).adopt(new Element("span",{"class":"icon-cross"}),new Element("span",{html:"Clear"})).inject(this.buttons),n.addEvent(Affinity.events.click,this.resetForm),t=new Element("span",{"class":"button green",style:"margin-left:10px;"}).adopt(new Element("span",{"class":"icon-paperplane"}),new Element("span",{html:"Submit"})).inject(this.buttons),t.addEvent(Affinity.events.click,function(){this.submit(0)}.bind(this)),this.isManager&&(i=new Element("span",{"class":"button green w-icon-only",style:"margin-left: 10px;"}).adopt(new Element("span",{html:Affinity.icons.ThumbsUp}),new Element("span",{html:"Approve"})).inject(this.buttons),i.addEvent(Affinity.events.click,function(){this.submit(3)}.bind(this))))},acknowledgementModal:function(n){Affinity.modal.show();Affinity.modal.clear();Affinity.modal.position();var t=new Element("div",{"class":"modal-data",style:"width:700px;"}),o=new Element("div",{"class":"acknowledgement-header"}).inject(t),u=new Element("div",{"class":"acknowledgement-content"}).inject(t),i=new Element("div").inject(t),f=new Element("ul").inject(i),r=new Element("div").inject(t),e=new Element("ul").inject(r);n.Messages.length>0&&Array.each(n.Messages,function(n){n.MessageType===1&&(new Element("li",{html:n.Message}).inject(e),r.addClass("acknowledgement-warnings"));n.MessageType===0&&(new Element("li",{html:n.Message}).inject(f),i.addClass("ackfnowledgement-errors"))});n.Exception!=null?(i.addClass("acknowledgement-errors"),i.set("html",n.Exception)):u.set("html",Affinity.leave.cleanResponse(n.Response));Affinity.modal.setElement(t);Affinity.modal.show()},hasAttachedFiles:function(){var n=document.getElementsByClassName("details-attachments"),i,f,r,u,t;if(n&&n.length>0){if(t=n[0].getElements("li"),t!==undefined&&t.length>0)return!0}else if(n=document.getElementsByClassName("upload-table"),n&&n.length>0){for(i=0;i<n.length;i++)if(f=n[i].hasClass("hidden"),!f&&(r=n[i].getElement("table"),r&&(u=r.getElements("tbody tr"),u&&u.length>0)))return!0;if(t=n[0].getElements("li"),t!==undefined&&t.length>0)return!0}return!1},isAttachmentMandatoryForLeaveType:function(){var u=!1,t=null,i,r,f,n,e;if(this.isManager&&Affinity.leave.manager)if(Affinity.leave.manager.config!==undefined&&Affinity.leave.manager.config.Employees!==undefined){for(i=Affinity.leave.manager.config.Employees,n=0;n<i.length;n++)if(i[n].LeaveCodes!==undefined){t=i[n].LeaveCodes;break}}else this.config&&(t=this.config.LeaveCodes);else t=Affinity.leave.employee.config!==undefined&&Affinity.leave.employee.config.LeaveCodes!==undefined?Affinity.leave.employee.config.LeaveCodes:this.config.LeaveCodes;if(t&&(r=document.getElementsByClassName("leave-type-selector")[0],r))for(f=r.getElement("option:selected").get("id"),n=0;n<t.length;n++)if(e=t[n].LeaveCode,f===e){u=t[n].MandatoryAttachment;break}return u},validateAttachmentRequirement:function(){return!this.hasAttachedFiles()&&this.isAttachmentMandatoryForLeaveType()?!1:!0},submit:function(n){var e,i,r,f,s,t,h;if(!this.validateAttachmentRequirement()){uialert({message:"You must attach supporting documentation when applying for this type of leave.",showLoader:!1,showButtons:!0,noClose:!1});return}if(e=this.isManager?this.employeeSelector.getElements("option")[this.employeeSelector.selectedIndex].get("id"):Affinity.login.profile.employeeNumber,!e){uialert({message:"Oops! You forgot to chose an employee.",showButtons:!0,noClose:!1,showLoader:!1});return}if(!this.leaveCode){uialert({message:"Oops! You forgot to chose a leave type.",showButtons:!0,noClose:!1,showLoader:!1});return}if(i=this.reasonSelector[this.reasonSelector.selectedIndex].get("id"),this.leaveCode.MandatoryReason&&(typeOf(i)==="null"||i==="null"||i==="")){uialert({message:"Oops! You forgot to chose a leave reason.",showButtons:!0,noClose:!1,showLoader:!1});return}var y=this.data,c=[],o=0,l=this.leaveCode.UnitType,a="hours";if(l=="D"&&(a="days"),Array.each(y,function(n){o+=l=="D"?parseFloat(n.Days):parseFloat(n.Hours);(n.Hours>0||n.Days>0)&&c.push(n)}),o==0){r="save";switch(n){case 0:r="submit";break;case 3:r="approve"}uialert({message:'<span class="icon-warning"><\/span> You can\'t '+r+" leave for <b>zero "+a+"<\/b>. Please try again.",showButtons:!0,noClose:!1,showLoader:!1});return}var v=[],p=document.getElements(".leave-approver-selector"),w=document.getElements(".leave-approver-selector.hidden"),b=p.filter(function(n){return w.indexOf(n)<0}),u=!1;if(Array.each(b,function(n){var t,i;if(n.getElements("option").length===0)u=!0;else if(t={},t.PositionCode=n.get("id"),typeOf(n.selectedIndex)==="number"&&n.selectedIndex>-1){i=n.selectedIndex;try{t.SubmittedTo=n[i].get("id");v.push(t)}catch(r){u=!0}}else u=!0}),u){uialert({message:"Oops! Something went wrong!<br />It would appear there are no valid approvers to choose from.<br />The Leave configuration may be faulty.<br />Please contact your administrator.",showLoader:!1,showButtons:!0,noClose:!1});return}if(this.approverSelector!==undefined&&this.approverSelector!==null&&this.approverSelector.selectedIndex!==undefined&&this.approverSelector.selectedIndex!==null&&this.approverSelector.selectedIndex>=0&&this.approverSelector[this.approverSelector.selectedIndex].innerHTML!==undefined&&this.approverSelector[this.approverSelector.selectedIndex].innerHTML===""){uialert({message:"Oops! You forgot to chose an approver.",showButtons:!0,noClose:!1,showLoader:!1});return}f=null;document.getElement(".position")?f=document.getElement(".position").get("id"):document.getElement(".leave-position-selector")&&(s=document.getElement(".leave-position-selector").selectedIndex,f=s===0?null:document.getElement(".leave-position-selector")[s].get("id"));t={};h=document.getElements(".uploadmulti label input");h.length>0&&Array.each(h,function(n){n.hasClass("initialValues")||n.files.length>0&&n.value!==""&&(t.HasAttachment=!0)});t.EmployeeNo=e;t.PositionCode=f;t.LeaveCode=this.leaveCode.LeaveCode;t.DateFrom=this.fromDateWidget.getRawDate().format("%d/%b/%Y");t.DateTo=this.toDateWidget.getRawDate().format("%d/%b/%Y");t.ReasonCode=i;t.TotalUnits=this.unitInput.get("id");t.SubmittedBy=Affinity.login.profile.employeeNumber;t.Authorisations=v;t.Comment=this.commentBox.value;t.StatusCode=n;t.UnitType=this.leaveCode.UnitType;t.Reply=null;t.Units=c;this._methodName="ui.leave.applyV1.js -> submit";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"LeaveApplication/"+t.EmployeeNo);this.sendApplicationRequest&&this.sendApplicationRequest.isRunning()&&this.sendApplicationRequest.cancel();this.sendApplicationRequest.url=this.sendApplicationRequest.options.url=this._api;this.sendApplicationRequest.post(JSON.stringify(t))},resetForm:function(){var n=new Date,t;this.fromDateWidget.setDate(n);this.toDateWidget.setDate(n);document.getElements(".ui-calendar").getElements(".ui-calendar-day.selected")[1].removeClass("selected");Affinity.leave.setDates(this.fromDateBox,n);Affinity.leave.setDates(this.toDateBox,n);this.unitInput.set("html","");this.employeeSelector&&(this.employeeSelector.selectedIndex=0);this.employeeSelectorAutocomplete&&this.employeeSelectorAutocomplete.setValue("0");this.positionSelector&&(this.positionSelector.selectedIndex=0);this.typeSelector&&(this.typeSelector.selectedIndex=0);this.reasonSelector&&(this.reasonSelector.set("html",""),this.def=new Element("option",{value:"0",html:"** Please select a leave type first **"}).inject(this.reasonSelector,"top"));this.approvers&&(t=document.getElements(".leave-approver-selector"),Array.each(t,function(n){n.selectedIndex=0}));this.requiredReason&&this.requiredReason.destroy();this.requiredAttachment&&this.requiredAttachment.destroy();this.attachWidgetDiv&&(Affinity.uploaders.reset(this.attachWidgetDiv),Affinity.uploaders.setMaxSize(20963328));this.commentRow&&(this.commentBox.value="");this.isManager&&this.position.addClass("hidden");this.timeinputs.addClass("hidden")},reset:function(){this.updateEditableDaysRequest&&this.updateEditableDaysRequest.isRunning()&&this.updateEditableDaysRequest.cancel();this.leaveUnitsRequest&&this.leaveUnitsRequest.isRunning()&&this.leaveUnitsRequest.cancel();this.sendApplicationRequest&&this.sendApplicationRequest.isRunning()&&this.sendApplicationRequest.cancel()},destroy:function(){this.reset();this.employeeSelector&&this.employeeSelector.removeEvents();this.employeeSelectorAutocomplete&&this.employeeSelectorAutocomplete.destroy();this.title&&this.title.removeEvents();this.positionSelector&&this.positionSelector.removeEvents();this.typeSelector&&this.typeSelector.removeEvents();this.editTimeButton&&this.editTimeButton.removeEvents();this.updateButton&&this.updateButton.removeEvents();this.fromDateWidget&&this.fromDateWidget.removeEvents();this.toDateWidget&&this.toDateWidget.removeEvents();this.fromDateBox&&this.fromDateBox.removeEvents();this.toDateBox&&this.toDateBox.removeEvents();this.fromDateWidget&&this.fromDateWidget.destroy();this.toDateWidget&&this.toDateWidget.destroy();this.section&&(Array.each(this.section.getElements(".button"),function(n){n.removeEvents()}),Array.each(this.section.getElements("input"),function(n){n.removeEvents()}),this.section.empty());Object.each(this,function(n,t){this[t]=null;delete this[t]}.bind(this))}}),UILeaveDetail=new Class({Implements:[Options,Events],State:["Closed","View","Edit"],Binds:["getDetail","viewDetail","editDetail","doEditDetail","tryCreateAuditLogForImportedLeave","initializeSubmitLeaveRequest","getLeaveStatusWhereForwardToIsNotAllowed","toHideForwardToBasedFromLeaveInstance","createCommentReplyEdits","createButtons","createEditableDates","newLeaveReason","setStartDate","setEndDate","setUnitInputEvents","buildUnitsTotals","populateForwardHistory","updateDate","updateUnits","doUpdateUnits","updateAuthoriser","doUpdateAuthoriser","deleteAttachment","postAttachments","deleteLeave","submitLeave","acknowledgementModal","reset","destroy"],options:{target:null,isManager:!1},initialize:function(n){this.setOptions(n);this.target=this.options.target;this.isManager=this.options.isManager?!0:!1;this.leaveDetailRequest=new Request.JSON({onRequest:function(){Affinity.leave.lockui("leaveDetail-leaveDetailRequest")},onFailure:function(n){Affinity.leave.unlockui("leaveDetail-leaveDetailRequest");prompts.hide();Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onException:function(){Affinity.leave.unlockui("leaveDetail-leaveDetailRequest")},onCancel:function(){Affinity.leave.unlockui("leaveDetail-leaveDetailRequest")},onSuccess:function(n){Affinity.leave.unlockui("leaveDetail-leaveDetailRequest");Affinity.leave.isErrorInJson(n,this._api,this._methodName)||(this.data=n.Data,this.timeLastModified=this.data.LeaveHeader.TimeLastModified?Date.parse(this.data.LeaveHeader.TimeLastModified):null,this.requireUpdate=!1,this.viewDetail(),prompts.hide())}.bind(this)});this.tryCreateActivityLogRequest=new Request.JSON({onSuccess:function(){}.bind(this)});this.updateUnitsRequest=new Request.JSON({method:"post",emulation:!1,headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("leaveDetail-updateUnitsRequest")},onFailure:function(n){Affinity.leave.unlockui("leaveDetail-updateUnitsRequest");Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onException:function(){Affinity.leave.unlockui("leaveDetail-updateUnitsRequest")},onCancel:function(){Affinity.leave.unlockui("leaveDetail-updateUnitsRequest")},onSuccess:function(n){if(Affinity.leave.unlockui("leaveDetail-updateUnitsRequest"),!Affinity.leave.isErrorInJson(n,this._api,this._methodName,!0)){var t=this.data.LeaveHeader.TimeLastModified?Date.parse(this.data.LeaveHeader.TimeLastModified):null;Affinity.leave.manager&&(this.requireUpdate=this.requireUpdate||n.RequireUpdate,!this.requireUpdate&&(!this.timeLastModified||t.getTime()>this.timeLastModified.getTime())&&(this.timeLastModified=t));this.data=n.Data;this.buildUnitsTotals(this.data.Components);this.createApproverBoxes(this.data.Components,this.positions);this.createEditableDates(this.data.LeaveHeader,this.data.Components,this.positions);Affinity.tooltips.processNew();this.isManager&&Affinity.leave.manager?Affinity.leave.manager.refreshAll():Affinity.leave.employee.refreshAll()}prompts.hide();this.errorChecking(n)}.bind(this)});this.isManager?(this.bossResponseRequest=new Request.JSON({headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("leaveDetail-bossResponseRequest")},onFailure:function(n){Affinity.leave.unlockui("leaveDetail-bossResponseRequest");Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this),onException:function(){Affinity.leave.unlockui("leaveDetail-bossResponseRequest")},onCancel:function(){Affinity.leave.unlockui("leaveDetail-bossResponseRequest")},onSuccess:function(n){if(Affinity.leave.unlockui("leaveDetail-bossResponseRequest"),prompts.hide(),Affinity.leave.isErrorInJson(n,this._api,this._methodName,!0))this.errorChecking(n);else{if(!n.Response){var t="Leave application";this.bossResponseRequest.isCancellation&&(t="Leave cancellation");n.Response=this._statusChange===3?t+" has been approved":t+" has been declined"}n.Messages.length>0&&n.Messages[0].Message!==undefined&&n.Messages[0].Message!==null&&n.Messages[0].Message.indexOf("position has changed")>-1?uialert({message:n.Messages[0].Message,showButtons:!0,noClose:!1}):(this.acknowledgementModal(n),Affinity.leave.manager.refreshAll())}}.bind(this)}),this.initializeSubmitLeaveRequest()):this.initializeSubmitLeaveRequest()},initializeSubmitLeaveRequest:function(){this.submitLeaveRequest=new Request.JSON({headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("leaveDetail-submitLeaveRequest")},onFailure:function(n){Affinity.leave.unlockui("leaveDetail-submitLeaveRequest");prompts.hide();Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this),onException:function(){Affinity.leave.unlockui("leaveDetail-submitLeaveRequest");prompts.hide()},onCancel:function(){Affinity.leave.unlockui("leaveDetail-submitLeaveRequest");prompts.hide()},onSuccess:function(n){Affinity.leave.unlockui("leaveDetail-submitLeaveRequest");prompts.hide();Affinity.leave.isErrorInJson(n,this._api,this._methodName,!0)||(this._onResponse&&this._onResponse(n),Affinity.leave.employee.refreshAll());this.errorChecking(n)}.bind(this)})},tryCreateAuditLogForImportedLeave:function(n,t){this._methodName="ui.leave.detail.js -> tryCreateAuditLogForImportedLeave ()";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"ActivityLog/"+n+"/"+t);this.tryCreateActivityLogRequest.url=this.tryCreateActivityLogRequest.options.url=this._api;this.tryCreateActivityLogRequest.post()},getDetail:function(n,t,i){if(uialert({message:"Loading Leave Detail",showLoader:!0,showButtons:!1,noClose:!1}),typeof i!="undefined"&&i!="undefined"&&i!=null){this._methodName="ui.leave.detail.js -> getDetail (with authId)";var r=Affinity.leave.apiroot+"LeaveDetail/"+n+"/"+t;i.AuthorisationId!=-1&&(r=r+"/"+i.AuthorisationId,this.authorisationId=i.AuthorisationId);this._api=Affinity.GetCacheSafePath(r);this.authorisation=i}else this._methodName="ui.leave.detail.js -> getDetail (without authId)",this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"LeaveDetail/"+n+"/"+t),this.authorisation=null;Affinity.leave.manager&&this.isManager?Affinity.leave.manager.getManagerEmployeeConfig(n,function(n){this.leaveDetailRequest&&this.leaveDetailRequest.isRunning()&&this.leaveDetailRequest.cancel();this.leaveDetailRequest.url=this.leaveDetailRequest.options.url=this._api;this.leaveDetailRequest.get();this.employeeConfig=n}.bind(this)):Affinity.leave.employee&&!this.isManager&&(this.employeeConfig=Affinity.leave.employee.config,this.leaveDetailRequest&&this.leaveDetailRequest.isRunning()&&this.leaveDetailRequest.cancel(),this.leaveDetailRequest.url=this.leaveDetailRequest.options.url=this._api,this.leaveDetailRequest.get())},createElementLeaveDetailGroupRow:function(n){return new Element("div",{"class":"leave-detail-group-row"}).inject(n)},createElementLeaveDetailBlankColumnHeader:function(n){return new Element("div",{"class":"leave-detail-group-column-blank-header"}).inject(n)},createElementLeaveDetailBlankColumnContainer:function(n){return new Element("div",{"class":"leave-detail-group-column-blank-container"}).inject(n)},createElementLeaveDetailColumnContainer:function(n){return new Element("div",{"class":"leave-detail-group-column-container"}).inject(n)},createLeaveDetailsStatusArea:function(n){var r=this.data.Components[0].Authorisation.SubmittedToName,i,t;this.statusAreaRow1=new Element("div",{"class":"form-row"}).inject(n);this.statusAreaRow2=this.createElementLeaveDetailGroupRow(n);this.statusArea1Row1Column1=new Element("span").inject(this.statusAreaRow1);this.statusArea1Row1Column2=new Element("span").inject(this.statusAreaRow1);this.statusArea1Row1Column3=new Element("span").inject(this.statusAreaRow1);this.statusAreaRow2Column1=this.createElementLeaveDetailBlankColumnContainer(this.statusAreaRow2);this.statusAreaRow2Column2=this.createElementLeaveDetailColumnContainer(this.statusAreaRow2);this.statusAreaRow2Column3=this.createElementLeaveDetailColumnContainer(this.statusAreaRow2);new Element("label",{html:"Leave Details","class":"leave-detail-group-title-label"}).inject(this.statusArea1Row1Column1);new Element("label",{html:"Approver","class":"leave-detail-group-column-label"}).inject(this.statusArea1Row1Column2);new Element("label",{html:"Status","class":"leave-detail-group-column-label"}).inject(this.statusArea1Row1Column3);new Element("label",{html:r}).inject(this.statusAreaRow2Column2);i=new Element("div",{style:"width:15px;font-size:20px;margin-left:8px;"}).inject(this.statusAreaRow2Column3);t=new Element("div",{"class":"color"}).inject(i);this.data.LeaveHeader.StatusCode===3?(t.addClass("ui-has-tooltip").set("data-tooltip","Leave is approved"),t.addClass("icon-thumbs-up"),t.addClass("green")):this.data.LeaveHeader.StatusCode===0?(t.addClass("ui-has-tooltip").set("data-tooltip","Leave is pending approval"),t.addClass("icon-hourglass"),t.addClass("blue")):this.data.LeaveHeader.StatusCode===2?(t.addClass("red"),t.addClass("ui-has-tooltip").set("data-tooltip","Leave is declined"),t.addClass("icon-thumbs-down")):this.data.LeaveHeader.StatusCode===7&&(t.addClass("ui-has-tooltip").set("data-tooltip","Leave cancellation is pending approval"),t.addClass("icon-cancel"),t.addClass("blue"))},createLeaveDetailsCommentsArea:function(n){this.commentsAreaRow1=this.createElementLeaveDetailGroupRow(n);this.commentsAreaRow1Column1=this.createElementLeaveDetailBlankColumnContainer(this.commentsAreaRow1);this.commentsAreaRow1Column2=this.createElementLeaveDetailColumnContainer(this.commentsAreaRow1);this.commentsAreaRow1Column3=this.createElementLeaveDetailColumnContainer(this.commentsAreaRow1);new Element("label",{html:"Comments","class":"leave-detail-group-column-label"}).inject(this.commentsAreaRow1Column2);this.commentsAreaRow2=this.createElementLeaveDetailGroupRow(n);this.commentsAreaRow2Column1=this.createElementLeaveDetailBlankColumnContainer(this.commentsAreaRow2);this.commentsAreaRow2Column2=this.createElementLeaveDetailColumnContainer(this.commentsAreaRow2);this.commentsAreaRow2Column3=this.createElementLeaveDetailColumnContainer(this.commentsAreaRow2);this.commentBox=new Element("label").inject(this.commentsAreaRow2Column2)},createLeaveDetailsManagerCommentsArea:function(n,t){t&&(this.managerCommentsAreaRow1=this.createElementLeaveDetailGroupRow(n),this.managerCommentsAreaRow2=this.createElementLeaveDetailGroupRow(n),this.managerCommentsAreaRow1Column1=this.createElementLeaveDetailBlankColumnContainer(this.managerCommentsAreaRow1),this.managerCommentsAreaRow1Column2=this.createElementLeaveDetailColumnContainer(this.managerCommentsAreaRow1),this.managerCommentsAreaRow1Column3=this.createElementLeaveDetailColumnContainer(this.managerCommentsAreaRow1),this.managerCommentsAreaRow2Column1=this.createElementLeaveDetailBlankColumnContainer(this.managerCommentsAreaRow2),this.managerCommentsAreaRow2Column2=this.createElementLeaveDetailColumnContainer(this.managerCommentsAreaRow2),this.managerCommentsAreaRow2Column3=this.createElementLeaveDetailColumnContainer(this.managerCommentsAreaRow2),new Element("label",{html:"Manager Comments","class":"leave-detail-group-column-label"}).inject(this.managerCommentsAreaRow1Column2),this.managerCommentBox=new Element("textarea",{"class":"leave-detail-text-area",rows:"4",id:"comment",name:"comment"}).inject(this.managerCommentsAreaRow2Column2),this.managerCommentEdit=new InputEditWidget({target:this.managerCommentsAreaRow2Column2,input:this.managerCommentBox,updateInput:function(){var n=this.managerCommentBox.value;if(n!=(this.data.LeaveHeader.Reply===null?"":this.data.LeaveHeader.Reply)){var t=this,i=function(n,t){t.handleValidationErrors(n,"Manager Comments")},r=function(n,t){t.handleRequestWarnings(n)};this.updateLeave2(null,r,i,t)}}.bind(this),cancelInput:function(){this.managerCommentBox.set("value",this.data.LeaveHeader.Reply)}.bind(this)}))},createLeaveDetailsAttachmentsArea:function(n,t){if(this.attachmentsAreaRow1=this.createElementLeaveDetailGroupRow(n),this.attachmentsAreaRow2=this.createElementLeaveDetailGroupRow(n),this.attachmentsAreaRow1Column1=this.createElementLeaveDetailBlankColumnContainer(this.attachmentsAreaRow1),this.attachmentsAreaRow1Column2=new Element("span").inject(this.attachmentsAreaRow1),this.attachmentsAreaRow2Column1=new Element("span",{"class":"leave-detail-group-column-blank-container-for-attachment"}).inject(this.attachmentsAreaRow2),this.attachmentsAreaRow2Column2=new Element("span",{"class":"leave-detail-group-column-container-for-attachment"}).inject(this.attachmentsAreaRow2),new Element("label",{html:"Attachments","class":"leave-detail-group-column-label"}).inject(this.attachmentsAreaRow1Column2),this.data.Attachments.length>0){var i=new Element("div",{"class":"form-row"}).inject(this.attachmentsAreaRow2Column2),r=new Element("div",{"class":"details-attachments-box"}).inject(i),u=new Element("ul",{"class":"details-attachments"}).inject(r);Array.each(this.data.Attachments,function(n){url=Affinity.leave.apiroot+"GetLeaveAttachment/"+t.EmployeeNo+"/"+t.TSGroupId+"/"+n.Id;var i=new Element("a",{href:url}).inject(u),r=new Element("li",{"class":"details-attachment"}).inject(i);r.set("html",n.Name)})}},createLeaveDetailsForwardsArea:function(n,t,i,r){i&&(this.forwardsAreaRow1=this.createElementLeaveDetailGroupRow(t),this.forwardsAreaRow2=this.createElementLeaveDetailGroupRow(t),this.forwardsAreaRow3=this.createElementLeaveDetailGroupRow(t),this.forwardsAreaRow4=this.createElementLeaveDetailGroupRow(t),this.forwardsAreaRow1Column1=this.createElementLeaveDetailBlankColumnContainer(this.forwardsAreaRow1),this.forwardsAreaRow1Column2=this.createElementLeaveDetailColumnContainer(this.forwardsAreaRow1),this.forwardsAreaRow1Column3=this.createElementLeaveDetailColumnContainer(this.forwardsAreaRow1),this.forwardsAreaRow2Column1=this.createElementLeaveDetailBlankColumnContainer(this.forwardsAreaRow2),this.forwardsAreaRow2Column2=this.createElementLeaveDetailColumnContainer(this.forwardsAreaRow2),this.forwardsAreaRow2Column3=this.createElementLeaveDetailColumnContainer(this.forwardsAreaRow2),this.forwardsAreaRow3Column1=this.createElementLeaveDetailBlankColumnContainer(this.forwardsAreaRow3),this.forwardsAreaRow3Column2=this.createElementLeaveDetailColumnContainer(this.forwardsAreaRow3),this.forwardsAreaRow3Column3=this.createElementLeaveDetailColumnContainer(this.forwardsAreaRow3),this.forwardsAreaRow4Column1=this.createElementLeaveDetailBlankColumnContainer(this.forwardsAreaRow4),this.forwardsAreaRow4Column2=this.createElementLeaveDetailColumnContainer(this.forwardsAreaRow4),this.forwardsAreaRow4Column3=this.createElementLeaveDetailColumnContainer(this.forwardsAreaRow4),new Element("label",{html:"Forward To","class":"leave-detail-group-column-label"}).inject(this.forwardsAreaRow1Column2),this.forwardsAreaRow1.addClass("hidden"),this.forwardSelector=new Element("select",{"class":"leave-approver-selector leave-detail-select"}).inject(this.forwardsAreaRow2Column2),this.forwardsAreaRow2.addClass("hidden"),Affinity.login.profile.employeeNumber!==r.EmployeeNo&&this.createForwardingFeature(n))},createEmployeeDetailsGroup:function(n,t){this.isManager?(this.employeeGroup=new Element("div",{"class":"leave-detail-group leave-detail-employee-group"}).inject(n),this.employeeGroupRow1=new Element("div",{"class":"form-row"}).inject(this.employeeGroup),this.employeeInputRow=new Element("div",{"class":"leave-detail-row"}).inject(this.employeeGroup),this.employeeInputColumn1=new Element("div",{"class":"leave-detail-group-column-blank-container"}).inject(this.employeeInputRow),this.employeeInputColumn2=new Element("div",{"class":"leave-detail-group-column-container"}).inject(this.employeeInputRow),this.employeeInputColumn3=new Element("div",{"class":"leave-detail-group-column-container"}).inject(this.employeeInputRow),new Element("label",{html:"Employee","class":"leave-detail-group-title-label"}).inject(this.employeeGroupRow1),new Element("label",{html:"Full Name","class":"leave-detail-group-column-label"}).inject(this.employeeGroupRow1),new Element("label",{html:"Position","class":"leave-detail-group-column-label"}).inject(this.employeeGroupRow1),new Element("div",{html:t.EmployeeName,"class":"leave-detail-group-column-label-value"}).inject(this.employeeInputColumn2),new Element("div",{html:t.PositionTitle,"class":"leave-detail-group-column-label-value"}).inject(this.employeeInputColumn3)):(this.employeeGroup=new Element("div",{"class":"leave-detail-group leave-detail-employee-group"}).inject(n),this.employeeGroupRow1=new Element("div",{"class":"form-row"}).inject(this.employeeGroup),this.employeeInputRow=new Element("div",{"class":"leave-detail-row"}).inject(this.employeeGroup),this.employeeInputColumn1=new Element("div",{"class":"leave-detail-group-column-blank-container"}).inject(this.employeeInputRow),this.employeeInputColumn2=new Element("div",{"class":"leave-detail-group-column-container"}).inject(this.employeeInputRow),this.employeeInputColumn3=new Element("div",{"class":"leave-detail-group-column-container"}).inject(this.employeeInputRow),new Element("label",{html:"Employee","class":"leave-detail-group-title-label"}).inject(this.employeeGroupRow1),new Element("label",{html:"Position","class":"leave-detail-group-column-label"}).inject(this.employeeGroupRow1),new Element("div",{html:t.PositionTitle,"class":"leave-detail-group-column-label-value"}).inject(this.employeeInputColumn2))},createLeaveTypeGroup:function(n){this.leaveTypeGroup=new Element("div",{"class":"leave-apply-group"}).inject(n);this.leaveTypeGroupRow1=new Element("div",{"class":"form-row"}).inject(this.leaveTypeGroup);this.leaveTypeGroupRow2=new Element("div",{"class":"leave-apply-group-row"}).inject(this.leaveTypeGroup);this.leaveTypeGroupRow1Column1=new Element("span").inject(this.leaveTypeGroupRow1);this.leaveTypeGroupRow1Column2=new Element("span").inject(this.leaveTypeGroupRow1);this.leaveTypeGroupRow1Column3=new Element("span").inject(this.leaveTypeGroupRow1);this.leaveTypeGroupRow2Column1=this.createElementLeaveDetailBlankColumnContainer(this.leaveTypeGroupRow2);this.leaveTypeGroupRow2Column2=this.createElementLeaveDetailColumnContainer(this.leaveTypeGroupRow2);this.leaveTypeGroupRow2Column3=this.createElementLeaveDetailColumnContainer(this.leaveTypeGroupRow2);new Element("label",{html:"Leave Type","class":"leave-detail-group-title-label"}).inject(this.leaveTypeGroupRow1Column1);new Element("label",{html:"Leave Type","class":"leave-detail-group-column-label"}).inject(this.leaveTypeGroupRow1Column2);this.reasonLabel=new Element("label",{html:"Reason","class":"leave-detail-group-column-label"}).inject(this.leaveTypeGroupRow1Column3);this.leaveTypeSelector=new Element("select",{"class":"leave-detail-select leave-type-selector hidden"}).inject(this.leaveTypeGroupRow2Column2);this.selectedLeaveLabel=new Element("div",{"class":"leave-detail-group-column-label-value",html:"----"}).inject(this.leaveTypeGroupRow2Column2);this.leaveReasonSelector=new Element("select",{"class":"leave-detail-select hidden"}).inject(this.leaveTypeGroupRow2Column3);this.selectedReasonLabel=new Element("div",{"class":"leave-detail-group-column-label-value",html:"----"}).inject(this.leaveTypeGroupRow2Column3)},createLeavePeriodGroup:function(n){this.leavePeriodGroup=new Element("div",{"class":"leave-detail-group"}).inject(n);this.leavePeriodGroupRow1=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);this.leavePeriodGroupRow2=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);this.leavePeriodGroupRow3=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);this.leavePeriodGroupRow4=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);this.leavePeriodGroupRow5=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);this.leavePeriodGroupRow6=new Element("div",{"class":"form-row"}).inject(this.leavePeriodGroup);new Element("label",{html:"Leave Period","class":"leave-detail-group-title-label"}).inject(this.leavePeriodGroupRow1);this.dates=new Element("div",{"class":"leave-dates leave-apply-dates"}).inject(this.leavePeriodGroupRow2);this.leavePeriodDaysBox=new Element("div").inject(this.leavePeriodGroupRow3);this.leavePeriodApproverAndStateColumn1=this.createElementLeaveDetailBlankColumnHeader(this.leavePeriodGroupRow4);this.leavePeriodApproverAndStateColumn2=this.createElementLeaveDetailColumnContainer(this.leavePeriodGroupRow4);this.leavePeriodApproverAndStateColumn3=this.createElementLeaveDetailColumnContainer(this.leavePeriodGroupRow4);this.leavPeriodRequestPartDayLabelColumn1=this.createElementLeaveDetailBlankColumnHeader(this.leavePeriodGroupRow5);this.leavPeriodRequestPartDayLabelColumn2=this.createElementLeaveDetailColumnContainer(this.leavePeriodGroupRow5);this.leavPeriodRequestPartDayLabelColumn3=this.createElementLeaveDetailColumnContainer(this.leavePeriodGroupRow5);this.leavePeriodRequestPartDayInputColumn1=this.createElementLeaveDetailBlankColumnHeader(this.leavePeriodGroupRow6);this.leavePeriodRequestPartDayInputColumn2=this.createElementLeaveDetailColumnContainer(this.leavePeriodGroupRow6);this.leavePeriodRequestPartDayInputColumn3=this.createElementLeaveDetailColumnContainer(this.leavePeriodGroupRow6);this.leavePeriodRequestPartDayLabel=new Element("label",{html:"Part Day Reason","class":"leave-detail-group-column-label"}).inject(this.leavPeriodRequestPartDayLabelColumn2);this.partDayReason=new Element("div").inject(this.leavePeriodRequestPartDayInputColumn2);this.leavePeriodDaysBoxHeaderRow=new Element("div").inject(this.leavePeriodDaysBox);this.leavePeriodDaysBlankContainer=this.createElementLeaveDetailBlankColumnHeader(this.leavePeriodDaysBoxHeaderRow);this.leavePeriodDaysDateTitle=new Element("label",{html:"Date","class":"leave-detail-leave-period-header-date"}).inject(this.leavePeriodDaysBoxHeaderRow);this.leavePeriodDaysDaysTitle=new Element("label",{html:"Days","class":"leave-detail-leave-period-header-days"}).inject(this.leavePeriodDaysBoxHeaderRow);this.leavePeriodDaysHoursTitle=new Element("label",{html:"Hours","class":"leave-detail-leave-period-header-hours"}).inject(this.leavePeriodDaysBoxHeaderRow);this.leavePeriodDaysHoursTitle=new Element("label",{html:"Scheduled","class":"leave-detail-leave-period-header-scheduled"}).inject(this.leavePeriodDaysBoxHeaderRow)},createLeaveDetailsGroup:function(n,t,i){this.leaveDetailsGroup=new Element("div",{"class":"leave-detail-group"}).inject(n);this.createLeaveDetailsStatusArea(this.leaveDetailsGroup);this.createLeaveDetailsCommentsArea(this.leaveDetailsGroup);this.createLeaveDetailsManagerCommentsArea(this.leaveDetailsGroup,t);this.createLeaveDetailsAttachmentsArea(this.leaveDetailsGroup,i);this.createLeaveDetailsForwardsArea(n,this.leaveDetailsGroup,t,i)},viewDetail:function(){var n=this.data.LeaveHeader,e=this.data.Components,t,u;this.isInEditMode=!1;Affinity.modal.show();Affinity.modal.clear();Affinity.modal.position();var r=new Element("div",{"class":"modal-data"}),f=new Element("div",{"class":"section"}).inject(r),i=new Element("div",{"class":"default-form"}).inject(f),o=new Element("div",{"class":"messages"}).inject(i);Affinity.login.profile.employeeNumber!==n.EmployeeNo&&(this.balanceBox=new Element("div",{"class":"leave-detail-balance-box"}).inject(i,"top"),this.balanceWidget=new EmployeeBalancesWidget({target:this.balanceBox,employeeId:n.EmployeeNo,filter:n.CodeDescription}));this.createEmployeeDetailsGroup(i,n);this.createLeaveTypeGroup(i);this.createLeavePeriodGroup(i);this.createLeaveDetailsGroup(i,this.isManager,n);this.createButtons(i,!1);Affinity.leave.populateLeaveActivity(i,n.EmployeeNo,n.TSGroupId);Affinity.modal.setElement(r);t={};this.isManager?(t=Affinity.leave.manager.config,this.generateCalendar(t,n.DateFrom,n.DateTo,!1),this.generateLeaveCodes(t),this.generateApprovers(t),this.setLeaveValues(n,t)):(t=Affinity.leave.employee.config,t.AllCompanyLeaveCodes=t.LeaveCodes,this.generateCalendar(t,n.DateFrom,n.DateTo,!1),this.generateLeaveCodes(t),this.setLeaveValues(n,t));u=this.createLeaveModel(this.data);this.createDaysFields(u,null);this.currentlySavedLeaveInstance=this.getEditedLeaveInstance();Affinity.tooltips.processNew()},showErrorMessages:function(n){var t,i;if(document.getElement(".messages")){var u=document.getElement(".messages").empty(),r=new Element("div").inject(u),f=new Element("ul").inject(r);for(t=0;t<n.length;t++)i=n[t]+"<br>",i=i.replace("\n","<br>"),new Element("li",{html:i}).inject(f);n.length>0&&r.addClass("acknowledgement-errors")}},createForwardingFeature:function(n){this.isManager&&(this.populateForwardHistory(this.data.Forwards,n),this.allowForwardToBasedFromLeaveInstance(this.data.LeaveHeader)&&(new Element("label",{html:"Forward Reason","class":"leave-detail-group-column-label"}).inject(this.forwardsAreaRow3Column2),this.forwardsAreaRow3.addClass("hidden"),this.forwardReason=new Element("textarea",{"class":"leave-detail-text-area",rows:"4",id:"forwardReason",name:"forwardReason"}).inject(this.forwardsAreaRow4Column2),this.forwardsAreaRow4.addClass("hidden")))},populateForwardHistory:function(n,t){var u;if(n&&t&&n.length>0){var i=new Element("div",{"class":"details-forwards-box form-row"}).inject(t),e=new Element("label",{"class":"details-label",html:"Forwards"}).inject(i),r=new Element("table",{"class":"details-forwards-history"}).inject(i),f=new Element("thead",{"class":""}).inject(r);new Element("tr",{"class":"forward-row"}).adopt(new Element("th",{"class":"",html:"Date Forwarded"}),new Element("th",{"class":"",html:"Forwarded By"}),new Element("th",{"class":"",html:"Forwarded To"}),new Element("th",{"class":"",html:"Reason"})).inject(f);u=new Element("tbody",{"class":""}).inject(r);Array.each(n,function(n){new Element("tr",{"class":"forward-row"}).adopt(new Element("td",{"class":"",html:Affinity.leave.cleanBadDate(n.TimeForwarded).format("%d-%b-%Y")}),new Element("td",{"class":"",html:n.ForwardedByName}),new Element("td",{"class":"",html:n.ForwardedToName}),new Element("td",{"class":"",html:n.Comment})).inject(u)})}},createLeaveModel:function(n){var f={},i={},t,u,r;for(i=n.Components[0],f.TotalDaysAppliedFor=n.LeaveHeader.TotalDays,f.TotalHoursAppliedFor=n.LeaveHeader.TotalHours,f.Days=[],t=0;t<i.Units.length;t++)u={},u.Date=i.Units[t].Date,u.IsPublicHoliday=i.Units[t].IsPublicHoliday,u.PositionUnits=[],r={},r.DaysAppliedFor=i.Units[t].DaysAppliedFor,r.HoursAppliedFor=i.Units[t].HoursAppliedFor,r.HoursWorkScheduled=i.Units[t].HoursWorkScheduled,r.HoursAppliedFor=i.Units[t].HoursAppliedFor,r.HoursStandard=i.Units[t].HoursStandard,r.DefaultHoursWorkScheduled=i.Units[t].DefaultHoursWorkScheduled,u.PositionUnits.push(r),f.Days.push(u);return f},getLeaveUnits:function(n,t,i,r,u,f){this.leaveUnitsRequest=new Request.JSON({method:"get",onRequest:function(){Affinity.leave.lockui("leaveApply-leaveUnitsRequest");uialert({message:"Calculating leave units. Please wait",showLoader:!0,showButtons:!1,noClose:!0})}.bind(this),onFailure:function(n){Affinity.leave.unlockui("leaveApply-leaveUnitsRequest");prompts.hide();Affinity.leave.handleXHRErrors(n,this._api,this._methodName)||uialert({message:"We can't load that information. Please try again.",okText:"Retry",showCancel:!0,onOk:function(){this.leaveUnitsRequest.send()}.bind(this)})}.bind(this),onException:function(){Affinity.leave.unlockui("leaveApply-leaveUnitsRequest");prompts.hide()},onCancel:function(){Affinity.leave.unlockui("leaveApply-leaveUnitsRequest");prompts.hide()},onSuccess:function(n){Affinity.leave.unlockui("leaveApply-leaveUnitsRequest");prompts.hide();f!=null&&f(n.Data)}.bind(this)});var e=Affinity.leave.apiroot+"CalculateLeaveUnits/"+n+"/"+t+"/"+i;r&&(e=e+"/"+r);u&&(e=e+"?positionCode="+encodeURIComponent(u));this._api=Affinity.GetCacheSafePath(e);this.leaveUnitsRequest&&this.leaveUnitsRequest.isRunning()&&this.leaveUnitsRequest.cancel();this.leaveUnitsRequest.url=this.leaveUnitsRequest.options.url=this._api;this.leaveUnitsRequest.send()},createDaysFields:function(n,t){var i,r;n.Days.length>0&&(this.leavePeriodDaysContainer!==undefined&&this.leavePeriodDaysContainer.destroy(),this.leavePeriodDaysContainer=new Element("div",{"class":"leave-detail-days-value-container"}).inject(this.leavePeriodDaysBox),Array.each(n.Days,function(n,i){var u,r,o,s;if(t!==null)for(u=0;u<t.leaveUnits.length;u++)r=t.leaveUnits[u],Date.parse(n.Date).toLocaleString()===Date.parse(r.leaveDate).toLocaleString()&&(n.PositionUnits[0].HoursAppliedFor=r.hoursAppliedFor,n.PositionUnits[0].DaysAppliedFor=r.daysAppliedFor,n.PositionUnits[0].HoursWorkScheduled=r.hoursWorkSched,n.PositionUnits[0].DefaultHoursWorkScheduled=r.defaultHoursWorkScheduled);this.leavePeriodDaysBoxValueRow=new Element("div").inject(this.leavePeriodDaysContainer);this.leavePeriodDaysDateColumnBlankContainer=new Element("span",{"class":"leave-detail-group-column-blank-header"}).inject(this.leavePeriodDaysBoxValueRow);this.leavePeriodDaysDateColumnContainer=new Element("span").inject(this.leavePeriodDaysBoxValueRow);this.leavePeriodDaysDaysColumnContainer=new Element("span").inject(this.leavePeriodDaysBoxValueRow);this.leavePeriodDaysHoursColumnContainer=new Element("span").inject(this.leavePeriodDaysBoxValueRow);this.leavePeriodDaysScheduledColumnContainer=new Element("span").inject(this.leavePeriodDaysBoxValueRow);var c=n.Date,l=c.toDate().toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),f=n.PositionUnits[0].HoursWorkScheduled===null?n.PositionUnits[0].HoursStandard:n.PositionUnits[0].HoursWorkScheduled;f=parseFloat(f).toFixed(2);var e=parseFloat(n.PositionUnits[0].DaysAppliedFor).toFixed(2),a=parseFloat(n.PositionUnits[0].HoursAppliedFor).toFixed(2),v=parseFloat(n.PositionUnits[0].DefaultHoursWorkScheduled),h=n.IsPublicHoliday;isNaN(e)&&(e=parseFloat(0).toFixed(2));o="leave-detail-input-hours";s="leave-detail-input-scheduledHours";this.isInEditMode||(o="leave-detail-input-uneditable-hours",s="leave-detail-input-uneditable-scheduledHours");h&&(f=parseFloat(0).toFixed(2));this.leavePeriodDaysDateColumnValue=new Element("input",{id:"date-"+i,type:"text","class":"leave-detail-input-date",value:l,readonly:"true"}).inject(this.leavePeriodDaysDateColumnContainer);this.leavePeriodDaysDaysColumnValue=new Element("input",{id:"days-"+i,type:"text","class":"leave-detail-input-days",value:e,readonly:"true"}).inject(this.leavePeriodDaysDaysColumnContainer);this.leavePeriodDaysHoursColumnValue=new Element("input",{id:"hours-"+i,type:"text","class":o,value:a,readonly:"true"}).inject(this.leavePeriodDaysHoursColumnContainer);this.leavePeriodDaysScheduledColumnValue=new Element("input",{id:"scheduledHours-"+i,type:"text","class":s,value:f,readonly:"true"}).inject(this.leavePeriodDaysScheduledColumnContainer);this.leavePeriodDaysDefaultScheduledColumnValue=new Element("input",{id:"defaultScheduledHours-"+i,type:"hidden","class":"leave-detail-input-defaultScheduledHours",value:v}).inject(this.leavePeriodDaysScheduledColumnContainer);this.leavePeriodDaysIsPublicHolidayColumnValue=new Element("input",{id:"isPublicHoliday-"+i,type:"hidden","class":"leave-detail-input-isPublicHoliday",value:h}).inject(this.leavePeriodDaysScheduledColumnContainer)}.bind(this)),i=this,this.computeUnitTotals(i),this.registerFocusOutEvents(),r=this.getEditedLeaveInstance().leaveUnits,this.formatFields(i,r),this.isInEditMode&&this.displayDaysInEditMode())},computeUnitTotals:function(n){var i,f,e,t;if(n.leavePeriodDaysContainer!==undefined){n.totalPeriodDaysDetail!==undefined&&n.totalPeriodDaysDetail.destroy();var r=0,u=0,o=this.getEditedLeaveInstance(),s=o.leaveUnits;for(i=0;i<s.length;i++)f=this.leavePeriodDaysContainer.getElementById("days-"+i),e=this.leavePeriodDaysContainer.getElementById("hours-"+i),r=parseFloat(r)+parseFloat(f.value),u=parseFloat(u)+parseFloat(e.value);t="Total [days] days / [hours] hours";t=t.replace("[days]",parseFloat(r).toFixed(2));t=t.replace("[hours]",parseFloat(u).toFixed(2));n.totalPeriodDaysDetail=new Element("label",{html:t,"class":"leave-detail-total-period-days-detail"}).inject(n.leavePeriodDaysBox)}},checkIfLeaveCanEditByDays:function(n){for(var i,r=this.employeeConfig.LeaveCodes,t=0;t<r.length;t++)if(i=r[t],i.LeaveCode===n.LeaveCode.toString())return i.CanEditByDays;return!1},setLeaveValues:function(n,t){var i,u,r,f;for(this.canEditByDays=this.checkIfLeaveCanEditByDays(n),i=0;i<this.leaveTypeSelector.length;i++)if(u=this.leaveTypeSelector[i],u.id===n.LeaveCode){if(this.leaveTypeSelector.selectedIndex=i,this.selectedLeaveLabel.set("html",u.text),this.leaveTypeSelectorChanged(t),this.leaveReasonSelector.length>0)for(r=0;r<this.leaveReasonSelector.length;r++)if(f=this.leaveReasonSelector[r],f.id===n.ReasonCode){this.leaveReasonSelector.selectedIndex=r;this.leaveReasonSelector.text!==""&&this.selectedReasonLabel.set("html",f.text);break}break}this.commentBox.set("html",n.Comment);this.partDayReason.set("html",n.PartDayReason);this.isManager&&this.managerCommentBox.set("html",n.Reply)},generateApprovers:function(n){var r=n.ForwardToManagers,t,i;for(this.defaultApprover=new Element("option",{value:"0",html:""}).inject(this.forwardSelector,"top"),t=0;t<r.length;t++)i=r[t],this.option=new Element("option",{value:t,html:i.EmployeeName,id:i.EmployeeNo}).inject(this.forwardSelector);this.forwardSelector.addEvent("change",function(n){n.target.selectedIndex===0?(this.forwardButton.addClass("hidden"),this.forwardsAreaRow3.addClass("hidden"),this.forwardsAreaRow4.addClass("hidden")):(this.forwardButton.removeClass("hidden"),this.forwardsAreaRow3.removeClass("hidden"),this.forwardsAreaRow4.removeClass("hidden"))}.bind(this))},generateLeaveCodes:function(n){this.defaultLeaveType=new Element("option",{value:"0",html:""}).inject(this.leaveTypeSelector,"top");this.leaveTypeSelector.addEvent("change",function(){this.leaveTypeSelectorChanged(n)}.bind(this));var t=n.AllCompanyLeaveCodes;Array.each(t,function(n,t){this.option=new Element("option",{value:t+1,html:n.Description,id:n.LeaveCode}).inject(this.leaveTypeSelector)}.bind(this))},handleValidationErrors:function(n,t,i){var u="Something's stopping the "+t+" field from updating. Try again.<br /><br />",r,f;i!==null&&i!==undefined&&(u=i);r=this.getValidationErrors(n);r!=""?(u=r,this.showErrorMessages(r)):(f=[],f.push(u),this.showErrorMessages(f))},handleRequestWarnings:function(n){var t,i;if(n.Messages!==null&&n.Messages!==undefined)for(t=0;t<n.Messages.length;t++)i=n.Messages[t],i.MessageType===1&&uialert({message:i.Message+"\n",okText:"Close",showButtons:!0,noClose:!1})},leaveTypeSelectorChanged:function(n){var i,t,f;this.leaveReasonSelector.empty();var e=this.leaveTypeSelector[this.leaveTypeSelector.selectedIndex].get("id"),r=n.AllCompanyLeaveCodes,u={};for(t=0;t<r.length;t++)if(e===r[t].LeaveCode){u=r[t];break}if(e!==null){for(this.canEditByDays=this.checkIfLeaveCanEditByDays(u),i=u.Reasons,this.defaultLeaveReason=new Element("option",{value:"0",html:""}).inject(this.leaveReasonSelector,"top"),t=0;t<i.length;t++)this.option=new Element("option",{value:t,html:i[t].Description,id:i[t].ReasonCode}).inject(this.leaveReasonSelector);if(f=this,this.leaveReasonSelector!=undefined&&this.leaveReasonSelector.removeEvents(),this.leaveReasonSelector.addEvent("change",function(){f.leaveReasonSelectorChanged(f)}),this.isInEditMode){var o=this,s=function(n,t){var r,i,u,f;if(n.ModelState!==null&&n.ModelState.Reason!==undefined)t.handleValidationErrors(n,"Reason");else for(t.handleValidationErrors(n,"Leave Type"),r=t.leaveTypeSelector,i=0;i<r.length;i++)if(u=r[i],t.data.LeaveHeader.LeaveCode===u.id){t.leaveTypeSelector.selectedIndex=parseInt(u.value);break}f=t.getEditedLeaveInstance().leaveUnits;t.formatFields(t,f)},h=function(n,t){t.handleRequestWarnings(n);var i=t.getEditedLeaveInstance().leaveUnits;t.formatFields(t,i)},c=this.getEditedLeaveInstance();this.currentlySavedLeaveInstance.payCode!==c.payCode&&this.updateLeave2(null,h,s,o)}}},leaveReasonSelectorChanged:function(n){if(n.isInEditMode){var r=n.getEditedLeaveInstance(),t=function(n,t){t.handleValidationErrors(n,"Reason")},i=function(n,t){t.handleRequestWarnings(n)};n.updateLeave2(null,i,t,n)}},updateRequestSuccessHandler:function(n,t,i,r){n.Message==="The request is invalid."?this.updateRequestValidationErrorHandler(n,400,t,r):(t.currentlySavedLeaveInstance=t.getEditedLeaveInstance(),t.data=n.Data,document.getElement(".messages").empty(),t.isManager&&(t.approveButton.removeClass("disabled"),t.declineButton.removeClass("disabled")),i!=null&&i(n,t),t.computeUnitTotals(t))},updateRequestValidationErrorHandler:function(n,t,i,r){if(document.getElement(".messages").empty(),t===400&&n.ModelState.Reason!==undefined){var u=n.ModelState.Reason[0];u!=null&&(i.requiredReason!==undefined&&i.requiredReason.empty(),i.requiredReason=new Element("span",{"class":"required",html:"*required"}).inject(i.reasonLabel,"bottom"),i.approveButton.addClass("disabled"),i.declineButton.addClass("disabled"))}r!=null&&r(n,i)},getListOfValidatedFields:function(n){return Object.getOwnPropertyNames(n)},getValidationErrors:function(n){var e=[],r,u,t,o,f,i,s;if(n.ModelState!==undefined)for(r=n.ModelState,u=this.getListOfValidatedFields(r),t=0;t<u.length;t++)for(o=u[t],f=r[o],i=0;i<f.length;i++)s=f[i],e.push(s);else return"";return e},setToPreviousValue:function(n){for(var r,t,u,f=n.currentlySavedLeaveInstance,e=Affinity.leave.manager.config,i=0;i<n.leaveTypeSelector.length;i++)if(r=n.leaveTypeSelector[i],r.id===f.LeaveCode){if(n.leaveTypeSelector.selectedIndex=i,n.selectedLeaveLabel.set("html",r.text),n.leaveTypeSelectorChanged(e),n.leaveReasonSelector.length>0)for(t=0;t<n.leaveReasonSelector.length;t++)if(u=this.leaveReasonSelector[t],u.id===f.ReasonCode){n.leaveReasonSelector.selectedIndex=t;n.leaveReasonSelector.text!==""&&n.selectedReasonLabel.set("html",u.text);break}break}},generateCalendar:function(n,t,i,r){var u=Affinity.leave.cleanBadDate(t),f=Affinity.leave.cleanBadDate(i),e;this.dateBox!==undefined&&this.dateBox.destroy();this.dateBox=new Element("div",{"class":"leave-date-box"}).inject(this.dates);this.leaveStart=new Element("div",{"class":"leave-date leave-start"}).adopt(this.leaveStartLabel=new Element("div",{"class":"title",html:"First Day"}),this.fromDateBox=new Element("div",{"class":"leave-date-picker selectable"}).adopt(this.leaveStartDay=new Element("div",{"class":"day"}),this.leaveStartDate=new Element("div",{"class":"date"}),this.leaveStartMonth=new Element("div",{"class":"month"}),this.leaveStartYear=new Element("div",{"class":"year"}))).inject(this.dateBox);this.leaveStop=new Element("div",{"class":"leave-date leave-stop"}).adopt(this.leaveStopLabel=new Element("div",{"class":"title",html:"Last Day"}),this.toDateBox=new Element("div",{"class":"leave-date-picker selectable"}).adopt(this.leaveStopDay=new Element("div",{"class":"day"}),this.leaveStopDate=new Element("div",{"class":"date"}),this.leaveStopMonth=new Element("div",{"class":"month"}),this.leaveStopYeah=new Element("div",{"class":"year"}))).inject(this.dateBox);this.hiddenDateDiv=new Element("div",{"class":"hidden"}).inject(this.dates,"top");this.hiddenDateDivFrom=new Element("div",{"class":"from-selector"}).inject(this.hiddenDateDiv);this.hiddenDateDivTo=new Element("div",{"class":"to-selector"}).inject(this.hiddenDateDiv);this.hiddenDateInputFrom=new Element("input",{type:"text",id:"apply-date-from","class":"scaled data-hj-whitelist"}).inject(this.hiddenDateDivFrom);this.hiddenDateInputTo=new Element("input",{type:"text",id:"apply-date-to","class":"scaled data-hj-whitelist"}).inject(this.hiddenDateDivTo);this.fromDateWidget=new UIDateTimeWidget({outputFormat:"%d.%m.%Y",displayFormat:"%a %e %b %Y",showCalendar:!0,showTime:!1,startDate:u.clone(),labelName:"",postId:"",postName:"",validationMethods:"",validationErrorStr:"",target:this.hiddenDateInputFrom});this.fromDateWidget.positionOverride=this.fromDateBox;this.toDateWidget=new UIDateTimeWidget({outputFormat:"%d.%m.%Y",displayFormat:"%a %e %b %Y",showCalendar:!0,showTime:!1,startDate:f.clone(),labelName:"",postId:"",postName:"",validationMethods:"",validationErrorStr:"",target:this.hiddenDateInputTo});this.toDateWidget.positionOverride=this.toDateBox;r&&(this.fromDateWidget.addEvent("dateClicked",function(){var n=this.fromDateWidget.getRawDate().clone(),t=this.toDateWidget.getRawDate().clone();n.greaterThan(t)&&(this.fromDateWidget.setDate(n),this.toDateWidget.setDate(n),t=n);Affinity.leave.setDates(this.fromDateBox,this.fromDateWidget.getRawDate());Affinity.leave.setDates(this.toDateBox,this.toDateWidget.getRawDate());this.recalculateLeaveUnitsDisplay(this.data.LeaveHeader.EmployeeNo,n.format("%d-%b-%Y"),t.format("%d-%b-%Y"),this.data.LeaveHeader.LeaveCode)}.bind(this)),this.toDateWidget.addEvent("dateClicked",function(){var t=this.fromDateWidget.getRawDate().clone(),n=this.toDateWidget.getRawDate().clone();n.lessThan(t)&&(this.fromDateWidget.setDate(n),this.toDateWidget.setDate(n),t=n);Affinity.leave.setDates(this.fromDateBox,this.fromDateWidget.getRawDate());Affinity.leave.setDates(this.toDateBox,this.toDateWidget.getRawDate());this.recalculateLeaveUnitsDisplay(this.data.LeaveHeader.EmployeeNo,t.format("%d-%b-%Y"),n.format("%d-%b-%Y"),this.data.LeaveHeader.LeaveCode)}.bind(this)));e=this;this.fromDateBox.addEvent(Affinity.events.click,function(n){this.toDateWidget.hide();this.fromDateWidget.externalShow(n)}.bind(this));this.toDateBox.addEvent(Affinity.events.click,function(n){this.fromDateWidget.hide();this.toDateWidget.externalShow(n)}.bind(this));Affinity.leave.setDates(this.fromDateBox,u);Affinity.leave.setDates(this.toDateBox,f);this.timeinputs=new Element("div",{"class":"leave-time-inputs hidden"}).inject(this.dates,"top");this.units=new Element("div",{"class":"leave-time-units"}).adopt(this.unitLabel=new Element("span",{"class":"title unit-label units",html:"Total Hours "}),this.unitInput=new Element("span",{"class":"units widget unit-input",id:""})).inject(this.timeinputs)},createButtonsForEditMode:function(n){n!==undefined&&n.empty();this.createForwardButton(n);this.createApproveButton(n);this.createDeclineButton(n);this.createCancelButton(n);this.createSubmitButton(n);this.createCloseButton(n)},createCloseButton:function(){this.closeButton=new Element("button",{"class":"grey details-close-leave-button w-icon-only leave-detail-button"}).adopt(new Element("span",{html:Affinity.icons.Cross}),new Element("span",{html:"Close"})).inject(this.buttonsBox);this.closeButton.addEvent("click",function(){Affinity.modal.closeButtonCloser()}.bind(this))},createEditButton:function(n){var t=this.data.LeaveHeader;t.StatusCode!==7&&(this.editButton=new Element("button",{"class":"blue details-edit-leave-button w-icon-only leave-detail-button"}).adopt(new Element("span",{html:Affinity.icons.Pencil}),new Element("span",{html:"Edit"})).inject(n),this.editButton.addEvent("click",function(){var i=this,r=function(r){r!=null&&r.Response==="Leave cancellation has been requested"?i.acknowledgementModal(r):(i.displayEditMode(),i.isManager||t.StatusCode!==3||(i.data.LeaveHeader.StatusCode=6),i.createButtonsForEditMode(n),i.isInEditMode=!0)},u;this.partialApproved=!1;u=function(){this.isManager||t.StatusCode!=3?!this.isManager&&this.partialApproved&&uialert({message:"This Leave Application is partially approved. <br /> Do you want to cancel it to make it editable?",showButtons:!0,showCancel:!0,okText:"Yes - Cancel and Edit",okIcon:Affinity.icons.Plane,onOk:function(){this.updateLeave2(6,r,null,i)}.bind(this),onCancel:function(){}}):uialert({message:"Approved/paid leave must first be cancelled before you can update it. Continue?",showButtons:!0,showCancel:!0,okText:"Yes",cancelText:"No",onOk:function(){this.updateLeave2(6,r,null,i)}.bind(this),onCancel:function(){}})}.bind(this);this.isManager||t.StatusCode!=3?!this.isManager&&this.partialApproved?Affinity.leave.doPositionUpdateOrValidation(t.TSGroupId,u,null):Affinity.leave.doPositionUpdateOrValidation(t.TSGroupId,r,null):Affinity.leave.doPositionUpdateOrValidation(t.TSGroupId,u,null)}.bind(this)))},createSubmitButton:function(n){var t=this.data.LeaveHeader;this.isManager||t.StatusCode===6&&(this.submitButton=new Element("button",{"class":"green details-edit-leave-button w-icon-only leave-detail-button"}).adopt(new Element("span",{html:Affinity.icons.Plane}),new Element("span",{html:"Submit"})).inject(n),this.submitButton.addEvent("click",function(){if(this.validateAttachmentRequirement()){var n=this,t=function(t){n.acknowledgementModal(t)};this.updateLeave2(0,t,null,n)}else this.displayAttachmentRequiredModalMessage()}.bind(this)))},createCancelButton:function(n){var t=this.data.LeaveHeader;this.isManager||(t.StatusCode===0||t.StatusCode===2||t.StatusCode===3)&&(this.cancelButton=new Element("button",{"class":"red details-edit-leave-button w-icon-only leave-detail-cancel-button"}).adopt(new Element("span",{html:Affinity.icons.Cancel}),new Element("span",{html:"Cancel Leave"})).inject(n),this.cancelButton.addEvent("click",function(){if(t.StatusCode==2){window.fireEvent("attachmentRequired",!1);var n=this,i=function(t){n.acknowledgementModal(t);Affinity.leave.manager.refreshAll()},r=function(n,t){t.handleValidationErrors(n,"Cancel","Something went wrong. Please try again")};this.updateLeave2(6,i,r,n)}else uialert({message:"Are you sure you want to cancel your leave?",showButtons:!0,showCancel:!0,okText:"Yes",cancelText:"No",onOk:function(){window.fireEvent("attachmentRequired",!1);var n=this,t=function(t){n.acknowledgementModal(t)};this.updateLeave2(6,t,null,n)}.bind(this)})}.bind(this)))},createDeclineButton:function(){var n=this.data.LeaveHeader;n.StatusCode!==6&&this.isManager&&!n.isExternal&&(this.declineButton=new Element("span",{"class":"button red w-icon-only leave-detail-button"}).adopt(new Element("span",{html:Affinity.icons.ThumbsDown}),new Element("span",{html:"Decline"})).inject(this.buttonsBox),this.declineButton.addEvent("click",function(){var n=this,t=function(t){n.acknowledgementModal(t);Affinity.leave.manager.refreshAll()},i=function(n,t){t.handleValidationErrors(n,"Decline","Something went wrong. Please try again")};this.updateLeave2(2,t,i,n)}.bind(this)))},createForwardButton:function(){var n=this.data.LeaveHeader;n.isExternal||this.isManager&&this.allowForwardToBasedFromLeaveInstance(n)&&(this.forwardButton=new Element("span",{"class":"button blue w-icon-only leave-detail-button hidden"}).adopt(new Element("span",{html:Affinity.icons.Forward}),new Element("span",{html:"Forward"})).inject(this.buttonsBox),this.forwardButton.addEvent("click",function(){var r=this.forwardSelector.selectedIndex,u=this.forwardSelector[r],f=u.get("id"),t={ForwardedTo:f,AuthorisationId:this.data.Components[0].Authorisation.AuthorisationId,Comment:this.forwardReason.get("value")};if(t.ForwardedTo===""){uialert({message:"Please select someone to forward to"});return}var e=this.data.LeaveHeader.EmployeeNo,o=this.data.LeaveHeader.TSGroupId,i="leave.detail.js -> createButtons (forward on click)",n=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"LeaveForwarding/"+e+"/"+o);new Request.JSON({url:n,headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("teamleave-forward");uialert({message:"Forwarding leave. Please wait",showLoader:!0,showButtons:!1,noClose:!0})},onFailure:function(t){Affinity.leave.unlockui("teamleave-forward");prompts.hide();Affinity.leave.handleXHRErrors(t,n,i)},onException:function(){Affinity.leave.unlockui("teamleave-forward");prompts.hide()},onCancel:function(){Affinity.leave.unlockui("teamleave-forward");prompts.hide()},onSuccess:function(t){Affinity.leave.unlockui("teamleave-forward");prompts.hide();Affinity.modal.hide();Affinity.leave.isErrorInJson(t,n,i)||Affinity.leave.manager.refreshAll()}.bind(this)}).post(JSON.stringify(t))}.bind(this)))},createApproveButton:function(){var n=this.data.LeaveHeader;n.isExternal||this.isManager&&n.StatusCode!==-1&&(this.approveButton=new Element("span",{"class":"button green w-icon-only leave-detail-button"}).adopt(new Element("span",{html:Affinity.icons.ThumbsUp}),new Element("span",{html:"Approve"})).inject(this.buttonsBox),this.approveButton.addEvent("click",function(){if(this.validateAttachmentRequirement()){var n=this,t=function(t){n.acknowledgementModal(t);Affinity.leave.manager.refreshAll()},i=function(n,t){t.handleValidationErrors(n,"Approve","Something went wrong. Please try again")};this.updateLeave2(3,t,i,n)}else this.displayAttachmentRequiredModalMessage()}.bind(this)))},createButtons:function(n){this.buttonsBox!==undefined&&this.buttonsBox.empty();this.buttonsBox=new Element("div",{"class":"leave-detail-button-container"}).inject(n);this.createApproveButton(this.buttonsBox);this.createDeclineButton(this.buttonsBox);this.createSubmitButton(this.buttonsBox,!1);this.createCancelButton(this.buttonsBox);this.createEditButton(this.buttonsBox);this.createCloseButton(this.buttonsBox)},getValidationErrorsConcatenated:function(n){var t=this.getValidationErrors(n),r="",i;if(t!=null&&t.length>0)for(i=0;i<t.length;i++)r+=t[i]+"\n";return r},recalculateLeaveUnitsDisplay:function(n,t,i,r){var u=this;this.getLeaveUnits(n,t,i,r,null,function(n){var r=u.getEditedLeaveInstance(),t,i;u.createDaysFields(n,r);t=function(n,t){var i,r,u;t.handleValidationErrors(n,"Unit");i=Date.parse(t.currentlySavedLeaveInstance.dateFrom);r=Date.parse(t.currentlySavedLeaveInstance.dateTo);t.fromDateWidget.setDate(i);t.toDateWidget.setDate(r);Affinity.leave.setDates(t.fromDateBox,i);Affinity.leave.setDates(t.toDateBox,r);u=t.createLeaveModel(t.data);t.createDaysFields(u,t.currentlySavedLeaveInstance)};i=function(n,t){t.handleRequestWarnings(n)};u.updateLeave2(null,i,t,u)})},getMaxHours:function(n,t,i){for(var u,e,r=0;r<i.length;r++)if(u=i[r],u.PositionCode===t)for(e=0;e<u.Units.length;e++){var f=u.Units[r],o=Date.parse(n).toLocaleString(),s=Date.parse(f.Date).toLocaleString();if(o===s)return f.HoursWorkScheduled===null?f.HoursStandard:f.HoursWorkScheduled}return 0},displayDaysInEditMode:function(){var r=this.data.LeaveHeader.UnitType,t=this.getEditedLeaveInstance(),i=t.leaveUnits,n;this.isInEditMode=!0;this.formatFields(this,i);n=this;this.leavePeriodDaysContainerEdit=new InputEditWidget({target:n.leavePeriodDaysBox,input:n.leavePeriodDaysContainer,updateInput:function(){var r=n.currentlySavedLeaveInstance.leaveUnits,u=n.getEditedLeaveInstance().leaveUnits,t,i;JSON.stringify(r)!==JSON.stringify(u)&&(t=function(n,t){t.handleValidationErrors(n,"Unit");var i=t.createLeaveModel(t.data);t.createDaysFields(i,t.currentlySavedLeaveInstance)},i=function(n,t){var i=t.getEditedLeaveInstance(),r=t.createLeaveModel(t.data);t.createDaysFields(r,i);t.handleRequestWarnings(n)},n.updateLeave2(null,i,t,n))}.bind(this),cancelInput:function(){var i=n.getEditedLeaveInstance(),t=n.createLeaveModel(n.data);n.createDaysFields(t,null)}.bind(this)})},displayEditMode:function(){this.generateCalendar(Affinity.leave.manager.config,this.data.LeaveHeader.DateFrom,this.data.LeaveHeader.DateTo,!0);this.displayDaysInEditMode();var n=this;this.selectedLeaveLabel.addClass("hidden");this.selectedReasonLabel.addClass("hidden");this.leaveTypeSelector.removeClass("hidden");this.leaveReasonSelector.removeClass("hidden");this.forwardsAreaRow1!==undefined&&this.forwardsAreaRow1.removeClass("hidden");this.forwardsAreaRow2!==undefined&&this.forwardsAreaRow2.removeClass("hidden");Affinity.leave.employee&&!this.isManager&&(this.commentBox!==undefined&&(this.commentBox.destroy(),this.commentBox=new Element("textarea",{"class":"leave-detail-text-area",rows:"4",id:"comment",name:"comment"}).inject(this.commentsAreaRow2Column2),this.commentBox.set("html",this.data.LeaveHeader.Comment),this.commentEdit=new InputEditWidget({target:this.commentsAreaRow2Column2,input:this.commentBox,updateInput:function(){var n=this.commentBox.value;if(n!==(this.data.LeaveHeader.Comment===null?"":this.data.LeaveHeader.Comment)){var t=this,i=function(n,t){t.handleValidationErrors(n,"Comment")},r=function(n,t){t.handleRequestWarnings(n)};this.updateLeave2(null,r,i,t)}}.bind(this),cancelInput:function(){this.commentBox.set("value",this.data.LeaveHeader.Comment)}.bind(this)})),this.partDayReason!==undefined&&(this.partDayReason.destroy(),this.partDayReason=new Element("textarea",{"class":"leave-detail-text-area-small",rows:"4",id:"partDayReason",name:"partDayReason"}).inject(this.leavePeriodRequestPartDayInputColumn2),this.partDayReason.set("html",this.data.LeaveHeader.PartDayReason),this.partDayReasonEdit=new InputEditWidget({target:this.leavePeriodRequestPartDayInputColumn2,input:this.partDayReason,updateInput:function(){var n=this.partDayReason.value;if(n!==(this.data.LeaveHeader.PartDayReason===null?"":this.data.LeaveHeader.PartDayReason)){var t=this,i=function(n,t){t.handleValidationErrors(n,"Part Day Reason")},r=function(n,t){t.handleRequestWarnings(n)};this.updateLeave2(null,r,i,t)}}.bind(this),cancelInput:function(){this.partDayReason.set("value",this.data.LeaveHeader.PartDayReason)}.bind(this)})));this.attachmentsAreaRow2Column2!==undefined&&(this.attachmentsAreaRow2Column2.empty(),this.attachmentform=new Element("div",{"class":"form-row"}).inject(this.attachmentsAreaRow2Column2),this.attachWidgetDiv=new Element("div",{"class":"uploadmulti print-hidden","data-question-name":"docs"}).adopt(this.attachWidgetInput=new Element("input",{type:"file"}),new Element("input",{hidden:"file","class":"initialValues"})),this.attachmentbox=new Element("div",{"class":"edit-leave-attachment"}).adopt(this.attachWidgetDiv).inject(this.attachmentform),this.attachWidget=new UIUplaodersMulti({maxsize:20963328}),this.attachWidget.addEvent("multiFileTooLarge",this.fileTooLarge),Affinity.leave.populateAttachments(this.data.LeaveHeader,this.data.Attachments,this.attachWidget,this.attachWidgetDiv),this.attachWidgetDiv.addEvent("multiFileDeleted",this.deleteAttachment),this.attachWidgetDiv.addEvent("multiFileAdded",this.postAttachments),this.attachWidgetDiv.addEvent("validateMultiFileDelete",this.validateFileDeletion),window.addEvent("multiFileDeletedFromConfirmation",this.deleteAttachment),window.addEvent("attachmentRequired",this.setAttachmentRequiredValue),window.addEvent("leaveEditDetailCloses",this.validateBeforeClosingModal),Affinity.modal.beforeClose=function(){this.attachWidgetDiv&&(this.attachWidgetDiv.removeEvent("multiFileDeleted",this.deleteAttachment),this.attachWidgetDiv.removeEvent("multiFileAdded",this.postAttachments),this.attachWidgetDiv.removeEvent("validateMultiFileDelete",this.validateFileDeletion),window.removeEvent("multiFileDeletedFromConfirmation",this.deleteAttachment),window.removeEvent("attachmentRequired",this.setAttachmentRequiredValue),window.removeEvent("leaveEditDetailCloses",this.validateBeforeClosingModal))})},attachmentRequired:!1,setAttachmentRequiredValue:function(n){this.attachmentRequired=n},displayAttachmentRequiredModalMessage:function(){uialert({message:"You must attach supporting documentation when applying for this type of leave.",showLoader:!1,showButtons:!0,noClose:!1})},isAttachmentMandatoryForLeaveType:function(){var r=!1,t=null,i,u,n,f;if(Affinity.leave.manager&&this.isManager)if(Affinity.leave.manager.config!==undefined&&Affinity.leave.manager.config.Employees!==undefined){for(i=Affinity.leave.manager.config.Employees,n=0;n<i.length;n++)if(i[n].LeaveCodes!==undefined){t=i[n].LeaveCodes;break}}else this.config&&(t=this.config.LeaveCodes);else t=Affinity.leave.employee.config!==undefined&&Affinity.leave.employee.config.LeaveCodes!==undefined?Affinity.leave.employee.config.LeaveCodes:this.config.LeaveCodes;if(t)for(u=this.data.LeaveHeader.LeaveCode,n=0;n<t.length;n++)if(f=t[n].LeaveCode,u===f){r=t[n].MandatoryAttachment;break}return r},validateAttachmentRequirement:function(){return!this.hasAttachedFiles()&&this.isAttachmentMandatoryForLeaveType()?!1:!0},hasAttachedFiles:function(){var n=document.getElementsByClassName("details-attachments"),i,f,r,u,t;if(n&&n.length>0){if(t=n[0].getElements("li"),t!==undefined&&t.length>0)return!0}else if(n=document.getElementsByClassName("upload-table"),n&&n.length>0){for(i=0;i<n.length;i++)if(f=n[i].hasClass("hidden"),!f&&(r=n[i].getElement("table"),r&&(u=r.getElements("tbody tr"),u&&u.length>0)))return!0;if(t=n[0].getElements("li"),t!==undefined&&t.length>0)return!0}return!1},validateBeforeClosingModal:function(){var i=!1,n,t,r;if(Affinity.leave.manager&&this.isManager?Affinity.leave.manager.refreshAll():Affinity.leave.employee&&!this.isManager&&Affinity.leave.employee.refreshAll(),n=document.getElementsByClassName("button green w-icon-only"),n&&n.length>0)for(t=0;t<n.length;t++)if(r=n[t].innerText.contains("Submit"),r){i=!0;break}this.attachmentRequired&&!i?(Affinity.modal.backgroundCloses=!1,uialert({message:"You must attach supporting documentation when applying for this type of leave.",showLoader:!1,showButtons:!0,noClose:!1})):Affinity.modal.backgroundCloses=!0},validateFileDeletion:function(n){var f=n.table.getElements("tbody tr"),r,t,u,e,i,o;if(f){if(r=!1,t=null,t=Affinity.leave.manager&&Affinity.leave.manager.config&&Affinity.leave.manager.config.LeaveCodes?Affinity.leave.manager.config.LeaveCodes:Affinity.leave.employee.config.LeaveCodes,t&&(u=document.getElementsByClassName("leave-type-selector")[0],u))for(e=u.getElement("option:selected").get("id"),i=0;i<t.length;i++)if(o=t[i].LeaveCode,e===o){r=t[i].MandatoryAttachment;break}r&&f.length===1?window.fireEvent("attachmentRequired",!0):window.fireEvent("attachmentRequired",!1);n.row.addClass("preventDeletion");uiconfirm({message:"Are you sure you want to delete this?",onOk:function(){window.fireEvent("multiFileDeletedFromConfirmation",n.deletionTarget);n.row.destroy();Affinity.uiGrid.zebra(n.table);n.table.getElements("tbody tr").length==0&&n.table.getParent().addClass("hidden")}.bind(this),onCancel:function(){window.fireEvent("attachmentRequired",!1)}.bind(this)})}},checkAttachmentsFileSize:function(n){var f,r,t,u,i;if(n!==undefined&&n.fileElement!==undefined&&n.fileElement.files!==undefined)for(f=n.fileElement.files.length,r=n.fileElement.files,t=0;t<f;t++)if(r[t].size!==undefined&&r[t].size>20963328){for(u=this.attachWidgetDiv.getElements("table tbody tr"),i=0;i<u.length;i++)u[i].innerText.indexOf(r[t].name)!==-1&&u[i].destroy();return!1}return!0},postAttachments:function(n){if(!this.checkAttachmentsFileSize(n)){window.uialert({message:"You can only attach a document that is less than 20MB in size. Please try again."});return}Affinity.leave.lockui("leaveDetail-postAttachments");uialert({message:"Attaching file",showLoader:!0,showButtons:!1,noClose:!0});var t=this.data.LeaveHeader.TSGroupId,i=this.data.LeaveHeader.EmployeeNo;Affinity.leave.postAttachements(i,t,function(n){Affinity.leave.populateAttachments(this.data.LeaveHeader,n.Data,this.attachWidget,this.attachWidgetDiv);Affinity.leave.unlockui("leaveDetail-postAttachments");window.fireEvent("attachmentRequired",!1)}.bind(this))},deleteAttachment:function(n){Affinity.leave.lockui("leaveDetail-deleteAttachment");uialert({message:"Deleting file",showLoader:!0,showButtons:!1,noClose:!0});var t=this.data.LeaveHeader.TSGroupId,i=this.data.LeaveHeader.EmployeeNo;Affinity.leave.deleteAttachment(i,t,n.deletedId,function(n){Affinity.leave.populateAttachments(this.data.LeaveHeader,n.Data,this.attachWidget,this.attachWidgetDiv);Affinity.leave.unlockui("leaveDetail-deleteAttachment")}.bind(this))},fileTooLarge:function(n){var t=(n.maxsize/1048576).round(2),i=(n.size/1048576).round(2);window.uialert({message:"You can only attach a document that is less than 20MB in size. Please try again."})},allowForwardToBasedFromLeaveInstance:function(n){var t=!1,i=this.getLeaveStatusWhereForwardToIsNotAllowed();return n!==undefined&&n.StatusCode!==undefined&&i.indexOf(n.StatusCode)===-1&&(t=!0),t},getLeaveStatusWhereForwardToIsNotAllowed:function(){return[3,2,6]},validateAttachmentRequirement:function(){return!this.hasAttachedFiles()&&this.isAttachmentMandatoryForLeaveType()?!1:!0},hasAttachedFiles:function(){var n=document.getElementsByClassName("details-attachments"),i,f,r,u,t;if(n&&n.length>0){if(t=n[0].getElements("li"),t!==undefined&&t.length>0)return!0}else if(n=document.getElementsByClassName("upload-table"),n&&n.length>0){for(i=0;i<n.length;i++)if(f=n[i].hasClass("hidden"),!f&&(r=n[i].getElement("table"),r&&(u=r.getElements("tbody tr"),u&&u.length>0)))return!0;if(t=n[0].getElements("li"),t!==undefined&&t.length>0)return!0}return!1},isAttachmentMandatoryForLeaveType:function(){var r=!1,t=null,i,u,n,f;if(Affinity.leave.manager)if(Affinity.leave.manager.config!==undefined&&Affinity.leave.manager.config.Employees!==undefined){for(i=Affinity.leave.manager.config.Employees,n=0;n<i.length;n++)if(i[n].LeaveCodes!==undefined){t=i[n].LeaveCodes;break}}else this.config&&(t=this.config.LeaveCodes);else t=Affinity.leave.employee.config!==undefined&&Affinity.leave.employee.config.LeaveCodes!==undefined?Affinity.leave.employee.config.LeaveCodes:this.config.LeaveCodes;if(t)for(u=this.data.LeaveHeader.LeaveCode,n=0;n<t.length;n++)if(f=t[n].LeaveCode,u===f){r=t[n].MandatoryAttachment;break}return r},registerFocusOutEvents:function(){for(var t=this.getEditedLeaveInstance().leaveUnits,i=this,n=0;n<t.length;n++){var f=this.leavePeriodDaysContainer.getElementById("days-"+n),r=this.leavePeriodDaysContainer.getElementById("hours-"+n),e=this.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+n),u=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+n);r.removeEvents();r.addEvent("focusout",function(){this.formatFields(this,t);this.computeUnitTotals(i)}.bind(this));u.removeEvents();u.addEvent("focusout",function(){this.formatFields(this,t);this.computeUnitTotals(i)}.bind(this))}},setAllFieldsToReadOnlyIfLeaveCanEditByDays:function(n){var u,t;if(this.isInEditMode)for(u=this.getEditedLeaveInstance().leaveUnits,t=0;t<u.length;t++){var f=u[t],e=this.leavePeriodDaysContainer.getElementById("date-"+t),o=this.leavePeriodDaysContainer.getElementById("days-"+t),r=this.leavePeriodDaysContainer.getElementById("hours-"+t),s=this.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+t),i=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+t);n?(r.set("readonly",!1),r.removeClass("leave-apply-input-uneditable-hours"),r.addClass("leave-apply-input-hours"),Affinity.leave.manager&&this.isManager?(i.set("readonly",!1),i.removeClass("leave-detail-input-uneditable-scheduledHours"),i.addClass("leave-detail-input-scheduledHours")):(i.set("readonly",!0),i.removeClass("leave-detail-input-scheduledHours"),i.addClass("leave-detail-input-uneditable-scheduledHours"))):(r.set("readonly",!0),r.removeClass("leave-apply-input-hours"),r.addClass("leave-apply-input-uneditable-hours"),i.set("readonly",!0),i.removeClass("leave-detail-input-scheduledHours"),i.addClass("leave-detail-input-uneditable-scheduledHours"))}},computeUnitsDaysAppliedFor:function(){for(var t,u=this.getEditedLeaveInstance().leaveUnits,n=0;n<u.length;n++){var f=this.leavePeriodDaysContainer.getElementById("days-"+n),i=this.leavePeriodDaysContainer.getElementById("hours-"+n),e=this.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+n),r=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+n);i.value=parseFloat(i.value).toFixed(2);r.value=parseFloat(r.value).toFixed(2);t=parseFloat(i.value)/parseFloat(r.value);t>1?t=1:isNaN(t)&&(t=0);f.value=parseFloat(t).toFixed(2)}},formatUnitsToDecimalFormat:function(){for(var u=this.getEditedLeaveInstance().leaveUnits,n=0;n<u.length;n++){var t=this.leavePeriodDaysContainer.getElementById("days-"+n),i=this.leavePeriodDaysContainer.getElementById("hours-"+n),f=this.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+n),r=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+n);t.value=parseFloat(t.value).toFixed(2);i.value=parseFloat(i.value).toFixed(2);r.value=parseFloat(r.value).toFixed(2)}},setScheduledHoursToReadOnlyIfHoursIsZero:function(){for(var i=this.getEditedLeaveInstance().leaveUnits,n=0;n<i.length;n++){var u=i[n],e=this.leavePeriodDaysContainer.getElementById("date-"+n),o=this.leavePeriodDaysContainer.getElementById("days-"+n),r=this.leavePeriodDaysContainer.getElementById("hours-"+n),f=this.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+n),t=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+n);parseFloat(r.value)===0?(u.isPublicHoliday||(t.value=parseFloat(f.value)),t.set("readonly",!0),t.removeClass("leave-detail-input-scheduledHours"),t.addClass("leave-detail-input-uneditable-scheduledHours")):parseFloat(r.value)>0&&Affinity.leave.manager&&this.isManager&&this.isEditMode&&(t.set("readonly",!1),t.removeClass("leave-detail-input-uneditable-scheduledHours"),t.addClass("leave-detail-input-scheduledHours"))}},formatFields:function(n,t){for(var o=this.getFormattingRule("days"),s=this.getFormattingRule("hours"),h=this.getFormattingRule("scheduledHours"),c=this.getFormattingRule("date"),r=0;r<t.length;r++){var u=n.leavePeriodDaysContainer.getElementById("date-"+r),l=n.leavePeriodDaysContainer.getElementById("days-"+r),f=n.leavePeriodDaysContainer.getElementById("hours-"+r),a=n.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+r),e=n.leavePeriodDaysContainer.getElementById("scheduledHours-"+r),v=n.leavePeriodDaysContainer.getElementById("isPublicHoliday-"+r),i={};i.isManager=this.identifyIfManager(n);i.isPublicHoliday=v.value==="true"?!0:!1;i.isWeekEnds=this.identifyIfWeekends(u);i.hoursValue=parseFloat(f.value);i.defaultScheduledHoursValue=parseFloat(a.value);i.scheduledHoursValue=parseFloat(e.value);i.formEditMode=n.isInEditMode===undefined?!0:n.isInEditMode;i.canEditByDays=n.canEditByDays;this.applyFormattingRule(l,o,i);this.applyFormattingRule(f,s,i);this.applyFormattingRule(e,h,i);this.applyFormattingRule(u,c,i)}},identifyIfWeekends:function(n){return n.value.indexOf("aturday")!==-1||n.value.indexOf("unday")!==-1?!0:!1},identifyIfManager:function(n){return n.isManager&&Affinity.leave.manager?!0:!1},applyFormattingRule:function(n,t,i){t.toFormatIn2DecimalPlaces&&(n.value=parseFloat(n.value).toFixed(2));t.formatToDefault(n,i);t.highlightInDarkShade(n,i);t.highlightInYellow(n,i);t.setValueToZero(n,i);t.setValueBasedOnHours(n,i);t.formatToReadOnly(n,i)},formatToDefault:function(n){n.set("readonly",!1);n.set("style","background-color: white !important;");isNaN(parseFloat(n.value))&&(n.value=parseFloat(0).toFixed(2))},getFormattingRule:function(n){var t=[],u=this.createDaysRulesObject(),f=this.createHoursRulesObject(),e=this.createScheduledHoursRulesObject(),o=this.createDateRulesObject(),i,r;for(t.push(u),t.push(f),t.push(e),t.push(o),i=0;i<t.length;i++)if(r=t[i],r.fieldName===n)return r;return null},createDateRulesObject:function(){var n={};return n.fieldName="date",n.formatToDefault=function(){},n.toFormatIn2DecimalPlaces=!1,n.formatToReadOnly=function(){}.bind(this),n.highlightInDarkShade=function(n,t){(t.IsPublicHoliday||t.isWeekEnds)&&this.toDarkBackground(n)}.bind(this),n.highlightInYellow=function(){}.bind(this),n.setValueToZero=function(){}.bind(this),n.setValueBasedOnHours=function(){}.bind(this),n},createScheduledHoursRulesObject:function(){var n={};return n.fieldName="scheduledHours",n.formatToDefault=this.formatToDefault,n.toFormatIn2DecimalPlaces=!0,n.formatToReadOnly=function(n,t){t.formEditMode&&!t.isPublicHoliday&&t.canEditByDays&&t.isManager&&parseFloat(t.hoursValue)!==0?(n.set("style","background-color: white !important;"),n.set("readonly",!1),n.removeClass("leave-detail-input-uneditable-hours"),n.addClass("leave-detail-input-hours")):(n.set("readonly",!0),n.removeClass("leave-detail-input-hours"),n.addClass("leave-detail-input-uneditable-hours"))}.bind(this),n.highlightInDarkShade=function(n,t){(t.isPublicHoliday||t.isWeekEnds)&&this.toDarkBackground(n)}.bind(this),n.highlightInYellow=function(){}.bind(this),n.setValueToZero=function(n,t){parseFloat(t.hoursValue)===0&&t.isManager&&(n.value=parseFloat(0).toFixed(2))}.bind(this),n.setValueBasedOnHours=function(){}.bind(this),n},createHoursRulesObject:function(){var n={};return n.fieldName="hours",n.formatToDefault=this.formatToDefault,n.toFormatIn2DecimalPlaces=!0,n.formatToReadOnly=function(n,t){t.formEditMode&&!t.isPublicHoliday&&t.canEditByDays?(n.set("readonly",!1),n.removeClass("leave-detail-input-uneditable-hours"),n.addClass("leave-detail-input-hours")):(n.set("readonly",!0),n.removeClass("leave-detail-input-hours"),n.addClass("leave-detail-input-uneditable-hours"))}.bind(this),n.highlightInDarkShade=function(n,t){t.isPublicHoliday&&this.toDarkBackground(n)}.bind(this),n.highlightInYellow=function(n,t){t.isPublicHoliday||parseFloat(t.hoursValue)!==parseFloat(t.defaultScheduledHoursValue)&&this.toYellowBackground(n)}.bind(this),n.setValueToZero=function(){}.bind(this),n.setValueBasedOnHours=function(){}.bind(this),n},createDaysRulesObject:function(){var n={};return n.fieldName="days",n.formatToDefault=this.formatToDefault,n.toFormatIn2DecimalPlaces=!0,n.formatToReadOnly=function(n){n.set("readonly",!0)}.bind(this),n.highlightInDarkShade=function(n,t){(t.isPublicHoliday||t.isWeekEnds)&&this.toDarkBackground(n)}.bind(this),n.highlightInYellow=function(n,t){t.isPublicHoliday||parseFloat(t.hoursValue)!==parseFloat(t.defaultScheduledHoursValue)&&this.toYellowBackground(n)}.bind(this),n.setValueToZero=function(){}.bind(this),n.setValueBasedOnHours=function(n,t){var i=parseFloat(t.hoursValue)/parseFloat(t.scheduledHoursValue);!isNaN(i)&&parseFloat(i)>=0&&i!==Infinity?(n.value=parseFloat(i).toFixed(2),parseFloat(i)>1&&(n.value=parseFloat(1).toFixed(2))):n.value=i===Infinity?"1.00":isNaN(i)&&parseFloat(t.hoursValue)>0?"1.00":"0.00"}.bind(this),n},toYellowBackground:function(n){n.set("style","background-color: yellow !important;")},toDarkBackground:function(n){n.set("style","background-color: #C0C0C0 !important;")},highlightUnitFieldsIfNotEqualToDefaultValue:function(){for(var f,e=this.getEditedLeaveInstance().leaveUnits,n=0;n<e.length;n++){var i=this.leavePeriodDaysContainer.getElementById("date-"+n),r=this.leavePeriodDaysContainer.getElementById("days-"+n),t=this.leavePeriodDaysContainer.getElementById("hours-"+n),o=this.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+n),u=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+n),s=this.leavePeriodDaysContainer.getElementById("isPublicHoliday-"+n);t.set("style","");r.set("style","");i.set("style","");u.set("style","");f=s.value==="true"?!0:!1;f&&(i.set("style","background-color: #C0C0C0 !important;"),r.set("style","background-color: #C0C0C0 !important;"),t.set("style","background-color: #C0C0C0 !important;"),u.set("style","background-color: #C0C0C0 !important;"));(i.value.indexOf("aturday")!==-1||i.value.indexOf("unday")!==-1)&&(i.set("style","background-color: #C0C0C0 !important;"),r.set("style","background-color: #C0C0C0 !important;"),t.set("style","background-color: #C0C0C0 !important;"),u.set("style","background-color: #C0C0C0 !important;"));f||(this.isInEditMode&&(Affinity.leave.manager&&this.isManager&&(t.set("style",""),u.set("style","")),Affinity.leave.employee&&!this.isManager&&t.set("style","")),parseFloat(t.value)!==parseFloat(o.value)&&(t.set("style","background-color: yellow !important;"),r.set("style","background-color: yellow !important;")))}},getEditedLeaveInstance:function(n){var u=this.data.LeaveHeader,t={},f,r;for(t.tsGroupId=u.TSGroupId,t.employeeNo=u.EmployeeNo,t.dateFrom=this.fromDateWidget.getRawDate().format("%d-%b-%Y"),t.dateTo=this.toDateWidget.getRawDate().format("%d-%b-%Y"),t.payCode=this.leaveTypeSelector[this.leaveTypeSelector.selectedIndex].id,t.calcUnit=u.UnitType,t.reason=this.leaveReasonSelector.selectedIndex!==-1?this.leaveReasonSelector[this.leaveReasonSelector.selectedIndex].id===""?null:this.leaveReasonSelector[this.leaveReasonSelector.selectedIndex].id:null,Affinity.leave.manager&&this.isManager?(t.managerNotes=this.managerCommentBox.value===""?null:this.managerCommentBox.value,t.empComment=this.commentBox.textContent===""?null:this.commentBox.textContent,t.partDayReason=this.partDayReason.textContent===""?null:this.partDayReason.textContent):Affinity.leave.employee&&!this.isManager&&(t.managerNotes=u.Reply,this.isInEditMode?(t.empComment=this.commentBox.value===""?null:this.commentBox.value,t.partDayReason=this.partDayReason.value===""?null:this.partDayReason.value):(t.empComment=this.commentBox.textContent===""?null:this.commentBox.textContent,t.partDayReason=this.partDayReason.textContent===""?null:this.partDayReason.textContent)),t.timeLastModified=u.TimeLastModified,t.leaveUnits=[],f=this.leavePeriodDaysContainer.getElementsByClassName("leave-detail-input-date"),r=0;r<f.length;r++){var o=Date.parse(f[r].value).format("%d-%b-%Y"),h=this.leavePeriodDaysContainer.getElementById("hours-"+r),c=this.leavePeriodDaysContainer.getElementById("days-"+r),l=this.leavePeriodDaysContainer.getElementById("scheduledHours-"+r),a=this.leavePeriodDaysContainer.getElementById("defaultScheduledHours-"+r),v=this.leavePeriodDaysContainer.getElementById("isPublicHoliday-"+r);if(Date.parse(o)<=Date.parse(t.dateTo)){var e=parseFloat(h.value),y=parseFloat(c.value),s=parseFloat(l.value),i={};i.tsGroupId=u.TSGroupId;i.leaveDate=o;i.positionCode=u.PositionCode;i.hoursAppliedFor=e;i.daysAppliedFor=this.computeDaysEquivalent(e,s);i.hoursWorkSched=s;i.defaultHoursWorkScheduled=parseFloat(a.value);i.isPublicHoliday=v.value==="true"?!0:!1;n===!0&&e>0?i.isPublicHoliday||t.leaveUnits.push(i):(n===null||n===undefined||n===!1)&&t.leaveUnits.push(i)}}return t},computeDaysEquivalent:function(n,t){var i=n/t;return i>1&&(i=1),i},updateLeave2:function(n,t,i,r){var u=this.getEditedLeaveInstance(!0),f;u.leaveStatus=n!==null?n:this.data.LeaveHeader.StatusCode;f=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"UpdateLeaveV2/"+u.tsGroupId);new Request.JSON({url:f,headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("myleave-update");uialert({message:"Saving changes. Please wait",showLoader:!0,showButtons:!1,noClose:!0})},onFailure:function(n){Affinity.leave.unlockui("myleave-update");prompts.hide();var t=JSON.parse(n.response);r.updateRequestValidationErrorHandler(t,n.status,r,i)}.bind(this),onException:function(){Affinity.leave.unlockui("myleave-update");prompts.hide()},onCancel:function(){Affinity.leave.unlockui("myleave-update");prompts.hide()},onSuccess:function(n){Affinity.leave.unlockui("myleave-update");prompts.hide();r.updateRequestSuccessHandler(n,r,t,i)}.bind(this)}).post(JSON.stringify(u))},acknowledgementModal:function(n,t){var s,f;Affinity.modal.show();Affinity.modal.clear();Affinity.modal.position();var i=new Element("div",{"class":"modal-data",style:"width:700px;"}),u=new Element("div").inject(i),e=new Element("ul").inject(u),r=new Element("div").inject(i),o=new Element("ul").inject(r);t&&typeOf(t)==="string"&&(s=new Element("div",{"class":"acknowledgement-header"}).adopt(new Element("span",{"class":"",html:t})).inject(i));f=new Element("div",{"class":"acknowledgement-content"}).inject(i);n.Messages!==null&&n.Messages.length>0&&Array.each(n.Messages,function(n){n.MessageType===1&&(new Element("li",{html:n.Message}).inject(e),u.addClass("acknowledgement-warnings"));n.MessageType===0&&(new Element("li",{html:n.Message}).inject(o),r.addClass("acknowledgement-errors"))});n.Exception!=null?(r.addClass("acknowledgement-errors"),r.set("html",n.Exception)):f.set("html",Affinity.leave.cleanResponse(n.Response));Affinity.modal.setElement(i);Affinity.modal.show()}}),UILeaveDetailV1=new Class({Implements:[Options,Events],State:["Closed","View","Edit"],Binds:["getDetail","viewDetail","editDetail","doEditDetail","tryCreateAuditLogForImportedLeave","initializeSubmitLeaveRequest","getLeaveStatusWhereForwardToIsNotAllowed","toHideForwardToBasedFromLeaveInstance","createCommentReplyEdits","createButtons","createEditableDates","newLeaveReason","setStartDate","setEndDate","setUnitInputEvents","buildUnitsTotals","populateForwardHistory","updateDate","updateUnits","doUpdateUnits","updateAuthoriser","doUpdateAuthoriser","deleteAttachment","postAttachments","deleteLeave","submitLeave","acknowledgementModal","reset","destroy"],options:{target:null,isManager:!1},initialize:function(n){this.setOptions(n);this.target=this.options.target;this.isManager=this.options.isManager?!0:!1;this.leaveDetailRequest=new Request.JSON({onRequest:function(){Affinity.leave.lockui("leaveDetail-leaveDetailRequest")},onFailure:function(n){Affinity.leave.unlockui("leaveDetail-leaveDetailRequest");prompts.hide();Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onException:function(){Affinity.leave.unlockui("leaveDetail-leaveDetailRequest")},onCancel:function(){Affinity.leave.unlockui("leaveDetail-leaveDetailRequest")},onSuccess:function(n){Affinity.leave.unlockui("leaveDetail-leaveDetailRequest");Affinity.leave.isErrorInJson(n,this._api,this._methodName)||(this.data=n.Data,this.timeLastModified=this.data.LeaveHeader.TimeLastModified?Date.parse(this.data.LeaveHeader.TimeLastModified):null,this.requireUpdate=!1,this.viewDetail(),prompts.hide())}.bind(this)});this.tryCreateActivityLogRequest=new Request.JSON({onSuccess:function(){}.bind(this)});this.updateUnitsRequest=new Request.JSON({method:"post",emulation:!1,headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("leaveDetail-updateUnitsRequest")},onFailure:function(n){Affinity.leave.unlockui("leaveDetail-updateUnitsRequest");Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onException:function(){Affinity.leave.unlockui("leaveDetail-updateUnitsRequest")},onCancel:function(){Affinity.leave.unlockui("leaveDetail-updateUnitsRequest")},onSuccess:function(n){if(Affinity.leave.unlockui("leaveDetail-updateUnitsRequest"),!Affinity.leave.isErrorInJson(n,this._api,this._methodName,!0)){var t=this.data.LeaveHeader.TimeLastModified?Date.parse(this.data.LeaveHeader.TimeLastModified):null;Affinity.leave.manager&&(this.requireUpdate=this.requireUpdate||n.RequireUpdate,!this.requireUpdate&&(!this.timeLastModified||t.getTime()>this.timeLastModified.getTime())&&(this.timeLastModified=t));this.data=n.Data;this.buildUnitsTotals(this.data.Components);this.createApproverBoxes(this.data.Components,this.positions);this.createEditableDates(this.data.LeaveHeader,this.data.Components,this.positions);Affinity.tooltips.processNew();this.isManager?Affinity.leave.manager.refreshAll():Affinity.leave.employee.refreshAll()}prompts.hide();this.errorChecking(n)}.bind(this)});this.isManager?(this.bossResponseRequest=new Request.JSON({headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("leaveDetail-bossResponseRequest")},onFailure:function(n){Affinity.leave.unlockui("leaveDetail-bossResponseRequest");Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this),onException:function(){Affinity.leave.unlockui("leaveDetail-bossResponseRequest")},onCancel:function(){Affinity.leave.unlockui("leaveDetail-bossResponseRequest")},onSuccess:function(n){if(Affinity.leave.unlockui("leaveDetail-bossResponseRequest"),prompts.hide(),Affinity.leave.isErrorInJson(n,this._api,this._methodName,!0))this.errorChecking(n);else{if(!n.Response){var t="Leave application";this.bossResponseRequest.isCancellation&&(t="Leave cancellation");n.Response=this._statusChange===3?t+" has been approved":t+" has been declined"}n.Messages.length>0&&n.Messages[0].Message!==undefined&&n.Messages[0].Message!==null&&n.Messages[0].Message.indexOf("position has changed")>-1?uialert({message:n.Messages[0].Message,showButtons:!0,noClose:!1}):(this.acknowledgementModal(n),Affinity.leave.manager.refreshAll())}}.bind(this)}),this.initializeSubmitLeaveRequest()):this.initializeSubmitLeaveRequest()},tryCreateAuditLogForImportedLeave:function(n,t){this._methodName="ui.leave.detail.js -> tryCreateAuditLogForImportedLeave ()";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"ActivityLog/"+n+"/"+t);this.tryCreateActivityLogRequest.url=this.tryCreateActivityLogRequest.options.url=this._api;this.tryCreateActivityLogRequest.post()},getDetail:function(n,t,i){if(uialert({message:"Loading Leave Detail",showLoader:!0,showButtons:!1,noClose:!1}),typeof i!="undefined"&&i!="undefined"&&i!=null){this._methodName="ui.leave.detail.js -> getDetail (with authId)";var r=Affinity.leave.apiroot+"LeaveDetail/"+n+"/"+t;i.AuthorisationId!=-1&&(r=r+"/"+i.AuthorisationId,this.authorisationId=i.AuthorisationId);this._api=Affinity.GetCacheSafePath(r);this.authorisation=i}else this._methodName="ui.leave.detail.js -> getDetail (without authId)",this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"LeaveDetail/"+n+"/"+t),this.authorisation=null;this.leaveDetailRequest&&this.leaveDetailRequest.isRunning()&&this.leaveDetailRequest.cancel();this.leaveDetailRequest.url=this.leaveDetailRequest.options.url=this._api;this.leaveDetailRequest.get();this.isManager&&Affinity.leave.manager.getManagerEmployeeConfig(n,function(){}.bind(this))},initializeSubmitLeaveRequest:function(){this.submitLeaveRequest=new Request.JSON({headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("leaveDetail-submitLeaveRequest")},onFailure:function(n){Affinity.leave.unlockui("leaveDetail-submitLeaveRequest");prompts.hide();Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this),onException:function(){Affinity.leave.unlockui("leaveDetail-submitLeaveRequest");prompts.hide()},onCancel:function(){Affinity.leave.unlockui("leaveDetail-submitLeaveRequest");prompts.hide()},onSuccess:function(n){Affinity.leave.unlockui("leaveDetail-submitLeaveRequest");prompts.hide();Affinity.leave.isErrorInJson(n,this._api,this._methodName,!0)||(this._onResponse&&this._onResponse(n),Affinity.leave.employee.refreshAll());this.errorChecking(n)}.bind(this)})},viewDetail:function(){var n=this.data.LeaveHeader,e=this.data.Components,p,u,f,d,g;Affinity.modal.show();Affinity.modal.clear();Affinity.modal.position();var a=new Element("div",{"class":"modal-dataV1"}),nt=new Element("div",{"class":"section"}).inject(a),t=new Element("div",{"class":"default-form"}).inject(nt),lt=new Element("div",{"class":"messages"}).inject(t);Affinity.login.profile.employeeNumber!==n.EmployeeNo&&(this.balanceBox=new Element("div").inject(t,"top"),this.balanceWidget=new EmployeeBalancesWidget({target:this.balanceBox,employeeId:n.EmployeeNo,filter:n.CodeDescription}));var tt=new Element("div",{"class":"form-row"}).inject(t),r=new Element("div",{"class":"details-date-range"}).inject(tt),o=new Element("div",{"class":"leave-date leave-start"}).adopt(new Element("div",{"class":"title",html:"First Day"}),new Element("div",{"class":"leave-date-picker"}).adopt(new Element("div",{"class":"day"}),new Element("div",{"class":"date"}),new Element("div",{"class":"month"}),new Element("div",{"class":"year"}))).inject(r),s=new Element("div",{"class":"leave-date leave-stop"}).adopt(new Element("div",{"class":"title",html:"Last Day"}),new Element("div",{"class":"leave-date-picker"}).adopt(new Element("div",{"class":"day"}),new Element("div",{"class":"date"}),new Element("div",{"class":"month"}),new Element("div",{"class":"year"}))).inject(r),it=new Element("div",{"class":"form-row"}).inject(t),v=new Element("div",{"class":"details-type-box"}).inject(it),at=new Element("label",{"class":"details-label",html:"Leave Type"}).inject(v),rt=new Element("div",{"class":"details-type"}).inject(v),ut=new Element("div",{"class":"form-row"}).inject(t),y=new Element("div",{"class":"details-reason-box"}).inject(ut),vt=new Element("label",{"class":"details-label",html:"Leave Reason"}).inject(y),ft=new Element("div",{"class":"details-reason"}).inject(y);this.unitForm=new Element("div",{"class":"form-row"}).inject(t);this.unitsBox=new Element("div",{"class":"details-positions-box"}).inject(this.unitForm);this.unitsLabel=new Element("label",{"class":"details-label",style:"display: block;",html:"Units"}).inject(this.unitsBox);this.totalUnitsSection=new Element("div",{"class":"total-units-box"}).inject(this.unitsBox);this.buildUnitsTotals(e);p=new Element("div",{"class":"details-approver-box"}).inject(this.unitsBox);this.partialApproved=!1;Array.each(e,function(n){var i=new Element("div",{"class":"details-position-approver"}).inject(p),r=new Element("span",{}).inject(i),t;n.Authorisation&&(n.Authorisation.ApprovedBy?r.set("html",n.Authorisation.ApprovedByName):r.set("html",n.Authorisation.SubmittedToName),this.data.LeaveHeader.StatusCode!=-1&&this.data.LeaveHeader.StatusCode!=6&&(t=new Element("span",{"class":"tickcross color"}).inject(i),n.Authorisation.StatusCode===3?(t.addClass("ui-has-tooltip").set("data-tooltip","Leave is approved"),t.addClass("icon-thumbs-up"),t.addClass("green"),this.partialApproved=!0):n.Authorisation.StatusCode===2?(t.addClass("red"),t.addClass("ui-has-tooltip").set("data-tooltip","Leave is declined"),t.addClass("icon-thumbs-down")):n.Authorisation.StatusCode===7?(t.addClass("ui-has-tooltip").set("data-tooltip","Leave cancellation is pending approval"),t.addClass("icon-cancel"),t.addClass("blue")):(t.addClass("ui-has-tooltip").set("data-tooltip","Leave is pending approval"),t.addClass("icon-hourglass"),t.addClass("blue"))))}.bind(this));this.units=new Element("div",{"class":"details-positions"}).inject(this.unitsBox);this.positionsLabels=new Element("div",{"class":"position-labels"}).inject(this.units);u=new Element("div",{"class":"unit-scroller-box"}).inject(this.units);f=new Element("div",{"class":"details-units-scroller"}).inject(u);this.createCommentReplyEdits(t,n);o.getElement(".day").set("html",Affinity.leave.cleanBadDate(n.DateFrom).format("%a"));o.getElement(".date").set("html",Affinity.leave.cleanBadDate(n.DateFrom).format("%e"));o.getElement(".month").set("html",Affinity.leave.cleanBadDate(n.DateFrom).format("%b"));o.getElement(".year").set("html",Affinity.leave.cleanBadDate(n.DateFrom).format("%Y"));s.getElement(".day").set("html",Affinity.leave.cleanBadDate(n.DateTo).format("%a"));s.getElement(".date").set("html",Affinity.leave.cleanBadDate(n.DateTo).format("%e"));s.getElement(".month").set("html",Affinity.leave.cleanBadDate(n.DateTo).format("%b"));s.getElement(".year").set("html",Affinity.leave.cleanBadDate(n.DateTo).format("%Y"));rt.set("html",n.CodeDescription);ft.set("html",n.ReasonDescription);for(var et=Affinity.leave.cleanBadDate(n.DateFrom),ot=Affinity.leave.cleanBadDate(n.DateTo),r=[],h=et.clone();h.lessThanOrEqualTo(ot);)r.push(h.clone()),h.increment("day",1);var c=0,l=new Element("div",{"class":"unit-grid"}).inject(f),st=new Element("div",{"class":"unit-gridheader"}).inject(l),w=new Element("div",{"class":"unit-gridbody"}).inject(l),i,b;if(Array.each(r,function(n){i=Affinity.leave.cleanBadDate(n);b=new Element("div",{"class":"day-class d-"+i.format("%d-%b-%y"),id:i.format("%d/%b/%y")}).inject(st);b.adopt(new Element("div",{"class":"day-class-day",html:i.format("%a")}),new Element("div",{"class":"day-class-date",html:i.format("%e")}),new Element("div",{"class":"day-class-my",html:i.format("%b '%y")}),new Element("div",{"class":"hol-icon icon-plane ui-has-tooltip"}));c+=79}),f.store("width",c),f.setStyle("width",c),this.data.Attachments.length>0){var ht=new Element("div",{"class":"form-row"}).inject(t),k=new Element("div",{"class":"details-attachments-box"}).inject(ht),yt=new Element("label",{"class":"details-label",html:"Attachments"}).inject(k),ct=new Element("ul",{"class":"details-attachments"}).inject(k);Array.each(this.data.Attachments,function(t){url=Affinity.leave.apiroot+"GetLeaveAttachment/"+n.EmployeeNo+"/"+n.TSGroupId+"/"+t.Id;var i=new Element("a",{href:url}).inject(ct),r=new Element("li",{"class":"details-attachment"}).inject(i);r.set("html",t.Name)})}n.StatusCode===7?this.createForwardingFeature(t):Affinity.login.profile.employeeNumber!==n.EmployeeNo&&this.populateForwardHistory(this.data.Forwards,t);this.createButtons(t,!1);Array.each(e,function(t){var f=new Element("div",{"class":"position-label"}).inject(this.positionsLabels),s=new Element("div",{"class":"position-title"}).inject(f),o,i,u;new Element("label",{html:t.PositionTitle,"class":"ui-has-tooltip","data-tooltip":t.PositionTitle,"data-tooltip-dir":"bottom"}).inject(s);i=new Element("div",{"class":"position-unit-label"}).inject(f);n.UnitType==="D"?(o=new Element("div",{"class":"positions-days",id:t.PositionCode}).inject(w),new Element("label",{html:"(Days)"}).inject(i)):new Element("label",{html:"(Hours)"}).inject(i);u=new Element("div",{"class":"positions-hours",id:t.PositionCode}).inject(w);n.UnitType==="D"&&u.addClass("hidden");Array.each(r,function(i){var r=Affinity.leave.cleanBadDate(i).format("%d/%b/%y"),s=new Element("span",{"class":"details-position-units fake-input",id:r,html:"0.00"}).inject(u),f=null;n.UnitType==="D"&&(f=new Element("span",{"class":"details-position-units fake-input",id:r,html:"0.00"}).inject(o));Array.each(e,function(i){i.PositionCode===t.PositionCode&&Array.each(i.Units,function(t){var i=Affinity.leave.cleanBadDate(t.Date).format("%d/%b/%y");r===i&&(s.set("html",t.HoursAppliedFor.toFixed(2)),n.UnitType==="D"&&f.set("html",t.DaysAppliedFor.toFixed(2)),typeOf(t.IsPublicHoliday)==="boolean"&&t.IsPublicHoliday===!0&&(s.addClass("public-holiday").addClass("ui-has-tooltip").set("data-tooltip",t.PublicHolidayName).set("data-tooltip-dir","bottom,center"),n.UnitType==="D"&&f.addClass("public-holiday").addClass("ui-has-tooltip").set("data-tooltip",t.PublicHolidayName).set("data-tooltip-dir","bottom,center"),l.getElement(".day-class.d-"+i.replace(/\//gi,"-")).addClass("public-holiday").getElement(".hol-icon").set("data-tooltip",t.PublicHolidayName).set("data-tooltip-dir","bottom,center")))})})})}.bind(this));Affinity.leave.populateLeaveActivity(t,n.EmployeeNo,n.TSGroupId);Affinity.modal.setElement(a);d=u.measure(function(){return this.getSize().x});g=f.measure(function(){return this.getScrollSize().x});g>d?u.setStyle("overflow-x","scroll"):u.setStyle("overflow-x","hidden");Affinity.tooltips.processNew()},editDetail:function(){this.isManager?Affinity.leave.manager&&Affinity.leave.manager.getManagerEmployeeConfig(this.data.LeaveHeader.EmployeeNo,function(n){n?this.doEditDetail(n):this.doEditDetail(Affinity.leave.manager.config)}.bind(this)):Affinity.leave.employee.config&&this.doEditDetail(Affinity.leave.employee.config)},createForwardingFeature:function(n){this.isManager&&(this.populateForwardHistory(this.data.Forwards,n),this.allowForwardToBasedFromLeaveInstance(this.data.LeaveHeader)&&(this.forwardSelector=new Element("div",{"class":"forward-to-selector form-row"}).inject(n),this.forwardsToLabel=new Element("label",{"class":"details-label",html:"Forward To"}).inject(this.forwardSelector),this.forwardTo=new Element("select",{"class":"details-forward-to ui-autocomplete"}).inject(this.forwardSelector),new Element("option",{html:"",id:null,value:""}).inject(this.forwardTo),Affinity.leave.manager.config&&typeOf(Affinity.leave.manager.config.ForwardToManagers)==="array"&&Affinity.leave.manager.config.ForwardToManagers.length>0&&Array.each(Affinity.leave.manager.config.ForwardToManagers,function(n){new Element("option",{html:n.EmployeeName+" ("+n.EmployeeNo+")",id:n.EmployeeNo,value:n.EmployeeNo}).inject(this.forwardTo)}.bind(this)),this.forwardReason=new Element("div",{"class":"forward-to-reason form-row hidden"}).inject(n),this.forwardReasonLabel=new Element("label",{"class":"details-label",html:"Forward Reason:"}).inject(this.forwardReason),this.forwardReasonText=new Element("textarea",{"class":"forward-reason-text data-hj-whitelist",rows:"3"}).inject(this.forwardReason)))},doEditDetail:function(n){var t=this.data.LeaveHeader,u=this.data.Components,v,i,f,e,o,r,l,a;Affinity.modal.show();Affinity.modal.clear();Affinity.modal.position();this.modalData=new Element("div",{"class":"modal-dataV1"});this.section=new Element("div",{"class":"section"}).inject(this.modalData);this.form=new Element("div",{"class":"default-form"}).inject(this.section);new Element("div",{"class":"leave-id hidden"}).inject(this.form).store("old",t.TSGroupId);v=new Element("div",{"class":"messages"}).inject(this.form);n&&(this.config=n,i=n.positions);this.isManager?(this.balanceBox=new Element("div",{"class":"leave-detail-balance"}).inject(this.form),this.balanceWidget=new EmployeeBalancesWidget({target:this.balanceBox,employeeId:t.EmployeeNo,filter:t.CodeDescription}),Affinity.leave.manager&&!i&&(i=u)):Affinity.leave.employee.config&&(i=Affinity.leave.employee.config.Positions);this.positions=i;t.PositionCode&&t.PositionCode!=""&&(i.map(function(n){n.PositionCode==t.PositionCode&&(f=n)}.bind(this)),f&&(i=[f]));this.dateRange=new Element("div",{"class":"details-date-range"}).inject(this.form);this.startDate=new Element("div",{"class":"leave-date leave-start"}).adopt(new Element("div",{"class":"title",html:"First Day"}),this.fromDateBox=new Element("div",{"class":"leave-date-picker selectable"}).adopt(new Element("div",{"class":"day"}),new Element("div",{"class":"date"}),new Element("div",{"class":"month"}),new Element("div",{"class":"year"}))).inject(this.dateRange);this.stopDate=new Element("div",{"class":"leave-date leave-stop"}).adopt(new Element("div",{"class":"title",html:"Last Day"}),this.toDateBox=new Element("div",{"class":"leave-date-picker selectable"}).adopt(new Element("div",{"class":"day"}),new Element("div",{"class":"date"}),new Element("div",{"class":"month"}),new Element("div",{"class":"year"}))).inject(this.dateRange);e=Affinity.leave.cleanBadDate(t.DateFrom);o=Affinity.leave.cleanBadDate(t.DateTo);new Element("div",{"class":"old-startDate hidden"}).inject(this.form).store("old",t.DateFrom);new Element("div",{"class":"old-endDate hidden"}).inject(this.form).store("old",t.DateTo);new Element("div",{"class":"globalDateRange hidden"}).inject(this.form);var s=new Element("div",{"class":"hidden"}).inject(this.dateRange,"top"),y=new Element("div",{"class":"from-selector"}).inject(s),p=new Element("div",{"class":"to-selector"}).inject(s),h=new Element("input",{type:"text",id:"detail-date-from","class":"data-hj-whitelist"}).inject(y),c=new Element("input",{type:"text",id:"detail-date-to","class":"data-hj-whitelist"}).inject(p);this.fromDateWidget=new UIDateTimeWidget({outputFormat:"%d.%m.%Y",displayFormat:"%a %e %b %Y",showCalendar:!0,showTime:!1,startDate:e.clone(),labelName:"",postId:"",postName:"",validationMethods:"",validationErrorStr:"",target:h,cssPosition:"fixed"});this.modalEls={};this.modalEls.fromDateWidget=this.fromDateWidget;this.modalEls.fromDateBox=this.fromDateBox;this.modalEls.fromDateHidden=h;this.modalEls.fromDateOld=e.clone();this.fromDateWidget.positionOverride=this.startDate;this.fromDateWidget.addEvent("dateClicked",function(){var t=this.modalEls.fromDateOld.format("%d-%b-%y"),n;this.setStartDate()?(n=this.fromDateWidget.getRawDate().format("%d-%b-%y"),this.updateDate("DateFrom",n,t,i),this.modalEls.fromDateOld=this.fromDateWidget.getRawDate()):this.fromDateWidget.setDate(this.modalEls.fromDateOld)}.bind(this));this.toDateWidget=new UIDateTimeWidget({outputFormat:"%d.%m.%Y",displayFormat:"%a %e %b %Y",showCalendar:!0,showTime:!1,startDate:o.clone(),labelName:"",postId:"",postName:"",validationMethods:"",validationErrorStr:"",target:c,cssPosition:"fixed"});this.modalEls.toDateWidget=this.toDateWidget;this.modalEls.toDateBox=this.toDateBox;this.modalEls.toDateHidden=c;this.modalEls.toDateOld=o.clone();this.toDateWidget.positionOverride=this.stopDate;this.toDateWidget.addEvent("dateClicked",function(){var t=this.modalEls.toDateOld.format("%d-%b-%y"),n;this.setEndDate()?(n=this.toDateWidget.getRawDate().format("%d-%b-%y"),this.updateDate("DateTo",n,t,i),this.modalEls.toDateOld=this.toDateWidget.getRawDate()):this.toDateWidget.setDate(this.modalEls.toDateOld)}.bind(this));this.startDate.addEvent("click",function(n){this.fromDateWidget.externalShow(n)}.bind(this));this.stopDate.addEvent("click",function(n){this.toDateWidget.externalShow(n)}.bind(this));this.setStartDate();this.setEndDate();this.typeForm=new Element("div",{"class":"form-row"}).inject(this.form);this.typeBox=new Element("div",{"class":"details-type-box"}).inject(this.typeForm);this.typeLabel=new Element("label",{"class":"details-label",html:"Leave Type"}).inject(this.typeBox);this.typeSelector=new Element("select",{"class":"edit-type-selector"}).inject(this.typeBox);this.typeSelector.addEvent("change",function(){var n=this.typeSelector.getElement("option:selected").get("id");this.update("LeaveCode",n,this.data.LeaveHeader.LeaveCode,t.EmployeeNo,t.TSGroupId,this.data.LeaveHeader.TimeLastModified,function(n){var u,t,i,r;if(n!=null&&n!=="error")this.newLeaveReason(Affinity.leave.employee.config,this.typeSelector.selectedIndex),this.reasonSelector.selectedIndex=0,this.data&&(this.data.LeaveHeader.LeaveCode=n.LeaveHeader.leaveCode,this.data.LeaveHeader.ReasonCode=null,this.data.LeaveHeader.TimeLastModified=n.LeaveHeader.TimeLastModified,this.createEditableDates(this.data.LeaveHeader,this.data.Components,this.positions));else if(n==="error"){for(u="Something's stopping the Leave Type field from updating. Check your selection then try again.<br /><br />",uialert({message:u,okText:"Close",showButtons:!0,noClose:!1}),t=-1,i=0;i<this.typeSelector.getElements("option").length;i++)if(r=this.typeSelector.getElements("option")[i],r.id===this.data.LeaveHeader.LeaveCode){t=r.index;break}t!=-1&&(this.typeSelector.selectedIndex=t)}}.bind(this),function(n,t){var r,i;if(n==="LeaveCode")for(r=-1,i=0;i<this.typeSelector.length;i++)t===this.typeSelector[i].id&&(r=i),this.typeSelector.selectedIndex=r}.bind(this))}.bind(this));this.reasonForm=new Element("div",{"class":"form-row"}).inject(this.form);this.reasonBox=new Element("div",{"class":"details-reason-box"}).inject(this.reasonForm);this.reasonLabel=new Element("label",{"class":"details-label",html:"Leave Reason"}).inject(this.reasonBox);r=null;r=n.LeaveCodes;Array.each(r,function(n,i){var u=new Element("option",{value:parseInt(i)}).inject(this.typeSelector),f;u.set("html",n.Description);u.set("id",n.LeaveCode);n.LeaveCode===t.LeaveCode&&(this.typeSelector.selectedIndex=i,this.reasonSelector=new Element("select",{"class":"edit-reason-selector"}).inject(this.reasonBox),new Element("option",{value:"",id:"null",html:""}).inject(this.reasonSelector,"top"),this.reasonSelector.addEvent("change",function(){var n=this.reasonSelector.getElement("option:selected").get("id");this.update("ReasonCode",n,this.data.LeaveHeader.ReasonCode,t.EmployeeNo,t.TSGroupId,this.data.LeaveHeader.TimeLastModified,function(n){var u,t,i,r;if(this.data&&n!=="error")this.data.LeaveHeader.ReasonCode=n.LeaveHeader.ReasonCode,this.data.LeaveHeader.TimeLastModified=n.LeaveHeader.TimeLastModified;else if(n==="error"){for(u="Something's stopping the Leave Reason field from updating. Check your selection then try again.<br /><br />",uialert({message:u,okText:"Close",showButtons:!0,noClose:!1}),t=-1,i=0;i<this.reasonSelector.getElements("option").length;i++)if(r=this.reasonSelector.getElements("option")[i],r.id===this.data.LeaveHeader.ReasonCode){t=r.index;break}t!=-1&&(this.reasonSelector.selectedIndex=t)}}.bind(this))}.bind(this)),typeof r[this.typeSelector.selectedIndex]!="undefined"&&r[this.typeSelector.selectedIndex].Reasons&&(f=r[this.typeSelector.selectedIndex].Reasons,Array.each(f,function(n,i){var r=new Element("option",{value:i}).inject(this.reasonSelector);r.set("html",n.Description);r.set("id",n.ReasonCode);n.ReasonCode===t.ReasonCode&&(this.reasonSelector.selectedIndex=i+1)}.bind(this))))}.bind(this));this.unitForm=new Element("div",{"class":"form-row"}).inject(this.form);this.unitsBox=new Element("div",{"class":"details-positions-box"}).inject(this.unitForm);this.unitsLabel=new Element("label",{"class":"details-label",style:"display: block;",html:"Units"}).inject(this.unitsBox);this.totalUnitsSection=new Element("div",{"class":"total-units-box"}).inject(this.unitsBox);this.buildUnitsTotals(u);this.approverBox=new Element("div",{"class":"detail-approver-box"}).inject(this.unitsBox);this.createApproverBoxes(u,i);this.units=new Element("div",{"class":"details-positions"}).inject(this.unitsBox,"bottom");this.rebuildUnits=function(){this.buildUnitsTotals(this.data.Components);this.createEditableDates(this.data.LeaveHeader,this.data.Components,this.positions);Affinity.tooltips.processNew()}.bind(this);this.unitsEdit=new InputEditWidget({target:this.units,updateInput:this.updateUnits,cancelInput:this.rebuildUnits});this.positionsLabels=new Element("div",{"class":"position-labels"}).inject(this.units);this.scrollerBox=new Element("div",{"class":"unit-scroller-box"}).inject(this.units);this.scroller=new Element("div",{"class":"details-units-scroller"}).inject(this.scrollerBox);this.createCommentReplyEdits(this.form,t);this.attachmentform=new Element("div",{"class":"form-row"}).inject(this.form);this.attachWidgetDiv=new Element("div",{"class":"uploadmulti print-hidden","data-question-name":"docs"}).adopt(this.attachWidgetInput=new Element("input",{type:"file"}),new Element("input",{hidden:"file","class":"initialValues"}));this.attachmentbox=new Element("div",{"class":"edit-leave-attachment"}).adopt(new Element("label",{"class":"details-label",html:"Attachments"}),this.attachWidgetDiv).inject(this.attachmentform);this.attachWidgetDiv.addEvent("multiFileDeleted",this.deleteAttachment);this.attachWidgetDiv.addEvent("multiFileAdded",this.postAttachments);this.attachWidgetDiv.addEvent("validateMultiFileDelete",this.validateFileDeletion);window.addEvent("multiFileDeletedFromConfirmation",this.deleteAttachment);window.addEvent("attachmentRequired",this.setAttachmentRequiredValue);window.addEvent("leaveEditDetailCloses",this.validateBeforeClosingModal);Affinity.modal.beforeClose=function(){this.attachWidgetDiv&&(this.attachWidgetDiv.removeEvent("multiFileDeleted",this.deleteAttachment),this.attachWidgetDiv.removeEvent("multiFileAdded",this.postAttachments),this.attachWidgetDiv.removeEvent("validateMultiFileDelete",this.validateFileDeletion),window.removeEvent("multiFileDeletedFromConfirmation",this.deleteAttachment),window.removeEvent("attachmentRequired",this.setAttachmentRequiredValue),window.removeEvent("leaveEditDetailCloses",this.validateBeforeClosingModal));this.fromDateWidget&&this.fromDateWidget.removeEvents();this.toDateWidget&&this.toDateWidget.removeEvents();this.startDate&&this.startDate.removeEvents();this.toDate&&this.toDate.removeEvents();this.typeSelector&&this.typeSelector.removeEvents();this.reasonSelector&&this.reasonSelector.removeEvents();this.approverSelector&&this.approverSelector.removeEvents();this.reply&&this.reply.removeEvents();this.comments&&this.comments.removeEvents();this.forward&&this.forward.removeEvents();this.forwardTo&&this.forwardTo.removeEvents();this.acceptButton&&this.acceptButton.removeEvents();this.declineButton&&this.declineButton.removeEvents();this.submitButton&&this.submitButton.removeEvents();this.deleteButton&&this.deleteButton.removeEvents();this.closeButton&&this.closeButton.removeEvents();this.editButton&&this.editButton.removeEvents();window.removeEvents("UpdateLeaveSuccess");window.removeEvents("DeleteLeaveUnitSuccess");window.removeEvents("CreateMissingLeaveUnitsSuccess");Affinity.modal.beforeClose=null;delete Affinity.modal.beforeClose}.bind(this);this.createForwardingFeature(this.form);this.createButtons(this.form,!0);Affinity.leave.populateLeaveActivity(this.form,t.EmployeeNo,t.TSGroupId);this.createEditableDates(t,u,i);Affinity.modal.setElement(this.modalData);this.attachWidget=new UIUplaodersMulti({maxsize:20963328});this.attachWidget.addEvent("multiFileTooLarge",this.fileTooLarge);Affinity.leave.populateAttachments(t,this.data.Attachments,this.attachWidget,this.attachWidgetDiv);l=this.scrollerBox.measure(function(){return this.getSize().x});a=this.scroller.measure(function(){return this.getScrollSize().x});a>l?this.scrollerBox.setStyle("overflow-x","scroll"):this.scrollerBox.setStyle("overflow-x","hidden");Affinity.tooltips.processNew()},fileTooLarge:function(n){var t=(n.maxsize/1048576).round(2),i=(n.size/1048576).round(2);window.uialert({message:"You can only attach a document that is less than 20MB in size. Please try again."})},getLeaveStatusWhereForwardToIsNotAllowed:function(){return[3,2,6]},allowForwardToBasedFromLeaveInstance:function(n){var t=!1,i=this.getLeaveStatusWhereForwardToIsNotAllowed();return n!==undefined&&n.StatusCode!==undefined&&i.indexOf(n.StatusCode)===-1&&(t=!0),t},createButtons:function(n,t){var i="";this.data.LeaveHeader.StatusCode===7?i="Leave Cancellation":this.data.LeaveHeader.StatusCode===0&&(i="Leave Request");this.buttons=new Element("div",{"class":"form-row"}).inject(n);this.buttonsBoxContainer=new Element("div",{"class":"details-comments-box"}).inject(this.buttons);this.buttonsLabelBox=new Element("label",{"class":"details-label",html:i}).inject(this.buttonsBoxContainer);this.buttonsBox=new Element("div",{"class":"details-buttons-box"}).inject(this.buttonsBoxContainer);this.data.LeaveHeader.isExternal||(this.isManager?((t||this.data.LeaveHeader.StatusCode===7)&&this.allowForwardToBasedFromLeaveInstance(this.data.LeaveHeader)&&(this.forward=new Element("span",{"class":"button blue hidden w-icon-only"}).adopt(new Element("span",{html:Affinity.icons.Forward}),new Element("span",{html:"Forward"})).inject(this.buttonsBox),this.forwardTo.value!==""&&(this.forward.removeClass("hidden"),this.forwardReason.removeClass("hidden")),this.forwardTo.addEvent("change",function(n){n.target.value===""?(this.forward.addClass("hidden"),this.forwardReason.addClass("hidden")):(this.forward.removeClass("hidden"),this.forwardReason.removeClass("hidden"))}.bind(this)),this.forward.addEvent("click",function(){var r=this.forwardTo.selectedIndex,u=this.forwardTo[r],f=u.get("id"),t={ForwardedTo:f,AuthorisationId:this.data.Components[0].Authorisation.AuthorisationId,Comment:this.forwardReasonText.get("value")};if(t.ForwardedTo===""){uialert({message:"Please select someone to forward to"});return}var e=this.data.LeaveHeader.EmployeeNo,o=this.data.LeaveHeader.TSGroupId,i="leave.detail.js -> createButtons (forward on click)",n=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"LeaveForwarding/"+e+"/"+o);new Request.JSON({url:n,headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("teamleave-forward")},onFailure:function(t){Affinity.leave.unlockui("teamleave-forward");Affinity.leave.handleXHRErrors(t,n,i)},onException:function(){Affinity.leave.unlockui("teamleave-forward")},onCancel:function(){Affinity.leave.unlockui("teamleave-forward")},onSuccess:function(t){Affinity.leave.unlockui("teamleave-forward");Affinity.modal.hide();Affinity.leave.isErrorInJson(t,n,i)||Affinity.leave.manager.refreshAll()}.bind(this)}).post(JSON.stringify(t))}.bind(this))),this.data.LeaveHeader.StatusCode!==-1&&(this.acceptButton=new Element("span",{"class":"button green w-icon-only"}).adopt(new Element("span",{html:Affinity.icons.ThumbsUp}),new Element("span",{html:"Approve"})).inject(this.buttonsBox),this.acceptButton.addEvent("click",function(){if(this.validateAttachmentRequirement()){var n=this.data.LeaveHeader.TSGroupId,t=this.data.LeaveHeader.EmployeeNo;this.requireUpdate?uialert({message:"Oops! This leave application has been changed by someone else, please reload.",showButtons:!0,noClose:!1,showLoader:!1}):this.totalUnitsUnits.get("html")==0?uialert({message:"Oops! There are no hours to approve for this leave.",showButtons:!0,noClose:!1,showLoader:!1}):this.bossResponse(t,n,this.authorisation.StatusCode,3,this.authorisation.AuthorisationId,this.data.LeaveHeader.TimeLastModified)}else this.displayAttachmentRequiredModalMessage()}.bind(this)),this.data.LeaveHeader.StatusCode!==6&&(this.declineButton=new Element("span",{"class":"button red w-icon-only"}).adopt(new Element("span",{html:Affinity.icons.ThumbsDown}),new Element("span",{html:"Decline"})).inject(this.buttonsBox),this.declineButton.addEvent("click",function(){window.fireEvent("attachmentRequired",!1);var n=this.data.LeaveHeader.TSGroupId,t=this.data.LeaveHeader.EmployeeNo;this.requireUpdate?uialert({message:"Oops! This leave application has been changed by someone else, please reload.",showButtons:!0,noClose:!1,showLoader:!1}):this.bossResponse(t,n,this.authorisation.StatusCode,2,this.authorisation.AuthorisationId,this.data.LeaveHeader.timeLastModified)}.bind(this))),this.data.LeaveHeader.StatusCode===6&&(this.submitButton=new Element("span",{"class":"button green w-icon-only"}).adopt(new Element("span",{html:Affinity.icons.Plane}),new Element("span",{html:"Submit"})).inject(this.buttonsBox),this.submitButton.addEvent(Affinity.events.click,function(){this.validateAttachmentRequirement()?this.submitLeave(this.data.LeaveHeader.TSGroupId,0,this.data.LeaveHeader.StatusCode,function(n){n.Response!=null&&n.Response.indexOf("position has changed since")!==-1?uialert({message:n.Response,showButtons:!0,noClose:!1}):this.acknowledgementModal(n,"Your leave has been submitted")}.bind(this)):this.displayAttachmentRequiredModalMessage()}.bind(this))))):((this.data.LeaveHeader.StatusCode===-1||this.data.LeaveHeader.StatusCode===6)&&(this.submitButton=new Element("span",{"class":"button green w-icon-only"}).adopt(new Element("span",{html:Affinity.icons.Plane}),new Element("span",{html:"Submit"})).inject(this.buttonsBox),this.submitButton.addEvent(Affinity.events.click,function(){this.validateAttachmentRequirement()?this.submitLeave(this.data.LeaveHeader.TSGroupId,0,this.data.LeaveHeader.StatusCode,function(n){n.Response!=null&&n.Response.indexOf("position has changed since")!==-1?uialert({message:n.Response,showButtons:!0,noClose:!1}):this.acknowledgementModal(n,"Your leave has been submitted")}.bind(this)):this.displayAttachmentRequiredModalMessage()}.bind(this))),this.data.LeaveHeader.StatusCode===-1?(this.deleteButton=new Element("button",{"class":"red detail-delete-button w-icon-only"}).adopt(new Element("span",{html:Affinity.icons.Trash}),new Element("span",{html:"Delete"})).inject(this.buttonsBox),this.deleteButton.addEvent(Affinity.events.click,function(){this.deleteLeave(this.data.LeaveHeader.EmployeeNo,this.data.LeaveHeader.TSGroupId);Affinity.modal.closeButtonCloser()}.bind(this))):(this.data.LeaveHeader.StatusCode===0||this.data.LeaveHeader.StatusCode===2||this.data.LeaveHeader.StatusCode===3)&&(this.cancelButton=new Element("span",{"class":"button red w-icon-only"}).adopt(new Element("span",{html:Affinity.icons.Cancel}),new Element("span",{html:"Cancel Leave"})).inject(this.buttonsBox),this.cancelButton.addEvent(Affinity.events.click,function(){this.data.LeaveHeader.StatusCode==2?(window.fireEvent("attachmentRequired",!1),this.doLeaveCancellation()):uialert({message:"Are you sure you want to cancel your leave?",showButtons:!0,showCancel:!0,okText:"Yes",cancelText:"No",onOk:function(){window.fireEvent("attachmentRequired",!1);this.doLeaveCancellation()}.bind(this)})}.bind(this)))),t||this.data.LeaveHeader.StatusCode==7&&this.data.LeaveHeader.StatusCode!=0||(this.editButton=new Element("button",{"class":"blue details-edit-leave-button w-icon-only"}).adopt(new Element("span",{html:Affinity.icons.Pencil}),new Element("span",{html:"Edit"})).inject(this.buttonsBox),this.editButton.addEvent("click",function(){var n=function(n){(n!==null&&n.Data!==null||n===null)&&(this.data.LeaveHeader.StatusCode=6,this.editDetail())}.bind(this),i=function(){this.editDetail()}.bind(this),t=function(){this.isManager||this.data.LeaveHeader.StatusCode!=3?!this.isManager&&this.partialApproved&&uialert({message:"This Leave Application is partially approved. <br /> Do you want to cancel it to make it editable?",showButtons:!0,showCancel:!0,okText:"Yes - Cancel and Edit",okIcon:Affinity.icons.Plane,onOk:function(){this.submitLeave(this.data.LeaveHeader.TSGroupId,6,0,n)}.bind(this),onCancel:function(){}}):uialert({message:"Approved/paid leave must first be cancelled before you can update it. Continue?",showButtons:!0,showCancel:!0,okText:"Yes",cancelText:"No",onOk:function(){this.submitLeave(this.data.LeaveHeader.TSGroupId,6,3,n)}.bind(this),onCancel:function(){}})}.bind(this);this.isManager||this.data.LeaveHeader.StatusCode!=3?!this.isManager&&this.partialApproved?Affinity.leave.doPositionUpdateOrValidation(this.data.LeaveHeader.TSGroupId,t,null):Affinity.leave.doPositionUpdateOrValidation(this.data.LeaveHeader.TSGroupId,i,null):Affinity.leave.doPositionUpdateOrValidation(this.data.LeaveHeader.TSGroupId,t,null)}.bind(this))));this.closeButton=new Element("button",{"class":"grey details-close-leave-button w-icon-only"}).adopt(new Element("span",{html:Affinity.icons.Cross}),new Element("span",{html:"Close"})).inject(this.buttonsBox);this.closeButton.addEvent("click",function(){Affinity.modal.closeButtonCloser()}.bind(this))},doLeaveCancellation:function(){this.submitLeave(this.data.LeaveHeader.TSGroupId,6,this.data.LeaveHeader.statusCode,function(n){n.Data!==null?n.Data.LeaveHeader.StatusCode==6?this.acknowledgementModal(n,"Your leave has been cancelled"):n.Data.LeaveHeader.StatusCode==7&&this.acknowledgementModal(n,"Leave cancellation has been requested"):n.Messages[0].length>0&&n.Messages[0].Message!==null&&n.Messages[0].Message!==undefined&&n.Messages[0].Message.indexOf("position has changed")>-1&&uialert({message:n.Messages[0].Message,showButtons:!0,noClose:!1})}.bind(this))},createCommentReplyEdits:function(n,t){this.commentForm=null;this.replyForm=null;(!this.isManager||t.Comment)&&(this.commentForm=new Element("div",{"class":"form-row"}),this.commentsBox=new Element("div",{"class":"details-comments-box"}).inject(this.commentForm),this.commentsLabel=new Element("label",{"class":"details-label",html:"Comments"}).inject(this.commentsBox));(this.isManager||t.Reply)&&(this.replyForm=new Element("div",{"class":"form-row"}),this.replyBox=new Element("div",{"class":"details-comments-box"}).inject(this.replyForm),this.replyLabel=new Element("label",{"class":"details-label",html:"Manager Comments"}).inject(this.replyBox));this.isManager?(this.commentForm&&(this.comments=new Element("div",{"class":"details-comments",html:t.Comment}).inject(this.commentsBox)),this.reply=new Element("textarea",{"class":"edit-reply data-hj-whitelist",rows:"4",html:t.Reply}).inject(this.replyBox),this.replyEdit=new InputEditWidget({target:this.replyBox,input:this.reply,updateInput:function(){var n=this.reply.value;n!=this.data.LeaveHeader.Reply&&this.update("Reply",n,this.data.LeaveHeader.Reply,t.EmployeeNo,t.TSGroupId,this.data.LeaveHeader.TimeLastModified,function(n){this.data&&(this.data.LeaveHeader.Reply=n.LeaveHeader.Reply,this.data.LeaveHeader.TimeLastModified=n.LeaveHeader.TimeLastModified)}.bind(this))}.bind(this),cancelInput:function(){this.reply.set("value",t.Reply)}.bind(this)})):(this.replyForm&&(this.reply=new Element("div",{"class":"details-comments",html:t.Reply}).inject(this.replyBox)),this.comments=new Element("textarea",{"class":"edit-comments data-hj-whitelist",rows:"4",html:t.Comment}).inject(this.commentsBox),this.replyEdit=new InputEditWidget({target:this.commentsBox,input:this.comments,updateInput:function(){var n=this.comments.value;n!=this.data.LeaveHeader.Comment&&this.update("Comment",n,this.data.LeaveHeader.Comment,t.EmployeeNo,t.TSGroupId,this.data.LeaveHeader.TimeLastModified,function(n){if(this.data&&n!=="error")this.data.LeaveHeader.Comment=n.LeaveHeader.Comment,this.data.LeaveHeader.TimeLastModified=n.LeaveHeader.TimeLastModified;else if(n==="error")uialert({message:"Something's stopping the Comment field from updating. Try again.<br /><br />",okText:"Close",showButtons:!0,noClose:!1}),this.comments.value=this.data.LeaveHeader.Comment}.bind(this))}.bind(this),cancelInput:function(){this.comments.set("value",t.Comment)}.bind(this)}));this.commentForm&&this.commentForm.inject(n);this.replyForm&&this.replyForm.inject(n)},buildUnitsTotals:function(n){var r,i,t;this.totalUnitsSection&&this.totalUnitsSection.empty();r=n.length>1;i="display:none";r&&(i="display:block");t=0;Array.each(n,function(n){var r=new Element("div",{"class":"position-units-box",style:i}).inject(this.totalUnitsSection),u=new Element("span",{"class":"position-name ui-has-tooltip",html:n.PositionTitle+": ","data-tooltip":n.PositionTitle,"data-tooltip-dir":"bottom"}).inject(r),f=new Element("span",{"class":"position-units",html:n.TotalUnits.toFixed(2),id:n.PositionCode}).store("units",n.TotalUnits).inject(r);t+=n.TotalUnits}.bind(this));this.totalUnits=new Element("div",{"class":"total-units"}).inject(this.totalUnitsSection,"bottom");this.totalUnitsName=new Element("span",{"class":"total-units-name",html:"Total: "}).inject(this.totalUnits);this.totalUnitsUnits=new Element("span",{"class":"total-units-units",html:t.toFixed(2)}).inject(this.totalUnits);this.totalUnitsUnits.store("total",t)},createEditableDates:function(n,t,i){for(var tt=Affinity.leave.cleanBadDate(n.DateFrom),it=Affinity.leave.cleanBadDate(n.DateTo),l=[],o=new Date(tt),b,s,a,k,r,e,d,v,y,p,w,h,u,c,f,g,nt;o<=it;)l.push(new Date(o)),o=new Date(o.setDate(o.getDate()+1));b=this.units.querySelectorAll(".edit-position-hours, .edit-position-days");Array.each(b,function(n){var t=n.retrieve("validation");t&&(t.destroy(),n.eliminate("validation"))}.bind(this));s=0;this.gridBody&&this.gridBody.removeEvents();this.scroller.empty();this.positionsLabels.empty();a=new Element("div",{"class":"unit-grid"}).inject(this.scroller);k=new Element("div",{"class":"unit-gridheader"}).inject(a);this.gridBody=new Element("div",{"class":"unit-gridbody"}).inject(a);r=!1;Array.each(this.config.LeaveCodes,function(t){n.LeaveCode==t.LeaveCode&&t.CanEditByDays!=undefined&&(r=!t.CanEditByDays)});r||this.unitsEdit.attachToInput(this.gridBody);Array.each(l,function(n){e=Affinity.leave.cleanBadDate(n);d=new Element("div",{"class":"day-class d-"+e.format("%d-%b-%y"),id:e.format("%d/%b/%y")}).inject(k);d.adopt(new Element("div",{"class":"day-class-day",html:e.format("%a")}),new Element("div",{"class":"day-class-date",html:e.format("%e")}),new Element("div",{"class":"day-class-my",html:e.format("%b '%y")}),new Element("div",{"class":"hol-icon icon-plane ui-has-tooltip"}));s+=79});this.scroller.store("width",s);this.scroller.setStyle("width",s);c=!0;f=[];u=null;Array.each(t,function(n){f.length===0?f.push(n.positionCode):f.length>0&&f.indexOf(n.positionCode)<0&&f.push(n.positionCode)});f.length===1&&i.length==1&&(c=!1);Array.each(i,function(i){var e=new Element("div",{"class":"position-label"}).inject(this.positionsLabels),s=new Element("div",{"class":"position-title"}).inject(e),o,f;new Element("label",{html:i.PositionTitle,"class":"ui-has-tooltip","data-tooltip":i.PositionTitle,"data-tooltip-dir":"bottom"}).inject(s);f=new Element("div",{"class":"position-unit-label"}).inject(e);n.UnitType==="D"?(o=new Element("div",{"class":"positions-days",id:i.PositionCode}).inject(this.gridBody),new Element("label",{html:"(Days)"}).inject(f)):new Element("label",{html:"(Hours)"}).inject(f);v=new Element("div",{"class":"positions-hours",id:i.PositionCode}).inject(this.gridBody);n.UnitType==="D"&&v.addClass("hidden");u=null;Array.each(t,function(n){(n.PositionCode===i.PositionCode&&c||!c)&&(u=n)});u&&Array.each(l,function(t){h=Affinity.leave.cleanBadDate(t).format("%d/%b/%y");p=new Element("input",{"class":"edit-position-hours data-hj-whitelist",id:h,value:"0.00"}).inject(v);p.readOnly=r;n.UnitType==="D"&&(w=new Element("input",{"class":"edit-position-days data-hj-whitelist",id:h,value:"0.00"}).inject(o),w.readOnly=r),function(i,f){var e=0;Array.each(u.Units,function(o){var s,c;y=Affinity.leave.cleanBadDate(o.Date).format("%d/%b/%y");h===y&&(e=o.MaxHours,s=0,typeOf(o.HoursAppliedFor)==="number"&&(s=o.HoursAppliedFor.toFixed(2)),i.store("old",s),i.store("init",s),i.set("value",s),r||this.setUnitInputEvents(i,null,t,u,o,"H"),n.UnitType==="D"&&(c=0,typeOf(o.DaysAppliedFor)==="number"&&(c=o.DaysAppliedFor.toFixed(2)),f.store("old",c),f.store("init",c),f.set("value",c),r||this.setUnitInputEvents(f,i,t,u,o,"D")),typeOf(o.IsPublicHoliday)==="boolean"&&o.IsPublicHoliday===!0&&(i.addClass("public-holiday").addClass("ui-has-tooltip").set("data-tooltip",o.PublicHolidayName).set("data-tooltip-dir","bottom,center"),i.getParent(".unit-grid").getElement(".day-class.d-"+y.replace(/\//gi,"-")).addClass("public-holiday").getElement(".hol-icon").set("data-tooltip",o.PublicHolidayName).set("data-tooltip-dir","bottom,center")))}.bind(this))}.bind(this)(p,w)}.bind(this))}.bind(this));g=this.scrollerBox.measure(function(){return this.getSize().x});nt=this.scroller.measure(function(){return this.getScrollSize().x});nt>g?this.scrollerBox.setStyle("overflow-x","scroll"):this.scrollerBox.setStyle("overflow-x","hidden")},setUnitInputEvents:function(n,t,i,r,u,f){n.addEvent("blur",function(n){n.target.value=Affinity.leave.cleanUnit(n.target.value,n.target.retrieve("initial-value"))}.bind(this));n.addEvent("change",function(){var l,a,s,h,e,c,o;n.removeClass("error-border");e=n.retrieve("validation");e&&(e.destroy(),n.eliminate("validation"));l=!0;a=this.units.querySelectorAll(".edit-position-hours, .edit-position-days");Array.each(a,function(n){if(n.retrieve("validation")){l=!1;return}}.bind(this));l&&(this.acceptButton&&(this.acceptButton.set("disabled",null),this.acceptButton.removeClass("disabled")),this.declineButton&&(this.declineButton.set("disabled",null),this.declineButton.removeClass("disabled")),this.unitsEdit&&this.unitsEdit.enableSave());s=24;h="";f==="H"?(s=u.MaxHours,h=" hours"):f==="D"&&(s=u.MaxHours>0?1:0,h=" day");n.value>s?(n.addClass("error-border"),this.acceptButton&&(this.acceptButton.set("disabled","disabled"),this.acceptButton.addClass("disabled")),this.declineButton&&(this.declineButton.set("disabled","disabled"),this.declineButton.addClass("disabled")),this.unitsEdit&&this.unitsEdit.disableSave(),e=new Element("div",{"class":"form-row unit-validation"}).adopt(new Element("span",{"class":"icon-warning"}),new Element("span",{html:"Please enter a value up to "+s+" "+h+" on "+Affinity.leave.cleanBadDate(i).format("%d/%b/%y")+" for "+r.PositionTitle+"."})),this.units.adopt(e),n.store("validation",e)):(c=n.value===""?0:parseFloat(n.value),this.updateTotals(c,n.retrieve("old"),r.PositionCode),n.store("old",c),t&&(o=u.HoursWorkScheduled,(!o||o<=0)&&(o=u.HoursStandard),o>0&&t.set("value",(c*o).toFixed(2))))}.bind(this))},updateTotals:function(n,t,i){if(document.id("uimodal")&&document.id("uimodal").style.visibility!="hidden"){var a=document.getElements(".position-units"),u=document.getElement(".total-units-units"),s=Math.abs(n-t),o,r,h,f,e,c,l;Array.each(a,function(a){a.get("id")===i&&(n>t?(o=a.retrieve("units"),r=o+s,a.set("html",r.toFixed(2)),a.store("units",r),h=u.retrieve("total"),f=h+s,u.set("html",f.toFixed(2)),u.store("total",f)):(o=a.retrieve("units"),r=o-s,a.set("html",r.toFixed(2)),a.store("units",r),h=u.retrieve("total"),f=h-s,u.set("html",f.toFixed(2)),u.store("total",f)),r==0&&o!=0&&(a.getParent().destroy(),e=!1,c=document.getElements(".details-positions-box .leave-approver-selector"),Array.each(c,function(n){e||n.get("id")!=i||(n.getParent().destroy(),e=!0)}),e||(l=document.getElements(".details-position-approver"),Array.each(l,function(n){e||n.get("id")!=i||(n.destroy(),e=!0)}))))})}else!this.isManager&&"employee"in Affinity.leave?Affinity.leave.employee.refreshAll():this.isManager&&"manager"in Affinity.leave&&Affinity.leave.manager.refreshAll()},doUpdateUnits:function(n,t,i,r){new Request.JSON({url:this._api,method:"post",emulation:!1,headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("leaveDetail-updateUnitsRequest")},onFailure:function(n){if(Affinity.leave.unlockui("leaveDetail-updateUnitsRequest"),prompts.hide(),r&&typeOf(r)==="function"){var f="",u=!1,e=n.response;try{u=JSON.parse(e)}catch(n){}typeOf(u)==="object"?(u.Exception!==undefined&&u.Exception.Message!==undefined&&(f=u.Exception.Message),r("error",t,i,f)):r("error",t,i,"Internal Server Error")}},onException:function(){if(Affinity.leave.unlockui("leaveDetail-updateUnitsRequest"),prompts.hide(),r&&typeOf(r)==="function"){var u="",n=!1,f=e.response;try{n=JSON.parse(f)}catch(e){}typeOf(n)==="object"?(n.Exception!==undefined&&n.Exception.Message!==undefined&&(u=n.Exception.Message),r("error",t,i,u)):r("error",t,i,"Internal Server Error")}},onCancel:function(){Affinity.leave.unlockui("leaveDetail-updateUnitsRequest")},onSuccess:function(n){if(Affinity.leave.unlockui("leaveDetail-updateUnitsRequest"),!Affinity.leave.isErrorInJson(n,this._api,this._methodName,!0)){var t=this.data.LeaveHeader.TimeLastModified?Date.parse(this.data.LeaveHeader.TimeLastModified):null;Affinity.leave.manager&&(this.requireUpdate=this.requireUpdate||n.RequireUpdate,!this.requireUpdate&&(!this.timeLastModified||t.getTime()>this.timeLastModified.getTime())&&(this.timeLastModified=t));this.data=n.Data;this.data.Components!==undefined&&this.data.Components.length!==undefined&&this.data.Components.length>0&&this.data.Components[0].Authorisation!==undefined&&this.data.Components[0].Authorisation.AuthorisationId!==undefined&&this.authorisation!==undefined&&this.authorisation!==null&&(this.authorisation.AuthorisationId=this.data.Components[0].Authorisation.AuthorisationId,this.authorisationId=this.authorisation.AuthorisationId);this.buildUnitsTotals(this.data.Components);this.createApproverBoxes(this.data.Components,this.positions);this.createEditableDates(this.data.LeaveHeader,this.data.Components,this.positions);Affinity.tooltips.processNew();this.isManager?Affinity.leave.manager.refreshAll():Affinity.leave.employee.refreshAll()}prompts.hide();this.errorChecking(n)}.bind(this)}).post(JSON.stringify(n))},updateUnits:function(){var a=this.gridBody.getElements(".positions-hours"),v=this.gridBody.getElements(".positions-days"),o=[],i=this.data.LeaveHeader.UnitType=="D",h,c,l,r,u,n,f,t,e,s;if(Array.each(a,function(e,s){h=e.get("id");i&&(l=v[s].getElements(".edit-position-days"));Array.each(e.getElements(".edit-position-hours"),function(e,s){c=e.get("id");i&&(r=l[s]);u=e.value===""?0:parseFloat(e.value);n=e.retrieve("init");n&&n!==""||(n=0);i&&(f=r.value===""?0:parseFloat(r.value),t=r.retrieve("init"),t&&t!==""||(t=0));(u!=n||f!=t)&&o.push({PositionCode:h,Date:c,NewHours:u,OldHours:n,NewDays:f,OldDays:t})})}),o.length>0){if(!this.updateUnitsRequest)return;uialert({message:"Updating Leave Units",showLoader:!0,showButtons:!1,noClose:!0});this._methodName="ui.leave.detail.js -> updateUnits";e="UpdateLeaveUnits/"+this.data.LeaveHeader.EmployeeNo+"/"+this.data.LeaveHeader.TSGroupId;this.isManager&&this.data.LeaveHeader.TimeLastModified&&(e=e+"?timeLastModified="+this.data.LeaveHeader.TimeLastModified);this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+e);this.updateUnitsRequest&&this.updateUnitsRequest.isRunning()&&this.updateUnitsRequest.cancel();this.updateUnitsRequest.url=this.updateUnitsRequest.options.url=this._api;s=this.data.LeaveHeader.PositionCode;this.doUpdateUnits(o,this.updateTotals,this.updateUnits,function(r,e){if(r==="error"){i?(document.getElementsByClassName("edit-position-days")[0].value=t,e(t,f,s),document.getElementsByClassName("edit-position-days")[0].store("old",t)):(document.getElementsByClassName("edit-position-hours")[0].value=n,e(n,u,s),document.getElementsByClassName("edit-position-hours")[0].store("old",n));uialert({message:"Something's stopping the Unit field from updating. Try again.<br /><br />",okText:"Close",showButtons:!0,showCancel:!1,noClose:!1})}})}},newLeaveReason:function(n,t){var i,u,r;this.reasonBox&&this.reasonSelector&&(this.reasonSelector.empty(),new Element("option",{value:"",id:"null",html:""}).inject(this.reasonSelector,"top"),i=null,i=this.isManager?Affinity.leave.manager.config.LeaveCodes:i=Affinity.leave.employee.config.LeaveCodes,typeof i[t]!="undefined"&&i[t].Reasons&&(u=i[t].Reasons,Array.each(u,function(n,t){var i=new Element("option",{value:t,html:n.Description,id:n.ReasonCode}).inject(this.reasonSelector)}.bind(this)),this.reasonSelector.selectedIndex=0));document.getElement(".details-reason-box .required")&&document.getElement(".details-reason-box .required").remove();document.getElement(".edit-leave-attachment .required")&&document.getElement(".edit-leave-attachment .required").remove();typeof i[t]!="undefined"&&(i[t].MandatoryReason===!0&&(r=document.getElement(".details-reason-box label"),new Element("span",{"class":"required",html:"*required"}).inject(r,"bottom")),i[t].MandatoryAttachment===!0&&(r=document.getElement(".edit-leave-attachment label"),new Element("span",{"class":"required",html:"*required"}).inject(r,"bottom")))},setStartDate:function(){var n=this.modalEls.fromDateHidden,t=this.modalEls.toDateHidden;return this.fromDateWidget.getRawDate().greaterThan(this.toDateWidget.getRawDate())?(uialert({message:"Oops! Something went wrong!<br /> Unable to change First Day to after Last Day.",showLoader:!1,showButtons:!0,noClose:!1}),!1):(Affinity.leave.setDates(this.fromDateBox,this.fromDateWidget.getRawDate()),Affinity.leave.setDates(this.toDateBox,this.toDateWidget.getRawDate()),this.modalEls.fromDateHidden=this.fromDateWidget.getDate(),this.modalEls.toDateHidden=this.toDateWidget.getDate(),!0)},setEndDate:function(){var n=this.modalEls.fromDateHidden,t=this.modalEls.toDateHidden;return this.toDateWidget.getRawDate().lessThan(this.fromDateWidget.getRawDate())?(uialert({message:"Oops! Something went wrong!<br /> Unable to change Last Day to before First Day.",showLoader:!1,showButtons:!0,noClose:!1}),!1):(Affinity.leave.setDates(this.fromDateBox,this.fromDateWidget.getRawDate()),Affinity.leave.setDates(this.toDateBox,this.toDateWidget.getRawDate()),this.modalEls.fromDateHidden=this.fromDateWidget.getDate(),this.modalEls.toDateHidden=this.toDateWidget.getDate(),!0)},updateDate:function(n,t,i,r){this.update(n,t,i,this.data.LeaveHeader.EmployeeNo,this.data.LeaveHeader.TSGroupId,this.data.LeaveHeader.TimeLastModified,function(n){this.buildUnitsTotals(n.Components);this.createApproverBoxes(n.Components,r);this.createEditableDates(n.LeaveHeader,n.Components,r);this.data.LeaveHeader.TimeLastModified=n.LeaveHeader.TimeLastModified;Affinity.tooltips.processNew();this.isManager?Affinity.leave.manager.refreshAll():Affinity.leave.employee.refreshAll()}.bind(this))},createApproverBoxes:function(n,t){var r=!0,i=[];component=null;Array.each(n,function(n){i.length===0?i.push(n.positionCode):i.length>0&&i.indexOf(n.positionCode)<0&&i.push(n.positionCode)});i.length===1&&t.length==1&&(r=!1);this.approverBox&&this.approverBox.empty();Array.each(n,function(n){var f=new Element("div",{"class":"details-position-approver authoriserId",id:n.PositionCode}).inject(this.approverBox),u,i;if(n.Authorisation&&f.store("authId",n.Authorisation.AuthorisationId),this.isManager)u=new Element("span").inject(f),n.Authorisation&&(n.Authorisation.ApprovedBy?u.set("html",n.Authorisation.ApprovedByName):u.set("html",n.Authorisation.SubmittedToName));else if(u=new Element("select",{"class":"leave-approver-selector authoriserId"}).inject(f),u.addEvent("change",this.updateAuthoriser),n.Authorisation&&n.Authorisation.AuthorisationId)u.store("authId",n.Authorisation.AuthorisationId),Array.each(t,function(t){(n.PositionCode==t.PositionCode&&r||!r)&&Array.each(t.SubmittedTos,function(t,i){var r=new Element("option",{value:i+1}).inject(u);r.set("html",t.EmployeeName+" ("+t.EmployeeNo+")");r.set("id",t.EmployeeNo);parseInt(n.Authorisation.SubmittedTo)===parseInt(t.EmployeeNo)&&(r.set("selected","selected"),u.store("old",t.EmployeeNo))})});else{Affinity.modal.clear();Affinity.modal.hide();prompts.hide();Affinity.tooltips.hideAll(),function(){Affinity.modal.clear();Affinity.modal.hide();prompts.hide();Affinity.tooltips.hideAll();uialert({showLoader:!1,noClose:!1,showButtons:!0,message:"Can not find an Authoriser ID.<br />This Leave record is missing vital information or is corrupted.<br />Please contact your administrator."})}.delay(1e3,this);return}this.data.LeaveHeader.StatusCode!=-1&&this.data.LeaveHeader.StatusCode!=6&&(i=new Element("div",{"class":"tickcross font-icons color"}).inject(f),n.Authorisation&&n.Authorisation.StatusCode===3?(i.addClass("ui-has-tooltip").set("data-tooltip","Leave is approved"),i.addClass("icon-thumbs-up"),i.addClass("green")):n.Authorisation&&n.Authorisation.StatusCode===2?(i.addClass("red"),i.addClass("ui-has-tooltip").set("data-tooltip","Leave is declined"),i.addClass("icon-thumbs-down")):n.Authorisation&&(i.addClass("ui-has-tooltip").set("data-tooltip","Leave is pending approval"),i.addClass("icon-hourglass"),i.addClass("blue")))}.bind(this))},populateForwardHistory:function(n,t){var u;if(n&&t&&n.length>0){var i=new Element("div",{"class":"details-forwards-box form-row"}).inject(t),e=new Element("label",{"class":"details-label",html:"Forwards"}).inject(i),r=new Element("table",{"class":"details-forwards-history"}).inject(i),f=new Element("thead",{"class":""}).inject(r);new Element("tr",{"class":"forward-row"}).adopt(new Element("th",{"class":"",html:"Date Forwarded"}),new Element("th",{"class":"",html:"Forwarded By"}),new Element("th",{"class":"",html:"Forwarded To"}),new Element("th",{"class":"",html:"Reason"})).inject(f);u=new Element("tbody",{"class":""}).inject(r);Array.each(n,function(n){new Element("tr",{"class":"forward-row"}).adopt(new Element("td",{"class":"",html:Affinity.leave.cleanBadDate(n.TimeForwarded).format("%d-%b-%Y")}),new Element("td",{"class":"",html:n.ForwardedByName}),new Element("td",{"class":"",html:n.ForwardedToName}),new Element("td",{"class":"",html:n.Comment})).inject(u)})}},update:function(n,t,i,r,u,f,o){var l={FieldName:n,NewValue:t,OldValue:i},h="ui.myLeave.js -> update",a=typeOf(r)!=="null"?r:Affinity.login.profile.employeeNumber,c="",s;f&&(c="?timeLastModified="+f);u||(u=document.getElement(".leave-id").retrieve("old"));s=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"UpdateLeave/"+a+"/"+u+c);new Request.JSON({url:s,headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("myleave-update")},onFailure:function(t){if(Affinity.leave.unlockui("myleave-update"),n==="Comment"||n==="LeaveCode"||n==="ReasonCode"){if(o&&typeOf(o)==="function"){var r="",i=!1,u=t.response;try{i=JSON.parse(u)}catch(t){}typeOf(i)==="object"&&i.Exception!==undefined&&i.Exception.Message!==undefined&&(r=i.Exception.Message);o("error",r)}}else Affinity.leave.handleXHRErrors(t,s,h)},onException:function(){if(Affinity.leave.unlockui("myleave-update"),(n==="Comment"||n==="LeaveCode"||n==="ReasonCode")&&o&&typeOf(o)==="function"){var i="",t=!1,r=e.response;try{t=JSON.parse(r)}catch(e){}typeOf(t)==="object"&&t.Exception!==undefined&&t.Exception.Message!==undefined&&(i=t.Exception.Message);o("error",i)}},onCancel:function(){Affinity.leave.unlockui("myleave-update")},onSuccess:function(t){if(Affinity.leave.unlockui("myleave-update"),Affinity.leave.isErrorInJson(t,s,h,!0))this.errorChecking(t);else{if(window.fireEvent("UpdateLeaveSuccess"),console.debug("Time stamp log start"),console.debug("Old timestamp: "+f),Affinity.leave.manager&&f&&t.Data!=null){console.debug("New time stamp: "+t.Data.LeaveHeader.TimeLastModified);var i=Affinity.leave.cleanBadDate(t.Data.LeaveHeader.TimeLastModified);console.debug("Cleaned time stamp: "+i);console.debug("Stored timestamp: "+Affinity.leave.manager.leaveDetail.timeLastModified);!Affinity.leave.manager.leaveDetail.timeLastModified||i.getTime()>Affinity.leave.manager.leaveDetail.timeLastModified.getTime()?(console.debug("Time stamp update succeeded"),Affinity.leave.manager.leaveDetail.timeLastModified=i):console.debug("Time stamp update failed");Affinity.leave.manager.leaveDetail.requireUpdate=Affinity.leave.manager.leaveDetail.requireUpdate||t.RequireUpdate}o&&typeOf(o)==="function"&&((n==="Comment"||n==="LeaveCode"||n==="ReasonCode")&&t.Data===null&&t.Response!=null?o("error",t.Response):o(t.Data))}this.errorChecking(t)}.bind(this)}).post(JSON.stringify(l))},errorChecking:function(n){if(document.getElement(".messages")){var i=document.getElement(".messages").empty(),f=new Element("div").inject(i),e=new Element("ul").inject(f),r=new Element("div").inject(i),u=new Element("ul").inject(r),t=!1;n.Messages.length>0&&Array.each(n.Messages,function(n){n.MessageType===1&&uialert({message:n.Message,showButtons:!0,showCancel:!1,okText:"OK"});n.MessageType===0&&(n.Message==="You must attach supporting documentation when applying for this type of leave."?uialert({message:n.Message,showButtons:!0,showCancel:!1,okText:"OK"}):(new Element("li",{html:n.Message}).inject(u),t=!0))});n.Exception!=null&&(new Element("li",{html:n.Exception}).inject(u),t=!0);t&&r.addClass("acknowledgement-errors")}},doUpdateAuthoriser:function(n,t,i,r){new Request.JSON({url:n,headers:{"Content-Type":"application/json; charset=utf-8"},urlEncoded:!1,onRequest:function(){Affinity.leave.lockui("leaveDetail-updateAuthoriser")},onFailure:function(n){if(Affinity.leave.unlockui("leaveDetail-updateAuthoriser"),r&&typeOf(r)==="function"){var i="",t=!1,u=n.response;try{t=JSON.parse(u)}catch(n){}typeOf(t)==="object"?(t.Exception!==undefined&&t.Exception.Message!==undefined&&(i=t.Exception.Message),r("error",i)):r("error","Internal Server Error.")}},onException:function(){if(Affinity.leave.unlockui("leaveDetail-updateAuthoriser"),r&&typeOf(r)==="function"){var t="",n=!1,i=e.response;try{n=JSON.parse(i)}catch(e){}typeOf(n)==="object"?(n.Exception!==undefined&&n.Exception.Message!==undefined&&(t=n.Exception.Message),r("error",t)):r("error","Internal Server Error.")}},onCancel:function(){Affinity.leave.unlockui("leaveDetail-updateAuthoriser")},onSuccess:function(n){if(Affinity.leave.unlockui("leaveDetail-updateAuthoriser"),Affinity.leave.isErrorInJson(n,api,methodName)){var t=i.getElements("option").indexOf(i.getElement("#"+oldValue));i.selectedIndex=t}else i.store("old",newValue)}}).post(JSON.stringify(t))},updateAuthoriser:function(n){var t=n.target,r=t.retrieve("authId"),i=t.retrieve("old"),u=t.getElements("option")[t.selectedIndex].get("id"),f=t.getParent(".default-form").getElement(".leave-id").retrieve("old"),e={FieldName:"SubmittedTo",NewValue:u,OldValue:i},o=Affinity.login.profile.employeeNumber,s=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"UpdateLeaveAuthorisation/"+o+"/"+f+"/"+r);this.doUpdateAuthoriser(s,e,t,function(n){var e,r,u,f;if(n==="error"){for(e="Something's stopping the Employee field from updating. Check your selection then try again.<br /><br />",uialert({message:e,okText:"Close",showButtons:!0,noClose:!1}),r=-1,u=0;u<t.getElements("option").length;u++)if(f=t.getElements("option")[u],f.id===i.toString()){r=f.index;break}r!=-1&&(t.selectedIndex=r)}})},bossResponse:function(n,t,i,r,u,f){var o,e;this.bossResponseRequest&&(uialert({message:(r===3?"Approving":r===2?"Declining":"Processing")+" Leave",showLoader:!0,noClose:!0,showButtons:!1}),o={FieldName:"StatusCode",NewValue:r,OldValue:i},this._statusChange=r,this._methodName="ui.leave.detail.js -> bossResponse",e="UpdateLeave/"+n+"/"+t,this.bossResponseRequest.isCancellation=i==7,u=="-1"?this.bossResponseRequest.isCancellation===!1&&i==7&&(r==3?e="ApproveCancelled/"+n+"/"+t:o.NewValue="3"):this.bossResponseRequest.isCancellation===!1&&(e="UpdateLeaveAuthorisation/"+n+"/"+t+"/"+u),f&&(e=e+"?timeLastModified="+f),this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+e),function(){this.bossResponseRequest&&this.bossResponseRequest.isRunning()&&this.bossResponseRequest.cancel();this.bossResponseRequest.url=this.bossResponseRequest.options.url=this._api;this.bossResponseRequest.post(JSON.stringify(o))}.delay(1e3,this))},deleteLeave:function(n,t){var r="ui.leave.detail.js -> deleteLeave",i=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"DeleteLeave/"+n+"/"+t);new Request.JSON({url:i,onRequest:function(){Affinity.leave.lockui("myleaveleaveDetail-deleteLeave")},onFailure:function(n){Affinity.leave.unlockui("leaveDetail-deleteLeave");Affinity.leave.handleXHRErrors(n,i,r)},onException:function(){Affinity.leave.unlockui("leaveDetail-deleteLeave")},onCancel:function(){Affinity.leave.unlockui("leaveDetail-deleteLeave")},onSuccess:function(n){Affinity.leave.unlockui("leaveDetail-deleteLeave");Affinity.leave.isErrorInJson(n,i,r)||window.fireEvent("DeleteLeaveSuccess")}}).get()},submitLeave:function(n,t,i,r){if(window.fireEvent("attachmentRequired",!1),this.submitLeaveRequest){var f={FieldName:"StatusCode",NewValue:t,OldValue:i},u;t==6?u="Cancelling Leave Application":t==0&&(u="Submitting Leave Application");setTimeout(function(){uialert({message:u,showButtons:!1,showLoader:!0,noClose:!0})},10);this._methodName="ui.leave.history.js -> resubmitLeave";this._onResponse=r;this._api=this.isManager&&t===0?Affinity.GetCacheSafePath(Affinity.leave.apiroot+"UpdateLeave/"+this.data.LeaveHeader.EmployeeNo+"/"+n):Affinity.GetCacheSafePath(Affinity.leave.apiroot+"UpdateLeave/"+Affinity.login.profile.employeeNumber+"/"+n);this.submitLeaveRequest&&this.submitLeaveRequest.isRunning()&&this.submitLeaveRequest.cancel();this.submitLeaveRequest.url=this.submitLeaveRequest.options.url=this._api;this.submitLeaveRequest.post(JSON.stringify(f))}},checkAttachmentsFileSize:function(n){var f,r,t,u,i;if(n!==undefined&&n.fileElement!==undefined&&n.fileElement.files!==undefined)for(f=n.fileElement.files.length,r=n.fileElement.files,t=0;t<f;t++)if(r[t].size!==undefined&&r[t].size>20963328){for(u=this.attachWidgetDiv.getElements("table tbody tr"),i=0;i<u.length;i++)u[i].innerText.indexOf(r[t].name)!==-1&&u[i].destroy();return!1}return!0},postAttachments:function(n){if(!this.checkAttachmentsFileSize(n)){window.uialert({message:"You can only attach a document that is less than 20MB in size. Please try again."});return}Affinity.leave.lockui("leaveDetail-postAttachments");uialert({message:"Attaching file",showLoader:!0,showButtons:!1,noClose:!0});var t=this.data.LeaveHeader.TSGroupId,i=this.data.LeaveHeader.EmployeeNo;Affinity.leave.postAttachements(i,t,function(n){Affinity.leave.populateAttachments(this.data.LeaveHeader,n.Data,this.attachWidget,this.attachWidgetDiv);Affinity.leave.unlockui("leaveDetail-postAttachments");window.fireEvent("attachmentRequired",!1)}.bind(this))},deleteAttachment:function(n){Affinity.leave.lockui("leaveDetail-deleteAttachment");uialert({message:"Deleting file",showLoader:!0,showButtons:!1,noClose:!0});var t=this.data.LeaveHeader.TSGroupId,i=this.data.LeaveHeader.EmployeeNo;Affinity.leave.deleteAttachment(i,t,n.deletedId,function(n){Affinity.leave.populateAttachments(this.data.LeaveHeader,n.Data,this.attachWidget,this.attachWidgetDiv);Affinity.leave.unlockui("leaveDetail-deleteAttachment")}.bind(this))},attachmentRequired:!1,setAttachmentRequiredValue:function(n){this.attachmentRequired=n},displayAttachmentRequiredModalMessage:function(){uialert({message:"You must attach supporting documentation when applying for this type of leave.",showLoader:!1,showButtons:!0,noClose:!1})},isAttachmentMandatoryForLeaveType:function(){var r=!1,t=null,i,u,n,f;if(Affinity.leave.manager)if(Affinity.leave.manager.config!==undefined&&Affinity.leave.manager.config.Employees!==undefined){for(i=Affinity.leave.manager.config.Employees,n=0;n<i.length;n++)if(i[n].LeaveCodes!==undefined){t=i[n].LeaveCodes;break}}else this.config&&(t=this.config.LeaveCodes);else t=Affinity.leave.employee.config!==undefined&&Affinity.leave.employee.config.LeaveCodes!==undefined?Affinity.leave.employee.config.LeaveCodes:this.config.LeaveCodes;if(t)for(u=this.data.LeaveHeader.LeaveCode,n=0;n<t.length;n++)if(f=t[n].LeaveCode,u===f){r=t[n].MandatoryAttachment;break}return r},validateAttachmentRequirement:function(){return!this.hasAttachedFiles()&&this.isAttachmentMandatoryForLeaveType()?!1:!0},hasAttachedFiles:function(){var n=document.getElementsByClassName("details-attachments"),i,f,r,u,t;if(n&&n.length>0){if(t=n[0].getElements("li"),t!==undefined&&t.length>0)return!0}else if(n=document.getElementsByClassName("upload-table"),n&&n.length>0){for(i=0;i<n.length;i++)if(f=n[i].hasClass("hidden"),!f&&(r=n[i].getElement("table"),r&&(u=r.getElements("tbody tr"),u&&u.length>0)))return!0;if(t=n[0].getElements("li"),t!==undefined&&t.length>0)return!0}return!1},validateBeforeClosingModal:function(){var i=!1,n=document.getElementsByClassName("button green w-icon-only"),t,r;if(n&&n.length>0)for(t=0;t<n.length;t++)if(r=n[t].innerText.contains("Submit"),r){i=!0;break}this.attachmentRequired&&!i?(Affinity.modal.backgroundCloses=!1,uialert({message:"You must attach supporting documentation when applying for this type of leave.",showLoader:!1,showButtons:!0,noClose:!1})):Affinity.modal.backgroundCloses=!0},validateFileDeletion:function(n){var f=n.table.getElements("tbody tr"),r,t,u,e,i,o;if(f){if(r=!1,t=null,t=Affinity.leave.manager&&Affinity.leave.manager.leaveDetail.config&&Affinity.leave.manager.leaveDetail.config.LeaveCodes?Affinity.leave.manager.leaveDetail.config.LeaveCodes:Affinity.leave.employee.leaveDetail.config.LeaveCodes,t&&(u=document.getElementsByClassName("edit-type-selector")[0],u))for(e=u.getElement("option:selected").get("id"),i=0;i<t.length;i++)if(o=t[i].LeaveCode,e===o){r=t[i].MandatoryAttachment;break}r&&f.length===1?window.fireEvent("attachmentRequired",!0):window.fireEvent("attachmentRequired",!1);n.row.addClass("preventDeletion");uiconfirm({message:"Are you sure you want to delete this?",onOk:function(){window.fireEvent("multiFileDeletedFromConfirmation",n.deletionTarget);n.row.destroy();Affinity.uiGrid.zebra(n.table);n.table.getElements("tbody tr").length==0&&n.table.getParent().addClass("hidden")}.bind(this),onCancel:function(){window.fireEvent("attachmentRequired",!1)}.bind(this)})}},acknowledgementModal:function(n,t){var s,f;Affinity.modal.show();Affinity.modal.clear();Affinity.modal.position();var i=new Element("div",{"class":"modal-dataV1",style:"width:700px;"}),u=new Element("div").inject(i),e=new Element("ul").inject(u),r=new Element("div").inject(i),o=new Element("ul").inject(r);t&&typeOf(t)==="string"&&(s=new Element("div",{"class":"acknowledgement-header"}).adopt(new Element("span",{"class":"",html:t})).inject(i));f=new Element("div",{"class":"acknowledgement-content"}).inject(i);n.Messages.length>0&&Array.each(n.Messages,function(n){n.MessageType===1&&(new Element("li",{html:n.Message}).inject(e),u.addClass("acknowledgement-warnings"));n.MessageType===0&&(new Element("li",{html:n.Message}).inject(o),r.addClass("acknowledgement-errors"))});n.Exception!=null?(r.addClass("acknowledgement-errors"),r.set("html",n.Exception)):f.set("html",Affinity.leave.cleanResponse(n.Response));Affinity.modal.setElement(i);Affinity.modal.show()},reset:function(){this.leaveDetailRequest&&this.leaveDetailRequest.isRunning()&&this.leaveDetailRequest.cancel();this.isManager?this.bossResponseRequest&&this.bossResponseRequest.isRunning()&&this.bossResponseRequest.cancel():this.submitLeaveRequest&&this.submitLeaveRequest.isRunning()&&this.submitLeaveRequest.cancel()},destroy:function(){this.reset();this.acceptButton&&this.acceptButton.removeEvents();this.declineButton&&this.declineButton.removeEvents();this.closeButton&&this.closeButton.removeEvents();Object.each(this,function(n,t){this[t]=null;delete this[t]}.bind(this))}}),UIEmployeeLeaveBalances=new Class({Implements:[Options,Events],Binds:["getBalances","processEmployee","createProjectionDate","createProjectionButtonMultiposition","reset","destroy"],options:{target:null},initialize:function(n,t){t||(this.setOptions(n),this.target=this.options.target,this.section=new Element("div",{"class":"section shadow"}).inject(this.target),this.sectionBody=new Element("div",{"class":"section-body"}).inject(this.section),this.form=new Element("div",{"class":"default-form"}).inject(this.sectionBody),this.title=new Element("div",{"class":"section-title",html:"Estimated Leave"}).inject(this.form),this.panels=new Element("div",{"class":"leave-info-panels"}).inject(this.form),this.employeeNumber=Affinity.login.profile.employeeNumber,this.multiPositionCompanies=[2593,6593,5e3]);this.employeeBalanceRequest=new Request.JSON({headers:{Pragma:"no-cache"},onFailure:function(n){Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onSuccess:function(n){Affinity.leave.isErrorInJson(n,this._api,this._methodName)||this.processEmployee(n.Data.ComponentBalances)}.bind(this)});t||this.getBalances()},getBalances:function(){this.employeeNumber&&this.employeeNumber>0&&(this._methodName="ui.leaveBalances.js -> getBalances",this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"EmployeeLeaveBalance/"+this.employeeNumber),this.employeeBalanceRequest&&this.employeeBalanceRequest.isRunning()&&this.employeeBalanceRequest.cancel(),this.employeeBalanceRequest.url=this.employeeBalanceRequest.options.url=this._api,this.employeeBalanceRequest.get())},projectBalances:function(n,t,i){var r,u;i.getElementsByClassName("resultUnits")[0]!=null&&i.getElementsByClassName("resultUnits")[0].addClass("hidden");i.getElementsByClassName("lookup-spinner")[0].removeClass("hidden");r=new Request.JSON({headers:{Pragma:"no-cache"},onFailure:function(n){Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onSuccess:function(n){if(i.getElementsByClassName("lookup-spinner")[0].addClass("hidden"),i.getElementsByClassName("resultUnits")[0]!=null&&i.getElementsByClassName("resultUnits")[0].removeClass("hidden"),!Affinity.leave.isErrorInJson(n,this._api,this._methodName)&&n.Data.ComponentBalances.length>0){var t=n.Data.ComponentBalances[0].CodeBalances[0],r=t.TotalHours;t.UnitType=="D"&&(r=t.TotalDays);i.getElementsByClassName("tileLeaveUnits")[0].innerHTML=r;i.getElementsByClassName("ealTableContainer")[0].parentNode.removeChild(i.getElementsByClassName("ealTableContainer")[0]);this.renderEalStory(i.getElementsByClassName("ealStoryContainer")[0],n.Data.ComponentBalances[0].CodeBalances[0])}}.bind(this)});this.employeeNumber&&this.employeeNumber>0&&(this._methodName="ui.leaveBalances.js -> projectBalances",u=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"EmployeeLeaveBalance/"+this.employeeNumber),u=this.addToApiUrl(u,"dateTo="+t),u=this.addToApiUrl(u,"leaveCode="+n),this._api=u,r&&r.isRunning()&&this.projectBalanceRequest.cancel(),r.url=r.options.url=this._api,r.get())},sendFeedback:function(n){var i=new Request.JSON({headers:{Pragma:"no-cache"},onFailure:function(n){Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this)}),t;n&&n.length>0&&(this._methodName="ui.leaveBalances.js -> SendFeedback",t=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"SendFeedback/"+this.employeeNumber),t=this.addToApiUrl(t,"companyNo="+Affinity.login.profile.companyNumber),t=this.addToApiUrl(t,"feedback="+n),this._api=t,i&&i.isRunning()&&this.sendFeedbackRequest.cancel(),i.url=i.options.url=this._api,i.get())},processEmployee:function(n){this.panelEntitlement=!1;this.panelAccrual=!1;this.panelUnapproved=!1;this.panelApprovedNotPaid=!1;var t=["07","09","10","12","13","11"];this.multiPositionCompanies.indexOf(Affinity.login.profile.companyNumber)>-1?Array.each(n,function(n){var i="top";n.PositionTitle!="All"&&(this.position=new Element("h4",{"class":"",html:n.PositionTitle}).inject(this.panels),n.IsExpired&&(this.position.innerHTML=this.position.innerHTML+' (<span class="required">expired<\/span>)'),i="bottom");Array.each(n.CodeBalances,function(n){if(t.indexOf(n.LeaveCode)>-1){var u=n.TotalHours,f=n.TotalDays,r="Hours",e="Days";n.UnitType==="D"&&(u=n.TotalDays,f=n.TotalHours,r="Days",e="Hours");this.leavePanel=new Element("div",{"class":"leave-info-panel"}).inject(this.panels,i);this.main=new Element("div",{"class":"leave-info-main"}).inject(this.leavePanel);this.balancebox=new Element("div",{"class":"leave-info-main-balance"}).inject(this.main);this.flip=new Element("div",{"class":"leave-info-main-flip",html:Affinity.leave.toFixed(u,2)}).inject(this.balancebox);this.totalLabel=new Element("div",{"class":"days",html:r}).inject(this.balancebox);this.titlebox=new Element("div",{"class":"leave-info-main-title"}).inject(this.main);this.title=new Element("div",{"class":"title",html:n.CodeDescription.replace("Long Service Leave","Long Service")}).inject(this.titlebox);this.detailsBox=new Element("div",{"class":"details-box"}).inject(this.leavePanel);this.panelCols=new Element("div",{"class":"panel-cols"}).inject(this.detailsBox);this.createProjectionButtonMultiposition(n);(n.Entitlement!=null||n.Accrual!=null)&&(this.col1=new Element("div",{"class":"col"}).inject(this.panelCols),n.Entitlement!=null&&(this.panelEntitlement=!0,this.row1=new Element("div",{"class":"row"}).inject(this.col1),this.title1=new Element("div",{"class":"title",html:"Entitled"}).inject(this.row1),this.value1=new Element("div",{"class":"value",html:Affinity.leave.toFixed(n.Entitlement,2)+" "+r.toLowerCase()}).inject(this.row1)),n.Accrual!=null&&(this.panelAccrual=!0,this.row2=new Element("div",{"class":"row"}).inject(this.col1),this.title2=new Element("div",{"class":"title",html:"Accrued"}).inject(this.row2),this.value2=new Element("div",{"class":"value",html:Affinity.leave.toFixed(n.Accrual,2)+" "+r.toLowerCase()}).inject(this.row2)));(n.Unapproved!=null||n.ApprovedNotPaid!=null)&&(this.col2=new Element("div",{"class":"col"}).inject(this.panelCols),n.Unapproved!=null&&(this.panelUnapproved=!0,this.row3=new Element("div",{"class":"row"}).inject(this.col2),this.title3=new Element("div",{"class":"title",html:"Pending"}).inject(this.row3),this.value3=new Element("div",{"class":"value",html:Affinity.leave.toFixed(n.Unapproved,2)+" "+r.toLowerCase()}).inject(this.row3)),n.ApprovedNotPaid!=null&&(this.panelApprovedNotPaid=!0,this.row4=new Element("div",{"class":"row"}).inject(this.col2),this.title4=new Element("div",{"class":"title",html:"Approved"}).inject(this.row4),this.value4=new Element("div",{"class":"value",html:Affinity.leave.toFixed(n.ApprovedNotPaid,2)+" "+r.toLowerCase()}).inject(this.row4)))}}.bind(this))}.bind(this)):Array.each(n,function(n){Array.each(n.CodeBalances,function(n){var r,i,u,f;if(t.indexOf(n.LeaveCode)>-1){r=n.TotalHours;i="Hours";n.UnitType==="D"&&(r=n.TotalDays,approxUnits=n.TotalHours,i="Days");this.leavePanel=new Element("div",{"class":"leave-info-panel"}).inject(this.panels);this.main=new Element("div",{"class":"leave-info-main"}).inject(this.leavePanel);this.balancebox=new Element("div",{"class":"leave-info-main-balance"}).inject(this.main);this.titlebox=new Element("div",{"class":"leave-info-main-title inlineBlock"}).inject(this.main);this.title=new Element("div",{"class":"title",html:n.CodeDescription.replace("Long Service Leave","Long Service")}).inject(this.titlebox);u=new Element("input",{type:"text","class":"uidate-calendar uidate-preserve data-hj-whitelist","data-calendar-type":"date","data-calendar-display-format":"%d/%m/%Y","data-calendar-return-format":"%d/%m/%Y","data-start-date":"none"});f=new Element("div",{"class":"calendarContainer inlineBlock",style:"margin: 15px 0;"}).adopt(u);r==1&&(i=i.substring(0,i.length-1));var e="Your available leave on ",o=' is <span class="resultUnits"><span class="tileLeaveUnits">'+r+"<\/span> "+i.toLowerCase()+"<\/span>",s=new Element("span",{html:'<img src="'+Affinity.loaders.light+'" />',"class":"lookup-spinner hidden"});r==0&&(e="You have no leave available on ",o="");new Element("div",{"class":"tileSummaryContainer"}).adopt(new Element("span",{html:e}),f,new Element("span",{html:o}),s).inject(this.titlebox);Affinity.UI.calendars.processNew();u.getWidget().setDate(new Date);u.addEvent("change",function(){this.calcEntitlement(u,n)}.bind(this));this.detailsBox=new Element("div",{"class":"details-box",style:"margin-top: 15px;"}).inject(this.leavePanel);this.detailsWrapper=new Element("div",{"class":"detailsWrapper",style:"padding: 0 15px;"}).inject(this.detailsBox);this.storyContainer=new Element("div",{"class":"ealStoryContainer",style:"padding: 0 15px;"}).inject(this.detailsWrapper);this.renderEalStory(this.storyContainer,n);this.ppeTotalsStory=new Element("div",{"class":"ppeTotalsStory",style:"display: none;",html:"<br />"+n.PpeTotalsStory}).inject(this.detailsWrapper)}}.bind(this))}.bind(this));this.infoTileBoxes=document.getElements(".leave-info-main");this.infoDetailsBoxes=document.getElements(".details-box");Array.each(this.infoTileBoxes,function(n,t){var i;if(this.detailsButton=new Element("div",{"class":"tooltip-view ui-has-tooltip more-button tile-more-button",html:'<span class="button more w-icon"><span class="icon-info"><\/span><span class="btn-tag tile-more">More<\/span><\/span>'}).store("state","closed").inject(n),i=this.infoDetailsBoxes[t],i.set("reveal",{duration:250}),i.toggle(),this.multiPositionCompanies.indexOf(Affinity.login.profile.companyNumber)==-1){var r=this.infoTileBoxes[t].closest(".leave-info-panel"),u=new Element("div",{"class":"tooltip-view ui-has-tooltip more-button tile-more-button",style:"text-align: center;",html:'<br /><span class="button more w-icon"><span class="icon-info"><\/span><span class="btn-tag tile-more">Totals at last pay period<\/span><\/span>'}).inject(r.getElementsByClassName("detailsWrapper")[0]),f=new Element("div",{"class":"tooltip-view ui-has-tooltip more-button tile-more-button",style:"text-align: center;",html:'<span class="button more w-icon"><span><\/span><span class="btn-tag tile-more">Hide<\/span><\/span>'}).inject(r.getElementsByClassName("ppeTotalsStory")[0]);u.addEvent(Affinity.events.click,function(){r.getElementsByClassName("ppeTotalsStory")[0].style.display="block";u.style.display="none"}.bind(this));f.addEvent(Affinity.events.click,function(){r.getElementsByClassName("ppeTotalsStory")[0].style.display="none";u.style.display="block"}.bind(this))}this.detailsButton.addEvent(Affinity.events.start,function(n){n.stop()}.bind(this));this.detailsButton.addEvent(Affinity.events.click,function(n){this.button=n.getTarget("more-button");var t=this.button.closest(".leave-info-panel");this.button.retrieve("state")==="closed"?(i.reveal(),this.button.getElementsByClassName("tile-more")[0].innerText="Less",this.button.store("state","open")):(i.dissolve(),this.button.getElementsByClassName("tile-more")[0].innerText="More",this.button.store("state","closed"))}.bind(this))}.bind(this))},renderEalStory:function(n,t){var i=this.generateEalTableHtml(t);new Element("div",{"class":"ealTableContainer",html:i,style:"padding: 0 15px;"}).inject(n)},generateEalTableHtml:function(n){var o=n.UnitType=="H"?"Hours":"Days",r=this.parseISOLocal(n.BalanceDate),s=r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear(),u="<div class='leftText'>How Your Estimated Leave Is Calculated<\/div><br /><table class='ealTable'><thead><tr><th>Breakdown<\/th><th class='centerText'>"+o+"<\/th><\/tr><\/thead><tbody><tr><td>Leave balance at last period end<\/td><td class='centerText "+this.evaluateCssClassByValue(n.Entitlement)+"'>"+n.Entitlement+"<\/td><\/tr><tr><td>Add leave accruals<\/td><td class='centerText "+this.evaluateCssClassByValue(n.PostProjectedAccruals+n.Accrual)+"'>+"+ +(n.PostProjectedAccruals+n.Accrual).toFixed(2)+"<\/td><\/tr>",e=n.UnitType=="H"?n.TotalHours:n.TotalDays,t,i,f;if(n.LeaveItems!=null)for(t=0;t<n.LeaveItems.length;t++)i=this.parseISOLocal(n.LeaveItems[t].DateFrom),f=i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),u+=n.LeaveItems[t].Credit?"<tr><td>Credit cancelled/declined leave booked on "+f+"<\/td><td class='centerText "+this.evaluateCssClassByValue(n.LeaveItems[t].Units)+"'>+"+n.LeaveItems[t].Units+"<\/td><\/tr>":"<tr><td>Subtract leave booked on "+f+"<\/td><td class='centerText "+this.evaluateCssClassByValue(-n.LeaveItems[t].Units)+"'>-"+n.LeaveItems[t].Units+"<\/td><\/tr>";return u+="<tfoot><tr><th>Total estimated leave available on "+s+"<\/th><th class='centerText "+this.evaluateCssClassByValue(e)+"'>"+e+"<\/th><\/tr> <\/tfoot>",u+"<\/table><br />"},parseISOLocal:function(n){var t=n.split(/\D/);return new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])},evaluateCssClassByValue:function(n){return n<0?"red":""},addToApiUrl:function(n,t){return n+=n.indexOf("?")>-1?"&":"?",n+t},calcEntitlement:function(n,t){var i=n.getWidget().getRawDate(),u=n.closest(".leave-info-panel"),r;if(i&&typeOf(i)==="date"&&i.isValid())i=i.format("%d-%b-%Y");else return uialert({message:"Date is invalid.",noClose:!1}),!1;if(r=Date.parse(i.replace(/-/g," ")),r.lessThan(new Date))return uialert({message:"Past dates are invalid.",noClose:!1}),!1;if(r.greaterThan(new Date((new Date).setFullYear((new Date).getFullYear()+1))))return uialert({message:"You can only estimate leave up to one year in advance.",noClose:!1}),!1;this.projectBalances(t.LeaveCode,i,u)},registerFeedback:function(n,t){var i=n.getTarget("message-icon").closest(".leave-info-panel"),s=i.getElementsByClassName("feedbackThumbsContainer")[0],o=i.getElementsByClassName("feedbackCommentContainer")[0],u=i.getElementsByClassName("feedbackMoreInfo")[0],e=i.getElementsByClassName("ealStory")[0].innerText,r,f;u.style.display="inline";u.fade("in");s.fade("out");o.fade("in");o.style.display="block";switch(t){case 0:r=i.getElementsByClassName("feedbackMoreInfoTextbox")[0];f=i.getElementsByClassName("feedbackSend")[0];r.fade("in");f.fade("in");u.innerText="Help us to improve.";r.style.display="block";f.style.display="inline-block";ga("send","event",{eventCategory:"ThumbsFeedback",eventAction:"Bad",eventLabel:"e: "+Affinity.login.profile.employeeNumber+" | c:"+Affinity.login.profile.companyNumber+" | story: "+e});break;case 1:u.innerText="Thanks for your feedback.";ga("send","event",{eventCategory:"ThumbsFeedback",eventAction:"Good",eventLabel:"e: "+Affinity.login.profile.employeeNumber+" | c:"+Affinity.login.profile.companyNumber+" | story: "+e});break;default:var r=i.getElementsByClassName("feedbackMoreInfoTextbox")[0],f=i.getElementsByClassName("feedbackSend")[0],t=r.value;ga("send","event",{eventCategory:"ThumbsFeedback",eventAction:"Comment",eventLabel:"e: "+Affinity.login.profile.employeeNumber+" | c:"+Affinity.login.profile.companyNumber+" | story: "+e+" | feedback: "+t});r.fade("out");f.fade("out");r.style.display="none";f.style.display="none";u.innerText="Thanks for your feedback."}},createProjectionButtonMultiposition:function(n){n.LeaveCode=="09"&&(this.leavePanel.addClass("projection"),this.projectionButton=new Element("div",{"class":"toggle-button ui-has-tooltip",html:Affinity.icons.GraphStatistics,"data-tooltip":"Show leave projection","data-tooltip-dir":"left"}).inject(this.main),this.projectionButton.addEvent(Affinity.events.click,function(){var t=new Date,i;t.setHours(0);t.setMinutes(0);t.setSeconds(0);t.setMilliseconds(0);i=160;n.AnnualEntitlement&&(i=n.AnnualEntitlement);var f=Date.parse(n.PeriodEndDate),r=n.TotalHours,e=i/365,o=t.getTime()-f.getTime(),u=Math.round(o/864e5);this.todayBalance=r+u*e;Affinity.modal.show();Affinity.modal.clear();Affinity.modal.position();this.modalData=new Element("div",{"class":"modal-data section",style:"width:700px;"});this.modalHeader=new Element("h1",{html:"Annual Leave Projection"}).inject(this.modalData);this.projectionControls=new Element("div",{"class":"projection-controls default-form"}).inject(this.modalData);this.annualEntitlement=new Element("div",{"class":"annual-entitlement form-row"}).inject(this.projectionControls);this.calcEntitlement=function(){var f=this.annualEntitlementInput.get("value")/365,i=this.projectionDateInput.retrieve("widget"),n=new Date(t),r,u;i&&(n=new Date(i.date));n.getTime()<t.getTime()?(n=new Date(t),i.setDate(new Date(n)),this.projectedEntInput.set("value",Math.round(this.todayBalance*100)/100)):(r=n.getTime()-t.getTime(),u=Math.ceil(r/864e5),this.projectedEntitlement=this.todayBalance+u*f,this.projectedEntInput.set("value",Math.round(this.projectedEntitlement*100)/100))}.bind(this);new Element("label",{html:"Entitlement Per Year (estimated hours)"}).inject(this.annualEntitlement);this.annualEntitlementInput=new Element("input",{type:"text",value:i}).inject(this.annualEntitlement);this.annualEntitlementInput.addEvent("change",function(){var n=this.annualEntitlementInput.get("value")/365;this.todayBalance=r+u*n;this.calcEntitlement()}.bind(this));this.projectionDate=new Element("div",{"class":"projection-date form-row"}).inject(this.projectionControls);new Element("label",{html:"Projection Date"}).inject(this.projectionDate);this.projectionDateInput=new Element("input",{type:"text","class":"uidate-calendar uidate-preserve","data-calendar-type":"date","data-calendar-display-format":"%d/%m/%Y","data-calendar-return-format":"%d/%m/%Y","data-start-date":t.format("%d/%b/%y")}).inject(this.projectionDate);this.projectionDateInput.addEvent("change",this.calcEntitlement);this.projectedEntRow=new Element("div",{"class":"projected-entitlement form-row"}).inject(this.projectionControls);new Element("label",{html:"Estimated Entitlement"}).inject(this.projectedEntRow);this.projectedEntInput=new Element("input",{type:"text"}).inject(this.projectedEntRow);this.projectedEntInput.addEvent("change",function(){var u=this.annualEntitlementInput.get("value")/365,n=this.projectedEntInput.get("value"),i=this.projectionDateInput.retrieve("widget"),r;i&&(isNaN(n)||n<this.todayBalance?(date=new Date(t),i.setDate(new Date(date)),this.projectedEntInput.set("value",Math.round(this.todayBalance*100)/100)):(r=Math.ceil((n-this.todayBalance)/u),date=new Date(t),date.setDate(date.getDate()+r),i.setDate(new Date(date))))}.bind(this));this.canvas=new Element("canvas",{id:"projection-chart","class":"hidden",width:650,height:400}).inject(this.modalData);this.projection={};this.projection.dataSet={label:"Annual Leave Total",pointBackgroundColor:"#44b5ec",pointHoverRadius:6,data:[]};this.projection.data={labels:[],datasets:[this.projection.dataSet]};this.projection.options={responsive:!1,title:{display:!0,text:"Annual Leave Projection"},tooltips:{mode:"label"},hover:{mode:"single"},scales:{xAxes:[{display:!0,scaleLabel:{display:!0,labelString:"Date"},ticks:{autoSkip:!1,maxRotation:0},afterTickToLabelConversion:function(n){var t=n.ticks,r=n.chart.options.scales.xAxes[0].ticks.stepSize,u="",i=0;t.forEach(function(n,f){u==t[f][1]?(i++,t[f]=r<10?i%r!=0?"":t[f][0]:t[f][0]!=15?"":t[f][0]):(u=t[f][1],i=0)})}}],yAxes:[{display:!0,scaleLabel:{display:!0,labelString:"Annual Leave (hours)"},ticks:{stepSize:10,autoSkip:!1}}]},legend:{display:!1}};this.projection.buildData=function(n,t,i,r){var h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],c=r,o=[],s=[],f=1,u,e;for(t==="1"?(f=1,this.projection.options.scales.xAxes[0].ticks.stepSize=2,this.projection.options.scales.xAxes[0].ticks.maxRotation=0):t==="3"?(f=3,this.projection.options.scales.xAxes[0].ticks.stepSize=15,this.projection.options.scales.xAxes[0].ticks.maxRotation=0):t==="6"?(f=6,this.projection.options.scales.xAxes[0].ticks.stepSize=15,this.projection.options.scales.xAxes[0].ticks.maxRotation=0):t==="12"&&(f=12,this.projection.options.scales.xAxes[0].ticks.stepSize=15,this.projection.options.scales.xAxes[0].ticks.maxRotation=15),u=new Date(i),e=new Date(i),e.setMonth(e.getMonth()+f);u.getTime()<=e.getTime();)o.push([u.getDate(),h[u.getMonth()]]),s.push(Math.round(r*100)/100),u.setDate(u.getDate()+1),r+=n;this.projection.data.labels=o;this.projection.dataSet.data=s;this.projection.options.scales.yAxes[0].ticks.min=Math.floor(c/40)*40;this.projection.options.scales.yAxes[0].ticks.max=Math.ceil(r/40)*40;this.projectionChart&&this.projectionChart.destroy();this.canvas.removeClass("hidden");this.projectionChart=new Chart(this.canvas,{type:"line",data:this.projection.data,options:this.projection.options})}.bind(this);Affinity.modal.setElement(this.modalData);Affinity.modal.show();Affinity.UI.calendars.processNew();this.projectionDate.getElement("span.ui-calendar-buttons").addClass("hidden")}.bind(this)))},reset:function(){this.employeeBalanceRequest&&this.employeeBalanceRequest.isRunning()&&this.employeeBalanceRequest.cancel();this.panels&&(Array.each(this.panels.getElements(".button"),function(n){n.removeEvents()}),Array.each(this.panels.getElements(".toggle-button"),function(n){n.removeEvents()}),this.panels.empty())},destroy:function(){this.reset();this.section&&(Array.each(this.section.getElements(".button"),function(n){n.removeEvents()}),Array.each(this.section.getElements(".toggle-button"),function(n){n.removeEvents()}),this.section.empty(),this.section.destroy());Object.each(this,function(n,t){this[t]=null;delete this[t]}.bind(this))}}),InputEditWidget;Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector);Element.prototype.closest||(Element.prototype.closest=function(n){var t=this;do{if(t.matches(n))return t;t=t.parentElement||t.parentNode}while(t!==null&&t.nodeType===1);return null});InputEditWidget=new Class({Implements:[Options,Events],Binds:["attachToInput","select","deselect","enableSave","disableSave"],options:{target:null,input:null,updateInput:null,cancelInput:null},initialize:function(n){this.setOptions(n);this.target=this.options.target;this.input=this.options.input;this.updateInput=this.options.updateInput;this.cancelInput=this.options.cancelInput;this.selected=!1;this.delayDeselectTimeout=null;this.input&&this.attachToInput(this.input);this.inputEditButtons=new Element("div",{"class":"edit-input-buttons"}).inject(this.target);this.saveInputEdit=new Element("span",{"class":"button green w-icon-only ui-has-tooltip","data-tooltip":"Save","data-tooltip-dir":"bottom"}).adopt(new Element("span",{html:Affinity.icons.Save})).inject(this.inputEditButtons);this.saveInputEdit.addEvent("click",function(){this.updateInput(),function(){this.target.removeClass("selected")}.delay(500,this);this.inputEditButtons.dissolve();this.selected=!1}.bind(this));this.cancelInputEdit=new Element("span",{"class":"button grey w-icon-only ui-has-tooltip","data-tooltip":"Cancel","data-tooltip-dir":"bottom"}).adopt(new Element("span",{html:Affinity.icons.Cancel})).inject(this.inputEditButtons);this.cancelInputEdit.addEvent("click",function(){this.inputEditButtons.dissolve(),function(){this.target.removeClass("selected")}.delay(500,this);this.cancelInput();this.selected=!1;this.enableSave()}.bind(this));this.inputEditButtons.hide()},attachToInput:function(n){n&&(this.input&&this.input.removeEvents(),this.input=n,this.input.addEvent("focusin",function(n){this.select(n)}.bind(this)),this.input.addEvent("focusout",function(n){this.deselect(n)}.bind(this)))},select:function(){this.inInput=!0;this.selected||(this.selected=!0,function(){this.delayDeselectTimeout&&clearTimeout(this.delayDeselectTimeout);this.target.addClass("selected");this.inputEditButtons.setStyle("top",this.target.getSize().y-4+"px");this.inputEditButtons.reveal()}.bind(this).delay(250,this))},deselect:function(n){this.inInput=!1;this.inputEditButtons.setStyle("top",this.target.getSize().y-4+"px");this.delayFocusoutTimeout&&clearTimeout(this.delayFocusoutTimeout);this.delayFocusoutTimeout=function(){this.selected&&!this.inInput&&(this.saveInputEdit.get("disabled")?function(){n.target.focus()}():(this.delayDeselectTimeout=function(){this.target.removeClass("selected")}.bind(this).delay(500,this),this.inputEditButtons.dissolve(),this.selected=!1,this.updateInput()))}.delay(250,this)},enableSave:function(){this.saveInputEdit&&(this.saveInputEdit.set("disabled",null),this.saveInputEdit.removeClass("disabled"))},disableSave:function(){this.saveInputEdit&&(this.saveInputEdit.set("disabled","disabled"),this.saveInputEdit.addClass("disabled"))}})