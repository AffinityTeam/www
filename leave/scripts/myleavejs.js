var EmployeeLeave=new Class({Implements:[Options,Events],Binds:["init","employeeBalance","employeeApply","employeeHistory","initLeaveDetail","generateMyLeaveCalendar","generateTeamLeaveCalendar","refreshApplyForLeave","update","deleteLeave","newLeaveReason","editableDateRange","populateDates","populatePositionUnits","refreshBalance","refreshHistory","refreshAll","reset","destroy","checkApplicationEditable","getConfig","getConfigWithHandle","applyConfig"],options:{target:null},initialize:function(n){this.setOptions(n);this.target=this.options.target},configData:null,leaveBlanaces:!1,leaveHistory:!1,applyForLeave:!1,leaveDetail:!1,init:function(){this.leaveConfigRequest=new Request.JSON({onRequest:function(){Affinity.leave.lockui("employee-leaveConfigRequest")},onFailure:function(n){Affinity.leave.unlockui("employee-leaveConfigRequest");Affinity.leave.handleXHRErrors(n,this._api,this._methodName)}.bind(this),onException:function(){Affinity.leave.unlockui("employee-leaveConfigRequest")},onCancel:function(){Affinity.leave.unlockui("employee-leaveConfigRequest")},onSuccess:function(n){Affinity.leave.unlockui("employee-leaveConfigRequest");Affinity.leave.isErrorInJson(n,this._api,this._methodName)||(this.config=n.Data,this.configQueue&&this.configQueue.length>0&&(Array.each(this.configQueue,function(n){n&&typeOf(n)==="function"&&n(this.config)}.bind(this)),this.configQueue=[]),this._onSuccess&&(this._onSuccess(n.Data),this._onSuccess=null))}.bind(this)});this.configQueue=[];this.getConfig();this.employeeBalance();this.employeeApply();this.employeeHistory();this.initLeaveDetail();this.generateMyLeaveCalendar();this.generateTeamLeaveCalendar();Affinity.tooltips.processNew();this.target.removeClass("hidden")},employeeBalance:function(){this.leaveBlanaces=new UIEmployeeLeaveBalances({target:this.target})},initLeaveDetail:function(){this.leaveDetail=new UILeaveDetail({target:this.target,isManager:!1})},refreshBalance:function(){this.leaveBlanaces&&(this.leaveBlanaces.reset(),this.leaveBlanaces.getBalances())},employeeApply:function(){this.applyForLeave=new UILeaveApply({target:this.target,isManager:!1})},employeeHistory:function(){this.leaveHistory=new UILeaveHistory({target:this.target,isManager:!1})},refreshHistory:function(){this.leaveHistory&&(this.leaveHistory.reset(!0),this.leaveHistory.refreshHistory(!0))},refreshAll:function(){this.refreshBalance();this.refreshHistory();this.refreshApplyForLeave()},refreshApplyForLeave:function(){this.applyForLeave.validateTotalUnitsAppliedFor()},generateMyLeaveCalendar:function(){var t=new Date,i,n,r;t.setDate(1);i=t.setMonth(t.getMonth()-13);n=new Date;n.setMonth(n.getMonth()+11);r=new Date(n.getFullYear(),n.getMonth(),0);this.mycalendar=new UILeaveCalendar({target:this.target,fromDate:i,toDate:r})},generateTeamLeaveCalendar:function(){var t=new Date,i,n,r;t.setDate(1);i=t.setMonth(t.getMonth()-13);n=new Date;n.setMonth(n.getMonth()+11);r=new Date(n.getFullYear(),n.getMonth(),0);this.teamcalendar=new UITeamLeaveCalendar({target:this.target,fromDate:i,toDate:r})},deleteLeave:function(n,t){var r="ui.myLeave.js -> deleteLeave",i=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"DeleteLeave/"+n+"/"+t);new Request.JSON({url:i,onRequest:function(){Affinity.leave.lockui("myleave-deleteLeave")},onFailure:function(n){Affinity.leave.unlockui("myleave-deleteLeave");Affinity.leave.handleXHRErrors(n,i,r)},onException:function(){Affinity.leave.unlockui("myleave-deleteLeave")},onCancel:function(){Affinity.leave.unlockui("myleave-deleteLeave")},onSuccess:function(n){Affinity.leave.unlockui("myleave-deleteLeave");Affinity.leave.isErrorInJson(n,i,r)||window.fireEvent("DeleteLeaveSuccess")}}).get()},newLeaveReason:function(n,t){var e,r,i,f,u;document.getElement(".details-reason-box")&&(e=document.getElement(".details-reason-box"),r=document.getElement(".edit-reason-selector"),r.empty(),new Element("option",{value:"",id:"null",html:""}).inject(r,"top"),i=n.Data.LeaveCodes,typeof i[t]!="undefined"&&i[t].Reasons&&(f=i[t].Reasons,Array.each(f,function(n,t){var i=new Element("option",{value:t}).inject(r);i.set("html",n.Description);i.set("id",n.ReasonCode)}),r.selectedIndex=0));document.getElement(".details-label .required")&&document.getElement(".details-label .required").remove();document.getElement(".edit-leave-attachment .required")&&document.getElement(".edit-leave-attachment .required").remove();typeof i[t]!="undefined"&&(i[t].MandatoryReason===!0&&(u=document.getElement(".details-label label"),new Element("span",{"class":"required",html:"*required"}).inject(u,"bottom")),i[t].MandatoryAttachment===!0&&(u=document.getElement(".edit-leave-attachment label"),new Element("span",{"class":"required",html:"*required"}).inject(u,"bottom")))},editableDateRange:function(n,t,i){for(var e=this.modalEls.fromDateWidget.getRawDate(),o=this.modalEls.toDateWidget.getRawDate(),r=[],u=e.clone(),f;u.lessThanOrEqualTo(o);)r.push(u.clone()),u.increment("day",1);f=document.getElement(".globalDateRange");f.store("dateRange",r);this.populateDates(n,t,r,i)},populateDates:function(n,t,i,r){var a=i.concat(document.getElement(".globalDateRange").retrieve("dateRange")).sort(),f=0,e=document.getElement(".unit-scroller-box"),u=document.getElement(".details-units-scroller"),v=document.getElement(".details-positions"),o=new Element("div",{"class":"unit-grid"}).inject(u),l=new Element("div",{"class":"unit-gridheader"}).inject(o),y=new Element("div",{"class":"unit-gridbody"}).inject(o),s,h,c;Array.each(i,function(n){tempDate=Affinity.leave.cleanBadDate(n);s=new Element("div",{"class":"day-class d-"+tempDate.format("%d-%b-%y"),id:tempDate.format("%d/%b/%y")}).inject(l);s.adopt(new Element("div",{"class":"day-class-day",html:tempDate.format("%a")}),new Element("div",{"class":"day-class-date",html:tempDate.format("%e")}),new Element("div",{"class":"day-class-my",html:tempDate.format("%b '%y")}),new Element("div",{"class":"hol-icon icon-plane ui-has-tooltip"}));f+=79});u.setStyle("width",f);u.store("scrollerWidth",f);h=e.measure(function(){return this.getSize().x});c=u.measure(function(){return this.getScrollSize().x});c>h?e.setStyle("overflow-x","scroll"):e.setStyle("overflow-x","hidden");this.populatePositionUnits(n,t,i,r)},populatePositionUnits:function(n,t,i,r){r=typeOf(r)==="null"?!1:r;var f,c=document.getElement(".unit-gridbody"),l=document.getElement(".position-labels"),e,s,a,u,o,h;Array.each(t,function(t){e=r?r+"":t.PositionCode;t.PositionCode===e&&(s=new Element("div",{"class":"positions-units",id:e}).inject(c),a=new Element("label",{html:t.PositionTitle,"class":"ui-has-tooltip","data-tooltip":t.PositionTitle,"data-tooltip-dir":"bottom"}).inject(l),Array.each(i,function(t){u=new Element("input",{"class":"edit-position-units data-hj-whitelist",id:Affinity.leave.cleanBadDate(t).format("%d/%b/%y"),value:"0.00"}).inject(s);Array.each(n,function(n){n.PositionCode===e&&Array.each(n.Units,function(n){o=Affinity.leave.cleanBadDate(n.Date).format("%d/%b/%y");h=u.get("id");h===o&&(f=0,typeOf(n.UnitsAppliedFor)==="number"&&(f=n.UnitsAppliedFor,u.store("old",f)),u.set("value",f.toFixed(2)),typeOf(n.IsPublicHoliday)==="boolean"&&n.IsPublicHoliday===!0&&(u.addClass("public-holiday").addClass("ui-has-tooltip").set("data-tooltip",n.PublicHolidayName).set("data-tooltip-dir","bottom,center"),u.getParent(".unit-grid").getElement(".day-class.d-"+o.replace(/\//gi,"-")).addClass("public-holiday").getElement(".hol-icon").set("data-tooltip",n.PublicHolidayName).set("data-tooltip-dir","bottom,center")))})});Affinity.tooltips.processNew()}))})},checkApplicationEditable:function(n,t,i,r){var u="";t==3?u="Approved":t==2&&(u="Declined");u!=""?uialert({message:"This Leave Application has been approved. <br /> Do you want to resubmit application to make it editable?",showButtons:!0,showCancel:!0,okText:"Yes - resubmit application",okIcon:Affinity.icons.Plane,onOk:function(){var u={FieldName:"StatusCode",NewValue:0,OldValue:t};this._methodName="ui.myLeave.js -> resubmitApplication";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"UpdateLeave/"+Affinity.login.profile.employeeNumber+"/"+n);this.resubmitApprovedRequest.doOnSuccess=i;this.resubmitApprovedRequest.doOnFailure=r;this.resubmitApprovedRequest&&this.resubmitApprovedRequest.isRunning()&&this.resubmitApprovedRequest.cancel();this.resubmitApprovedRequest.url=this.resubmitApprovedRequest.options.url=this._api;this.resubmitApprovedRequest.post(JSON.stringify(u))}.bind(this),onCancel:function(){r&&r()}}):i&&i()},getConfig:function(){var n=Affinity.login.profile.employeeNumber;this._methodName="ui.myLeave.js -> getConfig";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"LeaveConfig/"+n);this.leaveConfigRequest&&this.leaveConfigRequest.isRunning()&&this.leaveConfigRequest.cancel();this.leaveConfigRequest.url=this.leaveConfigRequest.options.url=this._api;this.leaveConfigRequest.get()},getConfigWithHandle:function(n){var t=Affinity.login.profile.employeeNumber;this._methodName="ui.myLeave.js -> getConfig";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"LeaveConfig/"+t);this.leaveConfigRequest&&this.leaveConfigRequest.isRunning()&&this.leaveConfigRequest.cancel();this._onSuccess=n;this.leaveConfigRequest.url=this.leaveConfigRequest.options.url=this._api;this.leaveConfigRequest.get()},applyConfig:function(n){this.config?n(this.config):this.configQueue.push(n)},reset:function(){this.leaveBlanaces&&this.leaveBlanaces.reset();this.leaveHistory&&this.leaveHistory.reset();this.applyForLeave&&this.applyForLeave.reset();this.mycalendar&&this.mycalendar.reset();this.teamcalendar&&this.teamcalendar.reset();this.target.empty();this.target.addClass("hidden")},destroy:function(){this.reset();this.leaveBlanaces&&this.leaveBlanaces.destroy();this.leaveHistory&&this.leaveHistory.destroy();this.applyForLeave&&this.applyForLeave.destroy();this.mycalendar&&this.mycalendar.destroy();this.teamcalendar&&this.teamcalendar.destroy()}}),UILeaveCalendar=new Class({Implements:[Options,Events],Binds:["hide","show","toggle","init","buildHistoryFrames","getHolidays","myLeave","getExisitingLeave","processExistingLeave","buildHistoryControls","scrollFromMarker","positionKeyMarker","positionKeyMarkerOnScroll","reset","destroy"],options:{target:null,fromDate:!1,toDate:!1,startDay:0},initialize:function(n){this.setOptions(n);this.width="90%";this.today=new Date;this.currentMonth=Date.parse(this.options.fromDate).getMonth()+1;this.fromDate=Date.parse(this.options.fromDate);this.toDate=Date.parse(this.options.toDate);this.days=Math.ceil((this.toDate-this.fromDate)/864e5);this.visibleWidth="90%";this.segmentWidth=this.days*20<this.width?this.width/this.days:20;this.totalWidth=this.segmentWidth*this.days;this.target=this.options.target;this.section=new Element("div",{"class":"section calendar-section"}).adopt(new Element("div",{"class":"section-body"}).adopt(this.calendarForm=new Element("div",{"class":"default-form leave-calendar-form"}))).inject(this.target);this.section.setStyle("opacity",0);this.titlebox=new Element("div",{"class":"section-title ui-has-tooltip",html:"Leave Calendar","data-tooltip":"Open / Close","data-tooltip-dir":"top"}).addEvent(Affinity.events.click,this.toggle).inject(this.calendarForm);this.toggleButton=new Element("div",{"class":"toggle-button",html:Affinity.icons.ArrowLineSmallDown}).store("state","closed").inject(this.titlebox);this.hiddenBox=new Element("div",{"class":"calendar-generator",style:"opacity: 0;"}).inject(this.target,"bottom");this.box=new Element("div",{"class":"calendarbox",style:"opacity:1"}).inject(this.hiddenBox);this.employeeBoxWrap=new Element("div",{"class":"calendarbox-wrapper"}).inject(this.box);this.leaveTypes=new Element("div",{"class":"leave-types",style:"padding-top: 26px;"}).setStyle("width","8%").inject(this.employeeBoxWrap,"top");this.historyContainer=new Element("div",{"class":"calendar-history",style:"display:inline-block;"}).setStyle("width",this.visibleWidth).inject(this.employeeBoxWrap);this.historyFrame=new Element("div",{"class":"calendar-history-frame employee-calendar-frame"}).setStyle("width","100%").inject(this.historyContainer);this.historyTitles=new Element("div",{"class":"calendar-history-titles"}).setStyle("width",this.totalWidth).inject(this.historyFrame);this.historySlider=new Element("div",{"class":"",html:""}).inject(this.box);this.scrollPosition=null;this.leaveRequest=new Request.JSON({onFailure:function(n){Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onSuccess:function(n){Affinity.leave.isErrorInJson(n,this._api,this._methodName)||this.getExisitingLeave(n.Data.LeaveTypeBlocks)}.bind(this)});this.holidayRequest=new Request.JSON({onFailure:function(n){Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onSuccess:function(n){Affinity.leave.isErrorInJson(n,this._api,this._methodName)||this.renderHolidays(n.Data)}.bind(this)});this.init();this.section.addEvent("calendarloaded",function(){this.box.inject(this.calendarForm);this.box.toggle();this.hide(!0),function(){this.section.setStyle("opacity",null)}.delay(500,this);this.hiddenBox.set("html","");Affinity.tooltips.processNew()}.bind(this))},hide:function(n){n||(this.scrollPosition=this.historyFrame.scrollLeft);this.toggleButton.set("html",Affinity.icons.ArrowLineSmallDown).store("state","closed");this.box.dissolve()},show:function(){this.toggleButton.set("html",Affinity.icons.ArrowLineSmallUp).store("state","open");this.box.reveal();this.historyFrame.scrollLeft=this.scrollPosition===null?this.scrollPosition=this.historyFrame.scrollWidth/2:this.scrollPosition},toggle:function(){this.toggleButton.retrieve("state")==="open"?this.hide():this.show()},init:function(){this.getHolidays();this.section.addEvent("myScheduleReturned",function(){this.buildHistoryFrames()}.bind(this))},myLeave:function(){var n=Affinity.login.profile.employeeNumber;this._methodName="ui.leaveCalandar.js -> myLeave";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"EmployeeLeaveCalendar/"+n+"/"+this.fromDate.format("%d-%b-%Y")+"/"+this.toDate.format("%d-%b-%Y"));this.leaveRequest&&this.leaveRequest.isRunning()&&this.leaveRequest.cancel();this.leaveRequest.url=this.leaveRequest.options.url=this._api;this.leaveRequest.get()},getHolidays:function(){var n=Affinity.login.profile.employeeNumber;this._methodName=" ui.leaveCalendar.js -> getHolidays";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"Holidays/"+n+"/"+Date.parse(this.fromDate).format("%d-%b-%Y")+"/"+Date.parse(this.toDate).format("%d-%b-%Y"));this.holidays={};this.dayStarts=this.today.clone().clearTime().set("Hours",8).set("Minutes",30);this.dayEnds=this.today.clone().clearTime().set("Hours",17).set("Minutes",30);this.weekends=[0,6];this.holidayRequest&&this.holidayRequest.isRunning()&&this.holidayRequest.cancel();this.holidayRequest.url=this.holidayRequest.options.url=this._api;this.holidayRequest.get()},renderHolidays:function(n){Array.each(n,function(n){var t="t"+Date.parse(n.Date).clone().clearTime().format("%s");this.holidays[t]=n.Name}.bind(this));this.section.fireEvent("myScheduleReturned")},getExisitingLeave:function(n){var t={};t.myleave=[];t.myleave.push(n);this.processExistingLeave(t)},buildHistoryFrames:function(){for(var n=this.fromDate.clone().clearTime(),u,f,i,r,o,e,t=0;t<this.days;t++)(t===0||n.getDate()===1)&&(u=this.segmentWidth*n.get("lastdayofmonth"),t===0&&(u=this.segmentWidth*(n.get("lastdayofmonth")-this.fromDate.getDate()+1)),new Element("div").addClass("title").setStyle("width",u+"px").set("html",n.format("%B %Y")).inject(this.historyTitles)),r=n.format("%A %B %e%o %Y"),f="calendar-history-segment ui-has-tooltip ",n.clearTime().getTime()==this.today.clearTime().getTime()&&(f+="today ",r+="<br />Today"),i="bottom",n.getDate()===1&&(i+=" month"),this.weekends.contains(n.getDay())&&(i+=" weekend"),this.holidays["t"+n.format("%s")]&&(i+=" holiday",r+="<br />"+this.holidays["t"+n.format("%s")]),o=t<this.days/2?"top,right":"top,left",e=new Element("div",{"class":f,"data-tooltip":r,"data-tooltip-dir":o}).adopt(new Element("div",{"class":"top"}),new Element("div",{"class":i})).inject(this.historyFrame),e.store("date",n.clone()),e.setStyles({width:this.segmentWidth,left:this.segmentWidth*t}),n.increment("day",1);this.historyTitles.setStyle("width",this.segmentWidth*t);this.fromDate.getDate()>15&&this.historyTitles.getElement(".title").set("html","");this.toDate.getDate()<15?this.historyTitles.getLast(".title").destroy():this.historyTitles.getLast(".title").setStyle("width","auto");this.myLeave()},processExistingLeave:function(n){var u=20,f,e,o,r,t,i=this,s;this.currentFocusedDay=undefined;this.currentTooltip=undefined;s=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0);n.myleave&&n.myleave.length>0&&(document.addEventListener("scroll",function(){i.currentFocusedDay&&(i.currentFocusedDay.removeClass("focused"),i.currentTooltip&&i.currentTooltip.remove(),i.currentTooltip=undefined,i.currentFocusedDay=undefined,document.getElementById("calendarToolTipOverlay").remove())}),Array.each(n.myleave[0],function(n){var i=0,h;this.leaveCodeBox=new Element("div",{"class":"leave-code"}).inject(this.leaveTypes);this.leaveCodeTitle=new Element("div",{"class":"leave-code-title",html:n.CodeDescription}).inject(this.leaveCodeBox);n.ApprovedBlocks.length>0&&(i+=1,Array.each(n.ApprovedBlocks,function(i){var c,h;f=Math.round((Date.parse(i.DateTo).getTime()-Date.parse(i.DateFrom).getTime())/864e5)+1;e=f*this.segmentWidth;c=this.fromDate.getFullYear()+"-"+(this.fromDate.getMonth()+1)+"-"+this.fromDate.getDate()+"T00:00:00";o=Math.round((Date.parse(i.DateFrom).getTime()-Date.parse(c).getTime())/864e5)*this.segmentWidth;r="calendar-history-item";r+=" ui-has-tooltip";t="<h1 class='"+r+"'>Approved<\/h1>";t+="<strong>"+n.CodeDescription+"<\/strong><br />";Array.each(i.LeaveApplications,function(n){t+="<div class='details'>";t+="<strong>Leave ID<\/strong> "+n.TSGroupId+"<br />";t+="<strong>From<\/strong> "+Date.parse(n.DateFrom).format("%A %B %e%o %Y")+"<br />";t+="<strong>To<\/strong> "+Date.parse(n.DateTo).format("%A %B %e%o %Y")+"<br />";t+="<\/div>"});h=new Element("div").addClass(r).addClass("approved").setStyles({"margin-left":o,width:e,top:u});s>=768?(h.set("data-tooltip",t),h.set("data-tooltip-direction","top")):h.set("data-content",t);h.store("leave",i).inject(this.historyFrame)}.bind(this)),u+=25);n.SubmittedBlocks.length>0&&(i+=1,Array.each(n.SubmittedBlocks,function(i){var c,h;f=Math.round((Date.parse(i.DateTo).getTime()-Date.parse(i.DateFrom).getTime())/864e5)+1;e=f*this.segmentWidth;c=this.fromDate.getFullYear()+"-"+(this.fromDate.getMonth()+1)+"-"+this.fromDate.getDate()+"T00:00:00";o=Math.round((Date.parse(i.DateFrom).getTime()-Date.parse(c).getTime())/864e5)*this.segmentWidth;r="calendar-history-item";r+=" ui-has-tooltip";t="<h1 class='"+r+"'>Submitted<\/h1>";t+="<strong>"+n.CodeDescription+"<\/strong><br />";Array.each(i.LeaveApplications,function(n){t+="<div class='details'>";t+="<strong>Leave ID<\/strong> "+n.TSGroupId+"<br />";t+="<strong>From<\/strong> "+Date.parse(n.DateFrom).format("%A %B %e%o %Y")+"<br />";t+="<strong>To<\/strong> "+Date.parse(n.DateTo).format("%A %B %e%o %Y")+"<br />";t+="<\/div>"});h=new Element("div").addClass(r).addClass("submitted").setStyles({"margin-left":o,width:e,top:u});s>=768?(h.set("data-tooltip",t),h.set("data-tooltip-direction","top")):h.set("data-content",t);h.store("leave",i).inject(this.historyFrame)}.bind(this)),u+=25);n.PendingBlocks.length>0&&(i+=1,Array.each(n.PendingBlocks,function(i){var c,h;f=Math.round((Date.parse(i.DateTo).getTime()-Date.parse(i.DateFrom).getTime())/864e5)+1;e=f*this.segmentWidth;c=this.fromDate.getFullYear()+"-"+(this.fromDate.getMonth()+1)+"-"+this.fromDate.getDate()+"T00:00:00";o=Math.round((Date.parse(i.DateFrom).getTime()-Date.parse(c).getTime())/864e5)*this.segmentWidth;r="calendar-history-item";r+=" ui-has-tooltip";t="<h1 class='"+r+"'>Pending<\/h1>";t+="<strong>"+n.CodeDescription+"<\/strong><br />";Array.each(i.LeaveApplications,function(n){t+="<div class='details'>";t+="<strong>Leave ID<\/strong> "+n.TSGroupId+"<br />";t+="<strong>From<\/strong> "+Date.parse(n.DateFrom).format("%A %B %e%o %Y")+"<br />";t+="<strong>To<\/strong> "+Date.parse(n.DateTo).format("%A %B %e%o %Y")+"<br />";t+="<\/div>"});h=new Element("div").addClass(r).addClass("pending").setStyles({"margin-left":o,width:e,top:u});s>=768?(h.set("data-tooltip",t),h.set("data-tooltip-direction","top")):h.set("data-content",t);h.store("leave",i).inject(this.historyFrame)}.bind(this)),u+=25);n.DeclinedBlocks.length>0&&(i+=1,Array.each(n.DeclinedBlocks,function(i){var c,h;f=Math.round((Date.parse(i.DateTo).getTime()-Date.parse(i.DateFrom).getTime())/864e5)+1;e=f*this.segmentWidth;c=this.fromDate.getFullYear()+"-"+(this.fromDate.getMonth()+1)+"-"+this.fromDate.getDate()+"T00:00:00";o=Math.round((Date.parse(i.DateFrom).getTime()-Date.parse(c).getTime())/864e5)*this.segmentWidth;r="calendar-history-item";r+=" ui-has-tooltip";t="<h1 class='"+r+"'>Declined<\/h1>";t+="<strong>"+n.CodeDescription+"<\/strong><br />";Array.each(i.LeaveApplications,function(n){t+="<div class='details'>";t+="<strong>Leave ID<\/strong> "+n.TSGroupId+"<br />";t+="<strong>From<\/strong> "+Date.parse(n.DateFrom).format("%A %B %e%o %Y")+"<br />";t+="<strong>To<\/strong> "+Date.parse(n.DateTo).format("%A %B %e%o %Y")+"<br />";t+="<\/div>"});h=new Element("div").addClass(r).addClass("declined").setStyles({"margin-left":o,width:e,top:u});s>=768?(h.set("data-tooltip",t),h.set("data-tooltip-direction","top")):h.set("data-content",t);h.store("leave",i).inject(this.historyFrame)}.bind(this)),u+=25);new Element("div",{style:"border-bottom:1px solid lightgrey; position:absolute;"}).setStyles({width:this.totalWidth,top:u+5}).inject(this.historyFrame);h=i*25+5;this.leaveCodeBox.setStyle("height",h);u+=5}.bind(this)));this.historyFrame.setStyle("height",u+25);this.leaveTypes.setStyle("height",u+25);Affinity.tooltips.processNew();this.buildHistoryControls.delay(100,this);s<768&&$$(".employee-calendar-frame .calendar-history-item").addEvent("click",function(n){if(n.stopPropagation(),!i.currentFocusedDay){i.currentFocusedDay=n.target;i.currentFocusedDay.addClass("focused");var t=i.currentFocusedDay.getBoundingClientRect();i.currentTooltip=new Element("div").addClass("calendar-history-day").set("html",i.currentFocusedDay.get("data-content")).inject(document.body);i.currentTooltip.setStyles({top:t.top-i.currentTooltip.offsetHeight-t.height});new Element("div").addClass("calendar-history-day-overlay").set("id","calendarToolTipOverlay").addEvent("touchstart",function(n){n.stopPropagation();n.target.remove();i.currentFocusedDay.removeClass("focused");i.currentTooltip&&i.currentTooltip.remove();i.currentTooltip=undefined;i.currentFocusedDay=undefined}).inject(document.body)}})},buildHistoryControls:function(){var r,i,n,t;this.historyFrame.scrollWidth>this.historyFrame.clientWidth&&(this.histroryFrameSize=this.historyFrame.measure(function(){return this.getSize()}),Affinity.mobile||(this.histroryFrameSize.x-=Affinity.scrollBarSize*1.5),this.keyScale=this.histroryFrameSize.x/this.totalWidth,r=this.histroryFrameSize.y,i=new Element("div",{id:"keyWrapper"}),i.setStyles({width:"100%",height:r*this.keyScale,margin:"20px 0 30px 0",border:"1px solid #ccc",overflow:"hidden"}),i.inject(this.historyContainer),this.historyKey=this.historyFrame.clone(),this.historyKey.setStyles({width:this.totalWidth,"transform-origin":"0 0",transform:"scale("+this.keyScale+","+this.keyScale+")",overflow:"hidden"}),this.historyKey.addClass("historyKey"),this.historyKey.inject(i),n=this.historyKey.getPosition(this.historyContainer),t=this.historyKey.getSize(),this.keyButton=new Element("div").addClass("history-key-button has-events").setStyles({width:t.x,height:t.y,top:n.y,left:n.x}).addEvent(Affinity.events.click,this.positionKeyMarker).inject(this.historyKey,"after"),this.keyMarkerWidth=t.x*this.keyScale,this.keyButtonMarker=new Element("div").addClass("history-key-button-marker").addClass("mine").setStyles({width:this.keyMarkerWidth,height:t.y+20,top:n.y-10,left:n.x}).inject(this.keyButton,"after"),new Drag(this.keyButtonMarker,{limit:{x:[0,this.histroryFrameSize.x-this.keyMarkerWidth-2],y:[0,0]},modifiers:{x:"margin-left",y:"margin-top"},onDrag:this.scrollFromMarker}),this.historyFrame.addEvent("scroll",this.positionKeyMarkerOnScroll),this.section.addEvent("LeaveCalendarScroll",function(n){this.historyFrame.scrollTo((this.totalWidth-this.histroryFrameSize.x)*n,0)}.bind(this)),delete n,delete t);this.box.setStyle("opacity",1).set("reveal",{duration:250});prompts.hide();this.section.fireEvent("calendarloaded")},scrollFromMarker:function(){var n=this.totalWidth-this.histroryFrameSize.x,t=this.histroryFrameSize.x-this.keyMarkerWidth-2,i=this.keyButtonMarker.getPosition(this.historyContainer).x-this.keyButton.getPosition(this.historyContainer).x;this.historyFrame.scrollTo(n*(i/t),0);delete n;delete t;delete i},positionKeyMarker:function(n){var t=n.client.x-this.keyButton.getPosition(this.historyContainer).x-this.keyMarkerWidth/2;t=t<0?0:t>this.histroryFrameSize.x-this.keyMarkerWidth?this.histroryFrameSize.x-this.keyMarkerWidth:t;this.keyButtonMarker.setStyle("margin-left",t);this.scrollFromMarker();delete t},positionKeyMarkerOnScroll:function(){var t=this.totalWidth-this.histroryFrameSize.x,n=this.historyFrame.getScroll().x,i=n/t;this.keyButtonMarker.setStyle("margin-left",n*this.keyScale);this.section.fireEvent("LeaveHistoryScroll",i);delete t;delete n;delete i},reset:function(){this.leaveRequest&&this.leaveRequest.isRunning()&&this.leaveRequest.cancel();this.holidayRequest&&this.holidayRequest.isRunning()&&this.holidayRequest.cancel()},destroy:function(){if(this.reset(),this.section){this.section.removeEvents();try{this.titlebox.removeEvents()}catch(n){}try{this.historyFrame.removeEvents()}catch(n){}Array.each(this.section.getElements(".has-events"),function(n){n.removeEvents()});Array.each(this.section.getElements(".button"),function(n){n.removeEvents()});this.section.empty();this.section.destroy()}}}),UITeamLeaveCalendar=new Class({Implements:[Options,Events],Binds:["hide","show","toggle","init","buildHistoryFrames","getHolidays","teamLeave","processExistingLeave","buildHistoryControls","scrollFromMarker","positionKeyMarker","positionKeyMarkerOnScroll","reset","destroy"],options:{target:null,fromDate:!1,toDate:!1,startDay:0},initialize:function(n){this.setOptions(n);this.width="90%";this.today=new Date;this.currentMonth=Date.parse(this.options.fromDate).getMonth()+1;this.fromDate=Date.parse(this.options.fromDate);this.toDate=Date.parse(this.options.toDate);this.days=Math.ceil((this.toDate-this.fromDate)/864e5);this.visibleWidth="90%";this.segmentWidth=this.days*20<this.width?this.width/this.days:20;this.totalWidth=this.segmentWidth*this.days;this.target=this.options.target;this.section=new Element("div",{"class":"section calendar-section"}).adopt(new Element("div",{"class":"section-body"}).adopt(this.calendarForm=new Element("div",{"class":"default-form team-leave-calendar-form"}))).inject(this.target);this.section.setStyle("opacity",0);this.titlebox=new Element("div",{"class":"section-title ui-has-tooltip",html:"Team Leave Calendar","data-tooltip":"Open / Close","data-tooltip-dir":"top"}).addEvent(Affinity.events.click,this.toggle).inject(this.calendarForm);this.toggleButton=new Element("div",{"class":"toggle-button",html:Affinity.icons.ArrowLineSmallDown}).store("state","closed").inject(this.titlebox);this.hiddenBox=new Element("div",{"class":"team-calendar-generator",style:"opacity: 0;"}).inject(this.target,"bottom");this.box=new Element("div",{"class":"team-calendarbox",style:"opacity:1"}).inject(this.hiddenBox);this.teamBoxWrap=new Element("div",{"class":"calendarbox-wrapper"}).inject(this.box);this.teamMembers=new Element("div",{"class":"team-members"}).setStyle("width","8%").inject(this.teamBoxWrap,"top");this.historyContainer=new Element("div",{"class":"calendar-history",style:"display:inline-block"}).setStyle("width",this.visibleWidth).inject(this.teamBoxWrap);this.historyFrame=new Element("div",{"class":"calendar-history-frame employee-team-calendar-frame"}).setStyle("width","100%").inject(this.historyContainer);this.historyTitles=new Element("div",{"class":"calendar-history-titles"}).setStyle("width",this.totalWidth).inject(this.historyFrame);this.historySlider=new Element("div",{"class":"",html:""}).inject(this.box);this.scrollPosition=null;this.leaveRequest=new Request.JSON({onFailure:function(n){Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onSuccess:function(n){Affinity.leave.isErrorInJson(n,this._api,this._methodName)||this.processExistingLeave(n.Data)}.bind(this)});this.holidayRequest=new Request.JSON({onFailure:function(n){Affinity.leave.handleXHRErrors(n,this._api,this._methodName)},onSuccess:function(n){Affinity.leave.isErrorInJson(n,this._api,this._methodName)||this.renderHolidays(n.Data)}.bind(this)});this.init();this.section.addEvent("teamcalendarloaded",function(){this.box.inject(this.calendarForm);this.box.toggle();this.hide(!0),function(){this.section.setStyle("opacity",null)}.delay(500,this);this.hiddenBox.set("html","");Affinity.tooltips.processNew()}.bind(this))},hide:function(n){n||(this.scrollPosition=this.historyFrame.scrollLeft);this.toggleButton.set("html",Affinity.icons.ArrowLineSmallDown).store("state","closed");this.box.dissolve()},show:function(){this.toggleButton.set("html",Affinity.icons.ArrowLineSmallUp).store("state","open");this.box.reveal();this.historyFrame.scrollLeft=this.scrollPosition===null?this.scrollPosition=this.historyFrame.scrollWidth/2:this.scrollPosition},toggle:function(){this.toggleButton.retrieve("state")==="open"?this.hide():this.show()},init:function(){this.getHolidays();this.section.addEvent("teamScheduleReturned",function(){this.buildHistoryFrames()}.bind(this))},teamLeave:function(){var n=Affinity.login.profile.employeeNumber;this._methodName="ui.teamCalendar.js -> teamLeave";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"EmployeeTeamCalendar/"+this.fromDate.format("%d-%b-%Y")+"/"+this.toDate.format("%d-%b-%Y"));this.leaveRequest&&this.leaveRequest.isRunning()&&this.leaveRequest.cancel();this.leaveRequest.url=this.leaveRequest.options.url=this._api;this.leaveRequest.get()},getHolidays:function(){var n=Affinity.login.profile.employeeNumber;this._methodName="ui.teamCalendar.js -> getHolidays";this._api=Affinity.GetCacheSafePath(Affinity.leave.apiroot+"Holidays/"+n+"/"+Date.parse(this.fromDate).format("%d-%b-%Y")+"/"+Date.parse(this.toDate).format("%d-%b-%Y"));this.holidays={};this.dayStarts=this.today.clone().clearTime().set("Hours",8).set("Minutes",30);this.dayEnds=this.today.clone().clearTime().set("Hours",17).set("Minutes",30);this.weekends=[0,6];this.holidayRequest&&this.holidayRequest.isRunning()&&this.holidayRequest.cancel();this.holidayRequest.url=this.holidayRequest.options.url=this._api;this.holidayRequest.get()},renderHolidays:function(n){Array.each(n,function(n){var t="t"+Date.parse(n.Date).clone().clearTime().format("%s");this.holidays[t]=n.Name}.bind(this));this.section.fireEvent("teamScheduleReturned")},buildHistoryFrames:function(){for(var n=this.fromDate.clone().clearTime(),u,f,i,r,o,e,t=0;t<this.days;t++)(t===0||n.getDate()===1)&&(u=this.segmentWidth*n.get("lastdayofmonth"),t===0&&(u=this.segmentWidth*(n.get("lastdayofmonth")-this.fromDate.getDate()+1)),new Element("div").addClass("title").setStyle("width",u+"px").set("html",n.format("%B %Y")).inject(this.historyTitles)),r=n.format("%A %B %e%o %Y"),f="calendar-history-segment ui-has-tooltip ",n.clearTime().getTime()==this.today.clearTime().getTime()&&(f+="today ",r+="<br />Today"),i="bottom",n.getDate()===1&&(i+=" month"),this.weekends.contains(n.getDay())&&(i+=" weekend"),this.holidays["t"+n.format("%s")]&&(i+=" holiday",r+="<br />"+this.holidays["t"+n.format("%s")]),o=t<this.days/2?"top,right":"top,left",e=new Element("div",{"class":f,"data-tooltip":r,"data-tooltip-dir":o}).adopt(new Element("div",{"class":"top"}),new Element("div",{"class":i})).inject(this.historyFrame),e.store("date",n.clone()),e.setStyles({width:this.segmentWidth,left:this.segmentWidth*t}),n.increment("day",1);this.historyTitles.setStyle("width",this.segmentWidth*t);this.fromDate.getDate()>15&&this.historyTitles.getElement(".title").set("html","");this.toDate.getDate()<15?this.historyTitles.getLast(".title").destroy():this.historyTitles.getLast(".title").setStyle("width","auto");this.teamLeave()},processExistingLeave:function(n){var r=27,e,o,s,u,i,t=this,f;this.currentFocusedDay=undefined;this.currentTooltip=undefined;f=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0);n&&n.length>0?(document.addEventListener("scroll",function(){t.currentFocusedDay&&(t.currentFocusedDay.removeClass("focused"),t.currentTooltip&&t.currentTooltip.remove(),t.currentTooltip=undefined,t.currentFocusedDay=undefined,document.getElementById("calendarToolTipOverlay").remove())}),Array.each(n,function(n){this.teamMemberName=new Element("div",{"class":"team-members-name",html:n.EmployeeName}).inject(this.teamMembers);Array.each(n.LeaveBlocks,function(n){var h,t;e=Math.round((Date.parse(n.DateTo).getTime()-Date.parse(n.DateFrom).getTime())/864e5)+1;o=e*this.segmentWidth;h=this.fromDate.getFullYear()+"-"+(this.fromDate.getMonth()+1)+"-"+this.fromDate.getDate()+"T00:00:00";s=Math.round((Date.parse(n.DateFrom).getTime()-Date.parse(h).getTime())/864e5)*this.segmentWidth;u="calendar-history-item";u+=" ui-has-tooltip";i="<div class='details'>";i+="<strong>From<\/strong> "+Date.parse(n.DateFrom).format("%A %B %e%o %Y")+"<br />";i+="<strong>To<\/strong> "+Date.parse(n.DateTo).format("%A %B %e%o %Y")+"<br />";i+="<\/div>";t=new Element("div").addClass(u).addClass("approved").setStyles({"margin-left":s,width:o,top:r});f>=768?(t.set("data-tooltip",i),t.set("data-tooltip-direction","top")):t.set("data-content",i);t.inject(this.historyFrame)}.bind(this));r+=35}.bind(this)),this.historyFrame.setStyle("height",r+25),this.teamMembers.setStyle("height",r+25),Affinity.tooltips.processNew(),this.buildHistoryControls.delay(100,this),this.teamMembers.removeClass("hidden"),f<768&&$$(".employee-team-calendar-frame .calendar-history-item").addEvent("click",function(n){if(n.stopPropagation(),!t.currentFocusedDay){t.currentFocusedDay=n.target;t.currentFocusedDay.addClass("focused");var i=t.currentFocusedDay.getBoundingClientRect();t.currentTooltip=new Element("div").addClass("calendar-history-day").set("html",t.currentFocusedDay.get("data-content")).inject(document.body);t.currentTooltip.setStyles({top:i.top-t.currentTooltip.offsetHeight-i.height});new Element("div").addClass("calendar-history-day-overlay").set("id","calendarToolTipOverlay").addEvent("touchstart",function(n){n.stopPropagation();n.target.remove();t.currentFocusedDay.removeClass("focused");t.currentTooltip&&t.currentTooltip.remove();t.currentTooltip=undefined;t.currentFocusedDay=undefined}).inject(document.body)}})):(this.section.addClass("hidden"),this.hiddenBox.addClass("hidden"))},buildHistoryControls:function(){var r,i,n,t;this.historyFrame.scrollWidth>this.historyFrame.clientWidth&&(this.histroryFrameSize=this.historyFrame.measure(function(){return this.getSize()}),Affinity.mobile||(this.histroryFrameSize.x-=Affinity.scrollBarSize*1.5),this.keyScale=this.histroryFrameSize.x/this.totalWidth,r=this.historyFrame.getSize().y,i=new Element("div",{id:"keyWrapper"}),i.setStyles({width:this.histroryFrameSize.x,height:r*this.keyScale,margin:"20px 0 30px 0",border:"1px solid #ccc",overflow:"hidden"}),i.inject(this.historyContainer),this.historyKey=this.historyFrame.clone(),this.historyKey.setStyles({width:this.totalWidth,"transform-origin":"0 0",transform:"scale("+this.keyScale+","+this.keyScale+")",overflow:"hidden"}),this.historyKey.addClass("historyKey"),this.historyKey.inject(i),n=this.historyKey.getPosition(this.historyContainer),t=this.historyKey.getSize(),this.keyButton=new Element("div").addClass("history-key-button has-events").setStyles({width:t.x,height:t.y,top:n.y,left:n.x}).addEvent(Affinity.events.click,this.positionKeyMarker).inject(this.historyKey,"after"),this.keyMarkerWidth=t.x*this.keyScale,this.keyButtonMarker=new Element("div").addClass("history-key-button-marker").setStyles({width:this.keyMarkerWidth,height:t.y+20,top:n.y-10,left:n.x}).inject(this.keyButton,"after"),new Drag(this.keyButtonMarker,{limit:{x:[0,this.histroryFrameSize.x-this.keyMarkerWidth-2],y:[0,0]},modifiers:{x:"margin-left",y:"margin-top"},onDrag:this.scrollFromMarker}),this.historyFrame.addEvent("scroll",this.positionKeyMarkerOnScroll),this.section.addEvent("teamLeaveCalendarScroll",function(n){this.historyFrame.scrollTo((this.totalWidth-this.histroryFrameSize.x)*n,0)}.bind(this)),delete n,delete t);this.box.setStyle("opacity",1).set("reveal",{duration:250});prompts.hide();this.section.fireEvent("teamcalendarloaded")},scrollFromMarker:function(){var n=this.totalWidth-this.histroryFrameSize.x,t=this.histroryFrameSize.x-this.keyMarkerWidth-2,i=this.keyButtonMarker.getPosition(this.historyContainer).x-this.keyButton.getPosition(this.historyContainer).x;this.historyFrame.scrollTo(n*(i/t),0);delete n;delete t;delete i},positionKeyMarker:function(n){var t=n.client.x-this.keyButton.getPosition(this.historyContainer).x-this.keyMarkerWidth/2;t=t<0?0:t>this.histroryFrameSize.x-this.keyMarkerWidth?this.histroryFrameSize.x-this.keyMarkerWidth:t;console.log("positionKeyMarker");this.keyButtonMarker.setStyle("margin-left",t);this.scrollFromMarker();delete t},positionKeyMarkerOnScroll:function(){var t=this.totalWidth-this.histroryFrameSize.x,n=this.historyFrame.getScroll().x,i=n/t;this.keyButtonMarker.setStyle("margin-left",n*this.keyScale);this.section.fireEvent("teamLeaveHistoryScroll",i);delete t;delete n;delete i},reset:function(){this.leaveRequest&&this.leaveRequest.isRunning()&&this.leaveRequest.cancel();this.holidayRequest&&this.holidayRequest.isRunning()&&this.holidayRequest.cancel()},destroy:function(){if(this.reset(),this.section){this.section.removeEvents();try{this.titlebox.removeEvents()}catch(n){}try{this.historyFrame.removeEvents()}catch(n){}Array.each(this.section.getElements(".has-events"),function(n){n.removeEvents()});Array.each(this.section.getElements(".button"),function(n){n.removeEvents()});this.section.empty();this.section.destroy()}}})