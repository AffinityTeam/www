var Favourites,FavouriteRow,Settings,Statistics,Timesheets,DashboardWrapper;Affinity.Components=Affinity.Components||{},Affinity.Components.Favourites={Version:"1.0.10.0",Sequence:10030,Name:"Favourites",File:"ts.favourites.js",Jira:"",Notes:"Add hide new master laoder"},Favourites=new Class({Implements:[Options,Events],Binds:["init","dashboardLoginDelayHack","getFavs","getEmployeeFavs","gotFavs","insertRow","processError","reset","checkMobileMenuSwipeOpen","mobileMenuOpen","mobileMenuClose","loggedin","loggedout"],options:{target:null},emptyRowTemplate:"",rowTemplate:"",initialize:function(n){this.setOptions(n),this.table=this.options.target,this.tbody=this.table.getElement("tbody"),this.emptyRowTemplate=this.tbody.getElement("tr").innerHTML,this.rowTemplate=this.tbody.getElement("tr.fav-row-template").innerHTML,this.reset(this.emptyRowTemplate)},employeeProfile:!1,init:function(){var n,t;if(this.baseLang=Affinity.languages.english.features,this.baseAppLang=Affinity.languages.english.application.timesheets.features,this.table.querySelectorAll("thead th")[0].innerHTML=this.baseAppLang.favourites.views.manage.columnName,this.table.querySelectorAll("thead th")[1].innerHTML=this.baseAppLang.favourites.views.manage.columnType,this.table.querySelectorAll("thead th")[2].innerHTML=this.baseAppLang.favourites.views.manage.columnFields,this.isManager=!1,this.employeNumer=!1,this.hasDates=!1,this.favs=[],this.tabBox=document.getElement(".section-nav ul").removeClass("hidden"),document.getElement("li#logout")&&(this.logoutButton=document.getElement("#logout"),Affinity.hasDashboardWrapper()?this.logoutButton.addClass("hidden"):(this.logoutButtonLabel=this.logoutButton.getElement("span.text"),Affinity.oldess?(this.logoutButtonLabel.set("html","Close"),this.logoutButton.addClass("ui-has-tooltip").set("data-tooltip","Will not log out of ESS").set("data-tooltip-dir","bottom")):this.logoutButtonLabel.set("html","Logout"))),Affinity.mobile){this.tabBoxContainer=document.getElement(".section-nav"),this.tabBoxButton=document.getElement(".section-nav-icon"),this.tabBoxButton.addEvent(Affinity.events.click,this.mobileMenuOpen),n=new Hammer(window,{domEvents:!0});n.on("panleft",this.checkMobileMenuSwipeOpen);n.on("panright",this.mobileMenuClose);window.addEvent("mobileback",this.mobileMenuClose),t=this.tabBox.getElement("li.link a"),t.removeEvents(),t.addEvent(Affinity.events.start,function(n){n.stopPropagation()}.bind(this))}return Affinity.isLoggedIn?(this.loggedin(),setTimeout(function(){window.addEvent("loggedin",this.loggedin),window.addEvent("loggedout",this.loggedout)}.bind(this),1e3)):(window.addEvent("loggedin",this.loggedin),window.addEvent("loggedout",this.loggedout)),Affinity.AwardModels={Widgets:[],closeAll:function(){Affinity.AwardModels.Widgets.forEach(function(n){n&&n.hasOwnProperty("close")&&typeof n.close=="function"&&n.close()})}},Affinity.HideMasterLoader(1e3),!0},dashboardLoginDelayHackPasses:0,dashboardLoginDelayHackTimer:!1,dashboardLoginDelayHack:function(){this.dashboardLoginDelayHackTimer=setTimeout(function(){clearTimeout(this.dashboardLoginDelayHackTimer),this.dashboardLoginDelayHackPasses++,Affinity.SessionLoginReady()&&Affinity.isloggedin?this.loggedin():this.dashboardLoginDelayHack()}.bind(this),1e3)},getFavsLoader:!1,getFavs:function(){window.scrollTo(0,0),Affinity.prompts.clearOnClose(),Affinity.prompts.hide(),this.reset('<span class="spinner small light"><\/span>'),this.isManager?this.getEmployeeFavs():this.getEmployeeFavs(this.employeNumer)},getEmployeeFavs:function(n){var t,i;t=Affinity.zelosroot+"?api=Favourite/GetFavouriteNamesExt",n&&(t+="&employeeNo="+n),i=new Request.JSON({method:"get",noCache:!0,url:t,onSuccess:function(n){if(JSON.Unauthorized(n))this.processError("Unauthorised");else{var t;n.hasOwnProperty("error")&&typeOf(n.error)==="string"?(t=n.error.trim()!==""?n.error.trim():Affinity.languages.english.generic.error,t=Affinity.CheckFavError(n,t),console.log(errorStr)):n.hasOwnProperty("errorMsg")&&typeOf(n.errorMsg)==="string"?(t=n.errorMsg.trim()!==""?n.errorMsg.trim():Affinity.languages.english.generic.error,t=Affinity.CheckFavError(n,t),console.log(errorStr)):typeOf(n)==="array"&&n.length>0?this.gotFavs(n):this.reset()}}.bind(this)}).get()},returnHash:function(n){var t=[];return Object.each(JSON.decode(n.Fields),function(n,i){t.push(i+":"+n)}),t.push("Type:"+n.Type),t.push("EmployeeNo:"+n.EmployeeNo),t.push("Name:"+n.Name),t.sort(),t=t.join(",")},gotFavs:function(n){if(this.favs=[],n.length===0){this.reset(this.emptyRowTemplate);return}this.favs=this.options.isManager?Affinity.FavResultSort(n,"Name","EmployeeName"):Affinity.FavResultSort(n,"Name"),this.tbody.empty();var i=[],t;Array.each(this.favs,function(n){t=this.returnHash(n),i.indexOf(t)===-1&&(i.push(t),n.Type=n.hasOwnProperty("Type")?n.Type:this.defaultType,n.EmployeeNo=n.hasOwnProperty("EmployeeNo")?parseInt(n.EmployeeNo):n.hasOwnProperty("Item1")?parseInt(n.Item1):"?",n.EmployeeName=n.hasOwnProperty("EmployeeName")?n.EmployeeName:n.hasOwnProperty("Item2")?n.Item2:"?",n.Name=n.hasOwnProperty("Name")?n.Name:n.hasOwnProperty("Item3")?n.Item3:"?",n.Fields=n.hasOwnProperty("Fields")?JSON.decode(n.Fields):n.hasOwnProperty("Item4")?JSON.decode(n.Item4):{},n.Created=n.hasOwnProperty("Created")?Date.parse(n.Created):new Date,this.insertRow(n))}.bind(this)),Affinity.uiGrid&&Affinity.uiGrid.zebra(this.table,"fav-row")},insertRow:function(n){var t=new FavouriteRow(n,this.rowTemplate,this);t.element.inject(this.tbody)},processError:function(n){this.reset(n)},reset:function(n){this.tbody.empty(),new Element("tr").adopt(new Element("td",{colspan:this.hasDates?5:4,html:n?n:this.baseAppLang.favourites.views.manage.none})).inject(this.tbody)},mobileCloseDelay:!1,checkMobileMenuSwipeOpen:function(n){Affinity.stopHammerEvent(n);var t=window.getSize().x,i=n.center.x+n.distance,r=t-i;r<30&&this.mobileMenuOpen()},mobileMenuOpen:function(n){Affinity.stopHammerEvent(n),clearTimeout(this.mobileCloseDelay),this.tabBoxContainer.addClass("open"),window.removeEvent(Affinity.events.start,this.mobileMenuClose),window.removeEvent("mobileback",this.mobileMenuClose),this.mobileCloseDelay=function(){window.addEvent(Affinity.events.start,this.mobileMenuClose),window.addEvent("mobileback",this.mobileMenuClose)}.delay(250,this)},mobileMenuClose:function(n){Affinity.stopHammerEvent(n),clearTimeout(this.mobileCloseDelay),this.tabBoxContainer.removeClass("open"),window.removeEvent(Affinity.events.start,this.mobileMenuClose),window.removeEvent("mobileback",this.mobileMenuClose)},loggedin:function(){document.getElement("li#logout")&&(Affinity.oldess&&Affinity.oldessLaunched?document.getElement("li#logout span.text").set("html","Close"):document.getElement("li#logout span.text").set("html","Logout")),Affinity.enableFavourites=!1,!Affinity.mobile&&Affinity.enableFavouritesGlobal&&Affinity.login.areas.Timesheet.hasOwnProperty("EnableFavourite")&&(Affinity.enableFavourites=Affinity.login.areas.Timesheet.EnableFavourite),this.isManager=Affinity.login&&Affinity.login.hasOwnProperty("areas")?Affinity.login.areas.Timesheet.IsManager:!1,this.employeNumer=Affinity.login&&Affinity.login.hasOwnProperty("profile")?Affinity.login.profile.employeeNumber:!1,this.getFavs()},loggedout:function(){window.onbeforeunload=function(){},this.reset(),this.isManager=!1,this.employeNumer=!1,this.hasDates=!1,this.favs=[],window.location.href="./"}}),FavouriteRow=new Class({Implements:[Events],Binds:["edit","del","destroy"],element:null,data:{},initialize:function(n,t,i){this.baseLang=Affinity.languages.english.features,this.baseAppLang=Affinity.languages.english.application.timesheets.features,this.data=n,this.parent=i,this.element=new Element("tr",{"class":"fav-row",html:t}),this.nameRow=this.element.getElement("td.fav-name"),this.typeRow=this.element.getElement("td.fav-type"),this.fieldsRow=this.element.getElement("td.fav-fields"),this.parent.hasDates&&(this.dateRow=this.element.getElement("td.fav-date")),this.buttonsRow=this.element.getElement("td.fav-buttons"),this.editButton=this.buttonsRow.getElement(".fav-edit-button"),this.delButton=this.buttonsRow.getElement(".fav-del-button"),this.nameRow.innerHTML=this.returnNameString(this.data),this.typeRow.innerHTML=this.returnTypeString(this.data),this.fieldsRow.innerHTML=this.returnFieldsString(this.data),this.parent.hasDates&&(this.dateRow.innerHTML=this.returnDateString(this.data)),this.editButton.addEvent("click",this.edit),this.delButton.addEvent("click",this.del)},returnNameString:function(n){var t=Affinity.login.profile.commonName;return n.hasOwnProperty("Name")&&(t=n.hasOwnProperty("EmployeeName")?n.EmployeeName+" - "+n.Name.replace("_"," "):n.Name.replace("_"," ")),t},returnTypeString:function(n){var t=parseInt(n.Type);switch(t){case 1:return"Timesheet ";case 2:return"Allowance ";case 3:return"Leave";case 4:return"Mileage";default:return""}},returnFieldsString:function(n){var t="",i=[];return n.hasOwnProperty("Fields")&&(t="Template contains '",typeOf(this.data.Fields)!=="object"?t+="no data":Object.each(this.data.Fields,function(n,t){(n+"").trim()!==""&&i.push(t+": "+n)}),t=i.join(", ")),t},returnDateString:function(n){var t=new Date;return n.hasOwnProperty("Created")&&(t=Date.parse(n.Created)),t.toWords()+" ("+t.toSimple()+" "+t.toTime12()+")"},edit:function(n,t){if(Affinity.enableFavourites){var i=Affinity.zelosroot+"?api=Favourite/RenameFavourite&timesheetType="+this.data.Type+"&employeeNo="+this.data.EmployeeNo+"&OldName="+this.data.Name+"&NewName=",r=this.baseAppLang.favourites.renameMessage;n&&typeof n=="string"&&(n=n.trim()!==""?n.trim():Affinity.languages.english.generic.error,n=Affinity.CheckFavError(result,errormsg),r=n+"<br />Please try again."),uiprompt({message:r,showButtons:!0,noClose:!1,value:typeOf(t)==="string"?t:this.data.Name,onOk:function(n){var t=this.baseLang.favourites.validation.validateName(n),r;if(!t.isValid){this.edit.delay(50,this,[t.error,n]);return}uialert({message:this.baseAppLang.favourites.renamingMessage+'<img src="'+Affinity.loaders.dark+'" />',noClose:!0}),i+=n.trim(),r=new Request.JSON({url:i,onComplete:function(n){if(n.hasOwnProperty("success")&&n.success===!1&&n.hasOwnProperty("error")&&typeOf(n.error)==="string"){var t=n.error.trim()!==""?n.error.trim():Affinity.languages.english.generic.error,t=Affinity.CheckFavError(n,t);uialert({message:"Oops! "+t+"<br />Please try again.",showButtons:!0,onClose:this.parent.getFavs});return}Affinity.uiPompts.hide(),this.parent.getFavs()}.bind(this),onFailure:function(){uialert({message:Affinity.languages.english.generic.error+"<br />Please try again.",showButtons:!0,onClose:this.parent.getFavs})}.bind(this),onError:function(n){var t=Affinity.CheckFavError(n,Affinity.languages.english.generic.error+"<br />Please try again.");uialert({message:t,showButtons:!0,onClose:this.parent.getFavs})}.bind(this)}).post()}.bind(this)})}},del:function(){if(Affinity.enableFavourites){var n=Affinity.zelosroot+"?api=Favourite/RemoveFavourite?employeeNo="+this.data.EmployeeNo+"&timesheetType="+this.data.Type+"&Name="+this.data.Name,t=this.baseAppLang.favourites.deleteMessage;Affinity,uiconfirm({message:t,showButtons:!0,noClose:!1,onOk:function(){uialert({message:this.baseAppLang.favourites.deletingMessage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0});var t=new Request.JSON({url:n,onComplete:function(n){if(n.hasOwnProperty("OK")&&n.OK===!1){var t=Affinity.languages.english.generic.error;n.hasOwnProperty("error")&&typeOf(n.error)==="string"&&(t=n.error.trim()!==""?n.error.trim():t),t=Affinity.CheckFavError(n,t),uialert({message:"Oops! "+t+"<br />Please try again.",showButtons:!0,onClose:this.parent.getFavs});return}Affinity.uiPompts.hide(),this.parent.getFavs()}.bind(this),onFailure:function(){uialert({message:Affinity.languages.english.generic.error+"<br />Please try again.",showButtons:!0,onClose:this.parent.getFavs})}.bind(this),onError:function(n){var t=Affinity.CheckFavError(n,Affinity.languages.english.generic.error+"<br />Please try again.");uialert({message:t,showButtons:!0,onClose:this.parent.getFavs})}}).post()}.bind(this)})}},destroy:function(){}}),Affinity.Components=Affinity.Components||{},Affinity.Components.Settings={Version:"1.0.4.0",Sequence:10020,Name:"Settings",File:"ts.settings.js",Jira:"",Notes:"Add hide new master laoder"},Settings=new Class({Implements:[Options,Events],Binds:["init","dashboardLoginDelayHack","checkMobileMenuSwipeOpen","mobileMenuOpen","mobileMenuClose","addShare","loadExistingShares","deleteShare","loggedin","loggedout"],options:{existingSharesTarget:null,newSharesTarget:null,managerLookupTarget:null},initialize:function(n){this.setOptions(n)},init:function(){var t,n;if(this.options.newSharesTarget.getElement(".addNewShare").addEvent(Affinity.events.click,this.addShare),this.tabBox=document.getElement(".section-nav ul").removeClass("hidden"),document.getElement("li#logout")&&(this.logoutButton=document.getElement("#logout"),Affinity.hasDashboardWrapper()?this.logoutButton.addClass("hidden"):(this.logoutButtonLabel=this.logoutButton.getElement("span.text"),Affinity.oldess?(this.logoutButtonLabel.set("html","Close"),this.logoutButton.addClass("ui-has-tooltip").set("data-tooltip","Will not log out of ESS").set("data-tooltip-dir","bottom")):this.logoutButtonLabel.set("html","Logout"))),Affinity.mobile){this.tabBoxContainer=document.getElement(".section-nav"),this.tabBoxButton=document.getElement(".section-nav-icon"),this.tabBoxButton.addEvent(Affinity.events.click,this.mobileMenuOpen),t=new Hammer(window,{domEvents:!0});t.on("panright",this.mobileMenuClose);window.addEvent("mobileback",this.mobileMenuClose),n=this.tabBox.getElement("li.link a"),n.removeEvents(),n.addEvent(Affinity.events.start,function(n){n.stopPropagation()}.bind(this))}else Array.each(document.getElements(".ui-mobile-calendar-buttons"),function(n){n.removeClass("ui-mobile-calendar-buttons"),n.addClass("ui-calendar-buttons")}),Array.each(document.getElements(".ui-mobile-calendar-button"),function(n){n.removeClass("ui-mobile-calendar-button"),n.addClass("ui-calendar-button")}),document.getElement(".ts-new-share").addClass("w-border");return Affinity.isLoggedIn?(this.loggedin(),setTimeout(function(){window.addEvent("loggedin",this.loggedin),window.addEvent("loggedout",this.loggedout)}.bind(this),1e3)):(window.addEvent("loggedin",this.loggedin),window.addEvent("loggedout",this.loggedout)),Affinity.AwardModels={Widgets:[],closeAll:function(){Affinity.AwardModels.Widgets.forEach(function(n){n&&n.hasOwnProperty("close")&&typeof n.close=="function"&&n.close()})}},Affinity.HideMasterLoader(1e3),!0},dashboardLoginDelayHackPasses:0,dashboardLoginDelayHackTimer:!1,dashboardLoginDelayHack:function(){this.dashboardLoginDelayHackTimer=setTimeout(function(){clearTimeout(this.dashboardLoginDelayHackTimer),this.dashboardLoginDelayHackPasses++,Affinity.SessionLoginReady()&&Affinity.isloggedin?this.loggedin():this.dashboardLoginDelayHack()}.bind(this),1e3)},mobileCloseDelay:!1,checkMobileMenuSwipeOpen:function(n){Affinity.stopHammerEvent(n);var t=window.getSize().x,i=n.center.x+n.distance,r=t-i;r<30&&this.mobileMenuOpen()},mobileMenuOpen:function(n){Affinity.stopHammerEvent(n),clearTimeout(this.mobileCloseDelay),this.tabBoxContainer.addClass("open"),window.removeEvent(Affinity.events.start,this.mobileMenuClose),window.removeEvent("mobileback",this.mobileMenuClose),this.mobileCloseDelay=function(){window.addEvent(Affinity.events.start,this.mobileMenuClose),window.addEvent("mobileback",this.mobileMenuClose)}.delay(250,this)},mobileMenuClose:function(n){Affinity.stopHammerEvent(n),clearTimeout(this.mobileCloseDelay),this.tabBoxContainer.removeClass("open"),window.removeEvent(Affinity.events.start,this.mobileMenuClose),window.removeEvent("mobileback",this.mobileMenuClose)},asSelect:!1,insertManagercomponents:function(){if(!this.asSelect){if(Affinity.login.profile.employeeNumber>=5e6){var t=this.options.newSharesTarget,n=new Element("div",{"class":"form-row"}).inject(t,"top");new Element("label",{html:"Share / Delegate as"}).inject(n),this.asSelect=new Element("select",{"class":"has-lookup","data-lookup-api":Affinity.zelosroot+"?api=timesheetAsManager/GetManagers","data-default-value":Affinity.login.profile.employeeNumber,"data-lookup-rules":"hasValue"}).inject(n),this.asSelect.addEvent("change",this.loadExistingShares)}Affinity.lookups.processNew()}},loadExistingShares:function(){var i=this.options.existingSharesTarget,n=i.getElement("tbody"),t,r;n.empty(),this.insertManagercomponents(),new Element("tr").adopt(new Element("td",{colspan:5,html:"Loading..."})).inject(n),t=Affinity.zelosroot+"?api=Employee/GetNotifyApproval?",t+="notifyArea=Timesheet",this.asSelect&&(t+="&approver="+this.asSelect.value,t=t.replace(/GetNotifyApproval/,"GetNotifyApproval2")),r=new Request.JSON({url:Affinity.GetCacheSafePath(t),method:"get",onComplete:function(t){if(n.empty(),typeOf(t)=="array"&&t.length>0){Array.each(t,function(t){new Element("tr",{"data-share-id":t.Id}).adopt(new Element("td",{html:Date.parse(t.DateFrom).format("%a %b %e%o %Y")}),new Element("td",{html:Date.parse(t.DateTo).format("%a %b %e%o %Y")}),new Element("td",{html:t.ShareDelegate}),new Element("td",{html:t.AlternateApproverName,"data-employee-number":t.AlternateApprover}),new Element("td",{"class":"buttons"}).adopt(new Element("span",{"class":"button red w-icon"}).adopt(new Element("span",{html:Affinity.icons.Cross}),new Element("span",{html:"Delete"})).addEvent(Affinity.events.click,this.deleteShare))).store("data",t).inject(n)}.bind(this));try{Affinity.uiGrid.zebra(i)}catch(r){}}else new Element("tr").adopt(new Element("td",{colspan:5,html:"Nothing to view"})).inject(n)}.bind(this),onError:function(){n.empty(),new Element("tr").adopt(new Element("td",{colspan:5,html:"Nothing to view"})).inject(n)}.bind(this),onFailure:function(){n.empty(),new Element("tr").adopt(new Element("td",{colspan:5,html:"Nothing to view"})).inject(n)}.bind(this)}).send(),delete n,delete thead},addShare:function(){var i=this.options.newSharesTarget,r=Date.parse(i.getElement("#date-from").value),n=Date.parse(i.getElement("#date-to").value),u=!1,f,e,o,t,s;typeOf(r)==="date"&&"isValid"in r&&r.isValid()&&typeOf(n)==="date"&&"isValid"in n&&n.isValid()&&(u=!0),u&&((r>n||n<r)&&(f=new Date(r),r=n,n=f,e=Affinity.UI.calendars.widgets[i.getElement("#date-from").id],o=Affinity.UI.calendars.widgets[i.getElement("#date-to").id],e.setDate(r,!1),o.setDate(n,!1)),n<(new Date).clearTime()?uialert({message:"You can not share or delegate in the past",showButtons:!0}):(t=Affinity.zelosroot+"?api=Employee/PostNotifyApproval?",t+="dateFromInclusive="+i.getElement("#date-from").value+"&",t+="dateToInclusive="+i.getElement("#date-to").value+"&",t+="shareDelegate="+i.getElement("#method").value+"&",t+="alternateApprover="+i.getElement("#to").value+"&",t+="notifyArea=Timesheet",this.asSelect&&(t+="&approver="+this.asSelect.value,t=t.replace(/PostNotifyApproval/,"PostNotifyApproval2")),s=new Request.JSON({url:Affinity.GetCacheSafePath(t),method:"post",onComplete:function(n){if(typeOf(n)==="object"){if("success"in n&&typeOf(n.success)==="boolean"&&!n.success){var t=Affinity.languages.english.generic.error;"error"in n&&typeOf(n.error)==="string"&&n.error.trim()!==""?(t+="<br /><br />"+n.error.trim(),log("error: share / delegate failed with message: "+n.error.trim())):log("error: share / delegate failed with no error. Please check console."),uialert({message:t,showButtons:!0,noClose:!1});return}this.loadExistingShares(n)}else s.status===200?this.loadExistingShares(n):(log("error: share / delegate failed with no error. Please check console."),uialert({message:Affinity.languages.english.generic.error,showButtons:!0,noClose:!1}))}.bind(this),onError:function(){}.bind(this),onFailure:function(){}.bind(this)}).post())),delete i,delete r,delete n,delete u},deleteShare:function(n){var t=n.target.getParent("tr"),r=t.retrieve("data"),i="",u;i=Affinity.apiversion>1?Affinity.zelosroot+"?api=Employee/DeleteNotifyApproval?":Affinity.zelosroot.replace("ZelosProxy","ZelosProxyDelete")+"?api=Employee/DeleteNotifyApproval?",i+="id="+r.Id,t.getElement(".button.red").addClass("hidden"),t.getElement(".button.red").getParent().adopt(new Element("img",{"class":"loader",src:Affinity.loaders.light})),u=new Request.JSON({url:Affinity.GetCacheSafePath(i),method:"get",emulation:!1,onComplete:function(n){if(n&&n.success&&!n.success){var i=Affinity.languages.english.generic.error;n.Error&&(i+="<br />"+n.Error),uialert({message:i}),t.getElement(".button.red").removeClass("hidden"),t.getElement(".loader").destroy(),delete i}else this.loadExistingShares()}.bind(this),onError:function(n){uialert({message:Affinity.languages.english.generic.error+'<pre class="hidden">'+JSON.stringify(n,undefined,2)+"<\/pre>"})}.bind(this),onFailure:function(n){uialert({message:Affinity.languages.english.generic.error+'<pre class="hidden">'+JSON.stringify(n,undefined,2)+"<\/pre>"})}.bind(this)}).send(),delete t,delete r},loggedin:function(){document.getElement("li#logout")&&(Affinity.oldess&&Affinity.oldessLaunched?document.getElement("li#logout span.text").set("html","Close"):document.getElement("li#logout span.text").set("html","Logout"));var n=Affinity.zelosroot+"?api=Employee/GetNotifyManager";this.options.managerLookupTarget.addClass("has-lookup").set("data-lookup-api",Affinity.GetCacheSafePath(n)),Affinity.lookups.processNew(),this.loadExistingShares()},loggedout:function(){window.onbeforeunload=function(){};var n=this.options.managerLookupTarget.retrieve("widget"),i=this.options.existingSharesTarget,t=i.getElement("tbody");t.empty(),new Element("tr").adopt(new Element("td",{colspan:5,html:"Nothing to view"})).inject(t),n&&"revert"in n&&n.revert(),this.options.managerLookupTarget&&this.options.managerLookupTarget.empty(),delete i,delete t,window.location.href="./"}}),Affinity.Components=Affinity.Components||{},Affinity.Components.Statistics={Version:"1.0.4.0",Sequence:10010,Name:"Statistics",File:"ts.statistics.js",Jira:"",Notes:"Add hide new master laoder"},Statistics=new Class({Implements:[Options,Events],Binds:["init","dashboardLoginDelayHack","checkMobileMenuSwipeOpen","mobileMenuOpen","mobileMenuClose","mobileMenuCloseAndRedirectToHome","loadForm","getReport","loadReport","reportLoaded","doDownloadRequest","loggedin","loggedout"],options:{filterFormTarget:null,reportTarget:null,getReportSection:null,getReportButton:null,zelosHtmlTemplate:""},initialize:function(n){this.setOptions(n)},init:function(){var t,n;if(this.options.getReportButton.addEvent("click",this.getReport),this.downloadButton=!1,this.tabBox=document.getElement(".section-nav ul").removeClass("hidden"),document.getElement("li#logout")&&(this.logoutButton=document.getElement("#logout"),Affinity.hasDashboardWrapper()?this.logoutButton.addClass("hidden"):(this.logoutButtonLabel=this.logoutButton.getElement("span.text"),Affinity.oldess?(this.logoutButtonLabel.set("html","Close"),this.logoutButton.addClass("ui-has-tooltip").set("data-tooltip","Will not log out of ESS").set("data-tooltip-dir","bottom")):this.logoutButtonLabel.set("html","Logout"))),Affinity.mobile){this.tabBoxContainer=document.getElement(".section-nav"),this.tabBoxButton=document.getElement(".section-nav-icon"),this.tabBoxButton.addEvent(Affinity.events.click,this.mobileMenuOpen),t=new Hammer(window,{domEvents:!0});t.on("panright",this.mobileMenuClose);window.addEvent("mobileback",this.mobileMenuClose),n=this.tabBox.getElement("li.link a"),n.removeEvents(),n.addEvent(Affinity.events.start,function(n){n.stopPropagation()}.bind(this))}return Affinity.isLoggedIn?(this.loggedin(),setTimeout(function(){window.addEvent("loggedin",this.loggedin),window.addEvent("loggedout",this.loggedout)}.bind(this),1e3)):(window.addEvent("loggedin",this.loggedin),window.addEvent("loggedout",this.loggedout)),Affinity.AwardModels={Widgets:[],closeAll:function(){Affinity.AwardModels.Widgets.forEach(function(n){n&&n.hasOwnProperty("close")&&typeof n.close=="function"&&n.close()})}},Affinity.HideMasterLoader(1e3),!0},dashboardLoginDelayHackPasses:0,dashboardLoginDelayHackTimer:!1,dashboardLoginDelayHack:function(){this.dashboardLoginDelayHackTimer=setTimeout(function(){clearTimeout(this.dashboardLoginDelayHackTimer),this.dashboardLoginDelayHackPasses++,Affinity.SessionLoginReady()&&Affinity.isloggedin?this.loggedin():this.dashboardLoginDelayHack()}.bind(this),1e3)},mobileCloseDelay:!1,checkMobileMenuSwipeOpen:function(n){Affinity.stopHammerEvent(n);var i=window.getSize().x,r=n.center.x+n.distance,t=i-r;t<30&&t>0&&this.mobileMenuOpen()},mobileMenuOpen:function(n){Affinity.stopHammerEvent(n),clearTimeout(this.mobileCloseDelay),this.tabBoxContainer.addClass("open"),window.removeEvent(Affinity.events.start,this.mobileMenuClose),window.removeEvent("mobileback",this.mobileMenuClose),this.mobileCloseDelay=function(){window.addEvent(Affinity.events.start,this.mobileMenuClose),window.addEvent("mobileback",this.mobileMenuClose)}.delay(250,this)},mobileMenuClose:function(n){Affinity.stopHammerEvent(n),clearTimeout(this.mobileCloseDelay),this.tabBoxContainer.removeClass("open"),window.removeEvent(Affinity.events.start,this.mobileMenuClose),window.removeEvent("mobileback",this.mobileMenuClose)},mobileMenuCloseAndRedirectToHome:function(){this.mobileMenuClose(),window.location.href="Home"},loadForm:function(){var n,t,i;log("&#172; load form"),this.reportOptions={target:this.options.reportTarget,getApi:"",putApi:"none",onSaveError:function(){}.bind(this),beforSave:function(){}.bind(this),onSave:function(){}.bind(this),onComplete:function(){this.reportLoaded()}.bind(this),allowHorizontalScrollingForMobile:!1},this.reportLoader=new ZelosTemplateLoad({onRequest:function(){}.bind(this),onError:function(n){log("reportLoader failed: "+n),uialert({message:"Oops! Report failed to load.",noClose:!1,showLoader:!1,showButtons:!0})}.bind(this),onComplete:function(n){if(log("reportLoader completed: "+n),n&&typeOf(n.success)==="boolean"&&n.success===!1)uialert({message:"Oops! Something went wrong processing your report.",noClose:!1,showLoader:!1,showButtons:!0});else{Affinity.mobile&&(this.reportOptions.allowHorizontalScrollingForMobile=!0),this.options.reportTarget.empty();var t=new ZelosTemplateProcess(this.reportOptions);t.processTemplate(n)}}.bind(this)}),uialert({message:"Getting report filters",noClose:!0,showLoader:!0}),n=Affinity.zelosroot+"?api=timesheetInfo/GetTimesheetFormForStatsReport",log("form get Api: "+n),t={target:this.options.filterFormTarget,getApi:n,putApi:"none",onSaveError:function(){}.bind(this),beforSave:function(){}.bind(this),onSave:function(){}.bind(this),onComplete:function(){Affinity.prompts.hide(),this.reportTypeSelect=this.options.filterFormTarget.getElement("select"),this.options.getReportSection.removeClass("hidden")}.bind(this)},this.formProcessor=new ZelosTemplateProcess(t),i=new ZelosTemplateLoad({onRequest:function(){}.bind(this),onError:function(){uialert({message:"Oops! Could net get report filters.",noClose:!1,showLoader:!1,showButtons:!0})}.bind(this),onComplete:function(n){if(n&&typeOf(n.success)==="boolean"&&n.success===!1)uialert({message:"Oops! Something went wrong processing the report filters.",noClose:!1,showLoader:!1,showButtons:!0});else{var i=[],r=0,t=Object.clone(n);Array.each(n.Children[0].Children[0].Value,function(n,t){new RegExp("dashboard","gi").test(n.value)&&i.push(t)}),i.sort(),Array.each(i,function(n){t.Children[0].Children[0].Value.splice(n-r,1),t.Children.splice(n+1-r,1),r++}),t.Children[0].Children[0].ValueAsString=JSON.stringify(t.Children[0].Children[0].Value),this.formProcessor.processTemplate(t)}}.bind(this)}),i.loadTemplate(t.getApi)},getReport:function(){var r=this.reportTypeSelect.value,f=r.toLowerCase().replace(/ /g,"-").trim(),e=this.options.filterFormTarget.getElements(".section"),o=this.options.filterFormTarget.getElement(".ui-hideable-id-"+f),s=e.indexOf(o),h=this.formProcessor.template.Children[s].Children,n,i,u,t={};t.reportType=r,Array.each(h,function(r){n=this.formProcessor.fieldProcessor.readField(r,document.id(r.Name));switch(typeOf(n.Value)){case"array":switch(r.ElementType){case"MultiCheckBox":i=[],Array.each(n.Value,function(n){n.selected&&i.push(n.value)}),t[r.Source.PropertyName]=i.join(",");break;default:Array.each(n.Value,function(n){n.selected&&(t[r.Source.PropertyName]=n.value)})}break;case"boolean":case"string":t[r.Source.PropertyName]=n.Value}}.bind(this)),u=Affinity.zelosroot+"?api=timesheetInfo/GetTimesheetTableForStatsReport/?"+Object.toQueryString(t),this.loadReport(u)},loadReport:function(n){uialert({message:"Getting report",noClose:!0,showLoader:!0}),this.reportOptions.getApi=n,this.reportLoader.loadTemplate(this.reportOptions.getApi)},reportLoaded:function(){var t,n;for(Affinity.prompts.hide(),this.downloadButton&&this.downloadButton.removeEvents(),this.options.reportTarget.getElement(".custom-button")?(this.downloadButton=this.options.reportTarget.getElement(".custom-button"),this.downloadButton.addEvent(Affinity.events.click,this.doDownloadRequest)):this.downloadButton=!1,t=this.options.reportTarget.querySelectorAll(".zelos-table th"),n=0;n<t.length;n++)if(t[n].dataset.name.test(/Employee/gi)){t[n].click();return}},doDownloadRequest:function(){var n=this.reportOptions.getApi.replace("GetTimesheetTableForStatsReport","GetTimesheetTableForStatsReportCSV");window.open(n)},loggedin:function(){document.getElement("li#logout")&&(Affinity.oldess&&Affinity.oldessLaunched?document.getElement("li#logout span.text").set("html","Close"):document.getElement("li#logout span.text").set("html","Logout")),this.zelosEngine=new ZelosInit({htmlTemplateUrl:this.options.zelosHtmlTemplate,onRequest:function(){},onError:function(){},onComplete:function(){log("zelos engine initiated and ready"),this.loadForm()}.bind(this)})},loggedout:function(){this.options.reportTarget.empty(),this.options.filterFormTarget.empty(),window.onbeforeunload=function(){}}}),Affinity.Components=Affinity.Components||{},Affinity.Components.Timesheets={Version:"1.0.12.4",Sequence:1e4,Name:"Timesheets Master Controller",File:"ui.timesheets.js",Jira:"CT-1397",Notes:"Break Management"},Timesheets=new Class({Implements:[Options,Events],Binds:["init","checkMobileMenuSwipeOpen","mobileMenuOpen","mobileMenuClose","resetPanels","destroyTabs","buildTabs","enableTab","disableTab","selectTab","tabClcked","checkDependancyCacheClear","checkLookupCacheClear","continueRefresh","refresh","mobileMenuCloseAndEventPrevention","hasWidgetChanged","getWidget","refreshWidget","doSwitchToPeriodView","doSwitchToOverviewView","doSwitchToDualdetailView","doSwitchToEmployeeView","doSwitchToEmployeeDetailedView","doSwitchToManagerView","doSwitchToBulkView","doSwitchToMileageView","switchToPeriodView","switchToOverviewView","switchToDualdetailView","switchToEmployeeView","switchToEmployeeDetailedView","switchToManagerView","switchToBulkView","switchToMileageView","getperiodviewData","getOverviewDetails","getDualdetailTimesheet","getEmployeeTimesheet","getEmployeeDetailsTimesheet","getManagerTimesheet","getBulkTimesheet","sanatisePostDocument","sanatiseTimesheetDoc","toggleFilter","toggleAdd","destroy","cancelRequests","loggedin","loggedout","logout"],options:{periodTarget:null,overviewTarget:null,dualdetailTarget:null,managerTarget:null,employeeTarget:null,employeeDetailedTarget:null,bulkTarget:null,employeeMileageTarget:null,zelosHtmlTemplate:"",gotoTimesheet:"none",gotoEmployee:-1},overrideMileage:!1,overrideFavourites:!1,source:"internal",switchData:!1,affinityData:!1,isManager:!1,isEmployee:!1,managerLoader:!1,employeeLoader:!1,currentView:"employee",currentWidget:!1,periodWidget:!1,overviewWidget:!1,dualdetailWidget:!1,employeeWidget:!1,employeeDetailedWidget:!1,managerWidget:!1,bulkWidget:!1,employeeMileageWidget:!1,publicHolidays:[],lastButtonClicked:!1,initialize:function(n){this.setOptions(n),Affinity.timesheets||(Affinity.timesheets={}),Affinity.timesheets.methods||(Affinity.timesheets.methods={}),Affinity.timesheets.ready=!1,Affinity.acValues.maxDefault=parseInt(Affinity.acValues.maxDefault),Affinity.acValues.maxSlow=parseInt(Affinity.acValues.maxSlow),Affinity.acValues.maxFast=parseInt(Affinity.acValues.maxFast),Affinity.acValues.maxVeryFast=parseInt(Affinity.acValues.maxVeryFast),Affinity.acValues.defaultComps=Affinity.acValues.defaultComps.replace(new RegExp(" ","gi"),"").split(","),Affinity.acValues.slowComps=Affinity.acValues.slowComps!=="*"?Affinity.acValues.slowComps.replace(new RegExp(" ","gi"),"").split(","):Affinity.acValues.slowComps,Affinity.acValues.fastComps=Affinity.acValues.fastComps!=="*"?Affinity.acValues.fastComps.replace(new RegExp(" ","gi"),"").split(","):Affinity.acValues.fastComps,Affinity.acValues.veryFastComps=Affinity.acValues.veryFastComps!=="*"?Affinity.acValues.veryFastComps.replace(new RegExp(" ","gi"),"").split(","):Affinity.acValues.veryFastComps,Affinity.timesheets.init=this,Affinity.timesheets.methods.sanatisePostDocument=this.sanatisePostDocument,Affinity.timesheets.zelosHtmlTemplate=this.options.zelosHtmlTemplate,Affinity.viewSettings=new ZelosViewSettings,Affinity.AwardModels={Widgets:[],closeAll:function(){Affinity.AwardModels.Widgets.forEach(function(n){n&&n.hasOwnProperty("close")&&typeof n.close=="function"&&n.close()})}}},init:function(){var n,t;if(!Affinity.timesheets.ready){if(Affinity.timesheets.ready=!0,window.removeEvent("UiReady",this.init),this.tabBox=document.getElement(".section-nav ul").addClass("hidden"),this.tabBox.empty(),Affinity.mobile){this.tabBoxContainer=document.getElement(".section-nav"),this.tabBoxButton=document.getElement(".section-nav-icon"),this.tabBoxButton.addEvent(Affinity.events.click,this.mobileMenuOpen),n=new Hammer(window,{domEvents:!0});n.on("panright",this.mobileMenuClose);window.addEvent("mobileback",this.mobileMenuClose),window.addEvent(Affinity.events.start,function(n){this.tochStartX=n.client.x}.bind(this))}return this.tabs=["periodTab","overviewTab","dualdetailTab","weeklyTab","detailedTab","mileageTab","teamTab","teamMilesTab","bulkTab","refreshTab","filterTab","addTab","statsTab","settingsTab","favTab","helpTab","logoutTab"],t=-1,this.resetPanels(),this.zelosEngine=new ZelosInit({htmlTemplateUrl:this.options.zelosHtmlTemplate,onRequest:function(){uimessage({message:Affinity.languages.english.application.zelos.starting})},onError:function(n){uimessage({message:Affinity.languages.english.application.zelos.startfail+n})},onComplete:function(){Affinity.prompts.hide(),window.fireEvent("ZelosReady"),this.isZelosReady=!0,this.isLoggedIn&&!this.timesheetsStarted&&this.startTimesheets()}.bind(this)}),window.addEvent("gotUser",function(n){var t;if(Affinity.login.currentProfile=n,Affinity.login.userProfiles.hasOwnProperty(n.employeeNumber)){if(Affinity.login.userProfiles[n.employeeNumber].hasOwnProperty("payPeriods")){window.fireEvent("gotUserWithPeriods",Affinity.login.userProfiles[n.employeeNumber]);return}t=this.getPayPeriods(Affinity.login.userProfiles[n.employeeNumber],log.enabled),Affinity.login.userProfiles[n.employeeNumber].payPeriods=Object.clone(t),window.fireEvent("gotUserWithPeriods",Affinity.login.userProfiles[n.employeeNumber]);return}}.bind(this)),window.addEvent("TSSwitchView",function(n){switch(n.view){case"period":this.switchToOverviewView(n);break;case"overview":this.switchToOverviewView(n);break;case"dualdetail":this.switchToDualdetailView(n);break;case"employee":this.switchToEmployeeView(n);break;case"detailed":this.switchToEmployeeDetailedView(n);break;case"manager":this.switchToManagerView(n);break;case"managerMileage":this.switchToManagerMileageView(n);break;case"bulk":this.switchToBulkView(n);break;case"employeeMilaege":this.switchToMileageView(n)}}.bind(this)),Affinity.isLoggedIn?(this.loggedin(),setTimeout(function(){window.addEvent("loggedin",this.loggedin),window.addEvent("loggedout",this.loggedout)}.bind(this),1e3)):(window.addEvent("loggedin",this.loggedin),window.addEvent("loggedout",this.loggedout)),Affinity.HideMasterLoader(1e3),!0}},stopEvents:function(n){n.preventDefault(),n.stopPropagation()},mobileMenuCloseAndEventPrevention:function(n){var t=typeOf(n)!=="null"?n:!1;return Affinity.mobile&&this.mobileMenuClose(),t&&"stopPropagation"in n&&n.stopPropagation(),t},setLinkCloseEvent:function(n){n.removeEvents(),n.addEvent(Affinity.events.start,function(n){n.stopPropagation()}.bind(this))},dependancyCacheClear:!1,lookupCacheClear:!1,checkDependancyCacheClear:function(){this.dependancyCacheClear=!0,this.dependancyCacheClear&&this.lookupCacheClear&&this.continueRefresh()},checkLookupCacheClear:function(){this.lookupCacheClear=!0,this.dependancyCacheClear&&this.lookupCacheClear&&this.continueRefresh()},refresh:function(){uialert({message:"Refreshing",showLoader:!0,bgClose:!1,showButtons:!1}),this.dependancyCacheClear=!1,this.lookupCacheClear=!1,window.removeEvent("dependancyCacheClear",this.checkDependancyCacheClear),window.removeEvent("lookupCacheClear",this.checkLookupCacheClear),window.addEvent("dependancyCacheClear",this.checkDependancyCacheClear),window.addEvent("lookupCacheClear",this.checkLookupCacheClear),window.fireEvent("refreshQueues")},continueRefresh:function(){window.removeEvent("dependancyCacheClear",this.checkDependancyCacheClear),window.removeEvent("lookupCacheClear",this.checkLookupCacheClear);var n=this.getWidget(this.currentView);n&&n.refresh()},toggleFilter:function(n){n!==undefined&&n.preventDefault();var t=this.getWidget(this.currentView);t?t.toggleSearchForm():uialert({message:Affinity.languages.english.application.timesheets.globals.filterToggleFail,showButtons:!0})},toggleAdd:function(n){n.preventDefault();var t=this.getWidget(this.currentView);t?t.toggleAddRowsForm():uialert({message:Affinity.languages.english.application.timesheets.globals.addToggleFail,showButtons:!0})},mobileCloseDelay:!1,checkMobileMenuSwipeOpen:function(n){(Affinity.stopHammerEvent(n),n.changedPointers[0].target.hasClass("timesheet-row")||n.changedPointers[0].target.getParent("tr.timesheet-row"))||this.tochStartX>window.getSize().x-50&&this.mobileMenuOpen()},mobileMenuOpen:function(n){Affinity.stopHammerEvent(n),clearTimeout(this.mobileCloseDelay),this.tabBoxContainer.addClass("open"),window.removeEvent(Affinity.events.start,this.mobileMenuClose),window.removeEvent("mobileback",this.mobileMenuClose),this.mobileCloseDelay=function(){window.addEvent(Affinity.events.start,this.mobileMenuClose),window.addEvent("mobileback",this.mobileMenuClose)}.delay(250,this)},mobileMenuClose:function(n){n!==undefined&&Affinity.stopHammerEvent(n),clearTimeout(this.mobileCloseDelay),this.tabBoxContainer.removeClass("open"),window.removeEvent(Affinity.events.start,this.mobileMenuClose,{passive:!1}),window.removeEvent("mobileback",this.mobileMenuClose,{passive:!1})},removeTab:function(n){var t=this[n];typeof t!="undefined"&&typeOf(t)==="element"&&"removeEvent"in t&&(this.disableTab(n),this[n].destroy(),this[n]=null,delete this[n])},returnTab:function(n){this.removeTab(n);var t=new Element("li"),i=Affinity.languages.english.application.timesheets.tabs,r=Affinity.languages.english.features,u=new Fx.Reveal(t,{duration:250,mode:"horizontal",display:"inline-block"});t.store("revealer",u);switch(n){case"periodTab":t.addClass("mine isview u-blue"),t.set("html","<span>"+Affinity.icons.Calendar+"<\/span><span>"+i.periodView+"<\/span>");break;case"overviewTab":t.addClass("mine isview u-blue"),t.set("html","<span>"+Affinity.icons.GraphPie+"<\/span><span>"+i.dayOverview+"<\/span>");break;case"dualdetailTab":t.addClass("mine isview u-blue"),t.set("html","<span>"+Affinity.icons.User+"<\/span><span>"+i.dayDetail+"<\/span>");break;case"weeklyTab":t.addClass("mine isview u-blue"),t.set("html","<span>"+Affinity.icons.User+"<\/span><span>"+i.calendar+"<\/span>");break;case"detailedTab":t.addClass("detailed isview u-blue"),t.set("html","<span>"+Affinity.icons.User+"<\/span><span>"+i.detailed+"<\/span>");break;case"teamTab":t.addClass("team isview u-orange"),t.set("html","<span>"+Affinity.icons.Users+"<\/span><span>"+i.team+"<\/span>");break;case"bulkTab":t.addClass("bulk isview u-orange"),t.set("html","<span>"+Affinity.icons.Archive+"<\/span><span>"+i.bulkEntry+"<\/span>");break;case"mileageTab":t.addClass("mileage isview u-blue"),t.set("html","<span>"+Affinity.icons.Car+"<\/span><span>"+i.mileage+"<\/span>");break;case"teamMilesTab":t.addClass("team isview u-orange"),t.set("html","<span>"+Affinity.icons.Car+"<\/span><span>"+i.teamMiles+"<\/span>");break;case"refreshTab":t.addClass("refresh u-green ui-has-tooltip"),t.set("data-tooltip","Refresh Timesheets"),t.set("data-tooltip-dir","bottom,left"),Affinity.mobile?t.set("html","<span>"+Affinity.icons.Cycle+"<\/span><span>"+i.refresh+"<\/span>"):t.set("html","<span>"+Affinity.icons.Cycle+"<\/span>");break;case"filterTab":t.addClass("filter u-yellow"),t.set("html","<span>"+Affinity.icons.Search+"<\/span><span>"+i.filter+"<\/span>");break;case"addTab":t.addClass("add u-yellow"),t.set("html","<span>"+Affinity.icons.AddToList+"<\/span><span>"+i.add+"<\/span>");break;case"statsTab":t.addClass("stats isview link u-yellow ui-has-tooltip"),t.set("data-tooltip","Timesheets Statistics"),t.set("data-tooltip-dir","bottom,left"),Affinity.mobile?(t.set("html",'<a href="'+Affinity.urlroot+'Statistics" target="_self"><span>'+Affinity.icons.GraphStatistics+"<\/span><span>"+i.statistics+"<\/span><\/a>"),this.setLinkCloseEvent(t.getElement("a"))):t.set("html",'<a href="'+Affinity.urlroot+'Statistics" target="_self"><span>'+Affinity.icons.GraphStatistics+"<\/span><\/a>");break;case"settingsTab":t.addClass("settings isview link u-yellow"),Affinity.mobile?(t.set("html",'<a href="'+Affinity.urlroot+'UserSettings" target="_self"><span>'+Affinity.icons.Return+"<\/span>"+i.shareDelegate+"<\/a>"),this.setLinkCloseEvent(t.getElement("a"))):(t.addClass("ui-has-tooltip"),t.set("data-tooltip","Forward or Delegate Timesheets"),t.set("data-tooltip-dir","bottom,left"),t.set("html",'<a href="'+Affinity.urlroot+'UserSettings" target="_self"><span>'+Affinity.icons.Return+"<\/span><\/a>"));break;case"favTab":t.addClass("favs isview link u-yellow"),Affinity.mobile?(t.set("html",'<a href="'+Affinity.urlroot+'Favourites" target="_self"><span>'+r.favourites.icon+"<\/span>"+i.help+"<\/a>"),this.setLinkCloseEvent(t.getElement("a"))):(t.addClass("ui-has-tooltip"),t.set("data-tooltip",r.favourites.tabTooltip),t.set("data-tooltip-dir","bottom,left"),t.set("html",'<a href="'+Affinity.urlroot+'Favourites" target="_self"><span>'+r.favourites.icon+"<\/span><\/a>"));break;case"helpTab":t.addClass("help isview link u-blue"),Affinity.mobile?(t.set("html",'<a href="'+Affinity.urlroot+'Help" target="afhelp"><span>'+r.help.icon+"<\/span>"+i.help+"<\/a>"),this.setLinkCloseEvent(t.getElement("a"))):(t.addClass("ui-has-tooltip"),t.set("data-tooltip",r.help.tabTooltip),t.set("data-tooltip-dir","bottom,left"),t.set("html",'<a href="'+Affinity.urlroot+'Help" target="afhelp"><span>'+r.help.icon+"<\/span><\/a>"));break;case"logoutTab":t.addClass("logout isview orange u-orange"),t.set("id","logout"),Affinity.oldess?t.set("html","<span>"+Affinity.icons.Logout+"<\/span><span>"+i.close+"<\/span>"):t.set("html","<span>"+Affinity.icons.Logout+"<\/span><span>"+i.logout+"<\/span>")}return t.set("data-tab",n),this[n]=t,this.enableTab(n),this[n]},enableTab:function(n){var t=this[n];t&&(t.removeEvent(Affinity.events.click,this.tabClcked),t.className.contains("link")||t.addEvent(Affinity.events.click,this.tabClcked),t.retrieve("revealer").reveal(),t.addClass("enabled"))},disableTab:function(n){var t=this[n];t&&(t.removeEvent(Affinity.events.click,this.tabClcked),t.retrieve("revealer").dissolve(),t.removeClass("enabled"))},selectTab:function(n){this.tabBox.getElements("li").removeClass("selected"),this[n]&&(this.enableTab(n),this[n].addClass("selected"))},sortTabs:function(){if(!Affinity.mobile)return!1;var n=this.tabBox.getElement(".selected");n&&(this.tabBox.getElements(".isview").removeClass("paddtop"),n.addClass("paddtop"),this.filterTab.hasClass("enabled")&&this.filterTab.inject(n,"after"),this.addTab.hasClass("enabled")&&this.addTab.inject(n,"after"),this.refreshTab.hasClass("enabled")&&this.refreshTab.inject(n,"after"),n.getNext(".isview")&&n.getNext(".isview").addClass("paddtop"))},tabClcked:function(n){Affinity.uiAutoComplete.hideAll(),Affinity.uiTooltips.hideAll(),Affinity.uiDateCalendar.hideAll();var t=n.target.get("tag")==="li"?n.target:n.target.getParent("li"),i=t.get("data-tab");if(this.currentTab=!1,t.getParent("ul").getElement(".selected")&&(this.currentTab=t.getParent("ul").getElement(".selected").get("data-tab")),this.currentTab!==i)switch(i){case"periodTab":this.switchToPeriodView(n);break;case"overviewTab":this.switchToOverviewView(n);break;case"dualdetailTab":this.switchToDualdetailView(n);break;case"weeklyTab":this.switchToEmployeeView(n);break;case"detailedTab":this.switchToEmployeeDetailedView(n);break;case"teamTab":this.switchToManagerView(n);break;case"teamMilesTab":this.switchToManagerMileageView(n);break;case"bulkTab":this.switchToBulkView(n);break;case"mileageTab":this.switchToMileageView(n);break;case"refreshTab":this.refresh(n);break;case"filterTab":this.toggleFilter(n);break;case"addTab":this.toggleAdd(n);break;case"logoutTab":this.logout(n);break;case"statsTab":console.log(n)}},getWidget:function(){switch(this.currentView){case"period":return this.periodWidget||(this.periodWidget=this.options.periodTarget.getElement(".widget"))&&(this.periodWidget=this.options.periodTarget.getElement(".widget").retrieve("widget"),typeOf(this.periodWidget)==="null"&&(this.periodWidget=!1)),this.periodWidget;case"overview":return this.overviewWidget||(this.overviewWidget=this.options.overviewTarget.getElement(".widget"))&&(this.overviewWidget=this.options.overviewTarget.getElement(".widget").retrieve("widget"),typeOf(this.overviewWidget)==="null"&&(this.overviewWidget=!1)),this.overviewWidget;case"dualdetail":return this.dualdetailWidget||(this.dualdetailWidget=this.options.dualdetailTarget.getElement(".widget"))&&(this.dualdetailWidget=this.options.dualdetailTarget.getElement(".widget").retrieve("widget"),typeOf(this.dualdetailWidget)==="null"&&(this.dualdetailWidget=!1)),this.dualdetailWidget;case"employee":return this.employeeWidget||(this.employeeWidget=this.options.employeeTarget.getElement(".widget"))&&(this.employeeWidget=this.options.employeeTarget.getElement(".widget").retrieve("widget"),typeOf(this.employeeWidget)==="null"&&(this.employeeWidget=!1)),this.employeeWidget;case"detailed":return this.employeeDetailedWidget||this.options.employeeDetailedTarget.getElement(".widget")&&(this.employeeDetailedWidget=this.options.employeeDetailedTarget.getElement(".widget").retrieve("widget"),typeOf(this.employeeDetailedWidget)==="null"&&(this.employeeDetailedWidget=!1)),this.employeeDetailedWidget;case"manager":return this.managerWidget||this.options.managerTarget.getElement(".widget")&&(this.managerWidget=this.options.managerTarget.getElement(".widget").retrieve("widget"),typeOf(this.managerWidget)==="null"&&(this.managerWidget=!1)),this.managerWidget;case"bulk":return this.bulkWidget||this.options.bulkTarget.getElement(".widget")&&(this.bulkWidget=this.options.bulkTarget.getElement(".widget").retrieve("widget"),typeOf(this.bulkWidget)==="null"&&(this.bulkWidget=!1)),this.bulkWidget;case"employeeMilaege":return this.employeeMileageWidget||this.options.employeeMileageTarget.getElement(".widget")&&(this.employeeMileageWidget=this.options.employeeMileageTarget.getElement(".widget").retrieve("widget"),typeOf(this.employeeMileageWidget)==="null"&&(this.employeeMileageWidget=!1)),this.employeeMileageWidget;case"managerMileage":return this.managerMileageWidget||this.options.managerMileageTarget.getElement(".widget")&&(this.managerMileageWidget=this.options.managerMileageTarget.getElement(".widget").retrieve("widget"),typeOf(this.managerMileageWidget)==="null"&&(this.managerMileageWidget=!1)),this.managerMileageWidget}},hasWidgetChanged:function(){var t,i=!1,n=this.getWidget();n&&n.hasOwnProperty("hasChanges")&&n.hasChanges()&&(t=n.getChangeMessage(),i=t!==""?t.replace(/\n/g,"<br />"):!0)},refreshWidget:function(n){var t=this.getWidget(),r,i;return t&&t.hasOwnProperty("refresh")&&typeOf(t.refresh)==="function"?(this.lastView==="period"&&this.currentView==="dualdetail"?i=t.refresh(null,null,!0):(r=n||null,i=!1,i=r!==null?t.refresh(r):t.refresh()),i||!0):!1},getView:function(){var n=!1;try{var r=Affinity.login.profile.companyNumber+"-"+Affinity.login.profile.employeeNumber+"-last-view",t=document.cookie.match("(^|;) ?"+r+"=([^;]*)(;|$)"),i=t?t[2]:null;i!==null&&(n=i)}catch(u){console.log(u)}return n},saveView:function(){try{var t=new Date,i=new Date(t.getTime()+864e5),n=Affinity.login.profile.companyNumber+"-"+Affinity.login.profile.employeeNumber+"-last-view";n+="="+this.currentView+"; ",n+="expires="+i.toGMTString()+"; ",n+="SameSite=None; Secure",document.cookie=n}catch(r){console.log(r)}},cancelViewRequests:function(){this.currentWidget&&this.currentWidget.hasOwnProperty("cancelOtherRequests")&&this.currentWidget.cancelOtherRequests()},doSwitchToPeriodView:function(){var t,n;this.cancelViewRequests(),this.view="period",t=this.mobileMenuCloseAndEventPrevention(),this.lastView=this.currentView,this.currentView="period",document.getElement(".teamheading")&&document.getElement(".teamheading").addClass("hidden"),this.gettingPeriodData?(n=!1,Affinity.login.profile.admin?(n=this.refreshWidget(!1),Affinity.showProdConsole&&console.log("TS INIT: doSwitchToPeriodView refreshed",n,"with prop")):(n=this.refreshWidget(),Affinity.showProdConsole&&console.log("TS INIT: doSwitchToPeriodView refreshed",n))):(Affinity.showProdConsole&&console.log("TS INIT: doSwitchToPeriodView INIT -> get data and build view (getPeriodData)"),this.getPeriodData()),this.selectTab("periodTab"),this.disableTab("filterTab"),this.disableTab("addTab"),this.sortTabs(),this.options.periodTarget.removeClass("hidden"),this.options.overviewTarget.addClass("hidden"),this.options.dualdetailTarget.addClass("hidden"),this.options.managerTarget.addClass("hidden"),this.options.managerMileageTarget.addClass("hidden"),this.options.employeeTarget.addClass("hidden"),this.options.employeeDetailedTarget.addClass("hidden"),this.options.employeeMileageTarget.addClass("hidden"),this.options.bulkTarget.addClass("hidden"),this.currentWidget=this.periodWidget,this.saveView()},switchToPeriodView:function(n){var t=!1;try{t=this.hasWidgetChanged()}catch(i){}t?uiconfirm({message:Affinity.languages.english.application.timesheets.globals.warnViewChange+"<br /><br />"+(t!==!0?t+"<br />":"")+"<br /><br />"+Affinity.languages.english.generic.continue,onOk:function(){this.doSwitchToPeriodView(n)}.bind(this)}):this.doSwitchToPeriodView(n)},doSwitchToOverviewView:function(){var t,n;this.cancelViewRequests(),this.view="overview",t=this.mobileMenuCloseAndEventPrevention(),this.lastView=this.currentView,this.currentView="overview",document.getElement(".teamheading")&&document.getElement(".teamheading").addClass("hidden"),this.gettingOverviewDetails?(n=this.refreshWidget(),Affinity.showProdConsole&&console.log("TS INIT: doSwitchToOverviewView refreshed",n)):(Affinity.showProdConsole&&console.log("TS INIT: doSwitchToOverviewView INIT -> get data and build view (getOverviewDetails)"),this.getOverviewDetails()),this.selectTab("overviewTab"),this.disableTab("addTab"),this.disableTab("filterTab"),this.sortTabs(),this.options.periodTarget.addClass("hidden"),this.options.overviewTarget.removeClass("hidden"),this.options.dualdetailTarget.addClass("hidden"),this.options.managerTarget.addClass("hidden"),this.options.managerMileageTarget.addClass("hidden"),this.options.employeeTarget.addClass("hidden"),this.options.employeeDetailedTarget.addClass("hidden"),this.options.employeeMileageTarget.addClass("hidden"),this.options.bulkTarget.addClass("hidden"),this.currentWidget=this.overviewWidget,this.saveView()},switchToOverviewView:function(n){var t=!1;try{t=this.hasWidgetChanged()}catch(i){}t?uiconfirm({message:Affinity.languages.english.application.timesheets.globals.warnViewChange+"<br /><br />"+(t!==!0?t+"<br />":"")+"<br /><br />"+Affinity.languages.english.generic.continue,onOk:function(){this.doSwitchToOverviewView(n)}.bind(this)}):this.doSwitchToOverviewView(n)},doSwitchToDualdetailView:function(n){var u;this.cancelViewRequests(),this.view="dualdetail";var t=this.mobileMenuCloseAndEventPrevention(),i=t&&"date"in n?n.date:!1,r=t&&"profile"in n?n.profile:!1;this.lastView=this.currentView,this.currentView="dualdetail",document.getElement(".teamheading")&&document.getElement(".teamheading").addClass("hidden"),this.gettingDualdetailTimesheet?(u=this.refreshWidget(),Affinity.showProdConsole&&console.log("TS INIT: doSwitchToDualdetailView refreshed",u)):(Affinity.showProdConsole&&console.log("TS INIT: doSwitchToDualdetailView INIT -> get data and build view (getDualdetailTimesheet with date:",i,"and profile:",r,")"),this.getDualdetailTimesheet(i,r)),this.selectTab("dualdetailTab"),this.disableTab("addTab"),this.disableTab("filterTab"),this.sortTabs(),this.options.periodTarget.addClass("hidden"),this.options.overviewTarget.addClass("hidden"),this.options.dualdetailTarget.removeClass("hidden"),this.options.managerTarget.addClass("hidden"),this.options.managerMileageTarget.addClass("hidden"),this.options.employeeTarget.addClass("hidden"),this.options.employeeDetailedTarget.addClass("hidden"),this.options.employeeMileageTarget.addClass("hidden"),this.options.bulkTarget.addClass("hidden"),this.currentWidget=this.dualdetailWidget,this.saveView()},switchToDualdetailView:function(n){var t=!1;try{t=this.hasWidgetChanged()}catch(i){}t?uiconfirm({message:Affinity.languages.english.application.timesheets.globals.warnViewChange+"<br /><br />"+(t!==!0?t+"<br />":"")+"<br /><br />"+Affinity.languages.english.generic.continue,onOk:function(){this.doSwitchToDualdetailView(n)}.bind(this)}):this.doSwitchToDualdetailView(n)},doSwitchToEmployeeView:function(n){var u;this.cancelViewRequests(),this.view="employee";var t=this.mobileMenuCloseAndEventPrevention(),i=t&&"date"in n?n.date:!1,r=t&&"profile"in n?n.profile:!1;this.lastView=this.currentView,this.currentView="employee",document.getElement(".teamheading")&&document.getElement(".teamheading").addClass("hidden"),this.gettingEmployeeTimesheet?(u=this.refreshWidget(),Affinity.showProdConsole&&console.log("TS INIT: doSwitchToEmployeeView (weekly/calendar) refreshed",u)):(Affinity.showProdConsole&&console.log("TS INIT: doSwitchToEmployeeView (weekly/calendar) INIT -> get data and build view (getEmployeeTimesheet with date:",i,"and profile:",r,")"),this.getEmployeeTimesheet(i,r)),this.selectTab("weeklyTab"),this.areas.ReadonlyWeeklyView?this.disableTab("addTab"):this.enableTab("addTab"),this.disableTab("filterTab"),this.sortTabs(),this.options.periodTarget.addClass("hidden"),this.options.overviewTarget.addClass("hidden"),this.options.dualdetailTarget.addClass("hidden"),this.options.managerTarget.addClass("hidden"),this.options.managerMileageTarget.addClass("hidden"),this.options.employeeTarget.removeClass("hidden"),this.options.employeeDetailedTarget.addClass("hidden"),this.options.employeeMileageTarget.addClass("hidden"),this.options.bulkTarget.addClass("hidden"),this.currentWidget=this.employeeWidget,this.saveView()},switchToEmployeeView:function(n){var t=!1;try{t=this.hasWidgetChanged()}catch(i){}t?uiconfirm({message:Affinity.languages.english.application.timesheets.globals.warnViewChange+"<br /><br />"+(t!==!0?t+"<br />":"")+"<br /><br />"+Affinity.languages.english.generic.continue,onOk:function(){this.doSwitchToEmployeeView(n)}.bind(this)}):this.doSwitchToEmployeeView(n)},doSwitchToEmployeeDetailedView:function(){var t,n;this.cancelViewRequests(),this.view="employeeDetails",t=this.mobileMenuCloseAndEventPrevention(),this.lastView=this.currentView,this.currentView="detailed",document.getElement(".teamheading")&&document.getElement(".teamheading").addClass("hidden"),this.gettingEmployeeDetailsTimesheet?(n=this.refreshWidget(),Affinity.showProdConsole&&console.log("TS INIT: doSwitchToEmployeeDetailedView refreshed",n)):(Affinity.showProdConsole&&console.log("TS INIT: doSwitchToEmployeeDetailedView (weekly/calendar) INIT -> get data and build view (getEmployeeDetailsTimesheet)"),this.getEmployeeDetailsTimesheet()),this.selectTab("detailedTab"),this.areas.ReadonlyDetailView?this.disableTab("addTab"):this.enableTab("addTab"),this.enableTab("filterTab"),this.sortTabs(),this.options.periodTarget.addClass("hidden"),this.options.overviewTarget.addClass("hidden"),this.options.dualdetailTarget.addClass("hidden"),this.options.managerTarget.addClass("hidden"),this.options.managerMileageTarget.addClass("hidden"),this.options.employeeTarget.addClass("hidden"),this.options.employeeDetailedTarget.removeClass("hidden"),this.options.employeeMileageTarget.addClass("hidden"),this.options.bulkTarget.addClass("hidden"),this.currentWidget=this.employeeDetailedWidget,this.saveView()},switchToEmployeeDetailedView:function(n){var t=!1;try{t=this.hasWidgetChanged()}catch(i){}t?uiconfirm({message:Affinity.languages.english.application.timesheets.globals.warnViewChange+"<br /><br />"+(t!==!0?t+"<br />":"")+"<br /><br />"+Affinity.languages.english.generic.continue,onOk:function(){this.doSwitchToEmployeeDetailedView(n)}.bind(this)}):this.doSwitchToEmployeeDetailedView(n)},doSwitchToManagerView:function(){var t,n;this.cancelViewRequests(),this.view="manager",t=this.mobileMenuCloseAndEventPrevention(),this.lastView=this.currentView,this.currentView="manager",document.getElement(".teamheading")&&document.getElement(".teamheading").removeClass("hidden"),this.gettingManagerTimesheet?(n=this.refreshWidget(),Affinity.showProdConsole&&console.log("TS INIT: doSwitchToManagerView refreshed",n)):(Affinity.showProdConsole&&console.log("TS INIT: doSwitchToManagerView INIT -> get data and build view (getManagerTimesheet with date:",date,"and profile:",profile,")"),this.getManagerTimesheet()),this.selectTab("teamTab"),this.enableTab("filterTab"),this.enableTab("addTab"),this.sortTabs(),this.options.periodTarget.addClass("hidden"),this.options.overviewTarget.addClass("hidden"),this.options.dualdetailTarget.addClass("hidden"),this.options.managerTarget.removeClass("hidden"),this.options.managerMileageTarget.addClass("hidden"),this.options.employeeTarget.addClass("hidden"),this.options.employeeDetailedTarget.addClass("hidden"),this.options.employeeMileageTarget.addClass("hidden"),this.options.bulkTarget.addClass("hidden"),this.currentWidget=this.managerWidget,this.saveView()},switchToManagerView:function(n){var t=!1;try{t=this.hasWidgetChanged()}catch(i){}t?uiconfirm({message:Affinity.languages.english.application.timesheets.globals.warnViewChange+"<br /><br />"+(t!==!0?t+"<br />":"")+"<br /><br />"+Affinity.languages.english.generic.continue,onOk:function(){this.doSwitchToManagerView(n)}.bind(this)}):this.doSwitchToManagerView(n)},doSwitchToBulkView:function(){var t,n;this.cancelViewRequests(),this.view="bulk",t=this.mobileMenuCloseAndEventPrevention(),this.lastView=this.currentView,this.currentView="bulk",this.gettingBulkDetails?(n=this.refreshWidget(),Affinity.showProdConsole&&console.log("TS INIT: doSwitchToBulkView refreshed",n)):(Affinity.showProdConsole&&console.log("TS INIT: doSwitchToBulkView INIT -> get data and build view (getBulkDetails)"),this.getBulkDetails()),this.tabBox.getElements("li").removeClass("selected"),this.selectTab("bulkTab"),this.disableTab("addTab"),this.disableTab("filterTab"),this.sortTabs(),this.options.periodTarget.addClass("hidden"),this.options.overviewTarget.addClass("hidden"),this.options.dualdetailTarget.addClass("hidden"),this.options.managerTarget.addClass("hidden"),this.options.managerMileageTarget.addClass("hidden"),this.options.employeeTarget.addClass("hidden"),this.options.employeeDetailedTarget.addClass("hidden"),this.options.employeeMileageTarget.addClass("hidden"),this.options.bulkTarget.removeClass("hidden"),this.currentWidget=this.bulkWidget,this.saveView()},switchToBulkView:function(n){var t=!1;try{t=this.hasWidgetChanged()}catch(i){}t?uiconfirm({message:Affinity.languages.english.application.timesheets.globals.warnViewChange+"<br /><br />"+(t!==!0?t+"<br />":"")+"<br /><br />"+Affinity.languages.english.generic.continue,onOk:function(){this.doSwitchToBulkView(n)}.bind(this)}):this.doSwitchToBulkView(n)},doSwitchToMileageView:function(n){var u;this.cancelViewRequests(),this.view="employeeMilaege";var t=this.mobileMenuCloseAndEventPrevention(),i=t&&"date"in n?n.date:!1,r=t&&"profile"in n?n.profile:!1;this.lastView=this.currentView,this.currentView="employeeMilaege",this.gettingEmployeeMileage?(u=this.refreshWidget(),Affinity.showProdConsole&&console.log("TS INIT: doSwitchToMileageView refreshed",u)):(Affinity.showProdConsole&&console.log("TS INIT: doSwitchToMileageView INIT -> get data and build view (getEmployeeMileageTimesheets with date:",i,"and profile:",r,")"),this.getEmployeeMileageTimesheets(i,r)),this.selectTab("mileageTab"),this.enableTab("filterTab"),this.enableTab("addTab"),this.enableTab("refreshTab"),this.sortTabs(),this.options.periodTarget.addClass("hidden"),this.options.overviewTarget.addClass("hidden"),this.options.dualdetailTarget.addClass("hidden"),this.options.managerTarget.addClass("hidden"),this.options.managerMileageTarget.addClass("hidden"),this.options.employeeTarget.addClass("hidden"),this.options.employeeDetailedTarget.addClass("hidden"),this.options.bulkTarget.addClass("hidden"),this.options.employeeMileageTarget.removeClass("hidden"),this.currentWidget=this.employeeMileageWidget,this.saveView()},switchToMileageView:function(n){var t=!1;try{t=this.hasWidgetChanged()}catch(i){}t?uiconfirm({message:Affinity.languages.english.application.timesheets.globals.warnViewChange+"<br /><br />"+(t!==!0?t+"<br />":"")+"<br /><br />"+Affinity.languages.english.generic.continue,onOk:function(){this.doSwitchToMileageView(n)}.bind(this)}):this.doSwitchToMileageView(n)},doSwitchToManagerMileageView:function(n){var u;this.cancelViewRequests(),this.view="managerMileage";var t=this.mobileMenuCloseAndEventPrevention(),i=t&&"date"in n?n.date:!1,r=t&&"profile"in n?n.profile:!1;this.lastView=this.currentView,this.currentView="managerMileage",this.gettingManagerMileage?(u=this.refreshWidget(),Affinity.showProdConsole&&console.log("TS INIT: doSwitchToMileageView refreshed",u)):(Affinity.showProdConsole&&console.log("TS INIT: doSwitchToManagerMileageView INIT -> get data and build view (getManagerMileageTimesheets with date:",i,"and profile:",r,")"),this.getManagerMileageTimesheets(i,r)),this.selectTab("teamMilesTab"),this.enableTab("filterTab"),this.enableTab("addTab"),this.enableTab("refreshTab"),this.sortTabs(),this.options.periodTarget.addClass("hidden"),this.options.overviewTarget.addClass("hidden"),this.options.dualdetailTarget.addClass("hidden"),this.options.managerTarget.addClass("hidden"),this.options.employeeMileageTarget.addClass("hidden"),this.options.employeeTarget.addClass("hidden"),this.options.employeeDetailedTarget.addClass("hidden"),this.options.bulkTarget.addClass("hidden"),this.options.managerMileageTarget.removeClass("hidden"),this.currentWidget=this.managerMileageWidget,this.saveView()},switchToManagerMileageView:function(n){var t=!1;try{t=this.hasWidgetChanged()}catch(i){}t?uiconfirm({message:Affinity.languages.english.application.timesheets.globals.warnViewChange+"<br /><br />"+(t!==!0?t+"<br />":"")+"<br /><br />"+Affinity.languages.english.generic.continue,onOk:function(){this.doSwitchToManagerMileageView(n)}.bind(this)}):this.doSwitchToManagerMileageView(n)},destroyTabs:function(){return Array.each(this.tabs,function(n){this.removeTab(n)}.bind(this)),this.tabBox.empty(),!0},buildTabs:function(){var n;this.destroyTabs()&&(Array.each(this.tabs,function(t){n=this.returnTab(t),n.inject(this.tabBox)}.bind(this)),Affinity.uiTooltips&&Affinity.uiTooltips.processNew())},resetPanels:function(){this.buildTabs(),this.options.periodTarget.empty(),this.options.overviewTarget.empty(),this.options.dualdetailTarget.empty(),this.options.managerTarget.empty(),this.options.employeeTarget.empty(),this.options.employeeDetailedTarget.empty(),this.options.overviewTarget.addClass("hidden"),this.options.dualdetailTarget.addClass("hidden"),this.options.managerTarget.addClass("hidden"),this.options.employeeTarget.addClass("hidden"),this.options.employeeDetailedTarget.addClass("hidden"),this.options.bulkTarget.addClass("hidden"),this.options.employeeMileageTarget.addClass("hidden"),this.options.managerMileageTarget.addClass("hidden")},reverseDateParamMonths:["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],dateParam:!1,getDates:function(n){var e=n||!1,u,t,i,f,r;return e?(t=Affinity.login.profile.payPeriods.currentBegins.clone(),i=Affinity.login.profile.payPeriods.currentEnds.clone(),u={fromDate:t,toDate:i}):Affinity.DateRangeMethod==="original"?this.dateParam?(f=this.dateParam.substring(1).parseQueryString(),t=f.fromDate.trim().toLowerCase(),r=t.split("."),t=r[0]+"."+(this.reverseDateParamMonths.indexOf(r[1])+1)+"."+r[2],i=f.toDate.trim().toLowerCase(),r=i.split("."),i=r[0]+"."+(this.reverseDateParamMonths.indexOf(r[1])+1)+"."+r[2],u={fromDate:Date.parse(t),toDate:Date.parse(i)}):(t=this.defaultStartDate?Date.parse(this.defaultStartDate):!1,i=t?this.defaultEndDate?Date.parse(this.defaultEndDate):!1:!1,u={fromDate:t,toDate:i},t&&i&&(this.dateParam="&fromDate="+t.clone().format("%d.%b.%Y")+"&toDate="+i.clone().format("%d.%b.%Y"))):(t=this.defaultStartDate.clone(),i=this.defaultEndDate.clone(),u={fromDate:t,toDate:i}),u},getDateParams:function(n){var t=this.getDates(n);return"&fromDate="+t.fromDate.clone().format("%d.%b.%Y")+"&toDate="+t.toDate.clone().format("%d.%b.%Y")},gettingPeriodData:!1,getPeriodData:function(){this.gettingPeriodData=!0,this.periodWidget=new ZelosWidgetReportAsPeriodTable({target:this.options.periodTarget,onComplete:function(){this.periodProcessed=!0}.bind(this)})},gettingOverviewDetails:!1,getOverviewDetails:function(){var n,u,f;this.gettingOverviewDetails=!0;var t=!1,i=Date.parse(this.defaultStartDate),r=Date.parse(this.defaultEndDate);this.overviewDualDetailDate?t=Date.parse(this.overviewDualDetailDate):(n=new Date,n.sameDay(i)||n.sameDay(r)||n>i&&n<r?t=n:(u=864e5,f=Math.round(Math.abs((i.getTime()-r.getTime())/u)),t=n.increment("day",f/2))),new ZelosWidgetTimesheetOverview({target:this.options.overviewTarget,isManager:this.isManager,isEmployee:this.isEmployee,fromDate:i,toDate:r,startDate:t,getApi:Affinity.zelosroot+"?api=TimesheetInfo/GetTimesheetTotal",onComplete:function(){this.overviewProcessed=!0}.bind(this),onDateChanged:function(n){this.overviewDualDetailDate=n,this.dualdetailWidget&&(this.dualdetailWidget.fromDate=this.dualdetailWidget.toDate=this.dualdetailWidget.selectedDate=n)}.bind(this)})},overviewDualDetailDate:!1,gettingDualdetailTimesheet:!1,getDualdetailTimesheet:function(n,t){var i,e,o;this.gettingDualdetailTimesheet=!0;var r=!1,u=Date.parse(this.defaultStartDate),f=Date.parse(this.defaultEndDate);this.overviewDualDetailDate?r=Date.parse(this.overviewDualDetailDate):(i=new Date,i.sameDay(u)||i.sameDay(f)||i>u&&i<f?r=i:(e=864e5,o=Math.round(Math.abs((u.getTime()-f.getTime())/e)),r=i.increment("day",o/2))),new ZelosWidgetTimesheetDualdetailed({target:this.options.dualdetailTarget,isManager:this.isManager,isEmployee:this.isEmployee,fromDate:n||u,toDate:n||f,startDate:n||r,profile:t||!1,getApi:Affinity.zelosroot+"?api=TimesheetInfo/GetTimesheetTotal",onComplete:function(){this.dualdetailProcessed=!0}.bind(this),onDateChanged:function(n){this.overviewDualDetailDate=n,this.overviewWidget&&(this.overviewWidget.fromDate=this.overviewWidget.toDate=this.overviewWidget.selectedDate=n)}.bind(this)})},gettingEmployeeTimesheet:!1,getEmployeeTimesheet:function(n,t){var r=Affinity.languages.english.application.timesheets,u;uialert({message:r.globals.gets.calendar,noClose:!0,showLoader:!0}),this.gettingEmployeeTimesheet=!0;var f={mode:"Affinity"},i=Affinity.zelosroot;i+="?api=timesheet/get",i+=this.getDateParams(!0),i+="&view=week",i+="&page=0",u={target:this.options.employeeTarget,getApi:i,putApi:Affinity.zelosroot+"?api=timesheet/post",getEmptyTimesheetApi:Affinity.zelosroot+"?api=timesheet/getEmptyTimesheet",timesheetType:"employee",isManager:this.isManager,isEmployee:this.isEmployee,profile:t||!1,fromDate:n||this.defaultStartDate,toDate:n||this.defaultEndDate,startDay:this.defaultStartDay,showDays:this.showDays,publicHolidays:this.publicHolidays,readOnly:this.areas.ReadonlyWeeklyView===!1?!1:!0,onSaveError:function(){},beforSave:function(n){return n.button&&(n.button.hasClass("orange")&&window.uialert({message:r.globals.saving+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),n.button.hasClass("green")&&window.uialert({message:r.globals.submitting+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0})),!0}.bind(this),onSave:function(){},onComplete:function(){var t,i,n;this.employeeProcessed=!0,Affinity.prompts.hide(),this.options.employeeTarget.getElements(".form-row.buttons")&&(t=this.options.employeeTarget.getElements(".form-row.buttons").getParent(".default-form").getElements(".form-row"),Array.each(t,function(n){n.getParent(".default-form").hasClass("timesheetSearchFrom")||n.addClass("inline")}),this.options.employeeTarget.getElements(".form-row.required-message").removeClass("inline")),this.options.employeeTarget.getElements(".showSearch,.addrows").addClass("hidden"),this.options.employeeTarget.getElement(".section-header")&&this.options.employeeTarget.getElement(".section-header").addClass("hidden"),i=this.getWidget()||!1,n=i.internalWidget||!1,Array.each(this.options.employeeTarget.getElements(".zelos-button"),function(t){t.get("html").toLowerCase().contains("selected")&&t.set("html",t.get("html").replace(/selected/gi,"All")),n&&(t.hasClass("green")||t.hasClass("orange"))&&(t.hasClass("green")&&t.addClass("submit").removeEvents().addEvent(Affinity.events.click,n.submitWeek),t.hasClass("orange")&&t.addClass("save").addClass("hidden").removeEvents())}),Affinity.mobile}.bind(this)},f.zelosProcessor=new ZelosTemplateProcess(u),this.employeeLoader=new ZelosTemplateLoad({onRequest:function(){},onError:function(n){this.employeeProcessed=!0;var t="";t+='<div class="section shadow "><div class="section-body"><div class="section-row">',t+=r.globals.getError+"<!--"+n+"-->",t+="<\/div><\/div><\/div>",this.options.employeeTarget.set("html",t),Affinity.prompts.hide()}.bind(this),onComplete:function(n){this.areas&&this.areas.ReadonlyWeeklyView&&n.Children&&Array.isArray(n.Children)&&n.Children.length>1&&n.Children[1].Name&&n.Children[1].Name==="Buttons"&&n.Children[1].Children&&Array.isArray(n.Children[1].Children)&&n.Children[1].Children.length>0&&n.Children[1].Children[0].ElementType&&n.Children[1].Children[0].ElementType==="WorkflowButton"&&(n.Children[1]=null,delete n.Children[1]),Array.each(n.Children,function(t,i){t.ElementType==="SectionHeading"&&t.Name==="Forwarding"&&(n.Children[i]=null,n.Children.splice(i,1))}),f.zelosProcessor.processTemplate(n)}.bind(this)}).loadTemplate(u.getApi)},ignoreDeclined:!1,gettingEmployeeDetailsTimesheet:!1,getEmployeeDetailsTimesheet:function(){var t=Affinity.languages.english.application.timesheets,f;uialert({message:t.globals.gets.detailed,noClose:!0,showLoader:!0}),this.gettingEmployeeDetailsTimesheet=!0,this.options.employeeDetailedTarget.removeClass("hidden");var i=Date.parse(Affinity.login.profile.payPeriods.currentBegins),r=Date.parse(Affinity.login.profile.payPeriods.currentEnds),e=i.clone(),o=r.clone(),u={mode:"Affinity"},n=Affinity.zelosroot+"?api=timesheet/get";n+="&fromDate="+i.format("%d.%b.%Y")+"&toDate="+r.format("%d.%b.%Y"),n+="&view=detail",n+="&page=0",n+="&pageSize="+this.rowsPerPage,f={target:this.options.employeeDetailedTarget,getApi:n,putApi:Affinity.zelosroot+"?api=timesheet/post",getEmptyTimesheetApi:Affinity.zelosroot+"?api=timesheet/getEmptyTimesheet",timesheetType:"employeeDetails",isManager:this.isManager,isEmployee:this.isEmployee,fromDate:i,toDate:r,filterFromDate:e,filterToDate:o,readOnly:this.areas.ReadonlyDetailView===!1?!1:!0,onSaveError:function(n){if(Array.isArray(n)||typeof n=="string"||!n.hasOwnProperty("errors")||(n=n.errors),Array.isArray(n)){var t=[];n.forEach(function(n){t.push(n[2])}),n=t}Array.isArray(n)&&(n="<br />"+n.join("<br />")),uialert({message:Affinity.languages.english.generic.error+n,noClose:!1,showButtons:!0})},beforSave:function(n){var f=!1,i=n.button,o=i.getParent("tr.timesheet-row")?i.getParent("tr.timesheet-row"):i.get("data-row-ref")?document.getElement("tr#"+i.get("data-row-ref")):!1,e,r;return((i.hasClass("orange")||i.hasClass("green"))&&(i.hasClass("orange")&&window.uialert({message:t.globals.savingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),i.hasClass("green")&&(window.uialert({message:t.globals.submittingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),f="submit")),e=!0,r=this.getWidget(),f&&"internalWidget"in r&&"reduceBulkRows"in r.internalWidget&&(e=r.internalWidget.reduceBulkRows(f,this.ignoreDeclined),this.ignoreDeclined=!1,!e))?(Affinity.UI.___tempCallback=function(n){this.ignoreDeclined=n.ignoreDeclined,window.removeEvent("__tempCallback",Affinity.UI.___tempCallback),Affinity.UI.___tempCallback=null,delete Affinity.UI.___tempCallback,u.zelosProcessor.submit({target:i})}.bind(this),window.addEvent("__tempCallback",Affinity.UI.___tempCallback),!1):!0}.bind(this),onSave:function(){},onComplete:function(){if(this.employeeDetailedProcessed=!0,Affinity.prompts.hide(),this.options.employeeDetailedTarget.getElements(".form-row.buttons")){var n=this.options.employeeDetailedTarget.getElements(".form-row.buttons").getParent(".default-form").getElements(".form-row");Array.each(n,function(n){n.getParent(".default-form").hasClass("timesheetSearchFrom")||n.addClass("inline")}),this.options.employeeDetailedTarget.getElements(".form-row.required-message").removeClass("inline")}this.options.employeeDetailedTarget.getElements(".showSearch,.addrows").addClass("hidden"),this.options.employeeDetailedTarget.getElement(".section-header")&&this.options.employeeDetailedTarget.getElement(".section-header").addClass("hidden"),Affinity.mobile}.bind(this)},u.zelosProcessor=new ZelosTemplateProcess(f),this.employeeDetailedLoader=new ZelosTemplateLoad({onRequest:function(){},onError:function(n){this.employeeDetailedProcessed=!0;var i="";i+='<div class="section shadow "><div class="section-body"><div class="section-row">',i+=t.globals.getError+"<!--"+n+"-->",i+="<\/div><\/div><\/div>",this.options.employeeDetailedTarget.set("html",i),Affinity.prompts.hide()}.bind(this),onComplete:function(n){Array.each(n.Children,function(t,i){t.ElementType==="SectionHeading"&&t.Name==="Forwarding"&&(n.Children[i]=null,n.Children.splice(i,1))}),u.zelosProcessor.processTemplate(n)}}).loadTemplate(f.getApi)},gettingManagerTimesheet:!1,getManagerTimesheet:function(){var t=Affinity.languages.english.application.timesheets,h,i,u,c,p,n;uialert({message:t.globals.gets.manager,noClose:!0,showLoader:!0}),this.gettingManagerTimesheet=!0,this.options.managerTarget.removeClass("hidden");var l={mode:"Affinity"},f=this.defaultStartDate.clone(),r=this.defaultEndDate.clone(),o=this.defaultStartDate.clone(),s=this.defaultEndDate.clone(),e=Affinity.ShowManagerAllUnapproved==="*"?!0:!1;e||Affinity.ShowManagerAllUnapproved.trim()===""||(h=Affinity.ShowManagerAllUnapproved.split(","),(h.contains(Affinity.login.profile.companyNumber)||h.contains(Affinity.login.profile.companyNumber+""))&&(e=!0)),e&&(f=Affinity.login.profile.oldestTimesheetDate,r=Affinity.login.profile.newestTimesheetDate,Affinity.login.userProfiles[Affinity.login.profile.employeeNumber].payPeriods.currentEnds&&(r=Affinity.login.userProfiles[Affinity.login.profile.employeeNumber].payPeriods.currentEnds),o=f.clone(),s=r.clone()),Affinity.login.profile.admin&&(f=this.defaultStartDate.clone(),r=this.defaultEndDate.clone(),o=this.defaultStartDate.clone(),s=this.defaultEndDate.clone()),i=Affinity.zelosroot+"?api=timesheetAsManager/get",i+=e?"&fromDate="+f.format("%d.%b.%Y")+"&toDate="+r.format("%d.%b.%Y"):this.getDateParams(),i+="&timesheetStatus=Submitted",i+="&view=detail",i+="&page=0",i+="&pageSize="+this.rowsPerPage,u=[],e?u.push("dont_return_locked"):(u.push("dont_return_locked"),u.push("dont_return_managed")),c=!1,Affinity.login.profile.screenFilters&&Affinity.login.profile.screenFilters.length>0&&Array.each(Affinity.login.profile.screenFilters,function(n){"Data"in n&&Array.each(n.Data,function(t){n.FieldName!=="MethodFilter"||c||t.Key!==null&&(u.push("MethodFilter"+t.Key),c=!0)}.bind(this))}.bind(this)),u.length>0&&(i+="&DefaultRosterGroup="+u.join(","));var v=Affinity.zelosroot+"?api=timesheetAsManager/post",y=Affinity.zelosroot+"?api=timesheetAsManager/getEmptyTimesheet",a={target:this.options.managerTarget,getApi:i,putApi:v,getEmptyTimesheetApi:y,insertAddTimesheetForm:!0,timesheetType:"manager",isManager:this.isManager,isEmployee:this.isEmployee,fromDate:f,toDate:r,filterFromDate:o,filterToDate:s,readOnly:this.areas.ReadonlyDetailView===!1?!1:!0,onSaveError:function(n){var t=n;typeOf(n)==="object"&&n.hasOwnProperty("errors")&&(t=[],Array.each(n.errors,function(n){t.push(n[2])}),t=t.join("<br />"),uialert({message:Affinity.languages.english.generic.error+"<br />"+t,noClose:!1,showButtons:!0,showLoader:!1}))},beforSave:function(n){var i,f,e,o;if(n.button){this.lastButtonClicked=n.button.innerText;var u=!1,r=this.getWidget(),s=n.button.getParent("tr.timesheet-row")||!1;if(n.button.getParent(".default-form")&&n.button.getParent(".default-form").getElement("#ForwardTo")&&(u=!0,n.button.getParent(".default-form").getElement("#ForwardTo").value===""||n.button.getParent(".default-form").getElement("#ForwardTo").value==="0"))return uialert({message:Affinity.languages.english.generic.selectForward,noClose:!1,showButtons:!0,showLoader:!1}),!1;u?(o=r.internalWidget.cleanFavData(i),window.uialert({message:t.globals.forwardingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0})):(i=!1,f=["Save","Accept","Decline"],n.button&&n.button.dataset&&f.contains(n.button.dataset.type)&&(n.button.dataset.type==="Save"&&window.uialert({message:t.globals.savingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),n.button.dataset.type==="Accept"&&(window.uialert({message:t.globals.approvingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),i="submit"),n.button.dataset.type==="Decline"&&(window.uialert({message:t.globals.decliningSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),i="decline")),e=!1,i&&"internalWidget"in r&&"reduceBulkRows"in r.internalWidget&&(e=r.internalWidget.reduceBulkRows(i,!1)))}return!0}.bind(this),onSave:function(n){var u=this.getWidget(),r=[],i,f;n&&typeof n=="object"&&"hasOwnProperty"in n&&(n.hasOwnProperty("success")&&typeof n.success=="boolean"&&n.success===!1?u&&(i=t.globals.saveError,f=JSON.stringify(n),f.contains("ZelsoProxy error")&&f.contains("operation has timed out")&&(i=t.globals.processTimeout,this.lastButtonClicked&&typeof this.lastButtonClicked=="string"&&this.lastButtonClicked.trim()!==""&&(this.lastButtonClicked.toLowerCase().contains("approve selected")?i=t.globals.approvingSelectedTimeout:this.lastButtonClicked.toLowerCase().contains("decline selected")?i=t.globals.decliningSelectedTimeout:this.lastButtonClicked.toLowerCase().contains("save selected")?i=t.globals.savingSelectedTimeout:this.lastButtonClicked.toLowerCase().contains("forward selected")&&(i=t.globals.forwardingSelectedTimeout))),this.lastButtonClicked=!1,r.push(i),u.internalWidget.messageBucket=r):n.hasOwnProperty("Children")&&n.Children.length>0&&n.Children[0].hasOwnProperty("Children")&&n.Children[0].Children.length>0&&n.Children[0].Children[0].hasOwnProperty("Children")&&u&&(Array.each(n.Children[0].Children[0].Children,function(n,t){!("Children"in n)&&"Message"in n.Attribute&&n.Attribute.Message.trim()!==""&&r.push(n.Attribute.Message.trim().replace("Timesheet","The timesheet at row "+(t+1)))}),r.length>0&&(u.internalWidget.messageBucket=r)))}.bind(this),onComplete:function(){this.managerProcessed=!0,Affinity.prompts.hide(),this.options.managerTarget.getElements(".form-row.buttons")&&(Array.each(this.options.managerTarget.getElements(".form-row.buttons").getParent(".default-form").getElements(".form-row"),function(n){n.getParent(".default-form").hasClass("timesheetSearchFrom")||n.addClass("inline")}),this.options.managerTarget.getElements(".form-row.required-message").removeClass("inline")),this.options.managerTarget.getElements(".showSearch,.addrows").addClass("hidden"),this.options.managerTarget.getElement(".section-header").addClass("hidden"),Affinity.mobile}.bind(this)};l.zelosProcessor=new ZelosTemplateProcess(a),this.managerLoader=new ZelosTemplateLoad({onRequest:function(){},onError:function(n){this.managerProcessed=!0;var i="";i+='<div class="section shadow "><div class="section-body"><div class="section-row">',i+=t.globals.getError+"<!--"+n+"-->",i+="<\/div><\/div><\/div>",this.options.managerTarget.set("html",i),Affinity.prompts.hide()}.bind(this),onComplete:function(n){Array.each(n.Children,function(n){n.Name==="Forwarding"&&Array.each(n.Children,function(n){n.Name==="ForwardTo"&&(n.SortBy="innerText-lastname")}.bind(this))}.bind(this)),l.zelosProcessor.processTemplate(n)}}),Affinity.timesheets.init.hasOwnProperty("switchData")&&typeOf(Affinity.timesheets.init.switchData)==="object"?(uialert({message:t.globals.gettingEmplopyee+" "+Affinity.timesheets.init.switchData.emp+" for "+Affinity.timesheets.init.switchData.date.toFriendlyShort(),noClose:!0,showLoader:!0}),p=Affinity.login.profile.newestTimesheetDate.clone().increment("day",1),n=Affinity.zelosroot+"?api=timesheetAsManager/get",n+="&fromDate="+Affinity.timesheets.init.switchData.date.format("%d.%b.%Y")+"&toDate="+Affinity.timesheets.init.switchData.date.format("%d.%b.%Y"),n+="&timesheetStatus=Submitted,Declined,Approved,Paid",n+="&view=detail",n+="&page=0",n+="&pageSize="+this.rowsPerPage,n+="&employeeNo="+Affinity.timesheets.init.switchData.emp,n+="&PayPoint="+Affinity.timesheets.init.switchData.payPoint,n+="&DefaultRosterGroup=dont_return_locked,dont_return_managed",this.managerLoader.loadTemplate(n)):Affinity.timesheets.init.hasOwnProperty("affinityData")&&typeOf(Affinity.timesheets.init.affinityData)==="object"?(uialert({message:t.globals.gettingEmplopyee+" "+Affinity.timesheets.init.affinityData.emp+" for "+Affinity.timesheets.init.affinityData.fromDate.toFriendlyShort()+" to "+Affinity.timesheets.init.affinityData.toDate.toFriendlyShort(),noClose:!0,showLoader:!0}),n=Affinity.zelosroot+"?api=timesheetAsManager/get",n+="&view=detail",n+="&page=0",n+="&pageSize="+this.rowsPerPage,n+="&DefaultRosterGroup=dont_return_locked,dont_return_managed",n+="fromDate"in Affinity.timesheets.init.affinityData&&"toDate"in Affinity.timesheets.init.affinityData?"&fromDate="+Affinity.timesheets.init.affinityData.fromDate.format("%d.%b.%Y")+"&toDate="+Affinity.timesheets.init.affinityData.toDate.format("%d.%b.%Y"):"&fromDate="+f.format("%d.%b.%Y")+"&toDate="+r.format("%d.%b.%Y"),"emp"in Affinity.timesheets.init.affinityData&&Affinity.timesheets.init.affinityData.emp!==""&&(n+="&employeeNo="+Affinity.timesheets.init.affinityData.emp),n+="status"in Affinity.timesheets.init.affinityData&&Affinity.timesheets.init.affinityData.status!==""?"&timesheetStatus="+Affinity.timesheets.init.affinityData.status:"&timesheetStatus=Submitted,Declined,Approved,Paid","payPeriod"in Affinity.timesheets.init.affinityData&&Affinity.timesheets.init.affinityData.payPeriod!==""&&(n+="&payPeriod="+Affinity.timesheets.init.affinityData.payPeriod),"payPoint"in Affinity.timesheets.init.affinityData&&Affinity.timesheets.init.affinityData.payPoint!==""&&(n+="&payPoint="+Affinity.timesheets.init.affinityData.payPoint),this.managerLoader.loadTemplate(n)):(uialert({message:t.globals.gets.team,noClose:!0,showLoader:!0}),this.managerLoader.loadTemplate(a.getApi))},gettingBulkDetails:!1,getBulkDetails:function(){this.gettingBulkDetails=!0,new ZelosWidgetTimesheetBulkEntry({target:this.options.bulkTarget,putApi:Affinity.zelosroot+"?api=timesheetAsManager/post",getEmptyTimesheetApi:Affinity.zelosroot+"?api=timesheetAsManager/getEmptyTimesheet",onComplete:function(){this.bulkProcessed=!0}.bind(this)})},gettingEmployeeMileages:!1,getEmployeeMileageTimesheets:function(){var t=Affinity.languages.english.application.timesheets,e,n,o;uialert({message:t.globals.gets.milage,noClose:!0,showLoader:!0}),this.gettingEmployeeMileage=!0,this.options.employeeMileageTarget.removeClass("hidden");var r={mode:"Affinity"},u=this.defaultStartDate,i=this.defaultEndDate,s=this.defaultStartDate.clone(),h=this.defaultEndDate.clone(),f=Affinity.ShowManagerAllUnapproved==="*"?!0:!1;f||Affinity.ShowManagerAllUnapproved.trim()===""||(e=Affinity.ShowManagerAllUnapproved.split(","),(e.contains(Affinity.login.profile.companyNumber)||e.contains(Affinity.login.profile.companyNumber+""))&&(f=!0)),f&&(u=Affinity.login.profile.oldestTimesheetDate,i=Affinity.login.profile.newestTimesheetDate,Affinity.login.userProfiles[Affinity.login.profile.employeeNumber].payPeriods.currentEnds&&(i=Affinity.login.userProfiles[Affinity.login.profile.employeeNumber].payPeriods.currentEnds),s=u.clone(),h=i.clone()),Affinity.login.profile.admin&&(u=this.defaultStartDate.clone(),i=this.defaultEndDate.clone(),s=this.defaultStartDate.clone(),h=this.defaultEndDate.clone()),n=Affinity.zelosroot+"?api=mileage/get",n+=this.getDateParams(),n+="&view=detail",n+="&page=0",n+="&pageSize="+this.rowsPerPage,o={target:this.options.employeeMileageTarget,getApi:n,putApi:Affinity.zelosroot+"?api=mileage/post",getEmptyTimesheetApi:Affinity.zelosroot+"?api=mileage/getEmptyMileage",timesheetType:"employeeMilaege",isManager:this.isManager,isEmployee:this.isEmployee,fromDate:this.defaultStartDate,toDate:this.defaultEndDate,readOnly:!1,onSaveError:function(){},beforSave:function(n){var f=!1,i=n.button,o=i.getParent("tr.timesheet-row")?i.getParent("tr.timesheet-row"):i.get("data-row-ref")?document.getElement("tr#"+i.get("data-row-ref")):!1,e,u;if((i.hasClass("orange")||i.hasClass("green"))&&(i.hasClass("orange")&&window.uialert({message:t.globals.savingSelectedMileage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),i.hasClass("green")&&(window.uialert({message:t.globals.submittingSelectedMileage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),f="submit")),e=!0,u=this.getWidget(),"internalWidget"in u&&"reduceBulkRows"in u.internalWidget)if(f){if(e=u.internalWidget.reduceBulkRows(f,this.ignoreDeclined),this.ignoreDeclined=!1,!e)return Affinity.UI.___tempCallback=function(n){this.ignoreDeclined=n.ignoreDeclined,window.removeEvent("__tempCallback",Affinity.UI.___tempCallback),Affinity.UI.___tempCallback=null,delete Affinity.UI.___tempCallback,r.zelosProcessor.submit({target:i})}.bind(this),window.addEvent("__tempCallback",Affinity.UI.___tempCallback),!1}else u.internalWidget.cleanFavData();return!0}.bind(this),onSave:function(){},onComplete:function(){this.employeeMileageProcessed=!0,Affinity.prompts.hide(),this.options.employeeMileageTarget.getElements(".form-row.buttons")&&(Array.each(this.options.employeeMileageTarget.getElements(".form-row.buttons").getParent(".default-form").getElements(".form-row"),function(n){n.getParent(".default-form").hasClass("timesheetSearchFrom")||n.addClass("inline")}),this.options.employeeMileageTarget.getElements(".form-row.required-message").removeClass("inline")),this.options.employeeMileageTarget.getElements(".showSearch,.addrows").addClass("hidden"),this.options.employeeMileageTarget.getElement(".section-header")&&this.options.employeeMileageTarget.getElement(".section-header").addClass("hidden"),Affinity.mobile}.bind(this)},r.zelosProcessor=new ZelosTemplateProcess(o),this.employeeMileageLoader=new ZelosTemplateLoad({onRequest:function(){},onError:function(n){this.employeeMileageProcessed=!0;var i="";i+='<div class="section shadow "><div class="section-body"><div class="section-row">',i+=t.globals.getError+"<!--"+n+"-->",i+="<\/div><\/div><\/div>",this.options.employeeMileageTarget.set("html",i),Affinity.prompts.hide()}.bind(this),onComplete:function(n){Array.each(n.Children,function(t,i){t.ElementType==="SectionHeading"&&t.Name==="Forwarding"&&(n.Children[i]=null,n.Children.splice(i,1))}),r.zelosProcessor.processTemplate(n)}}).loadTemplate(o.getApi)},gettingManagerMileages:!1,getManagerMileageTimesheets:function(){var i=Affinity.languages.english.application.timesheets,h,n,t;uialert({message:i.globals.gets.teamMilage,noClose:!0,showLoader:!0}),this.gettingManagerMileage=!0,this.options.managerMileageTarget.removeClass("hidden");var f={mode:"Affinity"},e=this.defaultStartDate,r=this.defaultEndDate,o=this.defaultStartDate.clone(),s=this.defaultEndDate.clone(),u=Affinity.ShowManagerAllUnapproved==="*"?!0:!1;u||Affinity.ShowManagerAllUnapproved.trim()===""||(h=Affinity.ShowManagerAllUnapproved.split(","),(h.contains(Affinity.login.profile.companyNumber)||h.contains(Affinity.login.profile.companyNumber+""))&&(u=!0)),u&&(e=Affinity.login.profile.oldestTimesheetDate,r=Affinity.login.profile.newestTimesheetDate,Affinity.login.userProfiles[Affinity.login.profile.employeeNumber].payPeriods.currentEnds&&(r=Affinity.login.userProfiles[Affinity.login.profile.employeeNumber].payPeriods.currentEnds),o=e.clone(),s=r.clone()),Affinity.login.profile.admin&&(e=this.defaultStartDate.clone(),r=this.defaultEndDate.clone(),o=this.defaultStartDate.clone(),s=this.defaultEndDate.clone()),n=Affinity.zelosroot+"?api=mileage/GetAsManager",n+=this.getDateParams(),n+="&timesheetStatus=Submitted",n+="&view=detail",n+="&page=0",n+="&pageSize="+this.rowsPerPage,n+=u?"&DefaultRosterGroup=dont_return_locked":"&DefaultRosterGroup=dont_return_locked,dont_return_managed",t={target:this.options.managerMileageTarget,getApi:n,putApi:Affinity.zelosroot+"?api=mileage/PostAsManager",getEmptyTimesheetApi:Affinity.zelosroot+"?api=mileage/GetEmptyMileageAsManager",timesheetType:"managerMileage",isManager:this.isManager,isEmployee:this.isEmployee,fromDate:this.defaultStartDate,toDate:this.defaultEndDate,filterFromDate:o,filterToDate:s,readOnly:!1,onSaveError:function(n){var t=n;typeOf(n)==="object"&&n.hasOwnProperty("errors")&&(t=[],Array.each(n.errors,function(n){t.push(n[2])}),t=t.join("<br />"),uialert({message:Affinity.languages.english.generic.error+"<br />"+t,noClose:!1,showButtons:!0,showLoader:!1}))},beforSave:function(n){var r=!1,t=n.button,h=t.getParent("tr.timesheet-row")?t.getParent("tr.timesheet-row"):t.get("data-row-ref")?document.getElement("tr#"+t.get("data-row-ref")):!1,o=!1,u=this.getWidget(),e,s;if((t.hasClass("orange")||t.hasClass("green"))&&(t.innerText!==undefined&&t.innerText!==null&&t.innerText.indexOf("Forward Selected")>-1?(o=!0,t.hasClass("green")&&(window.uialert({message:i.globals.forwardingSelectedMileage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),r="submit")):(t.hasClass("orange")&&window.uialert({message:i.globals.savingSelectedMileage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),t.hasClass("green")&&(window.uialert({message:i.globals.submittingSelectedMileage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),r="submit"))),e=!0,"internalWidget"in u&&"reduceBulkRows"in u.internalWidget)if(r){if(o?s=u.internalWidget.cleanFavData(r):e=u.internalWidget.reduceBulkRows(r,this.ignoreDeclined),this.ignoreDeclined=!1,!e)return Affinity.UI.___tempCallback=function(n){this.ignoreDeclined=n.ignoreDeclined,window.removeEvent("__tempCallback",Affinity.UI.___tempCallback),Affinity.UI.___tempCallback=null,delete Affinity.UI.___tempCallback,f.zelosProcessor.submit({target:t})}.bind(this),window.addEvent("__tempCallback",Affinity.UI.___tempCallback),!1}else s=u.internalWidget.cleanFavData(r);return!0}.bind(this),onSave:function(){},onComplete:function(){this.managerMileageProcessed=!0,Affinity.prompts.hide(),this.options.managerMileageTarget.getElements(".form-row.buttons")&&(Array.each(this.options.managerMileageTarget.getElements(".form-row.buttons").getParent(".default-form").getElements(".form-row"),function(n){n.getParent(".default-form").hasClass("timesheetSearchFrom")||n.addClass("inline")}),this.options.managerMileageTarget.getElements(".form-row.required-message").removeClass("inline")),this.options.managerMileageTarget.getElements(".showSearch,.addrows").addClass("hidden"),this.options.managerMileageTarget.getElement(".section-header")&&this.options.managerMileageTarget.getElement(".section-header").addClass("hidden"),Affinity.mobile}.bind(this)},t.target.firstChild!==null&&t.target.removeChild(t.target.firstChild),f.zelosProcessor=new ZelosTemplateProcess(t),this.managerMileageLoader=new ZelosTemplateLoad({onRequest:function(){},onError:function(n){this.managerMileageProcessed=!0;var t="";t+='<div class="section shadow "><div class="section-body"><div class="section-row">',t+=i.globals.getError+"<!--"+n+"-->",t+="<\/div><\/div><\/div>",this.options.managerMileageTarget.set("html",t),Affinity.prompts.hide()}.bind(this),onComplete:function(n){Array.each(n.Children,function(n){n.Name==="Forwarding"&&Array.each(n.Children,function(n){n.Name==="ForwardTo"&&(n.SortBy="innerText-lastname")}.bind(this))}.bind(this)),f.zelosProcessor.processTemplate(n)}}).loadTemplate(t.getApi)},sanatiseTimesheetDoc:function(n){var i,t;return n.hasOwnProperty("Children")&&Array.isArray(n.Children)&&n.Children.length>0&&(timesheetDoc=Object.clone(n),Array.each(timesheetDoc.Children,function(n,r){var u,f;if(i=!1,Object.each(n.Description,function(n,i){typeOf(n)!=="null"&&(t=n,t=t.replace("\r\n"," "),t=t.replace(new RegExp("%","gi"),"%25"),t=t.replace(new RegExp(";","gi"),"%3B"),t=decodeURIComponent(t),t=t.replace(new RegExp("&","gi"),"%26"),t=t.replace(new RegExp("&amp;","gi"),"%26"),t=t.replace(new RegExp("&","gi"),"%26"),t=encodeURIComponent(t),timesheetDoc.Children[r].Description[i]=t)}.bind(this)),n.Attribute.IsReadOnly&&n.Name.contains(new RegExp("tsnet","gi"))&&(i=!0,timesheetDoc.Children[r]=null,timesheetDoc.Children.splice(r,1)),n.Attribute.hasOwnProperty("Message")&&(timesheetDoc.Children[r].Attribute.Message=null,delete timesheetDoc.Children[r].Attribute.Message),n.Attribute.hasOwnProperty("Error")&&(timesheetDoc.Children[r].Attribute.Error=null,delete timesheetDoc.Children[r].Attribute.Error),i||n.hasOwnProperty("Data")&&(timesheetDoc.Children[r].Data=null,delete timesheetDoc.Children[r].Data),!i&&n.hasOwnProperty("Source")&&n.Source.PropertyName==="RowButton"&&(u=[],Array.each(n.Children,function(n,t){n.ElementType==="CustomButton"&&u.push(t)}),u.length>0))for(f=0;f<u.length;f++)timesheetDoc.Children[r].Children.splice(u[f],1)}),timesheetDoc.hasOwnProperty("Attribute")&&timesheetDoc.Attribute.hasOwnProperty("Message")&&(timesheetDoc.Attribute.Message=null,delete timesheetDoc.Attribute.Message),timesheetDoc.hasOwnProperty("Attribute")&&timesheetDoc.Attribute.hasOwnProperty("Error")&&(timesheetDoc.Attribute.Error=null,delete timesheetDoc.Attribute.Error)),timesheetDoc},sanatisePostDocument:function(n){var t=[],i;if(n.hasOwnProperty("ElementType"))switch(n.ElementType){case"Document":try{n=Object.clone(n),i=n.Children[0].Children[0],i.hasOwnProperty("Attribute")&&i.Attribute.hasOwnProperty("Message")&&(n.Children[0].Children[0].Attribute.Message=null,delete n.Children[0].Children[0].Attribute.Message),i.hasOwnProperty("Attribute")&&i.Attribute.hasOwnProperty("Error")&&(n.Children[0].Children[0].Attribute.Error=null,delete n.Children[0].Children[0].Attribute.Error),Array.each(n.Children[0].Children[0].Children,function(t,i){n.Children[0].Children[0].Children[i]=this.sanatiseTimesheetDoc(t)}.bind(this))}catch(r){t.push('Failed to clean Document from type "Document"',r)}break;case"SectionHeading":try{n=Object.clone(n),Array.each(n.Children[0].Children,function(t,i){n.Children[0].Children[i]=this.sanatiseTimesheetDoc(t)}.bind(this))}catch(r){t.push('Failed to clean document from type "SectionHeading"',r)}break;case"TimesheetTable":try{n=Object.clone(n),Array.each(n.Children,function(t,i){n.Children[i]=this.sanatiseTimesheetDoc(t)}.bind(this)),n.hasOwnProperty("Attribute")&&n.Attribute.hasOwnProperty("Message")&&(n.Attribute.Message=null,delete n.Attribute.Message),n.hasOwnProperty("Attribute")&&n.Attribute.hasOwnProperty("Error")&&(n.Attribute.Error=null,delete n.Attribute.Error)}catch(r){t.push('Failed to clean document from type "TimesheetTable"',r)}break;case"TimesheetRow":try{n=this.sanatiseTimesheetDoc(n)}catch(r){t.push('Failed to clean document from type "TimesheetRow"',r)}break;default:t.push('Failed to clean document. Do not understand type "'+n.ElementType+'"')}else t.push('Failed to clean document. Document does not contain property "ElementType"');return t.length>0&&(t.forEach(function(n){console.error(n)}),console.log(n)),n},fromAffinityOverrides:!1,timesheetsStarted:!1,startTimesheets:function(){var i=Affinity.languages.english.application.timesheets,t;if(this.timesheetsStarted=!0,this.options.externalSource==="Max"){var n=new Date,r=n.clone().decrement("day",14),u=n.clone().increment("day",7);if(this.affinityData={emp:Affinity.login.profile.employeeNumber,fromDate:r,toDate:u,units:0,origin:"Max"},this.options.filters&&typeOf(this.options.filters)==="object"&&(this.options.filters.fromDate!==""&&Date.parse(this.options.filters.fromDate).isValid()&&(this.affinityData.fromDate=Date.parse(this.options.filters.fromDate)),this.options.filters.toDate!==""&&Date.parse(this.options.filters.toDate).isValid()&&(this.affinityData.toDate=Date.parse(this.options.filters.toDate)),this.options.filters.date!==""&&Date.parse(this.options.filters.date).isValid()&&(this.affinityData.fromDate=Date.parse(this.options.filters.date),this.affinityData.toDate=Date.parse(this.options.filters.date)),this.options.filters.units!==""&&(this.affinityData.units=parseFloat(this.options.filters.units)),this.options.filters.employeeNo!==""&&this.options.filters.employeeNo===-1&&this.options.filters.employeeNo==="-1"&&(this.affinityData.emp=this.options.filters.employeeNo.trim()),this.options.filters.payPeriod!==""&&(this.affinityData.payperiod=this.options.filters.payPeriod.trim()),this.options.filters.payPoint!==""&&(this.affinityData.payPoint=this.options.filters.payPoint.trim()),this.options.filters.status!==""&&(this.affinityData.status=this.options.filters.status.trim())),this.tabBox.removeClass("hidden"),this.areas.ShowDetailView){this.switchToEmployeeDetailedView();return}if(this.areas.ShowDualDetailView){this.switchToDualdetailView();return}if(this.areas.ShowView){this.switchToEmployeeView();return}}else if(this.options.externalSource==="Affinity"){if(this.isManager){var n=new Date,r=n.clone().decrement("day",14),u=n.clone().increment("day",7);this.affinityData={fromDate:r,toDate:u,origin:"Affinity"},this.options.filters&&typeOf(this.options.filters)==="object"&&(this.options.filters.fromDate!==""&&Date.parse(this.options.filters.fromDate).isValid()&&(this.affinityData.fromDate=Date.parse(this.options.filters.fromDate)),this.options.filters.toDate!==""&&Date.parse(this.options.filters.toDate).isValid()&&(this.affinityData.toDate=Date.parse(this.options.filters.toDate)),this.options.filters.employeeNo!==""&&(this.affinityData.emp=this.options.filters.employeeNo.trim()),this.options.filters.payPeriod!==""&&(this.affinityData.payperiod=this.options.filters.payPeriod.trim()),this.options.filters.payPoint!==""&&(this.affinityData.payPoint=this.options.filters.payPoint.trim()),this.options.filters.status!==""&&(this.affinityData.status=this.options.filters.status.trim())),this.switchToManagerView()}else uialert({message:i.globals.affnityMangerError});this.tabBox.removeClass("hidden");return}if(t=this.getView(),t){["period","overview","dualdetail","employee","detailed","manager","bulk","employeeMilaege","managerMileage"].indexOf(t)>-1&&this.tabBox.removeClass("hidden");switch(t){case"period":this.switchToPeriodView();return;case"overview":this.switchToOverviewView();return;case"dualdetail":this.switchToDualdetailView();return;case"employee":this.switchToEmployeeView();return;case"detailed":this.switchToEmployeeDetailedView();return;case"manager":this.switchToManagerView();return;case"bulk":this.switchToBulkView();return;case"employeeMilaege":this.switchToMileageView();return;case"managerMileage":this.switchToManagerMileageView();return}}this.isEmployee&&!this.isManager?this.areas.ShowOverviewView?this.switchToOverviewView():this.areas.ShowDualDetailView?this.switchToDualdetailView():this.areas.ShowView?this.switchToEmployeeView():this.areas.ShowDetailView?this.switchToEmployeeDetailedView():uialert({message:i.globals.noViewError}):this.isEmployee&&this.isManager?this.areas.ShowPeriodView?this.switchToPeriodView():this.areas.ShowDualDetailView?this.switchToDualdetailView():this.switchToManagerView():!this.isEmployee&&this.isManager?this.areas.ShowPeriodView?this.switchToPeriodView():this.areas.ShowDualDetailView?this.switchToDualdetailView():this.switchToManagerView():uialert({message:i.globals.noUserTypeError}),this.tabBox.removeClass("hidden")},getPayPeriods:function(n){var t={},c=Date.parse(n.previousPaydate).increment("day",1),a=Date.parse(n.currentPaydate),s=Date.parse(n.oldestTimesheetDate),h=Date.parse(n.newestTimesheetDate),u=Math.round((a-c)/864e5)+1,o,w=Math.ceil(Math.ceil((c-s)/864e5)/u),b=Math.ceil(Math.ceil((h-a)/864e5)/u),i=new Date,v=!1,l=!1,r,f,e,y,p;for(t.length=u,t.currentBegins=c.clone(),t.currentEnds=a.clone(),t.oldest=s.clone(),t.newest=h.clone(),t.periods=[],t.periodTodayIndex=0,t.periodCurrentIndex=0,o=w;o>0;o--)e=!1,r=c.clone().decrement("day",u*o),f=r.clone().increment("day",u-1),i.greaterThanOrEqualTo(r)&&i.lessThanOrEqualTo(f)&&(e=!0,t.periodTodayIndex=t.periods.length+0,v=!0,l=t.periods.length+0),t.periods.push({from:r,to:f,current:!1,containsToday:e});for(e=!1,r=c.clone(),f=r.clone().increment("day",u-1),i.greaterThanOrEqualTo(r)&&i.lessThanOrEqualTo(f)&&(e=!0,t.periodTodayIndex=t.periods.length),t.periodCurrentIndex=t.periods.length,t.periods.push({from:r,to:f,current:!0,containsToday:e}),o=1;o<b+1;o++)e=!1,r=c.clone().increment("day",u*o),f=r.clone().increment("day",u-1),i.greaterThanOrEqualTo(r)&&i.lessThanOrEqualTo(f)&&(e=!0,t.periodTodayIndex=t.periods.length),t.periods.push({from:r,to:f,current:!1,containsToday:e});return t.lastPayDate=Date.parse(n.previousPaydate),t.currentPayDate=Date.parse(n.currentPaydate),t.nextPayDate=Date.parse(n.currentPaydate).increment("day",u),t.ribbon={},t.ribbon.isPeriod=!1,t.ribbon.todayPeriod=v,t.ribbon.todayPeriodIndex=l,t.ribbon.stopAPIs=!0,t.ribbon.startDate=i.clone(),t.ribbon.innerFromDate=s.clone(),t.ribbon.innerToDate=h.clone(),t.ribbon.fromDate=s.clone(),t.ribbon.toDate=h.clone(),v?(t.ribbon.innerFromDate=t.periods[l].from.clone(),t.ribbon.innerToDate=t.periods[l].to.clone(),t.ribbon.checkApi=!1,t.ribbon.isPeriod=!0):i.greaterThanOrEqualTo(s)&&i.lessThanOrEqualTo(h)?(y=i.clone().decrement("day",t.length/2),p=i.clone().increment("day",t.length/2),t.length&&t.length>0&&y.greaterThanOrEqualTo(s)&&p.lessThanOrEqualTo(h)&&(t.ribbon.startDate=i.clone(),t.ribbon.innerFromDate=y.clone(),t.ribbon.innerToDate=p.clone(),t.ribbon.checkApi=!1)):(i.lessThanOrEqualTo(s)&&(t.ribbon.fromDate=i.clone(),t.ribbon.innerFromDate=i.clone()),i.greaterThanOrEqualTo(h)&&(t.ribbon.toDate=i.clone(),t.ribbon.innerToDate=i.clone())),t},loggedin:function(n,t){var y=Affinity.languages.english.application.timesheets,c,i,h,f,r,u,l,a,p,v;if(Affinity.hasDashboard&&this.dashboardLoginDelayHackTimer&&clearTimeout(this.dashboardLoginDelayHackTimer),c=typeOf(t)!=="null"&&t?!0:!1,navBox=document.getElement(".section-nav"),appname=Affinity.appname,i=!1,Affinity.apiversion>1)try{i=Affinity.login.areas}catch(k){}else if(i=Affinity.CookieMonster.Read(appname+"Areas"),typeOf(i)!=="null"&&i!==!1)try{i=JSON.parse(i)}catch(k){}if(typeOf(i)==="object"&&"Timesheet"in i&&(i=i.Timesheet,("ShowWeeklyView"in i&&i.ShowWeeklyView||"ShowDetailView"in i&&i.ShowDetailView||"ShowOverviewView"in i&&i.ShowOverviewView||"ShowDualDetailView"in i&&i.ShowDualDetailView||"ShowPeriodView"in i&&i.ShowPeriodView||"ShowBulkView"in i&&i.ShowBulkView)&&(this.areas=i)),this.defaultView=this.areas.DefaultView,this.loginvalues=!1,this.payPoints=!1,this.publicHolidays=!1,this.defaultStartDate=!1,Affinity.apiversion>1)this.payPoints=Affinity.login.profile.payPoints,this.publicHolidays=Affinity.login.profile.publicHolidays,Affinity.login.profile.previousPaydate&&(this.defaultStartDate=Affinity.login.profile.previousPaydate.clone().increment("day",1));else{if(typeOf(n)==="string"&&n!==""){var o=Affinity.CookieMonster.Read(appname+"Values"),e=Affinity.CookieMonster.Read(appname+"PayPoints"),s=Affinity.CookieMonster.Read(appname+"PublicHolidays");o!==null&&(o=JSON.parse(o),o&&(this.loginvalues=o)),e!==null&&(e=JSON.parse(e),typeOf(e)==="array"&&e.length>0&&(this.payPoints=e)),s!==null&&(s=JSON.parse(s),typeOf(s)==="array"&&(this.publicHolidays=s))}this.loginvalues&&this.loginvalues.ShowTimesheetFrom&&(this.defaultStartDate=this.loginvalues.ShowTimesheetFrom)}if((Affinity.apiversion<2&&!this.loginvalues||!this.areas||!this.payPoints||!this.publicHolidays||!this.defaultStartDate)&&(Affinity.prompts.hide(),!c))return this.resetPanels(),"hasDashboard"in Affinity&&Affinity.hasDashboard!==!1?(document.getElement(".noconfigbox")?h=document.getElement(".noconfigbox .noconfigmsg"):(h=new Element("div",{"class":"message noconfigmsg"}),new Element("div",{"class":"section shadow"}).adopt(new Element("div",{"class":"section-body"}).adopt(h)).inject(document.getElement(".contentwrapper"),"bottom")),h.set("html",y.globals.noDashboard)):this.logout(y.globals.noDashboard),!1;if(f=Affinity.login.profile.companyNumber+"",r=Affinity.acValues.maxDefault,r=Affinity.acValues.veryFastComps==="*"?Affinity.acValues.maxVeryFast:r,r=Affinity.acValues.fastComps==="*"?Affinity.acValues.maxFast:r,r=Affinity.acValues.slowComps==="*"?Affinity.acValues.maxSlow:r,r=Affinity.acValues.defaultComps.contains(f)?Affinity.acValues.maxDefault:r,r=Affinity.acValues.slowComps.contains(f)?Affinity.acValues.maxSlow:r,r=Affinity.acValues.fastComps.contains(f)?Affinity.acValues.maxFast:r,r=Affinity.acValues.veryFastComps.contains(f)?Affinity.acValues.maxVeryFast:r,Affinity.selectmax=r,u=Affinity.login.profile.employeeNumber+0,Affinity.login.userProfiles[u].payPeriods=this.getPayPeriods(Affinity.login.userProfiles[u],log.enabled),Affinity.login.profile={},Affinity.login.profile=Object.clone(Affinity.login.userProfiles[u]),this.defaultEndDate=new Date,this.showDays=7,Affinity.mobile===!1&&this.areas&&typeOf(this.areas.WeeklyDays)!=="null"&&!isNaN(this.areas.WeeklyDays)&&this.areas.WeeklyDays>0&&(this.showDays=this.areas.WeeklyDays),Affinity.apiversion>1?(this.defaultEndDate=Affinity.login.profile.newestTimesheetDate,this.defaultStartDay=Affinity.login.profile.startDayOfTheWeek,this.rowsPerPage=Affinity.login.profile.rowsPerPage):(this.loginvalues&&this.loginvalues.NewestTimesheetDate&&(this.defaultEndDate=this.loginvalues.NewestTimesheetDate),this.defaultStartDay=0,this.areas&&typeOf(this.areas.StartDayOfTheWeek)!=="null"?this.defaultStartDay=this.areas.StartDayOfTheWeek:this.loginvalues&&typeOf(this.loginvalues.StartDayOfTheWeek)!=="null"&&(this.defaultStartDay=this.loginvalues.StartDayOfTheWeek),this.rowsPerPage=10,Affinity.mobile===!1&&(this.areas&&typeOf(this.areas.RowsPerPage)!=="null"&&!isNaN(this.areas.RowsPerPage)&&this.areas.RowsPerPage>0?this.rowsPerPage=this.areas.RowsPerPage:this.loginvalues&&typeOf(this.loginvalues.RowsPerPage)!=="null"&&!isNaN(this.loginvalues.RowsPerPage)&&this.loginvalues.RowsPerPage>0&&(this.rowsPerPage=this.loginvalues.RowsPerPage))),Affinity.mobile){var w=window.innerHeight||document.documentElement.clientHeight,b=Math.floor((w-220)/50);this.rowsPerPage=b}return parseInt(Affinity.login.profile.employeeNumber)>=5e6&&(this.areas.ShowWeeklyView=!1),this.buildTabs(),this.isEmployee=!1,this.areas.IsEmployee&&(this.isEmployee=!0),this.isManager=!1,this.areas.IsManager&&(this.isManager=!0),Affinity.DateRangeMethod=!1,Affinity.DateRangeOriginal.contains("*")||Affinity.DateRangeOriginal.contains(f)?Affinity.DateRangeMethod="original":Affinity.DateRangeOldestNewest.contains("*")||Affinity.DateRangeOldestNewest.contains(f)?(Affinity.DateRangeMethod="oldnew",Affinity.login.userProfiles[u].hasOwnProperty("payPeriods")&&(this.defaultStartDate=Affinity.login.userProfiles[u].payPeriods.oldest,this.defaultEndDate=Affinity.login.userProfiles[u].payPeriods.newest)):(Affinity.DateRangePayPeriod.contains("*")||Affinity.DateRangePayPeriod.contains(f))&&(Affinity.DateRangeMethod="payperiod",Affinity.login.userProfiles[u].hasOwnProperty("payPeriods")&&(this.defaultStartDate=Affinity.login.userProfiles[u].payPeriods.currentBegins,this.defaultEndDate=Affinity.login.userProfiles[u].payPeriods.currentEnds)),u>5e6&&(this.defaultStartDate=Affinity.login.profile.oldestTimesheetDate,this.defaultEndDate=Affinity.login.profile.currentPayPeriodEnds),this.areas.ShowMileageView=this.overrideMileage==="on"?!0:this.overrideMileage==="off"?!1:this.areas.ShowMileageView,this.areas.ShowPeriodView||(this.removeTab("periodTab"),document.getElement(".period-manage-back")&&(document.getElement(".period-manage-back").removeEvents(),document.getElement(".period-manage-back").destroy())),Affinity.mobile&&(this.areas.ShowDualDetailView=!1,this.areas.ShowOverviewView=!1,this.areas.ShowWeeklyView=!1,this.areas.ShowBulkView=!1,this.areas.ShowDetailView||(this.areas.ShowDetailView=!0),this.areas.IsManager&&(this.areas.ShowTeamView||(this.areas.ShowTeamView=!0))),this.areas.ShowOverviewView||this.removeTab("overviewTab"),this.areas.ShowDualDetailView||this.removeTab("dualdetailTab"),this.areas.ShowWeeklyView||this.removeTab("weeklyTab"),this.areas.ShowDetailView||this.removeTab("detailedTab"),this.areas.ShowBulkView||this.removeTab("bulkTab"),this.areas.ShowMileageView||this.removeTab("mileageTab"),this.areas.ShowMileageView||this.removeTab("teamMilesTab"),this.areas.ShowPeriodView||this.removeTab("periodTab"),this.areas.IsManager?this.areas.ShowTeamView=!0:(this.removeTab("teamTab"),this.removeTab("teamMilesTab"),this.removeTab("settingsTab")),l=!1,(this.areas.IsManager||this.areas.ShowDetailView||this.areas.ShowMileageView)&&(l=!0),a=!1,(this.areas.IsManager||this.areas.ShowWeeklyView||this.areas.ShowDetailView||this.areas.ShowOverviewView||this.areas.ShowDualDetailView||this.areas.ShowMileageView)&&(a=!0),l||this.removeTab("filterTab"),a||this.removeTab("refreshTab"),this.isManager||this.removeTab("periodTab"),p=Affinity.IgnoreDependancyDefaults.replace(new RegExp(" ","gi"),"").split(","),this.ignoreDependancyDefaults=!1,p.contains(parseInt(Affinity.login.companyNumber))&&(this.ignoreDependancyDefaults=!0),Affinity.ignoreDependancyDefaults=this.ignoreDependancyDefaults,Affinity.enableFavourites=!1,!Affinity.mobile&&Affinity.enableFavouritesGlobal&&(this.overrideFavourites&&(Affinity.enableFavourites=!0),!this.overrideFavourites&&Affinity.login.areas.Timesheet.hasOwnProperty("EnableFavourite")&&(Affinity.enableFavourites=Affinity.login.areas.Timesheet.EnableFavourite)),Affinity.enableGridWorkSchedules=!1,Affinity.enableGridWorkSchedulesGlobal&&(Affinity.workScheduleCompanies.trim()==="*"?Affinity.enableGridWorkSchedules=!0:(v=Affinity.workScheduleCompanies.replace(new RegExp(" ","gi"),"").split(","),(v.contains(parseInt(Affinity.login.profile.companyNumber))||v.contains(Affinity.login.profile.companyNumber+""))&&(Affinity.enableGridWorkSchedules=!0))),Affinity.enableFavourites||this.removeTab("favTab"),Affinity.helpLink.trim()===""&&this.removeTab("helpTab"),Affinity.hasDashboardWrapper()&&this.removeTab("logoutTab"),Affinity.forceBrowserRefreshOnLogout=!1,this.areas.ShowPeriodView&&this.areas.ShowDualDetailView&&(Affinity.forceBrowserRefreshOnLogout=!0),this.isLoggedIn=!0,c||(this.isZelosReady&&!this.timesheetsStarted&&this.startTimesheets(),Affinity.mobile),Affinity.hasOwnProperty("EnableAwardsPopupGlobal")&&(Affinity.isAwardsPopupEnabled()||document.querySelector("body").classList.add("hide-calc-buttons")),!0},cancelRequests:function(){var n=!0;return Affinity.uiDisplayLookup&&(Affinity.uiDisplayLookup.cancelQueue(),Affinity.uiDisplayLookup.enabled=!0),Affinity.uiSelectLookup&&(Affinity.uiSelectLookup.cancelQueue(),Affinity.uiSelectLookup.enabled=!0),Affinity.UI.dependancyQueue&&(Affinity.UI.dependancyQueue.cancelQueue(),Affinity.UI.dependancyQueue.enabled=!0),Affinity.hasOwnProperty("ribbons")&&Affinity.ribbons.hasOwnProperty("widgets")&&Array.isArray(Affinity.ribbons.widgets)&&(n=Array.each(Affinity.ribbons.widgets,function(n){n!==null&&n.clear()})),n},logout:function(n){var t=null;this.cancelRequests(),Affinity.oldessLaunched&&(t===null&&(t={}),t.closewindow=!0),typeOf(n)!=="null"&&n!==""&&(t===null&&(t={}),t.message=n);try{window.stop()}catch(i){}try{document.execCommand("Stop")}catch(i){}window.fireEvent("logout",t)},loggedout:function(){window.onbeforeunload=function(){},this.overviewWidget&&"delUnload"in this.overviewWidget&&this.overviewWidget.delUnload(),this.dualdetailWidget&&"delUnload"in this.dualdetailWidget&&this.dualdetailWidget.delUnload(),this.employeeWidget&&"delUnload"in this.employeeWidget&&this.employeeWidget.delUnload(),this.employeeDetailedWidget&&"delUnload"in this.employeeDetailedWidget&&this.employeeDetailedWidget.delUnload(),this.managerWidget&&"delUnload"in this.managerWidget&&this.managerWidget.delUnload(),this.managerMileageWidget&&"delUnload"in this.managerMileageWidget&&this.managerMileageWidget.delUnload(),this.isLoggedIn=!1,this.isEmployee=!1,this.isManager=!1,this.destroy(),window.sessionKey=!1,widget=null,Affinity.loginsThisSession>0&&Affinity.forceBrowserRefreshOnLogout&&(window.location.href=window.location.href)},destroyWidget:function(n){var t,i;t=this.options[n+"Target"],t&&t.getElement(".widget")&&(t.getElement(".widget").retrieve("widget")&&(i=t.getElement(".widget").retrieve("widget"),t.getElement(".widget").eliminate("widget"),"destroy"in i&&i.destroy()),t.empty()),i=this[n+"Widget"],i&&"destroy"in i&&i.destroy()},destroy:function(){this.cancelRequests(),this.managerLoader&&(this.managerLoader.cancel(),this.managerLoader=!1),this.employeeLoader&&(this.employeeLoader.cancel(),this.employeeLoader=!1),this.employeeDetailedLoader&&(this.employeeDetailedLoader.cancel(),this.employeeDetailedLoader=!1),this.employeeMileageLoader&&(this.employeeMileageLoader.cancel(),this.employeeMileageLoader=!1),this.managerMileageLoader&&(this.managerMileageLoader.cancel(),this.managerMileageLoader=!1),this.timesheetsStarted=!1,this.gettingPeriodData=!1,this.gettingOverviewDetails=!1,this.gettingDualdetailTimesheet=!1,this.gettingEmployeeTimesheet=!1,this.gettingEmployeeDetailsTimesheet=!1,this.gettingManagerTimesheet=!1,this.gettingEmployeeMileage=!1,this.gettingManagerMileage=!1,this.destroyWidget("period"),this.destroyWidget("overview"),this.destroyWidget("dualdetail"),this.destroyWidget("employee"),this.destroyWidget("employeeDetailed"),this.destroyWidget("manager"),this.destroyWidget("bulk"),this.destroyWidget("managerMileage"),this.destroyWidget("employeeMileage"),this.dateParam=!1,this.periodWidget=!1,this.overviewWidget=!1,this.dualdetailWidget=!1,this.employeeDetailedWidget=!1,this.employeeWidget=!1,this.managerWidget=!1,this.bulkWidget=!1,this.employeeMileageWidget=!1,this.managerMileageWidget=!1,this.resetPanels(),this.destroyTabs()}}),Affinity.formatLongFloatsInMessage=function(n){var i,r,t;if(n.contains(" hrs")||n.contains(" hours")){for(i=n.split(" "),r=0;r<i.length;r++)t=i[r],!isNaN(parseFloat(t))&&t.contains(".")&&t.split(".").length===2&&t.split(".")[1].length>2&&(i[r]=(Math.round(parseFloat(t)*100)/100).toString());n=i.join(" ")}return n},Affinity.doCheckRowChanges=function(n){if(Affinity.disableRowChangeChecksGlobal)return!1;let t=n?(n+"").trim():Affinity.login.profile.companyNumber?(Affinity.login.profile.companyNumber+"").trim():Affinity.login.companyNumber?(Affinity.login.companyNumber+"").trim():"";return Affinity.disableRowChangeCheckComps.trim()==="*"?!1:Affinity.disableRowChangeCheckComps.contains(t)?!1:!0},Affinity.isAwardsPopupEnabled=function(n){if(!Affinity.enableAwardsPopupGlobal)return!1;let t=n?(n+"").trim():Affinity.login.profile.companyNumber?(Affinity.login.profile.companyNumber+"").trim():Affinity.login.companyNumber?(Affinity.login.companyNumber+"").trim():"";return Affinity.awardsPopupComps.trim()==="*"?!0:Affinity.awardsPopupComps.contains(t)?!0:!1},Affinity.Components=Affinity.Components||{},Affinity.Components.DashboardWrapper={Version:"1.0.8.0",Sequence:10400,Name:"Dashboard Wrapper",File:"ui.dashboard.wrapper.js",Jira:"",Notes:"Fix checks for Form types"},DashboardWrapper=new Class({Implements:[Options,Events],Binds:["init","getConfig","configError","gotConfig","toggleNav","openNav","closeNav","toggleSubNav","openSubNav","closeSubNav","returnNavItem","setupWrapper","loggedin","loggedout"],options:{},initialize:function(){Affinity.commonsReady?this.init():window.addEvent("AffinityReady",this.init)},maxAttempts:10,loadAttempts:0,init:function(){Affinity.hasOwnProperty("hasDashboard")&&Affinity.hasDashboard===!0&&(uiloader({type:"DashboardLoader"}),document.querySelector("body").classList.add("dashboard"),document.querySelector(".pagewrapper").classList.add("dashboard","loading"),this.contentBox=document.querySelector(".pagewrapper .pagecontent"),this.navBox=document.querySelector(".ts-dashboard-nav"),this.navScrollBox=this.navBox.querySelector(".scrollable "),this.navTemplate=this.navScrollBox.querySelector(".dash-nav-item.template.hidden").cloneNode(!0),this.navTemplate.classList.remove("template","hidden"),this.navScrollBox.innerHTML="",this.getConfig())},getConfig:function(){this.loadAttempts++,new Request.JSON({url:Affinity.dashboardConfigPath,onComplete:this.gotConfig,onError:this.configError,onFailure:this.configError}).get()},configError:function(){if(this.loadAttempts<this.maxAttempts){setTimeout(this.getConfig,500);return}document.querySelector(".ts-dashboard-header").classList.add("hidden"),document.querySelector(".ts-dashboard-nav").classList.add("hidden"),document.querySelector(".ts-dashboard-foot").classList.add("hidden"),document.querySelector(".contentwrapper .footer").classList.remove("hidden"),document.querySelector("body").classList.remove("dashboard"),document.querySelector(".pagewrapper").classList.remove("dashboard","loading")},gotConfig:function(n){if(n===null||n===undefined||n===!1||n===""){this.loadAttempts<this.maxAttempts?setTimeout(this.getConfig,500):this.configError();return}this.config=n;var t=this.setupWrapper();Affinity.isLoggedIn?(this.loggedin(),setTimeout(function(){window.addEvent("loggedin",this.loggedin),window.addEvent("loggedout",this.loggedout)}.bind(this),1e3)):(window.addEvent("loggedin",this.loggedin),window.addEvent("loggedout",this.loggedout))},toggleNav:function(){this.navBox.classList.contains("show")?this.closeNav():this.openNav()},openNav:function(){this.navBox.classList.add("show"),this.contentBox.classList.add("dash-menu-open")},closeNav:function(){this.navBox.classList.remove("show"),this.contentBox.classList.remove("dash-menu-open")},stopEventBubbling:function(n){n.stopPropagation()},toggleSubNav:function(n){var i=n.target,t=i.closest(".dash-nav-item"),r=t.querySelector(".sub-nav");r.dataset.state!=="open"?this.openSubNav(t):this.closeSubNav(t)},openSubNav:function(n){var t=n.querySelector(".sub-nav");t.style.height=t.dataset.height+"px",t.dataset.state="open",n.classList.remove("expanded")},closeSubNav:function(n){var t=n.querySelector(".sub-nav");t.style.height="0px",t.dataset.state="closed",n.classList.add("expanded")},returnNavItem:function(n,t){var i=this.navTemplate.cloneNode(!0),s;if(i&&typeof n=="object"&&n.hasOwnProperty("Link")){if(n.Link.hasOwnProperty("Enabled")&&n.Link.Enabled===!1)return!1;var r=i.querySelector(".sub-nav"),u=0,f,o=n.Link.hasOwnProperty("Text")&&typeof n.Link.Text=="string"&&n.Link.Text.trim()!==""?n.Link.Text.trim():"",e=n.Link.hasOwnProperty("Icon")&&typeof n.Link.Icon=="string"&&n.Link.Icon.trim()!==""?n.Link.Icon.trim():!1;i.querySelector(".label").innerHTML=o,e&&i.querySelector(".icon").classList.add("icon-"+e),n.Name==="Timesheets"&&i.classList.add("selected"),n.Link.Menu.length>0&&r?(i.removeAttribute("href"),i.removeAttribute("target"),s={},i.classList.add("has-sub-nav"),i.addEventListener("click",this.toggleSubNav),n.Link.Menu.forEach(function(t){t.Enabled&&(u++,f=this.returnNavItem({Link:t,Name:t.Name},n),r.appendChild(f))}.bind(this)),r.dataset.height=42*u,this.closeSubNav(i)):(i.href=t!==undefined&&n.Link.Url.substring(0,4).toLowerCase()!=="http"?t.Link.Url+n.Link.Url:n.Link.Url,i.target=n.Link.External?"_blank":"_self")}return i},setupWrapper:function(){this.navScrollBox.appendChild(this.returnNavItem({Link:{Enabled:!0,External:!1,Icon:"gauge",Name:"Dashboard",Text:"Dashboard",Url:Affinity.dashboardPath,Menu:[]},Name:"Dashboard"}));let n=!0;return this.config&&this.config.hasOwnProperty("Apps")&&Object.keys(this.config.Apps).length>0&&(n=!1,this.config.Apps.forEach(function(n){typeof n=="object"&&n!==null&&"hasOwnProperty"in n&&n.hasOwnProperty("Link")&&typeof n.Link=="object"&&n.Link!==null&&"hasOwnProperty"in n.Link&&n.Link.hasOwnProperty("Enabled")&&n.Link.Enabled===!0&&this.navScrollBox.appendChild(this.returnNavItem(n))}.bind(this))),this.config&&this.config.hasOwnProperty("Forms")&&Object.keys(this.config.Forms).length>0&&(n=!1,this.config.Forms.forEach(function(n){typeof n=="object"&&n!==null&&"hasOwnProperty"in n&&n.hasOwnProperty("Enabled")&&typeof n.Enabled=="boolean"&&n.Enabled===!0&&n.hasOwnProperty("Text")&&typeof n.Text=="string"&&n.Text.trim()!==""&&n.hasOwnProperty("Icon")&&typeof n.Icon=="string"&&n.Icon.trim()!==""&&n.hasOwnProperty("Url")&&typeof n.Url=="string"&&n.Url.trim()!==""?this.navScrollBox.appendChild(this.returnNavItem({Name:n.Text,Link:n})):typeof n=="object"&&n!==null&&"hasOwnProperty"in n&&n.hasOwnProperty("Link")&&typeof n.Link=="object"&&n.Link!==null&&"hasOwnProperty"in n.Link&&n.Link.hasOwnProperty("Enabled")&&n.Link.Enabled===!0&&this.navScrollBox.appendChild(this.returnNavItem(n))}.bind(this))),n&&this.navScrollBox.appendChild(this.returnNavItem({Link:{Enabled:!0,External:!1,Icon:"clock",Name:"Timesheets",Text:"Timesheets",Url:"./",Menu:[]},Name:"Timesheets"})),document.querySelector(".dash-menu-toggle").addEventListener("click",this.toggleNav),document.querySelector(".dash-nav-item.logout").href=Affinity.dashboardLogoutPath,document.querySelector(".contentwrapper .footer").classList.add("hidden"),document.querySelector(".pagewrapper").classList.remove("loading"),this.scrollable=document.querySelector(".scrollable"),Ps.initialize(this.scrollable),!0},loggedin:function(){var n=document.querySelector(".ts-dashboard-header .displayname"),t=document.querySelector(".ts-dashboard-header .dash-header-logo img");t&&(t.src=Affinity.dashboardPath+"/Root/Logo?company="+Affinity.login.profile.companyNumber+"&employee="+Affinity.login.profile.employeeNumber),n&&(n.innerHTML=Affinity.login.profile.firstName+" "+Affinity.login.profile.lastName),prompts.hide("DashboardLoader")},loggedout:function(){}})