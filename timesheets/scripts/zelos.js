function ZelosError(n){this.name="ZelosError",this.message=n||""}var ZelosInit,ZelosProcessFileds,ZelosTemplateLoad,ZelosTemplateProcess,ZelosViewSettings,ZelosAwardModal,ZelosWidget,ZelosWidgetDependancyQueue,ZelosWidgetDependancy,ZelosWidgetTable,ZelosWidgetTimesheetBulkEntry,ZelosWidgetTimesheetTableAsDetailed,widget,rowid,rowIndex;return Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosInit={Version:"1.0.2.0",Sequence:10100,Name:"Zelos Init",File:"ui.zelos.init.js",Jira:"",Notes:"Update root basepath"},!1 in window&&(window.Affinity={}),Affinity.zelos={},Affinity.zelos.Elements={},ZelosError.prototype=Error.prototype,ZelosInit=new Class({Implements:[Options,Events],Binds:["loadHtmlTemplate","htmlTemplateLoadError","htmlTemplayeLoaded"],options:{htmlTemplateUrl:"/Content/html/ZelosHtmlTemplates.html",requiredUiComponenets:["UITabs","UIGrid","UIHelpBubble","UIHelpIcon","UITooltips","UIDrawPanels","UIModal","UIPompts","UISelectLookup","UIUplaodersMulti","UIDateCalendar","UIValidation","UIHidables"],requiredZelosComponenets:["ZelosTemplateLoad","ZelosTemplateProcess"]},initialize:function(n){this.setOptions(n);var r,i=this.options.requiredUiComponenets.combine(this.options.requiredZelosComponenets),t=[];if(Array.each(i,function(n){typeOf(window[n])!="class"&&t.push(n)}),t.length>0)throw new ZelosError("There are components missing that are required for Zelos to run:\n"+t.join("\n")+"\nPlease refer to 'Setting up Zelos UI' in documentation.");delete r,delete i,delete t,Affinity.zelos.getElement=this.getElement,Affinity.zelos.getElementFromData=this.getElementFromData,this.loadHtmlTemplate()},loadHtmlTemplate:function(){this.fireEvent("request",Affinity.basepath+this.options.htmlTemplateUrl),new Request.HTML({url:Affinity.basepath+this.options.htmlTemplateUrl,evalScripts:!1,onFailure:this.htmlTemplateLoadError,onError:this.htmlTemplateLoadError,onSuccess:this.htmlTemplayeLoaded}).get()},htmlTemplateLoadError:function(){ga&&ga("send","event","Zelos","HtmlTemplate","load failed ("+Affinity.basepath+this.options.htmlTemplateUrl+")"),Affinity.prompts.hide(),this.fireEvent("error",'"'+Affinity.basepath+this.options.htmlTemplateUrl+'" must exist in your project.')},htmlTemplayeLoaded:function(n){var t;Array.each(n,function(n){(typeOf(n)=="element"||typeOf(n)=="table")&&n.get("data-form-element")&&n.get("data-form-element")!=""&&(Affinity.zelos.Elements[n.get("data-form-element")]=n.hasClass("get-tr")?n.getElement("tr"):n)}),delete t,this.fireEvent("complete")},setTemplateElement:function(n,t){Affinity.zelos.Elements[n]=t},getElement:function(n){return Affinity.zelos.Elements[n]?Affinity.zelos.Elements[n].clone():!1},getElementFromData:function(n){if(typeOf(n)!=="null"){var t=n.ElementType?n.ElementType:n.InputType,i=n.ElementType?"ElementType":"InputType";if(typeOf(Affinity.zelos.Elements[t])==="class")return Affinity.zelos.Elements[t];if(n.ElementType=="FieldEdit"||n.ElementType=="FieldDisplay")switch(n.InputType){case"Currency":if(Affinity.zelos.Elements.CurrencyInput)return Affinity.zelos.Elements.CurrencyInput.clone();default:return Affinity.zelos.Elements[t].clone()}if(Affinity.zelos.Elements[t])return Affinity.zelos.Elements[t].clone()}return!1}}),function(n,t,i,r,u,f,e){n.GoogleAnalyticsObject=u,n[u]=n[u]||function(){(n[u].q=n[u].q||[]).push(arguments)},n[u].l=1*new Date,f=t.createElement(i),e=t.getElementsByTagName(i)[0],f.async=1,f.src=r,e.parentNode.insertBefore(f,e)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-45869305-1","teampayoffice.com"),ga("create","UA-45869305-1",{cookieDomain:"none"}),ga("send","pageview"),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosProcessFileds={Version:"1.0.14.0",Sequence:10130,Name:"Zelos Process Fields",File:"ui.zelos.process.field.js",Jira:"",Notes:"Add class to calc button for optional hiding"},ZelosProcessFileds=new Class({Implements:[Options,Events],Binds:[],options:{zelosProcessor:null,dateDisplayFormat:"%A %B %e%o %Y",timeDisplayFormat:"%l:%M %p"},template:null,initialize:function(n){this.setOptions(n),this.zelosProcessor=this.options.zelosProcessor,this.icons={},this.icons.save=Affinity.icons.Tick,this.icons.submit=Affinity.icons.Paperplane,this.icons.accept=Affinity.icons.ThumbsUp,this.icons.progress=Affinity.icons.Tick,this.icons.success=Affinity.icons.Tick,this.icons.cancel=Affinity.icons.Cancel,this.icons.del=Affinity.icons.Cross,this.icons.decline=Affinity.icons.ThumbsDown,this.icons.add=Affinity.icons.Plus,this.icons.save=Affinity.icons.Save,this.icons.award=Affinity.icons.Gift,this.icons.fav=Affinity.languages.english.features.favourites.icon,this.icons.help=Affinity.languages.english.features.help.icon},returnField:function(n,t,i){var o,e,u,h,s,f,r;return(t=typeOf(t)==="null"?null:t,i=typeOf(i)==="null"?null:i,o=this.getAttributes(n),o.hidden)?!1:(s=this.getValue(n),f=Affinity.zelos.getElementFromData(n),f?(typeOf(f)=="class"?(u=new Element("div",{"class":"widget "+n.ElementType.toLowerCase(),"data-widget":n.ElementType,id:n.Name}),n.Attribute&&n.Attribute.IsMessage&&n.Attribute.Message&&n.Attribute.Message!==""&&u&&(new Element("div",{html:Affinity.icons.Warning,"class":"message-icon yellow print-hidden ui-has-tooltip","data-tooltip":"Test Message"}).inject(u,"after"),new Element("div",{html:n.Attribute.Message,"class":"print-only print-help-left"}).inject(u,"after"),u.addClass("has-message-icon")),r={parentForm:this.zelosProcessor.target,parentDocument:this.template,parentSectionIndex:i,parentChildIndex:t,widgetDocument:n,target:u,zelosEngine:this.zelosProcessor.zelos,zelosProcessor:this.zelosProcessor},n.ElementType=="TimesheetTable"&&(u.addClass("suppress-errors"),r.timesheetType=this.zelosProcessor.options.timesheetType,r.isManager=this.zelosProcessor.options.isManager,r.putApi=this.zelosProcessor.options.putApi,r.getEmptyTimesheetApi=this.zelosProcessor.options.getEmptyTimesheetApi,r.insertAddForm=this.zelosProcessor.options.insertAddTimesheetForm===!1?!1:this.zelosProcessor.options.insertAddForm?!1:!0,r.fromDate=this.zelosProcessor.options.fromDate,r.toDate=this.zelosProcessor.options.toDate,r.profile=this.zelosProcessor.options.profile,r.startDay=this.zelosProcessor.options.startDay,r.showDays=this.zelosProcessor.options.showDays,r.publicHolidays=this.zelosProcessor.options.publicHolidays,r.readOnly=this.zelosProcessor.options.readOnly===!1?!1:!0,r.paginate=this.zelosProcessor.options.paginate===!1?!1:!0,r.isDual=this.zelosProcessor.options.isDual===!0?!0:!1,r.subType=this.zelosProcessor.options.subType||"not-sub-type",r.isMileageDual=this.zelosProcessor.options.isMileageDual===!0?!0:!1,r.isAllowanceGrid=this.zelosProcessor.options.isAllowanceGrid===!0?!0:!1,u.addClass("view-section")),n.ElementType=="LeaveTable"&&(u.addClass("suppress-errors"),r.leaveType=this.zelosProcessor.options.leaveType,r.isManager=this.zelosProcessor.options.isManager,r.putApi=this.zelosProcessor.options.putApi,r.getEmptyleaveApi=this.zelosProcessor.options.getEmptyleaveApi,r.fromDate=this.zelosProcessor.options.fromDate,r.toDate=this.zelosProcessor.options.toDate,r.startDay=this.zelosProcessor.options.startDay,r.publicHolidays=this.zelosProcessor.options.publicHolidays),n.ElementType=="LeaveHistory"&&(u.addClass("suppress-errors"),r.fromDate=this.zelosProcessor.options.fromDate,r.toDate=this.zelosProcessor.options.toDate,r.startDay=this.zelosProcessor.options.startDay,r.publicHolidays=this.zelosProcessor.options.publicHolidays),n.ElementType=="LeaveCalendar"&&(u.addClass("suppress-errors"),r.fromDate=this.zelosProcessor.options.fromDate,r.toDate=this.zelosProcessor.options.toDate,r.startDay=this.zelosProcessor.options.startDay,r.publicHolidays=this.zelosProcessor.options.publicHolidays),n.ElementType=="LeaveCalendarHistory"&&(u.addClass("suppress-errors"),r.fromDate=this.zelosProcessor.options.fromDate,r.toDate=this.zelosProcessor.options.toDate,r.startDay=this.zelosProcessor.options.startDay,r.publicHolidays=this.zelosProcessor.options.publicHolidays),h=new f(r),u.store("widget",h),f=u):(o.readonly&&f.set("disabled","disabled"),f.getElement("label,.label")&&(e=f.getElement("label,.label"),e.set("html",n.Description.ShortText)),f.getElement("input,select,textarea,.display")&&(u=f.getElement("input,select,textarea,.display"),typeOf(n.Value)!="null"&&(u.value=s),u.hasClass("display")&&u.set("html",s)),n.Description&&n.Description.HelpText&&n.Description.HelpText!=""&&e&&u&&(new Element("div",{html:"?","class":"indicator grey help print-hidden ui-has-tooltip","data-tooltip":n.Description.HelpText}).inject(e),new Element("div",{html:n.Description.HelpText,"class":"print-only print-help-left"}).inject(u,"after")),n.Attribute&&n.Attribute.IsMessage&&n.Attribute.Message&&n.Attribute.Message!==""&&u&&(new Element("div",{html:Affinity.icons.Warning,"class":"message-icon yellow print-hidden ui-has-tooltip","data-tooltip":"Test Message"}).inject(u,"after"),new Element("div",{html:n.Attribute.Message,"class":"print-only print-help-left"}).inject(u,"after"),u.addClass("has-message-icon")),u&&(u.set("id",n.Name),u.set("autocomplete","off"),n.SortBy!==undefined&&n.SortBy!==null&&n.SortBy.trim().length>0&&u.set("sortby",n.SortBy)),this.writeField(n,f)),f.set("data-child-index",t),f):void 0)},getValue:function(n){var i=typeOf(n.Value)==="null"?"":n.Value,t;if(typeOf(i)==="array")for(t=0;t<n.Value.length;t++)if(typeOf(n.Value[t])==="object"&&n.Value[t].selected){if(n.Value[t].display){i=n.Value[t].display;break}if(n.Value[t].value){i=n.Value[t].value;break}}return i},mobileFilter:["TsCode","ProjectId","TsCost","ResourceCode","AuthoriserId","CostElement1","CostElement2","CostElement3","CostElement4"],getAttributes:function(n){if(Affinity.mobile&&Affinity.appname==="timesheets"&&Affinity.view&&(Affinity.view==="detailed"||Affinity.view==="dualdetailed")){if(n.Name.test(new RegExp("Comment","gi"))||n.Name.test(new RegExp("BulkProcess","gi"))||n.Name.test(new RegExp("Submit","gi"))||n.Name.test(new RegExp("RowButton","gi"))||n.Layout.Rank>2&&this.mobileFilter.contains(n.Source.PropertyName))return{readonly:!0,hidden:!0,required:!1};if(n.Attribute&&!n.Attribute.IsHidden)return{readonly:!0,hidden:!1,required:!1}}return{readonly:n.Attribute&&n.Attribute.IsReadOnly?n.Attribute.IsReadOnly:!1,hidden:n.Attribute&&n.Attribute.IsHidden?n.Attribute.IsHidden:!1,required:n.Attribute&&n.Attribute.IsRequired?n.Attribute.IsRequired:!1}},getLookupDependancies:function(n){var t,i,r,u,e,f=[];return(n.Parameter&&Array.each(n.Parameter,function(o){o.LinkType&&o.LinkType.toLowerCase().contains("dependency")&&(t=n.Name,i=n.Name.contains("-")?n.Name.substring(n.Name.lastIndexOf("-")+1):n.Name,r=o.PropertyName,u=o.PropertyName.contains("-")?o.PropertyName.substring(o.PropertyName.lastIndexOf("-")+1):o.PropertyName,e="if "+r+" ("+u+") changes, update "+t+" ("+i+")",f.push({logic:e,updateThisId:t,updateThisPropertyName:i,updateFromId:r,updateFromPropertyName:u,questionData:n}))}.bind(this)),f.length>0)?f:!1},setLookupDependancies:function(n,t,i){var r=Affinity.lookupapi;typeOf(n.Data)!=="null"&&typeOf(n.Data.ExternalParameter)!=="null"&&(r+=r.indexOf("?")>-1?"&"+n.Data.ExternalParameter:"?"+n.Data.ExternalParameter),this.setElementChangedEvent(i),dependenciesWidget=new ZelosWidgetDependancy({target:n.Name,propertyName:n.Source.PropertyName,modelName:n.Source.ModelName,dependancies:t,api:r}),i.addClass("has-dependencies"),i.store("dependencies",dependenciesWidget)},setElementChangedEvent:function(n){n.addChangeTracker(),n.addEvent("value-changed",function(){window.fireEvent("formElementChanged",{element:n})})},writeField:function(n,t){var rt,i,l,p,a,y,c,f,o,h,ft,s,e,v,w,u,b,ut,k,d,g,nt,tt,et="",r=this.getAttributes(n),it;if(!r.hidden){t.getElement("label,.label")&&(rt=t.getElement("label,.label")),t.getElement("input,select,textarea,.display")&&(i=t.getElement("input,select,textarea,.display"),i.hasClass("display")||i.addClass("validate")),h=this.getValue(n),r.required&&(ft=!0,new Element("span",{html:"*","class":"required"}).inject(rt)),et="",r.readonly===!1&&n.ElementType==="FieldDisplay"&&n.InputType==="Date"&&(n.ElementType="FieldEdit");switch(n.ElementType){case"WorkflowButton":case"TimesheetRowButton":case"LeaveRowButton":case"CustomButton":v=n.Value,s="",e="";switch(v.ButtonType){case"Save":s="<span>"+this.icons.save+"<\/span>",e="button orange w-icon";break;case"Submit":s="<span>"+this.icons.submit+"<\/span>",e="button green w-icon";break;case"Accept":s="<span>"+this.icons.accept+"<\/span>",e="button green w-icon";break;case"Progress":s="<span>"+this.icons.progress+"<\/span>",e="button green w-icon";break;case"Success":s="<span>"+this.icons.success+"<\/span>",e="button green w-icon";break;case"Cancel":s="<span>"+this.icons.cancel+"<\/span>",e="button grey w-icon";break;case"Delete":s="<span>"+this.icons.del+"<\/span>",e="button red w-icon";break;case"Decline":s="<span>"+this.icons.decline+"<\/span>",e="button grey w-icon";break;case"Add":s="<span>"+this.icons.add+"<\/span>",e="button blue w-icon";break;case"Favourite":s="<span>"+this.icons.fav+"<\/span>",e="button blue w-icon";break;case"Award":s="<span>"+this.icons.award+"<\/span>",e="button blue w-icon calc-pop-button";break;default:s="",e="button blue"}"Icon"in v&&v.Icon in Affinity.icons&&(s="<span>"+Affinity.icons[v.Icon]+"<\/span>",e="button blue w-icon"),"Color"in v&&v.Color.trim()!==""&&(e="button "+v.Color+" w-icon"),n.ElementType=="WorkflowButton"&&(e+=" zelos-button"),n.ElementType=="TimesheetRowButton"&&(e+=" timesheet-button"),n.ElementType=="CustomButton"&&(e+=" custom-button"),t.getElement(".button").set("id",n.Name),t.getElement(".button").set("data-id",n.Name),t.getElement(".button").set("data-name",n.Name),t.getElement(".button").set("data-type",v.ButtonType),t.getElement(".button").set("html",s+"<span>"+v.Label+"<\/span>"),t.getElement(".button").set("class",e);break;case"TextInput":case"Memo":i&&(i.set("data-validate-method",r.required?"hasvalue,sentence":"sentence"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"IntegerInput":i&&(i.set("data-validate-method",r.required?"hasvalue,int":"int"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"FloatInput":i&&(i.set("data-validate-method",r.required?"hasvalue,float":"float"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"CurrencyInput":i&&(i.set("data-validate-method",r.required?"hasvalue,currency":"currency"),i.value=parseFloat(h).format({decimal:".",group:",",decimals:2}),i.addClass("validate"),this.setElementChangedEvent(i));break;case"EmailInput":i&&(i.set("data-validate-method",r.required?"hasvalue,email":"email"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"DatePickerInput":f=Date.parse(n.ValueAsString),o=new UIDateTimeWidget({target:i,postId:n.Name,startDate:f,outputFormat:"zelos",showCalendarFilterButtonsForMobile:Affinity.mobile}),o.output.set("data-validate-method",r.required?"hasvalue,date":"date"),i.addClass("validate");break;case"DropDownBoxInput":w=!1,typeOf(n.Value)==="array"?(Array.each(n.Value,function(t){y=new Element("option",{html:t.display,value:t.value}),t.selected&&(y.set("selected","selected"),y.defaultSelected=!0,w=t,i.set("data-default-value",t.value)),n.SelectedItem&&n.SelectedItem==t.value&&(y.set("selected","selected"),y.defaultSelected=!0,w=t,i.set("data-default-value",t.value)),i.adopt(y)}),w!==!1&&(i.selectedIndex=n.Value.indexOf(w),i.value=w.value)):"SelectedItemAsString"in n&&n.SelectedItemAsString!==""&&i.set("data-default-value",n.SelectedItemAsString),c=this.getLookupDependancies(n),c&&(this.setLookupDependancies(n,c,i),c=!1),r.required&&(i.set("data-validate-method","hasvalue"),i.addClass("validate")),n.Layout.IsHideableSwitch&&i.addClass("is-hideable-switch"),this.setElementChangedEvent(i);break;case"FieldEdit":switch(n.InputType){case"String":if(n.InputType==="String"&&n.Name.test(new RegExp("Break","i"))){f=Date.parse(h),o=new UIDateTimeWidget({target:i,postId:n.Name,startDate:f,outputFormat:"%H:%M",displayFormat:"%H:%M",showCalendar:!1,showTime:!0,nullable:!0,hoursmins:!0}),o.output.set("data-validate-method",r.required?"hasvalue,time":"time"),o.output.set("data-calendar-nullable","true"),o.output.set("data-calendar-hoursmins","true"),o.output.addClass("validate"),this.setElementChangedEvent(i);break}i&&(i.set("data-validate-method",r.required?"hasvalue,sentence":"sentence"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"Float":i&&(i.set("data-validate-method",r.required?"hasvalue,float":"float"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"Currency":i&&(h=isNaN(parseFloat(h))?"":parseFloat(h).format({decimal:".",group:",",decimals:2}),i.set("data-validate-method",r.required?"hasvalue,currency":"currency"),i.addClass("validate"),i.value=h,this.setElementChangedEvent(i));break;case"Integer":i&&(i.set("data-validate-method",r.required?"hasvalue,int":"int"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"Lookup":a=i.get("tag"),a==="select"||r.readonly||(l=new Element("select").inject(i,"after"),l.setProperties(i.getProperties()),l.addClass(i.get("class")),i.destroy(),i=l,i.set("id",n.Name)),a==="select"&&r.readonly&&(l=new Element("input",{type:"text"}).inject(i,"after"),l.addClass(i.get("class")),i.destroy(),i=l),r.readonly?(i.addClass("has-display-lookup"),i.set("disabled","disabled")):i.addClass("has-lookup"),i.set("data-default-value",h),p=Affinity.lookupapi+"?ModelName="+n.Source.ModelName+"&PropertyName="+n.Source.PropertyName,typeOf(n.Data)!=="null"&&typeOf(n.Data.ExternalParameter)!=="null"&&(p+="&"+n.Data.ExternalParameter),"enableSelectLimit"in Affinity&&Affinity.enableSelectLimit&&(p+="&limit="+Affinity.selectmax||1e3),i.set("data-lookup-api",p),r.required&&(i.set("data-validate-method","hasvalue"),i.addClass("validate")),this.setElementChangedEvent(i);break;case"Date":f=Date.parse(n.ValueAsString),r.readonly?i.value=f!==null&&typeOf(f)==="date"&&f.isValid()?f.toZelos():"":(o=new UIDateTimeWidget({target:i,postId:n.Name,startDate:f,outputFormat:"zelos"}),o.output.set("data-validate-method",r.required?"hasvalue,date":"date"),o.output.addClass("validate"),this.setElementChangedEvent(i));break;case"Time":f=Date.parse(h),r.readonly?i.value=f!==null&&typeOf(f)==="date"&&f.isValid()?f.format("%H:%M"):"":(o=new UIDateTimeWidget({target:i,postId:n.Name,startDate:f,outputFormat:"%H:%M",displayFormat:"%H:%M",showCalendar:!1,showTime:!0}),o.output.set("data-validate-method",r.required?"hasvalue,time":"time"),o.output.addClass("validate"),this.setElementChangedEvent(i));break;case"HoursMins":f=Date.parse(h),r.readonly?i.value=f!==null&&typeOf(f)==="date"&&f.isValid()?f.format("%H:%M"):"":(o=new UIDateTimeWidget({target:i,postId:n.Name,startDate:f,outputFormat:"%H:%M",displayFormat:"%H:%M",showCalendar:!1,showTime:!0,nullable:!0,hoursmins:!0}),o.output.set("data-validate-method",r.required?"hasvalue,time":"time"),o.output.set("data-calendar-nullable","true"),o.output.set("data-calendar-hoursmins","true"),o.output.addClass("validate"),this.setElementChangedEvent(i));break;case"BankNumber":document.banknumber.process(i);break;case"TaxNumber":document.taxnumber.process(i);break;case"Address":document.address.process(i)}c=this.getLookupDependancies(n),c&&(this.setLookupDependancies(n,c,i),c=!1);break;case"FieldDisplay":switch(n.InputType){case"Date":i.value="",n&&n.hasOwnProperty("ValueAsString")&&typeof n.ValueAsString=="string"&&n.ValueAsString.trim()!==""&&(it=Date.parse(n.ValueAsString),it&&(i.value=it.format(this.options.dateDisplayFormat))),r.readonly&&Affinity.mobile&&(newinput=new Element("span",{html:i.value.trim()===""?"&nbsp;":i.value}),newinput.setProperties(i.getProperties()),newinput.inject(i,"after"),i.destroy(),i=newinput);break;case"Time":n!==undefined&&n.ValueAsString!==undefined&&(i.value=n.ValueAsString.trim()!==""?Date.parse(n.ValueAsString).format(this.options.timeDisplayFormat):"");break;case"Lookup":a=i.get("tag"),a==="select"&&(l=new Element("input",{type:"text",disabled:"disabled"}).inject(i,"after"),l.addClass(i.get("class")),i.destroy(),i=l),i.addClass("has-display-lookup"),p=Affinity.lookupapi+"?ModelName="+n.Source.ModelName+"&PropertyName="+n.Source.PropertyName+"&Key="+h,typeOf(n.Data)!=="null"&&typeOf(n.Data.ExternalParameter)!=="null"&&(p+="&"+n.Data.ExternalParameter),"enableSelectLimit"in Affinity&&Affinity.enableSelectLimit&&(p+="&limit="+Affinity.selectmax||1e3),i.set("data-lookup-api",p),i.set("data-initial-value",h)}c=this.getLookupDependancies(n),c&&(this.setLookupDependancies(n,c,i),c=!1),this.setElementChangedEvent(i);break;case"AttachFile":t.getElement("a").set("html",n.Value.Display).set("href",this.zelosProcessor.options.server+"?api=document/content/"+n.Value.FileId),t.getElement(".print-only").set("html",this.zelosProcessor.options.server+"?api=document/content/"+n.Value.FileId);break;case"YoutubeInput":t.getElement("iframe").set("src","//www.youtube.com/embed/"+h);break;case"LinkURLInput":t.getElement("a").set("href",n.Value.value).set("html",n.Value.key),t.getElement(".print-only").set("html",n.Value.key);break;case"Subheading":t.set("html",n.Description.ShortText);break;case"ExplanationText":n.Layout.ArrowDirection&&t.addClass(n.Layout.ArrowDirection.toLowerCase()),t.set("html",n.Description.ShortText);break;case"Paragraph":t.getElement("p").set("html",n.Description.ShortText);break;case"DropDownBoxInput":Array.each(n.Value,function(n){y=new Element("option",{html:n.display,value:n.value}),n.selected&&y.set("selected","selected"),i.adopt(y)}),r.required&&(i.set("data-validate-method","hasvalue"),i.addClass("validate")),n.Layout.IsHideableSwitch&&i.addClass("is-hideable-switch"),this.setElementChangedEvent(i);break;case"MultiCheckBox":ut=String.uniqueID(),k=JSON.parse(n.ValueAsString),Array.each(k,function(n){b=String.uniqueID(),u=t.getElement(".template").clone(),u.removeClass("template"),u.removeClass("hidden"),u.getElement("input").set("value",n.value),u.getElement("input").set("id",b),u.getElement("input").set("name",n.value),u.getElement("input").set("data-validation-multicheck-id",ut),u.getElement("label").set("html",n.display),u.getElement("label").set("for",b),n.selected&&u.getElement("input").set("checked","checked"),r.required&&(u.getElement("input").set("data-validate-method","multiChecked"),i.addClass("validate")),t.getElement(".pairs").adopt(u)}),t.getElement(".template").destroy(),t.getElement(".pairs").set("id",n.Name);break;case"RadioGroup":k=JSON.parse(n.ValueAsString),Array.each(k,function(f){b=String.uniqueID(),u=t.getElement(".template").clone(),u.removeClass("template"),u.removeClass("hidden"),u.getElement("input").set("value",f.value),u.getElement("input").set("id",b),u.getElement("input").set("name",n.Name),u.getElement("label").set("html",f.display),u.getElement("label").set("for",b),f.selected&&u.getElement("input").set("selected","selected"),r.required&&(u.getElement("input").set("data-validate-method","radioSelected"),i.addClass("validate")),t.getElement(".pairs").adopt(u)}),t.getElement(".template").destroy(),t.getElement(".pairs").set("id",n.Name);break;case"CheckBox":r.required&&(i.set("data-validate-method","checked"),i.addClass("validate")),(n.Value||n.ValueAsString.toLowerCase()=="true")&&(i.checked=!0);break;case"Drawpanel":typeOf(n.Layout.BgImages)=="array"&&n.Layout.BgImages.length>0&&(d=[],g=[],nt=[],tt=[],Array.each(n.Layout.BgImages,function(n){d.push(n.name),g.push(n.image),nt.push(n.width),tt.push(n.height)}),i.set("data-bg-names",d.join("||")),i.set("data-bg-images",g.join("||")),i.set("data-bg-image-widths",nt.join("||")),i.set("data-bg-image-heights",tt.join("||")));break;case"BankNumber":i.value=n.ValueAsString;break;case"TaxNumber":i.value=n.ValueAsString;break;case"Address":i.value=n.ValueAsString}try{a=i.get("tag")}catch(ot){a=t.get("tag")}return r.readonly&&(a==="select"||a==="input"||a==="textarea")&&(i.hasClass("widget")||i.hasClass("has-dependencies")||i.erase("id"),i.getAttribute("type")==="text"&&r.readonly===!0?Affinity.mobile?(i.set("readonly","readonly"),i.set("style",(Affinity.DarkMode?"background:#2f2f2f;color:#ccc;":"background:#efefef;color:black;")+"text-decoration none;border:none;font-size:inherit;")):i.set("disabled","disabled"):i.set("disabled","disabled")),t}},readField:function(n,t){var r,i,u;if(typeOf(t)==="null"||typeOf(n)!=="object")return n;t.get("data-widget")&&(u=t.retrieve("widget"),n=u.returnDocument());switch(n.ElementType){case"WorkflowButton":n.Value.Pressed=this.buttonClickedName==n.Name?!0:!1;break;case"TextInput":case"Memo":case"EmailInput":case"DatePickerInput":n.Value=t.value,n.ValueAsString=t.value;break;case"CurrencyInput":case"FloatInput":n.Value=parseFloat(t.value),n.ValueAsString=t.value;break;case"IntegerInput":n.Value=parseInt(t.value),n.ValueAsString=t.value;break;case"DropDownBoxInput":r=t.value,i=[],Array.each(t.getElements("option"),function(n){i.push({display:n.get("html"),value:n.value,selected:n.value==r?!0:!1})}),Array.each(i,function(n,r){n.display===""&&n.value===""?i.splice(r,1):n.display===""&&n.value==="0"&&t.value==="0"&&n.selected===!1&&(n.selected=!0)}.bind(this)),n.Value=i,n.ValueAsString=JSON.stringify(i);break;case"MultiCheckBox":i=[],Array.each(t.getElements(".check-label-pair"),function(n){i.push({display:n.getElement("label").get("html"),value:n.getElement("input").value,selected:n.getElement("input").checked?!0:!1})}),n.Value=i,n.ValueAsString=JSON.stringify(i);break;case"RadioGroup":i=[],Array.each(t.getElements(".radio-label-pair"),function(n){i.push({display:n.getElement("label").get("html"),value:n.getElement("input").value,selected:n.getElement("input").checked?!0:!1})}),n.Value=i,n.ValueAsString=JSON.stringify(i);case"CheckBox":switch(n.InputType){case"Integer":t.checked&&(n.Value=parseInt(t.value),n.ValueAsString=t.value);break;default:t.checked?(n.Value=!0,n.ValueAsString="true"):(n.Value=!1,n.ValueAsString="false")}break;case"FieldEdit":r=t.value,n.ValueAsString=r;switch(n.InputType){case"Float":case"Double":r!==!1&&(n.Value=parseFloat(r));break;case"Integer":r!==!1&&(n.Value=parseInt(r));break;default:r!==!1&&(n.Value=r)}}return delete r,delete i,n}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosTemplateLoad={Version:"1.0.0.0",Sequence:10110,Name:"Zelos Template Load",File:"ui.zelos.template.load.js",Jira:"",Notes:""},ZelosTemplateLoad=new Class({Implements:[Options,Events],Binds:["loadTemplate","templateLoaded","loadFailed","cancel"],options:{},initialize:function(n){this.setOptions(n);var t=new Date;log("&#x2794; attempting ZelosLoader template load (0) ..."),this.formTemplateRequest=new Request.JSON({method:"get",timeout:12e4,onRequest:function(){log("&#x2794; ZelosLoader template load requested ("+t.elapsed()+") - "+this.logUrl+" ...",{color:"blue"}),this.fireEvent("request",this.formTemplateRequest.options.url)}.bind(this),onFailure:function(n){var i="",r;switch(n.status){case 401:i="Api unauthorized.";break;case 404:i="API path not found.";break;case 500:try{r=JSON.decode(n.responseText)}catch(u){r=!1,i=n.responseText}r&&(i=r.error?r.error:n.responseText),delete r;break;default:i=n.statusText}i.contains(401)||i.toLowerCase().contains("unauthorized")?(log("&#x270B; attempted ZelosLoader template load unauthorized &#x270B;",{color:"red"}),window.fireEvent("unauthorized"),this.loadFailed(i)):(log("&#x2718; attempted ZelosLoader template load failed ("+t.elapsed()+") - "+this.logUrl+" - "+i,{color:"red"}),this.loadFailed(i)),delete i}.bind(this),onError:function(n){log("&#x2718; attempted ZelosLoader template load failed with errors ("+t.elapsed()+") - "+this.logUrl+" - "+n,{color:"red"}),this.loadFailed(n)}.bind(this),onException:function(n,i){log("&#x2718; attempted ZelosLoader template load failed with exception ("+t.elapsed()+") - "+this.logUrl+" - "+n+": "+i,{color:"red"}),this.loadFailed("Exception on "+n+": "+i)}.bind(this),onTimeout:function(){log("&#x2718; attempted ZelosLoader template load timed out ("+t.elapsed()+") - "+this.logUrl,{color:"red"}),this.loadFailed("Load reached timeout limit.")}.bind(this),onSuccess:function(n){JSON.Unauthorized(n,"Zelos Loader, initialize - "+this.formTemplateRequest.url)||(n.error?typeOf(n.error)==="object"?(log("&#x2718; attempted ZelosLoader template load succeeded with errors ("+t.elapsed()+") - "+this.logUrl+" - "+JSON.stringify(n.error),{color:"red"}),this.loadFailed(JSON.stringify(n.error))):(log("&#x2718; attempted ZelosLoader template load succeeded with errors ("+t.elapsed()+") - "+this.logUrl+" - "+n.error.split("\r\n").join(", "),{color:"red"}),this.loadFailed(n.error.split("\r\n").join("<br />"))):(log("&#x2714; attempted ZelosLoader template load succeeded ("+t.elapsed()+") - "+this.logUrl,{color:"green"}),this.templateLoaded(n)))}.bind(this)})},attemptUrl:"no url set",loadFailed:function(n){this.formTemplateRequest.isRunning()&&this.formTemplateRequest.cancel(),this.fireEvent("error",n),ga&&ga("send","event","Zelos","FormTemplate","load failed ("+this.attemptUrl+")")},loadTemplate:function(n){this.attemptUrl=n,this.attemptUrl.contains("ran")||(this.attemptUrl=Affinity.GetCacheSafePath(this.attemptUrl)),this.formTemplateRequest.url=this.formTemplateRequest.options.url=this.attemptUrl,this.formTemplateRequest.send()},templateLoaded:function(n){typeOf(n.success)==="boolean"&&n.success===!1?this.loadFailed():(this.template=n,this.fireEvent("complete",this.template),ga&&ga("send","event","Zelos","FormTemplate","From Loaded ("+this.attemptUrl+")"))},isRunning:function(){return this.formTemplateRequest&&this.formTemplateRequest.isRunning()?!0:!1},cancel:function(){this.formTemplateRequest&&this.formTemplateRequest.isRunning()&&this.formTemplateRequest.cancel(),this.fireEvent("cancel","Form was canceled.")},destroy:function(){}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosTemplateProcess={Version:"1.0.2.0",Sequence:10120,Name:"Zelos Template Process",File:"ui.zelos.template.process.js",Jira:"",Notes:"Fix mandatory field validation for Timesheets"},ZelosTemplateProcess=new Class({Implements:[Options,Events],Binds:["processTemplate","writeField","readField","readDirectValue","submit","cancel","cancelForm","validationFailed","onPost","updateDocument","sanatisePostJson","validationPassed","postFailed","postSuccess","getLookupDependancies","setLookupDependancies","processChild","selectedRowsFromDetailedView","updateSelectedRows","submitSelectedRowsOnly","allowHorizontalScrollingForMobile"],options:{getApi:null,putApi:null,getEmptyTimesheetApi:null,insertAddTimesheetForm:!0,target:document.body,viewOnly:!1,frameless:!1,dateDisplayFormat:"%a %e %b %Y",allowHorizontalScrollingForMobile:!1,operationType:""},fieldProcessor:!1,hasValidation:!1,processorId:!1,initialize:function(n){if(this.setOptions(n),this.processorId=String.uniqueID(),this.icons={},this.icons.save=Affinity.icons.Save||"&#xe093;",this.icons.cancel=Affinity.icons.Cancel||"&#xe070;",Affinity.zelos.Elements==null)throw new ZelosError("Zelos HTML Elements must be compiled. See ui.zelos.init.js");if(!this.options.viewOnly&&this.options.putApi==null)throw new ZelosError("Zelos needs a put API path in options.");this.target=this.options.target,this.allowHorizontalScrollingForMobile=n.allowHorizontalScrollingForMobile,this.fieldProcessor=new ZelosProcessFileds({zelosProcessor:this})},getValue:function(n){return this.fieldProcessor?this.fieldProcessor.getValue(n):!1},getAttributes:function(n){return this.fieldProcessor?this.fieldProcessor.getValue(n):!1},getLookupDependancies:function(n){return this.fieldProcessor?this.fieldProcessor.getLookupDependancies(n):!1},setLookupDependancies:function(n,t,i){this.fieldProcessor&&this.fieldProcessor.setLookupDependancies(n,t,i)},processTemplate:function(n){var i,t;typeOf(n)=="string"&&(n=JSON.encode(n)),typeOf(n)==="object"&&(this.template=n,this.fieldProcessor.template=n,i=n,typeOf(i.Children)=="array"&&(i.Children.sort(function(n,t){return parseInt(n.Layout.Rank,10)-parseInt(t.Layout.Rank,10)}),Array.each(i.Children,this.processSection.bind(this))),t=this.options.target.getElements(".zelos-button"),t===undefined&&(t=this.options.target.getElements(".timesheet-button")),t.length>0?(this.form=new Element("form"),this.form.adopt(this.target.getChildren()),this.form.inject(this.target),this.form.set("autocomplete","off"),this.buttonBox=this.options.target.getElement(".form-row.buttons"),this.loaderBox=new Element("div",{"class":"form-row hidden"}).adopt(new Element("img",{src:Affinity.loaders.light})).inject(this.buttonBox,"after"),this.errorScroll=new Fx.Scroll(window),this.validation=new UIFormValidation({target:this.form,onPost:this.onPost,onValidateFailCallback:this.validationFailed,onValidateCallback:this.validationPassed}),t.addEvent("click",function(n){var t=n.target.hasClass("zelos-button")?n.target:n.target.getParent(".zelos-button");t.get("data-type")&&(t.get("data-type")!=="Cancel"?(this.buttonClickedName=t.get("data-name"),this.submit(n)):this.cancelForm())}.bind(this))):(this.form=this.target,this.form.set("autocomplete","off")),this.options.frameless,Array.each(this.form.getElements(".has-dependencies"),function(n){n.retrieve("dependencies").setEvents()}),Affinity.formhideables&&Affinity.formhideables.processNew(),Affinity.tooltips&&Affinity.tooltips.processNew(),Affinity.lookups&&Affinity.lookups.processNew({jsonp:!0,operationType:this.options.operationType}),Affinity.displaylookups&&Affinity.displaylookups.processNew({jsonp:!0}),Affinity.uiDrawPanels&&Affinity.uiDrawPanels.processNew(),this.fireEvent("complete",this.options.target))},submit:function(n){document.getElements(".error").removeClass("error"),document.getElements(".errorstr").destroy(),this.loaderBox&&this.loaderBox.removeClass("hidden"),this.buttonBox&&this.buttonBox.addClass("hidden"),this.buttonClicked=n.target.hasClass("button")?n.target:n.target.getParent(".button");var i=this.buttonClicked.hasClass("zelos-button")?!0:!1,t=!0;this.options.beforSave&&(t=this.options.beforSave({button:this.buttonClicked})),t?this.validation?this.validation.validate(i):this.validationPassed():(this.loaderBox&&this.loaderBox.addClass("hidden"),this.buttonBox&&this.buttonBox.removeClass("hidden"))},cancel:function(){this.cancelForm()},cancelForm:function(){this.fireEvent("cancel")},validationFailed:function(n){this.fireEvent("saveError",{errors:n}),function(){this.buttonBox&&this.buttonBox.removeClass("hidden"),this.loaderBox&&this.loaderBox.addClass("hidden"),document!=undefined&&document!=null&&document.getElement(".errorstr")!=null&&this.errorScroll.toElement(document.getElement(".errorstr").getParent(".form-row"))}.delay(1e3,this)},onPost:function(){this.loaderBox.removeClass("hidden"),this.buttonBox.addClass("hidden")},updateDocument:function(){var n=Object.clone(this.template);return n.Children&&typeOf(n.Children)=="array"&&Array.each(n.Children,function(t,i){t.Children&&typeOf(t.Children)=="array"&&Array.each(t.Children,function(t,r){this.readField(n,i,r,t)}.bind(this))}.bind(this)),n},sanatisePostJson:function(n){var t=JSON.encode(n);return t=t.replace(new RegExp("&amp;","gi"),"%26"),t=t.replace(new RegExp("&","gi"),"%26"),escape(t)},validationPassed:function(){var n=this.updateDocument(),t;this.fireEvent("validated",{document:n,buttonClicked:this.buttonClicked}),this.options.putApi!=="none"&&(t=this.sanatisePostJson(n),new Request.JSON({method:"POST",url:this.options.putApi,onFailure:this.postFailed,onError:this.postFailed,onSuccess:this.postSuccess}).post("="+t))},postFailed:function(){this.loaderBox&&this.loaderBox.addClass("hidden"),this.buttonBox&&this.buttonBox.removeClass("hidden"),this.fireEvent("saveError")},postSuccess:function(n){var t,u,f,e;if(typeOf(n)=="string"&&(n=JSON.decode(n)),typeOf(n)!="object")throw new ZelosError("returned Json is not a valid object");this.loaderBox&&this.loaderBox.addClass("hidden"),this.buttonBox&&this.buttonBox.removeClass("hidden");var o="cleverform",i=!1,r=[];n.Attribute&&n.Attribute.IsError&&(r.push(n.Attribute.ErrorMessage),i=!0),n.error!=undefined&&n.success===!1&&(r.push(n.error),i=!0),n.Children&&Array.each(n.Children,function(s){s.Attribute&&s.Attribute.IsError&&(r.push(s.name+": "+s.Attribute.ErrorMessage),i=!0),Array.each(s.Children,function(s){if(s.ElementType&&s.ElementType==="TimesheetTable"){if(o="timesheets",s.Attribute&&s.Attribute.IsError){if(i){window.fireEvent("processorDocumentError",{document:n,processorId:this.processorId});return}i=!0}}else s.Attribute&&s.Attribute.IsError&&(i=!0,t=document.id(s.Name)?document.id(s.Name):!1,t?(t.get("data-widget")?(u=t.retrieve("widget"),u&&"processErrors"in u&&(f=t.retrieve("widget").processErrors(n)),f.length>0?(i=!0,e=f.join(", ")):e=s.Attribute.ErrorMessage):(t.getPrevious("label,.lable")?t=t.getPrevious("label,.lable"):t.getParent().getElement("label,.lable")&&(t=t.getParent().getElement("label,.lable")),e=s.Attribute.ErrorMessage),t.addClass("error"),t.hasClass("suppress-errors")||new Element("div",{"class":"errorstr",html:e}).inject(t,"before")):r.push(s.Name+": "+s.Attribute.ErrorMessage))}.bind(this))}.bind(this)),i?(o=="timesheets"&&window.fireEvent("processorDocumentError",{document:n,processorId:this.processorId}),r.length>0?this.fireEvent("saveError","<br />"+r.join("<br />")):this.fireEvent("saveError","")):(this.fireEvent("save",n),window.fireEvent("processorDocumentSaved",{document:n,processorId:this.processorId})),delete t,delete u,delete f,delete i,delete r},processChild:function(n,t,i,r){var u,f;return i=typeOf(i)==="null"?null:i,u=this.fieldProcessor.returnField(n,t,r),Affinity.mobile&&this.allowHorizontalScrollingForMobile&&(f=u.getElement(".section-table"),f.addClass("ui-mobile-table-overflow")),i!==null&&u&&(i.getElement(".default-form").adopt(u),u.fireEvent("inDom")),u},processSection:function(n,t){if(n.ElementType=="SectionHeading"){if(n.Attribute&&n.Attribute.IsHidden)return;var r=!1,i=Affinity.zelos.getElementFromData(n);this.options.frameless&&i.addClass("frameless"),this.options.target.adopt(i),i.getElement(".section-title").set("html",n.Description.ShortText),n.Layout&&n.Layout.HideTitle&&i.getElement(".section-header")&&i.getElement(".section-header").addClass("hidden"),typeOf(n.Children)=="array"&&(n.Children.sort(function(n,t){return parseInt(n.Layout.Rank,10)-parseInt(t.Layout.Rank,10)}),Array.each(n.Children,function(n,u){n.ElementType&&n.ElementType=="WorkflowButton"&&(r=!0),this.processChild(n,u,i,t)}.bind(this))),typeOf(n.Layout.HideMessage)==="null"||n.Layout.HideMessage||i.getElement(".required-message").removeClass("hidden"),i.getElement(".required")&&r&&new Element("div",{"class":"form-row buttons"}).inject(i.getElement(".required-message"),"after").adopt(i.getElements(".button-wrapper")),n.Layout.IsHideable&&i.addClass("is-hideable").addClass("ui-hideable-id-"+n.Name.trim().toLowerCase().replace(/ /g,"-"))}},readDirectValue:function(n,t){return this.fieldProcessor.readField(n,t)},writeField:function(n,t){this.fieldProcessor.writeField(n,t)},readField:function(n,t,i,r,u){if(typeOf(u)==="null"&&(u=this.form),!(Affinity.mobile&&r.Name.toString().indexOf("TsCode")>-1)&&u.getElement("#"+r.Name)){var f=u.getElement("#"+r.Name);this.buttonClickedName&&(this.fieldProcessor.buttonClickedName=this.buttonClickedName),n.Children[t].Children[i]=this.fieldProcessor.readField(r,f),delete f}}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosViewSettings={Version:"1.0.4.0",Sequence:10500,Name:"Timesheet View Settings",Description:"Used to keep state between view and user switching",File:"ui.zelos.view.settings.js",Jira:"",Notes:""},ZelosViewSettings=new Class({Binds:["set","get","unset","setProfileData","setProfile","getProfile","unsetProfile","unsetProfileData","setFilterData","setFilter","getFilter","unsetFilter","unsetFilterData","reset"],name:"",employeeNumber:"",startDate:!1,fromDat:!1,toDate:!1,profileData:{},filterData:{employee:!1,fromDate:!1,toDate:!1,period:!1,payPoint:!1,excludeLocked:!1,onlyManaged:!1,forceReload:!1},lastUpdated:!1,lastView:!1,currentView:!1,profile:{set:function(){},get:function(){},unset:function(){}},filter:{set:function(){},get:function(){},unset:function(){}},initialize:function(){"Affinity"in window||(window.Affinity={}),"viewSettings"in Affinity||(Affinity.viewSettings=this),this.profile.set=this.setProfile,this.profile.get=this.getProfile,this.profile.unset=this.unsetProfile,this.filter.set=this.setFilter,this.filter.get=this.getFilter,this.filter.unset=this.unsetFilter,this.lastUpdated=new Date},set:function(n,t){this[n]=t,this.lastUpdated=new Date},get:function(n){return this[n]?this[n]:!1},unset:function(n){this[n]=!1,this.lastUpdated=new Date},setProfileData:function(n){this.profileData=Object.clone(n),this.lastUpdated=new Date},setProfile:function(n){for(n in this.profileData)this.profileData(n);this.lastUpdated=new Date},getProfile:function(n){return this.profileData[n]?this.profileData[n]:!1},unsetProfile:function(n){this.profileData[n]=!1,this.lastUpdated=new Date},unsetProfileData:function(){for(key in this.filterData)this.unsetFilter(key);this.lastUpdated=new Date},setFilter:function(n,t){this.filterData[n]=t,this.lastUpdated=new Date},getFilter:function(n){return this.filterData[n]?this.filterData[n]:!1},unsetFilter:function(n){this.filterData[n]=!1,this.lastUpdated=new Date},unsetFilterData:function(){for(key in this.filterData)this.unsetFilter(key);this.lastUpdated=new Date},reset:function(){for(key in this)key!=="filterData"&&typeOf(this[key])!=="function"&&typeOf(this[key])!=="object"&&this.unset(key);return this.unsetProfileData(),this.unsetFilterData(),!0},log:function(n){console.log(""),console.log("////////////////////////////////////////////////////////////////////////////////////////////"),console.log(n),console.log(Affinity.login.userProfiles.hasOwnProperty(Affinity.viewSettings.employeeNumber)?Affinity.login.userProfiles[Affinity.viewSettings.employeeNumber].commonName:"(No Profile Yet)",Affinity.viewSettings.employeeNumber),console.log(Affinity.viewSettings.startDate.clone()),console.log(JSON.stringify(Affinity.viewSettings.filterData,null,2)),console.log("////////////////////////////////////////////////////////////////////////////////////////////"),console.log("")}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosAwardModal={Version:"1.0.10.0",Sequence:10320,Name:"Timesheet Award Modal (Zelos Widget)",Description:"Detail view calc popup",File:"ui.zelos.widget.awards.modal.js",Jira:"",Notes:"fix award text path"},ZelosAwardModal=new Class({debug:!1,Implements:[Options,Events],Binds:["set","render","close","_retuirnApiFromRow","_returnEmployeeNoFromRow","_returnEmployeeNameFromRow","_returnDateFromRow","_isRowGood","_getAwards","_gotAwards","_setPosition","_startDrag","_drag","_stopDrag","_clearDragEvents","_closed"],options:{row:!1,user:"",date:"",iconData:[],returnRowMethod:!1,isDraggable:!0,startPosition:{x:!1,y:!1},isOpen:!1},initialize:function(n){var t,i,r;if(!Affinity.isAwardsPopupEnabled())return!1;this.setOptions(n),Affinity.hasOwnProperty("AwardModels")||(Affinity.AwardModels={Widgets:[],closeAll:function(){Affinity.AwardModels.Widgets.forEach(function(n){n&&n.hasOwnProperty("close")&&typeof n.close=="function"&&n.close()})}}),Affinity.AwardModels.Widgets.push(this),t="",t+="<h2>Timesheet Information<\/h2>",this.baseLang=Affinity.languages.english.features,this.baseAppLang=Affinity.languages.english.application.timesheets,this.container=new Element("div",{"class":"ts-award-box",html:t}),this.userInfoBox=new Element("div",{"class":"ts-award-user-info"}).inject(this.container),this.awardBox=new Element("div",{"class":"ts-award-message hidden"}).inject(this.container),this.spinner=new Element("div",{"class":"ts-award-loader newloader hidden"}).inject(this.container),this.detailsBox=new Element("div",{"class":"ts-award-details-box section"}).inject(this.container),this.table=new Element("table",{"class":"ui-grid timesheet"}).inject(this.detailsBox),i=new Element("thead").inject(this.table),this.thead=new Element("tr").inject(i),this.tbody=new Element("tbody").inject(this.table),r=new Element("tfoot").inject(this.table),this.tfoot=new Element("tr").inject(r),this.spinner.innerHTML='<svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg"><circle class="circle" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"><\/circle><\/svg>',this.loader=new Request.JSON({onSuccess:this._gotAwards}),this.render(),this.debug&&(console.info("award modal trace (init):"),console.trace())},set:function(n){if(!Affinity.isAwardsPopupEnabled())return!1;this.setOptions(n),this.render(),this.debug&&(console.info("award modal trace (set):"),console.trace())},render:function(){if(!Affinity.isAwardsPopupEnabled())return!1;this.thead.empty(),this.tbody.empty(),this.tfoot.empty(),this.spinner.classList.remove("hidden");var n="",t="",i=!1;try{i=Date.parse(this._returnDateFromRow())}catch(r){}n+='<span class="user">',n+=this._returnEmployeeNameFromRow(),n+="<\/span>  ",n+='<span class="date">',i&&(n+=i.format("%a %e%o of %b, %Y")),n+="<\/span>",this.options.iconData.forEach(function(n){t+=n.trim()+"<br />"}),t+="<br />",this.awardBox.innerHTML=t,this.userInfoBox.innerHTML=n,Affinity.uiModal.setClass("ui-new-modal"),Affinity.uiModal.adopt(this.container),Affinity.uiModal.show(),this._clearDragEvents(),this.options.isDraggable&&!Affinity.mobile?(Affinity.uiModal.modal.classList.add("draggable"),Affinity.uiModal.modalbg.addClass("hidden"),Affinity.uiModal.modal.addEventListener("mousedown",this._startDrag),Affinity.uiModal.afterClose=this._closed):(Affinity.uiModal.modal.classList.remove("draggable"),Affinity.uiModal.modalbg.addClass("opaque")),this.options.startPosition.x&&this.options.startPosition.y?Affinity.uiModal.modal.classList.add("positioned"):Affinity.uiModal.modal.classList.remove("positioned"),this._setPosition(),this._getAwards(),this.isOpen=!0},close:function(){Affinity.uiModal.afterClose=this._closed,Affinity.uiModal.hide(),this.isOpen=!1},_retuirnApiFromRow:function(){var t=Date.parse(this.options.row.dataset.date),i=this.options.row.dataset.employeeNo,r=this.options.row.dataset.timesheetId,n="";return n+=Affinity.zelosroot+"?api=TimesheetPayTrans/GetPayTransForDate",n+="&fromDate="+t.format("%d.%b.%Y"),n+="&toDate="+t.format("%d.%b.%Y"),n+="&employeeNo="+i,n+"&view=daydetail"},_returnEmployeeNoFromRow:function(){return this.options.row.dataset.employeeNo||Affinity.login.profile.employeeNumber},_returnEmployeeNameFromRow:function(){return this.options.row.dataset.employeeName||Affinity.login.profile.commonName},_returnDateFromRow:function(){return this.options.row.dataset.date||!1},_isRowGood:function(n){var t=!1,i=this._returnEmployeeNoFromRow().toString().trim();return n.Children.forEach(function(n){if(n.Name&&n.Name.test(new RegExp("EmployeeNo","gi"))&&n.ValueAsString.toString().trim()===i)return t=!0}.bind(this)),t},_gotAwards:function(n){var u=[],f=!0,e=0,t,i,r,o;this.thead.empty(),this.tbody.empty(),this.tfoot.empty(),n.hasOwnProperty("Children")&&n.Children[0].Children[0].hasOwnProperty("Children")&&(u=n.Children[0].Children[0].Children),u.length>0?(u.forEach(function(n){this._isRowGood(n)&&typeof this.options.returnRowMethod=="function"&&(n.Attribute.IsReadOnly=!0,t=this.options.returnRowMethod(n,!1,"awards"),i=t.querySelector(".col-id-TsDate"),r=t.querySelector(".col-id-RowButton"),i&&(i.classList.remove("active"),i.classList.add("hidden")),r&&(r.classList.remove("active"),r.classList.add("hidden")),this.tbody.adopt(t),f&&(f=!1,n.Children.forEach(function(n){o=n.Attribute.IsHidden||n.Name.test(new RegExp("TsDate|Button","gi"))?!0:!1,this.thead.adopt(new Element("th",{"class":o?"hidden":"active",html:n.Description.ShortText}))}.bind(this)),this.tfoot.adopt(new Element("th",{colspan:t.querySelectorAll(".active").length}))),e++)}.bind(this)),e===0&&this.tbody.adopt(new Element("tr").adopt(new Element("tr",{html:this.baseAppLang.features.awards.noawards}))),Affinity.tooltips&&Affinity.tooltips.processNew(),Affinity.uiGrid&&Affinity.uiGrid.zebra(this.table,"timesheet-row"),Affinity.lookups&&Affinity.lookups.processNew({jsonp:!0}),Affinity.displaylookups&&Affinity.displaylookups.processNew({jsonp:!0})):this.tbody.adopt(new Element("tr").adopt(new Element("tr",{html:this.baseAppLang.features.awards.noawards}))),this.spinner.classList.add("hidden"),this._setPosition()},_getAwards:function(){if(!Affinity.isAwardsPopupEnabled)return!1;var n=this._retuirnApiFromRow();this.loader.isRunning()&&this.loader.cancel(),this.loader.url=n,this.loader.options.url=n,this.loader.get()},_setPosition:function(){if(isNaN(this.options.startPosition.x+this.options.startPosition.y))Affinity.uiModal.position();else{var t=Math.max(document.documentElement.clientHeight,window.innerHeight||0),n=this._getHeight(Affinity.uiModal.modal);Affinity.uiModal.modal.style.top=this.options.startPosition.y+n>t?this.options.startPosition.y-40-n+"px":this.options.startPosition.y+"px",Affinity.uiModal.modal.style.left=this.options.startPosition.x+"px"}},_getHeight:function(n){var t=n.getBoundingClientRect();return t.height},_getMouseX:function(n){return n.pageX?n.pageX:n.clientX?n.clientX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft):null},_getMouseY:function(n){return n.pageY?n.pageY:n.clientY?n.clientY+(document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop):null},_offsetTop:!1,_offsetLeft:!1,_startDrag:function(n){this._clearDragEvents(),this._offsetTop=this._getMouseY(n),this._offsetLeft=this._getMouseX(n),Affinity.uiModal.modal.classList.add("dragging"),window.addEventListener("mousemove",this._drag),window.addEventListener("mouseup",this._stopDrag),n.preventDefault(),n.stopPropagation()},_drag:function(n){var i=this._getMouseX(n),r=this._getMouseY(n),t=Affinity.uiModal.modal;(i!=this._offsetLeft||r!=this._offsetTop)&&(t.style.top=parseInt(t.style.top)+(r-this._offsetTop)+"px",t.style.left=parseInt(t.style.left)+(i-this._offsetLeft)+"px",this._offsetTop=r,this._offsetLeft=i)},_stopDrag:function(){this._clearDragEvents(),this.options.isDraggable&&!Affinity.mobile&&Affinity.uiModal.modal.addEventListener("mousedown",this._startDrag)},_clearDragEvents:function(){Affinity.uiModal.modal.removeEventListener("mousedown",this._startDrag),Affinity.uiModal.modal.classList.remove("dragging"),window.removeEventListener("mousemove",this._drag),window.removeEventListener("mouseup",this._stopDrag),this._offsetTop=!1,this._offsetLeft=!1},_closed:function(){this._clearDragEvents(),Affinity.uiModal.modal.classList.remove("positioned"),Affinity.uiModal.modal.classList.remove("draggable")}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidget={Version:"1.0.0.0",Sequence:10150,Name:"Zelos Widget Base",File:"ui.zelos.widget.base.js",Jira:"",Notes:""},ZelosWidget=new Class({Implements:[Options,Events],Binds:[""],options:{parentDocument:null,parentSectionIndex:null,parentChildIndex:null,widgetDocument:null,target:null,processor:null},initialize:function(n){this.setOptions(n),this.target=this.options.target()},returnDocumnent:function(){return this.options.widgetDocument},returnParentDocument:function(){return this.options.parentDocument},processErrors:function(){return[]},showLoader:function(n){var i=n||"data",t;this.target.getElement("section")||(t="",t+='<div class="section shadow "><div class="section-body"><div class="section-row">',t+='Loading Timesheets <img src="'+Affinity.loaders.light+'" />',t+="<\/div><\/div><\/div>",this.target.set("html",t).removeClass("hidden"))},clear:function(){this.target.empty().removeClass("hidden")}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetDependancy={Version:"1.0.4.0",Sequence:10170,Name:"Dependency (Zelos Widget)",File:"ui.zelos.widget.dependancy.js",Jira:"",Notes:"Added default selection checks"},ZelosWidgetDependancyQueue=new Class({Implements:[Options,Events],Binds:["destroyLoader","add","remove","refreshQueue","cancelQueue","process","processCont","loadComplete","loadFailed"],options:{jsonp:!0},enabled:!1,initialize:function(n){this.setOptions(n),Affinity.UI||(Affinity.UI={}),Affinity.UI.dependancies||(Affinity.UI.dependancies={}),Affinity.UI.debug||(Affinity.UI.debug={}),Affinity.UI.debug.dependancyKeys||(Affinity.UI.debug.dependancyKeys=[]),Affinity.UI.dependancyLoaders=[],this.loadCount=0,window.addEvent("refreshQueues",this.refreshQueue),window.addEvent("loggedout",this.cancelQueue),window.addEvent("loggedin",function(){log("! dependency queue enabled !"),this.enabled=!0}.bind(this))},getApiKey:function(n){var o=new URI(n.toLowerCase()),s=o.get("query").parseQueryString(),i=[],u=[],t=!1,f="",r,e;return Object.each(s,function(n,r){r.toLowerCase()!=="ran"&&(r!=="parameters"?i.push(r+"-"+n):t=JSON.parse(n))}),i=i.sort(),t&&typeOf(t)==="object"&&"parameter"in t&&typeOf(t.parameter)==="array"&&(Array.each(t.parameter,function(n){r=[],Object.each(n,function(n,t){t.toLowerCase()!=="ran"&&r.push(t+"-"+n)}),r.sort(),u.push(r.join("|"))}),u.sort(),f="|parameters|"+u.join("||")),e=i.join("|")+f,e.replace(/\//g,"-")},remove:function(n,t){var i=this.getApiKey(n);Affinity.UI.dependancies[i].elements.splice(Affinity.UI.dependancies[i].elements.indexOf(t),1)},add:function(n,t){var i=this.getApiKey(n);t.set("data-dep-key",i),Affinity.UI.dependancies[i]?Affinity.UI.dependancies[i].elements.contains[t]||Affinity.UI.dependancies[i].elements.push(t):Affinity.UI.dependancies[i]={api:decodeURI(n),id:"depends_"+String.uniqueID(),type:"dependency",loaded:!1,massive:!1,elements:[t]},t.fireEvent("lookup")},refreshQueue:function(){this.enabled&&(this.loadCount=0,clearTimeout(this.processDelay),log("&#171; REFRESH ALL DEPENDANCIES &#187;"),this.enabled=!1,Array.each(Affinity.UI.dependancyLoaders,function(n,t){"cancel"in n&&n.cancel(),"removeEvents"in n&&n.removeEvents(),Affinity.UI.dependancyLoaders[t]=null}),Affinity.UI.dependancyLoaders=[],Object.each(Affinity.UI.dependancies,function(n,t){Affinity.UI.dependancies[t].loaded=!1,Affinity.UI.dependancies[t].data=null,delete Affinity.UI.dependancies[t].data}),this.enabled=!0,window.fireEvent("dependancyCacheClear"))},cancelQueue:function(){return this.loadCount=0,this.enabled=!1,clearTimeout(this.processDelay),Array.each(Affinity.UI.dependancyLoaders,function(n){"cancel"in n&&n.cancel(),"removeEvents"in n&&n.removeEvents(),n=null}),Affinity.UI.dependancyLoaders=[],Object.each(Affinity.UI.dependancies,function(n,t){Affinity.UI.dependancies[t].loaded=!1,Affinity.UI.dependancies[t].data=null,Affinity.UI.dependancies[t].elements=[],Affinity.UI.dependancies[t]=null,delete Affinity.UI.dependancies[t]}),Affinity.UI.dependancies={},!0},process:function(){this.loadCount=0;var n,t,i=new Date;try{Object.each(Affinity.UI.dependancies,function(i,r){if(this.enabled&&Affinity.UI.dependancies[r].loaded!=="loading...")if(Affinity.UI.dependancies[r].loaded===!0)this.loadComplete(r);else if(Affinity.UI.dependancies[r].loaded===!1){t=Affinity.UI.dependancies[r].api,Affinity.UI.dependancies[r].loaded="loading...";var u=new URI(t),f=u.parsed.query.parseQueryString();n=this.options.jsonp?new Request.JSONP({callbackKey:"jsoncallback",url:Affinity.GetCacheSafePath(t),method:"get",timeout:3e4,onRequest:function(){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&console.log("problem dependancy requested...")}.bind(this),onComplete:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy complete:"),console.log(r),console.log(n)),JSON.Unauthorized(n,Affinity.UI.dependancies[r].id)||("error"in n?n.error.test("limit","gi")?(Affinity.UI.dependancies[r].data=[],Affinity.UI.dependancies[r].massive=!0,Affinity.UI.dependancies[r].loaded=!0,this.loadComplete(r)):(this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1):(Affinity.mobile&&r.toLowerCase().indexOf("tscode")>-1&&(n=n.reverse()),Affinity.UI.dependancies[r].data=n,Affinity.UI.dependancies[r].loaded=typeOf(n)==="array"&&n.length>0?!0:!1,this.loadComplete(r)))}.bind(this),onError:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy failed:"),console.log(r),console.log(n)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this),onFailure:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy failed (xhr):"),console.log(r),console.log(n)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this),onTimeout:function(){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy timedout."),console.log(r)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this)}):new Request.JSON({url:Affinity.GetCacheSafePath(t),method:"get",timeout:3e4,onRequest:function(){}.bind(this),onSuccess:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy complete:"),console.log(r),console.log(n)),JSON.Unauthorized(n,Affinity.UI.dependancies[r].id)||("error"in n?n.error.test("limit","gi")?(Affinity.UI.dependancies[r].data=[],Affinity.UI.dependancies[r].massive=!0,Affinity.UI.dependancies[r].loaded=!0,this.loadComplete(r)):(this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1):(Affinity.UI.dependancies[r].data=n,Affinity.UI.dependancies[r].loaded=typeOf(n)==="array"&&n.length>0?!0:!1,this.loadComplete(r)))}.bind(this),onError:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy failed:"),console.log(r),console.log(n)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this),onFailure:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy failed (xhr):"),console.log(r),console.log(n)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this),onTimeout:function(){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy timedout."),console.log(r)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this)}),n&&(Affinity.UI.dependancyLoaders.push(n),n.send())}}.bind(this))}catch(r){}},loadCount:0,loadComplete:function(n){Array.each(Affinity.UI.dependancies[n].elements,function(t){typeOf(t)!=="null"&&t.fireEvent("dependancyLoaded",{data:Affinity.UI.dependancies[n].data})}.bind(this)),this.loadCount++,this.loadCount===Affinity.UI.dependancies.length&&(window.fireEvent("AllDependanciesLoaded"),this.loadCount=0)},loadFailed:function(n){Array.each(Affinity.UI.dependancies[n].elements,function(t){typeOf(t)!=="null"&&t.fireEvent("dependancyFailed",{data:Affinity.UI.dependancies[n].data})}.bind(this))}}),Affinity.UI.dependancyQueue=new ZelosWidgetDependancyQueue,ZelosWidgetDependancy=new Class({Implements:[Options,Events],WidgetName:"Dependancy",Binds:["setTarget","processOptions","destroyLoader","getApiKey","doLookup","cancelLookup","lookupFailed","forceSetDefault"],eventsset:!1,options:{target:null,propertyName:"",modelName:"",dependancies:[],api:null},loader:!1,initialize:function(n){this.setOptions(n),this.dependancies=this.options.dependancies},target:!1,setTarget:function(){typeOf(this.target)!=="element"&&typeOf(this.options.target)==="string"&&document.id(this.options.target)&&(this.target=document.id(this.options.target)),this.target&&this.target.store("dependancy",this)},eventsset:!1,setEventAttempt:0,setEventAttemptDelay:250,setEventAttemptMax:10,setEventAttemptDelay:!1,setEvents:function(){this.setTarget();var n=!0;Array.each(this.dependancies,function(t){document.id(t.updateFromId)?document.id(t.updateFromId).hasEvent("change",this.doLookup)||document.id(t.updateFromId).addEvent("change",this.doLookup):(n=!1,clearTimeout(this.setEventAttemptDelay),this.setEventAttempt<this.setEventAttemptMax&&(this.setEventAttempt++,this.setEventAttemptDelay=this.setEvents.delay(this.setEventAttemptDelay,this)))}.bind(this)),n&&(this.eventsset=!0)},destroyLoader:function(){this.loader&&typeOf(this.loader)==="element"&&"destroy"in this.loader&&this.loader.destroy(),this.loader=!1},lookupFailed:function(n){this.setTarget(),this.cancelLookup();var t="There was an error getting these values.";typeOf(n)==="object"&&"error"in n&&(t=n.error),typeOf(n)==="object"&&"data"in n&&(n=n.data,typeOf(n)==="object"&&"error"in n&&(t=n.error)),this.target.adopt(new Element("span",{"class":"errormsg",html:t}))},api:!1,cancelLookup:function(){this.setTarget(),this.api&&(this.target.removeEvent("dependancyLoaded",this.processOptions),this.target.removeEvent("dependancyFailed",this.lookupFailed),Affinity.UI.dependancyQueue.remove(this.api,this.target)),this.destroyLoader(),this.target.empty(),this.target.removeClass("hidden")},getApiKey:function(n){return Affinity.UI.dependancyQueue.getApiKey(n)},lastKnownValue:null,doLookup:function(){var i,u,n,r,f,e,t;if(this.target){var o=typeOf(this.options.api)==="string"&&this.options.api!=""?this.options.api:Affinity.lookupapi,s=o.match(/lookup\/get/gi),h=o.replace(s[0],"lookup/GetConditional");this.lastKnownValue=this.target.value,this.cancelLookup(),i=this.target.get("tag").toLowerCase(),i!=="td"&&i!=="th"?this.target.addClass("hidden"):this.target.empty(),this.loader=this.target.getParent().getElement(".deploader")?this.target.getParent().getElement(".deploader"):i!=="td"&&i!=="th"?new Element("img",{src:Affinity.loaders.light,"class":"deploader"}).inject(this.target,"before"):new Element("img",{src:Affinity.loaders.light,"class":"deploader"}).inject(this.target),u=new URI(h),e=[],Array.each(this.dependancies,function(t){document.id(t.updateFromId)&&(n=document.id(t.updateFromId),r=n.value,f=r,n.get("data-lookup-api")&&n.get("data-default-value")&&(f=n.get("data-default-value")),Affinity.ignoreDependancyDefaults||typeOf(n.value)!=="null"&&n.value!==""?typeOf(n.value)==="null"&&(r=""):r=f,e.push({LinkType:"Dependency",ModelName:"Timesheet",PropertyName:t.updateFromPropertyName,ValueAsString:r}))}.bind(this)),t=u.parsed.query.parseQueryString(),t.propertyName=this.options.propertyName,t.modelName=this.options.modelName,t.parameters=JSON.stringify({Parameter:e}),"enableSelectLimit"in Affinity&&Affinity.enableSelectLimit&&(t.limit=Affinity.selectmax||1e3),u.parsed.query=Object.toQueryString(t),this.api=unescape(decodeURI(u.toString())),this.target.removeEvent("dependancyLoaded",this.processOptions),this.target.removeEvent("dependancyFailed",this.lookupFailed),this.target.addEvent("dependancyLoaded",this.processOptions),this.target.addEvent("dependancyFailed",this.lookupFailed),Affinity.UI.dependancyQueue.add(this.api,this.target),Affinity.UI.dependancyQueue.process()}},processOptions:function(n){var o,t,i,v,s,u,h,c,l,y,p,r,f,a,e,w;if(this.setTarget(),o=this.target.get("tag").toLowerCase(),this.target.removeEvent("dependancyLoaded",this.processOptions),this.target.removeEvent("dependancyFailed",this.lookupFailed),"data"in n&&(n=n.data),t=!1,i=this.target.value,i!=this.lastKnownValue&&(i=this.lastKnownValue),v=i,this.target.get("data-default-value")&&this.target.get("data-default-value")!==i&&(i=this.target.get("data-default-value")),s=Affinity.ignoreDependancyDefaults,u=!1,this.target.getParent("tr.timesheet-row")&&(u=this.target.getParent("tr.timesheet-row")),u&&!u.hasClass("new")&&(s=!1),u){for(h=!1,l=0;l<this.dependancies.length;l++)if(c=document.id(this.dependancies[l].updateFromId),!h&&c.get("data-default-value")&&c.get("data-default-value")!==c.value){h=!0;break}h&&(s=Affinity.ignoreDependancyDefaults)}y=i,this.target.get("tag")==="select"?(p=Affinity.UI.dependancyQueue.getApiKey(this.api),Affinity.UI.dependancies[p].massive&&n.length>Affinity.selectmax?this.target.addClass("massive").store("data-store","dependancies").store("data-key",p).store("data-value",i).store("data-label",i):(this.target.removeClass("massive").eliminate("data-store").eliminate("data-key").eliminate("data-label"),r=!1,Array.each(n,function(n,t){Affinity.mobile&&n.Value!==undefined&&n.Value!==null&&(n.Value=n.Value.replace(","," - ")),a=new Element("option",{value:n.Key,html:n.Value}).inject(this.target),s?t===0&&(r=n,f=a):(r||n.Key!==y||(r=n,f=a),typeof n.selected=="boolean"&&n.selected===!0&&(r=n,f=a))}.bind(this)),r!==!1&&(f.set("selected","selected"),f.defaultSelected=!0,v=r.Key,this.target.selectedIndex=n.indexOf(r),this.target.value=r.Key))):o==="input"||o==="textarea"?this.target.value=n[0].Value:this.target.set("html",n[0].Value),this.target.retrieve("widget")&&(t=this.target.retrieve("widget"),t.type==="autocomplete"&&t.revert()),o==="select"&&n.length>=Affinity.selectToAutoNum&&UIAutoComplete&&typeOf(UIAutoComplete)==="class"&&this.target.addClass("ui-autocomplete"),this.target.hasClass("ui-autocomplete")&&typeOf(UIAutoCompleteWidget)==="class"&&(this.target.removeClass("ui-autocomplete"),t=new UIAutoCompleteWidget({selectElement:this.target,onComplete:function(n){window.fireEvent("lookupComplete",n.displayElement)}})),t||window.fireEvent("lookupComplete",this.target),this.destroyLoader(),w=this.target.retrieve("dependencies"),Array.each(w.dependancies,function(n){document.id(n.updateThisId)&&(e=document.id(n.updateThisId),e.getWidget("elementWidget")&&(e.getWidget("elementWidget").reset(),e.fireEvent("change",{target:e})))}),this.target.fireEvent("lookupComplete",{defaultValue:v,value:y,target:this.target}),this.target.removeClass("hidden"),this.target.retrieve("widget")&&(t=this.target.retrieve("widget"),t.hasOwnProperty("forceDefaultSelection")&&t.addEvent("complete",this.forceSetDefault))},forceSetDefaultDelay:!1,forceSetDefault:function(){this.target.retrieve("widget")&&(widget=this.target.retrieve("widget"),widget.displayElement&&widget.displayElement!==this.target&&widget.displayElement.hasClass("hidden")&&widget.displayElement.removeClass("hidden"),clearTimeout(this.forceSetDefaultDelay),this.forceSetDefaultDelay=setTimeout(function(){widget.hasOwnProperty("forceDefaultSelection")&&(Affinity.ignoreDependancyDefaults||!widget.defaultValue||widget.isDefaultSelected()||widget.forceDefaultSelection()),widget.removeEvent("complete",this.forceSetDefault)}.bind(this),500))}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTable={Version:"1.0.4.0",Sequence:10160,Name:"Table (Zelos Widget)",File:"ui.zelos.widget.table.js",Jira:"",Notes:"Fix time sorting"},ZelosWidgetTable=new Class({Implements:[Options,Events],Binds:["beforeSort","afterSort","refresh","cleanName","returnParser","buildHeader","buildFooter","buildRows","buildRow","doTotals","doSearch","returnData","saveCSV","destroy"],options:{parentForm:null,parentDocument:null,parentSectionIndex:null,parentChildIndex:null,widgetDocument:null,target:null,zelosEngine:null,zelosProcessor:null,searchable:!0,sortable:!0},dissabled:!1,defaultSortReverse:!0,initialize:function(n){this.setOptions(n),this.gridID=String.uniqueID(),this.isTSStatsPage=new RegExp("statistics","gi").test(window.location.href)?!0:!1,this.seaction=new Element("div",{"class":"section-table"}).inject(this.options.target),this.table={},this.table.hidden=new Element("table",{"class":"hidden"}).inject(this.seaction),this.table.table=new Element("table",{"class":"zelos-table"}).inject(this.seaction),this.table.thead=new Element("thead").inject(this.table.table),this.options.searchable&&(this.table.filters=new Element("thead",{"class":"filters"}).inject(this.table.table)),this.table.tbody=new Element("tbody").inject(this.table.table),this.table.tfoot=new Element("tfoot").inject(this.table.table),this.table.saveButton=new Element("div",{"class":"button green w-icon large save-csv hidden",html:"<span>"+Affinity.icons.Save+"<\/span>Save as CSV"}).inject(this.options.target),this.table.saveButton.addEvent(Affinity.events.click,this.saveCSV),this.noRows=new Element("div",{"class":"no-rows hidden",html:"No results found"}).inject(this.options.target),Affinity.hasOwnProperty("sortgrids")||(Affinity.sortgrids={}),Affinity.sortgrids[this.gridID]=[],this.parserTimeKey="time_"+this.gridID;var t={},i=this;t[this.parserTimeKey]={match:/.*/,convert:function(){var n,i,t;if(this.get("text").trim().match(/[0-9]{2}:[0-9]{2}/))return n=(new Date).clearTime(),i=this.get("text").trim().split(":"),n.setHours(parseInt(i[0])),n.setMinutes(parseInt(i[1])),parseInt(n.getTime());if(t=Affinity.sortgrids,t[t.currentGridId][t.currentSortIndex].direction==="desc"){var n=new Date,r=parseInt((new Date).getFullYear()),u=r+50;return n.setYear(u),parseInt(n.getTime())}return 0},number:!0},HtmlTable.defineParsers(t),this.refresh(this.options.widgetDocument)},beforeSort:function(n){var t=n.target.get("tag")==="th"?n.target:n.target.getParent("th"),i=t.getParent("tr").getElements("th").indexOf(t);Affinity.sortgrids.currentGridId=this.gridID,Affinity.sortgrids.currentSortIndex=i},afterSort:function(){if(this.htmlTable&&this.htmlTable.hasOwnProperty("sorted")){var n=this.htmlTable.sorted,t=Affinity.sortgrids[this.gridID][n.index].direction;Affinity.sortgrids[this.gridID][n.index].direction=n.reverse?"desc":"asc",t===Affinity.sortgrids[this.gridID][n.index].direction&&this.htmlTable.sort(n.index,!n.reverse)}},refresh:function(n){this.table.totals={},this.table.thead.empty(),this.table.tbody.empty(),this.table.tfoot.empty(),this.columns=[],this.parsers=[];var t=n.Children;this.buildHeader(t),this.buildRows(t),this.buildFooter(),this.options.sortable&&(this.currentSort=this.parsers.indexOf("date"),this.htmlTable=new HtmlTable(this.table.table,{parsers:this.parsers,sortable:!0,sortIndex:this.currentSort,sortReverse:this.defaultSortReverse,classSortSpan:"icon",classSortable:"",classGroupHead:"",classGroup:"",classCellSort:"",onSort:this.afterSort.bind(this)}),this.table.table.store("HtmlTable",this.htmlTable)),this.rows=this.table.tbody.getElements("tr.row"),Affinity.prompts.hide()},cleanName:function(n){return n.hyphenate().replace(/-/g," ").trim().capitalize()},returnParser:function(n){var t="";switch(typeOf(n.InputType)!=="null"?n.InputType:""){case"String":case"BankNumber":case"TaxNumber":case"Address":t="string";break;case"Float":case"Integer":t="float";break;case"Currency":t="floatLax";break;case"Date":t="date";break;case"Time":t=this.parserTimeKey;break;default:t=""}return t==="string"&&n.hasOwnProperty("Source")&&(t=n.Source.hasOwnProperty("PropertyName")?n.Source.PropertyName.test(new RegExp("time","gi"))?t=this.parserTimeKey:"string":n.Name.test(new RegExp("time","gi"))?t=this.parserTimeKey:"string"),t},buildHeader:function(n){var t,i,u,r,f,o=new Element("tr").inject(this.table.thead),e;this.options.searchable&&(e=new Element("tr").inject(this.table.filters)),this.parsers=[],this.columns=[],Affinity.sortgrids[this.gridID]=[],Array.each(n,function(n){Array.each(n.Children,function(n){t=n.Source&&n.Source.PropertyName?n.Source.PropertyName:n.Name,i=this.cleanName(n.Name),this.isTSStatsPage&&(i=n.Description.ShortText),this.columns.contains(t)||(this.columns.push(t),u=this.returnParser(n),this.parsers.push(u),this.options.searchable&&(r=new Element("input",{type:"text",placeholder:"Filter"}),r.addEvent("keyup",this.doSearch),new Element("th",{html:""}).adopt(r).inject(e)),f=new Element("th",{"data-name":this.cleanName(n.Name),html:i}).inject(o),f.addEvent(Affinity.events.start,this.beforeSort),Affinity.sortgrids[this.gridID].push({direction:"desc"}),this.table.totals[n.Name]=0)}.bind(this))}.bind(this))},buildFooter:function(){var n=new Element("tr").inject(this.table.tfoot);Array.each(this.columns,function(){new Element("th",{html:""}).inject(n)}.bind(this)),this.table.tbody.getElements("tr.row").length===0?(this.seaction.addClass("hidden"),this.noRows.removeClass("hidden"),this.table.saveButton.addClass("hidden")):(this.doTotals(),this.seaction.removeClass("hidden"),this.noRows.addClass("hidden"),this.table.saveButton.removeClass("hidden"))},buildRows:function(n){Array.each(n,function(n){this.buildRow(n)}.bind(this))},buildRow:function(n){var r,t,f,u,i,o=new Element("tr",{"class":"row"}).inject(this.table.tbody),e=[];Array.each(this.columns,function(){i=new Element("td",{html:""}).inject(o),e.push(i)}),Array.each(n.Children,function(n){if(r=n.Value,n.InputType&&n.InputType==="Date"&&(t=Date.parse(n.Value),t&&"isValid"in t&&t.isValid()&&(r=t.toSimple())),n.InputType&&n.InputType==="Time"){t=(new Date).clearTime();var s=r,o=s.split(":"),h=parseInt(o[0]),c=parseInt(o[1]);t.setHours(h),t.setMinutes(c),t&&"isValid"in t&&t.isValid()&&(r=t.toTime12())}f=n.Source&&n.Source.PropertyName?n.Source.PropertyName:n.Name,u=this.columns.indexOf(f),typeOf(u)==="null"||isNaN(u)||(i=e[u],i&&(i.set("html",r),typeOf(n.InputType)!=="null"&&(n.InputType==="Float"||n.InputType==="Integer"||n.InputType==="Currency")&&i.addClass("dototal")))}.bind(this))},dototalDelay:!1,doTotals:function(){clearTimeout(this.dototalDelay),this.dototalDelay=function(){var t,n={},i;Array.each(this.table.tbody.getElements("tr.row"),function(i){Array.each(i.getElements("td"),function(i,r){i.hasClass("dototal")&&(n[r]||(n[r]=0),t=i.get("html").stripTags().trim(),t!==""&&(n[r]+=parseFloat(t)))}.bind(this))}.bind(this)),i=this.table.tfoot.getElement("tr").getElements("th"),Object.each(n,function(n,t){i[parseInt(t)].set("html",Number.round(n,2))}.bind(this))}.delay(1e3,this)},resortTimer:!1,searchTimer:!1,doSearch:function(n){this.options.searchable&&!this.dissabled&&(clearTimeout(this.resortTimer),clearTimeout(this.searchTimer),this.searchTimer=function(){var r=n.target,u=this.table.filters.getElements("input"),t=u.indexOf(n.target),i=r.value.toLowerCase().trim();Array.each(this.rows,function(n){n.addClass("hidden-"+t),(i===""||n.getElements("td")[t].get("html").toLowerCase().contains(i))&&n.removeClass("hidden-"+t),n.get("class").contains("hidden")?n.inject(this.table.hidden):n.inject(this.table.tbody)}.bind(this)),this.resortTimer=function(){this.htmlTable.sort(this.currentSort,!0)}.delay(500,this),this.doTotals()}.delay(500,this))},returnData:function(){var t=[],n=[];return n=[],Array.each(this.table.thead.getElements("th"),function(t){n.push(t.get("data-name"))}),t.push(n.join(",")),Array.each(this.table.tbody.getElements("tr"),function(i){n=[],Array.each(i.getElements("td"),function(t){n.push(t.get("html"))}),t.push(n.join(","))}),n=[],Array.each(this.table.tfoot.getElements("th"),function(t){n.push(t.get("html"))}),t.push(n.join(",")),t.join("\r\n")},saveCSV:function(){var n=unescape(this.returnData());uiprompt({message:"Please enter a name for your file",onOk:function(t){if(this.iemode)saveTextAs(n,t+".csv");else{var i=new Blob([n],{type:"text/plain;charset=utf-8"});saveAs(i,t+".csv")}}.bind(this)})}}),Affinity.zelos||(Affinity.zelos={}),Affinity.zelos.Elements||(Affinity.zelos.Elements={}),Affinity.zelos.Elements.Table=ZelosWidgetTable,Affinity.zelos||(Affinity.zelos={}),Affinity.zelos.Widgets||(Affinity.zelos.Widgets=[]),Affinity.zelos.Widgets.push("Table"),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetBulkEntry={Version:"1.0.14.0",Sequence:10250,Name:"Timesheet Bulk Entry (Zelos Widget)",File:"ui.zelos.widget.timesheets.bulk.entry.js",Jira:"CCP-1492",Notes:"fix zero code padding"},ZelosWidgetTimesheetBulkEntry=new Class({getEmptyTimesheetPerEmployee:!1,Implements:[Options,Events],Binds:["refresh","getEmployeeList","gotEmployeeList","getEmptyDoc","gotEmptyDoc","getEmptyTimeheet","gotEmptyTimeheet","getEmployeeEmptyTimesheet","sanatisePostDocument","editRow","populateTemplateFromKeyValueObject","downloadCSV","uploadCSV","processTimesheets","processNextTimesheet","continueProcessNextTimesheet","processDocErrors","postTimesheetDoc","updateDataFromRow"],options:{target:null,putApi:null,getEmptyTimesheetApi:null},rendered:!1,initialize:function(n){this.setOptions(n),Affinity.views.bulkentry=this,this.container=new Element("div").inject(this.options.target),this.container.addClass("widget"),this.container.addClass("widget poopy"),this.container.store("widget",this),this.section=new Element("div",{"class":"section shadow"}).inject(this.container),this.body=new Element("div",{"class":"section-body"}).inject(this.section),this.downloadBox=new Element("div",{"class":"ts-import-download"}).inject(this.body),this.uploadBox=new Element("div",{"class":"ts-import-upload"}).inject(this.body),this.gridBox=new Element("div",{"class":"ts-import-grid hidden"}).inject(this.body),this.csvTemplateDownloadButton=new Element("a",{"class":"ts-importer-download-csv ts-import-button",html:"<span>"+Affinity.icons.Download+"<\/span><span>Download CSV Template<\/span>"}).inject(this.downloadBox),new Element("br").inject(this.downloadBox),this.helpBox=new Element("div",{"class":"ts-import-desc",html:"<br />This is a description of all the columns in the CSV Template:<br /><br />"}).inject(this.downloadBox),this.helpShowButton=new Element("div",{"class":"ts-import-desc-help ts-import-button show yellow",html:"<span>"+Affinity.icons.HelpRound+"<\/span><span>CSV Columns & Example Values<\/span>"}).addEvent(Affinity.events.click,function(){this.helpShowButton.dissolve(),this.helpHideButton.reveal(),this.helpBox.reveal()}.bind(this)).inject(this.downloadBox),this.helpHideButton=new Element("div",{"class":"ts-import-desc-help ts-import-button hide orange",html:"<span>"+Affinity.icons.HelpRound+"<\/span><span>Hide Examples<\/span>"}).addEvent(Affinity.events.click,function(){this.helpShowButton.reveal(),this.helpHideButton.dissolve(),this.helpBox.dissolve()}.bind(this)).inject(this.helpBox,"top"),this.helpShowButton.set("reveal",{duration:250,display:"inline-block"}),this.helpHideButton.set("reveal",{duration:250,display:"inline-block"}).toggle(),this.helpBox.set("reveal",{duration:250}).toggle(),this.importDesc=new Element("p",{html:"Download a CSV template using the button above, then enter your data."}).inject(this.uploadBox),this.importDesc=new Element("p",{html:"Upload your new CSV below, then follow the instructions."}).inject(this.uploadBox),this.importDesc=new Element("p",{"class":"important",html:"Make sure that you save your file as a CSV or Text/CSV before uploading!"}).inject(this.uploadBox);var t=new Element("div",{"class":"ts-importer-upload-input"}).inject(this.uploadBox);new Element("div",{"class":"ts-import-button",html:"<span>"+Affinity.icons.Upload+"<\/span><span>Upload CSV<\/span>"}).inject(t),this.uploadForm=new Element("form").inject(t),this.uploadButton=new Element("input",{type:"file",accept:".csv"}).inject(this.uploadForm),this.tableBox=new Element("div",{"class":"section-table"}).inject(this.gridBox),this.table=new Element("table",{"class":"ui-grid"}).inject(this.tableBox),this.tableHead=new Element("thead").inject(this.table),this.tableBody=new Element("tbody").inject(this.table),this.proceeButton=new Element("a",{"class":"ts-importer-process ts-import-button",html:"<span>"+Affinity.icons.Hourglass+"<\/span><span>Process Timesheets<\/span>"}).inject(this.gridBox),this.proceeButton.addEvent(Affinity.events.click,this.processTimesheets),uialert({message:"Getting you all set up",showLoader:!0,noClose:!0}),this.refresh()},hasChanges:function(){return!1},refresh:function(){log("&#171; refresh bulk view &#187;"),this.getEmployeeList()},employeeSelect:!1,getEmployeeList:function(){if(this.employeeSelect)this.gotEmployeeList();else{var n=Affinity.zelosroot+"?api=timesheetAsManager/getEmployees";new Request.JSONP({url:n,callbackKey:"jsoncallback",method:"get",noCache:!0,onComplete:function(t){JSON.Unauthorized(t,"bulk, getEmployeeList - "+n)||(log('&#x2714; attempted detailed toggleAddRowsForm "get employees" succeeded'),this.employeeSelect=new Element("select"),this.options.isEmployee&&this.employeeSelect.adopt(new Element("option",{html:Affinity.login.profile.commonName+" ("+Affinity.login.profile.employeeNumber+")",value:Affinity.login.profile.employeeNumber})),Array.each(t,function(n){n.Value!==""&&n.Key!==""&&n.Key!==this.defaultEmployeeNumber?this.employeeSelect.adopt(new Element("option",{html:n.Value,value:n.Key})):this.employeeSelect.adopt(new Element("option",{html:"Select Employee",value:""}))}.bind(this)),this.gotEmployeeList())}.bind(this),onError:function(n){log('&#x2718; attempted detailed toggleAddRowsForm "get employees" failed with errors - '+n)},onFailure:function(n){log('&#x2718; attempted detailed toggleAddRowsForm "get employees" failed - '+n.statusText)}}).send()}},gotEmployeeList:function(){this.getEmptyDoc()},timesheetDocRaw:!1,getEmptyDoc:function(){if(this.timesheetDocRaw)this.gotEmptyDoc(this.timesheetDocRaw);else{var n=Affinity.zelosroot;n+="?api=timesheetAsManager/get",n+="&fromDate=1.1.70&toDate=1.1.70",n+="&timesheetStatus=",n+="&view=detail",n+="&page=0",n+="&pageSize=1",new ZelosTemplateLoad({onComplete:this.gotEmptyDoc}).loadTemplate(n)}},gotEmptyDoc:function(n){n.Children[0].Children[0].Children=[],this.timesheetDocRaw=n,this.getEmptyTimeheet()},emptyTimesheetDocRaw:!1,emptyTimesheetDoc:!1,getEmptyTimeheet:function(){if(this.emptyTimesheetDoc)this.gotEmptyTimeheet();else{var n=this.options.getEmptyTimesheetApi;log("&#x2794; attempting bulk getEmptyTimeheet ..."),this.loadRequest=new Request.JSON({url:n,method:"get",noCache:!0,onSuccess:function(t){JSON.Unauthorized(t,"bulk, getEmptyTimeheet - "+n)||(t.error?log("&#x2718; attempted bulk getEmptyTimeheet succeeded with errors - "+t.error):(log("&#x2714; attempted bulk getEmptyTimeheet succeeded"),this.gotEmptyTimeheet(t)))}.bind(this),onError:function(n,t){log("&#x2718; attempted bulk getEmptyTimeheet failed with errors - "+t)}.bind(this),onFailure:function(n){log("&#x2718; attempted bulk getEmptyTimeheet failed - "+n.statusText)}.bind(this)}).get()}},gotEmptyTimeheet:function(n){typeOf(n)==="array"&&(this.emptyTimesheetDocRaw=n,this.emptyTimesheetDoc=n[0]),this.buildCSVTemplate(this.emptyTimesheetDoc)},getEmployeeEmptyTimesheet:function(n,t){var u=JSON.stringify(this.emptyTimesheetDocRaw)+"",i=JSON.parse(u),r;typeOf(t)!=="function"&&(t=function(){}),this.getEmptyTimesheetPerEmployee?(r=this.options.getEmptyTimesheetApi+"&employeeNo="+n,log("&#x2794; attempting bulk getEmptyTimeheet for emp '"+n+"' ..."),new Request.JSON({url:r,method:"get",noCache:!0,onSuccess:function(u){JSON.Unauthorized(u,"bulk, getEmployeeEmptyTimesheet - "+r)||(u.error?(log("&#x2718; attempted bulk getEmptyTimeheet for emp '"+n+"' succeeded with errors - "+u.error),t(i)):(log("&#x2714; attempted bulk getEmptyTimeheet  for emp '"+n+"' succeeded"),t(u)))}.bind(this),onError:function(r,u){log("&#x2718; attempted bulk getEmptyTimeheet for emp '"+n+"' failed with errors - "+u),t(i)}.bind(this),onFailure:function(r){log("&#x2718; attempted bulk getEmptyTimeheet for emp '"+n+"' failed - "+r.statusText),t(i)}.bind(this)}).get()):t(i)},sanatisePostDocument:function(n){return Affinity.timesheets.methods.sanatisePostDocument(n)},csvColumns:!1,csvEditColumns:!1,csvColumnKeys:!1,csvTemplate:!1,isColumn:function(n){return n.Attribute.IsHidden?!1:(n.Attribute.IsReadOnly,n.Name.contains("BulkProcess"))?!1:n.Name.contains("RowButton")?!1:!0},isEditColumn:function(n){return n.Name.contains("BulkProcess")?!1:n.Name.contains("RowButton")?!1:!0},sortColumnRank:function(n,t){return n.Layout.rank<t.Layout.rank?-1:n.Layout.rank>t.Layout.rank?1:0},buildCSVTemplate:function(){if(!this.csvTemplate&&this.emptyTimesheetDoc){this.csvColumns=[],this.csvEditColumns=[],this.emptyTimesheetDoc.Children.sort(function(n,t){return parseInt(n.Layout.Rank,10)-parseInt(t.Layout.Rank,10)}),Array.each(this.emptyTimesheetDoc.Children,function(n){this.isColumn(n)&&this.csvColumns.push(n),this.isEditColumn(n)&&this.csvEditColumns.push(n)}.bind(this)),this.csvColumns=this.csvColumns.sort(this.sortColumnRank),this.csvEditColumns=this.csvEditColumns.sort(this.sortColumnRank),this.csvColumnKeys=[];var e=[],i=[],f,n,r,t,u;Array.each(this.csvColumns,function(o,s){f=o.Name.split("-").slice(-1).pop(),e.push(o.Description.ShortText),this.csvColumnKeys.push(f),n=new Element("div",{"class":"help-box"}).inject(this.helpBox),new Element("h2",{html:"Column "+(s+1)+": "+o.Description.ShortText+"  "}).inject(n),new Element("em",{html:" ("+f+")"}).inject(n),"Value"in o&&typeOf(o.Value)==="array"&&o.Value.length>0?(new Element("div",{"class":"help-row",html:"Search / Select to see valid value"}).inject(n),t=new Element("select",{"class":"ui-autocomplete"}).inject(n),new Element("span",{"class":"help-display-label hidden",html:"Valid Value: "}).inject(n),u=new Element("input",{"class":"help-display hidden"}).inject(n),u.addEvent("focus",function(n){n.target.select()}),t.addEvent("change",function(n){n&&"target"in n&&(n.target.getParent(".help-box").getElement(".help-display-label").removeClass("hidden"),n.target.getParent(".help-box").getElement(".help-display").removeClass("hidden"),n.target.getParent(".help-box").getElement(".help-display").value=n.target.value)}),new Element("option",{value:"",html:""}).inject(t),Array.each(o.Value,function(n){new Element("option",{value:n.value,html:n.display}).inject(t)}.bind(this))):o.Name.contains("AuthoriserId")?new Element("div",{"class":"help-row",html:"Value should be your employee number ("+o.Value+")"}).inject(n):"InputType"in o&&(o.InputType==="Lookup"&&(new Element("div",{"class":"help-row",html:"Search / Select to see valid value"}).inject(n),r=Affinity.lookupapi+"?ModelName="+o.Source.ModelName+"&PropertyName="+o.Source.PropertyName,typeOf(o.Data)!=="null"&&typeOf(o.Data.ExternalParameter)!=="null"&&(r+="&"+o.Data.ExternalParameter),"enableSelectLimit"in Affinity&&Affinity.enableSelectLimit&&(r+="&limit="+Affinity.selectmax||1e3),t=new Element("select",{"class":"has-lookup","data-lookup-api":r}).inject(n),new Element("span",{"class":"help-display-label hidden",html:"Valid Value: "}).inject(n),u=new Element("input",{"class":"help-display hidden"}).inject(n),u.addEvent("focus",function(n){n.target.select()}),t.addEvent("change",function(n){n&&"target"in n&&(n.target.getParent(".help-box").getElement(".help-display-label").removeClass("hidden"),n.target.getParent(".help-box").getElement(".help-display").removeClass("hidden"),n.target.getParent(".help-box").getElement(".help-display").value=n.target.value)})),o.InputType==="Date"&&new Element("div",{"class":"help-row",html:"Value should be a date string dd.mm.YYYY"}).inject(n),o.InputType==="Time"&&new Element("div",{"class":"help-row",html:"Value should be a 24 hour time string HH:mm"}).inject(n),o.InputType==="Integer"&&new Element("div",{"class":"help-row",html:"Value should be a whole Number"}).inject(n),(o.InputType==="Float"||o.InputType==="Double")&&new Element("div",{"class":"help-row",html:"Value should be a decimal Number"}).inject(n),o.InputType==="String"&&new Element("div",{"class":"help-row",html:"Value should be a String"}).inject(n)),"Value"in o?typeOf(o.Value)==="string"&&o.Value!==""?o.Name.toLowerCase().contains("date")?i.push(Date.parse(o.Value).format("%d.%m.%Y")):i.push(o.Value):i.push(""):i.push("")}.bind(this)),this.csvTemplate=e.join(",")+"\n"+i.join(",")+"\n"}this.renderUI()},downloadCSV:function(){var t,u,i,n,r,e,f="timesheets_"+Affinity.login.profile.companyNumber+"_"+Affinity.login.profile.employeeNumber+"_"+(new Date).format("%d-%m-%Y")+".csv";Affinity.isie?(t="sep=,\r\n"+this.csvTemplate,i=new Element("iframe").inject(this.container,"bottom").addClass("subhidden"),n=i.contentWindow||i.contentDocument,n.document.open("text/html","replace"),n.document.write(t),n.document.close(),n.focus(),e=n.document.execCommand("SaveAs",!0,f),i.destroy()):(t="data:text/csv;charset=utf-8,",t+=this.csvTemplate,u=encodeURI(t),r=new Element("a",{href:u,download:f}),r.click(),r.destroy())},renderUI:function(){if(!this.rendered){this.csvTemplateDownloadButton.addEvent(Affinity.events.click,this.downloadCSV),this.tableEmpIndex=!1;var n=new Element("tr").inject(this.tableHead);Array.each(this.csvColumns,function(t,i){new Element("th",{html:t.Description.ShortText,"data-key":this.csvColumnKeys[i],"class":"key-"+this.csvColumnKeys[i]}).inject(n),(this.csvColumnKeys[i].toLowerCase().contains("emp")&&this.csvColumnKeys[i].toLowerCase().contains("no")||this.csvColumnKeys[i].toLowerCase().contains("emp")&&this.csvColumnKeys[i].toLowerCase().contains("num"))&&(this.tableEmpIndex=i)}.bind(this)),this.tableHeadCells=this.tableHead.getElements("th"),new Element("th").inject(n),this.uploadButton.addEvent("change",this.uploadCSV),Affinity.uiAutoComplete.processNew(),Affinity.uiSelectLookup.options.jsonp=!0,Affinity.uiSelectLookup.processNew()}this.rendered=!0,Affinity.prompts.hide(),this.fireEvent("complete")},uploadCSV:function(){var t=this.uploadButton.files[0],n=new FileReader;n.onload=function(){this.gotCSVData(n.result),this.uploadForm.reset()}.bind(this),n.readAsText(t)},CSVtoArray:function(n){var i=/(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g,t;return/^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/.test(n)?(t=[],n.replace(i,function(n,i,r,u){return i!==undefined?t.push(i.replace(/\\'/g,"'")):r!==undefined?t.push(r.replace(/\\"/g,'"')):u!==undefined&&t.push(u),""}),/,\s*$/.test(n)&&t.push(""),t):null},rowData:!1,gotCSVData:function(n){this.rowData=[],this.tableBody.empty(),this.gridBox.addClass("hidden");var t,i=n.split(/\r\n|\n/);Array.each(i,function(n){n=n.replace(new RegExp("'","gi")," "),t=this.CSVtoArray(n),t&&t.length===this.csvColumns.length&&t[0]!==this.csvColumns[0].Description.ShortText&&(this.rowData.push(t),this.addRow(t))}.bind(this))},padZero:function(n){return!isNaN(parseInt(n))&&n.toString().length===1&&parseInt(n)>-1&&parseInt(n)<10?"0"+parseInt(n).toString():n},checkForCodePadZero:function(n,t){return n.test(new RegExp("code","gi"))?this.padZero(t):t},checkForInvalidTimes:function(n,t){var r,i;return(n.test(new RegExp("starttime","gi"))||n.test(new RegExp("endtime","gi")))&&(t.test(new RegExp("am","gi"))||t.test(new RegExp("pm","gi")))&&(r=t.test(new RegExp("pm","gi"))?12:0,t=t.replace(new RegExp("am|pm","gi"),"").trim(),i=new Date.parse(t),i.isValid())?(i.getHours()===12&&r===12&&(r=0),i=i.increment("hour",r),i.format("%H:%M")):t},addRow:function(n){var t=new Element("tr"),i,r;Array.each(n,function(n,u){i=this.tableHeadCells[u].get("data-key"),r=this.checkForCodePadZero(i,n),r=this.checkForInvalidTimes(i,r),new Element("td",{"class":"key-"+i,html:r}).inject(t)}.bind(this)),new Element("td",{"class":"progress",html:Affinity.icons.Ellipsis}).inject(t),t.inject(this.tableBody),t.addEvent(Affinity.events.click,this.editRow),this.gridBox.removeClass("hidden"),Affinity.uiGrid.zebra(this.table)},updateDataFromRow:function(n){if(n&&"get"in n&&n.get("tag")==="tr"){var t,i;t=this.tableBody.getElements("tr"),i=t.indexOf(n),Array.each(n.getElements("td"),function(n,t){this.rowData[i][t]=n.get("html")}.bind(this))}},promptForEmployee:function(n){var t=this.employeeSelect.clone();uialert({message:"Before we can edit this timesheet<br />we need a valid employee number",showButtons:!1,onClose:function(){t.removeEvents(),t.retrieve("widget")&&t.retrieve("widget").destroy()}}),t.addEvent("change",function(){prompts.hide(),typeOf(n)==="element"&&(n.getElement(".key-EmployeeNo").set("html",t.value),this.updateDataFromRow(n),this.continueRowEdit(n))}.bind(this)),prompts.adopt(new Element("br"),new Element("br"),t,new Element("br"),new Element("br")),new UIAutoCompleteWidget({selectElement:t})},editRow:function(n){var t,i;t=n.target.get("tag")==="tr"?n.target:n.target.getParent("tr"),i=!1,t.hasClass("locked")||(i=t.getElement(".key-EmployeeNo")&&t.getElement(".key-EmployeeNo").get("html")&&t.getElement(".key-EmployeeNo").get("html")!==""?t.getElement(".key-EmployeeNo").get("html"):!1),i?this.continueRowEdit(t):this.promptForEmployee(t)},continueRowEdit:function(n){var a,t,i,o=!1,s=!1,h=!1,u=0,f=0,c=!1,v=this.tableBody.getElements("tr"),y=v.indexOf(n),p=this.rowData[y],e={},l=this.tableHead.getElements("th"),r;Array.each(l,function(n,r){n.get("data-key")&&(t=n.get("data-key"),i=this.checkForInvalidTimes(t,p[r]),i=this.checkForCodePadZero(t,i),e[t]=i,t.test(new RegExp("StartTime","gi"))&&(o=!0),t.test(new RegExp("EndTime","gi"))&&(s=!0),t.test(new RegExp("TsNet","gi"))&&(h=!0))}.bind(this)),n.hasClass("locked")||(c=n.getElement(".key-EmployeeNo")&&n.getElement(".key-EmployeeNo").get("html")&&n.getElement(".key-EmployeeNo").get("html")!==""?n.getElement(".key-EmployeeNo").get("html"):!1),this.formElement||(this.formElement=new Element("div",{"class":"timesheet-edit-form"})),this.formElement.empty(),r=Object.clone(this.emptyTimesheetDoc),r=this.populateTemplateFromKeyValueObject(r,e),a=new ZelosWidgetTimesheetEditForm({target:this.formElement,timesheetId:!1,employeeNumber:c,keyValueData:e,supressButtons:!0,width:600,originDoc:r,onLoaded:function(){},onDone:function(t){var i,r,c,e;Array.each(t.Children[0].Children,function(t){Array.each(n.getElements("td"),function(n,e){if(t.Name.contains(l[e].get("data-key"))){if(r=n.get("html"),typeOf(t.Value)==="array"){for(i=t.Value.length-1;i>-1;i--)if(t.Value[i].selected){r=t.Value[i].value;break}}else t.Name.test(new RegExp("StartTime","gi"))&&(u=t.Value),t.Name.test(new RegExp("EndTime","gi"))&&(f=t.Value),t.Name.test(new RegExp("TsNet","gi"))&&(c=n),r=t.Name.test(new RegExp("PayCode","gi"))?this.padZero(t.ValueAsString):t.ValueAsString;this.populateCell(n,r,t)}}.bind(this))}.bind(this)),h&&s&&o&&c&&f&&u&&(e=(Date.parse(f)-Date.parse(u))/36e5,(e+"").length>4&&(e=e.toFixed(2)),c.set("html",e)),this.updateDataFromRow(n)}.bind(this)})},populateCell:function(n,t,i){switch(i.InputType){case"Date":n.set("html",Date.parse(t).format("%d.%m.%Y"));break;case"Time":n.set("html",Date.parse(t).format("%H:%M"));break;default:n.set("html",t)}},populateTemplateFromKeyValueObject:function(n,t){var i;return typeOf(t)!=="null"&&Object.each(t,function(t,r){i=!1,value=this.checkForCodePadZero(r,t),value=this.checkForInvalidTimes(r,value),Array.each(n.Children,function(t,u){if(t.Name.contains(r)){if(r.contains("EmployeeNo")||r==="EmployeeNo")n.Children[u].Value=parseInt(value),n.Children[u].ValueAsString=value;else if("Value"in t)typeOf(t.Value)==="array"?(Array.each(t.Value,function(t,i){typeOf(t)==="object"&&"selected"in t&&"value"in t&&(n.Children[u].Value[i].selected=!1,t.value+""==value+""&&(n.Children[u].Value[i].selected=!0))}.bind(this)),n.Children[u].ValueAsString=JSON.stringify(n.Children[u].Value),"SelectedItem"in t&&(n.Children[u].SelectedItem=value,n.Children[u].SelectedItemAsString=value),i=!0):typeOf(t.Value)==="string"?(n.Children[u].Value=value,n.Children[u].ValueAsString=value,i=!0):isNaN(t.Value)?(console.log(""),console.log("child has Value, but is not array, string or number ... what to do ?"),console.log(t),console.log("")):(n.Children[u].Value=parseFloat(value),n.Children[u].ValueAsString=value+"",i=!0);else if("InputType"in t)switch(t.InputType){case"Lookup":n.Children[u].Value=value,n.Children[u].ValueAsString=value,i=!0;break;case"Float":n.Children[u].Value=parseFloat(value),n.Children[u].ValueAsString=value+"",i=!0;break;case"Integer":n.Children[u].Value=parseInt(value,10),n.Children[u].ValueAsString=value+"",i=!0;break;case"String":n.Children[u].Value=value,n.Children[u].ValueAsString=value,i=!0;break;case"Date":case"Time":case"HoursMins":n.Children[u].Value=value,n.Children[u].ValueAsString=value,i=!0;break;default:console.log(""),console.log("Don't know what to do with InputType \""+t.InputType+'" ... what to do ?'),console.log(t),console.log("")}else console.log(""),console.log("child has NO Value and no InputType ... what to do ?"),console.log(t),console.log("");r.toLowerCase().contains("paycode")&&(n.Children[u].SelectedItem=this.padZero(value),n.Children[u].SelectedItemAsString=this.padZero(value)),i&&(n.Children[u].Attribute={IsHidden:!1,IsReadOnly:!1,IsRequired:!1})}}.bind(this))}.bind(this)),n},allProcessed:!1,postErrors:[],processTotal:0,processCount:0,progress:!1,progressBar:!1,dotdotdot:!1,dotdotdotDelay:!1,processTimesheets:function(){clearInterval(this.dotdotdotDelay),this.allProcessed=!1,this.postErrors=[],this.processTotal=this.rowData.length,this.processCount=0;var n=new Element("div");this.dotdotdotLabel=new Element("span",{html:"Processing"}).inject(n),this.dotdotdot=new Element("span",{"class":"ts-import-progress-dots",html:"..."}).inject(n),this.progress=new Element("div",{"class":"ts-import-progress",html:"Processed "+this.processCount+" Timesheets of "+this.processTotal}).inject(n),this.progressBar=new Element("div",{"class":"ts-import-progress-bar",html:'<div class="bg"><\/div>'}).inject(n),uialert({message:'<div class="ts-import-progress-warn">Do not close your browser!<\/div>',showLoader:!1,noClose:!0}),Affinity.prompts.adopt(n),Affinity.prompts.center(),this.progressBar.setStyle("width","0%"),this.dotdotdotDelay=function(){var n=this.dotdotdot.get("html");n.length===0?this.dotdotdot.set("html","."):n.length===1?this.dotdotdot.set("html",".."):n.length===2?this.dotdotdot.set("html","..."):n.length===3&&this.dotdotdot.set("html","")}.periodical(250,this),this.processNextTimesheet()},setTemplateValue:function(n,t,i){return Array.each(n.Children,function(r,u){var e,f;if(r.Name.contains(t)){if(typeOf(r.Value)!=="object")if(t.contains("EmployeeNo")||t==="EmployeeNo")if(typeOf(r.Value)==="array"){for(e={display:i+"",value:parseInt(i),selected:!0},f=r.Value.length-1;f>-1;f--)if(r.Value[f].value===parseInt(i)){e=Object.clone(r.Value[f]),e.selected=!0;break}n.Children[u].Value=[e],n.Children[u].ValueAsString=JSON.stringify(n.Children[u].Value),n.Children[u].SelectedItem=parseInt(i),n.Children[u].SelectedItemAsString=parseInt(i)+""}else n.Children[u].Value=parseInt(i),n.Children[u].ValueAsString=i;else typeOf(r.Value)==="array"?(Array.each(r.Value,function(t,r){"selected"in t&&typeOf(t.selected)==="boolean"&&(n.Children[u].Value[r].selected=!1,t.value+""==i+""&&(n.Children[u].Value[r].selected=!0))}),n.Children[u].ValueAsString=JSON.stringify(n.Children[u].Value)):(n.Children[u].Value=i,n.Children[u].ValueAsString=i,r.Attribute.IsReadOnly&&(n.Children[u].Attribute.IsReadOnly=!1),r.Attribute.IsHidden&&(n.Children[u].Attribute.IsHidden=!1));t.toLowerCase().contains("paycode")&&(template.Children[childIndex].SelectedItem=this.padZero(i),template.Children[childIndex].SelectedItemAsString=this.padZero(i))}}),n},emlpoyeeTimesheets:{},processNextTimesheet:function(){if(this.rowData[this.processCount]){var r,s,t,i,e,o,u,f,n;r=JSON.stringify(this.timesheetDocRaw)+"",s=JSON.parse(r),t=!1,e=this.tableBody.getElements("tr")[this.processCount],o=e.getElements("td"),n=!1,this.tableEmpIndex!==!1&&(u=o[this.tableEmpIndex],u&&(f=u.get("html"),f.trim()!==""&&(n=f))),n!==!1?this.emlpoyeeTimesheets["emp-"+n]?(i=JSON.stringify(this.emlpoyeeTimesheets["emp-"+n])+"",t=JSON.parse(i),this.continueProcessNextTimesheet(t)):this.getEmployeeEmptyTimesheet(n,function(t){t=t[0],this.emlpoyeeTimesheets["emp-"+n]=t,i=JSON.stringify(this.emlpoyeeTimesheets["emp-"+n])+"",t=JSON.parse(i),this.continueProcessNextTimesheet(t)}.bind(this)):(i=JSON.stringify(this.emptyTimesheetDocRaw)+"",t=JSON.parse(r)[0],this.continueProcessNextTimesheet(t))}else this.continueProcessNextTimesheet(!1)},continueProcessNextTimesheet:function(n){var u,o,i,s,h,p,c,l,f,a,t,v,y,r,e;this.rowData[this.processCount]?n&&(u="accept",o=JSON.stringify(this.timesheetDocRaw)+"",i=JSON.parse(o),s=this.tableBody.getElements("tr")[this.processCount],h=s.getElements("td"),p=this.rowData[this.processCount],Array.each(i.Children[1].Children,function(n,t){n.Value.ButtonType.toLowerCase().contains(u)&&(i.Children[1].Children[t].Value.Pressed=!0,i.Children[1].Children[t].ValueAsString=JSON.stringify(i.Children[1].Children[t].Value))}),Array.each(n.Children,function(t,i){t.Name.contains("RowButton")&&Array.each(t.Children,function(t,r){t.Value.ButtonType.toLowerCase().contains(u)&&(n.Children[i].Children[r].Value.Pressed=!0,n.Children[i].Children[r].ValueAsString=JSON.stringify(n.Children[i].Children[r].Value))})}),Array.each(h,function(t,i){this.tableHeadCells[i]&&(c=this.tableHeadCells[i].get("data-key"),l=t.get("html"),n=this.setTemplateValue(n,c,l))}.bind(this)),n=this.setTemplateValue(n,"Bulk","true"),i.Children[0].Children[0].Children=[],i.Children[0].Children[0].Children.push(n),this.postTimesheetDoc(i)):this.allProcessed=!0,this.progress.set("html","Processed "+this.processCount+" Timesheets of "+this.processTotal),this.progressBar.setStyle("width",this.processCount/this.processTotal*100+"%"),this.allProcessed?(clearInterval(this.dotdotdotDelay),this.dotdotdot.destroy(),this.dotdotdotLabel.set("html","Done."),f=[],a=this.tableBody.getElements("tr"),Array.each(this.postErrors,function(n,i){t=a[i],t.removeClass("failed").removeClass("passed").removeClass("locked"),t.getElement("td.progress").set("html",Affinity.icons.Ellipsis),t.getElement("td.progress").set("data-tooltip",!1),t.getElement("td.progress").removeClass("ui-has-tooltip"),t.removeEvents(),typeOf(n)==="boolean"&&n===!1?(t.addClass("locked passed"),t.getElement("td.progress").set("html",Affinity.icons.Tick),f.push(i)):(t.addClass("failed"),t.getElement("td.progress").set("html",Affinity.icons.Cross),t.addEvent(Affinity.events.click,this.editRow),typeOf(n)==="array"&&(r="",Array.each(n,function(n){typeOf(n)==="string"?r+=n+"<br />":typeOf(n)==="object"&&(n.key==="document"||(n.key==="timesheet"?r+=n.message+"<br />":(v=this.tableHeadCells.indexOf(this.tableHead.getElement(".key-"+n.key)),y=t.getElements("td")[v],new Element("div",{"class":"ui-has-tooltip",html:Affinity.icons.Warning,"data-tooltip":n.message,"data-tooltip-dir":"top,left"}).inject(y))))}.bind(this)),r!==""&&(t.getElement("td.progress").set("html",Affinity.icons.Warning),t.getElement("td.progress").set("data-tooltip",r),t.getElement("td.progress").set("data-tooltip-dir","top,left"),t.getElement("td.progress").addClass("ui-has-tooltip"))))}.bind(this)),Affinity.uiTooltips.processNew(),e=[],Array.each(this.rowsData,function(n,t){f.contains(t)||e.push(n)}.bind(this)),this.rowsData=Array.clone(e),function(){uialert({message:"Timesheets Processed",showLoader:!1,noClose:!1,showButtons:!0})}.delay(5e3,this)):this.processCount++,Affinity.prompts.center()},processDocErrors:function(n){var i=[],t;return n.error?(t={},t.key="document",t.label="",t.message=n.error,i.push(t)):Array.each(n.Children,function(n){Array.each(n.Children,function(n){n.ElementType=="TimesheetTable"&&Array.each(n.Children,function(n){n.Data&&n.Data.RowType||(n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&(t={},t.key="timesheet",t.label="",t.message=n.Attribute.ErrorMessage,i.push(t)),Array.each(n.Children,function(n){n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&(t={},t.key=n.Name.split("-").slice(-1).pop(),t.label=n.Description.ShortText,t.message=n.Attribute.ErrorMessage,i.push(t))}.bind(this)))}.bind(this))}.bind(this))}.bind(this)),i},postTimesheetDoc:function(n){log("&#x2794; attempting bulk postDocumentRow ..."),n=this.sanatisePostDocument(n),new Request.JSON({url:this.options.putApi,timeout:3e5,onSuccess:function(n){if(!JSON.Unauthorized(n,"detailed, postDocumentRow - "+this.options.putApi)){Affinity.hasOwnProperty("resetSessionTimer")&&Affinity.resetSessionTimer();var t=this.processDocErrors(n);t.length===0?(log("&#x2714; attempted bulk postDocumentRow succeeded"),this.postErrors.push(!1),this.processNextTimesheet.delay(500,this)):(log("&#x2718; attempted bulk postDocumentRow succeeded with errors - "+t.join(", ")),this.postErrors.push(t),this.processNextTimesheet.delay(500,this))}}.bind(this),onError:function(n,t){if(typeOf(t)==="object")if("message"in t)t=t.message;else{var i=t.toString();i.contains("401")&&Affinity&&Affinity.login&&Affinity.login.session&&log("&#x270B; attempted bulk postDocumentRow unauthorized &#x270B;"),t=="unknown"}typeOf(t)==="string"&&t.contains("401")?log("&#x270B; attempted bulk postDocumentRow unauthorized &#x270B;"):log("&#x2718; attempted bulk postDocumentRow failed with errors - "+t),this.postErrors.push(t),this.processNextTimesheet.delay(500,this)}.bind(this),onFailure:function(n,t){var i=n.response?n.response:n.responseText?n.responseText:t;i&&i.contains("401")?log("&#x270B; attempted bulk postDocumentRow unauthorized &#x270B;"):log("&#x2718; attempted bulk postDocumentRow failed - "+t),this.postErrors.push(t),this.processNextTimesheet.delay(500,this)}.bind(this),onException:function(n,t){log("&#x2718; attempted bulk postDocumentRow failed with exception - "+n+": "+t),this.postErrors.push("Failed with post exception"),this.processNextTimesheet.delay(500,this)}.bind(this),onTimeout:function(){log("&#x2718; attempted bulk postDocumentRow timed out"),this.postErrors.push("Timed out"),this.processNextTimesheet()}}).post("="+escape(JSON.stringify(n)))},destroy:function(){this.rendered=!1,Array.each(this.container.getElements(".widget"),function(n){n.retrieve("widget")&&"destroy"in n.retrieve("widget")&&n.retrieve("widget").destroy()}),this.employeeSelect=!1,this.timesheetDocRaw=!1,this.emptyTimesheetDocRaw=!1,this.emptyTimesheetDoc=!1,this.csvColumns=!1,this.csvEditColumns=!1,this.csvColumnKeys=!1,this.csvTemplate=!1,this.rowData=!1,this.allProcessed=!1,this.postErrors=[],this.processTotal=0,this.processCount=0,this.progress=!1,this.progressBar=!1,this.dotdotdot=!1,this.dotdotdotDelay=!1,this.helpBox.empty(),this.tableHead.empty(),this.tableBody.empty(),Affinity.views.bulkentry=null,delete Affinity.views.bulkentry}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetTableAsDetailed={Version:"1.0.44.2",Sequence:10230,Name:"Timesheet Table As Detailed (Zelos Widget)",File:"ui.zelos.widget.timesheets.detailed.js",Jira:"",Notes:"reset fave buttons on bulk action"},ZelosWidgetTimesheetTableAsDetailed=new Class({debug:!1,setMissingDefaultAsReadOnly:!1,Implements:[Options,Events],Binds:["isViewActive","setApprovedFilter","removeGlobalElementChangeEvent","addGlobalElementChangeEvent","globalElementChangeHandler","checkKeyboardShortcut","beforeClose","renderCheck","processUI","continueProcessUI","processDocument","selectAllRows","cleanFavData","reduceBulkRows","showAwards","subMenuOver","subMenuOut","showButtons","hideButtons","editFormButtonClicked","buttonClicked","buttonClickedContinue","returnSecondaryAddButton","secondaryAdd","secondaryAddAllowance","addRows","selectFav","promptFavName","showFavSelect","saveFav","sanatisePostDocument","postDocumentRow","openSelectEmployee","toggleAddRowsForm","toggleAddRowsFormCont","showAddRowsForm","hideAddRowsForm","showMobilePopupEditor","toggleSearchForm","showSearchForm","hideSearchForm","adjustFilterDates","doSearch","getNextPage","getPreviousPage","getPage","rowUserInteraction","hasRowChanged","checkColumnMisssAligned","loadNewRows","returnNewRow","buildTableRow","updateRow","forceRowReadOnly","getAttributes","getTimesheetType","mobileSelect","popupEditForm","hidePopupEditFormDeleteButton","duplicateTimesheet","setDates","setEmployee","refresh","destroy","delUnload","getUIAutoCompleteOptions","instantiateUIAutoCompleteWidget","setupCorrectInfoColorForForwardedRowInMobileMode","templates"],options:{parentForm:null,timesheetType:"employee",parentDocument:null,parentSectionIndex:null,parentChildIndex:null,widgetDocument:null,putApi:null,getEmptyTimesheetApi:"",target:null,zelosProcessor:null,insertAddForm:!0,isManager:!1,isEmployee:!1,fromDate:!1,toDate:!1,filterFromDate:!1,filterToDate:!1,paginate:!0,subType:"not-sub-type",isDual:!1,isMileageDual:!1,isAllowanceGrid:!1,profile:!1},uuid:"none yet",aaa:"none yet",ribbonDate:!1,ribbonEmpNo:!1,showAlerts:!0,enableFormEdit:!1,showPeriodButtonsInFilter:!1,showAllUnapproved:!1,messageBucket:[],viewName:"",initialize:function(n){var y,o,s,p,w,h,b,g,nt,c,l,a,f,k,u,t,e,ft,v,r,d,i,ut;if(this.setOptions(n),this.templates(),this.uuid=String.uniqueID(),this.options.zelosProcessor.options.filterFromDate&&(this.options.filterFromDate=this.options.zelosProcessor.options.filterFromDate),this.options.zelosProcessor.options.filterToDate&&(this.options.filterToDate=this.options.zelosProcessor.options.filterToDate),this.options.zelosProcessor.options.isManager&&(this.options.isManager=this.options.zelosProcessor.options.isManager),this.options.zelosProcessor.options.isManager&&(this.options.isEmployee=this.options.zelosProcessor.options.isEmployee),this.isManagerView=this.options.isManager&&this.options.timesheetType.toLowerCase().contains("manager"),this.getApi=this.options.zelosProcessor.options.getApi+"",this.isManagerView&&(this.showAllUnapproved=Affinity.ShowManagerAllUnapproved==="*"?!0:Affinity.ShowManagerAllUnapproved.split(",").contains(Affinity.login.profile.companyNumber)?!0:!1),this.options.isDual?(y=this.options.subType,o="",this.isManagerView&&(y+="-manager"),o=y.ToCamelCase(),Affinity.views[o]=this,this.viewName=o):this.isManagerView?(Affinity.views.managerDetailed=this,this.viewName="managerDetailed"):(Affinity.views.detailed=this,this.viewName="detailed"),this.userData=this.options.profile||Affinity.login.profile,this.options.profile&&Affinity.login.profile.employeeNumber!==this.options.profile.employeeNumber&&(this.currentSearchEmployee=this.userData.employeeNumber),this.isAdmin=Affinity.login.profile.employeeNumber>5e6,this.zelosProcessor=this.options.zelosProcessor,Affinity.apiversion>1?(this.loadTimesheetsFrom=this.userData.payPeriods.currentBegins.clone(),this.loadTimesheetsTo=this.userData.payPeriods.currentEnds.clone()):(s=Affinity.appname,this.userData=JSON.decode(Affinity.CookieMonster.Read(s+"User")),p=JSON.decode(Affinity.CookieMonster.Read(s+"Values")),this.loadTimesheetsFrom=Date.parse(p.ShowTimesheetFrom),this.loadTimesheetsTo=Date.parse(p.NewestTimesheetDate)),this.options.fromDate&&this.options.toDate&&(this.loadTimesheetsFrom=this.options.fromDate.clone(),this.loadTimesheetsTo=this.options.toDate.clone()),!this.isAdmin&&this.showAllUnapproved&&(this.loadTimesheetsFrom=Affinity.login.profile.oldestTimesheetDate,this.loadTimesheetsTo=Affinity.login.profile.newestTimesheetDate),this.isAdmin&&(this.loadTimesheetsFrom=Affinity.login.profile.oldestTimesheetDate,this.loadTimesheetsTo=Affinity.login.profile.currentPayPeriodEnds),w=[["loadTimesheetsFrom","show timesheet from","ShowTimesheetFrom"],["loadTimesheetsTo","newest timesheet","NewestTimesheetDate"]],Array.each(w,function(n){typeOf(this[n[0]])==="date"&&(typeOf(this[n[0]])!=="date"||this[n[0]].isValid())||(this[n[0]]=!1)}.bind(this)),h="",Array.each(w,function(n){this[n[0]]||(h+=n[1]+" date ("+n[2]+") is missing or invalid\r\n")}.bind(this)),h!==""){b={},b.message=Affinity.languages.english.application.timesheets.globals.noViewAccess+"<!--\r\n"+h+"-->",window.fireEvent("logout",b);return}if(window.addEvent("processorDocumentSaved",function(n){n.processorId==this.zelosProcessor.processorId&&this.refresh()}.bind(this)),window.addEvent("processorDocumentError",function(n){n.processorId==this.zelosProcessor.processorId&&this.processErrors(n.document,!0)}.bind(this)),this.parentSection=this.options.parentDocument.Children[this.options.parentSectionIndex],this.baseLang=Affinity.languages.english.features,this.genericLang=Affinity.languages.english.generic,this.baseAppLang=Affinity.languages.english.application.timesheets.features,this.globalLang=Affinity.languages.english.application.timesheets.globals,this.icons={},this.icons.edit=Affinity.icons.Pencil,this.icons.save=Affinity.icons.Save,this.icons.view=Affinity.icons.Page,this.icons.del=Affinity.icons.CrossRound,this.icons.add=Affinity.icons.PlusRound,this.icons.cancel=Affinity.icons.Cancel,this.icons.approve=Affinity.icons.ThumbsUp,this.icons.decline=Affinity.icons.ThumbsDown,this.icons.search=Affinity.icons.Search,this.icons.duplicate=Affinity.icons.Docs,this.icons.list=Affinity.icons.List,this.icons.addrow=Affinity.icons.AddToList,this.icons.allowance=Affinity.icons.Gift,this.icons.award=Affinity.icons.Gift,this.icons.fav=this.baseLang.favourites.icon,this.icons.help=this.baseLang.help.icon,this.icons.dotsVert=Affinity.icons.DotsVert,this.zelosProcessor=this.options.zelosProcessor,this.table=new Element("table").inject(this.options.target),g=new Element("thead").inject(this.table),this.thead=new Element("tr").inject(g),this.tbody=new Element("tbody").inject(this.table),nt=new Element("tfoot").inject(this.table),this.tfoot=new Element("tr").inject(nt),this.options.timesheetType==="employeeDetails"&&this.table.addClass("detailed"),c=new Element("div",{"class":"section-table"}).wraps(this.table),this.options.insertAddForm){if(this.searchFormTarget=new Element("div").inject(this.options.target,"top"),this.searchFormButton=new Element("span",{"class":"button blue w-icon showSearch",html:"<span>"+this.icons.search+"<\/span>Search"}),this.searchFormButton.set("reveal",{duration:300,display:"inline-block"}),l=new Element("input",{type:"text"}),a=new Element("input",{type:"text"}),this.searchForm=new Element("div",{"class":"default-form w-border timesheetSearchFrom"}),this.searchEmployee=!1,this.isManagerView&&(this.searchEmployee=new Element("select",{"class":"has-lookup","data-lookup-api":Affinity.zelosroot+"?api=timesheetAsManager/getEmployees"}),this.options.isDual&&this.searchEmployee.set("data-lookup-rules","hasValue"),this.searchEmployeeRow=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search Employee"}),this.searchEmployee),this.searchForm.adopt(this.searchEmployeeRow)),this.searchEmployeeGroups=!1,f=!1,k=!1,this.searchPayPoint=!1,this.searchScreenFilters=!1,this.isManagerView){if(u=!1,Affinity.apiversion>1)try{u=Affinity.login.profile.screenFilters}catch(b){}else try{u=JSON.decode(Affinity.CookieMonster.Read(s+"ScreenFilters"))}catch(b){}u&&typeOf(u)==="array"&&u.length>0?(this.searchScreenFilters=[],Array.each(u,function(n){"Data"in n?(f=!1,t=new Element("select"),t.set("data-field-name",n.FieldName),Array.each(n.Data,function(i){n.FieldName!=="MethodFilter"||i.Key===null||f?new Element("option",{value:i.Key,html:i.Value}).inject(t):(k=i.Value,t.set("data-default-value",i.Key),new Element("option",{value:i.Key,html:i.Value,selected:"selected"}).inject(t),f=!0)}.bind(this)),e=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:n.Label}),t),e.inject(this.searchForm),new UIAutoCompleteWidget({selectElement:t}),n.FieldName==="PayPoint"?(this.searchPayPointRow=e,this.searchPayPoint=t):n.FieldName==="EssGroup"?(this.searchEmployeeGroupsRow=e,this.searchEmployeeGroups=t):this.searchScreenFilters.push(t)):(t=new Element("select"),t.addClass("has-lookup"),t.set("data-field-name",n.FieldName),t.set("data-label",n.Label),t.set("data-lookup-api",Affinity.lookupapi+"?ModelName="+n.ModelName+"&PropertyName="+n.FieldName),this.searchScreenFilters.push(t),e=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Filter By "+n.Label.replace(/ /gi,"&nbsp;")}),t).inject(this.searchForm))}.bind(this))):(this.searchScreenFilters=new Element("input",{type:"hidden",value:""}),this.searchForm.adopt(this.searchScreenFilters))}if(this.showPeriodButtonsInFilter){var tt=new Element("span",{"class":"button w-icon blue filter-last-period",html:'<span class="icon-arrow-left"><\/span>Last'}),it=new Element("span",{"class":"button w-icon blue filter-current-period",html:'<span class="icon-calendar"><\/span>Current'}),rt=new Element("span",{"class":"button w-icon blue filter-next-period",html:'<span class="icon-arrow-right"><\/span>Next'});this.searchForm.adopt(new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search From"}),l),new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search To"}),a),new Element("div",{"class":"form-row"}).adopt(new Element("div",{"class":"sub-text",html:"Set dates to Pay Periods."}),new Element("br"),new Element("label"),new Element("div",{style:"display:inline-block"}).adopt(tt,new Element("span",{html:"&nbsp;"}),it,new Element("span",{html:"&nbsp;"}),rt),new Element("br"),new Element("div",{"class":"sub-text",html:"Leave 'Search To' blank if you wish to search only one day."}))),tt.addEvent(Affinity.events.click,this.adjustFilterDates),it.addEvent(Affinity.events.click,this.adjustFilterDates),rt.addEvent(Affinity.events.click,this.adjustFilterDates)}else this.searchForm.adopt(new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search From"}),l),new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search To"}),a,new Element("br"),new Element("div",{"class":"sub-text",html:"Leave 'Search To' blank if you wish to search only one day."})));this.searchFrom=new UIDateTimeWidget({target:l,startDate:this.options.filterFromDate?this.options.filterFromDate.clone():this.options.fromDate.clone(),showCalendarFilterButtonsForMobile:Affinity.mobile}),this.searchTo=new UIDateTimeWidget({target:a,startDate:this.options.filterToDate?this.options.filterToDate.clone():this.options.toDate.clone(),showCalendarFilterButtonsForMobile:Affinity.mobile}),this.searchStatus=!1,this.isManagerView&&(this.FilterApprovedCheckbox=!1,this.FilterManagedCheckbox=!1,this.supportedStatus=["Submitted","Declined","Approved","Paid"],ft=new Element("div"),this.searchStatus=new Element("div",{"class":"form-row wide search-status"}).adopt(new Element("label",{html:"Filter by Status"})),v=0,Array.each(this.supportedStatus,function(n){if(r="",n==="Submitted"?r="checked":this.showAllUnapproved&&(r=""),this.options.timesheetType=="manager"&&n!=="Pending"||this.options.timesheetType!=="manager"){v!==0&&v%3==0&&(new Element("br").inject(this.searchStatus),new Element("div",{"class":"labelplaceholder"}).inject(this.searchStatus));var t=new Element("input",{type:"checkbox",id:"searchStatusCheck-d-"+n,"class":"searchStatusCheck-d-"+n,name:"searchStatusCheck-d-"+n,checked:r}).addEvent(Affinity.events.click,function(){document.getElement(".select-all-status-d")&&(document.getElement(".select-all-status-d").checked=!1)}.bind(this));n==="Approved"&&(this.FilterApprovedCheckbox=t,this.FilterApprovedCheckboxLastChecked=this.FilterApprovedCheckbox.checked),new Element("div",{"class":"check-label-pair"}).adopt(t,new Element("label",{"class":"right",html:n,"for":"searchStatusCheck-d-"+n})).inject(this.searchStatus),v++}}.bind(this)),this.searchForm.adopt(this.searchStatus),new Element("div",{"class":"form-row wide"}).adopt(new Element("label",{html:""}),new Element("div",{"class":"check-label-pair"}).adopt(new Element("input",{type:"checkbox",id:"select-all-status-d","class":"select-all-status-d",name:"select-all-status-d"}).addEvent("click",function(n){var t=this.searchStatus.getElements('input[type="checkbox"]');Array.each(t,function(t){t.checked=n.target.checked}),t.length>0&&(t[0].checked=!0)}.bind(this)),new Element("label",{"class":"right",html:"Select All","for":"select-all-status-d"}))).inject(this.searchForm)),this.immutibleFilter=!1,this.managedFilter=!1,d=this.options.zelosProcessor.options.getApi.test(new RegExp("dont_return_managed","gi"))?!1:!0,this.isManagerView&&(r="checked",this.immutibleFilter=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Exclude Locked"}),new Element("div",{"class":"check-label-pair"}).adopt(new Element("input",{type:"checkbox","class":"searchExcludeLockedCheck-d",name:"searchFilterImmutible-d",checked:r}))).inject(this.searchForm),r=d?"":"checked",this.FilterManagedCheckbox=new Element("input",{type:"checkbox","class":"searchMangedOnlyCheck-d",name:"searchFilterMangedOnly-d",checked:r}),this.managedFilter=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Timesheets to Action"}),new Element("div",{"class":"check-label-pair"}).adopt(this.FilterManagedCheckbox)).inject(this.searchForm)),this.searchForm.adopt(new Element("br"),new Element("div",{"class":"form-row buttons"}).adopt(new Element("label",{html:"","class":"mobile-no-display"}),new Element("span",{"class":"button blue w-icon",html:"<span>"+this.icons.add+"<\/span>Search"}).addEvent(Affinity.events.click,this.doSearch),new Element("span",{html:"&nbsp;"}),new Element("span",{"class":"button grey w-icon",html:"<span>"+this.icons.cancel+"<\/span>Cancel"}).addEvent(Affinity.events.click,this.hideSearchForm))),this.searchForm.set("reveal",{duration:300}),this.searchForm.toggle(),this.searchFormButton.addEvent(Affinity.events.click,this.showSearchForm),new Element("div",{"class":"form-row"}).adopt(this.searchForm,this.searchFormButton).inject(c,"before"),i=[],i.push("Date From "+Date.parse(this.searchFrom.date).format("%d/%m/%Y")),i.push("Date To "+Date.parse(this.searchTo.date).format("%d/%m/%Y")),this.options.timesheetType==="manager"&&(i.push("Status Submitted"),i.push("Excluding Locked"),d||i.push("My timesheets to approve only"),f&&i.push(k)),ut=this.FilterStringTemplate.format({filters:i.join(", ")}),this.filterStrBox=new Element("div",{"class":"filter-str",html:ut}).inject(c,"before"),i=null}this.isManagerView&&this.FilterApprovedCheckbox&&this.FilterManagedCheckbox&&(this.setApprovedFilter(),this.FilterManagedCheckbox.addEventListener("change",this.setApprovedFilter)),this.options.paginate&&(this.paginationContainer=new Element("div",{"class":"pagination"}),this.paginationSection=new Element("div",{"class":"default-form frameless"}).adopt(new Element("div",{"class":"form-row"}).adopt(this.paginationContainer)).inject(c,"after")),this.currentFocus="null",window.addEvent("keyup",function(n){n.code===9&&(this.currentFocus=document.activeElement.get("id"))}.bind(this)),window.addEvent("lookupComplete",function(n){if(n&&n.get("id")&&n.get("id")==this.currentFocus&&(n.focus(),n.select(),this.currentFocus=document.activeElement.get("id"),n.hasClass("ui-autocomplete-display"))){var t=n.retrieve("widget");t.show("ts detailed on lookupComplete"),t=null}}.bind(this)),this.norows=new Element("div",{"class":"no-rows",html:'<div class="message">'+Affinity.languages.english.application.timesheets.globals.noTimesheeets+"&nbsp;&nbsp;<\/div>",style:"padding: 10px;"}).inject(this.table,"before"),!Affinity.mobile&&this.options.parentForm&&(this.canKeyboardShortcut=!1,this.options.parentForm.addEvent(Affinity.events.overAll,function(){this.canKeyboardShortcut=!0}.bind(this)),this.options.parentForm.addEvent(Affinity.events.outAll,function(){this.canKeyboardShortcut=!1}.bind(this)),window.addEvent("keydown",this.checkKeyboardShortcut)),this.refresh(this.options.widgetDocument)},setApprovedFilter:function(){this.isManagerView&&(this.FilterManagedCheckbox.checked?(this.FilterApprovedCheckboxLastChecked=this.FilterApprovedCheckbox.checked,this.FilterApprovedCheckbox.checked=!1,this.FilterApprovedCheckbox.disabled=!0,this.FilterApprovedCheckbox.parentNode.classList.add("disabled")):(this.FilterApprovedCheckbox.disabled=!1,this.FilterApprovedCheckbox.checked=this.FilterApprovedCheckboxLastChecked,this.FilterApprovedCheckbox.parentNode.classList.remove("disabled")))},removeGlobalElementChangeEvent:function(){return window.removeEvent("AnElementChanged",this.globalElementChangeHandler),window.removeEvent("AnElementRestored",this.globalElementChangeHandler),!0},addGlobalElementChangeEvent:function(){return this.removeGlobalElementChangeEvent(),window.addEvent("AnElementChanged",this.globalElementChangeHandler),window.addEvent("AnElementRestored",this.globalElementChangeHandler),!0},globalElementChangeHandler:function(n){if(!Affinity.doCheckRowChanges())return!1;this.doChangeChecks&&this.isViewActive()&&(this.hasRowChanged(n.target),this.hasChanges()?this.setUnload():this.delUnload())},isViewActive:function(){var n=!1,t=Affinity.timesheets.init.view,i=this.options.timesheetType;return t==="employee"&&i==="employee"&&(n=!0),t==="dualdetail"&&i==="employeeDetails"&&(n=!0),t==="dualdetail"&&i==="manager"&&(n=!0),t==="manager"&&i==="manager"&&(n=!0),t===i&&(n=!0),n},checkKeyboardShortcut:function(n){if(this.canKeyboardShortcut&&n.control&&n.alt){n.stop();switch(n.key){case"n":case"N":this.secondaryAdd();break;case"u":case"U":Affinity.login.areas.Timesheet.AddUnit&&this.secondaryAddAllowance();break;case"f":case"F":this.selectFav()}}},setUnload:function(){window.onbeforeunload=this.beforeClose},delUnload:function(){window.onbeforeunload=function(){}},beforeClose:function(){return Affinity.languages.english.application.timesheets.globals.unsavedTimeshetWarn+(this.changedFieldsMessage!==""?"\n\n"+this.changedFieldsMessage:"")},hasRows:!1,setNoRows:function(){this.norows.removeClass("hidden"),this.table.addClass("hidden"),this.hasRows=!1},setHasRows:function(){this.norows.addClass("hidden"),this.table.removeClass("hidden"),this.hasRows=!0},setDates:function(n,t){var i=this.aaa;return typeOf(n)==="date"&&n.isValid()&&typeOf(t)==="date"&&t.isValid()&&(this.loadTimesheetsFrom=n.clone(),this.loadTimesheetsTo=t.clone(),this.options.isDual&&(this.options.fromDate=n.clone())),this.awardModal&&this.awardModal.close(),"from: "+n.toFriendlyShort()+", to: "+t.toFriendlyShort()},setEmployee:function(n){return this.currentSearchEmployee=n,!0},setExisitngDocOnRefresh:function(n){this.destroyRows()&&(this.tbody.empty(),typeOf(this.options.widgetDocument.Children)=="array"&&this.options.widgetDocument.Children.length>0?this.setHasRows():(this.setNoRows(),this.tbody.getParent(".inline-awards")||(this.secondaryAddButton||this.returnSecondaryAddButton(),this.secondaryButtonWrapper.inject(this.norows))),this.processDocument(n))},refreshing:!1,filterFromRefresh:!1,refresh:function(n,t){var u,f,r,s,h,c;if(this.isViewActive()){this.awardModal&&this.awardModal.close(),this.refreshing=!0,log("&#171; refresh detail view &#187;"),this.removeGlobalElementChangeEvent(),this.columnsCheck=[];var l=this.aaa,i,e=!1,o=!1;if(Affinity.viewSettings.employeeNumber&&Affinity.viewSettings.startDate&&(this.filterFromRefresh=!0,this.startDate=Affinity.viewSettings.startDate.clone(),this.startEmployee=Affinity.viewSettings.employeeNumber,u=Affinity.languages.english.application.timesheets.globals.gettingEmplopyee+" "+Affinity.viewSettings.employeeNumberp+" for "+Affinity.viewSettings.startDate.toFriendlyShort(),uialert({message:u,showLoader:!0,noClose:!0}),this.showSearchForm(),o=Affinity.viewSettings.filterData.forceReload,i=Affinity.viewSettings.filterData,"employee"in i&&(i.emp=i.employee),e=!0),Affinity.timesheets.init.hasOwnProperty("affinityData")&&typeOf(Affinity.timesheets.init.affinityData)==="object"){if(this.filterFromRefresh=!0,log("&#x22C8; switch detail view attempted with affinity data (for: "+Affinity.timesheets.init.affinityData.fromDate.toFriendly()+" to "+Affinity.timesheets.init.affinityData.toDate.toFriendly()+", emp: "+Affinity.timesheets.init.affinityData.emp+") ...",{color:"orange"}),u=Affinity.languages.english.application.timesheets.globals.gettingEmplopyee+" "+Affinity.timesheets.init.affinityData.emp+" for "+Affinity.timesheets.init.affinityData.fromDate.toFriendlyShort()+" to "+Affinity.timesheets.init.affinityData.toDate.toFriendlyShort(),i=Affinity.timesheets.init.affinityData,i.employee=i.emp,i.fromDate=i.fromDate?i.fromDate:i.date,i.toDate=i.toDate?i.toDate:i.date,i.hasOwnProperty("origin")&&i.origin==="Max"){this.addRows(i.fromDate,i.toDate,i.employee,!1,!1,!1,i.units,!0),Affinity.timesheets.init.affinityData=!1,i=null,delete i;return}e=!0,this.showSearchForm(),delete i.emp,delete i.date,e=!0}if(e){(function(){var t;this.searchEmployee&&"emp"in i&&(t=this.searchEmployee.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue(i.employee+"",!1)),this.searchPayPoint&&(t=this.searchPayPoint.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue(i.payPoint+"",!1)),this.searchEmployeeGroups&&(t=this.searchEmployeeGroups.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue("",!1)),this.searchScreenFilters&&Array.each(this.searchScreenFilters,function(n){t=n.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue("",!1)}),this.searchStatus&&Array.each(this.searchStatus.getElements("input"),function(n){n.checked=!0}),"date"in i&&(this.searchFrom.setDate(i.date),this.searchTo.setDate(i.date)),"fromDate"in i&&"toDate"in i&&(this.searchFrom.setDate(i.fromDate),this.searchTo.setDate(i.toDate)),this.immutibleFilter&&"excludeLocked"in i&&this.immutibleFilter.getElement(".searchExcludeLockedCheck-d")&&(this.immutibleFilter.getElement(".searchExcludeLockedCheck-d").checked=i.excludeLocked),this.managedFilter&&"onlyManged"in i&&this.managedFilter.getElement(".searchMangedOnlyCheck-d")&&(this.managedFilter.getElement(".searchMangedOnlyCheck-d").checked=i.onlyManged),o?this.doSearch(""):typeOf(n)==="null"?this.doSearch(u):(this.setExisitngDocOnRefresh(n),this.doSearch("",!0)),this.options.isMileageDual||Affinity.viewSettings.reset(),Affinity.timesheets.init.affinityData=null,delete Affinity.timesheets.init.affinityData}).delay(1e3,this);return}typeOf(n)==="null"||o?(f=new URI(this.getApi),r=typeOf(f.parsed.query)==="null"?{}:f.parsed.query.parseQueryString(),r.fromDate=this.loadTimesheetsFrom.format("%d.%b.%Y"),r.toDate=this.loadTimesheetsTo.format("%d.%b.%Y"),this.isManagerView||(s=this.searchFrom?this.searchFrom.getDateObject():this.options.fromDate?this.options.fromDate:this.loadTimesheetsFrom,h=this.searchTo?this.searchTo.getDateObject():this.options.toDate?this.options.toDate:this.loadTimesheetsTo,r.fromDate=s.format("%d.%b.%Y"),r.toDate=h.format("%d.%b.%Y")),this.options.isDual&&(r.fromDate=this.options.fromDate.format("%d.%b.%Y"),r.toDate=this.options.fromDate.format("%d.%b.%Y")),!this.options.isDual&&this.filterQueryObject&&Object.merge(r,this.filterQueryObject),this.currentSearchEmployee&&(r.employeeNo=this.currentSearchEmployee),r.page=this.currentPage,r.view="detail",this.options.isDual&&(r.view="daydetail",this.filterQueryObject=r),f.parsed.query=Object.toQueryString(r),c=Affinity.GetCacheSafePath(f.toString()),this.loadNewRows(c,"Refresh",t)):this.setExisitngDocOnRefresh(n),this.fireEvent("refreshed")}},getMessages:function(n,t){var r=t||"",i=[];return n.Attribute&&(n.Attribute.Message&&i.push('<div class="yellow">'+r+n.Attribute.Message+"<\/div>"),n.Attribute.ErrorMessage&&i.push('<div class="red">'+r+n.Attribute.ErrorMessage+"<\/div>")),i},docMessages:[],returnMessagesArray:function(){return this.docMessages},messageIndent:"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",processDocument:function(n){var u=new Date,i,t,r;this.removeGlobalElementChangeEvent(),this.doChangeChecks=!1,this.readonly=this.options.widgetDocument.Attribute.IsReadOnly,t=this.readonly?"ui-grid ui-grid-sortable timesheet":"ui-grid timesheet",t=this.options.timesheetType==="employeeDetails"?t+" detailed":t,this.table.set("class",t),this.tbody.getElements("tr.timesheet-row").addClass("old"),this.docMessages=[],Array.each(this.getMessages(n),function(n){this.docMessages.push(n)}.bind(this)),r=0,Array.each(n.Children,function(n){i=this.returnNewRow(n),i&&(i.inject(this.tbody),r++)}.bind(this)),Array.each(this.tbody.getElements("tr.old"),this.destroyRow.bind(this)),this.processUI(),delete t,delete i,log("&#x2714; detail view document processed ("+u.elapsed()+")"),function(){this.addGlobalElementChangeEvent(),this.fireEvent("processComplete")}.delay(1e3,this)},addRowsFormSatus:"closed",getUIAutoCompleteOptions:function(n,t){return{stopInitialChange:!1,selectElement:n,onComplete:function(){prompts.center()},onElementChanged:function(i){var r=parseInt(i,10),e=n.get("id"),o=document.getElement("select#"+e.replace("-Display","")),u=!1,f;if(Array.each(n.getElements("option"),function(n){f=parseInt(n.get("value"),10),f===r&&(u=!0)}.bind(this)),u){if(uialert({message:"Getting empty Timesheet for "+n.value,showLoader:!0,showButtons:!1}),t==="timesheet")this.addRows(new Date,new Date,r);else if(t==="allowance")this.addRows(new Date,new Date,r,!1,!0);else{prompts.hide();throw"Can not add timesheet of unknown type ("+t+")";}Affinity.mobile&&(this.showMobilePopupEditor=!0)}else prompts.hide()}.bind(this)}},openSelectEmployee:function(n){uialert({message:"Select an employee",showButtons:!1});var i=n||"timesheet",t=this.addRowEmployeeSelect.clone();t.addClass("hidden"),Affinity.prompts.adopt(new Element("br"),new Element("br"),t,new Element("br"),new Element("br")),function(){t.removeClass("hidden");var n=this.getUIAutoCompleteOptions(t,i);this.instantiateUIAutoCompleteWidget(n)}.delay(250,this)},instantiateUIAutoCompleteWidget:function(n){var t=undefined;Affinity.mobile&&"UIAutoCompleteMobileWidget"in window?t=new UIAutoCompleteMobileWidget(n):(t=new UIAutoCompleteWidget(n),window.onPromptClose=function(){t&&t.destroy()}.bind(this))},toggleAddRowsForm:function(n){var t=typeOf(n)==="null"?!1:n;!t&&Affinity.login.areas.Timesheet.AddUnit?uiconfirm({message:"Select a Timesheet Type",okText:"Timesheet",okColor:"blue",okIcon:Affinity.icons.Clock,cancelText:"Unit",cancelColor:"blue",cancelIcon:Affinity.icons.Gift,noClose:!1,onOk:function(){this.toggleAddRowsFormCont("timesheet")}.bind(this),onCancel:function(){this.toggleAddRowsFormCont("allowance")}.bind(this)}):this.toggleAddRowsFormCont(n)},showMobilePopupEditor:!1,toggleAddRowsFormCont:function(n){var t=typeOf(n)==="null"?"timesheet":n,i=!1,r;if(this.options.timesheetType==="manager")if(typeOf(this.currentSearchEmployee)!=="null")if(this.currentSearchEmployee===!1)i=!0;else{if(t==="timesheet")this.addRows(new Date,new Date,this.currentSearchEmployee);else if(t==="allowance")this.addRows(new Date,new Date,this.currentSearchEmployee,!1,!0);else throw"Can not add timesheet of unknown type ("+t+")";Affinity.mobile&&(this.showMobilePopupEditor=!0);return}else i=!0;else{if(t==="timesheet")this.addRows(new Date);else if(t==="allowance")this.addRows(new Date,null,null,!1,!0);else throw"Can not add timesheet of unknown type ("+t+")";Affinity.mobile&&(this.showMobilePopupEditor=!0);return}i&&(this.addRowEmployeeSelect?this.openSelectEmployee(t):(uialert({message:"Getting Employee list",showLoader:!0,noClose:!0}),r=Affinity.zelosroot+"?api=timesheetAsManager/getEmployees",new Request.JSONP({url:r,callbackKey:"jsoncallback",method:"get",noCache:!0,onComplete:function(n){JSON.Unauthorized(n,'detailed, toggleAddRowsForm "get employees" - '+r)||(this.addRowEmployeeSelect=new Element("select",{"class":"ui-autocomplete ui-autocomplete-center ui-autocomplete-autowidth"}),Array.each(n,function(n){n.Value!==""&&n.Key!==""&&n.Key!==this.defaultEmployeeNumber?this.addRowEmployeeSelect.adopt(new Element("option",{html:n.Value,value:n.Key})):n.Value.trim()===""&&n.Key.trim()===""?this.addRowEmployeeSelect.adopt(new Element("option",{html:"Select Employee",value:""})):this.addRowEmployeeSelect.adopt(new Element("option",{html:"[No Name for "+n.Key+"]",value:n.Key}))}.bind(this)),this.openSelectEmployee(t))}.bind(this),onError:function(){},onFailure:function(){}}).send()))},showAddRowsForm:function(){},hideAddRowsForm:function(){},searchFormSatus:"closed",toggleSearchForm:function(){this.awardModal&&this.awardModal.close(),this.searchFormSatus=="open"?this.hideSearchForm():this.searchFormSatus=="closed"&&this.showSearchForm()},showSearchForm:function(n){typeOf(n)!=="null"&&n.stopPropagation(),this.searchForm&&(this.searchFormButton.dissolve(),this.searchForm.reveal(),this.searchFormSatus="open")},hideSearchForm:function(n){typeOf(n)!=="null"&&n.stopPropagation(),this.searchForm&&(this.searchFormButton.reveal(),this.searchForm.dissolve(),this.searchFormSatus="closed")},sanatiseFromToDates:function(n,t){var i,r,u;return typeOf(n)=="string"?(i=Date.parse(n),i!=null&&i||(i=!1)):i=n,typeOf(t)=="string"?(r=Date.parse(t),t!=null&&t||(t=!1)):r=t,typeOf(i)!="date"||t||(r=i.clone()),typeOf(t)!="date"||n||(i=r.clone()),i&&r&&r<i&&(u=i.clone(),i=r.clone(),r=u,delete u),{fromDate:i,toDate:r}},returnSecondaryAddButton:function(){var n=Affinity.enableFavourites;return this.options.isDual&&(n=!1),this.options.isDual&&this.options.subType==="dual-timesheets"&&(n=!0),[].contains(this.options.timesheetType)&&(n=!1),Affinity.enableFavourites||(n=!1),this.secondaryAddButton=!1,this.secondaryAddAllowanceButton=!1,this.secondaryButtonWrapper=new Element("span",{"class":"no-rows-button-wrapper"}),this.options.isAllowanceGrid?((this.isManagerView||[5111,2591].contains(parseInt(Affinity.login.profile.companyNumber)))&&(this.secondaryAddButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.addrow+"<\/span><span>Add<\/span>"}),this.secondaryAddButton.addEvent(Affinity.events.click,this.secondaryAdd)),this.options.isManager&&!Affinity.isAwardsPopupEnabled()&&(this.secondaryAddButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.addrow+"<\/span><span>Add<\/span>"}),this.secondaryAddButton.addEvent(Affinity.events.click,this.secondaryAdd))):Affinity.login.areas.Timesheet.AddUnit?(this.secondaryAddButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.addrow+"<\/span><span>Add Timesheet<\/span>"}),this.secondaryAddButton.addEvent(Affinity.events.click,this.secondaryAdd),this.secondaryAddAllowanceButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.allowance+"<\/span><span>Add Unit<\/span>"}),this.secondaryAddAllowanceButton.addEvent(Affinity.events.click,this.secondaryAddAllowance)):(this.secondaryAddButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.addrow+"<\/span><span>Add<\/span>"}),this.secondaryAddButton.addEvent(Affinity.events.click,this.secondaryAdd)),this.secondaryAddButton&&this.secondaryAddButton.inject(this.secondaryButtonWrapper),this.secondaryAddAllowanceButton&&new Element("span",{html:"&nbsp;"}).inject(this.secondaryButtonWrapper),this.secondaryAddAllowanceButton&&this.secondaryAddAllowanceButton.inject(this.secondaryButtonWrapper),n&&(new Element("span",{html:"&nbsp;"}).inject(this.secondaryButtonWrapper),this.addAllowanceFromFavButton=new Element("div",{"class":"button blue w-icon-only add-fav footer-add ui-has-tooltip","data-tooltip":this.baseAppLang.favourites.views.detailed.createFromTooltip,"data-tooltip-dir":"top,left",html:"<span>"+this.icons.fav+"<\/span><span>"+this.baseAppLang.favourites.addButtonlabel+"<\/span>"}).inject(this.secondaryButtonWrapper),this.addAllowanceFromFavButton.addEvent(Affinity.events.click,this.secondaryAddAllowance)),this.secondaryButtonWrapper},secondaryAdd:function(n){var i=n?n.target.hasClass("button")?n.target:n.target.getParent(".button"):!1,t,r;if(i&&i.hasClass("add-fav")){this.selectFav(1);return}Affinity.timesheets.init.view==="dualdetail"?(t=this.options.fromDate?this.options.fromDate:new Date,r=this.currentSearchEmployee||this.userData.employeeNumber||Affinity.login.profile.employeeNumber,this.addRows(t,t,r)):this.toggleAddRowsForm("timesheet")},secondaryAddAllowance:function(n){var i=n?n.target.hasClass("button")?n.target:n.target.getParent(".button"):!1,t,r;if(i&&i.hasClass("add-fav")){this.selectFav(2);return}Affinity.timesheets.init.view==="dualdetail"?(t=this.options.fromDate?this.options.fromDate:new Date,r=this.currentSearchEmployee||this.userData.employeeNumber||Affinity.login.profile.employeeNumber,this.addRows(t,t,r,!1,!0)):this.toggleAddRowsForm("allowance")},adding:!1,duplicateTimesheet:function(n){var i,r,t;Array.each(this.options.widgetDocument.Children[n].Children,function(n){n.Name.test("TimesheetId","gi")&&(i=n.ValueAsString),n.Name.test("EmployeeNo","gi")&&(r=n.ValueAsString),n.Name.test("TSDate","gi")&&(t=Date.parse(n.ValueAsString))}),this.addRows(t,t,r,i)},addRows:function(n,t,i,r,u,f,e,o){var y,s,l,a,p,v,c,w,h;if(!this.adding){if(this.loadRequest)try{this.loadRequest.cancel()}catch(b){}if(y=typeOf(o)==="boolean"?o:!1,s=!1,s=this.currentSearchEmployee?this.currentSearchEmployee:s?s:Affinity.login.profile.employeeNumber,s=i||s,!s||s==""){uialert({message:this.genericLang.error+"<br />You are attempting to add a new entry without a Employee Number.",showButtons:!0,noClose:!1});return}if(l=this.tbody.getElements("tr.new"),a=Affinity.mobile?5:10,l.length>=a){s=l=a=null,uialert({message:"You must save your current timesheets before you can add any new ones.",showButtons:!0,noClose:!1});return}this.adding=!0,this.doChangeChecks=!1,v=this.sanatiseFromToDates(n,t),n=v.fromDate,t=v.toDate,this.options.isDual||n.clone().clearTime().getTime()!==t.clone().clearTime().getTime()||(t=t.increment("day",1)),n&&t?(h=this.options.getEmptyTimesheetApi,h+=s?"&employeeNo="+s:"",h+=r?"&timesheetId="+r:"",h+="&FromDate="+n.toZelos()+"&ToDate="+t.toZelos(),typeOf(u)==="boolean"&&u===!0&&(h=h.replace(new RegExp("getEmptyTimesheet","gi"),"GetEmptyAllowance")),typeof f=="string"&&f!==""&&(h+="&favouriteName="+f),function(){log('&#x2794; attempting detailed addRows "get empty timesheets" ...'),this.loadRequest=new Request.JSON({url:h,method:"get",timeout:6e5,noCache:!0,onSuccess:function(n){if(!JSON.Unauthorized(n,"detailed, addRows - "+h)){if(n.error)log('&#x2718; attempted detailed addRows "get empty timesheets" succeeded with errors - '+n.error),window.uialert({message:n.error+"<br />"+h});else{log('&#x2714; attempted detailed addRows "get empty timesheets" succeeded');var t=0;this.options.widgetDocument.Children?t=this.options.widgetDocument.Children.length:this.options.widgetDocument.Children=[],this.setTableClass(),Array.each(n,function(n,t){for(t=n.Children.length-1;t>-1;t--){if(n.Children[t].Name.test("TsDate","gi")&&!n.Children[t].Attribute.IsReadOnly&&(n.Children[t].ElementType="FieldEdit",typeOf(e)==="null"))break;typeOf(e)!=="null"&&(n.Children[t].Name.test("TsUnit","gi")||n.Children[t].Name.test("TsNet","gi"))&&(n.Children[t].Value=parseFloat(e),n.Children[t].ValueAsString=e+"")}this.options.widgetDocument.Children.push(n),c=this.returnNewRow(n,!0),c&&c.inject(this.tbody)}.bind(this)),p=c?this.processUI(!0,c):this.processUI(!0),Affinity.prompts.hide()}this.adding=!1,c&&y&&Array.each(c.getElements("td.buttons span.timesheet-button"),function(n){n&&n.get("data-type")&&n.get("data-type").toLowerCase().trim()==="submit"&&this.checkNoRows()&&this.buttonClicked({target:n})}.bind(this))}}.bind(this),onError:function(n,t){log('&#x2718; attempted detailed addRows "get empty timesheets" failed with errors - '+t),window.uialert({message:t}),this.adding=!1}.bind(this),onFailure:function(n){log('&#x2718; attempted detailed addRows "get empty timesheets" failed - '+n.statusText),window.uialert({message:n.statusText}),this.adding=!1}.bind(this)}).get()}.delay(500,this)):(window.uialert({message:"From and To dates are invalid"}),this.adding=!1),v=s=c=w=l=a=null}},getSubstitutedName:function(n,t){var i=n.match(/-Row[0-9A-Za-z-]+[A-Z]-/)[0],r=i.substring(i.length-2),u="-Row"+i.substring(4,i.length-2)+r,f="-Row"+t+r;return n.replace(u,f)},awardModal:!1,showAwards:function(n){var i,t,f;if(!Affinity.isAwardsPopupEnabled())return!1;if(isNaN(n))if("target"in n)if(n.target.getParent("tr"))i=this.tableRows.indexOf(n.target.getParent("tr"));else return;else return;else i=n;var r=this.tableRows[i],u=[],e=r.querySelectorAll(".message-icon.info");e.length>0&&e.forEach(function(n){n.dataset.tooltip&&n.dataset.tooltip!==""&&(n.dataset.tooltip.contains(",")?n.dataset.tooltip.split(",").forEach(function(n){u.push(n)}):u.push(n.dataset.tooltip))}),t=r.getBoundingClientRect(),f={row:r,iconData:u,returnRowMethod:this.returnNewRow.bind(this),startPosition:{x:t.left+15,y:t.top+t.height-5}},this.awardModal?this.awardModal.set(f):this.awardModal=new ZelosAwardModal(f)},buttonClicked:function(n){var u,c,w,b,l,a,e,s,i,h,o;Affinity.tooltips.hideAll();var t=n.target.hasClass("button")?n.target:n.target.getParent(".button"),v=n.target.classList.contains("message-icon")?n.target:n.target.getParent(".message-icon"),y=t?t.retrieve("cfbutton")?t.retrieve("cfbutton"):t:!1;if(t=t?t:v?v:!1,!t)return!1;var f=t.getParent(".button-container")?document.id(t.getParent(".button-container").get("data-menu-id")):!1,r=t.getParent("tr")?t.getParent("tr"):t.get("data-row-ref")?this.table.getElement("tr#"+t.get("data-row-ref")):!1,u=r?this.tableRows.indexOf(r):!1;if(u===!1||u<0){uialert({message:"Could not identify Timesheet. Please refresh and try again.",showButtons:!0});return}if(u=r?this.tableRows.indexOf(r):!1,document.getElement(".button-menu-closer")&&document.getElement(".button-menu-closer").addClass("hidden"),f&&Array.each(this.table.getParent().getElements(".button-menu-container"),function(n){n!==f&&n.dissolve()}),t.hasClass("button-menu-button")){if(f)if(f.getStyle("display")==="block")f.dissolve();else{var p=t.getPosition(t.getParent(".section")),k=t.getParent(".section").getSize(),d=t.getSize();f.setStyles({top:p.y-5,right:k.x-p.x-d.x-2}),f.reveal(),document.getElement(".button-menu-closer").removeClass("hidden")}return}t.getParent(".button-menu-container")&&t.getParent(".button-menu-container").dissolve();try{n.preventDefault(),n.stopPropagation()}catch(g){}if(t.get("data-type")==="FormEdit")this.popupEditForm({target:t.getParent("tr")});else if(t.get("data-type")==="Delete"){if(r.hasClass("new")){this.destroyRow(r);return}Array.each(r.getElements("input,select,textarea"),function(n){n.hasClass("validate")&&n.get("data-validate-method")&&n.get("data-validate-method").contains("hasvalue")&&(c=n.get("data-validate-method").split(","),n.value=c.contains("float")||c.contains("int")||c.contains("number")?0:"empty")}),this.rowValidationPassed(y,r,u,n)}else t.get("data-type")==="Duplicate"?(Array.each(this.options.widgetDocument.Children[u].Children,function(n){n.Name.test("TimesheetId","gi")&&(w=n.ValueAsString),n.Name.test("EmployeeNo","gi")&&(b=n.ValueAsString),n.Name.test("TSDate","gi")&&(l=Date.parse(n.ValueAsString))}),this.addRows(l,l,b,w)):t.get("data-type")==="Favourite"?(a=!1,r&&u!==!1&&(e=this.options.widgetDocument.Children[u],e.hasOwnProperty("Data")&&e.Data.hasOwnProperty("FavouriteName")&&(a=e.Data.FavouriteName.trim()!==""?e.Data.FavouriteName.trim():!1),this.promptFavName(t,e,a))):t.get("data-type")==="Awards"?this.showAwards(u):t.get("data-type")==="Obscured"?(h=r.getElement(t.get("data-col-ref")),s=h.getElement(".subhidden")?h.getElement(".subhidden").getElement("input,textarea,select"):h.getElement("input,textarea,select"),i=s.clone(),i.value=s.value,uialert({message:"Set "+t.get("data-display")+"<br /><br />",showButtons:!0,showCancel:!0,onClose:function(){i.retrieve("widget")&&"destroy"in i.retrieve("widget")&&(i.retrieve("widget").destroy(),i.removeEvent("change"))}}),Affinity.prompts.adopt(i),i.get("tag")==="select"?(i.set("class",""),new UIAutoCompleteWidget({stopInitialChange:!0,selectElement:i})):new Affinity.FormElement(i),i.addEvent("change",function(){s.value=i.value,s.fireEvent("change"),this.hasRowChanged(h)}.bind(this))):(o=new UIFormValidation({target:r,onValidateCallback:function(){this.rowValidationPassed(y,r,u,n),o.destroy(),delete o}.bind(this),onValidateFailCallback:function(){o.destroy(),delete o}.bind(this)}),o.validate())},promptFavName:function(n,t,i,r,u){var f=i?this.baseAppLang.favourites.renameMessage:this.baseAppLang.favourites.views.detailed.createMessage;typeOf(r)==="string"&&(r=r.trim().length===0?this.genericLang.error:r,f=r+"<br />Please try again."),uiprompt({message:f,showButtons:!0,value:typeOf(u)==="string"?u:i?i:"",onOk:function(r){var u=this.baseLang.favourites.validation.validateName(r);if(!u.isValid){this.promptFavName.delay(50,this,[n,t,i,u.error,r]);return}this.saveFav(n,r,i?i:!1)}.bind(this)})},returnFavHash:function(n){var t=[];return Object.each(JSON.decode(n.Fields),function(n,i){t.push(i+":"+n)}),t.push("Type:"+n.Type),t.push("EmployeeNo:"+n.EmployeeNo),t.push("Name:"+n.Name),t.sort(),t=t.join(",")},selectFav:function(){var n;uiloader({message:this.baseAppLang.favourites.loadingMessage,type:this.viewName}),n=Affinity.zelosroot+"?api=Favourite/GetFavouriteNamesExt&EmployeeNo="+Affinity.login.profile.employeeNumber,this.isManagerView&&(n=Affinity.zelosroot+"?api=Favourite/GetFavouriteNamesExt"),new Request.JSON({url:n,onSuccess:function(n){var r,t,i;if("error"in n&&n.error!==!1||typeOf(n)!=="array"){uialert({message:this.baseAppLang.favourites.loadError,showButtons:!0,type:this.viewName});return}if(n.length===0){uialert({message:this.baseAppLang.favourites.loadNoneError,showButtons:!0,type:this.viewName});return}r=this.isManagerView?Affinity.FavResultSort(n,"Name","EmployeeName"):Affinity.FavResultSort(n,"Name"),t=[],this.favouriteData=[],Array.each(r,function(n){i=this.returnFavHash(n),t.indexOf(i)===-1&&(this.favouriteData.push(n),t.push(i))}.bind(this)),this.showFavSelect(this.favouriteData)}.bind(this)}).get()},showFavSelect:function(n,t){var h=t||"",o=this.baseAppLang.favourites.selectLabel,i,u,r,s,f,e;h!==""&&(o=t+"<br />"+this.baseAppLang.favourites.selectLabel),i=new Element("select"),new Element("option",{html:this.baseAppLang.favourites.selectLabel,value:""}).inject(i),Array.each(n,function(n){r=!1,(n.Type===1||n.Type===2)&&(this.options.isDual?(s=this.isManagerView?this.userData.employeeNumber:Affinity.login.profile.employeeNumber,parseInt(n.EmployeeNo)===parseInt(s)&&(r=!0,f=!1)):(r=!0,this.isManagerView&&(f=!0))),r&&(e=n.Name,f&&(e=parseInt(n.EmployeeNo)===parseInt(Affinity.login.profile.employeeNumber)?"Me : "+n.Name:n.EmployeeName+" : "+n.Name),new Element("option",{html:e,value:'{"name":"'+n.Name+'","emp":"'+n.EmployeeNo+'","type":"'+n.Type+'"}'}).inject(i))}.bind(this)),i.addClass("hidden"),uialert({message:o,showButtons:!0,showCancel:!0,type:this.viewName+"FavSelect",onOk:function(){var t=new Date,n;if(this.options.isDual&&(t=this.loadTimesheetsFrom),i.value!==""){n=JSON.decode(i.value);switch(n.type){case"4":uialert({message:"This view does not support Mileage"});break;case"3":uialert({message:"This view does not support Leave"});break;case"2":this.addRows(t.clone(),t.clone(),n.emp,!1,!0,n.name);break;case"1":default:this.addRows(t.clone(),t.clone(),n.emp,!1,!1,n.name)}}}.bind(this)}),Affinity.prompts.adopt(new Element("br"),new Element("br"),i,new Element("br")),function(){i.removeClass("hidden"),u=new UIAutoCompleteWidget({stopInitialChange:!1,selectElement:i,onComplete:function(){prompts.center()}}),window.onPromptClose=function(){i&&u&&u.destroy()}.bind(this)}.delay(250,this)},saveFav:function(n,t,i){var h=n.get("data-row-ref"),o=this.table.getElement("#"+h),u=this.tableRows.indexOf(o),c=this.options.widgetDocument.Children[u],r=JSON.parse(JSON.stringify(c)+""),f=Affinity.login.profile.employeeNumber,e=1,s,l;r.Data.IsFavourite=!0,r.Data.FavouriteName=t,Array.each(r.Children,function(n,t){i&&new RegExp("TimesheetType","gi").test(n.Name)&&(e=n.hasOwnProperty("Value")?parseInt(n.Value):e),i&&new RegExp("EmployeeNo","gi").test(n.Name)&&(f=n.hasOwnProperty("Value")?n.Value:f),!i&&new RegExp("RowButton","gi").test(n.Name)&&Array.each(n.Children,function(n,i){r.Children[t].Children[i].Value.Pressed=!1,new RegExp("Favourite","gi").test(n.Name)&&(r.Children[t].Children[i].Value.Pressed=!0),r.Children[t].Children[i].ValueAsString=JSON.stringify(r.Children[t].Children[i].Value)}.bind(this))}.bind(this)),i?(s=Affinity.zelosroot+"?api=Favourite/RenameFavourite?OldName="+i+"&NewName="+t+"&timesheetType="+e+"&employeeNo="+f,uiloader({message:this.baseAppLang.favourites.renamingMessage,type:this.viewName+"FavRenaming"}),l=new Request.JSON({url:s,onComplete:function(n){if(n.hasOwnProperty("success")&&n.success===!1&&n.hasOwnProperty("error")&&typeOf(n.error)==="string"){var t=n.error.trim()!==""?n.error.trim():this.genericLang.error,t=Affinity.CheckFavError(n,t);uialert({message:this.genericLang.errorPrefix+" "+t+"<br />"+this.genericLang.tryAgain,showButtons:!0,type:this.viewName+"FavRenaming"});return}setTimeout(function(){uialert({message:this.globalLang.waitForNameChange+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),setTimeout(function(){this.refresh()}.bind(this),3e3)}.bind(this),3e3)}.bind(this),onFailure:function(){uialert({message:this.genericLang.error+"<br />"+this.genericLang.tryAgain,showButtons:!0,type:this.viewName+"FavRenaming"})}.bind(this),onError:function(n){var t=Affinity.CheckFavError(n,this.genericLang.error+"<br />"+this.genericLang.tryAgain);uialert({message:t,showButtons:!0,type:this.viewName+"FavRenaming"})}.bind(this)}).post()):(this.options.widgetDocument.Children[u]=r,this.postDocumentRow({rowIndex:u,row:o,messagea:"saving "+this.baseLang.favourites.name,messageb:"saved "+this.baseLang.favourites.name,isfave:!0}))},sanatisePostDocument:function(n){return Affinity.timesheets.methods.sanatisePostDocument(n)},promptVisible:!1,postDocumentRow:function(n){var h=!1,f,c,e,o,t,i,r=!1,s=!1,l=!0;if(n!==null&&n!==undefined&&n.hasOwnProperty("isfave")&&typeof n.isfave=="boolean"&&n.isfave===!0&&(l=!1),n.hasOwnProperty("rowIndex"))e=n.row,o=n.rowIndex,t=n.messagea||"saving",i=n.messageb||"saved",r="timesheet",s="Timesheet";else if(f=n.target.hasClass("button")?n.target:n.target.getParent(".button"),c=f.retrieve("cfbutton")?f.retrieve("cfbutton"):f,e=c.getParent("tr"),o=this.tbody.getElements("tr.timesheet-row").indexOf(e),t="saving",i="saved",r="timesheet",s="Timesheet",n!==null)switch(f.get("data-type")){case"Submit":t="submitting",i="submitted";break;case"Accept":t="approving",i="approved";break;case"Decline":t="declining",i="declined";break;case"Delete":h=!0,t="deleting",i="deleted";break;default:t="saving",i="saved"}!r&&t.contains(this.baseLang.favourites.name)&&(t=t.replace(this.baseLang.favourites.name,"").trim(),i=i.replace(this.baseLang.favourites.name,"").trim(),r=this.baseLang.favourites.name,s=this.baseLang.favourites.title),this.errormsg='Timesheet(s) processed with errors.<span class="hidden"> while '+i+"<\/span><br />",this.promptVisible=!0,uiloader({message:t.capitalize(),type:this.viewName});var v=this.options.widgetDocument.Children[o],u=Object.clone(this.options.parentDocument),a=Object.clone(this.options.widgetDocument);a.Children=[v],u.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex]=a,u=this.sanatisePostDocument(u),l&&(u.Children[0].Children[0]=this.cleanFavData(null,u.Children[0].Children[0])),log("&#x2794; attempting detailed postDocumentRow ..."),new Request.JSON({url:this.options.putApi,timeout:9e5,onSuccess:function(n){var u,o,c;if(!JSON.Unauthorized(n,"detailed, postDocumentRow - "+this.options.putApi))if(u=this.processErrors(n),u.length===0){log("&#x2714; attempted detailed postDocumentRow succeeded");var t="Children"in n?n.Children[0].Children[0].Children[0]:!1,s=!0,f="";!t||"Children"in t||"Message"in t.Attribute&&t.Attribute.Message.trim()!==""&&(this.destroyRow(e),f=this.genericLang.successPrefix+" Your "+r+" has been "+i+".<br /><br />"+t.Attribute.Message.trim(),window.uialert({message:f,noClose:!1,showButtons:!0,type:this.viewName}),s=!1),this.promptVisible&&s&&(f=this.genericLang.successPrefix+" Your "+r+" has been "+i+".",uialert({message:f,noClose:!0,showButtons:!0,type:this.viewName}),function(){Affinity.prompts.hide()}.delay(1500,this),this.promptVisible=!1),o=this.tableRows.indexOf(e),h?(this.delWidgetDocumentRow(o),this.options.widgetDocument.Layout.DataTotal--,this.totalTimesheets=this.options.widgetDocument.Layout.DataTotal):(c=n.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex].Children[0],this.putWidgetDocumentRow(o,c,u)),this.fireEvent("processComplete"),this.processUI()}else log("&#x2718; attempted detailed postDocumentRow succeeded with errors - "+u.join(", "))}.bind(this),onError:function(n,i){if(typeOf(i)==="object")if("message"in i)i=i.message;else{var u=i.toString();if(u.contains("401")&&Affinity&&Affinity.login&&Affinity.login.session){log("&#x270B; attempted detailed postDocumentRow unauthorized &#x270B;"),window.fireEvent("unauthorized");return}i=="unknown"}typeOf(i)==="string"&&i.contains("401")?(log("&#x270B; attempted detailed postDocumentRow unauthorized &#x270B;"),Affinity&&Affinity.login&&Affinity.login.session?window.fireEvent("unauthorized"):uialert({message:this.genericLang.errorPrefix+" We had trouble "+t.toLowerCase()+" your "+r+".<br />You have been logged out by another system. Please try logging in again.",showButtons:!0,type:this.viewName})):(log("&#x2718; attempted detailed postDocumentRow failed with errors - "+i),uialert({message:this.genericLang.errorPrefix+" We had trouble "+t.toLowerCase()+" your "+r+".<br />"+i,showButtons:!0,type:this.viewName}))}.bind(this),onFailure:function(n,i){var u=n.response?n.response:n.responseText?n.responseText:i;u&&u.contains("401")?(log("&#x270B; attempted detailed postDocumentRow unauthorized &#x270B;"),Affinity&&Affinity.login&&Affinity.login.session?window.fireEvent("unauthorized"):uialert({message:this.genericLang.errorPrefix+" We had trouble "+t.toLowerCase()+" your "+r+".<br />"+n.statusText,showButtons:!0,type:this.viewName})):(log("&#x2718; attempted detailed postDocumentRow failed - "+i),uialert({message:this.genericLang.errorPrefix+" We had trouble "+t.toLowerCase()+" your "+r+".<br />"+n.statusText,showButtons:!0,type:this.viewName}))}.bind(this),onException:function(n,t){log("&#x2718; attempted detailed postDocumentRow failed with exception - "+n+": "+t),uialert({message:this.genericLang.error+"<br />There was a problem with the header "+n+": "+t,showButtons:!0,type:this.viewName})}.bind(this),onTimeout:function(){log("&#x2718; attempted detailed postDocumentRow timed out"),uialert({message:this.genericLang.errorPrefix+" We reached the timeout limit!<br />Please check your connection and try again.",showButtons:!0,type:this.viewName})}}).post("="+escape(JSON.stringify(u)))},rowValidationPassed:function(n,t,i,r){var e,u,o,f;this.updateWidgetDocument(),e=[],Array.each(this.options.widgetDocument.Children,function(n){n.Data.RowType||e.push(n)}),u=Object.clone(e[i]),delete e,o=n.get("id"),f=u.Children.length-1,Array.each(u.Children[f].Children,function(n,t){u.Children[f].Children[t].Value.Pressed=n.Name===o?!0:!1,u.Children[f].Children[t].ValueAsString=JSON.stringify(u.Children[f].Children[t].Value)}),this.options.widgetDocument.Children[i]=u,delete u,delete o,delete f,this.postDocumentRow(r)},processErrors:function(n,t){var i=[],u=0,r;if(n.error?i.push(n.error):Array.each(n.Children,function(n){Array.each(n.Children,function(n){n.ElementType=="TimesheetTable"&&Array.each(n.Children,function(n){n.Data&&n.Data.RowType||(n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&i.push("Row "+(u+1)+" has an error : "+n.Attribute.ErrorMessage),Array.each(n.Children,function(n,t){n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&i.push("Row "+(u+1)+" column "+(t+1)+" has an error : "+n.Attribute.ErrorMessage)}.bind(this)),u++)}.bind(this))}.bind(this))}.bind(this)),typeof t!="undefined"&&t===!0){this.refresh(null,i);return}return this.promptVisible&&i.length>0&&(r=this.errormsg+i.join("<br />"),i.length==1&&(r=r.replace("Row 1","A row")),uialert({message:this.genericLang.error+"<br />"+r,showButtons:!0,type:this.viewName}),this.promptVisible=!1),i},checkSelected:function(){var n=!1,t=!0;return Array.each(this.tbody.getElements(".check input"),function(i){i.checked?n=!0:t=!1}.bind(this)),{anyChecked:n,allChecked:t}},rendered:!1,renderCheckTimer:!1,renderCheck:function(){var t,n,i,u,r,f,e;clearTimeout(this.renderCheckTimer),this.options.target.getElement("table.timesheet")&&(this.rendered=!0),this.rendered?(t=this.options.target.getParent("form"),n=t&&typeOf(t)!=="null"?t.getElement("select#ForwardTo"):!1,n&&typeOf(n)!=="null"&&(i=this.isManagerView,Affinity.login.profile&&Affinity.login.hasOwnProperty("profile")&&Affinity.login.profile.hasOwnProperty("admin")&&Affinity.login.profile.admin&&(i=!0),Affinity.login.currentProfile&&Affinity.login.hasOwnProperty("currentProfile")&&Affinity.login.currentProfile.hasOwnProperty("admin")&&Affinity.login.currentProfile.admin&&(i=!0),i?(u=n&&typeOf(n)!=="null"?!n.hasClass("widget"):!1,n&&n.getParent(".form-row")&&(n.getParent(".form-row").addClass("inline"),n.getParent(".form-row").getParent().getElement(".form-row.buttons")&&n.getParent(".form-row").getParent().getElement(".form-row.buttons").addClass("inline")),u&&(n.getElement("option")&&n.getElement("option").get("html")!==""&&new Element("option",{selected:"selected"}).inject(n,"top"),this.frowardWidget=new UIAutoCompleteWidget({selectElement:n}))):n&&n.getParent(".form-row").addClass("hidden")),r=t?t.getElements(".form-row.buttons"):!1,Affinity.mobile&&r&&r.length>0&&!r.getLast().getElement(".mobile-select-message")&&(f=t.getElements(".form-row.buttons").getLast(),e=f.getElement(".button-wrapper"),new Element("div",{"class":"mobile-select-message",html:"Swipe row right to select, swipe row left to deselect"}).inject(e,"before"))):this.renderCheckTimer=this.renderCheck.delay(50,this)},checkNoRows:function(){return(this.tableRows=this.tbody&&this.tbody.getElements("tr.timesheet-row")&&this.tbody.getElements("tr.timesheet-row").length>0?this.tbody.getElements("tr.timesheet-row"):[],this.tableRows.length>0?(this.setHasRows(),this.thead.getElements("th").length===0&&this.buildTableHeader(),this.tfoot.getElements("th").length===0&&this.buildTableFooter()):(this.setNoRows(),this.secondaryAddButton||this.returnSecondaryAddButton(),this.secondaryButtonWrapper.inject(this.norows)),this.tableRows.length>0)?!0:!1},processUIThrottle:!1,processUI:function(n,t){clearTimeout(this.processUIThrottle),this.processUIThrottle=this.continueProcessUI.delay(100,this[(n,t)])},continueProcessUI:function(n,t){var f=n?!1:!0,i=t||!1,u,r;return this.debug&&(console.log("%cProcess UI","background: #9d9dfd; color: white"),console.time("Process UI")),this.checkNoRows(),f&&(this.buildTableHeader(),this.buildTableFooter(),this.renderPagination()),i?i.hasClass("new")||i.hasClass("modified")?this.setUnload():this.delUnload():this.tbody.getElements("tr.new").length>0||this.tbody.getElements("tr.modified").length>0?this.setUnload():this.delUnload(),this.setTableClass(),Affinity.uiGrid&&Affinity.uiGrid.zebra(this.table,"timesheet-row"),this.readonly&&document.uiSortableGrid&&document.uiSortableGrid.processTable(this.table,"timesheet-row"),u=i?i.getElements(".has-dependencies"):this.table.getElements(".has-dependencies"),Array.each(u,function(n){if(r=n.retrieve("dependencies"),r&&"setEvents"in r)"eventsset"in r&&!r.eventsset&&r.setEvents();else try{var i=n.getParent("tr"),t="";t+="!!!\tDependency issue found\r\n",t+="\tDependency not established when processing UI (Could not find widget on element)\r\n",t+="\tTime:\t"+(new Date).toTime()+"\r\n",t+="\tElement ID:\t"+n.get("id")+"\r\n",t+="\tElement Class:\t"+n.get("class")+"\r\n",t+="\tRow ID:\t"+i.get("id")+"\r\n",t+="\tRow Class:\t"+i.get("class")+"\r\n",t+="!!!",log(t)}catch(u){}}.bind(this)),Affinity.tooltips&&Affinity.tooltips.processNew(),Affinity.lookups&&Affinity.lookups.processNew({jsonp:!0}),Affinity.displaylookups&&Affinity.displaylookups.processNew({jsonp:!0}),Affinity.uiDrawPanels&&Affinity.uiDrawPanels.processNew(),Affinity.uiDateCalendar&&(u=i?i.getElements(".input.uidate-calendar"):this.table.getElements(".input.uidate-calendar"),Array.each(u,function(n){new UIDateTimeWidget({target:n,showTime:!0})}.bind(this)),i?i.getElements(".ui-calendar-button.blue").addClass("hide1024 hide1350 hide1620"):this.table.getElements(".ui-calendar-button.blue").addClass("hide1024 hide1350 hide1620")),this.doChangeChecks=!0,clearTimeout(this.renderCheckTimer),this.renderCheckTimer=this.renderCheck.delay(50,this),this.debug&&(console.timeEnd("Process UI"),console.log("%c\tUI Processed","background: #9d9dfd; color: white;")),this.showMobilePopupEditor&&(this.popupEditForm({target:this.tableRows.getLast()}),this.showMobilePopupEditor=!1),this.forceCheckNewRows(),!0},forceCheckNewRows:function(){document.querySelectorAll("tr.timesheet-row.new .active.check input").forEach(function(n){n.checked=!0})},newRowsLoader:null,loadNewRows:function(n,t,i){if(this.doChangeChecks=!1,this.newRowsLoader)try{this.newRowsLoader.cancel()}catch(r){}this.getApi=n,log("&#x2794; attempting detailed loadNewRows ..."),this.newRowsLoader=new ZelosTemplateLoad({noCache:!0,onRequest:function(){if(this.showAlerts){var n=t.length>15?t:t+"ing";uiloader({message:n,type:this.viewName}),t="Search"}}.bind(this),onError:function(n){log("&#x2718; attempted detailed loadNewRows failed with errors - "+n),this.showAlerts&&uialert({message:t+" "+this.genericLang.failed+"<br />"+n,type:this.viewName}),this.newRowsLoader=!1,this.refreshing=!1}.bind(this),onFailure:function(n){log("&#x2718; attempted detailed loadNewRows failed - "+n.statusText),this.showAlerts&&uialert({message:t+" "+this.genericLang.failed,type:this.viewName}),this.newRowsLoader=!1,this.refreshing=!1}.bind(this),onComplete:function(t){var r,u;if(!JSON.Unauthorized(t,"detailed, loadNewRows - "+n)){if(log("&#x2714; attempted detailed loadNewRows succeeded"),this.debug&&(console.log("%cAdd New Rows","background: #44b5ec; color: white"),console.time("Add New Rows")),this.destroyRows()){if(this.putWidgetDocument(t.Children[0].Children[0]),typeOf(this.options.widgetDocument.Children)=="array"&&this.options.widgetDocument.Children.length>0&&Array.each(this.options.widgetDocument.Children,function(n){u=this.returnNewRow(n),u&&u.inject(this.tbody)}.bind(this)),this.checkColumnMisssAligned()){this.refreshing=!1,this.refresh();return}this.filterFromRefresh||this.hideSearchForm(),this.filterFromRefresh=!1,this.processUI(),this.showAlerts&&(r=function(){var n=!1;Affinity.prompts.currentObj!==undefined&&Affinity.prompts.currentObj.isCloseOnClick!==undefined&&(n=Affinity.prompts.currentObj.isCloseOnClick),n===!1&&Affinity.prompts.hide()}.delay(2e3,this)),this.newRowsLoader=!1,typeOf(i)!=="null"&&i.length>0&&this.showAlerts&&(clearTimeout(r),i.length==1?uialert({message:this.genericLang.error+"<br />"+i.join("<br />").replace("Row 1","A row"),showButtons:!0,type:this.viewName}):uialert({message:this.genericLang.error+"<br />"+i.join("<br />"),showButtons:!0,type:this.viewName}))}this.debug&&(console.timeEnd("Add New Rows"),console.log("%c\tNew Rows Added","background: #44b5ec; color: white;")),this.messageBucket.length>0&&(clearTimeout(r),window.uialert({message:this.messageBucket.join("<br />"),showButtons:!0,type:this.viewName}),this.messageBucket=[]),this.addGlobalElementChangeEvent(),this.refreshing=!1,this.fireEvent("newRowsLoaded")}}.bind(this)}),this.removeGlobalElementChangeEvent(),this.newRowsLoader.loadTemplate(n)},adjustFilterDates:function(n){if(n){var u,t=!1,i=!1,r=n.target.hasClass("button")?n.target:n.target.getParent("button");if(r){u=r.hasClass("filter-last-period")?"last":r.hasClass("filter-current-period")?"current":r.hasClass("filter-next-period")?"next":"unknown";switch(u){case"last":if(Affinity.login.profile.payPeriods.periodCurrentIndex<=0){uialert({message:this.globalLang.noUserPastPeriods,showButtons:!0,showLoader:!1,noClose:!1});return}t=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex-1].from,i=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex-1].to;break;case"current":t=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex].from,i=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex].to;break;case"next":if(Affinity.login.profile.payPeriods.periodCurrentIndex===Affinity.login.profile.payPeriods.periods.length){uialert({message:this.globalLang.noUserFuturePeriods,showButtons:!0,showLoader:!1,noClose:!1});return}t=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex+1].from,i=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex+1].to}t&&i&&(this.searchFrom.setDate(t),this.searchTo.setDate(i))}}},filterQueryObject:!1,filterDelay:!1,doSearch:function(n,t){var i=typeOf(t)==="boolean"?t:!1;i||uiloader({message:typeOf(n)==="string"&&n!==""?n:"Searching",type:this.viewName+"Search"}),clearTimeout(this.filterDelay),this.filterDelay=function(){var r=[],a=this.searchFrom.getRawDate(),v=this.searchTo.getRawDate(),e=this.sanatiseFromToDates(a,v),y=this.getApi,s=new URI(y),t=s.parsed.query.parseQueryString(),f,u,l;e.fromDate&&(t.fromDate=Date.parse(e.fromDate).format("%d.%b.%Y"),r.push("Date From "+Date.parse(e.fromDate).format("%d/%m/%Y"))),e.toDate&&(t.toDate=Date.parse(e.toDate).format("%d.%b.%Y"),r.push("Date To "+Date.parse(e.toDate).format("%d/%m/%Y"))),this.currentSearchEmployee=!1,this.searchEmployee&&(t.employeeNo=this.searchEmployee.value,this.searchEmployee.value!==""&&(this.currentSearchEmployee=this.searchEmployee.value,r.push("Employee "+this.searchEmployee.value))),this.searchPayPoint&&(t.PayPoint=this.searchPayPoint.value,this.currentSearchPayPoint=this.searchPayPoint.value,this.searchPayPoint.value!==""&&r.push("Pay Point "+this.searchPayPoint.value)),this.searchEmployeeGroups&&(t.TimesheetRole=this.searchEmployeeGroups.value,this.currentSearchEmployeeGroup=this.searchEmployeeGroups.value,this.searchEmployeeGroups.value!==""&&r.push("Group "+this.searchEmployeeGroups.value));var o=!1,h=!1,c=[];this.searchScreenFilters&&this.searchScreenFilters.length>0&&(Array.each(this.searchScreenFilters,function(n){n.get("data-field-name")==="MethodFilter"?(o=n.value,h=n.options[n.selectedIndex].text):n.value!==""?(t[n.get("data-field-name")]=n.value,c.push(n.get("data-label")+" is '"+n.value+"'")):delete t[n.get("data-field-name")]}.bind(this)),c.length>0&&r.push("Where "+c.join(" & "))),this.searchStatus&&(f=[],t.timesheetStatus="",Array.each(this.supportedStatus,function(n){this.searchStatus.getElement(".searchStatusCheck-d-"+n)&&!this.searchStatus.getElement(".searchStatusCheck-d-"+n).disabled&&this.searchStatus.getElement(".searchStatusCheck-d-"+n).checked&&f.push(n)}.bind(this)),t.timesheetStatus=f.join(","),this.currentSearchStatus=f.join(","),f.length>0&&r.push("Status "+f.join(" and ")),delete f),u=!1,this.immutibleFilter&&this.immutibleFilter.getElement(".searchExcludeLockedCheck-d").checked&&(u="dont_return_locked",r.push("Excluding Locked")),this.managedFilter&&this.managedFilter.getElement(".searchMangedOnlyCheck-d").checked&&(u?u+=",dont_return_managed":u="dont_return_managed",r.push("My timesheets to approve only")),this.managedFilter&&o&&(u?u+=",MethodFilter"+o:u="MethodFilter"+o,r.push(h.charAt(0).toUpperCase()+h.slice(1))),u===!1?(t.DefaultRosterGroup=null,delete t.DefaultRosterGroup):t.DefaultRosterGroup=u,this.filterQueryObject=t,t.page=0,s.parsed.query=Object.toQueryString(t),url=s.toString(),l=this.FilterStringTemplate.format({filters:r.join(", ")}),this.filterStrBox.set("html",l),i||this.loadNewRows(url,typeOf(n)==="string"&&n!==""?n:"Search")}.delay(500,this)},renderPagination:function(){var i,t,n;if(this.options.paginate){for(t=this.options.widgetDocument.Layout,this.pageSize=t.PageSize,this.totalPages=t.PageTotal,this.currentPage=t.PageNumber,this.totalTimesheets=t.DataTotal,this.timsheetRowfrom=this.currentPage*this.pageSize+1,this.timesheetRowTo=this.currentPage*this.pageSize+this.pageSize,this.timesheetRowTo>this.totalTimesheets&&(this.timesheetRowTo=this.totalTimesheets),this.paginationContainer.empty(),new Element("span",{html:"previous","class":this.currentPage==0?"disabled":""}).inject(this.paginationContainer).addEvent(Affinity.events.click,this.getPreviousPage),n=0;n<this.totalPages;n++)i=n==this.currentPage?"page selected":"page",i+=" page"+n,new Element("span",{html:n+1,"class":i,"data-page":n}).inject(this.paginationContainer).addEvent(Affinity.events.click,this.getPage);new Element("span",{html:"next","class":this.currentPage+1>=this.totalPages||this.totalPages==0?"disabled":""}).inject(this.paginationContainer).addEvent(Affinity.events.click,this.getNextPage),new Element("br").inject(this.paginationContainer),new Element("span",{html:"Showing Timesheet(s) "+this.timsheetRowfrom+" to "+this.timesheetRowTo+" of "+this.totalTimesheets,"class":"disabled","class":"desc"}).inject(this.paginationContainer),this.totalTimesheets===0?this.paginationContainer.addClass("hidden"):this.paginationContainer.removeClass("hidden")}},getNextPage:function(n){n.target.hasClass("disabled")||this.currentPage<this.totalPages&&this.paginationContainer.getElement(".page"+(this.currentPage+1))&&this.getPage({target:this.paginationContainer.getElement(".page"+(this.currentPage+1))})},getPreviousPage:function(n){n.target.hasClass("disabled")||this.currentPage>0&&this.paginationContainer.getElement(".page"+(this.currentPage-1))&&this.getPage({target:this.paginationContainer.getElement(".page"+(this.currentPage-1))})},getPage:function(n){var r=n.target.hasClass("page")?n.target:n.target.getParent(".page"),i=new URI(this.getApi),t=typeOf(i.parsed.query)==="null"?{}:i.parsed.query.parseQueryString();t.fromDate=this.loadTimesheetsFrom.format("%d.%b.%Y"),t.toDate=this.loadTimesheetsTo.format("%d.%b.%Y"),this.filterQueryObject&&Object.merge(t,this.filterQueryObject),t.page=parseInt(r.get("data-page")),t.view="detail",this.options.isDual&&(t.view="daydetail"),t.ran=String.uniqueID(),i.parsed.query=Object.toQueryString(t),this.currentPage=t.page+0,this.loadNewRows(i.toString(),"Load")},subMenuOpen:!1,subMenuOpenDelay:!1,subMenuCloseDelay:!1,subMenuOver:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay),n.delay=0,this.showButtons(n)},subMenuOut:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay),n.delay=0,this.hideButtons(n)},showButtons:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay);var t=250;n.hasOwnProperty("delay")&&(t=n.delay),this.subMenuOpenDelay=setTimeout(function(){var t=n.target.hasClass("button")?n.target:n.target.getParent(".button"),i,r,u,f;t&&(this.subMenuOpen=!0,i=t.getParent(".button-container")?document.id(t.getParent(".button-container").get("data-menu-id")):!1,r=t.getPosition(t.getParent(".section")),u=t.getParent(".section").getSize(),f=t.getSize(),document.querySelectorAll(".button-menu-container").forEach(function(n){n!==i&&n.dissolve()}.bind(this)),i.setStyles({top:r.y-5,right:u.x-r.x-f.x-2}),i.reveal(),document.getElement(".button-menu-closer").removeClass("hidden"))}.bind(this),t)},hideButtons:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay);var t=250;n.hasOwnProperty("delay")&&(t=n.delay),this.subMenuOpenDelay=setTimeout(function(){this.subMenuOpen=!1,document.getElements(".button-menu-container").dissolve(),document.getElement(".button-menu-closer").addClass("hidden")}.bind(this),t)},simplifyButton:function(n){n.getElement(".button")&&(n=n.getElement(".button")),n.removeClass("w-icon").addClass("w-icon-only").getElements("span").addClass("hidden"),n.getElement("span").removeClass("hidden")},returnButtonfromLang:function(n,t){var i=n.querySelector("span"),f=t.icon,e=f!==!1?Affinity.icons[f]:"",o=t.label,u,r;return i.querySelectorAll("span").length===1?(r=document.createElement("span"),u=i.querySelector("span"),r.innerHTML=e,u.innerHTML=o,i.insertBefore(r,u),i.classList.add("w-icon")):i.querySelectorAll("span").length===2&&(r=i.querySelectorAll("span")[0],u=i.querySelectorAll("span")[1],r.innerHTML=e,u.innerHTML=o,i.classList.add("w-icon")),r&&f===!1&&(r.destroy(),i.classList.remove("w-icon")),n},returnButtons:function(n,t,i,r,u,f,e,o){var h,s,v,l=!1,d=e||!1,y,a,et;if(n.Name.contains("Button")){y=String.uniqueID(),document.getElement(".button-menu-closer")||new Element("div",{"class":"button-menu-closer hidden"}).addEvent(Affinity.events.click,this.hideButtons).inject(document.getElement("body"),"bottom");var p=new Element("div"),w=new Element("span",{"class":"button-divider blue hidden",html:"<hr />"}),g=new Element("span",{"class":"button-divider decline hidden",html:"<hr />"}),nt=new Element("span",{"class":"button-wrapper recalc"}),b=new Element("span",{"class":"button-wrapper awards"}),k=new Element("span",{"class":"button-wrapper duplicate"}),tt=new Element("span",{"class":"button-wrapper favourite"}),it=new Element("span",{"class":"button-wrapper decline"}),rt=new Element("span",{"class":"button-wrapper save"}),ut=new Element("span",{"class":"button-wrapper delete"}),ft=new Element("div",{"class":"button-menu-close",html:this.icons.dotsVert}),c=new Element("div",{"class":"button-menu-container row-ref-"+i,id:"bm"+y}).adopt(ft,new Element("div",{"class":"button-menu-title",html:"Options"}),new Element("div",{"class":"button-wrappers"}).adopt(nt,b,k,tt,p,w,it,g,rt,ut)).inject(document.getElement("body"),"bottom").addEvent(Affinity.events.outAll,this.subMenuOut).addEvent(Affinity.events.overAll,this.subMenuOver).set("reveal",{duration:250,transition:Fx.Transitions.Sine.easeInOut});r!=="pending"&&k.addClass("active"),this.isManager&&b.addClass("active"),a=new Element("span",{"class":"button button-menu-button","data-row-ref":i,html:"<span>"+this.icons.dotsVert+"<\/span><span><\/span>"}),Affinity.mobile?a.addEvent(Affinity.events.click,this.buttonClicked):a.addEvent(Affinity.events.outAll,this.hideButtons).addEvent(Affinity.events.overAll,this.showButtons),l=new Element("div",{"class":"button-container","data-menu-id":"bm"+y}).adopt(new Element("span",{"class":"button-wrapper submit"}),new Element("span",{"class":"button-wrapper approve"}),new Element("span",{"class":"button-wrapper decline"}),a),et=!1,Array.each(n.Children,function(n){s=this.zelosProcessor.processChild(n),s&&(n.Name.test("ReCalc","gi")?Affinity.mobile?c.getElement(".button-wrapper.recalc").destroy():(s.addClass("active").inject(c.getElement(".button-wrapper.recalc"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.recalc").destroy(),s=this.returnButtonfromLang(s,Affinity.languages.english.application.timesheets.buttons.recalc),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)):n.Name.test("awards","gi")?!Affinity.mobile&&Affinity.isAwardsPopupEnabled()?(s.addClass("active").inject(c.getElement(".button-wrapper.awards"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.awards").destroy(),s=this.returnButtonfromLang(s,Affinity.languages.english.application.timesheets.buttons.awards),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)):c.getElement(".button-wrapper.awards").destroy():Affinity.enableFavourites&&n.Name.test("favourite","gi")?Affinity.mobile?c.getElement(".button-wrapper.favourite").destroy():(s.addClass("active").inject(c.getElement(".button-wrapper.favourite"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.favourite").destroy(),s=this.returnButtonfromLang(s,{label:o?this.baseAppLang.favourites.renameButtonLabel:this.baseAppLang.favourites.saveButtonLabel,icon:"Pin"}),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)):n.Name.test("save","gi")?s.addClass("active").inject&&c.getElement(".button-wrapper.save")!==null&&(s.addClass("active").inject(c.getElement(".button-wrapper.save"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.save").destroy(),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked),w.classList.remove("hidden")):n.Name.test("approve","gi")?(s.addClass("active").inject(l.getElement(".button-wrapper.approve"),"after"),s.getElement(".button").set("data-row-ref",i),l.getElement(".button-wrapper.approve").destroy(),s.getElement(".button").addEvent(Affinity.events.click,this.buttonClicked),this.simplifyButton(s)):n.Name.test("decline","gi")?(s.addClass("active").inject(l.getElement(".button-wrapper.decline"),"after"),s.getElement(".button").set("data-row-ref",i),l.getElement(".button-wrapper.decline").destroy(),s.getElement(".button").addEvent(Affinity.events.click,this.buttonClicked),this.simplifyButton(s)):n.Name.test("delete","gi")?(s.addClass("active").inject(c.getElement(".button-wrapper.delete"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.delete")&&c.getElement(".button-wrapper.delete").destroy(),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked),w.classList.remove("hidden")):n.Name.test("submit","gi")?(s.addClass("active").inject(l.getElement(".button-wrapper.submit"),"after"),s.getElement(".button").set("data-row-ref",i),l.getElement(".button-wrapper.submit").destroy(),s.getElement(".button").addEvent(Affinity.events.click,this.buttonClicked),this.simplifyButton(s)):(s.inject(a,"before"),s.getElement(".button").set("data-row-ref",i),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)),s&&s.querySelector(".button")&&s.querySelector(".button").classList.add("button-"+n.Value.ButtonType.replace(new RegExp(/\s/g),"").toLowerCase()),h&&h.querySelector(".button")&&h.querySelector(".button").classList.add("button-"+n.Value.ButtonType.replace(new RegExp(/\s/g),"").toLowerCase()))}.bind(this)),this.enableFormEdit&&(new Element("span",{"class":"button-divider edits",html:"<hr />"}).inject(c.getElement(".button-wrappers")),v=new Element("span",{"class":"button-wrapper"}).inject(c.getElement(".button-wrappers")),s=new Element("span",{"class":"button blue w-icon","data-row-ref":i,"data-type":"FormEdit"}).adopt(new Element("span",{html:Affinity.icons.Pencil}),new Element("span",{html:"Edit"})).inject(v),s.store("cfbutton",s),s.addEvent(Affinity.events.click,this.buttonClicked)),c.getElement(".button-wrapper.duplicate")&&(typeOf(t)==="null"||t||d?c.getElement(".button-wrapper.duplicate").destroy():s=new Element("span",{"class":"button blue w-icon ui-has-tooltip","data-type":"Duplicate","data-row-ref":i,html:"<span>"+this.icons.duplicate+"<\/span><span>Duplicate<\/span><\/span>"}).inject(c.getElement(".button-wrapper.duplicate")).addEvent(Affinity.events.click,this.buttonClicked)),f&&f.length>0&&(new Element("span",{"class":"button-divider obscured",html:"<hr />"}).inject(p),Array.each(f,function(n){v=new Element("span",{"class":"button-wrapper obscured"}).inject(p),s=new Element("span",{"class":"button "+(n[1].toLowerCase().contains("higher dut")?"yellow":"blue")+" w-icon","data-type":"Obscured","data-row-ref":i,"data-col-ref":n[0],"data-display":n[1]}).adopt(new Element("span",{html:Affinity.icons.FieldEdit}),new Element("span",{html:"Set "+n[1]})).inject(v),s.store("cfbutton",s).addEvent(Affinity.events.click,this.buttonClicked)}.bind(this))),c.inject(this.table,"before").set("reveal",{duration:250,mode:"vertical"}).toggle()}return l},retrunRowStatus:function(n){var i=this.getValue(n).toLowerCase(),t={status:"none",icon:"",color:"none",klass:"",message:"",isNewRow:!1};switch(i){case"pending":t.status=i,t.icon=Affinity.icons.Save,t.message=this.globalLang.timesheetSavedNotSubmitted,t.color="orange",t.klass="color "+t.color;break;case"submitted":t.status=i,t.color="blue",t.klass="color "+t.color;break;case"declined":t.status=i,t.icon=Affinity.icons.ThumbsDown,t.color="red",t.message=this.globalLang.timesheetDeclined,t.klass="color "+t.color;break;case"approved":t.status=i,t.icon=Affinity.icons.ThumbsUp,t.color="green",t.message=this.globalLang.timesheetApproved,t.klass="color "+t.color;break;case"paid":t.status=i,t.icon=Affinity.icons.Moneybag,t.color="green",t.message=this.globalLang.timesheetPaid,t.klass="color "+t.color;break;case"immutable":t.status=i,t.icon=Affinity.icons.Lock,t.color="grey",t.message="",t.klass="color "+t.color;break;case"new":t.status=i,t.icon=Affinity.icons.StarFull,t.color="orange",t.message="New Timesheet",t.klass="color "+t.color+" hi",t.isNewRow=!0}return t},setTableClass:function(){if(typeOf(this.options.widgetDocument)==="object"&&"Attribute"in this.options.widgetDocument){var t=this.options.widgetDocument.Attribute.IsReadOnly||!1,n;n=t?"ui-grid ui-grid-sortable timesheet":"ui-grid timesheet",n=this.options.timesheetType==="employeeDetails"?n+" detailed":n,this.table.set("class",n),this.hasRows||this.table.addClass("hidden")}},buildTableHeader:function(){var n,i,t;if(this.setTableClass(),this.options.widgetDocument&&this.options.widgetDocument.Children&&this.options.widgetDocument.Children.length!==0){for(i=!1,n=0;n<this.options.widgetDocument.Children.length;n++)if(this.options.widgetDocument.Children[n].Data&&typeOf(this.options.widgetDocument.Children[n].Data.RowType)==="null"){i=this.options.widgetDocument.Children[n];break}i&&(t=this.buildTableRow(i,!0),t&&(t.getElement("th.active").addClass("first"),this.table.getElement("thead").empty().adopt(t),this.thead=t,this.thead.getElement("input.selectall")&&(this.bulkSelect=this.thead.getElement("input.selectall"),this.bulkSelect.addEvent(Affinity.events.click,this.selectAllRows))))}},buildTableFooter:function(){var t,e,i,r,f,n,u,s;if(this.options.widgetDocument&&this.options.widgetDocument.Children&&this.options.widgetDocument.Children.length!==0){for(e=!1,t=0;t<this.options.widgetDocument.Children.length;t++)if(this.options.widgetDocument.Children[t].Data&&typeOf(this.options.widgetDocument.Children[t].Data.RowType)==="null"){e=this.options.widgetDocument.Children[t];break}if(e)if(i=Number(this.options.widgetDocument.Layout.UnitTotal).round(2),r=this.thead.getElement(".col-id-TsNet")||this.thead.getElement(".col-id-CalculatedTotal")||this.thead.getElement(".col-id-Unit")||this.thead.getElement(".col-id-Units")||!1,Affinity.mobile){this.tfoot.empty();var n=this.thead.getElements("th.active"),f=n.indexOf(r),o=n.length;r?(this.tfoot.adopt(new Element("th",{colspan:o,"class":"active"})),this.tfoot.adopt(new Element("th",{"class":"active value unit-total"})),f+1<o&&this.tfoot.adopt(new Element("th",{colspan:1,"class":"active"}))):this.tfoot.adopt(new Element("th",{colspan:o,"class":"active"})),this.secondaryAddButton||this.returnSecondaryAddButton(),this.secondaryButtonWrapper.inject(this.tfoot.getElement("th.active"))}else r?(this.tfoot.empty(),n=this.thead.getElements("th"),f=n.indexOf(r),Array.each(n,function(n,t){t==f?this.tfoot.adopt(new Element("th",{"class":"active value unit-total"})):this.tfoot.adopt(new Element("th",{"class":n.hasClass("hidden")?"hidden":n.hasClass("active")?"active":""}))}.bind(this)),this.tfoot.getElement("th.active").addClass("first")):(this.tfoot.empty(),n=this.thead.getElements("th"),Array.each(n,function(n){this.tfoot.adopt(new Element("th",{"class":n.hasClass("hidden")?"hidden":n.hasClass("active")?"active":""}))}.bind(this)),this.tfoot.getElement("th.active")&&this.tfoot.getElement("th.active").addClass("first")),this.tfoot.getElement(".unit-total")&&i&&i>0&&(u=this.tfoot.getElement(".unit-total"),s=u.getPrevious("th.active"),u.set("html","Total&nbsp;<strong>"+i+"<\/strong>"),Affinity.mobile?u.set("html","<strong>"+i+"<\/strong>"):(s.set("html","(from&nbsp;"+this.options.widgetDocument.Layout.PageTotal+"&nbsp;pages)"),s.setStyle("text-align","right"),u.set("html","Total&nbsp;<strong>"+i+"<\/strong>"))),function(){var i=[],t=this.tfoot.getElements("th"),u=0,r=0,n;for(this.tfoot.getElement("th.unit-total")&&(r=t.indexOf(this.tfoot.getElement("th.unit-total"))+1),n=t.length-1;n>-1;n--)if(i.push(t[n]),t[n].hasClass("active")&&u++,n===r)break;Array.each(i,function(n){n.destroy()}),new Element("th",{colspan:i.length,"class":"active"}).inject(this.tfoot)}.bind(this)(),this.tfoot.getElements("th.active").length>0&&(this.secondaryAddButton||this.returnSecondaryAddButton(),this.secondaryButtonWrapper.inject(this.tfoot.getElements("th.active").getLast()))}},columnsCheck:[],checkColumnMisssAligned:function(){var i=!1,n,t;return this.columnsCheck.length>0&&(n=this.columnsCheck[0].join(",").trim().replace(/Selected/gi,"").replace(/\,\,/g,","),Array.each(this.columnsCheck,function(r){t=r.join(",").trim().replace(/Selected/gi,"").replace(/\,\,/g,","),/.*[ActEndTime].*[ActStartTime].*[ShiftType].*/gi.test(t)&&/.*[ActEndTime].*[ActStartTime].*[ShiftType].*/gi.test(n)&&(t=t.replace(/ShiftType/gi,"").replace(/\,\,/g,","),n=n.replace(/ShiftType/gi,"").replace(/\,\,/g,",")),n!==t&&(i=!0)}.bind(this))),i},buildTableRow:function(n,t){var o;if(n){var h=[],c=n.hasOwnProperty("data")&&typeof n.Data=="object"&&n.Data.hasOwnProperty("RowType")?n.Data.RowType:"Timesheet",b=0,l=-1;if(this.options.widgetDocument&&this.options.widgetDocument.Children&&typeOf(this.options.widgetDocument.Children)=="array"&&this.options.widgetDocument.Children.contains(n)&&(l=this.options.widgetDocument.Children.indexOf(n)),c==="Award")return!1;if(c==="Timesheet"){var e,u,r,a,v,i,s=!1,f=new Element("tr",{"class":"timesheet-row","data-doc-index":l}),y=new Element("tr"),p=[],w=!1;if("Children"in n&&typeOf(n.Children)==="array"){if(n.Children.sort(function(n,t){return parseInt(n.Layout.Rank,10)-parseInt(t.Layout.Rank,10)}),Array.each(n.Children,function(n){if(e=this.getAttributes(n),u=n.Source?n.Source.PropertyName:n.Name.substring(n.Name.lastIndexOf("-")+1),p.push(u.trim()),u.test("TsStatus","gi")&&(s=this.retrunRowStatus(n)),r="active ",e.hidden&&(r="hidden "),n.Source.PropertyName==="Comment"&&n.ValueAsString!==undefined&&n.ValueAsString.indexOf("Leave App")>-1&&(w=!0),a=this.tbody.getElements(".col-id-"+u+".hidden").length>0,v=this.tbody.getElements(".col-id-"+u+".active").length>0,!e.hidden&&a&&(this.table.getElements(".col-id-"+u).removeClass("hidden").addClass("active"),r="active "),e.hidden&&v&&(r="active "),n.Layout.hasOwnProperty("IsObscured")&&n.Layout.IsObscured&&(this.table.getElements(".col-id-"+u).removeClass("active").addClass("hidden"),r="hidden ",h.push([".col-id-"+u,n.Description.ShortText.replace(/timesheet/gi,"").trim()])),u.test("TimesheetId","gi")&&(f.addClass(n.ValueAsString),f.set("data-timesheet-id",n.ValueAsString)),r=u.test("Comment","gi")?r+"comment ":r,r=u.test("TsNet","gi")?r+"w100 ":r,r=u.test("Unit","gi")?r+"w100 ":r,r=u.test("CalculatedTotal","gi")?r+"w100 ":r,r=u.test("RowButton","gi")?r+"buttons ":r,r=u.test("Selected","gi")?r+" check w25 ":r,n.InputType)switch(n.InputType){case"Time":case"HoursMins":r=r.replace(/w100 /,"")+"w100 ";break;case"Date":case"DateTime":r=r.replace(/w100 /,"")+"w150 "}Affinity.mobile&&r.test("RowButton","gi")&&(r="hidden "+r.replace("active","")),new Element("td",{"class":r+"col-id-"+u,"data-col-id":u}).inject(f),b++,t&&(i="",n.Layout&&n.Layout.HideTitle!==!0&&typeOf(n.Description)!=="null"&&typeOf(n.Description.ShortText)!=="null"&&(i=n.Description.ShortText.replace(/timesheet/gi,"").trim(),i=="Position Code"?i='<span>Position<\/span><span class="hide-on-mobile"> Code<\/span>':i=="Pay Code"?i='Pay<span class="hide-on-mobile"> Code<\/span>':i.test(new RegExp(" Element","gi"))?i=i.replace(" Element",'<span class="hide-on-mobile"> Element<\/span>'):i=="Submitted To"?i='<span class="hide-on-mobile">Submitted <\/span><span>To<\/span>':i=="Hours Worked"?i='<span class="hide-on-mobile">Hours<\/span><span class="hide-on-desktop">Hrs<\/span><span class="hide-on-mobile"> Worked<\/span>':i=="Hours"?i='<span class="hide-on-mobile">Hours<\/span><span class="hide-on-desktop">Hrs<\/span>':i.test(new RegExp("hours","gi"))?Affinity.mobile&&(i="Hrs"):i.test(new RegExp("cost","gi"))?Affinity.mobile&&(i="Cost"):i.test(new RegExp("resource","gi"))?Affinity.mobile&&(i=i.replace(new RegExp("resource","gi"),"Res")):i.test(new RegExp("approver","gi"))?Affinity.mobile&&(i=i.replace(new RegExp("approver","gi"),"Appr")):i.test(new RegExp("employee","gi"))?Affinity.mobile&&(i="Emp"):i=="Bulk Process"?i='<input type="checkbox" class="selectall ui-has-tooltip" data-tooltip="Select / Deselect All" data-tooltip-dir="top,left" />':e.required&&!e.readonly?i+='&nbsp;<span class="required">*<\/span>':i=i.replace(/ /g,"&nbsp;")),new Element("th",{"class":r+"col-id-"+u,"data-col-id":u,html:i}).inject(y))}.bind(this)),this.columnsCheck.push(p),Affinity.mobile&&Array.each(n.Children,function(n){n.Source.PropertyName==="EmployeeNo"&&n.Description!=undefined&&n.Description.InfoIcon!=undefined&&n.Description.InfoIcon==="LockApproved"&&s.status.toLowerCase()==="immutable"&&(s.color="green")}.bind(this)),f.getElement("td.active").addClass("indicate").addClass("first"),f.store("status",s),Affinity.mobile&&s.status!=="immutable"&&w===!1&&f.getElement("td.indicate")){o=new Hammer(f,{domEvents:!0}),o.get("swipe").set({direction:Hammer.DIRECTION_HORIZONTAL}),o.add(new Hammer.Press({event:"longpress",time:501}));o.on("panleft panright",this.mobileSelect);o.on("longpress",this.mobileSelect);o.on("tap",this.popupEditForm)}return t?y:(f.store("obscured",h),f)}return f.destroy(),n.hasOwnProperty("Attribute")&&typeof n.Attribute=="object"&&n.Attribute.hasOwnProperty("Message")&&typeof n.Attribute.Message=="string"&&n.Attribute.Message.trim()!==""&&this.messageBucket.push(n.Attribute.Message.trim()),!1}}},returnNewRow:function(n,t,i){var r=this.buildTableRow(n),ut,it,l,d,f,w,b,h,c,a,s;if(r){ut=i||this.options.timesheetType,it=this.tbody.getElements(".timesheet-row").length,this.docMessages=[],l=this.getMessages(n,"Row "+it+": "),l.length>0&&Array.each(l,function(n){this.docMessages.push(n)}.bind(this)),r.set("id",n.Name);var v=this.getAttributes(n),e=r.retrieve("status"),i="timesheet",ft=!1,et=!1,k=!1;if((n.hasOwnProperty("Data")&&n.Data.hasOwnProperty("IsFavourite")&&n.Data.hasOwnProperty("FavouriteName")&&n.Data.IsFavourite===!0&&n.Data.FavouriteName.trim()!==""&&(et=!0,k=n.Data.FavouriteName.trim()),d=!1,v.readonly?Array.each(n.Children,function(n){n.Name&&n.Name.test(new RegExp("TsDate","gi"))&&(r.dataset.date=n.ValueAsString),n.Name&&n.Name.test(new RegExp("TimesheetId","gi"))&&(r.dataset.timesheetId=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeNo","gi"))&&(r.dataset.employeeNo=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeName","gi"))&&(r.dataset.employeeName=n.ValueAsString)}.bind(this)):Array.each(n.Children,function(n){n.Name&&n.Name.test(new RegExp("Comment","gi"))&&n.ValueAsString&&n.ValueAsString.test(new RegExp("Leave App","gi"))&&(d=!0),n.Name&&n.Name.test(new RegExp("TimesheetType","gi"))&&(i=this.getTimesheetType((n.Value+"").trim()),ft=i==="allowance"?!0:!1),n.Name&&n.Name.test(new RegExp("TsDate","gi"))&&(r.dataset.date=n.ValueAsString),n.Name&&n.Name.test(new RegExp("TimesheetId","gi"))&&(r.dataset.timesheetId=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeNo","gi"))&&(r.dataset.employeeNo=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeName","gi"))&&(r.dataset.employeeName=n.ValueAsString)}.bind(this)),d&&(v.readonly=!0),v.hidden)||(typeOf(t)==="null"||!t)&&e.isNewRow)return r.destroy(),!1;t&&!e.isNewRow&&(e.isNewRow=!0);var ot=n.AwardRows&&n.AwardRows.AwardRowIds&&typeOf(n.AwardRows.AwardRowIds)==="array"&&n.AwardRows.AwardRowIds.length>0?!0:!1,rt=!1,g=[],o=!1,st=!1,u,y,p,nt,tt=[];if(Array.each(n.Children,function(t){var s={name:t.Description.ShortText,value:t.Value},i,f,o;if(tt.push(s),t.hasOwnProperty("Children")&&Array.isArray(t.Children)&&t.hasOwnProperty("Name")&&typeof t.Name=="string"&&t.Name.trim()!==""&&t.Name.test(new RegExp("RowButton","gi"))&&t.Children.forEach(function(n){n.hasOwnProperty("Value")&&typeof n.Value=="object"&&n.Value.hasOwnProperty("ButtonType")&&typeof n.Value.ButtonType=="string"&&n.Value.ButtonType.trim()!==""&&n.Value.ButtonType.test(new RegExp("Awards","gi"))&&(rt=!0)}.bind(this)),u=!1,y=this.getAttributes(t),d&&(y.readonly=!0,t.Name.test(new RegExp("Bulk","gi"))&&(y.hidden=!0)),t.Description.hasOwnProperty("InfoText")&&typeof t.Description.InfoText=="string"&&(this.setupCorrectInfoColorForForwardedRowInMobileMode(t,e),g.push(t.Description)),p=t.Source?t.Source.PropertyName:t.Name.substring(t.Name.lastIndexOf("-")+1),p.test("AuthoriserId","gi")&&(st=t.Value),!y.hidden)if(v.readonly||y.readonly){if(u=r.getElement(".col-id-"+p),u.set("html",this.getValue(t)),t.InputType)switch(t.InputType){case"Date":i=(new Date).parse(t.ValueAsString),Affinity.mobile?(u.addClass("mobile-date"),u.set("html",i.isValid()?i.format("%e&nbsp;%b<span>%Y<\/span>"):t.ValueAsString)):u.set("html",i.isValid()?i.format("%e/%m/%y"):t.ValueAsString);break;case"Time":i=(new Date).parse(t.ValueAsString),Affinity.mobile?(u.addClass("mobile-time"),u.set("html",i.isValid()?i.format("%l:%M<span>%p<\/span>").replace(/ /g,""):t.ValueAsString)):u.set("html",i.isValid()?i.format("%l:%M%p").replace(/ /g,""):t.ValueAsString)}t.InputType=="Lookup"&&typeOf(t.Value)!=="null"&&(u.addClass("has-display-lookup").addClass("display"),u.set("data-lookup-api",Affinity.lookupapi+"?ModelName="+t.Source.ModelName+"&PropertyName="+t.Source.PropertyName+"&key="+t.Value)),t.Description.HelpText&&(u.addClass("ui-has-tooltip"),u.set("data-tooltip",t.Description.HelpText),u.set("data-tooltip-dir","top")),nt=this.zelosProcessor.getLookupDependancies(t),nt&&(u.set("id",t.Name),v.readonly?(f=!1,o=[],"Source"in t&&typeOf(t.Value)==="array"&&(Array.each(n.Children,function(n){Array.each(nt,function(t){n.Name.contains(t.updateFromPropertyName)&&o.push({LinkType:"Dependency",ModelName:"Timesheet",PropertyName:t.updateFromPropertyName,ValueAsString:n.ValueAsString})})}),f=Affinity.lookupapi.replace("/Get","/GetConditional")+"&ModelName="+t.Source.ModelName+"&PropertyName="+t.Source.PropertyName+'&parameters={"Parameter":'+JSON.stringify(o)+"}"),f&&(u.set("data-lookup-api",f),u.removeClass("has-dependencies"),u.addClass("has-display-lookup"))):this.zelosProcessor.setLookupDependancies(t,nt,u))}else{if(l=this.getMessages(t,"Row "+it+' "'+t.Description.ShortText+'": '),l.length>0&&Array.each(l,function(n){this.docMessages.push(n)}.bind(this)),t.ElementType=="SectionHeading"&&t.Name.test("button","gi"))u=this.returnButtons(t,e.isNewRow,n.Name,e.status,ot,r.retrieve("obscured"),ft,k),r.eliminate("obscured");else try{t.Name.contains("TimesheetTable-")||t.Name.contains("Timesheet-Row")||(t.Name+="-"+String.uniqueID()),u=this.zelosProcessor.processChild(t)}catch(h){u=!1}u&&u.inject(r.getElement(".col-id-"+p)),t.Name.toLowerCase().contains("tsnet")&&u.getElement("input")&&u.getElement("input").addEvent("blur",function(n){var t=[],i;val=n.target.value,val.contains(".")||(i=val.split(/\D/),i.length>0&&Array.each(i,function(n){typeOf(parseInt(n,10))!=="null"&&t.push(n)})),t.length>1&&(n.target.value=Number.format(parseInt(t[0],10)+parseInt(t[1],10)/60,{decimals:2}))})}}.bind(this)),k&&g.push({InfoText:"From "+this.baseLang.favourites.name+" '"+k+"'",InfoIcon:"Pin",InfoColor:"yellow"}),f=!1,r.getElement("td.indicate").addClass(e.color),["new","pending","paid","approved","declined"].contains(e.status)){if(e.status==="paid"&&tt!==undefined&&tt!==null&&(w=tt.FindIn(name,"Date Paid"),w!==null&&w.value!==undefined&&w.value!==null)){for(b=w.value.replace("00:00:00","");b.indexOf(".")>-1;)b=b.replace(".","/");e.message="Timesheet has been paid on "+b}f=new Element("div",{html:e.icon,"class":"message-icon master "+e.color+" print-hidden ui-has-tooltip","data-tooltip":e.message}),f.inject(r.getElement("td.indicate"),"top")}return n.Attribute&&n.Attribute.IsMessage&&n.Attribute.Message&&n.Attribute.Message!==""&&(f=new Element("div",{html:Affinity.icons.Warning,"class":"message-icon master yellow print-hidden ui-has-tooltip","data-tooltip":n.Attribute.Message}),f.inject(r.getElement("td.indicate"),"top"),r.getElement("td.indicate").removeClass(e.color).removeClass("red").addClass("yellow")),n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&n.Attribute.ErrorMessage!==""&&(f=new Element("div",{html:Affinity.icons.Warning,"class":"message-icon master red print-hidden ui-has-tooltip","data-tooltip":n.Attribute.ErrorMessage}),f.inject(r.getElement("td.indicate"),"top"),r.getElement("td.indicate").removeClass(e.color).removeClass("yellow").addClass("red")),e.status==="immutable"&&(f=new Element("div",{html:Affinity.icons.Lock,"class":"message-icon master grey print-hidden ui-has-tooltip","data-tooltip":"Can not be edited"}),f.inject(r.getElement("td.indicate"),"top")),n.Description.InfoText&&(h=n.Description.InfoText&&typeOf(n.Description.InfoText)==="string"&&n.Description.InfoText.trim()!==""?!0:!1,c=h?n.Description.InfoText:!1,a=Affinity.icons.getIcon(n.Description.InfoIcon,"PromptInfo"),infocolor=n.Description.InfoColor||"blue",s=new Element("div",{html:a,"class":"message-icon info "+infocolor+" print-hidden"}),s.inject(r.getElement("td.indicate"),"bottom"),h&&(s.addClass("ui-has-tooltip"),s.set("data-tooltip",c))),g.length>0&&(o=document.createElement("div"),o.classList.add("message-icons"),Affinity.mobile||r.querySelector("td.indicate").classList.add("has-message-icons"),r.querySelector("td.indicate").appendChild(o),Array.each(g,function(n){h=n.InfoText&&typeOf(n.InfoText)==="string"&&n.InfoText.trim()!==""?!0:!1,c=h?n.InfoText:!1,a=Affinity.icons.getIcon(n.InfoIcon,"PromptInfo"),infocolor=n.InfoColor||"blue",new RegExp("lock","gi").test(n.InfoIcon)?f?(f.set("class","message-icon master "+infocolor+" print-hidden"),f.set("html",a),h&&(f.addClass("ui-has-tooltip"),f.set("data-tooltip",c)),Affinity.mobile&&(infocolor==="blue-darker"||infocolor==="green"||infocolor==="red")&&r.getElement("td.indicate").removeClass("blue").addClass(infocolor)):(f=new Element("div",{html:a,"class":"message-icon master "+infocolor+" print-hidden"}),f.inject(o,"top"),h&&(f.addClass("ui-has-tooltip"),f.set("data-tooltip",c)),Affinity.mobile&&(infocolor==="blue-darker"||infocolor==="green"||infocolor==="red")&&r.getElement("td.indicate").removeClass("blue").addClass(infocolor)):n.hasOwnProperty("InfoText")&&(s=new Element("div",{html:a,"class":"message-icon info "+infocolor+" print-hidden"}),s.inject(o,"bottom"),n.InfoIcon.trim()==="CodeP"&&(c=this.sanatiseAwardsInfoText(c)),h&&(s.addClass("ui-has-tooltip"),s.set("data-tooltip",c)),["employeeDetails","manager"].contains(ut)&&(Affinity.mobile||n.InfoIcon.trim()!=="CodeP"||n.hasOwnProperty("InfoButtonType")||(n.InfoButtonType="Awards"),!Affinity.mobile&&n.hasOwnProperty("InfoButtonType")&&n.InfoButtonType.trim()!==""&&(s.classList.add("convert-to-button"),s.dataset.type=n.InfoButtonType,s.dataset.color=infocolor)),Affinity.mobile&&(infocolor==="blue-darker"||infocolor==="green"||infocolor==="red")&&r.getElement("td.indicate").removeClass("blue").addClass(infocolor))}.bind(this))),o&&o.querySelector(".convert-to-button")&&o.querySelectorAll(".convert-to-button").forEach(function(n){(Affinity.isAwardsPopupEnabled()&&n.dataset.type==="Awards"&&rt||n.dataset.type!=="Awards")&&(n.classList.remove("convert-to-button","blue",n.dataset.color),n.classList.add("as-button","color-white","bg-"+n.dataset.color,"as-button-type-"+n.dataset.type.toLowerCase()),n.removeAttribute("data-color"),n.addEventListener(Affinity.events.click,this.buttonClicked),o.appendChild(n))}.bind(this)),rt&&o&&Affinity.isAwardsPopupEnabled()&&o.querySelector(".as-button-type-awards")&&o.appendChild(o.querySelector(".as-button-type-awards")),e.isNewRow&&(r.addClass("new"),r.getElement(".check input")&&(r.getElement(".check input").checked=!0)),r&&r.addEventListener(Affinity.events.start,this.rowUserInteraction),r}return!1},sanatiseAwardsInfoText:function(n){var u=n,f=n.split(";"),t=[],i,e,o,s,r;return f.length>0&&(f.forEach(function(n){r='<tr><td colspan="3">'+n+"<\/td><\/tr>",e=0;try{i=n.split(" - ")[0].trim(),e=parseFloat(i),o=n.split(" - ")[1].split(",")[0].trim(),s=n.split(" - ")[1].split(",")[1].trim(),r="<tr><td>"+s+" <small>("+o+')<\/small><\/td><td>&nbsp;<\/td><td class="right">'+i+"<\/td><\/tr>"}catch(u){}t.push({sortby:0,str:r})}.bind(this)),t.sort(function(n,t){return n>t?-1:n<t?1:0}),u="<table>"+t.map(function(n){return n.str}).reverse().join("")+"<\/table>"),u},setupCorrectInfoColorForForwardedRowInMobileMode:function(n,t){Affinity.mobile&&(n.Description.InfoText.indexOf("assigned to")>-1&&t.status!=="approved"&&t.status!=="declined"?n.Description.InfoColor="blue-darker":n.Description.InfoText.indexOf("assigned to")>-1&&(t.status==="approved"||t.status==="declined")&&(n.Description.InfoColor=t.color))},updateRow:function(n,t,i,r){if(this.options.widgetDocument===undefined&&(this.options.widgetDocument=n),this.options.widgetDocument&&this.options.widgetDocument.hasOwnProperty("Children")&&typeOf(this.options.widgetDocument.Children==="array")&&t<this.options.widgetDocument.Children.length&&this.options.widgetDocument.Children[t]&&t<this.tableRows.length&&this.tableRows[t]){var f=this.returnNewRow(r,!0),u=this.tableRows[t],e=u.hasClass("new");f.inject(u,"after"),this.destroyRow(u),e||f.removeClass("new"),this.tbody&&this.tbody.getElements("tr.timesheet-row")&&this.tbody.getElements("tr.timesheet-row").length>0&&(this.tableRows=this.tbody.getElements("tr.timesheet-row")),t<this.options.widgetDocument.Children.length?this.options.widgetDocument.Children.splice(t,0,r):this.options.widgetDocument.Children.push(r)}},forceRowReadOnly:function(n,t){if(this.setMissingDefaultAsReadOnly){var f=n.getElements("td"),r,u,i;n.removeClass("modified"),Array.each(f,function(f){f.hasClass("active")?(f.getElement(".message-icon.master")&&(f.getElement(".message-icon.master").removeClass("orange").removeClass("red").removeClass("green").removeClass("blue").removeClass("light-blue").addClass("grey").set("html",Affinity.icons.Lock),typeOf(t)==="string"&&t.trim()!==""&&(Affinity.UI.Tooltips.Remove(f.getElement(".message-icon.master")),f.getElement(".message-icon.master").addClass("ui-has-tooltip").set("data-tooltip","Row is locked because "+t),Affinity.UI.Tooltips.Process())),n.getElement("td.indicate")&&n.getElement("td.indicate").removeClass("orange").removeClass("red").removeClass("green").removeClass("blue").removeClass("light-blue").addClass("grey").addClass("grey"),(f.hasClass("buttons")||f.hasClass("check"))&&(f.empty(),f.removeClass("buttons").removeClass("check")),f.getElement("input")&&(r=f.getElement("input").value,f.getElement(".subhidden")?(u=f.getElement(".subhidden").getChildren()[0],i=u.retrieve("widget"),i&&"destroy"in i&&i.destroy()):f.empty(),f.set("html",r))):f.empty()}.bind(this)),n.getParent("tbody").getElements("tr.modified").length===0&&this.delUnload()}},selectAllRows:function(n){document.querySelectorAll("tr.timesheet-row .active.check input").forEach(function(t){t.checked=n.target.checked?!0:!1})},cleanFavData:function(n,t){var i=t!==undefined?t:this.options.widgetDocument;return(Array.each(i.Children,function(n,t){var r={};Object.keys(n.Data).forEach(function(t){t!=="IsFavourite"&&t!=="FavouriteName"&&t!=="FavouriteType"&&(r[t]=n.Data[t])}),n.Data=r,i.Children[t].Data=r,Array.each(n.Children,function(n,r){n.Name.test(/RowButton/gi)&&Array.each(n.Children,function(n,u){n.Value.ButtonType==="Favourite"&&(n.Value.Pressed=!1,n.ValueAsString=JSON.stringify(n.Value),i.Children[t].Children[r].Children[u].Value=n.Value,i.Children[t].Children[r].Children[u].ValueAsString=n.ValueAsString)}.bind(this))}.bind(this))}.bind(this)),t!==undefined)?i:(this.options.widgetDocument=i,!0)},reduceBulkRows:function(){var n=parseInt(this.userData.employeeNumber),t=parseInt(this.currentSearchEmployee?this.currentSearchEmployee:n),r=Affinity.login.areas.Timesheet.IsEmployee,i=n!==t?!0:Affinity.login.areas.Timesheet.IsManager,u=this.cleanFavData();return Array.each(this.options.widgetDocument.Children,function(n,t){var o,r=!1,f=!1,e="",u=-1;Array.each(n.Children,function(n,t){n.Name.test(/TimesheetId/gi)&&(o=n.ValueAsString,r=this.options.target.getElement("tr.timesheet-row."+o)||!1,r&&(f=Affinity.doCheckRowChanges()?r.hasClass("modified")?!0:!1:r.getElement("td.check input")&&r.getElement("td.check input").checked?!0:!1)),n.Name.test(/TsStatus/gi)&&(e=n.ValueAsString.toLowerCase()),n.Name.test(/Bulk/gi)&&(u=t)}.bind(this)),r&&(i?e.test(new RegExp("decline|approve|paid","gi"))&&!f&&(r.getElement("td.check input")&&(r.getElement("td.check input").checked=!1),this.options.widgetDocument.Children[t].Children[u]&&(this.options.widgetDocument.Children[t].Children[u].Value=!1,this.options.widgetDocument.Children[t].Children[u].ValueAsString="False")):e.test(new RegExp("submit|decline|approve|paid","gi"))&&!f&&(r.getElement("td.check input")&&(r.getElement("td.check input").checked=!1),this.options.widgetDocument.Children[t].Children[u]&&(this.options.widgetDocument.Children[t].Children[u].Value=!1,this.options.widgetDocument.Children[t].Children[u].ValueAsString="False")))}.bind(this)),!0},hasRowChangedDelay:!1,changedFieldsMessage:"",getFirstCellvalue:function(n){var u=this.thead.getFirst("th.active").get("data-col-id"),t=n.getElement(".col-id-"+u),r=!1,i;return t.getElement(".widget")?(i=t.getElement(".widget").getWidget(),"getValue"in i&&(r=i.getValue())):t.getElement("input[type=hidden]")?r=t.getElement("input[type=hidden]").value:t.getChildren().length===0&&(r=t.get("html")),r},changeCount:0,hasChanges:function(){var n,i,e,r,u,o,s,h,c,f,t;if(this.isViewActive())return Affinity.timesheets.init.view&&(Affinity.timesheets.init.view==="detailed"||Affinity.timesheets.init.view==="dualdetailed"||Affinity.timesheets.init.view==="employee"||Affinity.timesheets.init.view==="employeeDetails"||Affinity.timesheets.init.view==="manager")?(n=[],n.append(this.tbody.getElements("tr.modified")),n.append(this.tbody.getElements("tr.new")),n.length>0?(f=this.tbody.getElements("tr.timesheet-row"),this.changedFieldsMessage="",t=[],Array.each(n,function(n){i=this.getFirstCellvalue(n),n.getElement(".message-icon.default-issue")&&n.getElement(".message-icon.default-issue").destroy(),n.getElement(".check input")&&(n.getElement(".check input").checked=!0),this.setMissingDefaultAsReadOnly?function(n,t,i,f){Array.each(t,function(r,u){r.test(new RegExp("Row "+(i.indexOf(n)+1)+(f?" ("+f+")":""),"gi"))&&t.splice(u,1)}.bind(this)),n.getElement(".cant-select-default")&&!n.hasClass("new")?(e=n.getElements(".cant-select-default"),r=e[0].getParent("tr"),u=[],Array.each(e,function(t){o=t.getParent("td"),s=r.getElements("td").indexOf(o),h=n.getParent("table").getElement("thead tr").getElements("th")[s].get("html").stripTags(),u.push(h+' can not select the saved value of "'+t.get("data-default-value")+'" as you are not configured to see this value.')}.bind(this)),c=new Element("span",{"class":"message-icon default-issue info red print-hidden ui-has-tooltip","data-tooltip":u.join("<br />"),html:Affinity.icons.Warning}),c.inject(r.getElement("td.active"),"bottom"),this.forceRowReadOnly(r,u.join("<br />")),t.push("Row "+(i.indexOf(n)+1)+(f?" ("+f+")":"")+" has changes - a default cant be selected")):t.push("Row "+(i.indexOf(n)+1)+(f?" ("+f+")":"")+" has changes")}.delay(1e3,this,[n,t,f,i]):t.push("Row "+(f.indexOf(n)+1)+(i?" ("+i+")":"")+" has changes")}.bind(this)),t.length>0&&(this.changedFieldsMessage="\n"+t.join("\n")),n=i=t=f=null,Affinity.UI.Tooltips.Process(),!0):(n=null,!1)):!1},getChangeMessage:function(){return this.changedFieldsMessage},rowUserInteraction:function(n){var t=n.target.get("tag").toLowerCase()=="tr"?n.target:n.target.getParent("tr");t&&!t.hasClass("user-interacted")&&(t.addClass("user-interacted"),t.removeEventListener(Affinity.events.start,this.rowUserInteraction))},hasRowChanged:function(n){if(!Affinity.doCheckRowChanges())return!1;var t=n&&"getParent"in n&&n.getParent("tr")||!1;t&&(clearTimeout(this.hasRowChangedDelay),this.hasRowChangedDelay=this.checkRowDiff.delay(250,this,[t]))},checkRowDiff:function(n){var i=n.retrieve("status"),f=!1,u,e,t,r;return this.options.target.getElements("tr").contains(n)?typeof i=="undefined"?!1:n&&!n.hasClass("user-interacted")?!1:(u=!0,Array.each(n.getElements("input,select,textarea"),function(n){u&&Affinity.UI.isElementInQueue(n)&&(Affinity.UI.hasElementRequestCompleted(n)||(u=!1))}.bind(this)),!u)?!1:(e=n.getElement("td.indicate"),t=n.getElement("td.indicate").getElement(".message-icon.master"),n.retrieve("initState")||n.store("initStatus",i),r=n.retrieve("initStatus"),n.getElement(".check input")&&(n.getElement(".check input").checked=!1),n.removeClass("modified"),e.classList.remove("blue","green","red","roange","yellow","modified","none"),t&&(t.classList.remove("blue","green","red","roange","yellow","hourglass"),Affinity.tooltips.removeTooltip(t)),e.classList.add(r.color),t&&(t.classList.add(r.color),t.innerHTML=r.icon,t.dataset.tooltip=r.message,t.classList.add(r.color,"ui-has-tooltip"),Affinity.tooltips.processTooltip(t)),Array.each(n.getElements("input,select,textarea"),function(n){var t=n.retrieve("changetracker");t&&t.hasChanged()&&!t.hasRestored()&&(f=!0)}.bind(this)),f?n.getElement("td.indicate")&&(n.addClass("modified"),n.getElement(".check input")&&(n.getElement(".check input").checked=!0),n.hasClass("new")||(n.getElement("td.indicate").removeClass("none").removeClass("blue").removeClass("green").removeClass("red").addClass("orange"),t?t.removeClass("blue").removeClass("green").removeClass("red").addClass("orange").addClass("hourglass").set("html",Affinity.icons.Hourglass):new Element("div",{html:Affinity.icons.Hourglass,"class":"message-icon master orange hourglass print-hidden"}).inject(n.getElement("td.indicate"),"top")),n.getElement("input[type=checkbox]")&&(n.getElement("input[type=checkbox]").checked=!0),n.addClass("modified")):n.getElement("td.indicate")&&(n.getElement("td.indicate").removeClass("none").removeClass("blue").removeClass("green").removeClass("orange"),n.getElement("td.indicate .message-icon.hourglass")&&(i.icon!==""?n.getElement("td.indicate .message-icon.hourglass").removeClass("hourglass").removeClass("orange").addClass(i.klass).set("html",i.icon):n.getElement("td.indicate .message-icon.hourglass").destroy()),n.getElement("td.indicate").addClass(i.color),!n.hasClass("new")&&n.getElement("input[type=checkbox]")&&(n.getElement("input[type=checkbox]").checked=!1),n.removeClass("modified")),this.hasChanges()?this.setUnload():this.delUnload(),f):!1},getWidgetDocument:function(){return this.options.widgetDocument},putWidgetDocument:function(n){return this.options.widgetDocument=n,n},updateWidgetDocument:function(){var n;return Array.each(this.options.widgetDocument.Children,function(t,i){n=this.tableRows[i],Array.each(t.Children,function(t,r){this.zelosProcessor.readField(this.options.widgetDocument,i,r,t,n)}.bind(this))}.bind(this)),delete n,this.options.widgetDocument},getWidgetDocumentRow:function(n){return this.options.widgetDocument.Children[n]?this.options.widgetDocument.Children[n]:!1},putWidgetDocumentRow:function(n,t,i){var u=this.returnNewRow(t),f,e,r,o;if(u){for(this.options.widgetDocument.Children[n]?(f=this.tbody.getElements("tr.timesheet-row")[n],this.options.widgetDocument.Children[n]=t,u.inject(f,"after"),f.destroy()):n<0?(this.options.widgetDocument.Children.unshift(t),u.inject(this.tbody,"top")):(this.options.widgetDocument.Children.push(t),u.inject(this.tbody,"bottom")),e="none",r=0;r<t.Children.length;r++)if(t.Children[r].Name.test("TimesheetId","gi")){e=t.Children[r].ValueAsString;break}if(o=this.tbody.getElement("."+e),o&&this.tbody.getElements("tr.timesheet-row")[n]!==o){this.refresh(null,i);return}this.processUI()}return u},delWidgetDocumentRow:function(n){if(this.options.widgetDocument.Children[n]){this.options.widgetDocument.Children.splice(n,1),this.debug&&(console.log("%cRemove Row Element","background: #ffd484; color: white"),console.time("Remove Row Element"));var t=this.tbody.getElements("tr.timesheet-row")[n];t.parentNode.removeChild(t),this.debug&&(console.timeEnd("Remove Row Element"),console.log("%c\tRow Element Removed","background: #ffd484; color: white;"))}this.processUI()},updateWidgetDocumentRow:function(n){var t=this.tbody.getElements("tr.timesheet-row")[n];return Array.each(this.options.widgetDocument.Children[n].Children,function(i,r){this.zelosProcessor.readField(this.options.widgetDocument,n,r,i,t)}.bind(this)),delete t,this.options.widgetDocument.Children[n]},returnDocument:function(){return this.updateWidgetDocument(),this.getWidgetDocument()},mobileFilter:["ProjectId","TsCost","ResourceCode","AuthoriserId","CostElement1","CostElement2","CostElement3","CostElement4"],getTimesheetType:function(n){switch(n){case"1":return"timesheet";case"2":return"allowance"}return"timesheet"},getAttributes:function(n){var t=n;if(Affinity.mobile&&Affinity.appname==="timesheets"&&Affinity.timesheets.init.view&&["detailed","dualdetailed","manager","employeeDetails"].contains(Affinity.timesheets.init.view)){if(t.Name.test(new RegExp("Comment","gi"))||t.Name.test(new RegExp("BulkProcess","gi"))||t.Name.test(new RegExp("Submit","gi"))||t.Name.test(new RegExp("RowButton","gi"))||t.Layout.Rank>2&&t.Source&&t.Source.PropertyName&&this.mobileFilter.contains(t.Source.PropertyName))return{readonly:!0,hidden:!0,required:!1};if(t.Attribute&&!t.Attribute.IsHidden)return{readonly:!0,hidden:!1,required:!1}}return{readonly:n.Attribute&&n.Attribute.IsReadOnly?n.Attribute.IsReadOnly:!1,hidden:n.Attribute&&n.Attribute.IsHidden?n.Attribute.IsHidden:!1,required:n.Attribute&&n.Attribute.IsRequired?n.Attribute.IsRequired:!1}},getValue:function(n){var i=n.Value==null||n.Value==undefined||n.Value=="undefined"?"":n.Value,t;if(n.Name=="Hours"&&(i=parseFloat(i).round(1)),typeOf(i)==="array")for(t=0;t<n.Value.length;t++)if(typeOf(n.Value[t])==="object"&&n.Value[t].selected){if(n.Value[t].display){i=n.Value[t].display;break}if(n.Value[t].value){i=n.Value[t].value;break}}return i},mobileSelect:function(n){Affinity.stopHammerEvent(n);var t=n.target.get("tag")==="tr"?n.target:n.target.getParent("tr"),r=this.tableRows.indexOf(t),e=this.options.widgetDocument.Children[r];if(t.getElement("td.check")){var u=t.getElement("td.active.indicate"),f=t.getElement("td.check"),i=t.hasClass("selected");switch(n.type){case"longpress":i?(u.removeClass("selected"),t.removeClass("selected"),i=!1):(u.addClass("selected"),t.addClass("selected"),i=!0);break;case"swipeleft":case"panleft":u.removeClass("selected"),t.removeClass("selected"),i=!1;break;case"swiperight":case"panright":u.addClass("selected"),t.addClass("selected"),i=!0}Array.each(this.options.widgetDocument.Children[r].Children,function(n,t){n.Source&&n.Source.PropertyName&&n.Source.PropertyName===f.get("data-col-id")&&(this.options.widgetDocument.Children[r].Children[t].Value=i,this.options.widgetDocument.Children[r].Children[t].ValueAsString=i.toString().capitalize())}.bind(this))}},formElement:!1,hidePopupEditFormDeleteButton:function(n){var i=null,t;Array.each(n.Children,function(n){n.Source.PropertyName==="TsStatus"&&(i=this.retrunRowStatus(n))}.bind(this)),this.options.timesheetType.toLowerCase==="employeedetails"&&i.toLowerCase!=="pending"&&(t=n.Children.length-1,Array.each(n.Children[t].Children,function(i,r){i.Value.ButtonType==="Delete"&&n.Children[t].Children.splice(r,1)}.bind(this)))},popupEditForm:function(n){var r=n.target.get("tag")==="tr"?n.target:n.target.getParent("tr"),u,t,i;r&&(u=this.tableRows.indexOf(r),t=this.options.widgetDocument.Children[u],this.hidePopupEditFormDeleteButton(t),t.Attribute.IsReadOnly||(i={target:!1,onSave:this.refresh,originDoc:t,originRow:r,originRowIndex:u,updateOnChange:this.updateRow,refreshBehind:this.refresh,duplicateTimesheet:this.duplicateTimesheet},t&&(this.formElement||(this.formElement=new Element("div",{"class":"timesheet-edit-form"})),this.formElement.empty(),i.target=this.formElement,t.hasOwnProperty("Children")&&typeOf(t.Children)==="array"&&t.Children.length>0&&Array.each(t.Children,function(n){n.Name.toLowerCase().contains("timesheetid")&&(i.timesheetId=n.Value),n.Name.toLowerCase().contains("employeeno")&&(i.employeeNumber=n.Value)}),(i.timesheetId===-1||i.timesheetId==="-1")&&(i.timesheetId=!1,delete i.timesheetId),new ZelosWidgetTimesheetEditForm(i))))},templates:function(){this.FilterStringTemplate=Filtered;n:{filters}}}),rowElement,this.debug&&(console.log("%cDestroy Single Row","background: orange; color: white"),console.time("Destroy Single Row")),rowElement.removeEventListener(Affinity.events.start,this.rowUserInteraction),rowid=rowElement.get("id"),rowIndex=this.tbody.getElements("tr.timesheet-row").indexOf(rowElement),Array.each(rowElement.getElements("input,textarea,select,.button"),function(n){if(n.hasClass("widget"))try{widget=n.retrieve("widget"),"destroy"in widget&&(widget.destroy(),widget=null)}catch(t){}n.removeEvents()}.bind(this)),rowElement.removeEvents(),this.delWidgetDocumentRow(rowIndex),document.getElements(".row-ref-"+rowid).destroy(),this.debug&&(console.timeEnd("Destroy Single Row"),console.log("%c\tSingle Row Destroyed","background: orange; color: white")),this.checkNoRows(),this.setTableClass(),this.debug&&(console.log("%cDestroy Rows","background: orange; color: white; font-size: large"),console.time("Destroy Rows")),Array.each(this.tbody.getElements("tr.timesheet-row"),function(n){this.destroyRow(n)}.bind(this)),this.thead.empty(),this.tfoot&&this.tfoot.empty(),this.debug&&(console.timeEnd("Destroy Rows"),console.log("%c\tRows Destroyed","background: orange; color: white; font-size: large")),this.checkNoRows(),this.setTableClass(),!0