function ZelosError(n){this.name="ZelosError",this.message=n||""}var ZelosInit,ZelosProcessFileds,ZelosTemplateLoad,ZelosTemplateProcess,ZelosViewSettings,ZelosAwardModal,ZelosWidget,ZelosWidgetDependancyQueue,ZelosWidgetDependancy,ZelosWidgetTable,ZelosWidgetTimesheetBulkEntry,ZelosWidgetTimesheetTableAsDetailed,ZelosWidgetTimesheetDualdetailed,ZelosWidgetTimesheetEditForm,ZelosWidgetTimesheetTable,ZelosWidgetTimesheetManagerDualdetailed,ZelosWidgetTimesheetTableAsMileage,ZelosWidgetTimesheetOverview,ZelosWidgetReportAsPeriodTable,ZelosWidgetTimesheetRibbon,ZelosWidgetTimesheetRibbonTile,ZelosWidgetTimesheetTableAsWeekly;Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosInit={Version:"1.0.2.0",Sequence:10100,Name:"Zelos Init",File:"ui.zelos.init.js",Jira:"",Notes:"Update root basepath"},!1 in window&&(window.Affinity={}),Affinity.zelos={},Affinity.zelos.Elements={},ZelosError.prototype=Error.prototype,ZelosInit=new Class({Implements:[Options,Events],Binds:["loadHtmlTemplate","htmlTemplateLoadError","htmlTemplayeLoaded"],options:{htmlTemplateUrl:"/Content/html/ZelosHtmlTemplates.html",requiredUiComponenets:["UITabs","UIGrid","UIHelpBubble","UIHelpIcon","UITooltips","UIDrawPanels","UIModal","UIPompts","UISelectLookup","UIUplaodersMulti","UIDateCalendar","UIValidation","UIHidables"],requiredZelosComponenets:["ZelosTemplateLoad","ZelosTemplateProcess"]},initialize:function(n){this.setOptions(n);var r,i=this.options.requiredUiComponenets.combine(this.options.requiredZelosComponenets),t=[];if(Array.each(i,function(n){typeOf(window[n])!="class"&&t.push(n)}),t.length>0)throw new ZelosError("There are components missing that are required for Zelos to run:\n"+t.join("\n")+"\nPlease refer to 'Setting up Zelos UI' in documentation.");delete r,delete i,delete t,Affinity.zelos.getElement=this.getElement,Affinity.zelos.getElementFromData=this.getElementFromData,this.loadHtmlTemplate()},loadHtmlTemplate:function(){this.fireEvent("request",Affinity.basepath+this.options.htmlTemplateUrl),new Request.HTML({url:Affinity.basepath+this.options.htmlTemplateUrl,evalScripts:!1,onFailure:this.htmlTemplateLoadError,onError:this.htmlTemplateLoadError,onSuccess:this.htmlTemplayeLoaded}).get()},htmlTemplateLoadError:function(){ga&&ga("send","event","Zelos","HtmlTemplate","load failed ("+Affinity.basepath+this.options.htmlTemplateUrl+")"),Affinity.prompts.hide(),this.fireEvent("error",'"'+Affinity.basepath+this.options.htmlTemplateUrl+'" must exist in your project.')},htmlTemplayeLoaded:function(n){var t;Array.each(n,function(n){(typeOf(n)=="element"||typeOf(n)=="table")&&n.get("data-form-element")&&n.get("data-form-element")!=""&&(Affinity.zelos.Elements[n.get("data-form-element")]=n.hasClass("get-tr")?n.getElement("tr"):n)}),delete t,this.fireEvent("complete")},setTemplateElement:function(n,t){Affinity.zelos.Elements[n]=t},getElement:function(n){return Affinity.zelos.Elements[n]?Affinity.zelos.Elements[n].clone():!1},getElementFromData:function(n){if(typeOf(n)!=="null"){var t=n.ElementType?n.ElementType:n.InputType,i=n.ElementType?"ElementType":"InputType";if(typeOf(Affinity.zelos.Elements[t])==="class")return Affinity.zelos.Elements[t];if(n.ElementType=="FieldEdit"||n.ElementType=="FieldDisplay")switch(n.InputType){case"Currency":if(Affinity.zelos.Elements.CurrencyInput)return Affinity.zelos.Elements.CurrencyInput.clone();default:return Affinity.zelos.Elements[t].clone()}if(Affinity.zelos.Elements[t])return Affinity.zelos.Elements[t].clone()}return!1}}),function(n,t,i,r,u,f,e){n.GoogleAnalyticsObject=u,n[u]=n[u]||function(){(n[u].q=n[u].q||[]).push(arguments)},n[u].l=1*new Date,f=t.createElement(i),e=t.getElementsByTagName(i)[0],f.async=1,f.src=r,e.parentNode.insertBefore(f,e)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-45869305-1","teampayoffice.com"),ga("create","UA-45869305-1",{cookieDomain:"none"}),ga("send","pageview"),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosProcessFileds={Version:"1.0.14.0",Sequence:10130,Name:"Zelos Process Fields",File:"ui.zelos.process.field.js",Jira:"",Notes:"Add class to calc button for optional hiding"},ZelosProcessFileds=new Class({Implements:[Options,Events],Binds:[],options:{zelosProcessor:null,dateDisplayFormat:"%A %B %e%o %Y",timeDisplayFormat:"%l:%M %p"},template:null,initialize:function(n){this.setOptions(n),this.zelosProcessor=this.options.zelosProcessor,this.icons={},this.icons.save=Affinity.icons.Tick,this.icons.submit=Affinity.icons.Paperplane,this.icons.accept=Affinity.icons.ThumbsUp,this.icons.progress=Affinity.icons.Tick,this.icons.success=Affinity.icons.Tick,this.icons.cancel=Affinity.icons.Cancel,this.icons.del=Affinity.icons.Cross,this.icons.decline=Affinity.icons.ThumbsDown,this.icons.add=Affinity.icons.Plus,this.icons.save=Affinity.icons.Save,this.icons.award=Affinity.icons.Gift,this.icons.fav=Affinity.languages.english.features.favourites.icon,this.icons.help=Affinity.languages.english.features.help.icon},returnField:function(n,t,i){var o,e,u,h,s,f,r;return(t=typeOf(t)==="null"?null:t,i=typeOf(i)==="null"?null:i,o=this.getAttributes(n),o.hidden)?!1:(s=this.getValue(n),f=Affinity.zelos.getElementFromData(n),f?(typeOf(f)=="class"?(u=new Element("div",{"class":"widget "+n.ElementType.toLowerCase(),"data-widget":n.ElementType,id:n.Name}),n.Attribute&&n.Attribute.IsMessage&&n.Attribute.Message&&n.Attribute.Message!==""&&u&&(new Element("div",{html:Affinity.icons.Warning,"class":"message-icon yellow print-hidden ui-has-tooltip","data-tooltip":"Test Message"}).inject(u,"after"),new Element("div",{html:n.Attribute.Message,"class":"print-only print-help-left"}).inject(u,"after"),u.addClass("has-message-icon")),r={parentForm:this.zelosProcessor.target,parentDocument:this.template,parentSectionIndex:i,parentChildIndex:t,widgetDocument:n,target:u,zelosEngine:this.zelosProcessor.zelos,zelosProcessor:this.zelosProcessor},n.ElementType=="TimesheetTable"&&(u.addClass("suppress-errors"),r.timesheetType=this.zelosProcessor.options.timesheetType,r.isManager=this.zelosProcessor.options.isManager,r.putApi=this.zelosProcessor.options.putApi,r.getEmptyTimesheetApi=this.zelosProcessor.options.getEmptyTimesheetApi,r.insertAddForm=this.zelosProcessor.options.insertAddTimesheetForm===!1?!1:this.zelosProcessor.options.insertAddForm?!1:!0,r.fromDate=this.zelosProcessor.options.fromDate,r.toDate=this.zelosProcessor.options.toDate,r.profile=this.zelosProcessor.options.profile,r.startDay=this.zelosProcessor.options.startDay,r.showDays=this.zelosProcessor.options.showDays,r.publicHolidays=this.zelosProcessor.options.publicHolidays,r.readOnly=this.zelosProcessor.options.readOnly===!1?!1:!0,r.paginate=this.zelosProcessor.options.paginate===!1?!1:!0,r.isDual=this.zelosProcessor.options.isDual===!0?!0:!1,r.subType=this.zelosProcessor.options.subType||"not-sub-type",r.isMileageDual=this.zelosProcessor.options.isMileageDual===!0?!0:!1,r.isAllowanceGrid=this.zelosProcessor.options.isAllowanceGrid===!0?!0:!1,u.addClass("view-section")),n.ElementType=="LeaveTable"&&(u.addClass("suppress-errors"),r.leaveType=this.zelosProcessor.options.leaveType,r.isManager=this.zelosProcessor.options.isManager,r.putApi=this.zelosProcessor.options.putApi,r.getEmptyleaveApi=this.zelosProcessor.options.getEmptyleaveApi,r.fromDate=this.zelosProcessor.options.fromDate,r.toDate=this.zelosProcessor.options.toDate,r.startDay=this.zelosProcessor.options.startDay,r.publicHolidays=this.zelosProcessor.options.publicHolidays),n.ElementType=="LeaveHistory"&&(u.addClass("suppress-errors"),r.fromDate=this.zelosProcessor.options.fromDate,r.toDate=this.zelosProcessor.options.toDate,r.startDay=this.zelosProcessor.options.startDay,r.publicHolidays=this.zelosProcessor.options.publicHolidays),n.ElementType=="LeaveCalendar"&&(u.addClass("suppress-errors"),r.fromDate=this.zelosProcessor.options.fromDate,r.toDate=this.zelosProcessor.options.toDate,r.startDay=this.zelosProcessor.options.startDay,r.publicHolidays=this.zelosProcessor.options.publicHolidays),n.ElementType=="LeaveCalendarHistory"&&(u.addClass("suppress-errors"),r.fromDate=this.zelosProcessor.options.fromDate,r.toDate=this.zelosProcessor.options.toDate,r.startDay=this.zelosProcessor.options.startDay,r.publicHolidays=this.zelosProcessor.options.publicHolidays),h=new f(r),u.store("widget",h),f=u):(o.readonly&&f.set("disabled","disabled"),f.getElement("label,.label")&&(e=f.getElement("label,.label"),e.set("html",n.Description.ShortText)),f.getElement("input,select,textarea,.display")&&(u=f.getElement("input,select,textarea,.display"),typeOf(n.Value)!="null"&&(u.value=s),u.hasClass("display")&&u.set("html",s)),n.Description&&n.Description.HelpText&&n.Description.HelpText!=""&&e&&u&&(new Element("div",{html:"?","class":"indicator grey help print-hidden ui-has-tooltip","data-tooltip":n.Description.HelpText}).inject(e),new Element("div",{html:n.Description.HelpText,"class":"print-only print-help-left"}).inject(u,"after")),n.Attribute&&n.Attribute.IsMessage&&n.Attribute.Message&&n.Attribute.Message!==""&&u&&(new Element("div",{html:Affinity.icons.Warning,"class":"message-icon yellow print-hidden ui-has-tooltip","data-tooltip":"Test Message"}).inject(u,"after"),new Element("div",{html:n.Attribute.Message,"class":"print-only print-help-left"}).inject(u,"after"),u.addClass("has-message-icon")),u&&(u.set("id",n.Name),u.set("autocomplete","off"),n.SortBy!==undefined&&n.SortBy!==null&&n.SortBy.trim().length>0&&u.set("sortby",n.SortBy)),this.writeField(n,f)),f.set("data-child-index",t),f):void 0)},getValue:function(n){var i=typeOf(n.Value)==="null"?"":n.Value,t;if(typeOf(i)==="array")for(t=0;t<n.Value.length;t++)if(typeOf(n.Value[t])==="object"&&n.Value[t].selected){if(n.Value[t].display){i=n.Value[t].display;break}if(n.Value[t].value){i=n.Value[t].value;break}}return i},mobileFilter:["TsCode","ProjectId","TsCost","ResourceCode","AuthoriserId","CostElement1","CostElement2","CostElement3","CostElement4"],getAttributes:function(n){if(Affinity.mobile&&Affinity.appname==="timesheets"&&Affinity.view&&(Affinity.view==="detailed"||Affinity.view==="dualdetailed")){if(n.Name.test(new RegExp("Comment","gi"))||n.Name.test(new RegExp("BulkProcess","gi"))||n.Name.test(new RegExp("Submit","gi"))||n.Name.test(new RegExp("RowButton","gi"))||n.Layout.Rank>2&&this.mobileFilter.contains(n.Source.PropertyName))return{readonly:!0,hidden:!0,required:!1};if(n.Attribute&&!n.Attribute.IsHidden)return{readonly:!0,hidden:!1,required:!1}}return{readonly:n.Attribute&&n.Attribute.IsReadOnly?n.Attribute.IsReadOnly:!1,hidden:n.Attribute&&n.Attribute.IsHidden?n.Attribute.IsHidden:!1,required:n.Attribute&&n.Attribute.IsRequired?n.Attribute.IsRequired:!1}},getLookupDependancies:function(n){var t,i,r,u,e,f=[];return(n.Parameter&&Array.each(n.Parameter,function(o){o.LinkType&&o.LinkType.toLowerCase().contains("dependency")&&(t=n.Name,i=n.Name.contains("-")?n.Name.substring(n.Name.lastIndexOf("-")+1):n.Name,r=o.PropertyName,u=o.PropertyName.contains("-")?o.PropertyName.substring(o.PropertyName.lastIndexOf("-")+1):o.PropertyName,e="if "+r+" ("+u+") changes, update "+t+" ("+i+")",f.push({logic:e,updateThisId:t,updateThisPropertyName:i,updateFromId:r,updateFromPropertyName:u,questionData:n}))}.bind(this)),f.length>0)?f:!1},setLookupDependancies:function(n,t,i){var r=Affinity.lookupapi;typeOf(n.Data)!=="null"&&typeOf(n.Data.ExternalParameter)!=="null"&&(r+=r.indexOf("?")>-1?"&"+n.Data.ExternalParameter:"?"+n.Data.ExternalParameter),this.setElementChangedEvent(i),dependenciesWidget=new ZelosWidgetDependancy({target:n.Name,propertyName:n.Source.PropertyName,modelName:n.Source.ModelName,dependancies:t,api:r}),i.addClass("has-dependencies"),i.store("dependencies",dependenciesWidget)},setElementChangedEvent:function(n){n.addChangeTracker(),n.addEvent("value-changed",function(){window.fireEvent("formElementChanged",{element:n})})},writeField:function(n,t){var rt,i,l,p,a,y,c,f,o,h,ft,s,e,v,w,u,b,ut,k,d,g,nt,tt,et="",r=this.getAttributes(n),it;if(!r.hidden){t.getElement("label,.label")&&(rt=t.getElement("label,.label")),t.getElement("input,select,textarea,.display")&&(i=t.getElement("input,select,textarea,.display"),i.hasClass("display")||i.addClass("validate")),h=this.getValue(n),r.required&&(ft=!0,new Element("span",{html:"*","class":"required"}).inject(rt)),et="",r.readonly===!1&&n.ElementType==="FieldDisplay"&&n.InputType==="Date"&&(n.ElementType="FieldEdit");switch(n.ElementType){case"WorkflowButton":case"TimesheetRowButton":case"LeaveRowButton":case"CustomButton":v=n.Value,s="",e="";switch(v.ButtonType){case"Save":s="<span>"+this.icons.save+"<\/span>",e="button orange w-icon";break;case"Submit":s="<span>"+this.icons.submit+"<\/span>",e="button green w-icon";break;case"Accept":s="<span>"+this.icons.accept+"<\/span>",e="button green w-icon";break;case"Progress":s="<span>"+this.icons.progress+"<\/span>",e="button green w-icon";break;case"Success":s="<span>"+this.icons.success+"<\/span>",e="button green w-icon";break;case"Cancel":s="<span>"+this.icons.cancel+"<\/span>",e="button grey w-icon";break;case"Delete":s="<span>"+this.icons.del+"<\/span>",e="button red w-icon";break;case"Decline":s="<span>"+this.icons.decline+"<\/span>",e="button grey w-icon";break;case"Add":s="<span>"+this.icons.add+"<\/span>",e="button blue w-icon";break;case"Favourite":s="<span>"+this.icons.fav+"<\/span>",e="button blue w-icon";break;case"Award":s="<span>"+this.icons.award+"<\/span>",e="button blue w-icon calc-pop-button";break;default:s="",e="button blue"}"Icon"in v&&v.Icon in Affinity.icons&&(s="<span>"+Affinity.icons[v.Icon]+"<\/span>",e="button blue w-icon"),"Color"in v&&v.Color.trim()!==""&&(e="button "+v.Color+" w-icon"),n.ElementType=="WorkflowButton"&&(e+=" zelos-button"),n.ElementType=="TimesheetRowButton"&&(e+=" timesheet-button"),n.ElementType=="CustomButton"&&(e+=" custom-button"),t.getElement(".button").set("id",n.Name),t.getElement(".button").set("data-id",n.Name),t.getElement(".button").set("data-name",n.Name),t.getElement(".button").set("data-type",v.ButtonType),t.getElement(".button").set("html",s+"<span>"+v.Label+"<\/span>"),t.getElement(".button").set("class",e);break;case"TextInput":case"Memo":i&&(i.set("data-validate-method",r.required?"hasvalue,sentence":"sentence"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"IntegerInput":i&&(i.set("data-validate-method",r.required?"hasvalue,int":"int"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"FloatInput":i&&(i.set("data-validate-method",r.required?"hasvalue,float":"float"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"CurrencyInput":i&&(i.set("data-validate-method",r.required?"hasvalue,currency":"currency"),i.value=parseFloat(h).format({decimal:".",group:",",decimals:2}),i.addClass("validate"),this.setElementChangedEvent(i));break;case"EmailInput":i&&(i.set("data-validate-method",r.required?"hasvalue,email":"email"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"DatePickerInput":f=Date.parse(n.ValueAsString),o=new UIDateTimeWidget({target:i,postId:n.Name,startDate:f,outputFormat:"zelos",showCalendarFilterButtonsForMobile:Affinity.mobile}),o.output.set("data-validate-method",r.required?"hasvalue,date":"date"),i.addClass("validate");break;case"DropDownBoxInput":w=!1,typeOf(n.Value)==="array"?(Array.each(n.Value,function(t){y=new Element("option",{html:t.display,value:t.value}),t.selected&&(y.set("selected","selected"),y.defaultSelected=!0,w=t,i.set("data-default-value",t.value)),n.SelectedItem&&n.SelectedItem==t.value&&(y.set("selected","selected"),y.defaultSelected=!0,w=t,i.set("data-default-value",t.value)),i.adopt(y)}),w!==!1&&(i.selectedIndex=n.Value.indexOf(w),i.value=w.value)):"SelectedItemAsString"in n&&n.SelectedItemAsString!==""&&i.set("data-default-value",n.SelectedItemAsString),c=this.getLookupDependancies(n),c&&(this.setLookupDependancies(n,c,i),c=!1),r.required&&(i.set("data-validate-method","hasvalue"),i.addClass("validate")),n.Layout.IsHideableSwitch&&i.addClass("is-hideable-switch"),this.setElementChangedEvent(i);break;case"FieldEdit":switch(n.InputType){case"String":if(n.InputType==="String"&&n.Name.test(new RegExp("Break","i"))){f=Date.parse(h),o=new UIDateTimeWidget({target:i,postId:n.Name,startDate:f,outputFormat:"%H:%M",displayFormat:"%H:%M",showCalendar:!1,showTime:!0,nullable:!0,hoursmins:!0}),o.output.set("data-validate-method",r.required?"hasvalue,time":"time"),o.output.set("data-calendar-nullable","true"),o.output.set("data-calendar-hoursmins","true"),o.output.addClass("validate"),this.setElementChangedEvent(i);break}i&&(i.set("data-validate-method",r.required?"hasvalue,sentence":"sentence"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"Float":i&&(i.set("data-validate-method",r.required?"hasvalue,float":"float"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"Currency":i&&(h=isNaN(parseFloat(h))?"":parseFloat(h).format({decimal:".",group:",",decimals:2}),i.set("data-validate-method",r.required?"hasvalue,currency":"currency"),i.addClass("validate"),i.value=h,this.setElementChangedEvent(i));break;case"Integer":i&&(i.set("data-validate-method",r.required?"hasvalue,int":"int"),i.addClass("validate"),this.setElementChangedEvent(i));break;case"Lookup":a=i.get("tag"),a==="select"||r.readonly||(l=new Element("select").inject(i,"after"),l.setProperties(i.getProperties()),l.addClass(i.get("class")),i.destroy(),i=l,i.set("id",n.Name)),a==="select"&&r.readonly&&(l=new Element("input",{type:"text"}).inject(i,"after"),l.addClass(i.get("class")),i.destroy(),i=l),r.readonly?(i.addClass("has-display-lookup"),i.set("disabled","disabled")):i.addClass("has-lookup"),i.set("data-default-value",h),p=Affinity.lookupapi+"?ModelName="+n.Source.ModelName+"&PropertyName="+n.Source.PropertyName,typeOf(n.Data)!=="null"&&typeOf(n.Data.ExternalParameter)!=="null"&&(p+="&"+n.Data.ExternalParameter),"enableSelectLimit"in Affinity&&Affinity.enableSelectLimit&&(p+="&limit="+Affinity.selectmax||1e3),i.set("data-lookup-api",p),r.required&&(i.set("data-validate-method","hasvalue"),i.addClass("validate")),this.setElementChangedEvent(i);break;case"Date":f=Date.parse(n.ValueAsString),r.readonly?i.value=f!==null&&typeOf(f)==="date"&&f.isValid()?f.toZelos():"":(o=new UIDateTimeWidget({target:i,postId:n.Name,startDate:f,outputFormat:"zelos"}),o.output.set("data-validate-method",r.required?"hasvalue,date":"date"),o.output.addClass("validate"),this.setElementChangedEvent(i));break;case"Time":f=Date.parse(h),r.readonly?i.value=f!==null&&typeOf(f)==="date"&&f.isValid()?f.format("%H:%M"):"":(o=new UIDateTimeWidget({target:i,postId:n.Name,startDate:f,outputFormat:"%H:%M",displayFormat:"%H:%M",showCalendar:!1,showTime:!0}),o.output.set("data-validate-method",r.required?"hasvalue,time":"time"),o.output.addClass("validate"),this.setElementChangedEvent(i));break;case"HoursMins":f=Date.parse(h),r.readonly?i.value=f!==null&&typeOf(f)==="date"&&f.isValid()?f.format("%H:%M"):"":(o=new UIDateTimeWidget({target:i,postId:n.Name,startDate:f,outputFormat:"%H:%M",displayFormat:"%H:%M",showCalendar:!1,showTime:!0,nullable:!0,hoursmins:!0}),o.output.set("data-validate-method",r.required?"hasvalue,time":"time"),o.output.set("data-calendar-nullable","true"),o.output.set("data-calendar-hoursmins","true"),o.output.addClass("validate"),this.setElementChangedEvent(i));break;case"BankNumber":document.banknumber.process(i);break;case"TaxNumber":document.taxnumber.process(i);break;case"Address":document.address.process(i)}c=this.getLookupDependancies(n),c&&(this.setLookupDependancies(n,c,i),c=!1);break;case"FieldDisplay":switch(n.InputType){case"Date":i.value="",n&&n.hasOwnProperty("ValueAsString")&&typeof n.ValueAsString=="string"&&n.ValueAsString.trim()!==""&&(it=Date.parse(n.ValueAsString),it&&(i.value=it.format(this.options.dateDisplayFormat))),r.readonly&&Affinity.mobile&&(newinput=new Element("span",{html:i.value.trim()===""?"&nbsp;":i.value}),newinput.setProperties(i.getProperties()),newinput.inject(i,"after"),i.destroy(),i=newinput);break;case"Time":n!==undefined&&n.ValueAsString!==undefined&&(i.value=n.ValueAsString.trim()!==""?Date.parse(n.ValueAsString).format(this.options.timeDisplayFormat):"");break;case"Lookup":a=i.get("tag"),a==="select"&&(l=new Element("input",{type:"text",disabled:"disabled"}).inject(i,"after"),l.addClass(i.get("class")),i.destroy(),i=l),i.addClass("has-display-lookup"),p=Affinity.lookupapi+"?ModelName="+n.Source.ModelName+"&PropertyName="+n.Source.PropertyName+"&Key="+h,typeOf(n.Data)!=="null"&&typeOf(n.Data.ExternalParameter)!=="null"&&(p+="&"+n.Data.ExternalParameter),"enableSelectLimit"in Affinity&&Affinity.enableSelectLimit&&(p+="&limit="+Affinity.selectmax||1e3),i.set("data-lookup-api",p),i.set("data-initial-value",h)}c=this.getLookupDependancies(n),c&&(this.setLookupDependancies(n,c,i),c=!1),this.setElementChangedEvent(i);break;case"AttachFile":t.getElement("a").set("html",n.Value.Display).set("href",this.zelosProcessor.options.server+"?api=document/content/"+n.Value.FileId),t.getElement(".print-only").set("html",this.zelosProcessor.options.server+"?api=document/content/"+n.Value.FileId);break;case"YoutubeInput":t.getElement("iframe").set("src","//www.youtube.com/embed/"+h);break;case"LinkURLInput":t.getElement("a").set("href",n.Value.value).set("html",n.Value.key),t.getElement(".print-only").set("html",n.Value.key);break;case"Subheading":t.set("html",n.Description.ShortText);break;case"ExplanationText":n.Layout.ArrowDirection&&t.addClass(n.Layout.ArrowDirection.toLowerCase()),t.set("html",n.Description.ShortText);break;case"Paragraph":t.getElement("p").set("html",n.Description.ShortText);break;case"DropDownBoxInput":Array.each(n.Value,function(n){y=new Element("option",{html:n.display,value:n.value}),n.selected&&y.set("selected","selected"),i.adopt(y)}),r.required&&(i.set("data-validate-method","hasvalue"),i.addClass("validate")),n.Layout.IsHideableSwitch&&i.addClass("is-hideable-switch"),this.setElementChangedEvent(i);break;case"MultiCheckBox":ut=String.uniqueID(),k=JSON.parse(n.ValueAsString),Array.each(k,function(n){b=String.uniqueID(),u=t.getElement(".template").clone(),u.removeClass("template"),u.removeClass("hidden"),u.getElement("input").set("value",n.value),u.getElement("input").set("id",b),u.getElement("input").set("name",n.value),u.getElement("input").set("data-validation-multicheck-id",ut),u.getElement("label").set("html",n.display),u.getElement("label").set("for",b),n.selected&&u.getElement("input").set("checked","checked"),r.required&&(u.getElement("input").set("data-validate-method","multiChecked"),i.addClass("validate")),t.getElement(".pairs").adopt(u)}),t.getElement(".template").destroy(),t.getElement(".pairs").set("id",n.Name);break;case"RadioGroup":k=JSON.parse(n.ValueAsString),Array.each(k,function(f){b=String.uniqueID(),u=t.getElement(".template").clone(),u.removeClass("template"),u.removeClass("hidden"),u.getElement("input").set("value",f.value),u.getElement("input").set("id",b),u.getElement("input").set("name",n.Name),u.getElement("label").set("html",f.display),u.getElement("label").set("for",b),f.selected&&u.getElement("input").set("selected","selected"),r.required&&(u.getElement("input").set("data-validate-method","radioSelected"),i.addClass("validate")),t.getElement(".pairs").adopt(u)}),t.getElement(".template").destroy(),t.getElement(".pairs").set("id",n.Name);break;case"CheckBox":r.required&&(i.set("data-validate-method","checked"),i.addClass("validate")),(n.Value||n.ValueAsString.toLowerCase()=="true")&&(i.checked=!0);break;case"Drawpanel":typeOf(n.Layout.BgImages)=="array"&&n.Layout.BgImages.length>0&&(d=[],g=[],nt=[],tt=[],Array.each(n.Layout.BgImages,function(n){d.push(n.name),g.push(n.image),nt.push(n.width),tt.push(n.height)}),i.set("data-bg-names",d.join("||")),i.set("data-bg-images",g.join("||")),i.set("data-bg-image-widths",nt.join("||")),i.set("data-bg-image-heights",tt.join("||")));break;case"BankNumber":i.value=n.ValueAsString;break;case"TaxNumber":i.value=n.ValueAsString;break;case"Address":i.value=n.ValueAsString}try{a=i.get("tag")}catch(ot){a=t.get("tag")}return r.readonly&&(a==="select"||a==="input"||a==="textarea")&&(i.hasClass("widget")||i.hasClass("has-dependencies")||i.erase("id"),i.getAttribute("type")==="text"&&r.readonly===!0?Affinity.mobile?(i.set("readonly","readonly"),i.set("style",(Affinity.DarkMode?"background:#2f2f2f;color:#ccc;":"background:#efefef;color:black;")+"text-decoration none;border:none;font-size:inherit;")):i.set("disabled","disabled"):i.set("disabled","disabled")),t}},readField:function(n,t){var r,i,u;if(typeOf(t)==="null"||typeOf(n)!=="object")return n;t.get("data-widget")&&(u=t.retrieve("widget"),n=u.returnDocument());switch(n.ElementType){case"WorkflowButton":n.Value.Pressed=this.buttonClickedName==n.Name?!0:!1;break;case"TextInput":case"Memo":case"EmailInput":case"DatePickerInput":n.Value=t.value,n.ValueAsString=t.value;break;case"CurrencyInput":case"FloatInput":n.Value=parseFloat(t.value),n.ValueAsString=t.value;break;case"IntegerInput":n.Value=parseInt(t.value),n.ValueAsString=t.value;break;case"DropDownBoxInput":r=t.value,i=[],Array.each(t.getElements("option"),function(n){i.push({display:n.get("html"),value:n.value,selected:n.value==r?!0:!1})}),Array.each(i,function(n,r){n.display===""&&n.value===""?i.splice(r,1):n.display===""&&n.value==="0"&&t.value==="0"&&n.selected===!1&&(n.selected=!0)}.bind(this)),n.Value=i,n.ValueAsString=JSON.stringify(i);break;case"MultiCheckBox":i=[],Array.each(t.getElements(".check-label-pair"),function(n){i.push({display:n.getElement("label").get("html"),value:n.getElement("input").value,selected:n.getElement("input").checked?!0:!1})}),n.Value=i,n.ValueAsString=JSON.stringify(i);break;case"RadioGroup":i=[],Array.each(t.getElements(".radio-label-pair"),function(n){i.push({display:n.getElement("label").get("html"),value:n.getElement("input").value,selected:n.getElement("input").checked?!0:!1})}),n.Value=i,n.ValueAsString=JSON.stringify(i);case"CheckBox":switch(n.InputType){case"Integer":t.checked&&(n.Value=parseInt(t.value),n.ValueAsString=t.value);break;default:t.checked?(n.Value=!0,n.ValueAsString="true"):(n.Value=!1,n.ValueAsString="false")}break;case"FieldEdit":r=t.value,n.ValueAsString=r;switch(n.InputType){case"Float":case"Double":r!==!1&&(n.Value=parseFloat(r));break;case"Integer":r!==!1&&(n.Value=parseInt(r));break;default:r!==!1&&(n.Value=r)}}return delete r,delete i,n}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosTemplateLoad={Version:"1.0.0.0",Sequence:10110,Name:"Zelos Template Load",File:"ui.zelos.template.load.js",Jira:"",Notes:""},ZelosTemplateLoad=new Class({Implements:[Options,Events],Binds:["loadTemplate","templateLoaded","loadFailed","cancel"],options:{},initialize:function(n){this.setOptions(n);var t=new Date;log("&#x2794; attempting ZelosLoader template load (0) ..."),this.formTemplateRequest=new Request.JSON({method:"get",timeout:12e4,onRequest:function(){log("&#x2794; ZelosLoader template load requested ("+t.elapsed()+") - "+this.logUrl+" ...",{color:"blue"}),this.fireEvent("request",this.formTemplateRequest.options.url)}.bind(this),onFailure:function(n){var i="",r;switch(n.status){case 401:i="Api unauthorized.";break;case 404:i="API path not found.";break;case 500:try{r=JSON.decode(n.responseText)}catch(u){r=!1,i=n.responseText}r&&(i=r.error?r.error:n.responseText),delete r;break;default:i=n.statusText}i.contains(401)||i.toLowerCase().contains("unauthorized")?(log("&#x270B; attempted ZelosLoader template load unauthorized &#x270B;",{color:"red"}),window.fireEvent("unauthorized"),this.loadFailed(i)):(log("&#x2718; attempted ZelosLoader template load failed ("+t.elapsed()+") - "+this.logUrl+" - "+i,{color:"red"}),this.loadFailed(i)),delete i}.bind(this),onError:function(n){log("&#x2718; attempted ZelosLoader template load failed with errors ("+t.elapsed()+") - "+this.logUrl+" - "+n,{color:"red"}),this.loadFailed(n)}.bind(this),onException:function(n,i){log("&#x2718; attempted ZelosLoader template load failed with exception ("+t.elapsed()+") - "+this.logUrl+" - "+n+": "+i,{color:"red"}),this.loadFailed("Exception on "+n+": "+i)}.bind(this),onTimeout:function(){log("&#x2718; attempted ZelosLoader template load timed out ("+t.elapsed()+") - "+this.logUrl,{color:"red"}),this.loadFailed("Load reached timeout limit.")}.bind(this),onSuccess:function(n){JSON.Unauthorized(n,"Zelos Loader, initialize - "+this.formTemplateRequest.url)||(n.error?typeOf(n.error)==="object"?(log("&#x2718; attempted ZelosLoader template load succeeded with errors ("+t.elapsed()+") - "+this.logUrl+" - "+JSON.stringify(n.error),{color:"red"}),this.loadFailed(JSON.stringify(n.error))):(log("&#x2718; attempted ZelosLoader template load succeeded with errors ("+t.elapsed()+") - "+this.logUrl+" - "+n.error.split("\r\n").join(", "),{color:"red"}),this.loadFailed(n.error.split("\r\n").join("<br />"))):(log("&#x2714; attempted ZelosLoader template load succeeded ("+t.elapsed()+") - "+this.logUrl,{color:"green"}),this.templateLoaded(n)))}.bind(this)})},attemptUrl:"no url set",loadFailed:function(n){this.formTemplateRequest.isRunning()&&this.formTemplateRequest.cancel(),this.fireEvent("error",n),ga&&ga("send","event","Zelos","FormTemplate","load failed ("+this.attemptUrl+")")},loadTemplate:function(n){this.attemptUrl=n,this.attemptUrl.contains("ran")||(this.attemptUrl=Affinity.GetCacheSafePath(this.attemptUrl)),this.formTemplateRequest.url=this.formTemplateRequest.options.url=this.attemptUrl,this.formTemplateRequest.send()},templateLoaded:function(n){typeOf(n.success)==="boolean"&&n.success===!1?this.loadFailed():(this.template=n,this.fireEvent("complete",this.template),ga&&ga("send","event","Zelos","FormTemplate","From Loaded ("+this.attemptUrl+")"))},isRunning:function(){return this.formTemplateRequest&&this.formTemplateRequest.isRunning()?!0:!1},cancel:function(){this.formTemplateRequest&&this.formTemplateRequest.isRunning()&&this.formTemplateRequest.cancel(),this.fireEvent("cancel","Form was canceled.")},destroy:function(){}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosTemplateProcess={Version:"1.0.2.0",Sequence:10120,Name:"Zelos Template Process",File:"ui.zelos.template.process.js",Jira:"",Notes:"Fix mandatory field validation for Timesheets"},ZelosTemplateProcess=new Class({Implements:[Options,Events],Binds:["processTemplate","writeField","readField","readDirectValue","submit","cancel","cancelForm","validationFailed","onPost","updateDocument","sanatisePostJson","validationPassed","postFailed","postSuccess","getLookupDependancies","setLookupDependancies","processChild","selectedRowsFromDetailedView","updateSelectedRows","submitSelectedRowsOnly","allowHorizontalScrollingForMobile"],options:{getApi:null,putApi:null,getEmptyTimesheetApi:null,insertAddTimesheetForm:!0,target:document.body,viewOnly:!1,frameless:!1,dateDisplayFormat:"%a %e %b %Y",allowHorizontalScrollingForMobile:!1,operationType:""},fieldProcessor:!1,hasValidation:!1,processorId:!1,initialize:function(n){if(this.setOptions(n),this.processorId=String.uniqueID(),this.icons={},this.icons.save=Affinity.icons.Save||"&#xe093;",this.icons.cancel=Affinity.icons.Cancel||"&#xe070;",Affinity.zelos.Elements==null)throw new ZelosError("Zelos HTML Elements must be compiled. See ui.zelos.init.js");if(!this.options.viewOnly&&this.options.putApi==null)throw new ZelosError("Zelos needs a put API path in options.");this.target=this.options.target,this.allowHorizontalScrollingForMobile=n.allowHorizontalScrollingForMobile,this.fieldProcessor=new ZelosProcessFileds({zelosProcessor:this})},getValue:function(n){return this.fieldProcessor?this.fieldProcessor.getValue(n):!1},getAttributes:function(n){return this.fieldProcessor?this.fieldProcessor.getValue(n):!1},getLookupDependancies:function(n){return this.fieldProcessor?this.fieldProcessor.getLookupDependancies(n):!1},setLookupDependancies:function(n,t,i){this.fieldProcessor&&this.fieldProcessor.setLookupDependancies(n,t,i)},processTemplate:function(n){var i,t;typeOf(n)=="string"&&(n=JSON.encode(n)),typeOf(n)==="object"&&(this.template=n,this.fieldProcessor.template=n,i=n,typeOf(i.Children)=="array"&&(i.Children.sort(function(n,t){return parseInt(n.Layout.Rank,10)-parseInt(t.Layout.Rank,10)}),Array.each(i.Children,this.processSection.bind(this))),t=this.options.target.getElements(".zelos-button"),t===undefined&&(t=this.options.target.getElements(".timesheet-button")),t.length>0?(this.form=new Element("form"),this.form.adopt(this.target.getChildren()),this.form.inject(this.target),this.form.set("autocomplete","off"),this.buttonBox=this.options.target.getElement(".form-row.buttons"),this.loaderBox=new Element("div",{"class":"form-row hidden"}).adopt(new Element("img",{src:Affinity.loaders.light})).inject(this.buttonBox,"after"),this.errorScroll=new Fx.Scroll(window),this.validation=new UIFormValidation({target:this.form,onPost:this.onPost,onValidateFailCallback:this.validationFailed,onValidateCallback:this.validationPassed}),t.addEvent("click",function(n){var t=n.target.hasClass("zelos-button")?n.target:n.target.getParent(".zelos-button");t.get("data-type")&&(t.get("data-type")!=="Cancel"?(this.buttonClickedName=t.get("data-name"),this.submit(n)):this.cancelForm())}.bind(this))):(this.form=this.target,this.form.set("autocomplete","off")),this.options.frameless,Array.each(this.form.getElements(".has-dependencies"),function(n){n.retrieve("dependencies").setEvents()}),Affinity.formhideables&&Affinity.formhideables.processNew(),Affinity.tooltips&&Affinity.tooltips.processNew(),Affinity.lookups&&Affinity.lookups.processNew({jsonp:!0,operationType:this.options.operationType}),Affinity.displaylookups&&Affinity.displaylookups.processNew({jsonp:!0}),Affinity.uiDrawPanels&&Affinity.uiDrawPanels.processNew(),this.fireEvent("complete",this.options.target))},submit:function(n){document.getElements(".error").removeClass("error"),document.getElements(".errorstr").destroy(),this.loaderBox&&this.loaderBox.removeClass("hidden"),this.buttonBox&&this.buttonBox.addClass("hidden"),this.buttonClicked=n.target.hasClass("button")?n.target:n.target.getParent(".button");var i=this.buttonClicked.hasClass("zelos-button")?!0:!1,t=!0;this.options.beforSave&&(t=this.options.beforSave({button:this.buttonClicked})),t?this.validation?this.validation.validate(i):this.validationPassed():(this.loaderBox&&this.loaderBox.addClass("hidden"),this.buttonBox&&this.buttonBox.removeClass("hidden"))},cancel:function(){this.cancelForm()},cancelForm:function(){this.fireEvent("cancel")},validationFailed:function(n){this.fireEvent("saveError",{errors:n}),function(){this.buttonBox&&this.buttonBox.removeClass("hidden"),this.loaderBox&&this.loaderBox.addClass("hidden"),document!=undefined&&document!=null&&document.getElement(".errorstr")!=null&&this.errorScroll.toElement(document.getElement(".errorstr").getParent(".form-row"))}.delay(1e3,this)},onPost:function(){this.loaderBox.removeClass("hidden"),this.buttonBox.addClass("hidden")},updateDocument:function(){var n=Object.clone(this.template);return n.Children&&typeOf(n.Children)=="array"&&Array.each(n.Children,function(t,i){t.Children&&typeOf(t.Children)=="array"&&Array.each(t.Children,function(t,r){this.readField(n,i,r,t)}.bind(this))}.bind(this)),n},sanatisePostJson:function(n){var t=JSON.encode(n);return t=t.replace(new RegExp("&amp;","gi"),"%26"),t=t.replace(new RegExp("&","gi"),"%26"),escape(t)},validationPassed:function(){var n=this.updateDocument(),t;this.fireEvent("validated",{document:n,buttonClicked:this.buttonClicked}),this.options.putApi!=="none"&&(t=this.sanatisePostJson(n),new Request.JSON({method:"POST",url:this.options.putApi,onFailure:this.postFailed,onError:this.postFailed,onSuccess:this.postSuccess}).post("="+t))},postFailed:function(){this.loaderBox&&this.loaderBox.addClass("hidden"),this.buttonBox&&this.buttonBox.removeClass("hidden"),this.fireEvent("saveError")},postSuccess:function(n){var t,u,f,e;if(typeOf(n)=="string"&&(n=JSON.decode(n)),typeOf(n)!="object")throw new ZelosError("returned Json is not a valid object");this.loaderBox&&this.loaderBox.addClass("hidden"),this.buttonBox&&this.buttonBox.removeClass("hidden");var o="cleverform",i=!1,r=[];n.Attribute&&n.Attribute.IsError&&(r.push(n.Attribute.ErrorMessage),i=!0),n.error!=undefined&&n.success===!1&&(r.push(n.error),i=!0),n.Children&&Array.each(n.Children,function(s){s.Attribute&&s.Attribute.IsError&&(r.push(s.name+": "+s.Attribute.ErrorMessage),i=!0),Array.each(s.Children,function(s){if(s.ElementType&&s.ElementType==="TimesheetTable"){if(o="timesheets",s.Attribute&&s.Attribute.IsError){if(i){window.fireEvent("processorDocumentError",{document:n,processorId:this.processorId});return}i=!0}}else s.Attribute&&s.Attribute.IsError&&(i=!0,t=document.id(s.Name)?document.id(s.Name):!1,t?(t.get("data-widget")?(u=t.retrieve("widget"),u&&"processErrors"in u&&(f=t.retrieve("widget").processErrors(n)),f.length>0?(i=!0,e=f.join(", ")):e=s.Attribute.ErrorMessage):(t.getPrevious("label,.lable")?t=t.getPrevious("label,.lable"):t.getParent().getElement("label,.lable")&&(t=t.getParent().getElement("label,.lable")),e=s.Attribute.ErrorMessage),t.addClass("error"),t.hasClass("suppress-errors")||new Element("div",{"class":"errorstr",html:e}).inject(t,"before")):r.push(s.Name+": "+s.Attribute.ErrorMessage))}.bind(this))}.bind(this)),i?(o=="timesheets"&&window.fireEvent("processorDocumentError",{document:n,processorId:this.processorId}),r.length>0?this.fireEvent("saveError","<br />"+r.join("<br />")):this.fireEvent("saveError","")):(this.fireEvent("save",n),window.fireEvent("processorDocumentSaved",{document:n,processorId:this.processorId})),delete t,delete u,delete f,delete i,delete r},processChild:function(n,t,i,r){var u,f;return i=typeOf(i)==="null"?null:i,u=this.fieldProcessor.returnField(n,t,r),Affinity.mobile&&this.allowHorizontalScrollingForMobile&&(f=u.getElement(".section-table"),f.addClass("ui-mobile-table-overflow")),i!==null&&u&&(i.getElement(".default-form").adopt(u),u.fireEvent("inDom")),u},processSection:function(n,t){if(n.ElementType=="SectionHeading"){if(n.Attribute&&n.Attribute.IsHidden)return;var r=!1,i=Affinity.zelos.getElementFromData(n);this.options.frameless&&i.addClass("frameless"),this.options.target.adopt(i),i.getElement(".section-title").set("html",n.Description.ShortText),n.Layout&&n.Layout.HideTitle&&i.getElement(".section-header")&&i.getElement(".section-header").addClass("hidden"),typeOf(n.Children)=="array"&&(n.Children.sort(function(n,t){return parseInt(n.Layout.Rank,10)-parseInt(t.Layout.Rank,10)}),Array.each(n.Children,function(n,u){n.ElementType&&n.ElementType=="WorkflowButton"&&(r=!0),this.processChild(n,u,i,t)}.bind(this))),typeOf(n.Layout.HideMessage)==="null"||n.Layout.HideMessage||i.getElement(".required-message").removeClass("hidden"),i.getElement(".required")&&r&&new Element("div",{"class":"form-row buttons"}).inject(i.getElement(".required-message"),"after").adopt(i.getElements(".button-wrapper")),n.Layout.IsHideable&&i.addClass("is-hideable").addClass("ui-hideable-id-"+n.Name.trim().toLowerCase().replace(/ /g,"-"))}},readDirectValue:function(n,t){return this.fieldProcessor.readField(n,t)},writeField:function(n,t){this.fieldProcessor.writeField(n,t)},readField:function(n,t,i,r,u){if(typeOf(u)==="null"&&(u=this.form),!(Affinity.mobile&&r.Name.toString().indexOf("TsCode")>-1)&&u.getElement("#"+r.Name)){var f=u.getElement("#"+r.Name);this.buttonClickedName&&(this.fieldProcessor.buttonClickedName=this.buttonClickedName),n.Children[t].Children[i]=this.fieldProcessor.readField(r,f),delete f}}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosViewSettings={Version:"1.0.4.0",Sequence:10500,Name:"Timesheet View Settings",Description:"Used to keep state between view and user switching",File:"ui.zelos.view.settings.js",Jira:"",Notes:""},ZelosViewSettings=new Class({Binds:["set","get","unset","setProfileData","setProfile","getProfile","unsetProfile","unsetProfileData","setFilterData","setFilter","getFilter","unsetFilter","unsetFilterData","reset"],name:"",employeeNumber:"",startDate:!1,fromDat:!1,toDate:!1,profileData:{},filterData:{employee:!1,fromDate:!1,toDate:!1,period:!1,payPoint:!1,excludeLocked:!1,onlyManaged:!1,forceReload:!1},lastUpdated:!1,lastView:!1,currentView:!1,profile:{set:function(){},get:function(){},unset:function(){}},filter:{set:function(){},get:function(){},unset:function(){}},initialize:function(){"Affinity"in window||(window.Affinity={}),"viewSettings"in Affinity||(Affinity.viewSettings=this),this.profile.set=this.setProfile,this.profile.get=this.getProfile,this.profile.unset=this.unsetProfile,this.filter.set=this.setFilter,this.filter.get=this.getFilter,this.filter.unset=this.unsetFilter,this.lastUpdated=new Date},set:function(n,t){this[n]=t,this.lastUpdated=new Date},get:function(n){return this[n]?this[n]:!1},unset:function(n){this[n]=!1,this.lastUpdated=new Date},setProfileData:function(n){this.profileData=Object.clone(n),this.lastUpdated=new Date},setProfile:function(n){for(n in this.profileData)this.profileData(n);this.lastUpdated=new Date},getProfile:function(n){return this.profileData[n]?this.profileData[n]:!1},unsetProfile:function(n){this.profileData[n]=!1,this.lastUpdated=new Date},unsetProfileData:function(){for(key in this.filterData)this.unsetFilter(key);this.lastUpdated=new Date},setFilter:function(n,t){this.filterData[n]=t,this.lastUpdated=new Date},getFilter:function(n){return this.filterData[n]?this.filterData[n]:!1},unsetFilter:function(n){this.filterData[n]=!1,this.lastUpdated=new Date},unsetFilterData:function(){for(key in this.filterData)this.unsetFilter(key);this.lastUpdated=new Date},reset:function(){for(key in this)key!=="filterData"&&typeOf(this[key])!=="function"&&typeOf(this[key])!=="object"&&this.unset(key);return this.unsetProfileData(),this.unsetFilterData(),!0},log:function(n){console.log(""),console.log("////////////////////////////////////////////////////////////////////////////////////////////"),console.log(n),console.log(Affinity.login.userProfiles.hasOwnProperty(Affinity.viewSettings.employeeNumber)?Affinity.login.userProfiles[Affinity.viewSettings.employeeNumber].commonName:"(No Profile Yet)",Affinity.viewSettings.employeeNumber),console.log(Affinity.viewSettings.startDate.clone()),console.log(JSON.stringify(Affinity.viewSettings.filterData,null,2)),console.log("////////////////////////////////////////////////////////////////////////////////////////////"),console.log("")}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosAwardModal={Version:"1.0.10.0",Sequence:10320,Name:"Timesheet Award Modal (Zelos Widget)",Description:"Detail view calc popup",File:"ui.zelos.widget.awards.modal.js",Jira:"",Notes:"fix award text path"},ZelosAwardModal=new Class({debug:!1,Implements:[Options,Events],Binds:["set","render","close","_retuirnApiFromRow","_returnEmployeeNoFromRow","_returnEmployeeNameFromRow","_returnDateFromRow","_isRowGood","_getAwards","_gotAwards","_setPosition","_startDrag","_drag","_stopDrag","_clearDragEvents","_closed"],options:{row:!1,user:"",date:"",iconData:[],returnRowMethod:!1,isDraggable:!0,startPosition:{x:!1,y:!1},isOpen:!1},initialize:function(n){var t,i,r;if(!Affinity.isAwardsPopupEnabled())return!1;this.setOptions(n),Affinity.hasOwnProperty("AwardModels")||(Affinity.AwardModels={Widgets:[],closeAll:function(){Affinity.AwardModels.Widgets.forEach(function(n){n&&n.hasOwnProperty("close")&&typeof n.close=="function"&&n.close()})}}),Affinity.AwardModels.Widgets.push(this),t="",t+="<h2>Timesheet Information<\/h2>",this.baseLang=Affinity.languages.english.features,this.baseAppLang=Affinity.languages.english.application.timesheets,this.container=new Element("div",{"class":"ts-award-box",html:t}),this.userInfoBox=new Element("div",{"class":"ts-award-user-info"}).inject(this.container),this.awardBox=new Element("div",{"class":"ts-award-message hidden"}).inject(this.container),this.spinner=new Element("div",{"class":"ts-award-loader newloader hidden"}).inject(this.container),this.detailsBox=new Element("div",{"class":"ts-award-details-box section"}).inject(this.container),this.table=new Element("table",{"class":"ui-grid timesheet"}).inject(this.detailsBox),i=new Element("thead").inject(this.table),this.thead=new Element("tr").inject(i),this.tbody=new Element("tbody").inject(this.table),r=new Element("tfoot").inject(this.table),this.tfoot=new Element("tr").inject(r),this.spinner.innerHTML='<svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg"><circle class="circle" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"><\/circle><\/svg>',this.loader=new Request.JSON({onSuccess:this._gotAwards}),this.render(),this.debug&&(console.info("award modal trace (init):"),console.trace())},set:function(n){if(!Affinity.isAwardsPopupEnabled())return!1;this.setOptions(n),this.render(),this.debug&&(console.info("award modal trace (set):"),console.trace())},render:function(){if(!Affinity.isAwardsPopupEnabled())return!1;this.thead.empty(),this.tbody.empty(),this.tfoot.empty(),this.spinner.classList.remove("hidden");var n="",t="",i=!1;try{i=Date.parse(this._returnDateFromRow())}catch(r){}n+='<span class="user">',n+=this._returnEmployeeNameFromRow(),n+="<\/span>  ",n+='<span class="date">',i&&(n+=i.format("%a %e%o of %b, %Y")),n+="<\/span>",this.options.iconData.forEach(function(n){t+=n.trim()+"<br />"}),t+="<br />",this.awardBox.innerHTML=t,this.userInfoBox.innerHTML=n,Affinity.uiModal.setClass("ui-new-modal"),Affinity.uiModal.adopt(this.container),Affinity.uiModal.show(),this._clearDragEvents(),this.options.isDraggable&&!Affinity.mobile?(Affinity.uiModal.modal.classList.add("draggable"),Affinity.uiModal.modalbg.addClass("hidden"),Affinity.uiModal.modal.addEventListener("mousedown",this._startDrag),Affinity.uiModal.afterClose=this._closed):(Affinity.uiModal.modal.classList.remove("draggable"),Affinity.uiModal.modalbg.addClass("opaque")),this.options.startPosition.x&&this.options.startPosition.y?Affinity.uiModal.modal.classList.add("positioned"):Affinity.uiModal.modal.classList.remove("positioned"),this._setPosition(),this._getAwards(),this.isOpen=!0},close:function(){Affinity.uiModal.afterClose=this._closed,Affinity.uiModal.hide(),this.isOpen=!1},_retuirnApiFromRow:function(){var t=Date.parse(this.options.row.dataset.date),i=this.options.row.dataset.employeeNo,r=this.options.row.dataset.timesheetId,n="";return n+=Affinity.zelosroot+"?api=TimesheetPayTrans/GetPayTransForDate",n+="&fromDate="+t.format("%d.%b.%Y"),n+="&toDate="+t.format("%d.%b.%Y"),n+="&employeeNo="+i,n+"&view=daydetail"},_returnEmployeeNoFromRow:function(){return this.options.row.dataset.employeeNo||Affinity.login.profile.employeeNumber},_returnEmployeeNameFromRow:function(){return this.options.row.dataset.employeeName||Affinity.login.profile.commonName},_returnDateFromRow:function(){return this.options.row.dataset.date||!1},_isRowGood:function(n){var t=!1,i=this._returnEmployeeNoFromRow().toString().trim();return n.Children.forEach(function(n){if(n.Name&&n.Name.test(new RegExp("EmployeeNo","gi"))&&n.ValueAsString.toString().trim()===i)return t=!0}.bind(this)),t},_gotAwards:function(n){var u=[],f=!0,e=0,t,i,r,o;this.thead.empty(),this.tbody.empty(),this.tfoot.empty(),n.hasOwnProperty("Children")&&n.Children[0].Children[0].hasOwnProperty("Children")&&(u=n.Children[0].Children[0].Children),u.length>0?(u.forEach(function(n){this._isRowGood(n)&&typeof this.options.returnRowMethod=="function"&&(n.Attribute.IsReadOnly=!0,t=this.options.returnRowMethod(n,!1,"awards"),i=t.querySelector(".col-id-TsDate"),r=t.querySelector(".col-id-RowButton"),i&&(i.classList.remove("active"),i.classList.add("hidden")),r&&(r.classList.remove("active"),r.classList.add("hidden")),this.tbody.adopt(t),f&&(f=!1,n.Children.forEach(function(n){o=n.Attribute.IsHidden||n.Name.test(new RegExp("TsDate|Button","gi"))?!0:!1,this.thead.adopt(new Element("th",{"class":o?"hidden":"active",html:n.Description.ShortText}))}.bind(this)),this.tfoot.adopt(new Element("th",{colspan:t.querySelectorAll(".active").length}))),e++)}.bind(this)),e===0&&this.tbody.adopt(new Element("tr").adopt(new Element("tr",{html:this.baseAppLang.features.awards.noawards}))),Affinity.tooltips&&Affinity.tooltips.processNew(),Affinity.uiGrid&&Affinity.uiGrid.zebra(this.table,"timesheet-row"),Affinity.lookups&&Affinity.lookups.processNew({jsonp:!0}),Affinity.displaylookups&&Affinity.displaylookups.processNew({jsonp:!0})):this.tbody.adopt(new Element("tr").adopt(new Element("tr",{html:this.baseAppLang.features.awards.noawards}))),this.spinner.classList.add("hidden"),this._setPosition()},_getAwards:function(){if(!Affinity.isAwardsPopupEnabled)return!1;var n=this._retuirnApiFromRow();this.loader.isRunning()&&this.loader.cancel(),this.loader.url=n,this.loader.options.url=n,this.loader.get()},_setPosition:function(){if(isNaN(this.options.startPosition.x+this.options.startPosition.y))Affinity.uiModal.position();else{var t=Math.max(document.documentElement.clientHeight,window.innerHeight||0),n=this._getHeight(Affinity.uiModal.modal);Affinity.uiModal.modal.style.top=this.options.startPosition.y+n>t?this.options.startPosition.y-40-n+"px":this.options.startPosition.y+"px",Affinity.uiModal.modal.style.left=this.options.startPosition.x+"px"}},_getHeight:function(n){var t=n.getBoundingClientRect();return t.height},_getMouseX:function(n){return n.pageX?n.pageX:n.clientX?n.clientX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft):null},_getMouseY:function(n){return n.pageY?n.pageY:n.clientY?n.clientY+(document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop):null},_offsetTop:!1,_offsetLeft:!1,_startDrag:function(n){this._clearDragEvents(),this._offsetTop=this._getMouseY(n),this._offsetLeft=this._getMouseX(n),Affinity.uiModal.modal.classList.add("dragging"),window.addEventListener("mousemove",this._drag),window.addEventListener("mouseup",this._stopDrag),n.preventDefault(),n.stopPropagation()},_drag:function(n){var i=this._getMouseX(n),r=this._getMouseY(n),t=Affinity.uiModal.modal;(i!=this._offsetLeft||r!=this._offsetTop)&&(t.style.top=parseInt(t.style.top)+(r-this._offsetTop)+"px",t.style.left=parseInt(t.style.left)+(i-this._offsetLeft)+"px",this._offsetTop=r,this._offsetLeft=i)},_stopDrag:function(){this._clearDragEvents(),this.options.isDraggable&&!Affinity.mobile&&Affinity.uiModal.modal.addEventListener("mousedown",this._startDrag)},_clearDragEvents:function(){Affinity.uiModal.modal.removeEventListener("mousedown",this._startDrag),Affinity.uiModal.modal.classList.remove("dragging"),window.removeEventListener("mousemove",this._drag),window.removeEventListener("mouseup",this._stopDrag),this._offsetTop=!1,this._offsetLeft=!1},_closed:function(){this._clearDragEvents(),Affinity.uiModal.modal.classList.remove("positioned"),Affinity.uiModal.modal.classList.remove("draggable")}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidget={Version:"1.0.0.0",Sequence:10150,Name:"Zelos Widget Base",File:"ui.zelos.widget.base.js",Jira:"",Notes:""},ZelosWidget=new Class({Implements:[Options,Events],Binds:[""],options:{parentDocument:null,parentSectionIndex:null,parentChildIndex:null,widgetDocument:null,target:null,processor:null},initialize:function(n){this.setOptions(n),this.target=this.options.target()},returnDocumnent:function(){return this.options.widgetDocument},returnParentDocument:function(){return this.options.parentDocument},processErrors:function(){return[]},showLoader:function(n){var i=n||"data",t;this.target.getElement("section")||(t="",t+='<div class="section shadow "><div class="section-body"><div class="section-row">',t+='Loading Timesheets <img src="'+Affinity.loaders.light+'" />',t+="<\/div><\/div><\/div>",this.target.set("html",t).removeClass("hidden"))},clear:function(){this.target.empty().removeClass("hidden")}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetDependancy={Version:"1.0.4.0",Sequence:10170,Name:"Dependency (Zelos Widget)",File:"ui.zelos.widget.dependancy.js",Jira:"",Notes:"Added default selection checks"},ZelosWidgetDependancyQueue=new Class({Implements:[Options,Events],Binds:["destroyLoader","add","remove","refreshQueue","cancelQueue","process","processCont","loadComplete","loadFailed"],options:{jsonp:!0},enabled:!1,initialize:function(n){this.setOptions(n),Affinity.UI||(Affinity.UI={}),Affinity.UI.dependancies||(Affinity.UI.dependancies={}),Affinity.UI.debug||(Affinity.UI.debug={}),Affinity.UI.debug.dependancyKeys||(Affinity.UI.debug.dependancyKeys=[]),Affinity.UI.dependancyLoaders=[],this.loadCount=0,window.addEvent("refreshQueues",this.refreshQueue),window.addEvent("loggedout",this.cancelQueue),window.addEvent("loggedin",function(){log("! dependency queue enabled !"),this.enabled=!0}.bind(this))},getApiKey:function(n){var o=new URI(n.toLowerCase()),s=o.get("query").parseQueryString(),i=[],u=[],t=!1,f="",r,e;return Object.each(s,function(n,r){r.toLowerCase()!=="ran"&&(r!=="parameters"?i.push(r+"-"+n):t=JSON.parse(n))}),i=i.sort(),t&&typeOf(t)==="object"&&"parameter"in t&&typeOf(t.parameter)==="array"&&(Array.each(t.parameter,function(n){r=[],Object.each(n,function(n,t){t.toLowerCase()!=="ran"&&r.push(t+"-"+n)}),r.sort(),u.push(r.join("|"))}),u.sort(),f="|parameters|"+u.join("||")),e=i.join("|")+f,e.replace(/\//g,"-")},remove:function(n,t){var i=this.getApiKey(n);Affinity.UI.dependancies[i].elements.splice(Affinity.UI.dependancies[i].elements.indexOf(t),1)},add:function(n,t){var i=this.getApiKey(n);t.set("data-dep-key",i),Affinity.UI.dependancies[i]?Affinity.UI.dependancies[i].elements.contains[t]||Affinity.UI.dependancies[i].elements.push(t):Affinity.UI.dependancies[i]={api:decodeURI(n),id:"depends_"+String.uniqueID(),type:"dependency",loaded:!1,massive:!1,elements:[t]},t.fireEvent("lookup")},refreshQueue:function(){this.enabled&&(this.loadCount=0,clearTimeout(this.processDelay),log("&#171; REFRESH ALL DEPENDANCIES &#187;"),this.enabled=!1,Array.each(Affinity.UI.dependancyLoaders,function(n,t){"cancel"in n&&n.cancel(),"removeEvents"in n&&n.removeEvents(),Affinity.UI.dependancyLoaders[t]=null}),Affinity.UI.dependancyLoaders=[],Object.each(Affinity.UI.dependancies,function(n,t){Affinity.UI.dependancies[t].loaded=!1,Affinity.UI.dependancies[t].data=null,delete Affinity.UI.dependancies[t].data}),this.enabled=!0,window.fireEvent("dependancyCacheClear"))},cancelQueue:function(){return this.loadCount=0,this.enabled=!1,clearTimeout(this.processDelay),Array.each(Affinity.UI.dependancyLoaders,function(n){"cancel"in n&&n.cancel(),"removeEvents"in n&&n.removeEvents(),n=null}),Affinity.UI.dependancyLoaders=[],Object.each(Affinity.UI.dependancies,function(n,t){Affinity.UI.dependancies[t].loaded=!1,Affinity.UI.dependancies[t].data=null,Affinity.UI.dependancies[t].elements=[],Affinity.UI.dependancies[t]=null,delete Affinity.UI.dependancies[t]}),Affinity.UI.dependancies={},!0},process:function(){this.loadCount=0;var n,t,i=new Date;try{Object.each(Affinity.UI.dependancies,function(i,r){if(this.enabled&&Affinity.UI.dependancies[r].loaded!=="loading...")if(Affinity.UI.dependancies[r].loaded===!0)this.loadComplete(r);else if(Affinity.UI.dependancies[r].loaded===!1){t=Affinity.UI.dependancies[r].api,Affinity.UI.dependancies[r].loaded="loading...";var u=new URI(t),f=u.parsed.query.parseQueryString();n=this.options.jsonp?new Request.JSONP({callbackKey:"jsoncallback",url:Affinity.GetCacheSafePath(t),method:"get",timeout:3e4,onRequest:function(){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&console.log("problem dependancy requested...")}.bind(this),onComplete:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy complete:"),console.log(r),console.log(n)),JSON.Unauthorized(n,Affinity.UI.dependancies[r].id)||("error"in n?n.error.test("limit","gi")?(Affinity.UI.dependancies[r].data=[],Affinity.UI.dependancies[r].massive=!0,Affinity.UI.dependancies[r].loaded=!0,this.loadComplete(r)):(this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1):(Affinity.mobile&&r.toLowerCase().indexOf("tscode")>-1&&(n=n.reverse()),Affinity.UI.dependancies[r].data=n,Affinity.UI.dependancies[r].loaded=typeOf(n)==="array"&&n.length>0?!0:!1,this.loadComplete(r)))}.bind(this),onError:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy failed:"),console.log(r),console.log(n)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this),onFailure:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy failed (xhr):"),console.log(r),console.log(n)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this),onTimeout:function(){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy timedout."),console.log(r)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this)}):new Request.JSON({url:Affinity.GetCacheSafePath(t),method:"get",timeout:3e4,onRequest:function(){}.bind(this),onSuccess:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy complete:"),console.log(r),console.log(n)),JSON.Unauthorized(n,Affinity.UI.dependancies[r].id)||("error"in n?n.error.test("limit","gi")?(Affinity.UI.dependancies[r].data=[],Affinity.UI.dependancies[r].massive=!0,Affinity.UI.dependancies[r].loaded=!0,this.loadComplete(r)):(this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1):(Affinity.UI.dependancies[r].data=n,Affinity.UI.dependancies[r].loaded=typeOf(n)==="array"&&n.length>0?!0:!1,this.loadComplete(r)))}.bind(this),onError:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy failed:"),console.log(r),console.log(n)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this),onFailure:function(n){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy failed (xhr):"),console.log(r),console.log(n)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this),onTimeout:function(){Affinity.UI.debug.dependancyKeys.indexOf(r)!==-1&&(console.log("problem dependancy timedout."),console.log(r)),this.loadFailed(r),Affinity.UI.dependancies[r].loaded=!1}.bind(this)}),n&&(Affinity.UI.dependancyLoaders.push(n),n.send())}}.bind(this))}catch(r){}},loadCount:0,loadComplete:function(n){Array.each(Affinity.UI.dependancies[n].elements,function(t){typeOf(t)!=="null"&&t.fireEvent("dependancyLoaded",{data:Affinity.UI.dependancies[n].data})}.bind(this)),this.loadCount++,this.loadCount===Affinity.UI.dependancies.length&&(window.fireEvent("AllDependanciesLoaded"),this.loadCount=0)},loadFailed:function(n){Array.each(Affinity.UI.dependancies[n].elements,function(t){typeOf(t)!=="null"&&t.fireEvent("dependancyFailed",{data:Affinity.UI.dependancies[n].data})}.bind(this))}}),Affinity.UI.dependancyQueue=new ZelosWidgetDependancyQueue,ZelosWidgetDependancy=new Class({Implements:[Options,Events],WidgetName:"Dependancy",Binds:["setTarget","processOptions","destroyLoader","getApiKey","doLookup","cancelLookup","lookupFailed","forceSetDefault"],eventsset:!1,options:{target:null,propertyName:"",modelName:"",dependancies:[],api:null},loader:!1,initialize:function(n){this.setOptions(n),this.dependancies=this.options.dependancies},target:!1,setTarget:function(){typeOf(this.target)!=="element"&&typeOf(this.options.target)==="string"&&document.id(this.options.target)&&(this.target=document.id(this.options.target)),this.target&&this.target.store("dependancy",this)},eventsset:!1,setEventAttempt:0,setEventAttemptDelay:250,setEventAttemptMax:10,setEventAttemptDelay:!1,setEvents:function(){this.setTarget();var n=!0;Array.each(this.dependancies,function(t){document.id(t.updateFromId)?document.id(t.updateFromId).hasEvent("change",this.doLookup)||document.id(t.updateFromId).addEvent("change",this.doLookup):(n=!1,clearTimeout(this.setEventAttemptDelay),this.setEventAttempt<this.setEventAttemptMax&&(this.setEventAttempt++,this.setEventAttemptDelay=this.setEvents.delay(this.setEventAttemptDelay,this)))}.bind(this)),n&&(this.eventsset=!0)},destroyLoader:function(){this.loader&&typeOf(this.loader)==="element"&&"destroy"in this.loader&&this.loader.destroy(),this.loader=!1},lookupFailed:function(n){this.setTarget(),this.cancelLookup();var t="There was an error getting these values.";typeOf(n)==="object"&&"error"in n&&(t=n.error),typeOf(n)==="object"&&"data"in n&&(n=n.data,typeOf(n)==="object"&&"error"in n&&(t=n.error)),this.target.adopt(new Element("span",{"class":"errormsg",html:t}))},api:!1,cancelLookup:function(){this.setTarget(),this.api&&(this.target.removeEvent("dependancyLoaded",this.processOptions),this.target.removeEvent("dependancyFailed",this.lookupFailed),Affinity.UI.dependancyQueue.remove(this.api,this.target)),this.destroyLoader(),this.target.empty(),this.target.removeClass("hidden")},getApiKey:function(n){return Affinity.UI.dependancyQueue.getApiKey(n)},lastKnownValue:null,doLookup:function(){var i,u,n,r,f,e,t;if(this.target){var o=typeOf(this.options.api)==="string"&&this.options.api!=""?this.options.api:Affinity.lookupapi,s=o.match(/lookup\/get/gi),h=o.replace(s[0],"lookup/GetConditional");this.lastKnownValue=this.target.value,this.cancelLookup(),i=this.target.get("tag").toLowerCase(),i!=="td"&&i!=="th"?this.target.addClass("hidden"):this.target.empty(),this.loader=this.target.getParent().getElement(".deploader")?this.target.getParent().getElement(".deploader"):i!=="td"&&i!=="th"?new Element("img",{src:Affinity.loaders.light,"class":"deploader"}).inject(this.target,"before"):new Element("img",{src:Affinity.loaders.light,"class":"deploader"}).inject(this.target),u=new URI(h),e=[],Array.each(this.dependancies,function(t){document.id(t.updateFromId)&&(n=document.id(t.updateFromId),r=n.value,f=r,n.get("data-lookup-api")&&n.get("data-default-value")&&(f=n.get("data-default-value")),Affinity.ignoreDependancyDefaults||typeOf(n.value)!=="null"&&n.value!==""?typeOf(n.value)==="null"&&(r=""):r=f,e.push({LinkType:"Dependency",ModelName:"Timesheet",PropertyName:t.updateFromPropertyName,ValueAsString:r}))}.bind(this)),t=u.parsed.query.parseQueryString(),t.propertyName=this.options.propertyName,t.modelName=this.options.modelName,t.parameters=JSON.stringify({Parameter:e}),"enableSelectLimit"in Affinity&&Affinity.enableSelectLimit&&(t.limit=Affinity.selectmax||1e3),u.parsed.query=Object.toQueryString(t),this.api=unescape(decodeURI(u.toString())),this.target.removeEvent("dependancyLoaded",this.processOptions),this.target.removeEvent("dependancyFailed",this.lookupFailed),this.target.addEvent("dependancyLoaded",this.processOptions),this.target.addEvent("dependancyFailed",this.lookupFailed),Affinity.UI.dependancyQueue.add(this.api,this.target),Affinity.UI.dependancyQueue.process()}},processOptions:function(n){var o,t,i,v,s,u,h,c,l,y,p,r,f,a,e,w;if(this.setTarget(),o=this.target.get("tag").toLowerCase(),this.target.removeEvent("dependancyLoaded",this.processOptions),this.target.removeEvent("dependancyFailed",this.lookupFailed),"data"in n&&(n=n.data),t=!1,i=this.target.value,i!=this.lastKnownValue&&(i=this.lastKnownValue),v=i,this.target.get("data-default-value")&&this.target.get("data-default-value")!==i&&(i=this.target.get("data-default-value")),s=Affinity.ignoreDependancyDefaults,u=!1,this.target.getParent("tr.timesheet-row")&&(u=this.target.getParent("tr.timesheet-row")),u&&!u.hasClass("new")&&(s=!1),u){for(h=!1,l=0;l<this.dependancies.length;l++)if(c=document.id(this.dependancies[l].updateFromId),!h&&c.get("data-default-value")&&c.get("data-default-value")!==c.value){h=!0;break}h&&(s=Affinity.ignoreDependancyDefaults)}y=i,this.target.get("tag")==="select"?(p=Affinity.UI.dependancyQueue.getApiKey(this.api),Affinity.UI.dependancies[p].massive&&n.length>Affinity.selectmax?this.target.addClass("massive").store("data-store","dependancies").store("data-key",p).store("data-value",i).store("data-label",i):(this.target.removeClass("massive").eliminate("data-store").eliminate("data-key").eliminate("data-label"),r=!1,Array.each(n,function(n,t){Affinity.mobile&&n.Value!==undefined&&n.Value!==null&&(n.Value=n.Value.replace(","," - ")),a=new Element("option",{value:n.Key,html:n.Value}).inject(this.target),s?t===0&&(r=n,f=a):(r||n.Key!==y||(r=n,f=a),typeof n.selected=="boolean"&&n.selected===!0&&(r=n,f=a))}.bind(this)),r!==!1&&(f.set("selected","selected"),f.defaultSelected=!0,v=r.Key,this.target.selectedIndex=n.indexOf(r),this.target.value=r.Key))):o==="input"||o==="textarea"?this.target.value=n[0].Value:this.target.set("html",n[0].Value),this.target.retrieve("widget")&&(t=this.target.retrieve("widget"),t.type==="autocomplete"&&t.revert()),o==="select"&&n.length>=Affinity.selectToAutoNum&&UIAutoComplete&&typeOf(UIAutoComplete)==="class"&&this.target.addClass("ui-autocomplete"),this.target.hasClass("ui-autocomplete")&&typeOf(UIAutoCompleteWidget)==="class"&&(this.target.removeClass("ui-autocomplete"),t=new UIAutoCompleteWidget({selectElement:this.target,onComplete:function(n){window.fireEvent("lookupComplete",n.displayElement)}})),t||window.fireEvent("lookupComplete",this.target),this.destroyLoader(),w=this.target.retrieve("dependencies"),Array.each(w.dependancies,function(n){document.id(n.updateThisId)&&(e=document.id(n.updateThisId),e.getWidget("elementWidget")&&(e.getWidget("elementWidget").reset(),e.fireEvent("change",{target:e})))}),this.target.fireEvent("lookupComplete",{defaultValue:v,value:y,target:this.target}),this.target.removeClass("hidden"),this.target.retrieve("widget")&&(t=this.target.retrieve("widget"),t.hasOwnProperty("forceDefaultSelection")&&t.addEvent("complete",this.forceSetDefault))},forceSetDefaultDelay:!1,forceSetDefault:function(){this.target.retrieve("widget")&&(widget=this.target.retrieve("widget"),widget.displayElement&&widget.displayElement!==this.target&&widget.displayElement.hasClass("hidden")&&widget.displayElement.removeClass("hidden"),clearTimeout(this.forceSetDefaultDelay),this.forceSetDefaultDelay=setTimeout(function(){widget.hasOwnProperty("forceDefaultSelection")&&(Affinity.ignoreDependancyDefaults||!widget.defaultValue||widget.isDefaultSelected()||widget.forceDefaultSelection()),widget.removeEvent("complete",this.forceSetDefault)}.bind(this),500))}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTable={Version:"1.0.4.0",Sequence:10160,Name:"Table (Zelos Widget)",File:"ui.zelos.widget.table.js",Jira:"",Notes:"Fix time sorting"},ZelosWidgetTable=new Class({Implements:[Options,Events],Binds:["beforeSort","afterSort","refresh","cleanName","returnParser","buildHeader","buildFooter","buildRows","buildRow","doTotals","doSearch","returnData","saveCSV","destroy"],options:{parentForm:null,parentDocument:null,parentSectionIndex:null,parentChildIndex:null,widgetDocument:null,target:null,zelosEngine:null,zelosProcessor:null,searchable:!0,sortable:!0},dissabled:!1,defaultSortReverse:!0,initialize:function(n){this.setOptions(n),this.gridID=String.uniqueID(),this.isTSStatsPage=new RegExp("statistics","gi").test(window.location.href)?!0:!1,this.seaction=new Element("div",{"class":"section-table"}).inject(this.options.target),this.table={},this.table.hidden=new Element("table",{"class":"hidden"}).inject(this.seaction),this.table.table=new Element("table",{"class":"zelos-table"}).inject(this.seaction),this.table.thead=new Element("thead").inject(this.table.table),this.options.searchable&&(this.table.filters=new Element("thead",{"class":"filters"}).inject(this.table.table)),this.table.tbody=new Element("tbody").inject(this.table.table),this.table.tfoot=new Element("tfoot").inject(this.table.table),this.table.saveButton=new Element("div",{"class":"button green w-icon large save-csv hidden",html:"<span>"+Affinity.icons.Save+"<\/span>Save as CSV"}).inject(this.options.target),this.table.saveButton.addEvent(Affinity.events.click,this.saveCSV),this.noRows=new Element("div",{"class":"no-rows hidden",html:"No results found"}).inject(this.options.target),Affinity.hasOwnProperty("sortgrids")||(Affinity.sortgrids={}),Affinity.sortgrids[this.gridID]=[],this.parserTimeKey="time_"+this.gridID;var t={},i=this;t[this.parserTimeKey]={match:/.*/,convert:function(){var n,i,t;if(this.get("text").trim().match(/[0-9]{2}:[0-9]{2}/))return n=(new Date).clearTime(),i=this.get("text").trim().split(":"),n.setHours(parseInt(i[0])),n.setMinutes(parseInt(i[1])),parseInt(n.getTime());if(t=Affinity.sortgrids,t[t.currentGridId][t.currentSortIndex].direction==="desc"){var n=new Date,r=parseInt((new Date).getFullYear()),u=r+50;return n.setYear(u),parseInt(n.getTime())}return 0},number:!0},HtmlTable.defineParsers(t),this.refresh(this.options.widgetDocument)},beforeSort:function(n){var t=n.target.get("tag")==="th"?n.target:n.target.getParent("th"),i=t.getParent("tr").getElements("th").indexOf(t);Affinity.sortgrids.currentGridId=this.gridID,Affinity.sortgrids.currentSortIndex=i},afterSort:function(){if(this.htmlTable&&this.htmlTable.hasOwnProperty("sorted")){var n=this.htmlTable.sorted,t=Affinity.sortgrids[this.gridID][n.index].direction;Affinity.sortgrids[this.gridID][n.index].direction=n.reverse?"desc":"asc",t===Affinity.sortgrids[this.gridID][n.index].direction&&this.htmlTable.sort(n.index,!n.reverse)}},refresh:function(n){this.table.totals={},this.table.thead.empty(),this.table.tbody.empty(),this.table.tfoot.empty(),this.columns=[],this.parsers=[];var t=n.Children;this.buildHeader(t),this.buildRows(t),this.buildFooter(),this.options.sortable&&(this.currentSort=this.parsers.indexOf("date"),this.htmlTable=new HtmlTable(this.table.table,{parsers:this.parsers,sortable:!0,sortIndex:this.currentSort,sortReverse:this.defaultSortReverse,classSortSpan:"icon",classSortable:"",classGroupHead:"",classGroup:"",classCellSort:"",onSort:this.afterSort.bind(this)}),this.table.table.store("HtmlTable",this.htmlTable)),this.rows=this.table.tbody.getElements("tr.row"),Affinity.prompts.hide()},cleanName:function(n){return n.hyphenate().replace(/-/g," ").trim().capitalize()},returnParser:function(n){var t="";switch(typeOf(n.InputType)!=="null"?n.InputType:""){case"String":case"BankNumber":case"TaxNumber":case"Address":t="string";break;case"Float":case"Integer":t="float";break;case"Currency":t="floatLax";break;case"Date":t="date";break;case"Time":t=this.parserTimeKey;break;default:t=""}return t==="string"&&n.hasOwnProperty("Source")&&(t=n.Source.hasOwnProperty("PropertyName")?n.Source.PropertyName.test(new RegExp("time","gi"))?t=this.parserTimeKey:"string":n.Name.test(new RegExp("time","gi"))?t=this.parserTimeKey:"string"),t},buildHeader:function(n){var t,i,u,r,f,o=new Element("tr").inject(this.table.thead),e;this.options.searchable&&(e=new Element("tr").inject(this.table.filters)),this.parsers=[],this.columns=[],Affinity.sortgrids[this.gridID]=[],Array.each(n,function(n){Array.each(n.Children,function(n){t=n.Source&&n.Source.PropertyName?n.Source.PropertyName:n.Name,i=this.cleanName(n.Name),this.isTSStatsPage&&(i=n.Description.ShortText),this.columns.contains(t)||(this.columns.push(t),u=this.returnParser(n),this.parsers.push(u),this.options.searchable&&(r=new Element("input",{type:"text",placeholder:"Filter"}),r.addEvent("keyup",this.doSearch),new Element("th",{html:""}).adopt(r).inject(e)),f=new Element("th",{"data-name":this.cleanName(n.Name),html:i}).inject(o),f.addEvent(Affinity.events.start,this.beforeSort),Affinity.sortgrids[this.gridID].push({direction:"desc"}),this.table.totals[n.Name]=0)}.bind(this))}.bind(this))},buildFooter:function(){var n=new Element("tr").inject(this.table.tfoot);Array.each(this.columns,function(){new Element("th",{html:""}).inject(n)}.bind(this)),this.table.tbody.getElements("tr.row").length===0?(this.seaction.addClass("hidden"),this.noRows.removeClass("hidden"),this.table.saveButton.addClass("hidden")):(this.doTotals(),this.seaction.removeClass("hidden"),this.noRows.addClass("hidden"),this.table.saveButton.removeClass("hidden"))},buildRows:function(n){Array.each(n,function(n){this.buildRow(n)}.bind(this))},buildRow:function(n){var r,t,f,u,i,o=new Element("tr",{"class":"row"}).inject(this.table.tbody),e=[];Array.each(this.columns,function(){i=new Element("td",{html:""}).inject(o),e.push(i)}),Array.each(n.Children,function(n){if(r=n.Value,n.InputType&&n.InputType==="Date"&&(t=Date.parse(n.Value),t&&"isValid"in t&&t.isValid()&&(r=t.toSimple())),n.InputType&&n.InputType==="Time"){t=(new Date).clearTime();var s=r,o=s.split(":"),h=parseInt(o[0]),c=parseInt(o[1]);t.setHours(h),t.setMinutes(c),t&&"isValid"in t&&t.isValid()&&(r=t.toTime12())}f=n.Source&&n.Source.PropertyName?n.Source.PropertyName:n.Name,u=this.columns.indexOf(f),typeOf(u)==="null"||isNaN(u)||(i=e[u],i&&(i.set("html",r),typeOf(n.InputType)!=="null"&&(n.InputType==="Float"||n.InputType==="Integer"||n.InputType==="Currency")&&i.addClass("dototal")))}.bind(this))},dototalDelay:!1,doTotals:function(){clearTimeout(this.dototalDelay),this.dototalDelay=function(){var t,n={},i;Array.each(this.table.tbody.getElements("tr.row"),function(i){Array.each(i.getElements("td"),function(i,r){i.hasClass("dototal")&&(n[r]||(n[r]=0),t=i.get("html").stripTags().trim(),t!==""&&(n[r]+=parseFloat(t)))}.bind(this))}.bind(this)),i=this.table.tfoot.getElement("tr").getElements("th"),Object.each(n,function(n,t){i[parseInt(t)].set("html",Number.round(n,2))}.bind(this))}.delay(1e3,this)},resortTimer:!1,searchTimer:!1,doSearch:function(n){this.options.searchable&&!this.dissabled&&(clearTimeout(this.resortTimer),clearTimeout(this.searchTimer),this.searchTimer=function(){var r=n.target,u=this.table.filters.getElements("input"),t=u.indexOf(n.target),i=r.value.toLowerCase().trim();Array.each(this.rows,function(n){n.addClass("hidden-"+t),(i===""||n.getElements("td")[t].get("html").toLowerCase().contains(i))&&n.removeClass("hidden-"+t),n.get("class").contains("hidden")?n.inject(this.table.hidden):n.inject(this.table.tbody)}.bind(this)),this.resortTimer=function(){this.htmlTable.sort(this.currentSort,!0)}.delay(500,this),this.doTotals()}.delay(500,this))},returnData:function(){var t=[],n=[];return n=[],Array.each(this.table.thead.getElements("th"),function(t){n.push(t.get("data-name"))}),t.push(n.join(",")),Array.each(this.table.tbody.getElements("tr"),function(i){n=[],Array.each(i.getElements("td"),function(t){n.push(t.get("html"))}),t.push(n.join(","))}),n=[],Array.each(this.table.tfoot.getElements("th"),function(t){n.push(t.get("html"))}),t.push(n.join(",")),t.join("\r\n")},saveCSV:function(){var n=unescape(this.returnData());uiprompt({message:"Please enter a name for your file",onOk:function(t){if(this.iemode)saveTextAs(n,t+".csv");else{var i=new Blob([n],{type:"text/plain;charset=utf-8"});saveAs(i,t+".csv")}}.bind(this)})}}),Affinity.zelos||(Affinity.zelos={}),Affinity.zelos.Elements||(Affinity.zelos.Elements={}),Affinity.zelos.Elements.Table=ZelosWidgetTable,Affinity.zelos||(Affinity.zelos={}),Affinity.zelos.Widgets||(Affinity.zelos.Widgets=[]),Affinity.zelos.Widgets.push("Table"),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetBulkEntry={Version:"1.0.14.0",Sequence:10250,Name:"Timesheet Bulk Entry (Zelos Widget)",File:"ui.zelos.widget.timesheets.bulk.entry.js",Jira:"CCP-1492",Notes:"fix zero code padding"},ZelosWidgetTimesheetBulkEntry=new Class({getEmptyTimesheetPerEmployee:!1,Implements:[Options,Events],Binds:["refresh","getEmployeeList","gotEmployeeList","getEmptyDoc","gotEmptyDoc","getEmptyTimeheet","gotEmptyTimeheet","getEmployeeEmptyTimesheet","sanatisePostDocument","editRow","populateTemplateFromKeyValueObject","downloadCSV","uploadCSV","processTimesheets","processNextTimesheet","continueProcessNextTimesheet","processDocErrors","postTimesheetDoc","updateDataFromRow"],options:{target:null,putApi:null,getEmptyTimesheetApi:null},rendered:!1,initialize:function(n){this.setOptions(n),Affinity.views.bulkentry=this,this.container=new Element("div").inject(this.options.target),this.container.addClass("widget"),this.container.addClass("widget poopy"),this.container.store("widget",this),this.section=new Element("div",{"class":"section shadow"}).inject(this.container),this.body=new Element("div",{"class":"section-body"}).inject(this.section),this.downloadBox=new Element("div",{"class":"ts-import-download"}).inject(this.body),this.uploadBox=new Element("div",{"class":"ts-import-upload"}).inject(this.body),this.gridBox=new Element("div",{"class":"ts-import-grid hidden"}).inject(this.body),this.csvTemplateDownloadButton=new Element("a",{"class":"ts-importer-download-csv ts-import-button",html:"<span>"+Affinity.icons.Download+"<\/span><span>Download CSV Template<\/span>"}).inject(this.downloadBox),new Element("br").inject(this.downloadBox),this.helpBox=new Element("div",{"class":"ts-import-desc",html:"<br />This is a description of all the columns in the CSV Template:<br /><br />"}).inject(this.downloadBox),this.helpShowButton=new Element("div",{"class":"ts-import-desc-help ts-import-button show yellow",html:"<span>"+Affinity.icons.HelpRound+"<\/span><span>CSV Columns & Example Values<\/span>"}).addEvent(Affinity.events.click,function(){this.helpShowButton.dissolve(),this.helpHideButton.reveal(),this.helpBox.reveal()}.bind(this)).inject(this.downloadBox),this.helpHideButton=new Element("div",{"class":"ts-import-desc-help ts-import-button hide orange",html:"<span>"+Affinity.icons.HelpRound+"<\/span><span>Hide Examples<\/span>"}).addEvent(Affinity.events.click,function(){this.helpShowButton.reveal(),this.helpHideButton.dissolve(),this.helpBox.dissolve()}.bind(this)).inject(this.helpBox,"top"),this.helpShowButton.set("reveal",{duration:250,display:"inline-block"}),this.helpHideButton.set("reveal",{duration:250,display:"inline-block"}).toggle(),this.helpBox.set("reveal",{duration:250}).toggle(),this.importDesc=new Element("p",{html:"Download a CSV template using the button above, then enter your data."}).inject(this.uploadBox),this.importDesc=new Element("p",{html:"Upload your new CSV below, then follow the instructions."}).inject(this.uploadBox),this.importDesc=new Element("p",{"class":"important",html:"Make sure that you save your file as a CSV or Text/CSV before uploading!"}).inject(this.uploadBox);var t=new Element("div",{"class":"ts-importer-upload-input"}).inject(this.uploadBox);new Element("div",{"class":"ts-import-button",html:"<span>"+Affinity.icons.Upload+"<\/span><span>Upload CSV<\/span>"}).inject(t),this.uploadForm=new Element("form").inject(t),this.uploadButton=new Element("input",{type:"file",accept:".csv"}).inject(this.uploadForm),this.tableBox=new Element("div",{"class":"section-table"}).inject(this.gridBox),this.table=new Element("table",{"class":"ui-grid"}).inject(this.tableBox),this.tableHead=new Element("thead").inject(this.table),this.tableBody=new Element("tbody").inject(this.table),this.proceeButton=new Element("a",{"class":"ts-importer-process ts-import-button",html:"<span>"+Affinity.icons.Hourglass+"<\/span><span>Process Timesheets<\/span>"}).inject(this.gridBox),this.proceeButton.addEvent(Affinity.events.click,this.processTimesheets),uialert({message:"Getting you all set up",showLoader:!0,noClose:!0}),this.refresh()},hasChanges:function(){return!1},refresh:function(){log("&#171; refresh bulk view &#187;"),this.getEmployeeList()},employeeSelect:!1,getEmployeeList:function(){if(this.employeeSelect)this.gotEmployeeList();else{var n=Affinity.zelosroot+"?api=timesheetAsManager/getEmployees";new Request.JSONP({url:n,callbackKey:"jsoncallback",method:"get",noCache:!0,onComplete:function(t){JSON.Unauthorized(t,"bulk, getEmployeeList - "+n)||(log('&#x2714; attempted detailed toggleAddRowsForm "get employees" succeeded'),this.employeeSelect=new Element("select"),this.options.isEmployee&&this.employeeSelect.adopt(new Element("option",{html:Affinity.login.profile.commonName+" ("+Affinity.login.profile.employeeNumber+")",value:Affinity.login.profile.employeeNumber})),Array.each(t,function(n){n.Value!==""&&n.Key!==""&&n.Key!==this.defaultEmployeeNumber?this.employeeSelect.adopt(new Element("option",{html:n.Value,value:n.Key})):this.employeeSelect.adopt(new Element("option",{html:"Select Employee",value:""}))}.bind(this)),this.gotEmployeeList())}.bind(this),onError:function(n){log('&#x2718; attempted detailed toggleAddRowsForm "get employees" failed with errors - '+n)},onFailure:function(n){log('&#x2718; attempted detailed toggleAddRowsForm "get employees" failed - '+n.statusText)}}).send()}},gotEmployeeList:function(){this.getEmptyDoc()},timesheetDocRaw:!1,getEmptyDoc:function(){if(this.timesheetDocRaw)this.gotEmptyDoc(this.timesheetDocRaw);else{var n=Affinity.zelosroot;n+="?api=timesheetAsManager/get",n+="&fromDate=1.1.70&toDate=1.1.70",n+="&timesheetStatus=",n+="&view=detail",n+="&page=0",n+="&pageSize=1",new ZelosTemplateLoad({onComplete:this.gotEmptyDoc}).loadTemplate(n)}},gotEmptyDoc:function(n){n.Children[0].Children[0].Children=[],this.timesheetDocRaw=n,this.getEmptyTimeheet()},emptyTimesheetDocRaw:!1,emptyTimesheetDoc:!1,getEmptyTimeheet:function(){if(this.emptyTimesheetDoc)this.gotEmptyTimeheet();else{var n=this.options.getEmptyTimesheetApi;log("&#x2794; attempting bulk getEmptyTimeheet ..."),this.loadRequest=new Request.JSON({url:n,method:"get",noCache:!0,onSuccess:function(t){JSON.Unauthorized(t,"bulk, getEmptyTimeheet - "+n)||(t.error?log("&#x2718; attempted bulk getEmptyTimeheet succeeded with errors - "+t.error):(log("&#x2714; attempted bulk getEmptyTimeheet succeeded"),this.gotEmptyTimeheet(t)))}.bind(this),onError:function(n,t){log("&#x2718; attempted bulk getEmptyTimeheet failed with errors - "+t)}.bind(this),onFailure:function(n){log("&#x2718; attempted bulk getEmptyTimeheet failed - "+n.statusText)}.bind(this)}).get()}},gotEmptyTimeheet:function(n){typeOf(n)==="array"&&(this.emptyTimesheetDocRaw=n,this.emptyTimesheetDoc=n[0]),this.buildCSVTemplate(this.emptyTimesheetDoc)},getEmployeeEmptyTimesheet:function(n,t){var u=JSON.stringify(this.emptyTimesheetDocRaw)+"",i=JSON.parse(u),r;typeOf(t)!=="function"&&(t=function(){}),this.getEmptyTimesheetPerEmployee?(r=this.options.getEmptyTimesheetApi+"&employeeNo="+n,log("&#x2794; attempting bulk getEmptyTimeheet for emp '"+n+"' ..."),new Request.JSON({url:r,method:"get",noCache:!0,onSuccess:function(u){JSON.Unauthorized(u,"bulk, getEmployeeEmptyTimesheet - "+r)||(u.error?(log("&#x2718; attempted bulk getEmptyTimeheet for emp '"+n+"' succeeded with errors - "+u.error),t(i)):(log("&#x2714; attempted bulk getEmptyTimeheet  for emp '"+n+"' succeeded"),t(u)))}.bind(this),onError:function(r,u){log("&#x2718; attempted bulk getEmptyTimeheet for emp '"+n+"' failed with errors - "+u),t(i)}.bind(this),onFailure:function(r){log("&#x2718; attempted bulk getEmptyTimeheet for emp '"+n+"' failed - "+r.statusText),t(i)}.bind(this)}).get()):t(i)},sanatisePostDocument:function(n){return Affinity.timesheets.methods.sanatisePostDocument(n)},csvColumns:!1,csvEditColumns:!1,csvColumnKeys:!1,csvTemplate:!1,isColumn:function(n){return n.Attribute.IsHidden?!1:(n.Attribute.IsReadOnly,n.Name.contains("BulkProcess"))?!1:n.Name.contains("RowButton")?!1:!0},isEditColumn:function(n){return n.Name.contains("BulkProcess")?!1:n.Name.contains("RowButton")?!1:!0},sortColumnRank:function(n,t){return n.Layout.rank<t.Layout.rank?-1:n.Layout.rank>t.Layout.rank?1:0},buildCSVTemplate:function(){if(!this.csvTemplate&&this.emptyTimesheetDoc){this.csvColumns=[],this.csvEditColumns=[],this.emptyTimesheetDoc.Children.sort(function(n,t){return parseInt(n.Layout.Rank,10)-parseInt(t.Layout.Rank,10)}),Array.each(this.emptyTimesheetDoc.Children,function(n){this.isColumn(n)&&this.csvColumns.push(n),this.isEditColumn(n)&&this.csvEditColumns.push(n)}.bind(this)),this.csvColumns=this.csvColumns.sort(this.sortColumnRank),this.csvEditColumns=this.csvEditColumns.sort(this.sortColumnRank),this.csvColumnKeys=[];var e=[],i=[],f,n,r,t,u;Array.each(this.csvColumns,function(o,s){f=o.Name.split("-").slice(-1).pop(),e.push(o.Description.ShortText),this.csvColumnKeys.push(f),n=new Element("div",{"class":"help-box"}).inject(this.helpBox),new Element("h2",{html:"Column "+(s+1)+": "+o.Description.ShortText+"  "}).inject(n),new Element("em",{html:" ("+f+")"}).inject(n),"Value"in o&&typeOf(o.Value)==="array"&&o.Value.length>0?(new Element("div",{"class":"help-row",html:"Search / Select to see valid value"}).inject(n),t=new Element("select",{"class":"ui-autocomplete"}).inject(n),new Element("span",{"class":"help-display-label hidden",html:"Valid Value: "}).inject(n),u=new Element("input",{"class":"help-display hidden"}).inject(n),u.addEvent("focus",function(n){n.target.select()}),t.addEvent("change",function(n){n&&"target"in n&&(n.target.getParent(".help-box").getElement(".help-display-label").removeClass("hidden"),n.target.getParent(".help-box").getElement(".help-display").removeClass("hidden"),n.target.getParent(".help-box").getElement(".help-display").value=n.target.value)}),new Element("option",{value:"",html:""}).inject(t),Array.each(o.Value,function(n){new Element("option",{value:n.value,html:n.display}).inject(t)}.bind(this))):o.Name.contains("AuthoriserId")?new Element("div",{"class":"help-row",html:"Value should be your employee number ("+o.Value+")"}).inject(n):"InputType"in o&&(o.InputType==="Lookup"&&(new Element("div",{"class":"help-row",html:"Search / Select to see valid value"}).inject(n),r=Affinity.lookupapi+"?ModelName="+o.Source.ModelName+"&PropertyName="+o.Source.PropertyName,typeOf(o.Data)!=="null"&&typeOf(o.Data.ExternalParameter)!=="null"&&(r+="&"+o.Data.ExternalParameter),"enableSelectLimit"in Affinity&&Affinity.enableSelectLimit&&(r+="&limit="+Affinity.selectmax||1e3),t=new Element("select",{"class":"has-lookup","data-lookup-api":r}).inject(n),new Element("span",{"class":"help-display-label hidden",html:"Valid Value: "}).inject(n),u=new Element("input",{"class":"help-display hidden"}).inject(n),u.addEvent("focus",function(n){n.target.select()}),t.addEvent("change",function(n){n&&"target"in n&&(n.target.getParent(".help-box").getElement(".help-display-label").removeClass("hidden"),n.target.getParent(".help-box").getElement(".help-display").removeClass("hidden"),n.target.getParent(".help-box").getElement(".help-display").value=n.target.value)})),o.InputType==="Date"&&new Element("div",{"class":"help-row",html:"Value should be a date string dd.mm.YYYY"}).inject(n),o.InputType==="Time"&&new Element("div",{"class":"help-row",html:"Value should be a 24 hour time string HH:mm"}).inject(n),o.InputType==="Integer"&&new Element("div",{"class":"help-row",html:"Value should be a whole Number"}).inject(n),(o.InputType==="Float"||o.InputType==="Double")&&new Element("div",{"class":"help-row",html:"Value should be a decimal Number"}).inject(n),o.InputType==="String"&&new Element("div",{"class":"help-row",html:"Value should be a String"}).inject(n)),"Value"in o?typeOf(o.Value)==="string"&&o.Value!==""?o.Name.toLowerCase().contains("date")?i.push(Date.parse(o.Value).format("%d.%m.%Y")):i.push(o.Value):i.push(""):i.push("")}.bind(this)),this.csvTemplate=e.join(",")+"\n"+i.join(",")+"\n"}this.renderUI()},downloadCSV:function(){var t,u,i,n,r,e,f="timesheets_"+Affinity.login.profile.companyNumber+"_"+Affinity.login.profile.employeeNumber+"_"+(new Date).format("%d-%m-%Y")+".csv";Affinity.isie?(t="sep=,\r\n"+this.csvTemplate,i=new Element("iframe").inject(this.container,"bottom").addClass("subhidden"),n=i.contentWindow||i.contentDocument,n.document.open("text/html","replace"),n.document.write(t),n.document.close(),n.focus(),e=n.document.execCommand("SaveAs",!0,f),i.destroy()):(t="data:text/csv;charset=utf-8,",t+=this.csvTemplate,u=encodeURI(t),r=new Element("a",{href:u,download:f}),r.click(),r.destroy())},renderUI:function(){if(!this.rendered){this.csvTemplateDownloadButton.addEvent(Affinity.events.click,this.downloadCSV),this.tableEmpIndex=!1;var n=new Element("tr").inject(this.tableHead);Array.each(this.csvColumns,function(t,i){new Element("th",{html:t.Description.ShortText,"data-key":this.csvColumnKeys[i],"class":"key-"+this.csvColumnKeys[i]}).inject(n),(this.csvColumnKeys[i].toLowerCase().contains("emp")&&this.csvColumnKeys[i].toLowerCase().contains("no")||this.csvColumnKeys[i].toLowerCase().contains("emp")&&this.csvColumnKeys[i].toLowerCase().contains("num"))&&(this.tableEmpIndex=i)}.bind(this)),this.tableHeadCells=this.tableHead.getElements("th"),new Element("th").inject(n),this.uploadButton.addEvent("change",this.uploadCSV),Affinity.uiAutoComplete.processNew(),Affinity.uiSelectLookup.options.jsonp=!0,Affinity.uiSelectLookup.processNew()}this.rendered=!0,Affinity.prompts.hide(),this.fireEvent("complete")},uploadCSV:function(){var t=this.uploadButton.files[0],n=new FileReader;n.onload=function(){this.gotCSVData(n.result),this.uploadForm.reset()}.bind(this),n.readAsText(t)},CSVtoArray:function(n){var i=/(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g,t;return/^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/.test(n)?(t=[],n.replace(i,function(n,i,r,u){return i!==undefined?t.push(i.replace(/\\'/g,"'")):r!==undefined?t.push(r.replace(/\\"/g,'"')):u!==undefined&&t.push(u),""}),/,\s*$/.test(n)&&t.push(""),t):null},rowData:!1,gotCSVData:function(n){this.rowData=[],this.tableBody.empty(),this.gridBox.addClass("hidden");var t,i=n.split(/\r\n|\n/);Array.each(i,function(n){n=n.replace(new RegExp("'","gi")," "),t=this.CSVtoArray(n),t&&t.length===this.csvColumns.length&&t[0]!==this.csvColumns[0].Description.ShortText&&(this.rowData.push(t),this.addRow(t))}.bind(this))},padZero:function(n){return!isNaN(parseInt(n))&&n.toString().length===1&&parseInt(n)>-1&&parseInt(n)<10?"0"+parseInt(n).toString():n},checkForCodePadZero:function(n,t){return n.test(new RegExp("code","gi"))?this.padZero(t):t},checkForInvalidTimes:function(n,t){var r,i;return(n.test(new RegExp("starttime","gi"))||n.test(new RegExp("endtime","gi")))&&(t.test(new RegExp("am","gi"))||t.test(new RegExp("pm","gi")))&&(r=t.test(new RegExp("pm","gi"))?12:0,t=t.replace(new RegExp("am|pm","gi"),"").trim(),i=new Date.parse(t),i.isValid())?(i.getHours()===12&&r===12&&(r=0),i=i.increment("hour",r),i.format("%H:%M")):t},addRow:function(n){var t=new Element("tr"),i,r;Array.each(n,function(n,u){i=this.tableHeadCells[u].get("data-key"),r=this.checkForCodePadZero(i,n),r=this.checkForInvalidTimes(i,r),new Element("td",{"class":"key-"+i,html:r}).inject(t)}.bind(this)),new Element("td",{"class":"progress",html:Affinity.icons.Ellipsis}).inject(t),t.inject(this.tableBody),t.addEvent(Affinity.events.click,this.editRow),this.gridBox.removeClass("hidden"),Affinity.uiGrid.zebra(this.table)},updateDataFromRow:function(n){if(n&&"get"in n&&n.get("tag")==="tr"){var t,i;t=this.tableBody.getElements("tr"),i=t.indexOf(n),Array.each(n.getElements("td"),function(n,t){this.rowData[i][t]=n.get("html")}.bind(this))}},promptForEmployee:function(n){var t=this.employeeSelect.clone();uialert({message:"Before we can edit this timesheet<br />we need a valid employee number",showButtons:!1,onClose:function(){t.removeEvents(),t.retrieve("widget")&&t.retrieve("widget").destroy()}}),t.addEvent("change",function(){prompts.hide(),typeOf(n)==="element"&&(n.getElement(".key-EmployeeNo").set("html",t.value),this.updateDataFromRow(n),this.continueRowEdit(n))}.bind(this)),prompts.adopt(new Element("br"),new Element("br"),t,new Element("br"),new Element("br")),new UIAutoCompleteWidget({selectElement:t})},editRow:function(n){var t,i;t=n.target.get("tag")==="tr"?n.target:n.target.getParent("tr"),i=!1,t.hasClass("locked")||(i=t.getElement(".key-EmployeeNo")&&t.getElement(".key-EmployeeNo").get("html")&&t.getElement(".key-EmployeeNo").get("html")!==""?t.getElement(".key-EmployeeNo").get("html"):!1),i?this.continueRowEdit(t):this.promptForEmployee(t)},continueRowEdit:function(n){var a,t,i,o=!1,s=!1,h=!1,u=0,f=0,c=!1,v=this.tableBody.getElements("tr"),y=v.indexOf(n),p=this.rowData[y],e={},l=this.tableHead.getElements("th"),r;Array.each(l,function(n,r){n.get("data-key")&&(t=n.get("data-key"),i=this.checkForInvalidTimes(t,p[r]),i=this.checkForCodePadZero(t,i),e[t]=i,t.test(new RegExp("StartTime","gi"))&&(o=!0),t.test(new RegExp("EndTime","gi"))&&(s=!0),t.test(new RegExp("TsNet","gi"))&&(h=!0))}.bind(this)),n.hasClass("locked")||(c=n.getElement(".key-EmployeeNo")&&n.getElement(".key-EmployeeNo").get("html")&&n.getElement(".key-EmployeeNo").get("html")!==""?n.getElement(".key-EmployeeNo").get("html"):!1),this.formElement||(this.formElement=new Element("div",{"class":"timesheet-edit-form"})),this.formElement.empty(),r=Object.clone(this.emptyTimesheetDoc),r=this.populateTemplateFromKeyValueObject(r,e),a=new ZelosWidgetTimesheetEditForm({target:this.formElement,timesheetId:!1,employeeNumber:c,keyValueData:e,supressButtons:!0,width:600,originDoc:r,onLoaded:function(){},onDone:function(t){var i,r,c,e;Array.each(t.Children[0].Children,function(t){Array.each(n.getElements("td"),function(n,e){if(t.Name.contains(l[e].get("data-key"))){if(r=n.get("html"),typeOf(t.Value)==="array"){for(i=t.Value.length-1;i>-1;i--)if(t.Value[i].selected){r=t.Value[i].value;break}}else t.Name.test(new RegExp("StartTime","gi"))&&(u=t.Value),t.Name.test(new RegExp("EndTime","gi"))&&(f=t.Value),t.Name.test(new RegExp("TsNet","gi"))&&(c=n),r=t.Name.test(new RegExp("PayCode","gi"))?this.padZero(t.ValueAsString):t.ValueAsString;this.populateCell(n,r,t)}}.bind(this))}.bind(this)),h&&s&&o&&c&&f&&u&&(e=(Date.parse(f)-Date.parse(u))/36e5,(e+"").length>4&&(e=e.toFixed(2)),c.set("html",e)),this.updateDataFromRow(n)}.bind(this)})},populateCell:function(n,t,i){switch(i.InputType){case"Date":n.set("html",Date.parse(t).format("%d.%m.%Y"));break;case"Time":n.set("html",Date.parse(t).format("%H:%M"));break;default:n.set("html",t)}},populateTemplateFromKeyValueObject:function(n,t){var i;return typeOf(t)!=="null"&&Object.each(t,function(t,r){i=!1,value=this.checkForCodePadZero(r,t),value=this.checkForInvalidTimes(r,value),Array.each(n.Children,function(t,u){if(t.Name.contains(r)){if(r.contains("EmployeeNo")||r==="EmployeeNo")n.Children[u].Value=parseInt(value),n.Children[u].ValueAsString=value;else if("Value"in t)typeOf(t.Value)==="array"?(Array.each(t.Value,function(t,i){typeOf(t)==="object"&&"selected"in t&&"value"in t&&(n.Children[u].Value[i].selected=!1,t.value+""==value+""&&(n.Children[u].Value[i].selected=!0))}.bind(this)),n.Children[u].ValueAsString=JSON.stringify(n.Children[u].Value),"SelectedItem"in t&&(n.Children[u].SelectedItem=value,n.Children[u].SelectedItemAsString=value),i=!0):typeOf(t.Value)==="string"?(n.Children[u].Value=value,n.Children[u].ValueAsString=value,i=!0):isNaN(t.Value)?(console.log(""),console.log("child has Value, but is not array, string or number ... what to do ?"),console.log(t),console.log("")):(n.Children[u].Value=parseFloat(value),n.Children[u].ValueAsString=value+"",i=!0);else if("InputType"in t)switch(t.InputType){case"Lookup":n.Children[u].Value=value,n.Children[u].ValueAsString=value,i=!0;break;case"Float":n.Children[u].Value=parseFloat(value),n.Children[u].ValueAsString=value+"",i=!0;break;case"Integer":n.Children[u].Value=parseInt(value,10),n.Children[u].ValueAsString=value+"",i=!0;break;case"String":n.Children[u].Value=value,n.Children[u].ValueAsString=value,i=!0;break;case"Date":case"Time":case"HoursMins":n.Children[u].Value=value,n.Children[u].ValueAsString=value,i=!0;break;default:console.log(""),console.log("Don't know what to do with InputType \""+t.InputType+'" ... what to do ?'),console.log(t),console.log("")}else console.log(""),console.log("child has NO Value and no InputType ... what to do ?"),console.log(t),console.log("");r.toLowerCase().contains("paycode")&&(n.Children[u].SelectedItem=this.padZero(value),n.Children[u].SelectedItemAsString=this.padZero(value)),i&&(n.Children[u].Attribute={IsHidden:!1,IsReadOnly:!1,IsRequired:!1})}}.bind(this))}.bind(this)),n},allProcessed:!1,postErrors:[],processTotal:0,processCount:0,progress:!1,progressBar:!1,dotdotdot:!1,dotdotdotDelay:!1,processTimesheets:function(){clearInterval(this.dotdotdotDelay),this.allProcessed=!1,this.postErrors=[],this.processTotal=this.rowData.length,this.processCount=0;var n=new Element("div");this.dotdotdotLabel=new Element("span",{html:"Processing"}).inject(n),this.dotdotdot=new Element("span",{"class":"ts-import-progress-dots",html:"..."}).inject(n),this.progress=new Element("div",{"class":"ts-import-progress",html:"Processed "+this.processCount+" Timesheets of "+this.processTotal}).inject(n),this.progressBar=new Element("div",{"class":"ts-import-progress-bar",html:'<div class="bg"><\/div>'}).inject(n),uialert({message:'<div class="ts-import-progress-warn">Do not close your browser!<\/div>',showLoader:!1,noClose:!0}),Affinity.prompts.adopt(n),Affinity.prompts.center(),this.progressBar.setStyle("width","0%"),this.dotdotdotDelay=function(){var n=this.dotdotdot.get("html");n.length===0?this.dotdotdot.set("html","."):n.length===1?this.dotdotdot.set("html",".."):n.length===2?this.dotdotdot.set("html","..."):n.length===3&&this.dotdotdot.set("html","")}.periodical(250,this),this.processNextTimesheet()},setTemplateValue:function(n,t,i){return Array.each(n.Children,function(r,u){var e,f;if(r.Name.contains(t)){if(typeOf(r.Value)!=="object")if(t.contains("EmployeeNo")||t==="EmployeeNo")if(typeOf(r.Value)==="array"){for(e={display:i+"",value:parseInt(i),selected:!0},f=r.Value.length-1;f>-1;f--)if(r.Value[f].value===parseInt(i)){e=Object.clone(r.Value[f]),e.selected=!0;break}n.Children[u].Value=[e],n.Children[u].ValueAsString=JSON.stringify(n.Children[u].Value),n.Children[u].SelectedItem=parseInt(i),n.Children[u].SelectedItemAsString=parseInt(i)+""}else n.Children[u].Value=parseInt(i),n.Children[u].ValueAsString=i;else typeOf(r.Value)==="array"?(Array.each(r.Value,function(t,r){"selected"in t&&typeOf(t.selected)==="boolean"&&(n.Children[u].Value[r].selected=!1,t.value+""==i+""&&(n.Children[u].Value[r].selected=!0))}),n.Children[u].ValueAsString=JSON.stringify(n.Children[u].Value)):(n.Children[u].Value=i,n.Children[u].ValueAsString=i,r.Attribute.IsReadOnly&&(n.Children[u].Attribute.IsReadOnly=!1),r.Attribute.IsHidden&&(n.Children[u].Attribute.IsHidden=!1));t.toLowerCase().contains("paycode")&&(template.Children[childIndex].SelectedItem=this.padZero(i),template.Children[childIndex].SelectedItemAsString=this.padZero(i))}}),n},emlpoyeeTimesheets:{},processNextTimesheet:function(){if(this.rowData[this.processCount]){var r,s,t,i,e,o,u,f,n;r=JSON.stringify(this.timesheetDocRaw)+"",s=JSON.parse(r),t=!1,e=this.tableBody.getElements("tr")[this.processCount],o=e.getElements("td"),n=!1,this.tableEmpIndex!==!1&&(u=o[this.tableEmpIndex],u&&(f=u.get("html"),f.trim()!==""&&(n=f))),n!==!1?this.emlpoyeeTimesheets["emp-"+n]?(i=JSON.stringify(this.emlpoyeeTimesheets["emp-"+n])+"",t=JSON.parse(i),this.continueProcessNextTimesheet(t)):this.getEmployeeEmptyTimesheet(n,function(t){t=t[0],this.emlpoyeeTimesheets["emp-"+n]=t,i=JSON.stringify(this.emlpoyeeTimesheets["emp-"+n])+"",t=JSON.parse(i),this.continueProcessNextTimesheet(t)}.bind(this)):(i=JSON.stringify(this.emptyTimesheetDocRaw)+"",t=JSON.parse(r)[0],this.continueProcessNextTimesheet(t))}else this.continueProcessNextTimesheet(!1)},continueProcessNextTimesheet:function(n){var u,o,i,s,h,p,c,l,f,a,t,v,y,r,e;this.rowData[this.processCount]?n&&(u="accept",o=JSON.stringify(this.timesheetDocRaw)+"",i=JSON.parse(o),s=this.tableBody.getElements("tr")[this.processCount],h=s.getElements("td"),p=this.rowData[this.processCount],Array.each(i.Children[1].Children,function(n,t){n.Value.ButtonType.toLowerCase().contains(u)&&(i.Children[1].Children[t].Value.Pressed=!0,i.Children[1].Children[t].ValueAsString=JSON.stringify(i.Children[1].Children[t].Value))}),Array.each(n.Children,function(t,i){t.Name.contains("RowButton")&&Array.each(t.Children,function(t,r){t.Value.ButtonType.toLowerCase().contains(u)&&(n.Children[i].Children[r].Value.Pressed=!0,n.Children[i].Children[r].ValueAsString=JSON.stringify(n.Children[i].Children[r].Value))})}),Array.each(h,function(t,i){this.tableHeadCells[i]&&(c=this.tableHeadCells[i].get("data-key"),l=t.get("html"),n=this.setTemplateValue(n,c,l))}.bind(this)),n=this.setTemplateValue(n,"Bulk","true"),i.Children[0].Children[0].Children=[],i.Children[0].Children[0].Children.push(n),this.postTimesheetDoc(i)):this.allProcessed=!0,this.progress.set("html","Processed "+this.processCount+" Timesheets of "+this.processTotal),this.progressBar.setStyle("width",this.processCount/this.processTotal*100+"%"),this.allProcessed?(clearInterval(this.dotdotdotDelay),this.dotdotdot.destroy(),this.dotdotdotLabel.set("html","Done."),f=[],a=this.tableBody.getElements("tr"),Array.each(this.postErrors,function(n,i){t=a[i],t.removeClass("failed").removeClass("passed").removeClass("locked"),t.getElement("td.progress").set("html",Affinity.icons.Ellipsis),t.getElement("td.progress").set("data-tooltip",!1),t.getElement("td.progress").removeClass("ui-has-tooltip"),t.removeEvents(),typeOf(n)==="boolean"&&n===!1?(t.addClass("locked passed"),t.getElement("td.progress").set("html",Affinity.icons.Tick),f.push(i)):(t.addClass("failed"),t.getElement("td.progress").set("html",Affinity.icons.Cross),t.addEvent(Affinity.events.click,this.editRow),typeOf(n)==="array"&&(r="",Array.each(n,function(n){typeOf(n)==="string"?r+=n+"<br />":typeOf(n)==="object"&&(n.key==="document"||(n.key==="timesheet"?r+=n.message+"<br />":(v=this.tableHeadCells.indexOf(this.tableHead.getElement(".key-"+n.key)),y=t.getElements("td")[v],new Element("div",{"class":"ui-has-tooltip",html:Affinity.icons.Warning,"data-tooltip":n.message,"data-tooltip-dir":"top,left"}).inject(y))))}.bind(this)),r!==""&&(t.getElement("td.progress").set("html",Affinity.icons.Warning),t.getElement("td.progress").set("data-tooltip",r),t.getElement("td.progress").set("data-tooltip-dir","top,left"),t.getElement("td.progress").addClass("ui-has-tooltip"))))}.bind(this)),Affinity.uiTooltips.processNew(),e=[],Array.each(this.rowsData,function(n,t){f.contains(t)||e.push(n)}.bind(this)),this.rowsData=Array.clone(e),function(){uialert({message:"Timesheets Processed",showLoader:!1,noClose:!1,showButtons:!0})}.delay(5e3,this)):this.processCount++,Affinity.prompts.center()},processDocErrors:function(n){var i=[],t;return n.error?(t={},t.key="document",t.label="",t.message=n.error,i.push(t)):Array.each(n.Children,function(n){Array.each(n.Children,function(n){n.ElementType=="TimesheetTable"&&Array.each(n.Children,function(n){n.Data&&n.Data.RowType||(n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&(t={},t.key="timesheet",t.label="",t.message=n.Attribute.ErrorMessage,i.push(t)),Array.each(n.Children,function(n){n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&(t={},t.key=n.Name.split("-").slice(-1).pop(),t.label=n.Description.ShortText,t.message=n.Attribute.ErrorMessage,i.push(t))}.bind(this)))}.bind(this))}.bind(this))}.bind(this)),i},postTimesheetDoc:function(n){log("&#x2794; attempting bulk postDocumentRow ..."),n=this.sanatisePostDocument(n),new Request.JSON({url:this.options.putApi,timeout:3e5,onSuccess:function(n){if(!JSON.Unauthorized(n,"detailed, postDocumentRow - "+this.options.putApi)){Affinity.hasOwnProperty("resetSessionTimer")&&Affinity.resetSessionTimer();var t=this.processDocErrors(n);t.length===0?(log("&#x2714; attempted bulk postDocumentRow succeeded"),this.postErrors.push(!1),this.processNextTimesheet.delay(500,this)):(log("&#x2718; attempted bulk postDocumentRow succeeded with errors - "+t.join(", ")),this.postErrors.push(t),this.processNextTimesheet.delay(500,this))}}.bind(this),onError:function(n,t){if(typeOf(t)==="object")if("message"in t)t=t.message;else{var i=t.toString();i.contains("401")&&Affinity&&Affinity.login&&Affinity.login.session&&log("&#x270B; attempted bulk postDocumentRow unauthorized &#x270B;"),t=="unknown"}typeOf(t)==="string"&&t.contains("401")?log("&#x270B; attempted bulk postDocumentRow unauthorized &#x270B;"):log("&#x2718; attempted bulk postDocumentRow failed with errors - "+t),this.postErrors.push(t),this.processNextTimesheet.delay(500,this)}.bind(this),onFailure:function(n,t){var i=n.response?n.response:n.responseText?n.responseText:t;i&&i.contains("401")?log("&#x270B; attempted bulk postDocumentRow unauthorized &#x270B;"):log("&#x2718; attempted bulk postDocumentRow failed - "+t),this.postErrors.push(t),this.processNextTimesheet.delay(500,this)}.bind(this),onException:function(n,t){log("&#x2718; attempted bulk postDocumentRow failed with exception - "+n+": "+t),this.postErrors.push("Failed with post exception"),this.processNextTimesheet.delay(500,this)}.bind(this),onTimeout:function(){log("&#x2718; attempted bulk postDocumentRow timed out"),this.postErrors.push("Timed out"),this.processNextTimesheet()}}).post("="+escape(JSON.stringify(n)))},destroy:function(){this.rendered=!1,Array.each(this.container.getElements(".widget"),function(n){n.retrieve("widget")&&"destroy"in n.retrieve("widget")&&n.retrieve("widget").destroy()}),this.employeeSelect=!1,this.timesheetDocRaw=!1,this.emptyTimesheetDocRaw=!1,this.emptyTimesheetDoc=!1,this.csvColumns=!1,this.csvEditColumns=!1,this.csvColumnKeys=!1,this.csvTemplate=!1,this.rowData=!1,this.allProcessed=!1,this.postErrors=[],this.processTotal=0,this.processCount=0,this.progress=!1,this.progressBar=!1,this.dotdotdot=!1,this.dotdotdotDelay=!1,this.helpBox.empty(),this.tableHead.empty(),this.tableBody.empty(),Affinity.views.bulkentry=null,delete Affinity.views.bulkentry}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetTableAsDetailed={Version:"1.0.44.0",Sequence:10230,Name:"Timesheet Table As Detailed (Zelos Widget)",File:"ui.zelos.widget.timesheets.detailed.js",Jira:"",Notes:"reset fave buttons on bulk action"},ZelosWidgetTimesheetTableAsDetailed=new Class({debug:!1,setMissingDefaultAsReadOnly:!1,Implements:[Options,Events],Binds:["isViewActive","removeGlobalElementChangeEvent","addGlobalElementChangeEvent","globalElementChangeHandler","checkKeyboardShortcut","beforeClose","renderCheck","processUI","continueProcessUI","processDocument","selectAllRows","cleanFavData","reduceBulkRows","showAwards","subMenuOver","subMenuOut","showButtons","hideButtons","editFormButtonClicked","buttonClicked","buttonClickedContinue","returnSecondaryAddButton","secondaryAdd","secondaryAddAllowance","addRows","selectFav","promptFavName","showFavSelect","saveFav","sanatisePostDocument","postDocumentRow","openSelectEmployee","toggleAddRowsForm","toggleAddRowsFormCont","showAddRowsForm","hideAddRowsForm","showMobilePopupEditor","toggleSearchForm","showSearchForm","hideSearchForm","adjustFilterDates","doSearch","getNextPage","getPreviousPage","getPage","rowUserInteraction","hasRowChanged","checkColumnMisssAligned","loadNewRows","returnNewRow","buildTableRow","updateRow","forceRowReadOnly","getAttributes","getTimesheetType","mobileSelect","popupEditForm","hidePopupEditFormDeleteButton","duplicateTimesheet","setDates","setEmployee","refresh","destroy","delUnload","getUIAutoCompleteOptions","instantiateUIAutoCompleteWidget","setupCorrectInfoColorForForwardedRowInMobileMode"],options:{parentForm:null,timesheetType:"employee",parentDocument:null,parentSectionIndex:null,parentChildIndex:null,widgetDocument:null,putApi:null,getEmptyTimesheetApi:"",target:null,zelosProcessor:null,insertAddForm:!0,isManager:!1,isEmployee:!1,fromDate:!1,toDate:!1,filterFromDate:!1,filterToDate:!1,paginate:!0,subType:"not-sub-type",isDual:!1,isMileageDual:!1,isAllowanceGrid:!1,profile:!1},uuid:"none yet",aaa:"none yet",ribbonDate:!1,ribbonEmpNo:!1,showAlerts:!0,enableFormEdit:!1,showPeriodButtonsInFilter:!1,showAllUnapproved:!1,messageBucket:[],viewName:"",initialize:function(n){var y,o,s,p,w,h,b,g,nt,c,l,a,f,k,u,t,e,ut,v,r,d,i;if(this.setOptions(n),this.uuid=String.uniqueID(),this.options.zelosProcessor.options.filterFromDate&&(this.options.filterFromDate=this.options.zelosProcessor.options.filterFromDate),this.options.zelosProcessor.options.filterToDate&&(this.options.filterToDate=this.options.zelosProcessor.options.filterToDate),this.options.zelosProcessor.options.isManager&&(this.options.isManager=this.options.zelosProcessor.options.isManager),this.options.zelosProcessor.options.isManager&&(this.options.isEmployee=this.options.zelosProcessor.options.isEmployee),this.isManagerView=this.options.isManager&&this.options.timesheetType.toLowerCase().contains("manager"),this.getApi=this.options.zelosProcessor.options.getApi+"",this.isManagerView&&(this.showAllUnapproved=Affinity.ShowManagerAllUnapproved==="*"?!0:Affinity.ShowManagerAllUnapproved.split(",").contains(Affinity.login.profile.companyNumber)?!0:!1),this.options.isDual?(y=this.options.subType,o="",this.isManagerView&&(y+="-manager"),o=y.ToCamelCase(),Affinity.views[o]=this,this.viewName=o):this.isManagerView?(Affinity.views.managerDetailed=this,this.viewName="managerDetailed"):(Affinity.views.detailed=this,this.viewName="detailed"),this.userData=this.options.profile||Affinity.login.profile,this.options.profile&&Affinity.login.profile.employeeNumber!==this.options.profile.employeeNumber&&(this.currentSearchEmployee=this.userData.employeeNumber),this.isAdmin=Affinity.login.profile.employeeNumber>5e6,this.zelosProcessor=this.options.zelosProcessor,Affinity.apiversion>1?(this.loadTimesheetsFrom=this.userData.payPeriods.currentBegins.clone(),this.loadTimesheetsTo=this.userData.payPeriods.currentEnds.clone()):(s=Affinity.appname,this.userData=JSON.decode(Affinity.CookieMonster.Read(s+"User")),p=JSON.decode(Affinity.CookieMonster.Read(s+"Values")),this.loadTimesheetsFrom=Date.parse(p.ShowTimesheetFrom),this.loadTimesheetsTo=Date.parse(p.NewestTimesheetDate)),this.options.fromDate&&this.options.toDate&&(this.loadTimesheetsFrom=this.options.fromDate.clone(),this.loadTimesheetsTo=this.options.toDate.clone()),!this.isAdmin&&this.showAllUnapproved&&(this.loadTimesheetsFrom=Affinity.login.profile.oldestTimesheetDate,this.loadTimesheetsTo=Affinity.login.profile.newestTimesheetDate),this.isAdmin&&(this.loadTimesheetsFrom=Affinity.login.profile.oldestTimesheetDate,this.loadTimesheetsTo=Affinity.login.profile.currentPayPeriodEnds),w=[["loadTimesheetsFrom","show timesheet from","ShowTimesheetFrom"],["loadTimesheetsTo","newest timesheet","NewestTimesheetDate"]],Array.each(w,function(n){typeOf(this[n[0]])==="date"&&(typeOf(this[n[0]])!=="date"||this[n[0]].isValid())||(this[n[0]]=!1)}.bind(this)),h="",Array.each(w,function(n){this[n[0]]||(h+=n[1]+" date ("+n[2]+") is missing or invalid\r\n")}.bind(this)),h!==""){b={},b.message=Affinity.languages.english.application.timesheets.globals.noViewAccess+"<!--\r\n"+h+"-->",window.fireEvent("logout",b);return}if(window.addEvent("processorDocumentSaved",function(n){n.processorId==this.zelosProcessor.processorId&&this.refresh()}.bind(this)),window.addEvent("processorDocumentError",function(n){n.processorId==this.zelosProcessor.processorId&&this.processErrors(n.document,!0)}.bind(this)),this.parentSection=this.options.parentDocument.Children[this.options.parentSectionIndex],this.baseLang=Affinity.languages.english.features,this.genericLang=Affinity.languages.english.generic,this.baseAppLang=Affinity.languages.english.application.timesheets.features,this.globalLang=Affinity.languages.english.application.timesheets.globals,this.icons={},this.icons.edit=Affinity.icons.Pencil,this.icons.save=Affinity.icons.Save,this.icons.view=Affinity.icons.Page,this.icons.del=Affinity.icons.CrossRound,this.icons.add=Affinity.icons.PlusRound,this.icons.cancel=Affinity.icons.Cancel,this.icons.approve=Affinity.icons.ThumbsUp,this.icons.decline=Affinity.icons.ThumbsDown,this.icons.search=Affinity.icons.Search,this.icons.duplicate=Affinity.icons.Docs,this.icons.list=Affinity.icons.List,this.icons.addrow=Affinity.icons.AddToList,this.icons.allowance=Affinity.icons.Gift,this.icons.award=Affinity.icons.Gift,this.icons.fav=this.baseLang.favourites.icon,this.icons.help=this.baseLang.help.icon,this.icons.dotsVert=Affinity.icons.DotsVert,this.zelosProcessor=this.options.zelosProcessor,this.table=new Element("table").inject(this.options.target),g=new Element("thead").inject(this.table),this.thead=new Element("tr").inject(g),this.tbody=new Element("tbody").inject(this.table),nt=new Element("tfoot").inject(this.table),this.tfoot=new Element("tr").inject(nt),this.options.timesheetType==="employeeDetails"&&this.table.addClass("detailed"),c=new Element("div",{"class":"section-table"}).wraps(this.table),this.options.insertAddForm){if(this.searchFormTarget=new Element("div").inject(this.options.target,"top"),this.searchFormButton=new Element("span",{"class":"button blue w-icon showSearch",html:"<span>"+this.icons.search+"<\/span>Search"}),this.searchFormButton.set("reveal",{duration:300,display:"inline-block"}),l=new Element("input",{type:"text"}),a=new Element("input",{type:"text"}),this.searchForm=new Element("div",{"class":"default-form w-border timesheetSearchFrom"}),this.searchEmployee=!1,this.isManagerView&&(this.searchEmployee=new Element("select",{"class":"has-lookup","data-lookup-api":Affinity.zelosroot+"?api=timesheetAsManager/getEmployees"}),this.options.isDual&&this.searchEmployee.set("data-lookup-rules","hasValue"),this.searchEmployeeRow=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search Employee"}),this.searchEmployee),this.searchForm.adopt(this.searchEmployeeRow)),this.searchEmployeeGroups=!1,f=!1,k=!1,this.searchPayPoint=!1,this.searchScreenFilters=!1,this.isManagerView){if(u=!1,Affinity.apiversion>1)try{u=Affinity.login.profile.screenFilters}catch(b){}else try{u=JSON.decode(Affinity.CookieMonster.Read(s+"ScreenFilters"))}catch(b){}u&&typeOf(u)==="array"&&u.length>0?(this.searchScreenFilters=[],Array.each(u,function(n){"Data"in n?(f=!1,t=new Element("select"),t.set("data-field-name",n.FieldName),Array.each(n.Data,function(i){n.FieldName!=="MethodFilter"||i.Key===null||f?new Element("option",{value:i.Key,html:i.Value}).inject(t):(k=i.Value,t.set("data-default-value",i.Key),new Element("option",{value:i.Key,html:i.Value,selected:"selected"}).inject(t),f=!0)}.bind(this)),e=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:n.Label}),t),e.inject(this.searchForm),new UIAutoCompleteWidget({selectElement:t}),n.FieldName==="PayPoint"?(this.searchPayPointRow=e,this.searchPayPoint=t):n.FieldName==="EssGroup"?(this.searchEmployeeGroupsRow=e,this.searchEmployeeGroups=t):this.searchScreenFilters.push(t)):(t=new Element("select"),t.addClass("has-lookup"),t.set("data-field-name",n.FieldName),t.set("data-label",n.Label),t.set("data-lookup-api",Affinity.lookupapi+"?ModelName="+n.ModelName+"&PropertyName="+n.FieldName),this.searchScreenFilters.push(t),e=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Filter By "+n.Label.replace(/ /gi,"&nbsp;")}),t).inject(this.searchForm))}.bind(this))):(this.searchScreenFilters=new Element("input",{type:"hidden",value:""}),this.searchForm.adopt(this.searchScreenFilters))}if(this.showPeriodButtonsInFilter){var tt=new Element("span",{"class":"button w-icon blue filter-last-period",html:'<span class="icon-arrow-left"><\/span>Last'}),it=new Element("span",{"class":"button w-icon blue filter-current-period",html:'<span class="icon-calendar"><\/span>Current'}),rt=new Element("span",{"class":"button w-icon blue filter-next-period",html:'<span class="icon-arrow-right"><\/span>Next'});this.searchForm.adopt(new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search From"}),l),new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search To"}),a),new Element("div",{"class":"form-row"}).adopt(new Element("div",{"class":"sub-text",html:"Set dates to Pay Periods."}),new Element("br"),new Element("label"),new Element("div",{style:"display:inline-block"}).adopt(tt,new Element("span",{html:"&nbsp;"}),it,new Element("span",{html:"&nbsp;"}),rt),new Element("br"),new Element("div",{"class":"sub-text",html:"Leave 'Search To' blank if you wish to search only one day."}))),tt.addEvent(Affinity.events.click,this.adjustFilterDates),it.addEvent(Affinity.events.click,this.adjustFilterDates),rt.addEvent(Affinity.events.click,this.adjustFilterDates)}else this.searchForm.adopt(new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search From"}),l),new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search To"}),a,new Element("br"),new Element("div",{"class":"sub-text",html:"Leave 'Search To' blank if you wish to search only one day."})));this.searchFrom=new UIDateTimeWidget({target:l,startDate:this.options.filterFromDate?this.options.filterFromDate.clone():this.options.fromDate.clone(),showCalendarFilterButtonsForMobile:Affinity.mobile}),this.searchTo=new UIDateTimeWidget({target:a,startDate:this.options.filterToDate?this.options.filterToDate.clone():this.options.toDate.clone(),showCalendarFilterButtonsForMobile:Affinity.mobile}),this.searchStatus=!1,this.isManagerView&&(this.supportedStatus=["Submitted","Declined","Approved","Paid"],ut=new Element("div"),this.searchStatus=new Element("div",{"class":"form-row wide search-status"}).adopt(new Element("label",{html:"Filter by Status"})),v=0,Array.each(this.supportedStatus,function(n){r="",n==="Submitted"?r="checked":this.showAllUnapproved&&(r=""),(this.options.timesheetType=="manager"&&n!=="Pending"||this.options.timesheetType!=="manager")&&(v!==0&&v%3==0&&(new Element("br").inject(this.searchStatus),new Element("div",{"class":"labelplaceholder"}).inject(this.searchStatus)),new Element("div",{"class":"check-label-pair"}).adopt(new Element("input",{type:"checkbox",id:"searchStatusCheck-d-"+n,"class":"searchStatusCheck-d-"+n,name:"searchStatusCheck-d-"+n,checked:r}).addEvent(Affinity.events.click,function(){document.getElement(".select-all-status-d")&&(document.getElement(".select-all-status-d").checked=!1)}.bind(this)),new Element("label",{"class":"right",html:n,"for":"searchStatusCheck-d-"+n})).inject(this.searchStatus),v++)}.bind(this)),this.searchForm.adopt(this.searchStatus),new Element("div",{"class":"form-row wide"}).adopt(new Element("label",{html:""}),new Element("div",{"class":"check-label-pair"}).adopt(new Element("input",{type:"checkbox",id:"select-all-status-d","class":"select-all-status-d",name:"select-all-status-d"}).addEvent("click",function(n){var t=this.searchStatus.getElements('input[type="checkbox"]');Array.each(t,function(t){t.checked=n.target.checked}),t.length>0&&(t[0].checked=!0)}.bind(this)),new Element("label",{"class":"right",html:"Select All","for":"select-all-status-d"}))).inject(this.searchForm)),this.immutibleFilter=!1,this.managedFilter=!1,d=this.options.zelosProcessor.options.getApi.test(new RegExp("dont_return_managed","gi"))?!1:!0,this.isManagerView&&(r="checked",this.immutibleFilter=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Exclude Locked"}),new Element("div",{"class":"check-label-pair"}).adopt(new Element("input",{type:"checkbox","class":"searchExcludeLockedCheck-d",name:"searchFilterImmutible-d",checked:r}))).inject(this.searchForm),r=d?"":"checked",this.managedFilter=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Timesheets to Action"}),new Element("div",{"class":"check-label-pair"}).adopt(new Element("input",{type:"checkbox","class":"searchMangedOnlyCheck-d",name:"searchFilterMangedOnly-d",checked:r}))).inject(this.searchForm)),this.searchForm.adopt(new Element("br"),new Element("div",{"class":"form-row buttons"}).adopt(new Element("label",{html:"","class":"mobile-no-display"}),new Element("span",{"class":"button blue w-icon",html:"<span>"+this.icons.add+"<\/span>Search"}).addEvent(Affinity.events.click,this.doSearch),new Element("span",{html:"&nbsp;"}),new Element("span",{"class":"button grey w-icon",html:"<span>"+this.icons.cancel+"<\/span>Cancel"}).addEvent(Affinity.events.click,this.hideSearchForm))),this.searchForm.set("reveal",{duration:300}),this.searchForm.toggle(),this.searchFormButton.addEvent(Affinity.events.click,this.showSearchForm),new Element("div",{"class":"form-row"}).adopt(this.searchForm,this.searchFormButton).inject(c,"before"),i=[],i.push("Date From "+Date.parse(this.searchFrom.date).format("%d/%m/%Y")),i.push("Date To "+Date.parse(this.searchTo.date).format("%d/%m/%Y")),this.options.timesheetType==="manager"&&(i.push("Status Submitted"),i.push("Excluding Locked"),d||i.push("My timesheets to approve only"),f&&i.push(k)),this.filterStrBox=new Element("div",{"class":"filter-str",html:"Filtered By: "+i.join(", ")}).inject(c,"before"),i=null}this.options.paginate&&(this.paginationContainer=new Element("div",{"class":"pagination"}),this.paginationSection=new Element("div",{"class":"default-form frameless"}).adopt(new Element("div",{"class":"form-row"}).adopt(this.paginationContainer)).inject(c,"after")),this.currentFocus="null",window.addEvent("keyup",function(n){n.code===9&&(this.currentFocus=document.activeElement.get("id"))}.bind(this)),window.addEvent("lookupComplete",function(n){if(n&&n.get("id")&&n.get("id")==this.currentFocus&&(n.focus(),n.select(),this.currentFocus=document.activeElement.get("id"),n.hasClass("ui-autocomplete-display"))){var t=n.retrieve("widget");t.show("ts detailed on lookupComplete"),t=null}}.bind(this)),this.norows=new Element("div",{"class":"no-rows",html:'<div class="message">'+Affinity.languages.english.application.timesheets.globals.noTimesheeets+"&nbsp;&nbsp;<\/div>",style:"padding: 10px;"}).inject(this.table,"before"),!Affinity.mobile&&this.options.parentForm&&(this.canKeyboardShortcut=!1,this.options.parentForm.addEvent(Affinity.events.overAll,function(){this.canKeyboardShortcut=!0}.bind(this)),this.options.parentForm.addEvent(Affinity.events.outAll,function(){this.canKeyboardShortcut=!1}.bind(this)),window.addEvent("keydown",this.checkKeyboardShortcut)),this.refresh(this.options.widgetDocument)},removeGlobalElementChangeEvent:function(){return window.removeEvent("AnElementChanged",this.globalElementChangeHandler),window.removeEvent("AnElementRestored",this.globalElementChangeHandler),!0},addGlobalElementChangeEvent:function(){return this.removeGlobalElementChangeEvent(),window.addEvent("AnElementChanged",this.globalElementChangeHandler),window.addEvent("AnElementRestored",this.globalElementChangeHandler),!0},globalElementChangeHandler:function(n){if(!Affinity.doCheckRowChanges())return!1;this.doChangeChecks&&this.isViewActive()&&(this.hasRowChanged(n.target),this.hasChanges()?this.setUnload():this.delUnload())},isViewActive:function(){var n=!1,t=Affinity.timesheets.init.view,i=this.options.timesheetType;return t==="employee"&&i==="employee"&&(n=!0),t==="dualdetail"&&i==="employeeDetails"&&(n=!0),t==="dualdetail"&&i==="manager"&&(n=!0),t==="manager"&&i==="manager"&&(n=!0),t===i&&(n=!0),n},checkKeyboardShortcut:function(n){if(this.canKeyboardShortcut&&n.control&&n.alt){n.stop();switch(n.key){case"n":case"N":this.secondaryAdd();break;case"u":case"U":Affinity.login.areas.Timesheet.AddUnit&&this.secondaryAddAllowance();break;case"f":case"F":this.selectFav()}}},setUnload:function(){window.onbeforeunload=this.beforeClose},delUnload:function(){window.onbeforeunload=function(){}},beforeClose:function(){return Affinity.languages.english.application.timesheets.globals.unsavedTimeshetWarn+(this.changedFieldsMessage!==""?"\n\n"+this.changedFieldsMessage:"")},hasRows:!1,setNoRows:function(){this.norows.removeClass("hidden"),this.table.addClass("hidden"),this.hasRows=!1},setHasRows:function(){this.norows.addClass("hidden"),this.table.removeClass("hidden"),this.hasRows=!0},setDates:function(n,t){var i=this.aaa;return typeOf(n)==="date"&&n.isValid()&&typeOf(t)==="date"&&t.isValid()&&(this.loadTimesheetsFrom=n.clone(),this.loadTimesheetsTo=t.clone(),this.options.isDual&&(this.options.fromDate=n.clone())),this.awardModal&&this.awardModal.close(),"from: "+n.toFriendlyShort()+", to: "+t.toFriendlyShort()},setEmployee:function(n){return this.currentSearchEmployee=n,!0},setExisitngDocOnRefresh:function(n){this.destroyRows()&&(this.tbody.empty(),typeOf(this.options.widgetDocument.Children)=="array"&&this.options.widgetDocument.Children.length>0?this.setHasRows():(this.setNoRows(),this.tbody.getParent(".inline-awards")||(this.secondaryAddButton||this.returnSecondaryAddButton(),this.secondaryButtonWrapper.inject(this.norows))),this.processDocument(n))},refreshing:!1,filterFromRefresh:!1,refresh:function(n,t){var u,f,r,s,h,c;if(this.isViewActive()){this.awardModal&&this.awardModal.close(),this.refreshing=!0,log("&#171; refresh detail view &#187;"),this.removeGlobalElementChangeEvent(),this.columnsCheck=[];var l=this.aaa,i,e=!1,o=!1;if(Affinity.viewSettings.employeeNumber&&Affinity.viewSettings.startDate&&(this.filterFromRefresh=!0,this.startDate=Affinity.viewSettings.startDate.clone(),this.startEmployee=Affinity.viewSettings.employeeNumber,u=Affinity.languages.english.application.timesheets.globals.gettingEmplopyee+" "+Affinity.viewSettings.employeeNumberp+" for "+Affinity.viewSettings.startDate.toFriendlyShort(),uialert({message:u,showLoader:!0,noClose:!0}),this.showSearchForm(),o=Affinity.viewSettings.filterData.forceReload,i=Affinity.viewSettings.filterData,"employee"in i&&(i.emp=i.employee),e=!0),Affinity.timesheets.init.hasOwnProperty("affinityData")&&typeOf(Affinity.timesheets.init.affinityData)==="object"){if(this.filterFromRefresh=!0,log("&#x22C8; switch detail view attempted with affinity data (for: "+Affinity.timesheets.init.affinityData.fromDate.toFriendly()+" to "+Affinity.timesheets.init.affinityData.toDate.toFriendly()+", emp: "+Affinity.timesheets.init.affinityData.emp+") ...",{color:"orange"}),u=Affinity.languages.english.application.timesheets.globals.gettingEmplopyee+" "+Affinity.timesheets.init.affinityData.emp+" for "+Affinity.timesheets.init.affinityData.fromDate.toFriendlyShort()+" to "+Affinity.timesheets.init.affinityData.toDate.toFriendlyShort(),i=Affinity.timesheets.init.affinityData,i.employee=i.emp,i.fromDate=i.fromDate?i.fromDate:i.date,i.toDate=i.toDate?i.toDate:i.date,i.hasOwnProperty("origin")&&i.origin==="Max"){this.addRows(i.fromDate,i.toDate,i.employee,!1,!1,!1,i.units,!0),Affinity.timesheets.init.affinityData=!1,i=null,delete i;return}e=!0,this.showSearchForm(),delete i.emp,delete i.date,e=!0}if(e){(function(){var t;this.searchEmployee&&"emp"in i&&(t=this.searchEmployee.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue(i.employee+"",!1)),this.searchPayPoint&&(t=this.searchPayPoint.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue(i.payPoint+"",!1)),this.searchEmployeeGroups&&(t=this.searchEmployeeGroups.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue("",!1)),this.searchScreenFilters&&Array.each(this.searchScreenFilters,function(n){t=n.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue("",!1)}),this.searchStatus&&Array.each(this.searchStatus.getElements("input"),function(n){n.checked=!0}),"date"in i&&(this.searchFrom.setDate(i.date),this.searchTo.setDate(i.date)),"fromDate"in i&&"toDate"in i&&(this.searchFrom.setDate(i.fromDate),this.searchTo.setDate(i.toDate)),this.immutibleFilter&&"excludeLocked"in i&&this.immutibleFilter.getElement(".searchExcludeLockedCheck-d")&&(this.immutibleFilter.getElement(".searchExcludeLockedCheck-d").checked=i.excludeLocked),this.managedFilter&&"onlyManged"in i&&this.managedFilter.getElement(".searchMangedOnlyCheck-d")&&(this.managedFilter.getElement(".searchMangedOnlyCheck-d").checked=i.onlyManged),o?this.doSearch(""):typeOf(n)==="null"?this.doSearch(u):(this.setExisitngDocOnRefresh(n),this.doSearch("",!0)),this.options.isMileageDual||Affinity.viewSettings.reset(),Affinity.timesheets.init.affinityData=null,delete Affinity.timesheets.init.affinityData}).delay(1e3,this);return}typeOf(n)==="null"||o?(f=new URI(this.getApi),r=typeOf(f.parsed.query)==="null"?{}:f.parsed.query.parseQueryString(),r.fromDate=this.loadTimesheetsFrom.format("%d.%b.%Y"),r.toDate=this.loadTimesheetsTo.format("%d.%b.%Y"),this.isManagerView||(s=this.searchFrom?this.searchFrom.getDateObject():this.options.fromDate?this.options.fromDate:this.loadTimesheetsFrom,h=this.searchTo?this.searchTo.getDateObject():this.options.toDate?this.options.toDate:this.loadTimesheetsTo,r.fromDate=s.format("%d.%b.%Y"),r.toDate=h.format("%d.%b.%Y")),this.options.isDual&&(r.fromDate=this.options.fromDate.format("%d.%b.%Y"),r.toDate=this.options.fromDate.format("%d.%b.%Y")),!this.options.isDual&&this.filterQueryObject&&Object.merge(r,this.filterQueryObject),this.currentSearchEmployee&&(r.employeeNo=this.currentSearchEmployee),r.page=this.currentPage,r.view="detail",this.options.isDual&&(r.view="daydetail",this.filterQueryObject=r),f.parsed.query=Object.toQueryString(r),c=Affinity.GetCacheSafePath(f.toString()),this.loadNewRows(c,"Refresh",t)):this.setExisitngDocOnRefresh(n),this.fireEvent("refreshed")}},getMessages:function(n,t){var r=t||"",i=[];return n.Attribute&&(n.Attribute.Message&&i.push('<div class="yellow">'+r+n.Attribute.Message+"<\/div>"),n.Attribute.ErrorMessage&&i.push('<div class="red">'+r+n.Attribute.ErrorMessage+"<\/div>")),i},docMessages:[],returnMessagesArray:function(){return this.docMessages},messageIndent:"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",processDocument:function(n){var u=new Date,i,t,r;this.removeGlobalElementChangeEvent(),this.doChangeChecks=!1,this.readonly=this.options.widgetDocument.Attribute.IsReadOnly,t=this.readonly?"ui-grid ui-grid-sortable timesheet":"ui-grid timesheet",t=this.options.timesheetType==="employeeDetails"?t+" detailed":t,this.table.set("class",t),this.tbody.getElements("tr.timesheet-row").addClass("old"),this.docMessages=[],Array.each(this.getMessages(n),function(n){this.docMessages.push(n)}.bind(this)),r=0,Array.each(n.Children,function(n){i=this.returnNewRow(n),i&&(i.inject(this.tbody),r++)}.bind(this)),Array.each(this.tbody.getElements("tr.old"),this.destroyRow.bind(this)),this.processUI(),delete t,delete i,log("&#x2714; detail view document processed ("+u.elapsed()+")"),function(){this.addGlobalElementChangeEvent(),this.fireEvent("processComplete")}.delay(1e3,this)},addRowsFormSatus:"closed",getUIAutoCompleteOptions:function(n,t){return{stopInitialChange:!1,selectElement:n,onComplete:function(){prompts.center()},onElementChanged:function(i){var r=parseInt(i,10),e=n.get("id"),o=document.getElement("select#"+e.replace("-Display","")),u=!1,f;if(Array.each(n.getElements("option"),function(n){f=parseInt(n.get("value"),10),f===r&&(u=!0)}.bind(this)),u){if(uialert({message:"Getting empty Timesheet for "+n.value,showLoader:!0,showButtons:!1}),t==="timesheet")this.addRows(new Date,new Date,r);else if(t==="allowance")this.addRows(new Date,new Date,r,!1,!0);else{prompts.hide();throw"Can not add timesheet of unknown type ("+t+")";}Affinity.mobile&&(this.showMobilePopupEditor=!0)}else prompts.hide()}.bind(this)}},openSelectEmployee:function(n){uialert({message:"Select an employee",showButtons:!1});var i=n||"timesheet",t=this.addRowEmployeeSelect.clone();t.addClass("hidden"),Affinity.prompts.adopt(new Element("br"),new Element("br"),t,new Element("br"),new Element("br")),function(){t.removeClass("hidden");var n=this.getUIAutoCompleteOptions(t,i);this.instantiateUIAutoCompleteWidget(n)}.delay(250,this)},instantiateUIAutoCompleteWidget:function(n){var t=undefined;Affinity.mobile&&"UIAutoCompleteMobileWidget"in window?t=new UIAutoCompleteMobileWidget(n):(t=new UIAutoCompleteWidget(n),window.onPromptClose=function(){t&&t.destroy()}.bind(this))},toggleAddRowsForm:function(n){var t=typeOf(n)==="null"?!1:n;!t&&Affinity.login.areas.Timesheet.AddUnit?uiconfirm({message:"Select a Timesheet Type",okText:"Timesheet",okColor:"blue",okIcon:Affinity.icons.Clock,cancelText:"Unit",cancelColor:"blue",cancelIcon:Affinity.icons.Gift,noClose:!1,onOk:function(){this.toggleAddRowsFormCont("timesheet")}.bind(this),onCancel:function(){this.toggleAddRowsFormCont("allowance")}.bind(this)}):this.toggleAddRowsFormCont(n)},showMobilePopupEditor:!1,toggleAddRowsFormCont:function(n){var t=typeOf(n)==="null"?"timesheet":n,i=!1,r;if(this.options.timesheetType==="manager")if(typeOf(this.currentSearchEmployee)!=="null")if(this.currentSearchEmployee===!1)i=!0;else{if(t==="timesheet")this.addRows(new Date,new Date,this.currentSearchEmployee);else if(t==="allowance")this.addRows(new Date,new Date,this.currentSearchEmployee,!1,!0);else throw"Can not add timesheet of unknown type ("+t+")";Affinity.mobile&&(this.showMobilePopupEditor=!0);return}else i=!0;else{if(t==="timesheet")this.addRows(new Date);else if(t==="allowance")this.addRows(new Date,null,null,!1,!0);else throw"Can not add timesheet of unknown type ("+t+")";Affinity.mobile&&(this.showMobilePopupEditor=!0);return}i&&(this.addRowEmployeeSelect?this.openSelectEmployee(t):(uialert({message:"Getting Employee list",showLoader:!0,noClose:!0}),r=Affinity.zelosroot+"?api=timesheetAsManager/getEmployees",new Request.JSONP({url:r,callbackKey:"jsoncallback",method:"get",noCache:!0,onComplete:function(n){JSON.Unauthorized(n,'detailed, toggleAddRowsForm "get employees" - '+r)||(this.addRowEmployeeSelect=new Element("select",{"class":"ui-autocomplete ui-autocomplete-center ui-autocomplete-autowidth"}),Array.each(n,function(n){n.Value!==""&&n.Key!==""&&n.Key!==this.defaultEmployeeNumber?this.addRowEmployeeSelect.adopt(new Element("option",{html:n.Value,value:n.Key})):n.Value.trim()===""&&n.Key.trim()===""?this.addRowEmployeeSelect.adopt(new Element("option",{html:"Select Employee",value:""})):this.addRowEmployeeSelect.adopt(new Element("option",{html:"[No Name for "+n.Key+"]",value:n.Key}))}.bind(this)),this.openSelectEmployee(t))}.bind(this),onError:function(){},onFailure:function(){}}).send()))},showAddRowsForm:function(){},hideAddRowsForm:function(){},searchFormSatus:"closed",toggleSearchForm:function(){this.awardModal&&this.awardModal.close(),this.searchFormSatus=="open"?this.hideSearchForm():this.searchFormSatus=="closed"&&this.showSearchForm()},showSearchForm:function(n){typeOf(n)!=="null"&&n.stopPropagation(),this.searchForm&&(this.searchFormButton.dissolve(),this.searchForm.reveal(),this.searchFormSatus="open")},hideSearchForm:function(n){typeOf(n)!=="null"&&n.stopPropagation(),this.searchForm&&(this.searchFormButton.reveal(),this.searchForm.dissolve(),this.searchFormSatus="closed")},sanatiseFromToDates:function(n,t){var i,r,u;return typeOf(n)=="string"?(i=Date.parse(n),i!=null&&i||(i=!1)):i=n,typeOf(t)=="string"?(r=Date.parse(t),t!=null&&t||(t=!1)):r=t,typeOf(i)!="date"||t||(r=i.clone()),typeOf(t)!="date"||n||(i=r.clone()),i&&r&&r<i&&(u=i.clone(),i=r.clone(),r=u,delete u),{fromDate:i,toDate:r}},returnSecondaryAddButton:function(){var n=Affinity.enableFavourites;return this.options.isDual&&(n=!1),this.options.isDual&&this.options.subType==="dual-timesheets"&&(n=!0),[].contains(this.options.timesheetType)&&(n=!1),Affinity.enableFavourites||(n=!1),this.secondaryAddButton=!1,this.secondaryAddAllowanceButton=!1,this.secondaryButtonWrapper=new Element("span",{"class":"no-rows-button-wrapper"}),this.options.isAllowanceGrid?((this.isManagerView||[5111,2591].contains(parseInt(Affinity.login.profile.companyNumber)))&&(this.secondaryAddButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.addrow+"<\/span><span>Add<\/span>"}),this.secondaryAddButton.addEvent(Affinity.events.click,this.secondaryAdd)),this.options.isManager&&!Affinity.isAwardsPopupEnabled()&&(this.secondaryAddButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.addrow+"<\/span><span>Add<\/span>"}),this.secondaryAddButton.addEvent(Affinity.events.click,this.secondaryAdd))):Affinity.login.areas.Timesheet.AddUnit?(this.secondaryAddButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.addrow+"<\/span><span>Add Timesheet<\/span>"}),this.secondaryAddButton.addEvent(Affinity.events.click,this.secondaryAdd),this.secondaryAddAllowanceButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.allowance+"<\/span><span>Add Unit<\/span>"}),this.secondaryAddAllowanceButton.addEvent(Affinity.events.click,this.secondaryAddAllowance)):(this.secondaryAddButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.addrow+"<\/span><span>Add<\/span>"}),this.secondaryAddButton.addEvent(Affinity.events.click,this.secondaryAdd)),this.secondaryAddButton&&this.secondaryAddButton.inject(this.secondaryButtonWrapper),this.secondaryAddAllowanceButton&&new Element("span",{html:"&nbsp;"}).inject(this.secondaryButtonWrapper),this.secondaryAddAllowanceButton&&this.secondaryAddAllowanceButton.inject(this.secondaryButtonWrapper),n&&(new Element("span",{html:"&nbsp;"}).inject(this.secondaryButtonWrapper),this.addAllowanceFromFavButton=new Element("div",{"class":"button blue w-icon-only add-fav footer-add ui-has-tooltip","data-tooltip":this.baseAppLang.favourites.views.detailed.createFromTooltip,"data-tooltip-dir":"top,left",html:"<span>"+this.icons.fav+"<\/span><span>"+this.baseAppLang.favourites.addButtonlabel+"<\/span>"}).inject(this.secondaryButtonWrapper),this.addAllowanceFromFavButton.addEvent(Affinity.events.click,this.secondaryAddAllowance)),this.secondaryButtonWrapper},secondaryAdd:function(n){var i=n?n.target.hasClass("button")?n.target:n.target.getParent(".button"):!1,t,r;if(i&&i.hasClass("add-fav")){this.selectFav(1);return}Affinity.timesheets.init.view==="dualdetail"?(t=this.options.fromDate?this.options.fromDate:new Date,r=this.currentSearchEmployee||this.userData.employeeNumber||Affinity.login.profile.employeeNumber,this.addRows(t,t,r)):this.toggleAddRowsForm("timesheet")},secondaryAddAllowance:function(n){var i=n?n.target.hasClass("button")?n.target:n.target.getParent(".button"):!1,t,r;if(i&&i.hasClass("add-fav")){this.selectFav(2);return}Affinity.timesheets.init.view==="dualdetail"?(t=this.options.fromDate?this.options.fromDate:new Date,r=this.currentSearchEmployee||this.userData.employeeNumber||Affinity.login.profile.employeeNumber,this.addRows(t,t,r,!1,!0)):this.toggleAddRowsForm("allowance")},adding:!1,duplicateTimesheet:function(n){var i,r,t;Array.each(this.options.widgetDocument.Children[n].Children,function(n){n.Name.test("TimesheetId","gi")&&(i=n.ValueAsString),n.Name.test("EmployeeNo","gi")&&(r=n.ValueAsString),n.Name.test("TSDate","gi")&&(t=Date.parse(n.ValueAsString))}),this.addRows(t,t,r,i)},addRows:function(n,t,i,r,u,f,e,o){var y,s,l,a,p,v,c,w,h;if(!this.adding){if(this.loadRequest)try{this.loadRequest.cancel()}catch(b){}if(y=typeOf(o)==="boolean"?o:!1,s=!1,s=this.currentSearchEmployee?this.currentSearchEmployee:s?s:Affinity.login.profile.employeeNumber,s=i||s,!s||s==""){uialert({message:this.genericLang.error+"<br />You are attempting to add a new entry without a Employee Number.",showButtons:!0,noClose:!1});return}if(l=this.tbody.getElements("tr.new"),a=Affinity.mobile?5:10,l.length>=a){s=l=a=null,uialert({message:"You must save your current timesheets before you can add any new ones.",showButtons:!0,noClose:!1});return}this.adding=!0,this.doChangeChecks=!1,v=this.sanatiseFromToDates(n,t),n=v.fromDate,t=v.toDate,this.options.isDual||n.clone().clearTime().getTime()!==t.clone().clearTime().getTime()||(t=t.increment("day",1)),n&&t?(h=this.options.getEmptyTimesheetApi,h+=s?"&employeeNo="+s:"",h+=r?"&timesheetId="+r:"",h+="&FromDate="+n.toZelos()+"&ToDate="+t.toZelos(),typeOf(u)==="boolean"&&u===!0&&(h=h.replace(new RegExp("getEmptyTimesheet","gi"),"GetEmptyAllowance")),typeof f=="string"&&f!==""&&(h+="&favouriteName="+f),function(){log('&#x2794; attempting detailed addRows "get empty timesheets" ...'),this.loadRequest=new Request.JSON({url:h,method:"get",timeout:6e5,noCache:!0,onSuccess:function(n){if(!JSON.Unauthorized(n,"detailed, addRows - "+h)){if(n.error)log('&#x2718; attempted detailed addRows "get empty timesheets" succeeded with errors - '+n.error),window.uialert({message:n.error+"<br />"+h});else{log('&#x2714; attempted detailed addRows "get empty timesheets" succeeded');var t=0;this.options.widgetDocument.Children?t=this.options.widgetDocument.Children.length:this.options.widgetDocument.Children=[],this.setTableClass(),Array.each(n,function(n,t){for(t=n.Children.length-1;t>-1;t--){if(n.Children[t].Name.test("TsDate","gi")&&!n.Children[t].Attribute.IsReadOnly&&(n.Children[t].ElementType="FieldEdit",typeOf(e)==="null"))break;typeOf(e)!=="null"&&(n.Children[t].Name.test("TsUnit","gi")||n.Children[t].Name.test("TsNet","gi"))&&(n.Children[t].Value=parseFloat(e),n.Children[t].ValueAsString=e+"")}this.options.widgetDocument.Children.push(n),c=this.returnNewRow(n,!0),c&&c.inject(this.tbody)}.bind(this)),p=c?this.processUI(!0,c):this.processUI(!0),Affinity.prompts.hide()}this.adding=!1,c&&y&&Array.each(c.getElements("td.buttons span.timesheet-button"),function(n){n&&n.get("data-type")&&n.get("data-type").toLowerCase().trim()==="submit"&&this.checkNoRows()&&this.buttonClicked({target:n})}.bind(this))}}.bind(this),onError:function(n,t){log('&#x2718; attempted detailed addRows "get empty timesheets" failed with errors - '+t),window.uialert({message:t}),this.adding=!1}.bind(this),onFailure:function(n){log('&#x2718; attempted detailed addRows "get empty timesheets" failed - '+n.statusText),window.uialert({message:n.statusText}),this.adding=!1}.bind(this)}).get()}.delay(500,this)):(window.uialert({message:"From and To dates are invalid"}),this.adding=!1),v=s=c=w=l=a=null}},getSubstitutedName:function(n,t){var i=n.match(/-Row[0-9A-Za-z-]+[A-Z]-/)[0],r=i.substring(i.length-2),u="-Row"+i.substring(4,i.length-2)+r,f="-Row"+t+r;return n.replace(u,f)},awardModal:!1,showAwards:function(n){var i,t,f;if(!Affinity.isAwardsPopupEnabled())return!1;if(isNaN(n))if("target"in n)if(n.target.getParent("tr"))i=this.tableRows.indexOf(n.target.getParent("tr"));else return;else return;else i=n;var r=this.tableRows[i],u=[],e=r.querySelectorAll(".message-icon.info");e.length>0&&e.forEach(function(n){n.dataset.tooltip&&n.dataset.tooltip!==""&&(n.dataset.tooltip.contains(",")?n.dataset.tooltip.split(",").forEach(function(n){u.push(n)}):u.push(n.dataset.tooltip))}),t=r.getBoundingClientRect(),f={row:r,iconData:u,returnRowMethod:this.returnNewRow.bind(this),startPosition:{x:t.left+15,y:t.top+t.height-5}},this.awardModal?this.awardModal.set(f):this.awardModal=new ZelosAwardModal(f)},buttonClicked:function(n){var u,c,w,b,l,a,e,s,i,h,o;Affinity.tooltips.hideAll();var t=n.target.hasClass("button")?n.target:n.target.getParent(".button"),v=n.target.classList.contains("message-icon")?n.target:n.target.getParent(".message-icon"),y=t?t.retrieve("cfbutton")?t.retrieve("cfbutton"):t:!1;if(t=t?t:v?v:!1,!t)return!1;var f=t.getParent(".button-container")?document.id(t.getParent(".button-container").get("data-menu-id")):!1,r=t.getParent("tr")?t.getParent("tr"):t.get("data-row-ref")?this.table.getElement("tr#"+t.get("data-row-ref")):!1,u=r?this.tableRows.indexOf(r):!1;if(u===!1||u<0){uialert({message:"Could not identify Timesheet. Please refresh and try again.",showButtons:!0});return}if(u=r?this.tableRows.indexOf(r):!1,document.getElement(".button-menu-closer")&&document.getElement(".button-menu-closer").addClass("hidden"),f&&Array.each(this.table.getParent().getElements(".button-menu-container"),function(n){n!==f&&n.dissolve()}),t.hasClass("button-menu-button")){if(f)if(f.getStyle("display")==="block")f.dissolve();else{var p=t.getPosition(t.getParent(".section")),k=t.getParent(".section").getSize(),d=t.getSize();f.setStyles({top:p.y-5,right:k.x-p.x-d.x-2}),f.reveal(),document.getElement(".button-menu-closer").removeClass("hidden")}return}t.getParent(".button-menu-container")&&t.getParent(".button-menu-container").dissolve();try{n.preventDefault(),n.stopPropagation()}catch(g){}if(t.get("data-type")==="FormEdit")this.popupEditForm({target:t.getParent("tr")});else if(t.get("data-type")==="Delete"){if(r.hasClass("new")){this.destroyRow(r);return}Array.each(r.getElements("input,select,textarea"),function(n){n.hasClass("validate")&&n.get("data-validate-method")&&n.get("data-validate-method").contains("hasvalue")&&(c=n.get("data-validate-method").split(","),n.value=c.contains("float")||c.contains("int")||c.contains("number")?0:"empty")}),this.rowValidationPassed(y,r,u,n)}else t.get("data-type")==="Duplicate"?(Array.each(this.options.widgetDocument.Children[u].Children,function(n){n.Name.test("TimesheetId","gi")&&(w=n.ValueAsString),n.Name.test("EmployeeNo","gi")&&(b=n.ValueAsString),n.Name.test("TSDate","gi")&&(l=Date.parse(n.ValueAsString))}),this.addRows(l,l,b,w)):t.get("data-type")==="Favourite"?(a=!1,r&&u!==!1&&(e=this.options.widgetDocument.Children[u],e.hasOwnProperty("Data")&&e.Data.hasOwnProperty("FavouriteName")&&(a=e.Data.FavouriteName.trim()!==""?e.Data.FavouriteName.trim():!1),this.promptFavName(t,e,a))):t.get("data-type")==="Awards"?this.showAwards(u):t.get("data-type")==="Obscured"?(h=r.getElement(t.get("data-col-ref")),s=h.getElement(".subhidden")?h.getElement(".subhidden").getElement("input,textarea,select"):h.getElement("input,textarea,select"),i=s.clone(),i.value=s.value,uialert({message:"Set "+t.get("data-display")+"<br /><br />",showButtons:!0,showCancel:!0,onClose:function(){i.retrieve("widget")&&"destroy"in i.retrieve("widget")&&(i.retrieve("widget").destroy(),i.removeEvent("change"))}}),Affinity.prompts.adopt(i),i.get("tag")==="select"?(i.set("class",""),new UIAutoCompleteWidget({stopInitialChange:!0,selectElement:i})):new Affinity.FormElement(i),i.addEvent("change",function(){s.value=i.value,s.fireEvent("change"),this.hasRowChanged(h)}.bind(this))):(o=new UIFormValidation({target:r,onValidateCallback:function(){this.rowValidationPassed(y,r,u,n),o.destroy(),delete o}.bind(this),onValidateFailCallback:function(){o.destroy(),delete o}.bind(this)}),o.validate())},promptFavName:function(n,t,i,r,u){var f=i?this.baseAppLang.favourites.renameMessage:this.baseAppLang.favourites.views.detailed.createMessage;typeOf(r)==="string"&&(r=r.trim().length===0?this.genericLang.error:r,f=r+"<br />Please try again."),uiprompt({message:f,showButtons:!0,value:typeOf(u)==="string"?u:i?i:"",onOk:function(r){var u=this.baseLang.favourites.validation.validateName(r);if(!u.isValid){this.promptFavName.delay(50,this,[n,t,i,u.error,r]);return}this.saveFav(n,r,i?i:!1)}.bind(this)})},returnFavHash:function(n){var t=[];return Object.each(JSON.decode(n.Fields),function(n,i){t.push(i+":"+n)}),t.push("Type:"+n.Type),t.push("EmployeeNo:"+n.EmployeeNo),t.push("Name:"+n.Name),t.sort(),t=t.join(",")},selectFav:function(){var n;uiloader({message:this.baseAppLang.favourites.loadingMessage,type:this.viewName}),n=Affinity.zelosroot+"?api=Favourite/GetFavouriteNamesExt&EmployeeNo="+Affinity.login.profile.employeeNumber,this.isManagerView&&(n=Affinity.zelosroot+"?api=Favourite/GetFavouriteNamesExt"),new Request.JSON({url:n,onSuccess:function(n){var r,t,i;if("error"in n&&n.error!==!1||typeOf(n)!=="array"){uialert({message:this.baseAppLang.favourites.loadError,showButtons:!0,type:this.viewName});return}if(n.length===0){uialert({message:this.baseAppLang.favourites.loadNoneError,showButtons:!0,type:this.viewName});return}r=this.isManagerView?Affinity.FavResultSort(n,"Name","EmployeeName"):Affinity.FavResultSort(n,"Name"),t=[],this.favouriteData=[],Array.each(r,function(n){i=this.returnFavHash(n),t.indexOf(i)===-1&&(this.favouriteData.push(n),t.push(i))}.bind(this)),this.showFavSelect(this.favouriteData)}.bind(this)}).get()},showFavSelect:function(n,t){var h=t||"",o=this.baseAppLang.favourites.selectLabel,i,u,r,s,f,e;h!==""&&(o=t+"<br />"+this.baseAppLang.favourites.selectLabel),i=new Element("select"),new Element("option",{html:this.baseAppLang.favourites.selectLabel,value:""}).inject(i),Array.each(n,function(n){r=!1,(n.Type===1||n.Type===2)&&(this.options.isDual?(s=this.isManagerView?this.userData.employeeNumber:Affinity.login.profile.employeeNumber,parseInt(n.EmployeeNo)===parseInt(s)&&(r=!0,f=!1)):(r=!0,this.isManagerView&&(f=!0))),r&&(e=n.Name,f&&(e=parseInt(n.EmployeeNo)===parseInt(Affinity.login.profile.employeeNumber)?"Me : "+n.Name:n.EmployeeName+" : "+n.Name),new Element("option",{html:e,value:'{"name":"'+n.Name+'","emp":"'+n.EmployeeNo+'","type":"'+n.Type+'"}'}).inject(i))}.bind(this)),i.addClass("hidden"),uialert({message:o,showButtons:!0,showCancel:!0,type:this.viewName+"FavSelect",onOk:function(){var t=new Date,n;if(this.options.isDual&&(t=this.loadTimesheetsFrom),i.value!==""){n=JSON.decode(i.value);switch(n.type){case"4":uialert({message:"This view does not support Mileage"});break;case"3":uialert({message:"This view does not support Leave"});break;case"2":this.addRows(t.clone(),t.clone(),n.emp,!1,!0,n.name);break;case"1":default:this.addRows(t.clone(),t.clone(),n.emp,!1,!1,n.name)}}}.bind(this)}),Affinity.prompts.adopt(new Element("br"),new Element("br"),i,new Element("br")),function(){i.removeClass("hidden"),u=new UIAutoCompleteWidget({stopInitialChange:!1,selectElement:i,onComplete:function(){prompts.center()}}),window.onPromptClose=function(){i&&u&&u.destroy()}.bind(this)}.delay(250,this)},saveFav:function(n,t,i){var h=n.get("data-row-ref"),o=this.table.getElement("#"+h),u=this.tableRows.indexOf(o),c=this.options.widgetDocument.Children[u],r=JSON.parse(JSON.stringify(c)+""),f=Affinity.login.profile.employeeNumber,e=1,s,l;r.Data.IsFavourite=!0,r.Data.FavouriteName=t,Array.each(r.Children,function(n,t){i&&new RegExp("TimesheetType","gi").test(n.Name)&&(e=n.hasOwnProperty("Value")?parseInt(n.Value):e),i&&new RegExp("EmployeeNo","gi").test(n.Name)&&(f=n.hasOwnProperty("Value")?n.Value:f),!i&&new RegExp("RowButton","gi").test(n.Name)&&Array.each(n.Children,function(n,i){r.Children[t].Children[i].Value.Pressed=!1,new RegExp("Favourite","gi").test(n.Name)&&(r.Children[t].Children[i].Value.Pressed=!0),r.Children[t].Children[i].ValueAsString=JSON.stringify(r.Children[t].Children[i].Value)}.bind(this))}.bind(this)),i?(s=Affinity.zelosroot+"?api=Favourite/RenameFavourite?OldName="+i+"&NewName="+t+"&timesheetType="+e+"&employeeNo="+f,uiloader({message:this.baseAppLang.favourites.renamingMessage,type:this.viewName+"FavRenaming"}),l=new Request.JSON({url:s,onComplete:function(n){if(n.hasOwnProperty("success")&&n.success===!1&&n.hasOwnProperty("error")&&typeOf(n.error)==="string"){var t=n.error.trim()!==""?n.error.trim():this.genericLang.error,t=Affinity.CheckFavError(n,t);uialert({message:this.genericLang.errorPrefix+" "+t+"<br />"+this.genericLang.tryAgain,showButtons:!0,type:this.viewName+"FavRenaming"});return}setTimeout(function(){uialert({message:this.globalLang.waitForNameChange+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),setTimeout(function(){this.refresh()}.bind(this),3e3)}.bind(this),3e3)}.bind(this),onFailure:function(){uialert({message:this.genericLang.error+"<br />"+this.genericLang.tryAgain,showButtons:!0,type:this.viewName+"FavRenaming"})}.bind(this),onError:function(n){var t=Affinity.CheckFavError(n,this.genericLang.error+"<br />"+this.genericLang.tryAgain);uialert({message:t,showButtons:!0,type:this.viewName+"FavRenaming"})}.bind(this)}).post()):(this.options.widgetDocument.Children[u]=r,this.postDocumentRow({rowIndex:u,row:o,messagea:"saving "+this.baseLang.favourites.name,messageb:"saved "+this.baseLang.favourites.name,isfave:!0}))},sanatisePostDocument:function(n){return Affinity.timesheets.methods.sanatisePostDocument(n)},promptVisible:!1,postDocumentRow:function(n){var h=!1,f,c,e,o,t,i,r=!1,s=!1,l=!0;if(n!==null&&n!==undefined&&n.hasOwnProperty("isfave")&&typeof n.isfave=="boolean"&&n.isfave===!0&&(l=!1),n.hasOwnProperty("rowIndex"))e=n.row,o=n.rowIndex,t=n.messagea||"saving",i=n.messageb||"saved",r="timesheet",s="Timesheet";else if(f=n.target.hasClass("button")?n.target:n.target.getParent(".button"),c=f.retrieve("cfbutton")?f.retrieve("cfbutton"):f,e=c.getParent("tr"),o=this.tbody.getElements("tr.timesheet-row").indexOf(e),t="saving",i="saved",r="timesheet",s="Timesheet",n!==null)switch(f.get("data-type")){case"Submit":t="submitting",i="submitted";break;case"Accept":t="approving",i="approved";break;case"Decline":t="declining",i="declined";break;case"Delete":h=!0,t="deleting",i="deleted";break;default:t="saving",i="saved"}!r&&t.contains(this.baseLang.favourites.name)&&(t=t.replace(this.baseLang.favourites.name,"").trim(),i=i.replace(this.baseLang.favourites.name,"").trim(),r=this.baseLang.favourites.name,s=this.baseLang.favourites.title),this.errormsg='Timesheet(s) processed with errors.<span class="hidden"> while '+i+"<\/span><br />",this.promptVisible=!0,uiloader({message:t.capitalize(),type:this.viewName});var v=this.options.widgetDocument.Children[o],u=Object.clone(this.options.parentDocument),a=Object.clone(this.options.widgetDocument);a.Children=[v],u.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex]=a,u=this.sanatisePostDocument(u),l&&(u.Children[0].Children[0]=this.cleanFavData(null,u.Children[0].Children[0])),log("&#x2794; attempting detailed postDocumentRow ..."),new Request.JSON({url:this.options.putApi,timeout:9e5,onSuccess:function(n){var u,o,c;if(!JSON.Unauthorized(n,"detailed, postDocumentRow - "+this.options.putApi))if(u=this.processErrors(n),u.length===0){log("&#x2714; attempted detailed postDocumentRow succeeded");var t="Children"in n?n.Children[0].Children[0].Children[0]:!1,s=!0,f="";!t||"Children"in t||"Message"in t.Attribute&&t.Attribute.Message.trim()!==""&&(this.destroyRow(e),f=this.genericLang.successPrefix+" Your "+r+" has been "+i+".<br /><br />"+t.Attribute.Message.trim(),window.uialert({message:f,noClose:!1,showButtons:!0,type:this.viewName}),s=!1),this.promptVisible&&s&&(f=this.genericLang.successPrefix+" Your "+r+" has been "+i+".",uialert({message:f,noClose:!0,showButtons:!0,type:this.viewName}),function(){Affinity.prompts.hide()}.delay(1500,this),this.promptVisible=!1),o=this.tableRows.indexOf(e),h?(this.delWidgetDocumentRow(o),this.options.widgetDocument.Layout.DataTotal--,this.totalTimesheets=this.options.widgetDocument.Layout.DataTotal):(c=n.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex].Children[0],this.putWidgetDocumentRow(o,c,u)),this.fireEvent("processComplete"),this.processUI()}else log("&#x2718; attempted detailed postDocumentRow succeeded with errors - "+u.join(", "))}.bind(this),onError:function(n,i){if(typeOf(i)==="object")if("message"in i)i=i.message;else{var u=i.toString();if(u.contains("401")&&Affinity&&Affinity.login&&Affinity.login.session){log("&#x270B; attempted detailed postDocumentRow unauthorized &#x270B;"),window.fireEvent("unauthorized");return}i=="unknown"}typeOf(i)==="string"&&i.contains("401")?(log("&#x270B; attempted detailed postDocumentRow unauthorized &#x270B;"),Affinity&&Affinity.login&&Affinity.login.session?window.fireEvent("unauthorized"):uialert({message:this.genericLang.errorPrefix+" We had trouble "+t.toLowerCase()+" your "+r+".<br />You have been logged out by another system. Please try logging in again.",showButtons:!0,type:this.viewName})):(log("&#x2718; attempted detailed postDocumentRow failed with errors - "+i),uialert({message:this.genericLang.errorPrefix+" We had trouble "+t.toLowerCase()+" your "+r+".<br />"+i,showButtons:!0,type:this.viewName}))}.bind(this),onFailure:function(n,i){var u=n.response?n.response:n.responseText?n.responseText:i;u&&u.contains("401")?(log("&#x270B; attempted detailed postDocumentRow unauthorized &#x270B;"),Affinity&&Affinity.login&&Affinity.login.session?window.fireEvent("unauthorized"):uialert({message:this.genericLang.errorPrefix+" We had trouble "+t.toLowerCase()+" your "+r+".<br />"+n.statusText,showButtons:!0,type:this.viewName})):(log("&#x2718; attempted detailed postDocumentRow failed - "+i),uialert({message:this.genericLang.errorPrefix+" We had trouble "+t.toLowerCase()+" your "+r+".<br />"+n.statusText,showButtons:!0,type:this.viewName}))}.bind(this),onException:function(n,t){log("&#x2718; attempted detailed postDocumentRow failed with exception - "+n+": "+t),uialert({message:this.genericLang.error+"<br />There was a problem with the header "+n+": "+t,showButtons:!0,type:this.viewName})}.bind(this),onTimeout:function(){log("&#x2718; attempted detailed postDocumentRow timed out"),uialert({message:this.genericLang.errorPrefix+" We reached the timeout limit!<br />Please check your connection and try again.",showButtons:!0,type:this.viewName})}}).post("="+escape(JSON.stringify(u)))},rowValidationPassed:function(n,t,i,r){var e,u,o,f;this.updateWidgetDocument(),e=[],Array.each(this.options.widgetDocument.Children,function(n){n.Data.RowType||e.push(n)}),u=Object.clone(e[i]),delete e,o=n.get("id"),f=u.Children.length-1,Array.each(u.Children[f].Children,function(n,t){u.Children[f].Children[t].Value.Pressed=n.Name===o?!0:!1,u.Children[f].Children[t].ValueAsString=JSON.stringify(u.Children[f].Children[t].Value)}),this.options.widgetDocument.Children[i]=u,delete u,delete o,delete f,this.postDocumentRow(r)},processErrors:function(n,t){var i=[],u=0,r;if(n.error?i.push(n.error):Array.each(n.Children,function(n){Array.each(n.Children,function(n){n.ElementType=="TimesheetTable"&&Array.each(n.Children,function(n){n.Data&&n.Data.RowType||(n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&i.push("Row "+(u+1)+" has an error : "+n.Attribute.ErrorMessage),Array.each(n.Children,function(n,t){n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&i.push("Row "+(u+1)+" column "+(t+1)+" has an error : "+n.Attribute.ErrorMessage)}.bind(this)),u++)}.bind(this))}.bind(this))}.bind(this)),typeof t!="undefined"&&t===!0){this.refresh(null,i);return}return this.promptVisible&&i.length>0&&(r=this.errormsg+i.join("<br />"),i.length==1&&(r=r.replace("Row 1","A row")),uialert({message:this.genericLang.error+"<br />"+r,showButtons:!0,type:this.viewName}),this.promptVisible=!1),i},checkSelected:function(){var n=!1,t=!0;return Array.each(this.tbody.getElements(".check input"),function(i){i.checked?n=!0:t=!1}.bind(this)),{anyChecked:n,allChecked:t}},rendered:!1,renderCheckTimer:!1,renderCheck:function(){var t,n,r,i,u,f;clearTimeout(this.renderCheckTimer),this.options.target.getElement("table.timesheet")&&(this.rendered=!0),this.rendered?(t=this.options.target.getParent("form"),this.isManagerView&&(n=t&&typeOf(t)!=="null"?t.getElement("select#ForwardTo"):!1,r=n&&typeOf(n)!=="null"?!n.hasClass("widget"):!1,n&&n.getParent(".form-row")&&(n.getParent(".form-row").addClass("inline"),n.getParent(".form-row").getParent().getElement(".form-row.buttons")&&n.getParent(".form-row").getParent().getElement(".form-row.buttons").addClass("inline")),r&&(n.getElement("option")&&n.getElement("option").get("html")!==""&&new Element("option",{selected:"selected"}).inject(n,"top"),this.frowardWidget=new UIAutoCompleteWidget({selectElement:n}))),i=t?t.getElements(".form-row.buttons"):!1,Affinity.mobile&&i&&i.length>0&&!i.getLast().getElement(".mobile-select-message")&&(u=t.getElements(".form-row.buttons").getLast(),f=u.getElement(".button-wrapper"),new Element("div",{"class":"mobile-select-message",html:"Swipe row right to select, swipe row left to deselect"}).inject(f,"before"))):this.renderCheckTimer=this.renderCheck.delay(50,this)},checkNoRows:function(){return(this.tableRows=this.tbody&&this.tbody.getElements("tr.timesheet-row")&&this.tbody.getElements("tr.timesheet-row").length>0?this.tbody.getElements("tr.timesheet-row"):[],this.tableRows.length>0?(this.setHasRows(),this.thead.getElements("th").length===0&&this.buildTableHeader(),this.tfoot.getElements("th").length===0&&this.buildTableFooter()):(this.setNoRows(),this.secondaryAddButton||this.returnSecondaryAddButton(),this.secondaryButtonWrapper.inject(this.norows)),this.tableRows.length>0)?!0:!1},processUIThrottle:!1,processUI:function(n,t){clearTimeout(this.processUIThrottle),this.processUIThrottle=this.continueProcessUI.delay(100,this[(n,t)])},continueProcessUI:function(n,t){var f=n?!1:!0,i=t||!1,u,r;return this.debug&&(console.log("%cProcess UI","background: #9d9dfd; color: white"),console.time("Process UI")),this.checkNoRows(),f&&(this.buildTableHeader(),this.buildTableFooter(),this.renderPagination()),i?i.hasClass("new")||i.hasClass("modified")?this.setUnload():this.delUnload():this.tbody.getElements("tr.new").length>0||this.tbody.getElements("tr.modified").length>0?this.setUnload():this.delUnload(),this.setTableClass(),Affinity.uiGrid&&Affinity.uiGrid.zebra(this.table,"timesheet-row"),this.readonly&&document.uiSortableGrid&&document.uiSortableGrid.processTable(this.table,"timesheet-row"),u=i?i.getElements(".has-dependencies"):this.table.getElements(".has-dependencies"),Array.each(u,function(n){if(r=n.retrieve("dependencies"),r&&"setEvents"in r)"eventsset"in r&&!r.eventsset&&r.setEvents();else try{var i=n.getParent("tr"),t="";t+="!!!\tDependency issue found\r\n",t+="\tDependency not established when processing UI (Could not find widget on element)\r\n",t+="\tTime:\t"+(new Date).toTime()+"\r\n",t+="\tElement ID:\t"+n.get("id")+"\r\n",t+="\tElement Class:\t"+n.get("class")+"\r\n",t+="\tRow ID:\t"+i.get("id")+"\r\n",t+="\tRow Class:\t"+i.get("class")+"\r\n",t+="!!!",log(t)}catch(u){}}.bind(this)),Affinity.tooltips&&Affinity.tooltips.processNew(),Affinity.lookups&&Affinity.lookups.processNew({jsonp:!0}),Affinity.displaylookups&&Affinity.displaylookups.processNew({jsonp:!0}),Affinity.uiDrawPanels&&Affinity.uiDrawPanels.processNew(),Affinity.uiDateCalendar&&(u=i?i.getElements(".input.uidate-calendar"):this.table.getElements(".input.uidate-calendar"),Array.each(u,function(n){new UIDateTimeWidget({target:n,showTime:!0})}.bind(this)),i?i.getElements(".ui-calendar-button.blue").addClass("hide1024 hide1350 hide1620"):this.table.getElements(".ui-calendar-button.blue").addClass("hide1024 hide1350 hide1620")),this.doChangeChecks=!0,clearTimeout(this.renderCheckTimer),this.renderCheckTimer=this.renderCheck.delay(50,this),this.debug&&(console.timeEnd("Process UI"),console.log("%c\tUI Processed","background: #9d9dfd; color: white;")),this.showMobilePopupEditor&&(this.popupEditForm({target:this.tableRows.getLast()}),this.showMobilePopupEditor=!1),this.forceCheckNewRows(),!0},forceCheckNewRows:function(){document.querySelectorAll("tr.timesheet-row.new .active.check input").forEach(function(n){n.checked=!0})},newRowsLoader:null,loadNewRows:function(n,t,i){if(this.doChangeChecks=!1,this.newRowsLoader)try{this.newRowsLoader.cancel()}catch(r){}this.getApi=n,log("&#x2794; attempting detailed loadNewRows ..."),this.newRowsLoader=new ZelosTemplateLoad({noCache:!0,onRequest:function(){if(this.showAlerts){var n=t.length>15?t:t+"ing";uiloader({message:n,type:this.viewName}),t="Search"}}.bind(this),onError:function(n){log("&#x2718; attempted detailed loadNewRows failed with errors - "+n),this.showAlerts&&uialert({message:t+" "+this.genericLang.failed+"<br />"+n,type:this.viewName}),this.newRowsLoader=!1,this.refreshing=!1}.bind(this),onFailure:function(n){log("&#x2718; attempted detailed loadNewRows failed - "+n.statusText),this.showAlerts&&uialert({message:t+" "+this.genericLang.failed,type:this.viewName}),this.newRowsLoader=!1,this.refreshing=!1}.bind(this),onComplete:function(t){var r,u;if(!JSON.Unauthorized(t,"detailed, loadNewRows - "+n)){if(log("&#x2714; attempted detailed loadNewRows succeeded"),this.debug&&(console.log("%cAdd New Rows","background: #44b5ec; color: white"),console.time("Add New Rows")),this.destroyRows()){if(this.putWidgetDocument(t.Children[0].Children[0]),typeOf(this.options.widgetDocument.Children)=="array"&&this.options.widgetDocument.Children.length>0&&Array.each(this.options.widgetDocument.Children,function(n){u=this.returnNewRow(n),u&&u.inject(this.tbody)}.bind(this)),this.checkColumnMisssAligned()){this.refreshing=!1,this.refresh();return}this.filterFromRefresh||this.hideSearchForm(),this.filterFromRefresh=!1,this.processUI(),this.showAlerts&&(r=function(){var n=!1;Affinity.prompts.currentObj!==undefined&&Affinity.prompts.currentObj.isCloseOnClick!==undefined&&(n=Affinity.prompts.currentObj.isCloseOnClick),n===!1&&Affinity.prompts.hide()}.delay(2e3,this)),this.newRowsLoader=!1,typeOf(i)!=="null"&&i.length>0&&this.showAlerts&&(clearTimeout(r),i.length==1?uialert({message:this.genericLang.error+"<br />"+i.join("<br />").replace("Row 1","A row"),showButtons:!0,type:this.viewName}):uialert({message:this.genericLang.error+"<br />"+i.join("<br />"),showButtons:!0,type:this.viewName}))}this.debug&&(console.timeEnd("Add New Rows"),console.log("%c\tNew Rows Added","background: #44b5ec; color: white;")),this.messageBucket.length>0&&(clearTimeout(r),window.uialert({message:this.messageBucket.join("<br />"),showButtons:!0,type:this.viewName}),this.messageBucket=[]),this.addGlobalElementChangeEvent(),this.refreshing=!1,this.fireEvent("newRowsLoaded")}}.bind(this)}),this.removeGlobalElementChangeEvent(),this.newRowsLoader.loadTemplate(n)},adjustFilterDates:function(n){if(n){var u,t=!1,i=!1,r=n.target.hasClass("button")?n.target:n.target.getParent("button");if(r){u=r.hasClass("filter-last-period")?"last":r.hasClass("filter-current-period")?"current":r.hasClass("filter-next-period")?"next":"unknown";switch(u){case"last":if(Affinity.login.profile.payPeriods.periodCurrentIndex<=0){uialert({message:this.globalLang.noUserPastPeriods,showButtons:!0,showLoader:!1,noClose:!1});return}t=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex-1].from,i=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex-1].to;break;case"current":t=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex].from,i=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex].to;break;case"next":if(Affinity.login.profile.payPeriods.periodCurrentIndex===Affinity.login.profile.payPeriods.periods.length){uialert({message:this.globalLang.noUserFuturePeriods,showButtons:!0,showLoader:!1,noClose:!1});return}t=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex+1].from,i=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex+1].to}t&&i&&(this.searchFrom.setDate(t),this.searchTo.setDate(i))}}},filterQueryObject:!1,filterDelay:!1,doSearch:function(n,t){var i=typeOf(t)==="boolean"?t:!1;i||uiloader({message:typeOf(n)==="string"&&n!==""?n:"Searching",type:this.viewName+"Search"}),clearTimeout(this.filterDelay),this.filterDelay=function(){var r=[],l=this.searchFrom.getRawDate(),a=this.searchTo.getRawDate(),e=this.sanatiseFromToDates(l,a),v=this.getApi,s=new URI(v),t=s.parsed.query.parseQueryString(),f,u;e.fromDate&&(t.fromDate=Date.parse(e.fromDate).format("%d.%b.%Y"),r.push("Date From "+Date.parse(e.fromDate).format("%d/%m/%Y"))),e.toDate&&(t.toDate=Date.parse(e.toDate).format("%d.%b.%Y"),r.push("Date To "+Date.parse(e.toDate).format("%d/%m/%Y"))),this.currentSearchEmployee=!1,this.searchEmployee&&(t.employeeNo=this.searchEmployee.value,this.searchEmployee.value!==""&&(this.currentSearchEmployee=this.searchEmployee.value,r.push("Employee "+this.searchEmployee.value))),this.searchPayPoint&&(t.PayPoint=this.searchPayPoint.value,this.currentSearchPayPoint=this.searchPayPoint.value,this.searchPayPoint.value!==""&&r.push("Pay Point "+this.searchPayPoint.value)),this.searchEmployeeGroups&&(t.TimesheetRole=this.searchEmployeeGroups.value,this.currentSearchEmployeeGroup=this.searchEmployeeGroups.value,this.searchEmployeeGroups.value!==""&&r.push("Group "+this.searchEmployeeGroups.value));var o=!1,h=!1,c=[];this.searchScreenFilters&&this.searchScreenFilters.length>0&&(Array.each(this.searchScreenFilters,function(n){n.get("data-field-name")==="MethodFilter"?(o=n.value,h=n.options[n.selectedIndex].text):n.value!==""?(t[n.get("data-field-name")]=n.value,c.push(n.get("data-label")+" is '"+n.value+"'")):delete t[n.get("data-field-name")]}.bind(this)),c.length>0&&r.push("Where "+c.join(" & "))),this.searchStatus&&(f=[],t.timesheetStatus="",Array.each(this.supportedStatus,function(n){this.searchStatus.getElement(".searchStatusCheck-d-"+n)&&this.searchStatus.getElement(".searchStatusCheck-d-"+n).checked&&f.push(n)}.bind(this)),t.timesheetStatus=f.join(","),this.currentSearchStatus=f.join(","),f.length>0&&r.push("Status "+f.join(" and ")),delete f),u=!1,this.immutibleFilter&&this.immutibleFilter.getElement(".searchExcludeLockedCheck-d").checked&&(u="dont_return_locked",r.push("Excluding Locked")),this.managedFilter&&this.managedFilter.getElement(".searchMangedOnlyCheck-d").checked&&(u?u+=",dont_return_managed":u="dont_return_managed",r.push("My timesheets to approve only")),this.managedFilter&&o&&(u?u+=",MethodFilter"+o:u="MethodFilter"+o,r.push(h.charAt(0).toUpperCase()+h.slice(1))),u===!1?(t.DefaultRosterGroup=null,delete t.DefaultRosterGroup):t.DefaultRosterGroup=u,this.filterQueryObject=t,t.page=0,s.parsed.query=Object.toQueryString(t),url=s.toString(),this.filterStrBox.set("html","Filtered By: "+r.join(", ")),i||this.loadNewRows(url,typeOf(n)==="string"&&n!==""?n:"Search")}.delay(500,this)},renderPagination:function(){var i,t,n;if(this.options.paginate){for(t=this.options.widgetDocument.Layout,this.pageSize=t.PageSize,this.totalPages=t.PageTotal,this.currentPage=t.PageNumber,this.totalTimesheets=t.DataTotal,this.timsheetRowfrom=this.currentPage*this.pageSize+1,this.timesheetRowTo=this.currentPage*this.pageSize+this.pageSize,this.timesheetRowTo>this.totalTimesheets&&(this.timesheetRowTo=this.totalTimesheets),this.paginationContainer.empty(),new Element("span",{html:"previous","class":this.currentPage==0?"disabled":""}).inject(this.paginationContainer).addEvent(Affinity.events.click,this.getPreviousPage),n=0;n<this.totalPages;n++)i=n==this.currentPage?"page selected":"page",i+=" page"+n,new Element("span",{html:n+1,"class":i,"data-page":n}).inject(this.paginationContainer).addEvent(Affinity.events.click,this.getPage);new Element("span",{html:"next","class":this.currentPage+1>=this.totalPages||this.totalPages==0?"disabled":""}).inject(this.paginationContainer).addEvent(Affinity.events.click,this.getNextPage),new Element("br").inject(this.paginationContainer),new Element("span",{html:"Showing Timesheet(s) "+this.timsheetRowfrom+" to "+this.timesheetRowTo+" of "+this.totalTimesheets,"class":"disabled","class":"desc"}).inject(this.paginationContainer),this.totalTimesheets===0?this.paginationContainer.addClass("hidden"):this.paginationContainer.removeClass("hidden")}},getNextPage:function(n){n.target.hasClass("disabled")||this.currentPage<this.totalPages&&this.paginationContainer.getElement(".page"+(this.currentPage+1))&&this.getPage({target:this.paginationContainer.getElement(".page"+(this.currentPage+1))})},getPreviousPage:function(n){n.target.hasClass("disabled")||this.currentPage>0&&this.paginationContainer.getElement(".page"+(this.currentPage-1))&&this.getPage({target:this.paginationContainer.getElement(".page"+(this.currentPage-1))})},getPage:function(n){var r=n.target.hasClass("page")?n.target:n.target.getParent(".page"),i=new URI(this.getApi),t=typeOf(i.parsed.query)==="null"?{}:i.parsed.query.parseQueryString();t.fromDate=this.loadTimesheetsFrom.format("%d.%b.%Y"),t.toDate=this.loadTimesheetsTo.format("%d.%b.%Y"),this.filterQueryObject&&Object.merge(t,this.filterQueryObject),t.page=parseInt(r.get("data-page")),t.view="detail",this.options.isDual&&(t.view="daydetail"),t.ran=String.uniqueID(),i.parsed.query=Object.toQueryString(t),this.currentPage=t.page+0,this.loadNewRows(i.toString(),"Load")},subMenuOpen:!1,subMenuOpenDelay:!1,subMenuCloseDelay:!1,subMenuOver:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay),n.delay=0,this.showButtons(n)},subMenuOut:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay),n.delay=0,this.hideButtons(n)},showButtons:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay);var t=250;n.hasOwnProperty("delay")&&(t=n.delay),this.subMenuOpenDelay=setTimeout(function(){var t=n.target.hasClass("button")?n.target:n.target.getParent(".button"),i,r,u,f;t&&(this.subMenuOpen=!0,i=t.getParent(".button-container")?document.id(t.getParent(".button-container").get("data-menu-id")):!1,r=t.getPosition(t.getParent(".section")),u=t.getParent(".section").getSize(),f=t.getSize(),document.querySelectorAll(".button-menu-container").forEach(function(n){n!==i&&n.dissolve()}.bind(this)),i.setStyles({top:r.y-5,right:u.x-r.x-f.x-2}),i.reveal(),document.getElement(".button-menu-closer").removeClass("hidden"))}.bind(this),t)},hideButtons:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay);var t=250;n.hasOwnProperty("delay")&&(t=n.delay),this.subMenuOpenDelay=setTimeout(function(){this.subMenuOpen=!1,document.getElements(".button-menu-container").dissolve(),document.getElement(".button-menu-closer").addClass("hidden")}.bind(this),t)},simplifyButton:function(n){n.getElement(".button")&&(n=n.getElement(".button")),n.removeClass("w-icon").addClass("w-icon-only").getElements("span").addClass("hidden"),n.getElement("span").removeClass("hidden")},returnButtonfromLang:function(n,t){var i=n.querySelector("span"),f=t.icon,e=f!==!1?Affinity.icons[f]:"",o=t.label,u,r;return i.querySelectorAll("span").length===1?(r=document.createElement("span"),u=i.querySelector("span"),r.innerHTML=e,u.innerHTML=o,i.insertBefore(r,u),i.classList.add("w-icon")):i.querySelectorAll("span").length===2&&(r=i.querySelectorAll("span")[0],u=i.querySelectorAll("span")[1],r.innerHTML=e,u.innerHTML=o,i.classList.add("w-icon")),r&&f===!1&&(r.destroy(),i.classList.remove("w-icon")),n},returnButtons:function(n,t,i,r,u,f,e,o){var h,s,v,l=!1,d=e||!1,y,a,et;if(n.Name.contains("Button")){y=String.uniqueID(),document.getElement(".button-menu-closer")||new Element("div",{"class":"button-menu-closer hidden"}).addEvent(Affinity.events.click,this.hideButtons).inject(document.getElement("body"),"bottom");var p=new Element("div"),w=new Element("span",{"class":"button-divider blue hidden",html:"<hr />"}),g=new Element("span",{"class":"button-divider decline hidden",html:"<hr />"}),nt=new Element("span",{"class":"button-wrapper recalc"}),b=new Element("span",{"class":"button-wrapper awards"}),k=new Element("span",{"class":"button-wrapper duplicate"}),tt=new Element("span",{"class":"button-wrapper favourite"}),it=new Element("span",{"class":"button-wrapper decline"}),rt=new Element("span",{"class":"button-wrapper save"}),ut=new Element("span",{"class":"button-wrapper delete"}),ft=new Element("div",{"class":"button-menu-close",html:this.icons.dotsVert}),c=new Element("div",{"class":"button-menu-container row-ref-"+i,id:"bm"+y}).adopt(ft,new Element("div",{"class":"button-menu-title",html:"Options"}),new Element("div",{"class":"button-wrappers"}).adopt(nt,b,k,tt,p,w,it,g,rt,ut)).inject(document.getElement("body"),"bottom").addEvent(Affinity.events.outAll,this.subMenuOut).addEvent(Affinity.events.overAll,this.subMenuOver).set("reveal",{duration:250,transition:Fx.Transitions.Sine.easeInOut});r!=="pending"&&k.addClass("active"),this.isManager&&b.addClass("active"),a=new Element("span",{"class":"button button-menu-button","data-row-ref":i,html:"<span>"+this.icons.dotsVert+"<\/span><span><\/span>"}),Affinity.mobile?a.addEvent(Affinity.events.click,this.buttonClicked):a.addEvent(Affinity.events.outAll,this.hideButtons).addEvent(Affinity.events.overAll,this.showButtons),l=new Element("div",{"class":"button-container","data-menu-id":"bm"+y}).adopt(new Element("span",{"class":"button-wrapper submit"}),new Element("span",{"class":"button-wrapper approve"}),new Element("span",{"class":"button-wrapper decline"}),a),et=!1,Array.each(n.Children,function(n){s=this.zelosProcessor.processChild(n),s&&(n.Name.test("ReCalc","gi")?Affinity.mobile?c.getElement(".button-wrapper.recalc").destroy():(s.addClass("active").inject(c.getElement(".button-wrapper.recalc"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.recalc").destroy(),s=this.returnButtonfromLang(s,Affinity.languages.english.application.timesheets.buttons.recalc),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)):n.Name.test("awards","gi")?!Affinity.mobile&&Affinity.isAwardsPopupEnabled()?(s.addClass("active").inject(c.getElement(".button-wrapper.awards"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.awards").destroy(),s=this.returnButtonfromLang(s,Affinity.languages.english.application.timesheets.buttons.awards),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)):c.getElement(".button-wrapper.awards").destroy():Affinity.enableFavourites&&n.Name.test("favourite","gi")?Affinity.mobile?c.getElement(".button-wrapper.favourite").destroy():(s.addClass("active").inject(c.getElement(".button-wrapper.favourite"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.favourite").destroy(),s=this.returnButtonfromLang(s,{label:o?this.baseAppLang.favourites.renameButtonLabel:this.baseAppLang.favourites.saveButtonLabel,icon:"Pin"}),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)):n.Name.test("save","gi")?s.addClass("active").inject&&c.getElement(".button-wrapper.save")!==null&&(s.addClass("active").inject(c.getElement(".button-wrapper.save"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.save").destroy(),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked),w.classList.remove("hidden")):n.Name.test("approve","gi")?(s.addClass("active").inject(l.getElement(".button-wrapper.approve"),"after"),s.getElement(".button").set("data-row-ref",i),l.getElement(".button-wrapper.approve").destroy(),s.getElement(".button").addEvent(Affinity.events.click,this.buttonClicked),this.simplifyButton(s)):n.Name.test("decline","gi")?(s.addClass("active").inject(l.getElement(".button-wrapper.decline"),"after"),s.getElement(".button").set("data-row-ref",i),l.getElement(".button-wrapper.decline").destroy(),s.getElement(".button").addEvent(Affinity.events.click,this.buttonClicked),this.simplifyButton(s)):n.Name.test("delete","gi")?(s.addClass("active").inject(c.getElement(".button-wrapper.delete"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.delete")&&c.getElement(".button-wrapper.delete").destroy(),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked),w.classList.remove("hidden")):n.Name.test("submit","gi")?(s.addClass("active").inject(l.getElement(".button-wrapper.submit"),"after"),s.getElement(".button").set("data-row-ref",i),l.getElement(".button-wrapper.submit").destroy(),s.getElement(".button").addEvent(Affinity.events.click,this.buttonClicked),this.simplifyButton(s)):(s.inject(a,"before"),s.getElement(".button").set("data-row-ref",i),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)),s&&s.querySelector(".button")&&s.querySelector(".button").classList.add("button-"+n.Value.ButtonType.replace(new RegExp(/\s/g),"").toLowerCase()),h&&h.querySelector(".button")&&h.querySelector(".button").classList.add("button-"+n.Value.ButtonType.replace(new RegExp(/\s/g),"").toLowerCase()))}.bind(this)),this.enableFormEdit&&(new Element("span",{"class":"button-divider edits",html:"<hr />"}).inject(c.getElement(".button-wrappers")),v=new Element("span",{"class":"button-wrapper"}).inject(c.getElement(".button-wrappers")),s=new Element("span",{"class":"button blue w-icon","data-row-ref":i,"data-type":"FormEdit"}).adopt(new Element("span",{html:Affinity.icons.Pencil}),new Element("span",{html:"Edit"})).inject(v),s.store("cfbutton",s),s.addEvent(Affinity.events.click,this.buttonClicked)),c.getElement(".button-wrapper.duplicate")&&(typeOf(t)==="null"||t||d?c.getElement(".button-wrapper.duplicate").destroy():s=new Element("span",{"class":"button blue w-icon ui-has-tooltip","data-type":"Duplicate","data-row-ref":i,html:"<span>"+this.icons.duplicate+"<\/span><span>Duplicate<\/span><\/span>"}).inject(c.getElement(".button-wrapper.duplicate")).addEvent(Affinity.events.click,this.buttonClicked)),f&&f.length>0&&(new Element("span",{"class":"button-divider obscured",html:"<hr />"}).inject(p),Array.each(f,function(n){v=new Element("span",{"class":"button-wrapper obscured"}).inject(p),s=new Element("span",{"class":"button "+(n[1].toLowerCase().contains("higher dut")?"yellow":"blue")+" w-icon","data-type":"Obscured","data-row-ref":i,"data-col-ref":n[0],"data-display":n[1]}).adopt(new Element("span",{html:Affinity.icons.FieldEdit}),new Element("span",{html:"Set "+n[1]})).inject(v),s.store("cfbutton",s).addEvent(Affinity.events.click,this.buttonClicked)}.bind(this))),c.inject(this.table,"before").set("reveal",{duration:250,mode:"vertical"}).toggle()}return l},retrunRowStatus:function(n){var i=this.getValue(n).toLowerCase(),t={status:"none",icon:"",color:"none",klass:"",message:"",isNewRow:!1};switch(i){case"pending":t.status=i,t.icon=Affinity.icons.Save,t.message=this.globalLang.timesheetSavedNotSubmitted,t.color="orange",t.klass="color "+t.color;break;case"submitted":t.status=i,t.color="blue",t.klass="color "+t.color;break;case"declined":t.status=i,t.icon=Affinity.icons.ThumbsDown,t.color="red",t.message=this.globalLang.timesheetDeclined,t.klass="color "+t.color;break;case"approved":t.status=i,t.icon=Affinity.icons.ThumbsUp,t.color="green",t.message=this.globalLang.timesheetApproved,t.klass="color "+t.color;break;case"paid":t.status=i,t.icon=Affinity.icons.Moneybag,t.color="green",t.message=this.globalLang.timesheetPaid,t.klass="color "+t.color;break;case"immutable":t.status=i,t.icon=Affinity.icons.Lock,t.color="grey",t.message="",t.klass="color "+t.color;break;case"new":t.status=i,t.icon=Affinity.icons.StarFull,t.color="orange",t.message="New Timesheet",t.klass="color "+t.color+" hi",t.isNewRow=!0}return t},setTableClass:function(){if(typeOf(this.options.widgetDocument)==="object"&&"Attribute"in this.options.widgetDocument){var t=this.options.widgetDocument.Attribute.IsReadOnly||!1,n;n=t?"ui-grid ui-grid-sortable timesheet":"ui-grid timesheet",n=this.options.timesheetType==="employeeDetails"?n+" detailed":n,this.table.set("class",n),this.hasRows||this.table.addClass("hidden")}},buildTableHeader:function(){var n,i,t;if(this.setTableClass(),this.options.widgetDocument&&this.options.widgetDocument.Children&&this.options.widgetDocument.Children.length!==0){for(i=!1,n=0;n<this.options.widgetDocument.Children.length;n++)if(this.options.widgetDocument.Children[n].Data&&typeOf(this.options.widgetDocument.Children[n].Data.RowType)==="null"){i=this.options.widgetDocument.Children[n];break}i&&(t=this.buildTableRow(i,!0),t&&(t.getElement("th.active").addClass("first"),this.table.getElement("thead").empty().adopt(t),this.thead=t,this.thead.getElement("input.selectall")&&(this.bulkSelect=this.thead.getElement("input.selectall"),this.bulkSelect.addEvent(Affinity.events.click,this.selectAllRows))))}},buildTableFooter:function(){var t,e,i,r,f,n,u,s;if(this.options.widgetDocument&&this.options.widgetDocument.Children&&this.options.widgetDocument.Children.length!==0){for(e=!1,t=0;t<this.options.widgetDocument.Children.length;t++)if(this.options.widgetDocument.Children[t].Data&&typeOf(this.options.widgetDocument.Children[t].Data.RowType)==="null"){e=this.options.widgetDocument.Children[t];break}if(e)if(i=Number(this.options.widgetDocument.Layout.UnitTotal).round(2),r=this.thead.getElement(".col-id-TsNet")||this.thead.getElement(".col-id-CalculatedTotal")||this.thead.getElement(".col-id-Unit")||this.thead.getElement(".col-id-Units")||!1,Affinity.mobile){this.tfoot.empty();var n=this.thead.getElements("th.active"),f=n.indexOf(r),o=n.length;r?(this.tfoot.adopt(new Element("th",{colspan:o,"class":"active"})),this.tfoot.adopt(new Element("th",{"class":"active value unit-total"})),f+1<o&&this.tfoot.adopt(new Element("th",{colspan:1,"class":"active"}))):this.tfoot.adopt(new Element("th",{colspan:o,"class":"active"})),this.secondaryAddButton||this.returnSecondaryAddButton(),this.secondaryButtonWrapper.inject(this.tfoot.getElement("th.active"))}else r?(this.tfoot.empty(),n=this.thead.getElements("th"),f=n.indexOf(r),Array.each(n,function(n,t){t==f?this.tfoot.adopt(new Element("th",{"class":"active value unit-total"})):this.tfoot.adopt(new Element("th",{"class":n.hasClass("hidden")?"hidden":n.hasClass("active")?"active":""}))}.bind(this)),this.tfoot.getElement("th.active").addClass("first")):(this.tfoot.empty(),n=this.thead.getElements("th"),Array.each(n,function(n){this.tfoot.adopt(new Element("th",{"class":n.hasClass("hidden")?"hidden":n.hasClass("active")?"active":""}))}.bind(this)),this.tfoot.getElement("th.active")&&this.tfoot.getElement("th.active").addClass("first")),this.tfoot.getElement(".unit-total")&&i&&i>0&&(u=this.tfoot.getElement(".unit-total"),s=u.getPrevious("th.active"),u.set("html","Total&nbsp;<strong>"+i+"<\/strong>"),Affinity.mobile?u.set("html","<strong>"+i+"<\/strong>"):(s.set("html","(from&nbsp;"+this.options.widgetDocument.Layout.PageTotal+"&nbsp;pages)"),s.setStyle("text-align","right"),u.set("html","Total&nbsp;<strong>"+i+"<\/strong>"))),function(){var i=[],t=this.tfoot.getElements("th"),u=0,r=0,n;for(this.tfoot.getElement("th.unit-total")&&(r=t.indexOf(this.tfoot.getElement("th.unit-total"))+1),n=t.length-1;n>-1;n--)if(i.push(t[n]),t[n].hasClass("active")&&u++,n===r)break;Array.each(i,function(n){n.destroy()}),new Element("th",{colspan:i.length,"class":"active"}).inject(this.tfoot)}.bind(this)(),this.tfoot.getElements("th.active").length>0&&(this.secondaryAddButton||this.returnSecondaryAddButton(),this.secondaryButtonWrapper.inject(this.tfoot.getElements("th.active").getLast()))}},columnsCheck:[],checkColumnMisssAligned:function(){var i=!1,n,t;return this.columnsCheck.length>0&&(n=this.columnsCheck[0].join(",").trim().replace(/Selected/gi,"").replace(/\,\,/g,","),Array.each(this.columnsCheck,function(r){t=r.join(",").trim().replace(/Selected/gi,"").replace(/\,\,/g,","),/.*[ActEndTime].*[ActStartTime].*[ShiftType].*/gi.test(t)&&/.*[ActEndTime].*[ActStartTime].*[ShiftType].*/gi.test(n)&&(t=t.replace(/ShiftType/gi,"").replace(/\,\,/g,","),n=n.replace(/ShiftType/gi,"").replace(/\,\,/g,",")),n!==t&&(i=!0)}.bind(this))),i},buildTableRow:function(n,t){var o;if(n){var h=[],c=n.hasOwnProperty("data")&&typeof n.Data=="object"&&n.Data.hasOwnProperty("RowType")?n.Data.RowType:"Timesheet",b=0,l=-1;if(this.options.widgetDocument&&this.options.widgetDocument.Children&&typeOf(this.options.widgetDocument.Children)=="array"&&this.options.widgetDocument.Children.contains(n)&&(l=this.options.widgetDocument.Children.indexOf(n)),c==="Award")return!1;if(c==="Timesheet"){var e,u,r,a,v,i,s=!1,f=new Element("tr",{"class":"timesheet-row","data-doc-index":l}),y=new Element("tr"),p=[],w=!1;if("Children"in n&&typeOf(n.Children)==="array"){if(n.Children.sort(function(n,t){return parseInt(n.Layout.Rank,10)-parseInt(t.Layout.Rank,10)}),Array.each(n.Children,function(n){if(e=this.getAttributes(n),u=n.Source?n.Source.PropertyName:n.Name.substring(n.Name.lastIndexOf("-")+1),p.push(u.trim()),u.test("TsStatus","gi")&&(s=this.retrunRowStatus(n)),r="active ",e.hidden&&(r="hidden "),n.Source.PropertyName==="Comment"&&n.ValueAsString!==undefined&&n.ValueAsString.indexOf("Leave App")>-1&&(w=!0),a=this.tbody.getElements(".col-id-"+u+".hidden").length>0,v=this.tbody.getElements(".col-id-"+u+".active").length>0,!e.hidden&&a&&(this.table.getElements(".col-id-"+u).removeClass("hidden").addClass("active"),r="active "),e.hidden&&v&&(r="active "),n.Layout.hasOwnProperty("IsObscured")&&n.Layout.IsObscured&&(this.table.getElements(".col-id-"+u).removeClass("active").addClass("hidden"),r="hidden ",h.push([".col-id-"+u,n.Description.ShortText.replace(/timesheet/gi,"").trim()])),u.test("TimesheetId","gi")&&(f.addClass(n.ValueAsString),f.set("data-timesheet-id",n.ValueAsString)),r=u.test("Comment","gi")?r+"comment ":r,r=u.test("TsNet","gi")?r+"w100 ":r,r=u.test("Unit","gi")?r+"w100 ":r,r=u.test("CalculatedTotal","gi")?r+"w100 ":r,r=u.test("RowButton","gi")?r+"buttons ":r,r=u.test("Selected","gi")?r+" check w25 ":r,n.InputType)switch(n.InputType){case"Time":case"HoursMins":r=r.replace(/w100 /,"")+"w100 ";break;case"Date":case"DateTime":r=r.replace(/w100 /,"")+"w150 "}Affinity.mobile&&r.test("RowButton","gi")&&(r="hidden "+r.replace("active","")),new Element("td",{"class":r+"col-id-"+u,"data-col-id":u}).inject(f),b++,t&&(i="",n.Layout&&n.Layout.HideTitle!==!0&&typeOf(n.Description)!=="null"&&typeOf(n.Description.ShortText)!=="null"&&(i=n.Description.ShortText.replace(/timesheet/gi,"").trim(),i=="Position Code"?i='<span>Position<\/span><span class="hide-on-mobile"> Code<\/span>':i=="Pay Code"?i='Pay<span class="hide-on-mobile"> Code<\/span>':i.test(new RegExp(" Element","gi"))?i=i.replace(" Element",'<span class="hide-on-mobile"> Element<\/span>'):i=="Submitted To"?i='<span class="hide-on-mobile">Submitted <\/span><span>To<\/span>':i=="Hours Worked"?i='<span class="hide-on-mobile">Hours<\/span><span class="hide-on-desktop">Hrs<\/span><span class="hide-on-mobile"> Worked<\/span>':i=="Hours"?i='<span class="hide-on-mobile">Hours<\/span><span class="hide-on-desktop">Hrs<\/span>':i.test(new RegExp("hours","gi"))?Affinity.mobile&&(i="Hrs"):i.test(new RegExp("cost","gi"))?Affinity.mobile&&(i="Cost"):i.test(new RegExp("resource","gi"))?Affinity.mobile&&(i=i.replace(new RegExp("resource","gi"),"Res")):i.test(new RegExp("approver","gi"))?Affinity.mobile&&(i=i.replace(new RegExp("approver","gi"),"Appr")):i.test(new RegExp("employee","gi"))?Affinity.mobile&&(i="Emp"):i=="Bulk Process"?i='<input type="checkbox" class="selectall ui-has-tooltip" data-tooltip="Select / Deselect All" data-tooltip-dir="top,left" />':e.required&&!e.readonly?i+='&nbsp;<span class="required">*<\/span>':i=i.replace(/ /g,"&nbsp;")),new Element("th",{"class":r+"col-id-"+u,"data-col-id":u,html:i}).inject(y))}.bind(this)),this.columnsCheck.push(p),Affinity.mobile&&Array.each(n.Children,function(n){n.Source.PropertyName==="EmployeeNo"&&n.Description!=undefined&&n.Description.InfoIcon!=undefined&&n.Description.InfoIcon==="LockApproved"&&s.status.toLowerCase()==="immutable"&&(s.color="green")}.bind(this)),f.getElement("td.active").addClass("indicate").addClass("first"),f.store("status",s),Affinity.mobile&&s.status!=="immutable"&&w===!1&&f.getElement("td.indicate")){o=new Hammer(f,{domEvents:!0}),o.get("swipe").set({direction:Hammer.DIRECTION_HORIZONTAL}),o.add(new Hammer.Press({event:"longpress",time:501}));o.on("panleft panright",this.mobileSelect);o.on("longpress",this.mobileSelect);o.on("tap",this.popupEditForm)}return t?y:(f.store("obscured",h),f)}return f.destroy(),n.hasOwnProperty("Attribute")&&typeof n.Attribute=="object"&&n.Attribute.hasOwnProperty("Message")&&typeof n.Attribute.Message=="string"&&n.Attribute.Message.trim()!==""&&this.messageBucket.push(n.Attribute.Message.trim()),!1}}},returnNewRow:function(n,t,i){var r=this.buildTableRow(n),ut,it,l,d,f,w,b,h,c,a,s;if(r){ut=i||this.options.timesheetType,it=this.tbody.getElements(".timesheet-row").length,this.docMessages=[],l=this.getMessages(n,"Row "+it+": "),l.length>0&&Array.each(l,function(n){this.docMessages.push(n)}.bind(this)),r.set("id",n.Name);var v=this.getAttributes(n),e=r.retrieve("status"),i="timesheet",ft=!1,et=!1,k=!1;if((n.hasOwnProperty("Data")&&n.Data.hasOwnProperty("IsFavourite")&&n.Data.hasOwnProperty("FavouriteName")&&n.Data.IsFavourite===!0&&n.Data.FavouriteName.trim()!==""&&(et=!0,k=n.Data.FavouriteName.trim()),d=!1,v.readonly?Array.each(n.Children,function(n){n.Name&&n.Name.test(new RegExp("TsDate","gi"))&&(r.dataset.date=n.ValueAsString),n.Name&&n.Name.test(new RegExp("TimesheetId","gi"))&&(r.dataset.timesheetId=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeNo","gi"))&&(r.dataset.employeeNo=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeName","gi"))&&(r.dataset.employeeName=n.ValueAsString)}.bind(this)):Array.each(n.Children,function(n){n.Name&&n.Name.test(new RegExp("Comment","gi"))&&n.ValueAsString&&n.ValueAsString.test(new RegExp("Leave App","gi"))&&(d=!0),n.Name&&n.Name.test(new RegExp("TimesheetType","gi"))&&(i=this.getTimesheetType((n.Value+"").trim()),ft=i==="allowance"?!0:!1),n.Name&&n.Name.test(new RegExp("TsDate","gi"))&&(r.dataset.date=n.ValueAsString),n.Name&&n.Name.test(new RegExp("TimesheetId","gi"))&&(r.dataset.timesheetId=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeNo","gi"))&&(r.dataset.employeeNo=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeName","gi"))&&(r.dataset.employeeName=n.ValueAsString)}.bind(this)),d&&(v.readonly=!0),v.hidden)||(typeOf(t)==="null"||!t)&&e.isNewRow)return r.destroy(),!1;t&&!e.isNewRow&&(e.isNewRow=!0);var ot=n.AwardRows&&n.AwardRows.AwardRowIds&&typeOf(n.AwardRows.AwardRowIds)==="array"&&n.AwardRows.AwardRowIds.length>0?!0:!1,rt=!1,g=[],o=!1,st=!1,u,y,p,nt,tt=[];if(Array.each(n.Children,function(t){var s={name:t.Description.ShortText,value:t.Value},i,f,o;if(tt.push(s),t.hasOwnProperty("Children")&&Array.isArray(t.Children)&&t.hasOwnProperty("Name")&&typeof t.Name=="string"&&t.Name.trim()!==""&&t.Name.test(new RegExp("RowButton","gi"))&&t.Children.forEach(function(n){n.hasOwnProperty("Value")&&typeof n.Value=="object"&&n.Value.hasOwnProperty("ButtonType")&&typeof n.Value.ButtonType=="string"&&n.Value.ButtonType.trim()!==""&&n.Value.ButtonType.test(new RegExp("Awards","gi"))&&(rt=!0)}.bind(this)),u=!1,y=this.getAttributes(t),d&&(y.readonly=!0,t.Name.test(new RegExp("Bulk","gi"))&&(y.hidden=!0)),t.Description.hasOwnProperty("InfoText")&&typeof t.Description.InfoText=="string"&&(this.setupCorrectInfoColorForForwardedRowInMobileMode(t,e),g.push(t.Description)),p=t.Source?t.Source.PropertyName:t.Name.substring(t.Name.lastIndexOf("-")+1),p.test("AuthoriserId","gi")&&(st=t.Value),!y.hidden)if(v.readonly||y.readonly){if(u=r.getElement(".col-id-"+p),u.set("html",this.getValue(t)),t.InputType)switch(t.InputType){case"Date":i=(new Date).parse(t.ValueAsString),Affinity.mobile?(u.addClass("mobile-date"),u.set("html",i.isValid()?i.format("%e&nbsp;%b<span>%Y<\/span>"):t.ValueAsString)):u.set("html",i.isValid()?i.format("%e/%m/%y"):t.ValueAsString);break;case"Time":i=(new Date).parse(t.ValueAsString),Affinity.mobile?(u.addClass("mobile-time"),u.set("html",i.isValid()?i.format("%l:%M<span>%p<\/span>").replace(/ /g,""):t.ValueAsString)):u.set("html",i.isValid()?i.format("%l:%M%p").replace(/ /g,""):t.ValueAsString)}t.InputType=="Lookup"&&typeOf(t.Value)!=="null"&&(u.addClass("has-display-lookup").addClass("display"),u.set("data-lookup-api",Affinity.lookupapi+"?ModelName="+t.Source.ModelName+"&PropertyName="+t.Source.PropertyName+"&key="+t.Value)),t.Description.HelpText&&(u.addClass("ui-has-tooltip"),u.set("data-tooltip",t.Description.HelpText),u.set("data-tooltip-dir","top")),nt=this.zelosProcessor.getLookupDependancies(t),nt&&(u.set("id",t.Name),v.readonly?(f=!1,o=[],"Source"in t&&typeOf(t.Value)==="array"&&(Array.each(n.Children,function(n){Array.each(nt,function(t){n.Name.contains(t.updateFromPropertyName)&&o.push({LinkType:"Dependency",ModelName:"Timesheet",PropertyName:t.updateFromPropertyName,ValueAsString:n.ValueAsString})})}),f=Affinity.lookupapi.replace("/Get","/GetConditional")+"&ModelName="+t.Source.ModelName+"&PropertyName="+t.Source.PropertyName+'&parameters={"Parameter":'+JSON.stringify(o)+"}"),f&&(u.set("data-lookup-api",f),u.removeClass("has-dependencies"),u.addClass("has-display-lookup"))):this.zelosProcessor.setLookupDependancies(t,nt,u))}else{if(l=this.getMessages(t,"Row "+it+' "'+t.Description.ShortText+'": '),l.length>0&&Array.each(l,function(n){this.docMessages.push(n)}.bind(this)),t.ElementType=="SectionHeading"&&t.Name.test("button","gi"))u=this.returnButtons(t,e.isNewRow,n.Name,e.status,ot,r.retrieve("obscured"),ft,k),r.eliminate("obscured");else try{t.Name.contains("TimesheetTable-")||t.Name.contains("Timesheet-Row")||(t.Name+="-"+String.uniqueID()),u=this.zelosProcessor.processChild(t)}catch(h){u=!1}u&&u.inject(r.getElement(".col-id-"+p)),t.Name.toLowerCase().contains("tsnet")&&u.getElement("input")&&u.getElement("input").addEvent("blur",function(n){var t=[],i;val=n.target.value,val.contains(".")||(i=val.split(/\D/),i.length>0&&Array.each(i,function(n){typeOf(parseInt(n,10))!=="null"&&t.push(n)})),t.length>1&&(n.target.value=Number.format(parseInt(t[0],10)+parseInt(t[1],10)/60,{decimals:2}))})}}.bind(this)),k&&g.push({InfoText:"From "+this.baseLang.favourites.name+" '"+k+"'",InfoIcon:"Pin",InfoColor:"yellow"}),f=!1,r.getElement("td.indicate").addClass(e.color),["new","pending","paid","approved","declined"].contains(e.status)){if(e.status==="paid"&&tt!==undefined&&tt!==null&&(w=tt.FindIn(name,"Date Paid"),w!==null&&w.value!==undefined&&w.value!==null)){for(b=w.value.replace("00:00:00","");b.indexOf(".")>-1;)b=b.replace(".","/");e.message="Timesheet has been paid on "+b}f=new Element("div",{html:e.icon,"class":"message-icon master "+e.color+" print-hidden ui-has-tooltip","data-tooltip":e.message}),f.inject(r.getElement("td.indicate"),"top")}return n.Attribute&&n.Attribute.IsMessage&&n.Attribute.Message&&n.Attribute.Message!==""&&(f=new Element("div",{html:Affinity.icons.Warning,"class":"message-icon master yellow print-hidden ui-has-tooltip","data-tooltip":n.Attribute.Message}),f.inject(r.getElement("td.indicate"),"top"),r.getElement("td.indicate").removeClass(e.color).removeClass("red").addClass("yellow")),n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&n.Attribute.ErrorMessage!==""&&(f=new Element("div",{html:Affinity.icons.Warning,"class":"message-icon master red print-hidden ui-has-tooltip","data-tooltip":n.Attribute.ErrorMessage}),f.inject(r.getElement("td.indicate"),"top"),r.getElement("td.indicate").removeClass(e.color).removeClass("yellow").addClass("red")),e.status==="immutable"&&(f=new Element("div",{html:Affinity.icons.Lock,"class":"message-icon master grey print-hidden ui-has-tooltip","data-tooltip":"Can not be edited"}),f.inject(r.getElement("td.indicate"),"top")),n.Description.InfoText&&(h=n.Description.InfoText&&typeOf(n.Description.InfoText)==="string"&&n.Description.InfoText.trim()!==""?!0:!1,c=h?n.Description.InfoText:!1,a=Affinity.icons.getIcon(n.Description.InfoIcon,"PromptInfo"),infocolor=n.Description.InfoColor||"blue",s=new Element("div",{html:a,"class":"message-icon info "+infocolor+" print-hidden"}),s.inject(r.getElement("td.indicate"),"bottom"),h&&(s.addClass("ui-has-tooltip"),s.set("data-tooltip",c))),g.length>0&&(o=document.createElement("div"),o.classList.add("message-icons"),Affinity.mobile||r.querySelector("td.indicate").classList.add("has-message-icons"),r.querySelector("td.indicate").appendChild(o),Array.each(g,function(n){h=n.InfoText&&typeOf(n.InfoText)==="string"&&n.InfoText.trim()!==""?!0:!1,c=h?n.InfoText:!1,a=Affinity.icons.getIcon(n.InfoIcon,"PromptInfo"),infocolor=n.InfoColor||"blue",new RegExp("lock","gi").test(n.InfoIcon)?f?(f.set("class","message-icon master "+infocolor+" print-hidden"),f.set("html",a),h&&(f.addClass("ui-has-tooltip"),f.set("data-tooltip",c)),Affinity.mobile&&(infocolor==="blue-darker"||infocolor==="green"||infocolor==="red")&&r.getElement("td.indicate").removeClass("blue").addClass(infocolor)):(f=new Element("div",{html:a,"class":"message-icon master "+infocolor+" print-hidden"}),f.inject(o,"top"),h&&(f.addClass("ui-has-tooltip"),f.set("data-tooltip",c)),Affinity.mobile&&(infocolor==="blue-darker"||infocolor==="green"||infocolor==="red")&&r.getElement("td.indicate").removeClass("blue").addClass(infocolor)):n.hasOwnProperty("InfoText")&&(s=new Element("div",{html:a,"class":"message-icon info "+infocolor+" print-hidden"}),s.inject(o,"bottom"),n.InfoIcon.trim()==="CodeP"&&(c=this.sanatiseAwardsInfoText(c)),h&&(s.addClass("ui-has-tooltip"),s.set("data-tooltip",c)),["employeeDetails","manager"].contains(ut)&&(Affinity.mobile||n.InfoIcon.trim()!=="CodeP"||n.hasOwnProperty("InfoButtonType")||(n.InfoButtonType="Awards"),!Affinity.mobile&&n.hasOwnProperty("InfoButtonType")&&n.InfoButtonType.trim()!==""&&(s.classList.add("convert-to-button"),s.dataset.type=n.InfoButtonType,s.dataset.color=infocolor)),Affinity.mobile&&(infocolor==="blue-darker"||infocolor==="green"||infocolor==="red")&&r.getElement("td.indicate").removeClass("blue").addClass(infocolor))}.bind(this))),o&&o.querySelector(".convert-to-button")&&o.querySelectorAll(".convert-to-button").forEach(function(n){(Affinity.isAwardsPopupEnabled()&&n.dataset.type==="Awards"&&rt||n.dataset.type!=="Awards")&&(n.classList.remove("convert-to-button","blue",n.dataset.color),n.classList.add("as-button","color-white","bg-"+n.dataset.color,"as-button-type-"+n.dataset.type.toLowerCase()),n.removeAttribute("data-color"),n.addEventListener(Affinity.events.click,this.buttonClicked),o.appendChild(n))}.bind(this)),rt&&o&&Affinity.isAwardsPopupEnabled()&&o.querySelector(".as-button-type-awards")&&o.appendChild(o.querySelector(".as-button-type-awards")),e.isNewRow&&(r.addClass("new"),r.getElement(".check input")&&(r.getElement(".check input").checked=!0)),r&&r.addEventListener(Affinity.events.start,this.rowUserInteraction),r}return!1},sanatiseAwardsInfoText:function(n){var u=n,f=n.split(";"),t=[],i,e,o,s,r;return f.length>0&&(f.forEach(function(n){r='<tr><td colspan="3">'+n+"<\/td><\/tr>",e=0;try{i=n.split(" - ")[0].trim(),e=parseFloat(i),o=n.split(" - ")[1].split(",")[0].trim(),s=n.split(" - ")[1].split(",")[1].trim(),r="<tr><td>"+s+" <small>("+o+')<\/small><\/td><td>&nbsp;<\/td><td class="right">'+i+"<\/td><\/tr>"}catch(u){}t.push({sortby:0,str:r})}.bind(this)),t.sort(function(n,t){return n>t?-1:n<t?1:0}),u="<table>"+t.map(function(n){return n.str}).reverse().join("")+"<\/table>"),u},setupCorrectInfoColorForForwardedRowInMobileMode:function(n,t){Affinity.mobile&&(n.Description.InfoText.indexOf("assigned to")>-1&&t.status!=="approved"&&t.status!=="declined"?n.Description.InfoColor="blue-darker":n.Description.InfoText.indexOf("assigned to")>-1&&(t.status==="approved"||t.status==="declined")&&(n.Description.InfoColor=t.color))},updateRow:function(n,t,i,r){if(this.options.widgetDocument===undefined&&(this.options.widgetDocument=n),this.options.widgetDocument&&this.options.widgetDocument.hasOwnProperty("Children")&&typeOf(this.options.widgetDocument.Children==="array")&&t<this.options.widgetDocument.Children.length&&this.options.widgetDocument.Children[t]&&t<this.tableRows.length&&this.tableRows[t]){var f=this.returnNewRow(r,!0),u=this.tableRows[t],e=u.hasClass("new");f.inject(u,"after"),this.destroyRow(u),e||f.removeClass("new"),this.tbody&&this.tbody.getElements("tr.timesheet-row")&&this.tbody.getElements("tr.timesheet-row").length>0&&(this.tableRows=this.tbody.getElements("tr.timesheet-row")),t<this.options.widgetDocument.Children.length?this.options.widgetDocument.Children.splice(t,0,r):this.options.widgetDocument.Children.push(r)}},forceRowReadOnly:function(n,t){if(this.setMissingDefaultAsReadOnly){var f=n.getElements("td"),r,u,i;n.removeClass("modified"),Array.each(f,function(f){f.hasClass("active")?(f.getElement(".message-icon.master")&&(f.getElement(".message-icon.master").removeClass("orange").removeClass("red").removeClass("green").removeClass("blue").removeClass("light-blue").addClass("grey").set("html",Affinity.icons.Lock),typeOf(t)==="string"&&t.trim()!==""&&(Affinity.UI.Tooltips.Remove(f.getElement(".message-icon.master")),f.getElement(".message-icon.master").addClass("ui-has-tooltip").set("data-tooltip","Row is locked because "+t),Affinity.UI.Tooltips.Process())),n.getElement("td.indicate")&&n.getElement("td.indicate").removeClass("orange").removeClass("red").removeClass("green").removeClass("blue").removeClass("light-blue").addClass("grey").addClass("grey"),(f.hasClass("buttons")||f.hasClass("check"))&&(f.empty(),f.removeClass("buttons").removeClass("check")),f.getElement("input")&&(r=f.getElement("input").value,f.getElement(".subhidden")?(u=f.getElement(".subhidden").getChildren()[0],i=u.retrieve("widget"),i&&"destroy"in i&&i.destroy()):f.empty(),f.set("html",r))):f.empty()}.bind(this)),n.getParent("tbody").getElements("tr.modified").length===0&&this.delUnload()}},selectAllRows:function(n){document.querySelectorAll("tr.timesheet-row .active.check input").forEach(function(t){t.checked=n.target.checked?!0:!1})},cleanFavData:function(n,t){var i=t!==undefined?t:this.options.widgetDocument;return(Array.each(i.Children,function(n,t){var r={};Object.keys(n.Data).forEach(function(t){t!=="IsFavourite"&&t!=="FavouriteName"&&t!=="FavouriteType"&&(r[t]=n.Data[t])}),n.Data=r,i.Children[t].Data=r,Array.each(n.Children,function(n,r){n.Name.test(/RowButton/gi)&&Array.each(n.Children,function(n,u){n.Value.ButtonType==="Favourite"&&(n.Value.Pressed=!1,n.ValueAsString=JSON.stringify(n.Value),i.Children[t].Children[r].Children[u].Value=n.Value,i.Children[t].Children[r].Children[u].ValueAsString=n.ValueAsString)}.bind(this))}.bind(this))}.bind(this)),t!==undefined)?i:(this.options.widgetDocument=i,!0)},reduceBulkRows:function(){var n=parseInt(this.userData.employeeNumber),t=parseInt(this.currentSearchEmployee?this.currentSearchEmployee:n),r=Affinity.login.areas.Timesheet.IsEmployee,i=n!==t?!0:Affinity.login.areas.Timesheet.IsManager,u=this.cleanFavData();return Array.each(this.options.widgetDocument.Children,function(n,t){var o,r=!1,f=!1,e="",u=-1;Array.each(n.Children,function(n,t){n.Name.test(/TimesheetId/gi)&&(o=n.ValueAsString,r=this.options.target.getElement("tr.timesheet-row."+o)||!1,r&&(f=Affinity.doCheckRowChanges()?r.hasClass("modified")?!0:!1:r.getElement("td.check input")&&r.getElement("td.check input").checked?!0:!1)),n.Name.test(/TsStatus/gi)&&(e=n.ValueAsString.toLowerCase()),n.Name.test(/Bulk/gi)&&(u=t)}.bind(this)),r&&(i?e.test(new RegExp("decline|approve|paid","gi"))&&!f&&(r.getElement("td.check input")&&(r.getElement("td.check input").checked=!1),this.options.widgetDocument.Children[t].Children[u]&&(this.options.widgetDocument.Children[t].Children[u].Value=!1,this.options.widgetDocument.Children[t].Children[u].ValueAsString="False")):e.test(new RegExp("submit|decline|approve|paid","gi"))&&!f&&(r.getElement("td.check input")&&(r.getElement("td.check input").checked=!1),this.options.widgetDocument.Children[t].Children[u]&&(this.options.widgetDocument.Children[t].Children[u].Value=!1,this.options.widgetDocument.Children[t].Children[u].ValueAsString="False")))}.bind(this)),!0},hasRowChangedDelay:!1,changedFieldsMessage:"",getFirstCellvalue:function(n){var u=this.thead.getFirst("th.active").get("data-col-id"),t=n.getElement(".col-id-"+u),r=!1,i;return t.getElement(".widget")?(i=t.getElement(".widget").getWidget(),"getValue"in i&&(r=i.getValue())):t.getElement("input[type=hidden]")?r=t.getElement("input[type=hidden]").value:t.getChildren().length===0&&(r=t.get("html")),r},changeCount:0,hasChanges:function(){var n,i,e,r,u,o,s,h,c,f,t;if(this.isViewActive())return Affinity.timesheets.init.view&&(Affinity.timesheets.init.view==="detailed"||Affinity.timesheets.init.view==="dualdetailed"||Affinity.timesheets.init.view==="employee"||Affinity.timesheets.init.view==="employeeDetails"||Affinity.timesheets.init.view==="manager")?(n=[],n.append(this.tbody.getElements("tr.modified")),n.append(this.tbody.getElements("tr.new")),n.length>0?(f=this.tbody.getElements("tr.timesheet-row"),this.changedFieldsMessage="",t=[],Array.each(n,function(n){i=this.getFirstCellvalue(n),n.getElement(".message-icon.default-issue")&&n.getElement(".message-icon.default-issue").destroy(),n.getElement(".check input")&&(n.getElement(".check input").checked=!0),this.setMissingDefaultAsReadOnly?function(n,t,i,f){Array.each(t,function(r,u){r.test(new RegExp("Row "+(i.indexOf(n)+1)+(f?" ("+f+")":""),"gi"))&&t.splice(u,1)}.bind(this)),n.getElement(".cant-select-default")&&!n.hasClass("new")?(e=n.getElements(".cant-select-default"),r=e[0].getParent("tr"),u=[],Array.each(e,function(t){o=t.getParent("td"),s=r.getElements("td").indexOf(o),h=n.getParent("table").getElement("thead tr").getElements("th")[s].get("html").stripTags(),u.push(h+' can not select the saved value of "'+t.get("data-default-value")+'" as you are not configured to see this value.')}.bind(this)),c=new Element("span",{"class":"message-icon default-issue info red print-hidden ui-has-tooltip","data-tooltip":u.join("<br />"),html:Affinity.icons.Warning}),c.inject(r.getElement("td.active"),"bottom"),this.forceRowReadOnly(r,u.join("<br />")),t.push("Row "+(i.indexOf(n)+1)+(f?" ("+f+")":"")+" has changes - a default cant be selected")):t.push("Row "+(i.indexOf(n)+1)+(f?" ("+f+")":"")+" has changes")}.delay(1e3,this,[n,t,f,i]):t.push("Row "+(f.indexOf(n)+1)+(i?" ("+i+")":"")+" has changes")}.bind(this)),t.length>0&&(this.changedFieldsMessage="\n"+t.join("\n")),n=i=t=f=null,Affinity.UI.Tooltips.Process(),!0):(n=null,!1)):!1},getChangeMessage:function(){return this.changedFieldsMessage},rowUserInteraction:function(n){var t=n.target.get("tag").toLowerCase()=="tr"?n.target:n.target.getParent("tr");t&&!t.hasClass("user-interacted")&&(t.addClass("user-interacted"),t.removeEventListener(Affinity.events.start,this.rowUserInteraction))},hasRowChanged:function(n){if(!Affinity.doCheckRowChanges())return!1;var t=n&&"getParent"in n&&n.getParent("tr")||!1;t&&(clearTimeout(this.hasRowChangedDelay),this.hasRowChangedDelay=this.checkRowDiff.delay(250,this,[t]))},checkRowDiff:function(n){var i=n.retrieve("status"),f=!1,u,e,t,r;return this.options.target.getElements("tr").contains(n)?typeof i=="undefined"?!1:n&&!n.hasClass("user-interacted")?!1:(u=!0,Array.each(n.getElements("input,select,textarea"),function(n){u&&Affinity.UI.isElementInQueue(n)&&(Affinity.UI.hasElementRequestCompleted(n)||(u=!1))}.bind(this)),!u)?!1:(e=n.getElement("td.indicate"),t=n.getElement("td.indicate").getElement(".message-icon.master"),n.retrieve("initState")||n.store("initStatus",i),r=n.retrieve("initStatus"),n.getElement(".check input")&&(n.getElement(".check input").checked=!1),n.removeClass("modified"),e.classList.remove("blue","green","red","roange","yellow","modified","none"),t&&(t.classList.remove("blue","green","red","roange","yellow","hourglass"),Affinity.tooltips.removeTooltip(t)),e.classList.add(r.color),t&&(t.classList.add(r.color),t.innerHTML=r.icon,t.dataset.tooltip=r.message,t.classList.add(r.color,"ui-has-tooltip"),Affinity.tooltips.processTooltip(t)),Array.each(n.getElements("input,select,textarea"),function(n){var t=n.retrieve("changetracker");t&&t.hasChanged()&&!t.hasRestored()&&(f=!0)}.bind(this)),f?n.getElement("td.indicate")&&(n.addClass("modified"),n.getElement(".check input")&&(n.getElement(".check input").checked=!0),n.hasClass("new")||(n.getElement("td.indicate").removeClass("none").removeClass("blue").removeClass("green").removeClass("red").addClass("orange"),t?t.removeClass("blue").removeClass("green").removeClass("red").addClass("orange").addClass("hourglass").set("html",Affinity.icons.Hourglass):new Element("div",{html:Affinity.icons.Hourglass,"class":"message-icon master orange hourglass print-hidden"}).inject(n.getElement("td.indicate"),"top")),n.getElement("input[type=checkbox]")&&(n.getElement("input[type=checkbox]").checked=!0),n.addClass("modified")):n.getElement("td.indicate")&&(n.getElement("td.indicate").removeClass("none").removeClass("blue").removeClass("green").removeClass("orange"),n.getElement("td.indicate .message-icon.hourglass")&&(i.icon!==""?n.getElement("td.indicate .message-icon.hourglass").removeClass("hourglass").removeClass("orange").addClass(i.klass).set("html",i.icon):n.getElement("td.indicate .message-icon.hourglass").destroy()),n.getElement("td.indicate").addClass(i.color),!n.hasClass("new")&&n.getElement("input[type=checkbox]")&&(n.getElement("input[type=checkbox]").checked=!1),n.removeClass("modified")),this.hasChanges()?this.setUnload():this.delUnload(),f):!1},getWidgetDocument:function(){return this.options.widgetDocument},putWidgetDocument:function(n){return this.options.widgetDocument=n,n},updateWidgetDocument:function(){var n;return Array.each(this.options.widgetDocument.Children,function(t,i){n=this.tableRows[i],Array.each(t.Children,function(t,r){this.zelosProcessor.readField(this.options.widgetDocument,i,r,t,n)}.bind(this))}.bind(this)),delete n,this.options.widgetDocument},getWidgetDocumentRow:function(n){return this.options.widgetDocument.Children[n]?this.options.widgetDocument.Children[n]:!1},putWidgetDocumentRow:function(n,t,i){var u=this.returnNewRow(t),f,e,r,o;if(u){for(this.options.widgetDocument.Children[n]?(f=this.tbody.getElements("tr.timesheet-row")[n],this.options.widgetDocument.Children[n]=t,u.inject(f,"after"),f.destroy()):n<0?(this.options.widgetDocument.Children.unshift(t),u.inject(this.tbody,"top")):(this.options.widgetDocument.Children.push(t),u.inject(this.tbody,"bottom")),e="none",r=0;r<t.Children.length;r++)if(t.Children[r].Name.test("TimesheetId","gi")){e=t.Children[r].ValueAsString;break}if(o=this.tbody.getElement("."+e),o&&this.tbody.getElements("tr.timesheet-row")[n]!==o){this.refresh(null,i);return}this.processUI()}return u},delWidgetDocumentRow:function(n){if(this.options.widgetDocument.Children[n]){this.options.widgetDocument.Children.splice(n,1),this.debug&&(console.log("%cRemove Row Element","background: #ffd484; color: white"),console.time("Remove Row Element"));var t=this.tbody.getElements("tr.timesheet-row")[n];t.parentNode.removeChild(t),this.debug&&(console.timeEnd("Remove Row Element"),console.log("%c\tRow Element Removed","background: #ffd484; color: white;"))}this.processUI()},updateWidgetDocumentRow:function(n){var t=this.tbody.getElements("tr.timesheet-row")[n];return Array.each(this.options.widgetDocument.Children[n].Children,function(i,r){this.zelosProcessor.readField(this.options.widgetDocument,n,r,i,t)}.bind(this)),delete t,this.options.widgetDocument.Children[n]},returnDocument:function(){return this.updateWidgetDocument(),this.getWidgetDocument()},mobileFilter:["ProjectId","TsCost","ResourceCode","AuthoriserId","CostElement1","CostElement2","CostElement3","CostElement4"],getTimesheetType:function(n){switch(n){case"1":return"timesheet";case"2":return"allowance"}return"timesheet"},getAttributes:function(n){var t=n;if(Affinity.mobile&&Affinity.appname==="timesheets"&&Affinity.timesheets.init.view&&["detailed","dualdetailed","manager","employeeDetails"].contains(Affinity.timesheets.init.view)){if(t.Name.test(new RegExp("Comment","gi"))||t.Name.test(new RegExp("BulkProcess","gi"))||t.Name.test(new RegExp("Submit","gi"))||t.Name.test(new RegExp("RowButton","gi"))||t.Layout.Rank>2&&t.Source&&t.Source.PropertyName&&this.mobileFilter.contains(t.Source.PropertyName))return{readonly:!0,hidden:!0,required:!1};if(t.Attribute&&!t.Attribute.IsHidden)return{readonly:!0,hidden:!1,required:!1}}return{readonly:n.Attribute&&n.Attribute.IsReadOnly?n.Attribute.IsReadOnly:!1,hidden:n.Attribute&&n.Attribute.IsHidden?n.Attribute.IsHidden:!1,required:n.Attribute&&n.Attribute.IsRequired?n.Attribute.IsRequired:!1}},getValue:function(n){var i=n.Value==null||n.Value==undefined||n.Value=="undefined"?"":n.Value,t;if(n.Name=="Hours"&&(i=parseFloat(i).round(1)),typeOf(i)==="array")for(t=0;t<n.Value.length;t++)if(typeOf(n.Value[t])==="object"&&n.Value[t].selected){if(n.Value[t].display){i=n.Value[t].display;break}if(n.Value[t].value){i=n.Value[t].value;break}}return i},mobileSelect:function(n){Affinity.stopHammerEvent(n);var t=n.target.get("tag")==="tr"?n.target:n.target.getParent("tr"),r=this.tableRows.indexOf(t),e=this.options.widgetDocument.Children[r];if(t.getElement("td.check")){var u=t.getElement("td.active.indicate"),f=t.getElement("td.check"),i=t.hasClass("selected");switch(n.type){case"longpress":i?(u.removeClass("selected"),t.removeClass("selected"),i=!1):(u.addClass("selected"),t.addClass("selected"),i=!0);break;case"swipeleft":case"panleft":u.removeClass("selected"),t.removeClass("selected"),i=!1;break;case"swiperight":case"panright":u.addClass("selected"),t.addClass("selected"),i=!0}Array.each(this.options.widgetDocument.Children[r].Children,function(n,t){n.Source&&n.Source.PropertyName&&n.Source.PropertyName===f.get("data-col-id")&&(this.options.widgetDocument.Children[r].Children[t].Value=i,this.options.widgetDocument.Children[r].Children[t].ValueAsString=i.toString().capitalize())}.bind(this))}},formElement:!1,hidePopupEditFormDeleteButton:function(n){var i=null,t;Array.each(n.Children,function(n){n.Source.PropertyName==="TsStatus"&&(i=this.retrunRowStatus(n))}.bind(this)),this.options.timesheetType.toLowerCase==="employeedetails"&&i.toLowerCase!=="pending"&&(t=n.Children.length-1,Array.each(n.Children[t].Children,function(i,r){i.Value.ButtonType==="Delete"&&n.Children[t].Children.splice(r,1)}.bind(this)))},popupEditForm:function(n){var r=n.target.get("tag")==="tr"?n.target:n.target.getParent("tr"),u,t,i;r&&(u=this.tableRows.indexOf(r),t=this.options.widgetDocument.Children[u],this.hidePopupEditFormDeleteButton(t),t.Attribute.IsReadOnly||(i={target:!1,onSave:this.refresh,originDoc:t,originRow:r,originRowIndex:u,updateOnChange:this.updateRow,refreshBehind:this.refresh,duplicateTimesheet:this.duplicateTimesheet},t&&(this.formElement||(this.formElement=new Element("div",{"class":"timesheet-edit-form"})),this.formElement.empty(),i.target=this.formElement,t.hasOwnProperty("Children")&&typeOf(t.Children)==="array"&&t.Children.length>0&&Array.each(t.Children,function(n){n.Name.toLowerCase().contains("timesheetid")&&(i.timesheetId=n.Value),n.Name.toLowerCase().contains("employeeno")&&(i.employeeNumber=n.Value)}),(i.timesheetId===-1||i.timesheetId==="-1")&&(i.timesheetId=!1,delete i.timesheetId),new ZelosWidgetTimesheetEditForm(i))))},destroyRow:function(n){this.debug&&(console.log("%cDestroy Single Row","background: orange; color: white"),console.time("Destroy Single Row")),n.removeEventListener(Affinity.events.start,this.rowUserInteraction);var t,i=n.get("id"),r=this.tbody.getElements("tr.timesheet-row").indexOf(n);Array.each(n.getElements("input,textarea,select,.button"),function(n){if(n.hasClass("widget"))try{t=n.retrieve("widget"),"destroy"in t&&(t.destroy(),t=null)}catch(i){}n.removeEvents()}.bind(this)),n.removeEvents(),this.delWidgetDocumentRow(r),document.getElements(".row-ref-"+i).destroy(),this.debug&&(console.timeEnd("Destroy Single Row"),console.log("%c\tSingle Row Destroyed","background: orange; color: white")),this.checkNoRows(),this.setTableClass()},destroyRows:function(){return this.debug&&(console.log("%cDestroy Rows","background: orange; color: white; font-size: large"),console.time("Destroy Rows")),Array.each(this.tbody.getElements("tr.timesheet-row"),function(n){this.destroyRow(n)}.bind(this)),this.thead.empty(),this.tfoot&&this.tfoot.empty(),this.debug&&(console.timeEnd("Destroy Rows"),console.log("%c\tRows Destroyed","background: orange; color: white; font-size: large")),this.checkNoRows(),this.setTableClass(),!0},destroy:function(){this.options.parentForm.removeEvents(),window.removeEvent("keydown",this.checkKeyboardShortcut),this.destroyRows(),this.tbody.empty(),this.frowardWidget&&this.frowardWidget.destroy(),document.getElement(".button-menu-closer")&&(document.getElement(".button-menu-closer").removeEvent(Affinity.events.click,this.hideButtons),document.getElement(".button-menu-closer").destroy()),Affinity.views.detailed=null,delete Affinity.views.detailed}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetDualdetailed={Version:"1.0.26.0",Sequence:10260,Name:"Timesheet Dual Detailed (Zelos Widget)",File:"ui.zelos.widget.timesheets.dualdetailed.js",Jira:"",Notes:"Close award poups on date change"},ZelosWidgetTimesheetDualdetailed=new Class({debug:!1,Implements:[Options,Events],Binds:["isViewActive","popEmployeeSelect","setDetailsComplete","setAwardsComplete","setOverviewComplete","checkComplete","toggleAddRowsForm","dateChanged","getTimesheets","getAwards","doPeriodJump","switchHandler","switchUser","load","refresh","hasChanges","destroy"],options:{target:null,isManager:!1,isEmployee:!1,fromDate:!1,toDate:!1,startDate:!1,getApi:"",readOnly:!1,profile:!1},userProfile:!1,currentEmployee:!1,employeSelectTimer:!1,ribbonValueApi:!1,initted:!1,initialize:function(n){this.setOptions(n),Affinity.timesheets.init.disableTab("addTab"),Affinity.views.dualdetailed=this,Affinity.view="dualdetailed",this.container=new Element("div").inject(this.options.target),this.container.addClass("widget"),this.container.store("widget",this),this.isManager=this.options.isManager,this.isEmployee=this.options.isEmployee,this.today=new Date,this.fromDate=this.options.fromDate,this.toDate=this.options.toDate,this.startDate=this.options.startDate,this.userProfile=this.options.profile||!1,this.startEmployee=this.userProfile?this.userProfile.employeeNumber:!1,this.doRibbon=!0,Affinity.viewSettings.employeeNumber&&Affinity.viewSettings.startDate&&(this.fromSwitchData=!0,this.startDate=Affinity.viewSettings.startDate.clone(),this.lastRibbonStartDate=Affinity.viewSettings.startDate.clone(),this.startEmployee=Affinity.viewSettings.employeeNumber,this.switchViewSettings=Object.clone(Affinity.viewSettings.profile.get()),Affinity.viewSettings.reset()),this.ribbonSection=new Element("div",{"class":"section ts-ribbon-section"+(Affinity.appname!=="dashboard"?" shadow":"")}).inject(this.container),this.ribbonSectionBody=new Element("div",{"class":"section-body"}).inject(this.ribbonSection),this.ribbonBox=new Element("div").inject(this.ribbonSectionBody),this.payPeriodBox=new Element("div",{"class":"ts-pay-period"}).inject(this.ribbonBox,"before"),this.tsDetailBox=new Element("div",{"class":"ts-detailed-section",html:""}).inject(this.container),this.messageSection=new Element("div",{"class":"section ts-message-section"+(Affinity.appname!=="dashboard"?" shadow":"")}).inject(this.container),this.timesheetMessageBox=new Element("div",{"class":"section-body tsdd-messages",html:"There are currently no messages warnings or errors."}),this.awardDetailBox=new Element("div",{"class":"section-body tsdd-messages hidden",html:"There are currently no messages warnings or errors."}),new Element("div",{"class":"section-body"}).adopt(new Element("div",{"class":"section-title hidden",html:"Timesheet Messages"}),this.timesheetMessageBox,new Element("div",{"class":"section-title hidden",html:"Award Messages"}),this.awardDetailBox).inject(this.messageSection),this.costDetailBox=new Element("div",{"class":"is-this-the-right-thing",html:""}).inject(this.container);var i=new URI(this.options.getApi),t=typeOf(i.parsed.query)==="null"?{}:i.parsed.query.parseQueryString();t.api&&t.api.contains("?")&&(t.api=t.api.substring(0,t.api.indexOf("?"))),t.employeeNo=Affinity.login.profile.employeeNumber,i.parsed.query=Object.toQueryString(t),this.getApi=Affinity.GetCacheSafePath(i.toString()),this.doRibbon&&(this.ribbonLastDate=!1,this.ribbon=new ZelosWidgetTimesheetRibbon({target:this.ribbonBox,markPeriods:!1,onSelected:this.dateChanged})),this.overviewWiget=!1,this.timesheetWidget=!1,this.awardWidget=!1,this.searchEmployeeWidget=!1,this.isManager?(uiloader({message:"Getting manager data",type:"dualLoader"}),this.searchEmployee=new Element("select",{"data-default-value":this.startEmployee?this.startEmployee:Affinity.login.profile.employeeNumber}),this.isEmployee&&this.searchEmployee.adopt(new Element("option",{html:Affinity.login.profile.commonName+" ("+Affinity.login.profile.employeeNumber+")",value:Affinity.login.profile.employeeNumber})),new Request.JSONP({url:Affinity.zelosroot+"?api=timesheetAsManager/getEmployees",onComplete:this.popEmployeeSelect}).send(),this.dateElement=!1,this.doRibbon?new Element("form",{"class":"default-form",styles:{position:"relative",margin:"20px auto 0 auto",width:560}}).adopt(new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Select Employee"}),this.searchEmployee)).inject(this.ribbonBox,"after"):(this.dateElement=new Element("input",{type:"text",value:this.startDate.format("%a %e %b %Y")}),new Element("form",{"class":"default-form",styles:{position:"relative",margin:"20px auto 0 auto",width:560}}).adopt(new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Select Date"}),this.dateElement),new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Select Employee"}),this.searchEmployee)).inject(this.ribbonBox,"after"),this.dateWidget=new UIDateTimeWidget({outputFormat:"%d.%m.%Y",displayFormat:"%a %e %b %Y",showCalendar:!0,showTime:!1,startDate:this.startDate,labelName:"",postId:"",postName:"",validationMethods:"",validationErrorStr:"",target:this.dateElement,cssPosition:"absolute"}),this.dateWidget.addEvent("dateChanged",this.dateChanged))):Affinity.timesheets.init.hasOwnProperty("switchData")&&typeOf(Affinity.timesheets.init.switchData)==="object"?this.refresh():this.switchUser.delay(500,this,[Affinity.login.profile]),this.doOverview=!0,this.doAwards=!0,Affinity.isAwardsPopupEnabled()&&(this.doOverview=!1,this.doAwards=!1,this.costDetailBox.classList.add("hidden"),this.costDetailBox=!1,this.awardsComplete=!0,this.overviewComplete=!0),this.initted=!0},isViewActive:function(){return Affinity.timesheets.init.view==="dualdetail"?!0:!1},popEmployeeSelect:function(n){this.searchEmployeeWidget||(Array.each(n,function(n){n.Value.trim()!==""&&n.Key.toString()!==Affinity.login.profile.employeeNumber.toString()&&new Element("option",{value:n.Key,html:n.Value}).inject(this.searchEmployee)}.bind(this)),this.searchEmployeeWidget=new UIAutoCompleteWidget({selectElement:this.searchEmployee,keeplist:!0,elementChangedOnly:!0,onElementChanged:function(){this.userProfile&&"employeeNumber"in this.userProfile&&parseInt(this.userProfile.employeeNumber)!==parseInt(this.searchEmployee.value)&&(this.searchEmployeeWidget.obscure(),uialert({message:"Getting user details",noClose:!0,showLoader:!0}),Affinity.login.controller.getUser(this.searchEmployee.value))}.bind(this)}),window.removeEvent("gotUserWithPeriods",this.switchHandler),window.addEvent("gotUserWithPeriods",this.switchHandler),this.switchUser.delay(500,this,[Affinity.login.profile]))},periodString:!1,periodJumpLabel:!1,doPeriodJump:function(n){var i=n.target.hasClass("ribbonlink")?n.target:n.target.getParent(".ribbonlink"),t;i.hasClass("back")?(t="ribbonlink",this.payPeriodStr="Showing from <strong>"+this.ribbonInnerFrom.clone().toFriendlyShort()+"<\/strong> to <strong>"+this.ribbonInnerTo.clone().toFriendlyShort()+"<\/strong>",this.periodJumpLabel="Jump to current Pay Period",this.startDate=this.today.clone()):(t="ribbonlink back",this.payPeriodStr="Pay Period from <strong>"+this.userProfile.payPeriods.currentBegins.clone().toFriendlyShort()+"<\/strong> to <strong>"+this.userProfile.payPeriods.currentEnds.clone().toFriendlyShort()+"<\/strong>",this.periodJumpLabel="Back to Today",this.startDate=this.userProfile.payPeriods.currentBegins.clone().increment("day",Math.round(this.userProfile.payPeriods.length/2))),this.payPeriodBox.set("html",this.payPeriodStr),this.periodJumpLink.set("html",this.periodJumpLabel),this.periodJumpLink.set("class",t),this.periodJumpLink.inject(this.payPeriodBox),this.ribbon.jumpToDate(this.startDate,!0)},switchHandler:function(n){(function(){Affinity.views.dualdetailed.switchUser(n)}).bind(Affinity.views.dualdetailed)()},switchTimer:!1,lastRibbonStartDate:!1,timeoutAttempts:0,switchUser:function(n){var s,r,o;if(this.isViewActive()){if(Affinity.AwardModels.closeAll(),Affinity.timesheets.init.disableTab("addTab"),Affinity.prompts.hide("dualLoader"),this.initted&&this.options.target&&this.options.target.hasClass("hidden")){this.timeoutAttempts++,this.timeoutAttempts<10&&(clearTimeout(this.switchTimer),this.switchTimer=setTimeout(function(){this.switchUser(n)}.bind(this),500));return}if(clearTimeout(this.switchTimer),this.timeoutAttempts=0,this.userProfile=n,this.fromSwitchData&&this.startEmployee&&!Affinity.login.userProfiles.hasOwnProperty(this.startEmployee)){this.fromSwitchData=!1,window.removeEvent("gotUserWithPeriods",this.switchHandler),window.addEvent("gotUserWithPeriods",this.switchHandler),window.removeEvent("gotUser",this.switchHandler),window.addEvent("gotUser",this.switchHandler),uiloader({message:"Getting data for user "+this.startEmployee,type:"dualLoader"}),Affinity.login.controller.getUser(this.startEmployee);return}if(!this.userProfile.hasOwnProperty("payPeriods")&&Affinity.login.userProfiles.hasOwnProperty(this.userProfile.employeeNumber)&&Affinity.login.userProfiles[this.userProfile.employeeNumber].hasOwnProperty("payPeriods")&&(this.userProfile=Affinity.login.userProfiles[this.userProfile.employeeNumber]),this.startEmployee=!1,this.lastRibbonStartDate=this.ribbonLastDate?this.ribbonLastDate:this.lastRibbonStartDate,this.userProfile.hasOwnProperty("payPeriods")&&this.userProfile.payPeriods.ribbon){var t=this.userProfile.payPeriods.ribbon,u=!1,f="",e="",i="";this.ribbonFrom=t.fromDate.clone(),this.ribbonTo=t.toDate.clone(),this.ribbonInnerFrom=t.innerFromDate.clone(),this.ribbonInnerTo=t.innerToDate.clone(),this.ribbonStart=this.lastRibbonStartDate?this.lastRibbonStartDate.clone():t.startDate.clone(),this.startDate=this.lastRibbonStartDate?this.lastRibbonStartDate.clone():this.ribbonStart.clone(),this.lastRibbonStartDate=this.startDate.clone(),this.doRibbon?(s=this.userProfile.payPeriods.periodCurrentIndex===this.userProfile.payPeriods.periodTodayIndex,t.isPeriod?s?(i="Pay Period from <strong>"+this.ribbonInnerFrom.clone().toFriendlyShort()+"<\/strong> to <strong>"+this.ribbonInnerTo.clone().toFriendlyShort()+"<\/strong>",u=!1):(i="Showing from <strong>"+this.ribbonInnerFrom.clone().toFriendlyShort()+"<\/strong> to <strong>"+this.ribbonInnerTo.clone().toFriendlyShort()+"<\/strong>",f="<u>Jump to current Pay Period<\/u>",e="ribbonlink",u=!0):(i="Showing from <strong>"+this.ribbonInnerFrom.clone().toFriendlyShort()+"<\/strong> to <strong>"+this.ribbonInnerTo.clone().toFriendlyShort()+"<\/strong>",f="<u>Jump to current Pay Period<\/u>",e="ribbonlink",u=!0),this.payPeriodBox||(this.payPeriodBox=new Element("div",{"class":"ts-pay-period"}).inject(this.ribbonBox,"before")),u&&(this.periodJumpLink||(this.payPeriodStr=i,this.periodJumpLabel=f,this.periodJumpLink=new Element("span",{"class":e,html:f}),this.periodJumpLink.addEvent(Affinity.events.click,this.doPeriodJump))),this.payPeriodStr?this.payPeriodBox.set("html",this.payPeriodStr):i&&this.payPeriodBox.set("html",this.payPeriodStr),this.periodJumpLink&&(this.periodJumpLink.inject(this.payPeriodBox),this.periodJumpLink.set("html",this.periodJumpLabel))):this.dateWidget.setDate(this.startDate,!1)}r=new URI(this.options.getApi),o=typeOf(r.parsed.query)==="null"?{}:r.parsed.query.parseQueryString(),o.employeeNo=this.userProfile.employeeNumber,r.parsed.query=Object.toQueryString(o),this.getApi=Affinity.GetCacheSafePath(r.toString()),this.doRibbon&&(this.ribbonValueApi={url:this.getApi,method:"get",returnKey:"DayDetail[0].Total"}),this.load("Loading")}},complete:!1,refreshing:!1,detailsComplete:!1,awardsComplete:!1,overviewComplete:!1,load:function(n){this.refreshing||(uiloader({message:n,type:"dualLoader"}),!this.doRibbon&&this.dateWidget&&this.dateWidget.hasOwnProperty("obscure")&&this.dateWidget.obscure(),this.refreshing=!0,this.complete=!1,this.detailsComplete=!1,this.awardsComplete=!1,this.overviewComplete=!1,this.getTimesheets(),this.getAwards())},hideLoadOnComplete:function(){Affinity.prompts.currentType.toLowerCase().contains("fav")||Affinity.prompts.hide()},checkComplete:function(){Affinity.prompts.center(),this.fromSwitchData&&(this.fromSwitchData=!1,log("&#x22C8; switch dual detail view with switch data succeeded",{color:"green","font-weight":"bold"})),this.detailsComplete&&this.hideLoadOnComplete(),this.detailsComplete&&this.awardsComplete&&this.overviewComplete?(this.complete=!0,this.refreshing=!1,this.doRibbon&&this.ribbonValueApi&&(this.ribbon.reset({fromDate:this.ribbonFrom,toDate:this.ribbonTo,startDate:this.ribbonStart,innerFromDate:this.ribbonInnerFrom,innerToDate:this.ribbonInnerTo,valueApi:this.ribbonValueApi,deferInitialSelect:!0,markPeriods:!1}),this.ribbonValueApi=!1,Affinity.prompts.hide("dualLoader"),this.hideLoadOnComplete()),!this.doRibbon&&this.dateWidget&&this.dateWidget.hasOwnProperty("reveal")&&this.dateWidget.reveal(),this.searchEmployeeWidget&&this.searchEmployeeWidget.hasOwnProperty("reveal")&&this.searchEmployeeWidget.reveal(),this.fireEvent("complete")):!this.doRibbon&&this.dateWidget&&this.dateWidget.hasOwnProperty("obscure")&&this.dateWidget.obscure()},setDetailsComplete:function(){this.detailsComplete=!0,this.checkComplete()},setAwardsComplete:function(){this.awardsComplete=!0,this.checkComplete()},setOverviewComplete:function(){this.overviewComplete=!0,this.checkComplete()},toggleAddRowsForm:function(){},dateChanged:function(n){var t=!0;if(Affinity.AwardModels.closeAll(),this.ribbonLastDate&&n.format("%s")===this.ribbonLastDate.format("%s")&&(t=!1),t&&this.awardsWidget&&this.detailsWidget){if(this.awardsWidget.hasChanges()||this.detailsWidget.hasChanges()){uiconfirm({message:"You have unsaved changes.<br />Changes will be lost.<br />Continue anyway?",okIcon:Affinity.icons.Tick,cancelIcon:Affinity.icons.Cross,onOk:function(){this.startDate=n,this.fireEvent("dateChanged",n),this.complete&&this.load("Loading")}.bind(this)});return}this.startDate=n,this.fireEvent("dateChanged",n),this.complete&&this.load("Loading")}t&&(this.startDate=n,this.fireEvent("dateChanged",n),this.complete&&this.load("Loading")),this.ribbonLastDate=n.clone()},ignoreDeclined:!1,getTimesheets:function(){var i=Affinity.languages.english.application.timesheets,n,f;if(this.detailsWidget&&(this.detailsWidget.removeEvents(),this.detailsWidget.destroy(),this.detailsWidget=!1,this.detailsComplete=!1),this.detailsLoader&&(this.detailsLoader.removeEvents(),this.detailsLoader.cancel(),this.detailsLoader=!1),this.detailsZelosProcessor&&(this.detailsZelosProcessor.removeEvents(),this.detailsZelosProcessor.cancel(),this.detailsZelosProcessor=!1),this.tsDetailBox){n="",n+='<div class="section shadow "><div class="section-body"><div class="section-row">',n+='Loading Timesheets <img src="'+Affinity.loaders.light+'" />',n+="<\/div><\/div><\/div>",this.tsDetailBox.set("html",n).removeClass("hidden");var r=Affinity.zelosroot+"?api="+(this.isManager?"timesheetAsManager":"timesheet")+"/getEmptyTimesheet",u=Affinity.zelosroot+"?api="+(this.isManager?"timesheetAsManager":"timesheet")+"/post",t=Affinity.zelosroot+"?api="+(this.isManager?"timesheetAsManager":"timesheet")+"/get&fromDate="+this.startDate.format("%d.%b.%Y")+"&toDate="+this.startDate.format("%d.%b.%Y"),e=this.isManager?"manager":"employeeDetails";t+="&view=daydetail",t+="&page=0",t+="&pageSize=999",this.isManager&&(t+="&employeeNo="+(this.startEmployee?this.startEmployee:this.userProfile.employeeNumber),t+="&timesheetStatus=Submitted,Approved,Declined,Paid",(this.userProfile.employeeNumber+"").trim()+""===(Affinity.login.profile.employeeNumber+"").trim()&&(r=r.replace("timesheetAsManager","timesheet"),u=u.replace("timesheetAsManager","timesheet"),t=t.replace("timesheetAsManager","timesheet"),e="employeeDetails")),f={target:this.tsDetailBox,getApi:t,putApi:u,getEmptyTimesheetApi:r,timesheetType:e,isManager:this.isManager,fromDate:this.startDate,toDate:this.startDate,profile:this.userProfile,insertAddTimesheetForm:!1,paginate:!1,subType:"dual-timesheets",isDual:!0,onSaveError:function(){},beforSave:function(n){var u,f;if(n.button){if(u=!1,n.button.getParent(".default-form")&&n.button.getParent(".default-form").getElement("#ForwardTo")&&(u=!0,n.button.getParent(".default-form").getElement("#ForwardTo").value===""||n.button.getParent(".default-form").getElement("#ForwardTo").value==="0"))return uialert({message:Affinity.languages.english.generic.selectForward,noClose:!1,showButtons:!0,showLoader:!1}),!1;if(u)f=this.detailsWidget.cleanFavData(t),window.uialert({message:i.globals.forwardingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0});else{var t=!1,e=!1,r=n.button;if(r.hasClass("orange")&&window.uialert({message:i.globals.savingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),r.hasClass("green")&&(window.uialert({message:i.globals.submittingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),t="submit"),r.hasClass("grey")&&(window.uialert({message:i.globals.decliningSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),t="decline"),t){if(e=this.detailsWidget.reduceBulkRows(t,this.ignoreDeclined),this.ignoreDeclined=!1,!e)return Affinity.UI.___tempCallback=function(n){this.ignoreDeclined=n.ignoreDeclined,window.removeEvent("__tempCallback",Affinity.UI.___tempCallback),Affinity.UI.___tempCallback=null,delete Affinity.UI.___tempCallback,this.detailsZelosProcessor.submit({target:r})}.bind(this),window.addEvent("__tempCallback",Affinity.UI.___tempCallback),!1}else f=this.detailsWidget.cleanFavData(t),window.uialert({message:i.globals.processingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0})}}return!0}.bind(this),onSave:function(){}.bind(this),onComplete:function(){}.bind(this)},this.detailsZelosProcessor=new ZelosTemplateProcess(f),this.detailsLoader=new ZelosTemplateLoad({onRequest:function(){},onError:function(t){n="",n+='<div class="section shadow "><div class="section-body"><div class="section-row">',n+="There was an error retrieving your timesheets.<!--"+t+"-->",n+="<\/div><\/div><\/div>",this.tsDetailBox.set("html",n),Affinity.prompts.hide()}.bind(this),onComplete:function(n){var t,i,r;this.tsDetailBox.empty().removeClass("hidden"),this.detailsZelosProcessor.processTemplate(n),this.detailsWidget=this.tsDetailBox.getElement(".widget.timesheettable").getWidget().internalWidget,this.detailsWidget.aaa="I am detail view - timesheets",this.detailsWidget.addEvent("processComplete",function(){var n=this.detailsWidget.returnMessagesArray();this.timesheetMessageBox.set("html",n.length===0?"There are currently no messages warnings or errors.":n.join("")),this.complete&&this.awardsWidget&&"refresh"in this.awardsWidget&&(this.complete=!1,this.awardsComplete=!1,this.awardsWidget.removeEvent("newRowsLoaded",this.setAwardsComplete),this.awardsWidget.addEvent("newRowsLoaded",this.setAwardsComplete),this.awardsWidget.refresh()),clearTimeout(this.refreshOverviewTimer),this.refreshOverviewTimer=function(){this.complete&&this.overviewWidget&&"refresh"in this.overviewWidget&&(this.complete=!1,this.overviewComplete=!1,this.overviewWidget.removeEvent("detailsLoaded",this.setOverviewComplete),this.overviewWidget.addEvent("detailsLoaded",this.setOverviewComplete),this.overviewWidget.refresh())}.delay(1e3,this),this.detailsComplete||(this.detailsComplete=!0,this.checkComplete())}.bind(this)),t=this.tsDetailBox.getElements(".section.shadow"),t.length>0&&(i=t[t.length-1],r=t[0],i.getElement(".section-body").inject(r.getElement(".section-body"),"after"),i.addClass("hidden"))}.bind(this)}).loadTemplate(f.getApi)}else uialert({message:"oops! Something went wrong.<br />Please refresh the page and try again.",canClose:!0,showButtons:!0,showLoader:!1})},refreshOverviewTimer:!1,renderOverviewTimer:!1,getAwards:function(){var t=Affinity.languages.english.application.timesheets,n,i,r,u;if(!this.doAwards){this.awardsComplete=!0,this.overviewComplete=!0,this.awardsWidget=!1,this.overviewWidget=!1,this.awardsLoader=!1,this.awardsZelosProcessor=!1,this.setAwardsComplete(),this.setOverviewComplete();return}clearTimeout(this.renderOverviewTimer),this.awardsWidget&&(this.awardsWidget.removeEvents(),this.awardsWidget.destroy(),this.awardsComplete=!1,this.awardsWidget=!1),this.overviewWidget&&(this.overviewWidget.removeEvents(),this.overviewWidget.destroy(),this.overviewComplete=!1,this.overviewWidget=!1),this.awardsLoader&&(this.awardsLoader.removeEvents(),this.awardsLoader.cancel(),this.awardsLoader=!1),this.awardsZelosProcessor&&(this.awardsZelosProcessor.removeEvents(),this.awardsZelosProcessor.cancel(),this.awardsZelosProcessor=!1),this.costDetailBox?(n="",n+='<div class="section shadow "><div class="section-body"><div class="section-row">',n+='Loading Data <img src="'+Affinity.loaders.light+'" />',n+="<\/div><\/div><\/div>",this.costDetailBox.set("html",n).removeClass("hidden"),i=Affinity.zelosroot+"?api=TimesheetPayTrans/GetPayTransForDate&fromDate="+this.startDate.format("%d.%b.%Y")+"&toDate="+this.startDate.format("%d.%b.%Y"),r=Affinity.zelosroot+"?api=TimesheetInfo/GetTimesheetTotal",this.isManager&&this.userProfile.employeeNumber&&(i+="&employeeNo="+this.userProfile.employeeNumber,r+="&employeeNo="+this.userProfile.employeeNumber),u={target:this.costDetailBox,getApi:i,putApi:Affinity.zelosroot+"?api=TimesheetPayTrans/Post",getEmptyTimesheetApi:Affinity.zelosroot+"?api=TimesheetPayTrans/CreatePayTransTemplate",timesheetType:"employeeDetails",isManager:this.isManager,fromDate:this.startDate,toDate:this.startDate,profile:this.userProfile,insertAddTimesheetForm:!1,paginate:!1,subType:"dual-awards",isDual:!0,isAllowanceGrid:!0,onSaveError:function(){},beforSave:function(n){return n.button&&(n.button.hasClass("orange")&&window.uialert({message:t.globals.savingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0,type:"dualLoader"}),n.button.hasClass("green")&&window.uialert({message:t.globals.submittingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0,type:"dualLoader"}),n.button.hasClass("grey")&&window.uialert({message:t.globals.decliningSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0,type:"dualLoader"})),!0}.bind(this),onSave:function(){}.bind(this),onComplete:function(){}.bind(this)},this.awardsZelosProcessor=new ZelosTemplateProcess(u),this.awardsLoader=new ZelosTemplateLoad({onRequest:function(){},onError:function(t){n="",n+='<div class="section shadow "><div class="section-body"><div class="section-row">',n+="There was an error retrieving your awards.<!--"+t+"-->",n+="<\/div><\/div><\/div>",this.costDetailBox.set("html",n),Affinity.prompts.hide()}.bind(this),onComplete:function(n){this.costDetailBox.empty().removeClass("hidden"),this.awardsZelosProcessor.processTemplate(n),this.awardsWidget=this.costDetailBox.getElement(".widget.timesheettable").getWidget().internalWidget,this.awardsWidget.aaa="I am detail view - awards",this.costDetailBox.getElement(".section-header").addClass("hidden"),this.awardsWidget.addEvent("processComplete",function(){this.complete&&this.detailsWidget&&"refresh"in this.detailsWidget&&(this.complete=!1,this.detailsComplete=!1,this.detailsWidget.removeEvent("newRowsLoaded",this.setDetailsComplete),this.detailsWidget.addEvent("newRowsLoaded",this.setDetailsComplete),this.detailsWidget.refresh()),clearTimeout(this.refreshOverviewTimer),this.refreshOverviewTimer=function(){this.complete&&this.overviewWidget&&"refresh"in this.overviewWidget&&(this.complete=!1,this.overviewComplete=!1,this.overviewWidget.removeEvent("detailsLoaded",this.setOverviewComplete),this.overviewWidget.addEvent("detailsLoaded",this.setOverviewComplete),this.overviewWidget.refresh())}.delay(1e3,this),this.awardsComplete||(this.awardsComplete=!0,this.checkComplete())}.bind(this));var i=this.costDetailBox.getElement(".section"+(Affinity.appname!=="dashboard"?".shadow":"")),t=i.getElement(".default-form").addClass("inline-awards");t.getParent().addClass("has-inline"),this.overviewBox=new Element("div",{"class":"inline-overview"}).inject(t,"before"),clearTimeout(this.refreshOverviewTimer),clearTimeout(this.renderOverviewTimer),this.renderOverviewTimer=function(){clearTimeout(this.refreshOverviewTimer),clearTimeout(this.renderOverviewTimer),this.overviewWidget=new ZelosWidgetTimesheetOverview({target:this.overviewBox,isManager:this.isManager,fromDate:this.startDate,toDate:this.startDate,startDate:this.startDate,getApi:r,profile:this.userProfile||!1,doRibbon:!1,subType:"dual-overview",onComplete:function(){var t=this.costDetailBox.getElement(".section-header").addClass("hidden"),n=t.getElement(".section-title").get("html");n.contains("Calculated ")&&(n=n.replace("Calculated ",'<span class="hide-on-mobile">Calculated <\/span>')),new Element("div",{"class":"section-title",html:n}).inject(this.overviewBox,"top"),this.overviewComplete||(this.overviewComplete=!0,this.checkComplete())}.bind(this)})}.delay(500,this)}.bind(this)}).loadTemplate(u.getApi)):uialert({message:"oops! Something went wrong.<br />Please refresh the page and try again.",canClose:!0,showButtons:!0,showLoader:!1})},fromSwitchData:!1,refresh:function(n,t){var r,i,u,f,e,o,s,h;this.refreshing||(this.refreshing=!0,log("&#171; refresh dual detail view &#187;"),Affinity.timesheets.init.disableTab("addTab"),r="Refreshing",i=!1,n&&(this.startDate=n,this.lastRibbonStartDate=this.startDate.clone(),this.ribbonLastDate=this.startDate.clone(),this.dateWidget&&this.dateWidget.setDate(this.startDate,!1),this.ribbon&&this.ribbon.setDate(this.startDate,!1)),t&&(this.startEmployee=t.employeeNumber,i=t.employeeNumber,this.searchEmployeeWidget&&this.searchEmployeeWidget.setValue(i+"",!1)),Affinity.viewSettings.employeeNumber&&Affinity.viewSettings.startDate&&(this.fromSwitchData=!0,this.searchEmployeeWidget&&(this.detailsComplete=!1,this.awardsComplete=!this.doAwards,this.overviewComplete=!this.doOverview,this.fromSwitchData=!0,this.startDate=Affinity.viewSettings.startDate.clone(),this.lastRibbonStartDate=Affinity.viewSettings.startDate.clone(),this.startEmployee=Affinity.viewSettings.employeeNumber,this.switchViewSettings=Object.clone(Affinity.viewSettings.profile.get()),this.ribbonLastDate=this.startDate.clone(),i=this.searchEmployeeWidget.getValue()+"",i!==this.startEmployee&&(this.searchEmployeeWidget.setValue(this.startEmployee,!1),i=this.startEmployee),this.lastRibbonStartDate=this.startDate.clone(),this.doRibbon?this.ribbon.clear()&&this.ribbon.setDate(this.startDate.clone(),!1):this.dateElement&&this.dateWidget.setDate(this.startDate.clone(),!1)),Affinity.viewSettings.reset(),r="Getting employee "+i+" for "+this.startDate.toFriendlyShort()),uiloader({message:r,type:"dualRefresh"}),this.refreshing=!0,this.doRibbon&&this.ribbon.refresh(),this.detailsWidget&&"refresh"in this.detailsWidget?(this.detailsWidget.showAlerts=!1,this.detailsComplete=!1,this.detailsWidget.removeEvent("newRowsLoaded",this.setDetailsComplete),this.detailsWidget.addEvent("newRowsLoaded",this.setDetailsComplete),u=this.detailsWidget.setDates(this.startDate,this.startDate),f=this.detailsWidget.setEmployee(i),u&&f&&this.detailsWidget.refresh()):this.getTimesheets(),this.doAwards?this.awardsWidget&&"refresh"in this.awardsWidget?(this.awardsWidget.showAlerts=!1,this.awardsComplete=!1,this.awardsWidget.removeEvent("newRowsLoaded",this.setAwardsComplete),this.awardsWidget.removeEvent("loadError",this.setAwardsComplete),this.awardsWidget.addEvent("newRowsLoaded",this.setAwardsComplete),this.awardsWidget.addEvent("loadError",this.setAwardsComplete),e=this.awardsWidget.setDates(this.startDate,this.startDate),o=this.awardsWidget.setEmployee(i),e&&o&&this.awardsWidget.refresh()):this.getAwards():this.awardsComplete=!0,this.doOverview?this.overviewWidget&&"refresh"in this.overviewWidget&&(this.overviewWidget.showAlerts=!1,this.overvieComplete=!1,this.overviewWidget.removeEvent("detailsLoaded",this.setOverviewComplete),this.overviewWidget.removeEvent("loadError",this.setOverviewComplete),this.overviewWidget.addEvent("detailsLoaded",this.setOverviewComplete),this.overviewWidget.addEvent("loadError",this.setOverviewComplete),s=this.overviewWidget.setDate(this.startDate),h=this.overviewWidget.setEmployee(i),s&&h&&this.overviewWidget.refresh()):this.overviewComplete=!0)},hasChanges:function(){return!1},destroy:function(){clearTimeout(this.switchTimer),clearTimeout(this.refreshOverviewTimer),clearTimeout(this.renderOverviewTimer),clearTimeout(this.employeSelectTimer),this.awardsLoader&&(this.awardsLoader.removeEvents(),this.awardsLoader.cancel()),this.detailsLoader&&(this.detailsLoader.removeEvents(),this.detailsLoader.cancel()),this.detailsZelosProcessor&&(this.detailsZelosProcessor.removeEvents(),this.detailsZelosProcessor.cancel()),this.awardsZelosProcessor&&(this.awardsZelosProcessor.removeEvents(),this.awardsZelosProcessor.cancel()),this.awardsWidget&&(this.awardsWidget.removeEvents(),this.awardsWidget.destroy()),this.overviewWidget&&(this.overviewWidget.removeEvents(),this.overviewWidget.destroy()),this.detailsWidget&&(this.detailsWidget.removeEvents(),this.detailsWidget.destroy()),this.doRibbon&&this.ribbon.destroy(),this.container&&("eliminate"in this.container&&this.container.eliminate("widget"),this.container.removeEvents(),this.container.destroy()),this.removeEvents(),window.removeEvent("gotUserWithPeriods",this.switchHandler),window.removeEvent("gotUser",this.switchHandler),Object.each(this,function(n,t){this[t]=null,delete this[t]}.bind(this)),Affinity.views.dualdetailed=null,delete Affinity.views.dualdetailed}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetEditForm={Version:"1.0.14.0",Sequence:10310,Name:"Timesheet Edit Form (Zelos Widget)",File:"ui.zelos.widget.timesheets.editform.js",Jira:"",Notes:"Hide Awards button on mobile"},ZelosWidgetTimesheetEditForm=new Class({Implements:[Options,Events],WidgetName:"TimesheetEditForm",Binds:["initZelos","initForm","updateFromOriginDoc","populatetemplateFromKeyValueObject","updateParentElement","updateTemplateFromTarget","buttonClicked","isDatabaseSaveOperation","duplicateRowOnDetailedView","checkOriginDocStatus","checkTimesheetType","getOperationType","operationType","hide","destroy","isPostOperation","getPropertyObjectFromZelosProcessorTemplate","getTimesheetDateValueFromTargetElement","setCorrectDateFormatForTsDateValue","authoriserObject","setCorrectAuthoriserObject","disableBackgroundScrolling","enableBackgroundScrolling"],options:{target:null,timesheetId:null,employeeNumber:null,onButtonClicked:!1,originRow:!1,originRowIndex:-1,originDoc:!1,updateOnChange:function(){},refreshBehind:function(){},supressButtons:!1,keyValueData:null,width:400},initialize:function(n){(this.setOptions(n),this.disableBackgroundScrolling(),Affinity.viewLast=Affinity.view+"",Affinity.view="form-edit",Affinity.modal.beforeClose=this.destroy,this.api=(Affinity.zelosroot+"?api=Timesheet/").replace(/\/\//gi,"/"),this.target=this.options.target,this.timesheetId=this.options.timesheetId||!1,this.employeeNumber=this.options.employeeNumber||!1,this.externalbuttonClicked=this.options.buttonClicked||!1,this.originRow=this.options.originRow||!1,this.originRowIndex=this.options.originRowIndex>=0?this.options.originRowIndex:-1,this.originDoc=this.options.originDoc||!1,this.operationType=this.getOperationType(),this.target)&&(this.formWidth=Affinity.mobile?window.getSize().x-60:this.options.width,this.target.setStyle("width",this.formWidth),uialert({message:"Loading",showLoader:!0,showButtons:!1,noClose:!0}),this.initZelos())},operationType:"",authoriserObject:null,disableBackgroundScrolling:function(){var n=document.getElementsByClassName("pagewrapper"),t;n.length>0&&($(n[0]).setStyle("overflow","hidden"),$(n[0]).setStyle("position","relative"),$(n[0]).setStyle("height","100%")),document.getElement("body").setStyle("overflow","hidden"),document.getElement("body").setStyle("position","relative"),document.getElement("body").setStyle("height","100%"),t=document.querySelector("html"),$(t).setStyle("overflow","hidden"),$(t).setStyle("position","relative"),$(t).setStyle("height","100%")},enableBackgroundScrolling:function(){var n=document.getElementsByClassName("pagewrapper"),t;n.length>0&&$(n[0]).removeAttribute("style"),document.getElement("body").removeAttribute("style"),t=document.querySelector("html"),$(t).removeAttribute("style")},initZelos:function(){this.zelosEngine=new ZelosInit({htmlTemplateUrl:Affinity.timesheets.zelosHtmlTemplate,onRequest:function(){},onError:function(n){uimessage({message:"Could not start. "+n})},onComplete:function(){this.initForm()}.bind(this)})},zelosProcessor:!1,duplicateRowOnDetailedView:function(){var n=this.options.originRowIndex;this.options.duplicateTimesheet(n),Affinity.modal.hide()},checkTimesheetType:function(){var n="";return Array.each(this.originDoc.Children,function(t){t.Source.PropertyName==="TimesheetType"&&(n=t.ValueAsString)}.bind(this)),n===""&&Array.each(this.originDoc.Children,function(t){t.Name.toLowerCase().indexOf("mileage")>-1&&(n="4")}.bind(this)),n},checkOriginDocStatus:function(){var n="";return Array.each(this.originDoc.Children,function(t){t.Source.PropertyName==="TsStatus"&&(n=t.ValueAsString)}.bind(this)),n},getOperationType:function(){var n="edit";return Array.each(this.originDoc.Children,function(t){t.Source.PropertyName==="TimesheetId"&&t.ValueAsString==="-1"&&(n="add")}.bind(this)),n},initForm:function(){this.zelosProcessor=new ZelosTemplateProcess({target:this.target,getApi:"none",putApi:this.api+"PostTimesheetAsForm",onComplete:function(){var i,t,n,r,u;prompts.hide(),Affinity.modal.clear(),Affinity.modal.adopt(this.target),Affinity.modal.show(),Affinity.modal.position(),Affinity.modal.beforeClose=this.hide,this.target.getElements(".shadow").removeClass("shadow"),this.target.getElement(".section-header").addClass("hidden"),this.options.supressButtons?(i=!1,this.target.getElements(".button-wrapper")&&(this.target.getElements(".button-wrapper").addClass("hidden"),i=!0),this.doneButton=new Element("div",{"class":"button blue",html:"Done"}),this.doneButton.addEvent(Affinity.events.click,function(){this.fireEvent("done",this.zelosProcessor.updateDocument()),this.hide()}.bind(this)),i?this.doneButton.inject(this.target.getElements(".button-wrapper").getLast(),"after"):this.doneButton.inject(this.target.getElement(".default-form"),"bottom")):Array.each(this.target.getElements(".button"),function(n){n.get("data-name")&&n.get("data-name").test("favourite|awards","gi")?n.addClass("hidden"):n.get("id")&&n.get("id").test("favourite","gi")?n.addClass("hidden"):n.addEvent(Affinity.events.click,this.buttonClicked)}.bind(this)),n=this.target.getElements(".has-dependencies"),Array.each(n,function(n){if(t=n.retrieve("dependencies"),t&&"setEvents"in t)t.setEvents();else try{var r=n.getParent("tr"),i="";i+="!!!\tDependency issue found\r\n",i+="\tTime:\t"+(new Date).toTime()+"\r\n",i+="\tElement ID:\t"+n.get("id")+"\r\n",i+="\tElement Class:\t"+n.get("class")+"\r\n",i+="\tRow ID:\t"+r.get("id")+"\r\n",i+="\tRow Class:\t"+r.get("class")+"\r\n",i+="!!!",log(i)}catch(u){}}.bind(this)),this.originRow&&this.originRowIndex>-1&&this.originDoc&&(n=this.target.getElements(".has-change-tracker"),Array.each(n,function(n){var t=!1;t=n.getWidget(),t&&t.hasOwnProperty("output")&&t.output?t.output.addEvent("change",this.updateParentElement):n.getAttribute("type")==="text"?n.addEvent("keyup",this.updateParentElement):n.addEvent("change",this.updateParentElement)}.bind(this))),Affinity.tooltips&&Affinity.tooltips.processNew(),Affinity.lookups&&Affinity.lookups.processNew({jsonp:!0,operationType:this.operationType}),Affinity.displaylookups&&Affinity.displaylookups.processNew({jsonp:!0}),r=this.checkOriginDocStatus(),u=this.checkTimesheetType(),r!=="Pending"&&r!=="New"&&(u==="1"||u==="4")&&this.target.getElements(".button-wrapper .timesheet-button")&&new Element("span",{"class":"button-wrapper"}).adopt(new Element("span",{"class":"button blue w-icon",html:"<span>"+Affinity.icons.Docs+"<\/span><span>Duplicate<\/span>"}).addEvent(Affinity.events.click,this.duplicateRowOnDetailedView)).inject(this.target.getElements(".button-wrapper").getLast(),"after"),this.target.getElements(".button-wrapper .timesheet-button")&&new Element("span",{"class":"button-wrapper"}).adopt(new Element("span",{"class":"button grey w-icon",html:'<span class="icon-cross"><\/span><span>Close<\/span>'}).addEvent(Affinity.events.click,Affinity.modal.hide)).inject(this.target.getElements(".button-wrapper").getLast(),"after"),Affinity.modal.position(),window.addEvent("mobileback",this.hide),this.fireEvent("loaded",{doc:doc})}.bind(this),beforSave:function(n){var u,t,i=n.button.get("data-type"),r=n.button;return(r.hasClass("orange")||r.hasClass("green"))&&(r.hasClass("orange")&&window.uialert({message:'Saving Selected Timesheets <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),r.hasClass("green")&&(window.uialert({message:'Submitting Selected Timesheets <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),type="submit")),this.attemptingDelete=!1,i.toLowerCase()==="delete"&&(this.attemptingDelete=!0),Array.each(this.zelosProcessor.template.Children[0].Children,function(n,r){n.Name.split("-").getLast()==="RowButton"&&Array.each(n.Children,function(n,f){try{this.zelosProcessor.template.Children[0].Children[r].Children[f].ElementType="WorkflowButton",t=Object.clone(n.Value),n.Type===i||n.Value.ButtonType==i?(t.Pressed=!0,u=Object.clone(n)):t.Pressed=!1,this.zelosProcessor.template.Children[0].Children[r].Children[f].Value=t,this.zelosProcessor.template.Children[0].Children[r].Children[f].ValueAsString=JSON.stringify(t)}catch(e){}}.bind(this))}.bind(this)),this.zelosProcessor.template.Children[0].ElementType="SectionHeading",this.zelosProcessor.template.Children[0].Name="Timesheets",u!==null&&(this.zelosProcessor.template.Children[1].ElementType="SectionHeading",Array.each(this.zelosProcessor.template.Children[1].Children,function(n,r){t=this.zelosProcessor.template.Children[1].Children[r].Value,t.Pressed=n.ButtonType===i||n.Value.ButtonType===i?!0:!1,this.zelosProcessor.template.Children[1].Children[r].Value=t,this.zelosProcessor.template.Children[1].Children[r].ValueAsString=JSON.stringify(t)}.bind(this))),!0}.bind(this),onSaveError:function(n){this.options.refreshBehind(),typeOf(n)==="string"?n.trim()===""?(this.checkDelete(),this.hide()):uialert({message:Affinity.languages.english.generic.error+n,isCloseOnClick:!0}):typeOf(n)!=="null"&&typeof n!="undefined"?(console.log("error with object?"),console.log(n),uialert({message:Affinity.languages.english.generic.error})):(this.checkDelete(),this.hide())}.bind(this),onSave:function(n){this.checkDelete(),this.fireEvent("save",{doc:n}),this.hide()}.bind(this),operationType:this.operationType});var n;n=this.employeeNumber?Affinity.zelosroot+"?api=timesheet/GetEmptyTimesheetAsForm&EmployeeNo="+this.employeeNumber:this.timesheetId?Affinity.zelosroot+"?api=timesheet/GetTimesheetAsForm&timesheetId="+this.timesheetId:Affinity.zelosroot+"?api=timesheet/GetEmptyTimesheetAsForm&EmployeeNo="+Affinity.login.profile.employeeNumber,this.zelosLoader=new ZelosTemplateLoad({onRequest:function(){},onError:function(n){this.employeeProcessed=!0;var t="";t+='<div class="section shadow "><div class="section-body"><div class="section-row">',t+="There was an error retrieving your timesheets.<!--"+n+"-->",t+="<\/div><\/div><\/div>",Affinity.prompts.hide()}.bind(this),onComplete:function(n){for(var i=this.originDoc,r=!1,u,t=0;t<n.Children[0].Children.length;t++)r&&(t=0,r=!1),child=n.Children[0].Children[t],u=!1,Array.each(i.Children,function(n){child.Source.PropertyName===n.Source.PropertyName&&(u=!0)}.bind(this)),u||(n.Children[0].Children.splice(t,1),r=!0);Array.each(n.Children[0].Children,function(n){n.Source.PropertyName==="TsCode"&&Array.each(i.Children,function(t){t.Source.PropertyName==="TsCode"&&(n.Data=t.Data,n.Description=t.Description)}),n.Source.PropertyName==="AuthoriserId"&&Array.each(i.Children,function(t){t.Source.PropertyName==="AuthoriserId"&&(n.Data=t.Data,n.ElementType=t.ElementType,n.SelectedItem=t.SelectedItem,n.SelectedItemAsString=t.SelectedItemAsString,n.Source=t.Source,n.Value=t.Value,n.ValueAsString=t.ValueAsString,delete n.InputType,this.authoriserObject=Object.clone(n))}.bind(this))}.bind(this)),n=this.updateFromOriginDoc(n),this.form=n,n=this.populatetemplateFromKeyValueObject(n),this.zelosProcessor.processTemplate(n)}.bind(this)}).loadTemplate(n)},checkDelete:function(){this.attemptingDelete&&this.options.refreshBehind(),this.attemptingDelete=!1},updateParentElement:function(n){var r=n.target.hasClass("has-change-tracker")?n.target:n.target.getParent(".has-change-tracker"),t=r.getParent(".form-row"),i=value=elementIndex=!1;t&&t.get("data-child-index")&&(docIndex=parseInt(t.get("data-doc-index")),elementIndex=parseInt(t.get("data-child-index")),i=r.getWidget(),value=i&&i.hasOwnProperty("getValue")?i.getValue():r.value),value&&this.originDoc&&(this.originDoc.Children[elementIndex].Value=value,this.originDoc.Children[elementIndex].ValueAsString=value+"",this.zelosProcessor.template.Children[0]=this.originDoc)},updateTemplateFromTarget:function(){this.isDatabaseSaveOperation||Array.each(this.originDoc.Children,function(n){if(n.Description.ShortText==="Timesheet Status"&&n.ValueAsString==="New"){var t=this.target.getElements(".has-change-tracker");Array.each(t,function(n){var t=n.getParent(".form-row"),i;t&&t.get("data-child-index")&&(i=parseInt(t.get("data-child-index")),this.options.updateOnChange(this.options.originDoc,this.options.originRowIndex,i,this.originDoc))}.bind(this))}}.bind(this)),this.isDatabaseSaveOperation=!1},updateFromOriginDoc:function(n){var t;if(this.originDoc){t=this.originDoc,typeOf(this.originDoc)!=="array"&&this.originDoc.hasOwnProperty("Children")&&(t=this.originDoc.Children);var i=!1,r=!1,u=null;return Array.each(t,function(t){i||t.Name.split("-").getLast()!=="RowButton"||(i=!0,u=Object.clone(t)),Array.each(n.Children[0].Children,function(i,u){r||i.Name.split("-").getLast()!=="RowButton"||(r=!0),i.Name.split("-").getLast()===t.Name.split("-").getLast()&&(n.Children[0].Children[u].Attribute=Object.clone(t.Attribute),n.Children[0].Children[u].Value=t.Value,n.Children[0].Children[u].ValueAsString=t.ValueAsString)}.bind(this))}.bind(this)),i&&!r&&u!==null&&(n.Children[1]=u),n}return n},populatetemplateFromKeyValueObject:function(n){return typeOf(this.options.keyValueData)!=="null"&&Object.each(this.options.keyValueData,function(t,i){Array.each(n.Children[0].Children,function(r,u){if(r.Name.contains(i))if("Value"in r)typeOf(r.Value)==="array"?(Array.each(r.Value,function(i,r){typeOf(i)==="object"&&"selected"in i&&"value"in i&&(n.Children[0].Children[u].Value[r].selected=!1,i.value+""==t+""&&(n.Children[0].Children[u].Value[r].selected=!0))}.bind(this)),n.Children[0].Children[u].ValueAsString=JSON.stringify(n.Children[0].Children[u].Value),"SelectedItem"in r&&(n.Children[0].Children[u].SelectedItem=t,n.Children[0].Children[u].SelectedItemAsString=t)):typeOf(r.Value)==="string"?(n.Children[0].Children[u].Value=t,n.Children[0].Children[u].ValueAsString=t):isNaN(r.Value)?(console.log(""),console.log("child has Value, but is not array, string or number ... what to do ?"),console.log(r),console.log("")):(n.Children[0].Children[u].Value=parseFloat(t),n.Children[0].Children[u].ValueAsString=t+"");else if("InputType"in r)switch(r.InputType){case"Lookup":n.Children[0].Children[u].Value=t,n.Children[0].Children[u].ValueAsString=t;break;case"Float":n.Children[0].Children[u].Value=parseFloat(t),n.Children[0].Children[u].ValueAsString=t+"";break;case"Integer":n.Children[0].Children[u].Value=parseInt(t,10),n.Children[0].Children[u].ValueAsString=t+"";break;case"String":n.Children[0].Children[u].Value=t,n.Children[0].Children[u].ValueAsString=t;break;case"Date":case"Time":case"HoursMins":n.Children[0].Children[u].Value=t,n.Children[0].Children[u].ValueAsString=t;break;default:console.log(""),console.log("Don't know what to do with InputType \""+r.InputType+'" ... what to do ?'),console.log(r),console.log("")}else console.log(""),console.log("child has NO Value and no InputType ... what to do ?"),console.log(r),console.log("")}.bind(this))}.bind(this)),n},isDatabaseSaveOperation:!1,buttonClicked:function(n){n.stop();var i=n.target.hasClass("button")?n.target:n.target.getParent(".button"),t=i.get("id");t&&(t.test(new RegExp("save","gi"))||t.test(new RegExp("submit","gi"))||t.test(new RegExp("delete","gi"))||t.test(new RegExp("approve","gi"))||t.test(new RegExp("decline","gi")))&&(this.isPostOperation(t)&&this.setCorrectDateFormatForTsDateValue(),this.setCorrectAuthoriserObject(),this.isDatabaseSaveOperation=!0,this.zelosProcessor.updateDocument(),this.zelosProcessor.submit(n))},setCorrectAuthoriserObject:function(){for(var i=this.originDoc,t,n=0;n<this.zelosProcessor.template.Children[0].Children.length;n++)if(this.zelosProcessor.template.Children[0].Children[n].Source.PropertyName==="AuthoriserId")for(t=0;t<i.Children.length;t++)i.Children[t].Source.PropertyName==="AuthoriserId"&&this.authoriserObject.Value!==undefined&&this.authoriserObject.Value.length!==undefined&&this.authoriserObject.Value.length===1&&(this.zelosProcessor.template.Children[0].Children[n]=Object.clone(this.authoriserObject),i.Children[t]=Object.clone(this.authoriserObject))},setCorrectDateFormatForTsDateValue:function(){var t=this.getPropertyObjectFromZelosProcessorTemplate("TsDate"),n=this.getTimesheetDateValueFromTargetElement(),i;n!==undefined&&n!==null&&(i=new Date(n),i!=="Invalid Date"&&(t.Value=n,t.ValueAsString=JSON.stringify(n)))},isPostOperation:function(n){var t=!1;return(n.test(new RegExp("save","gi"))||n.test(new RegExp("submit","gi"))||n.test(new RegExp("approve","gi")))&&(t=!0),t},getPropertyObjectFromZelosProcessorTemplate:function(n){var t=null;return this.zelosProcessor.template!==null&&this.zelosProcessor.template!==undefined&&Array.each(this.zelosProcessor.template.Children[0].Children,function(i){i.Source!==undefined&&i.Source.PropertyName!==undefined&&i.Source.PropertyName===n&&(t=i)}.bind(this)),t},getTimesheetDateValueFromTargetElement:function(){var n=this.target.getElement(".ui-calendar-row"),t,i;return n!==null&&n!==undefined&&n.getChildren!==undefined&&(t=n.getChildren("input[type=hidden]"),i=null,t.length===1&&(i=t[0].value)),i},hide:function(){this.enableBackgroundScrolling(),this.updateTemplateFromTarget(),this.setCorrectAuthoriserObject(),Affinity.modal.beforeClose=null,Affinity.modal.hide(),this.destroy()},destroy:function(){if(this.target){if(this.originRow&&this.originRowIndex>-1&&this.originDoc){var n=this.target.getElements(".has-change-tracker");Array.each(n,function(n){n.getAttribute("type")==="text"?n.removeEvent("keyup",this.updateParentElement):n.removeEvent("change",this.updateParentElement)}.bind(this))}Array.each(this.target.getElements(".widget"),function(n){n.retrieve("widget")&&"destroy"in n.retrieve("widget")&&n.retrieve("widget").destroy()})}window.removeEvent("mobileback",this.hide),Affinity.view=Affinity.viewLast+""}}),"Affinity"in window||(window.Affinity={}),"Components"in Affinity||(Affinity.Components={}),Affinity.Components.ZelosWidgetTimesheetTable={Version:"1.0.4.0",Sequence:10180,Name:"Timesheet Table (Zelos Widget)",File:"ui.zelos.widget.table.js",Jira:"",Notes:"Add filter dates to manager (team) view"},ZelosWidgetTimesheetTable=new Class({Implements:[Options,Events],Binds:[""],options:{timesheetType:"employee",isManager:!1,parentDocument:null,parentSectionIndex:null,parentChildIndex:null,widgetDocument:null,putApi:null,getEmptyTimesheetApi:"",target:null,zelosEngine:null,zelosProcessor:null,insertAddForm:!0,isManager:!1,fromDate:!1,toDate:!1,filterFromDate:!1,filterToDate:!1,profile:!1,startDay:0,showDays:7,publicHolidays:[],readOnly:!1,requiredUiComponenets:["ZelosWidgetTimesheetTableAsWeekly","ZelosWidgetTimesheetTableAsDetailed"]},initialize:function(n){this.setOptions(n);var t=[];if(Array.each(this.options.requiredUiComponenets,function(n){typeOf(window[n])!="class"&&t.push(n)}),t.length>0)throw new ZelosError("There are components missing that are required for Zelos Timesheets to run:\n"+t.join("\n")+"\nPlease refer to 'Setting up Zelos UI Timesheets' in documentation.");this.options.timesheetType==="employee"&&(this.internalWidget=new ZelosWidgetTimesheetTableAsWeekly(n),this.toggleAddRowsForm=this.internalWidget.toggleAddRowsForm.bind(this.internalWidget),this.toggleSearchForm=function(){},this.showAddRowsForm=function(){},this.showSearchForm=function(){},this.addRows=function(){},this.returnDocument=this.internalWidget.returnDocument.bind(this.internalWidget),this.checkSelected=this.internalWidget.checkSelected.bind(this.internalWidget),this.hasChanges=this.internalWidget.hasChanges.bind(this.internalWidget),this.getChangeMessage=this.internalWidget.getChangeMessage.bind(this.internalWidget),this.refresh=this.internalWidget.refresh.bind(this.internalWidget),this.processErrors=this.internalWidget.processErrors.bind(this.internalWidget),this.delUnload=this.internalWidget.delUnload.bind(this.internalWidget),this.destroy=this.internalWidget.destroy.bind(this.internalWidget)),this.options.timesheetType==="employeeDetails"&&(this.internalWidget=new ZelosWidgetTimesheetTableAsDetailed(n),this.toggleAddRowsForm=this.internalWidget.toggleAddRowsForm.bind(this.internalWidget),this.toggleSearchForm=this.internalWidget.toggleSearchForm.bind(this.internalWidget),this.showAddRowsForm=this.internalWidget.showAddRowsForm.bind(this.internalWidget),this.showSearchForm=this.internalWidget.showSearchForm.bind(this.internalWidget),this.addRows=this.internalWidget.addRows.bind(this.internalWidget),this.returnDocument=this.internalWidget.returnDocument.bind(this.internalWidget),this.checkSelected=this.internalWidget.checkSelected.bind(this.internalWidget),this.hasChanges=this.internalWidget.hasChanges.bind(this.internalWidget),this.getChangeMessage=this.internalWidget.getChangeMessage.bind(this.internalWidget),this.refresh=this.internalWidget.refresh.bind(this.internalWidget),this.processErrors=this.internalWidget.processErrors.bind(this.internalWidget),this.delUnload=this.internalWidget.delUnload.bind(this.internalWidget),this.destroy=this.internalWidget.destroy.bind(this.internalWidget)),this.options.timesheetType==="manager"&&(this.internalWidget=new ZelosWidgetTimesheetTableAsDetailed(n),this.toggleAddRowsForm=this.internalWidget.toggleAddRowsForm.bind(this.internalWidget),this.toggleSearchForm=this.internalWidget.toggleSearchForm.bind(this.internalWidget),this.showAddRowsForm=this.internalWidget.showAddRowsForm.bind(this.internalWidget),this.showSearchForm=this.internalWidget.showSearchForm.bind(this.internalWidget),this.addRows=this.internalWidget.addRows.bind(this.internalWidget),this.returnDocument=this.internalWidget.returnDocument.bind(this.internalWidget),this.checkSelected=this.internalWidget.checkSelected.bind(this.internalWidget),this.hasChanges=this.internalWidget.hasChanges.bind(this.internalWidget),this.getChangeMessage=this.internalWidget.getChangeMessage.bind(this.internalWidget),this.refresh=this.internalWidget.refresh.bind(this.internalWidget),this.processErrors=this.internalWidget.processErrors.bind(this.internalWidget),this.delUnload=this.internalWidget.delUnload.bind(this.internalWidget),this.destroy=this.internalWidget.destroy.bind(this.internalWidget),this.options.zelosProcessor.options.filterFromDate&&(this.options.filterFromDate=this.options.zelosProcessor.options.filterFromDate),this.options.zelosProcessor.options.filterToDate&&(this.options.filterToDate=this.options.zelosProcessor.options.filterToDate)),this.options.timesheetType==="mileage"&&(this.internalWidget=new ZelosWidgetTimesheetTableAsMileage(n),this.toggleAddRowsForm=this.internalWidget.toggleAddRowsForm.bind(this.internalWidget),this.toggleSearchForm=this.internalWidget.toggleSearchForm.bind(this.internalWidget),this.showAddRowsForm=this.internalWidget.showAddRowsForm.bind(this.internalWidget),this.showSearchForm=this.internalWidget.showSearchForm.bind(this.internalWidget),this.addRows=this.internalWidget.addRows.bind(this.internalWidget),this.returnDocument=this.internalWidget.returnDocument.bind(this.internalWidget),this.checkSelected=this.internalWidget.checkSelected.bind(this.internalWidget),this.hasChanges=this.internalWidget.hasChanges.bind(this.internalWidget),this.getChangeMessage=this.internalWidget.getChangeMessage.bind(this.internalWidget),this.refresh=this.internalWidget.refresh.bind(this.internalWidget),this.processErrors=this.internalWidget.processErrors.bind(this.internalWidget),this.delUnload=this.internalWidget.delUnload.bind(this.internalWidget),this.destroy=this.internalWidget.destroy.bind(this.internalWidget)),this.options.timesheetType==="managerMileage"&&(this.internalWidget=new ZelosWidgetTimesheetTableAsMileage(n),this.toggleAddRowsForm=this.internalWidget.toggleAddRowsForm.bind(this.internalWidget),this.toggleSearchForm=this.internalWidget.toggleSearchForm.bind(this.internalWidget),this.showAddRowsForm=this.internalWidget.showAddRowsForm.bind(this.internalWidget),this.showSearchForm=this.internalWidget.showSearchForm.bind(this.internalWidget),this.addRows=this.internalWidget.addRows.bind(this.internalWidget),this.returnDocument=this.internalWidget.returnDocument.bind(this.internalWidget),this.checkSelected=this.internalWidget.checkSelected.bind(this.internalWidget),this.hasChanges=this.internalWidget.hasChanges.bind(this.internalWidget),this.getChangeMessage=this.internalWidget.getChangeMessage.bind(this.internalWidget),this.refresh=this.internalWidget.refresh.bind(this.internalWidget),this.processErrors=this.internalWidget.processErrors.bind(this.internalWidget),this.delUnload=this.internalWidget.delUnload.bind(this.internalWidget),this.destroy=this.internalWidget.destroy.bind(this.internalWidget),this.options.zelosProcessor.options.filterFromDate&&(this.options.filterFromDate=this.options.zelosProcessor.options.filterFromDate),this.options.zelosProcessor.options.filterToDate&&(this.options.filterToDate=this.options.zelosProcessor.options.filterToDate)),this.options.timesheetType==="employeeMilaege"&&(this.internalWidget=new ZelosWidgetTimesheetTableAsMileage(n),this.toggleAddRowsForm=this.internalWidget.toggleAddRowsForm.bind(this.internalWidget),this.toggleSearchForm=this.internalWidget.toggleSearchForm.bind(this.internalWidget),this.showAddRowsForm=this.internalWidget.showAddRowsForm.bind(this.internalWidget),this.showSearchForm=this.internalWidget.showSearchForm.bind(this.internalWidget),this.addRows=this.internalWidget.addRows.bind(this.internalWidget),this.returnDocument=this.internalWidget.returnDocument.bind(this.internalWidget),this.checkSelected=this.internalWidget.checkSelected.bind(this.internalWidget),this.hasChanges=this.internalWidget.hasChanges.bind(this.internalWidget),this.getChangeMessage=this.internalWidget.getChangeMessage.bind(this.internalWidget),this.refresh=this.internalWidget.refresh.bind(this.internalWidget),this.processErrors=this.internalWidget.processErrors.bind(this.internalWidget),this.delUnload=this.internalWidget.delUnload.bind(this.internalWidget),this.destroy=this.internalWidget.destroy.bind(this.internalWidget))}}),Affinity.zelos||(Affinity.zelos={}),Affinity.zelos.Elements||(Affinity.zelos.Elements={}),Affinity.zelos.Elements.TimesheetTable=ZelosWidgetTimesheetTable,Affinity.zelos||(Affinity.zelos={}),Affinity.zelos.Widgets||(Affinity.zelos.Widgets=[]),Affinity.zelos.Widgets.push("TimesheetTable"),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetManagerDualdetailed={Version:"1.0.10.0",Sequence:10270,Name:"Timesheet Manager Dual Detailed (Zelos Widget)",File:"ui.zelos.widget.timesheets.manager.dualdetailed.js",Jira:"",Notes:"hide award pop on data change"},ZelosWidgetTimesheetManagerDualdetailed=new Class({debug:!1,Implements:[Options,Events],Binds:["setDetailsComplete","setMileageComplete","checkComplete","dateChanged","getTimesheets","getMilage","closeAwardModals","jumpToTimesheets","jumpToMileage","load","refresh","hasChanges","destroy"],options:{target:null,isManager:!0,isEmployee:!1,fromDate:!1,toDate:!1,startDate:!1},userProfile:!1,initted:!1,initialize:function(n){this.setOptions(n),Affinity.view="managerdualdetailed",Affinity.views.managerdualdetailed=this,this.container=new Element("div").inject(this.options.target),this.container.addClass("widget"),this.container.store("widget",this),this.isManager=this.options.isManager,this.isEmployee=this.options.isEmployee,this.fromDate=this.options.fromDate,this.toDate=this.options.toDate,this.startDate=this.options.startDate?this.options.startDate:this.options.fromDate,this.userProfile=this.options.profile||!1,Affinity.viewSettings.filter.get("employee")&&(this.startEmployee=Affinity.viewSettings.filter.get("employee"),this.fromDate=Affinity.viewSettings.filter.get("fromDate").clone(),this.toDate=Affinity.viewSettings.filter.get("toDate").clone(),this.startDate=Affinity.viewSettings.filter.get("fromDate").clone()),this.tsDetailBox=new Element("div",{"class":"ts-detailed-section",html:""}).inject(this.container),this.mlDetailBox=new Element("div",{"class":"ts-mileage-section",html:""}).inject(this.container),this.timesheetWidget=!1,this.mileageWidget=!1,Affinity.lookups&&Affinity.lookups.processNew({jsonp:!0}),this.initted=!0,this.load("Setting up Team view")},complete:!1,refreshing:!1,detailsComplete:!1,mileageComplete:!1,load:function(n){this.refreshing||(uialert({message:n,noClose:!0,showLoader:!0}),this.refreshing=!0,this.complete=!1,this.detailsComplete=!1,this.mileageComplete=!1,this.getTimesheets(),this.getMileage())},hidablesSet:!1,checkComplete:function(){var n,t;Affinity.prompts.center(),this.detailsComplete&&Affinity.prompts.hide(),this.detailsComplete&&this.mileageComplete&&(Affinity.viewSettings.reset(),Affinity.sectionHidables.processNew(),n=new Element("span",{"class":"title-link",html:"Jump to Timesheets"}).inject(this.mlDetailBox.getElement(".section-title")),n.addEvent(Affinity.events.click,this.jumpToTimesheets),t=new Element("span",{"class":"title-link",html:"Jump to Mileage"}).inject(this.tsDetailBox.getElement(".section-title")),t.addEvent(Affinity.events.click,this.jumpToMileage),this.fireEvent("complete"))},setDetailsComplete:function(){this.detailsComplete=!0,this.checkComplete()},setMileageComplete:function(){this.mileageComplete=!0,this.checkComplete()},ignoreDeclined:!1,getTimesheets:function(){var i=Affinity.languages.english.application.timesheets,n,f;if(this.detailsWidget&&(this.detailsWidget.removeEvents(),this.detailsWidget.destroy(),this.detailsWidget=!1,this.detailsComplete=!1),this.detailsLoader&&(this.detailsLoader.removeEvents(),this.detailsLoader.cancel(),this.detailsLoader=!1),this.detailsZelosProcessor&&(this.detailsZelosProcessor.removeEvents(),this.detailsZelosProcessor.cancel(),this.detailsZelosProcessor=!1),this.tsDetailBox){n="",n+='<div class="section shadow "><div class="section-body"><div class="section-row">',n+='Loading Timesheets <img src="'+Affinity.loaders.light+'" />',n+="<\/div><\/div><\/div>",this.tsDetailBox.set("html",n).removeClass("hidden");var r=Affinity.zelosroot+"?api="+(this.isManager?"timesheetAsManager":"timesheet")+"/getEmptyTimesheet",u=Affinity.zelosroot+"?api="+(this.isManager?"timesheetAsManager":"timesheet")+"/post",t=Affinity.zelosroot+"?api="+(this.isManager?"timesheetAsManager":"timesheet")+"/get&fromDate="+this.startDate.format("%d.%b.%Y")+"&toDate="+this.startDate.format("%d.%b.%Y"),e=this.isManager?"manager":"employeeDetails";t+="&view=daydetail",t+="&page=0",t+="&pageSize=10",this.isManager&&(t+="&timesheetStatus=Submitted,Approved,Declined,Paid",(this.userProfile.employeeNumber+"").trim()+""===(Affinity.login.profile.employeeNumber+"").trim()&&(r=r.replace("timesheetAsManager","timesheet"),u=u.replace("timesheetAsManager","timesheet"),t=t.replace("timesheetAsManager","timesheet"),e="employeeDetails"),this.startEmployee&&(t+="&employeeNo="+this.startEmployee)),r=r.replace("??","?"),t=t.replace("??","?"),u=u.replace("??","?"),f={target:this.tsDetailBox,getApi:t,putApi:u,getEmptyTimesheetApi:r,timesheetType:e,isManager:this.isManager,fromDate:this.startDate,toDate:this.startDate,profile:this.userProfile,insertAddTimesheetForm:!0,paginate:!0,isDual:!1,isMileageDual:!0,onSaveError:function(n){console.log(n)},beforSave:function(n){var u,f;if(n.button){if(u=!1,n.button.getParent(".default-form")&&n.button.getParent(".default-form").getElement("#ForwardTo")&&(u=!0,n.button.getParent(".default-form").getElement("#ForwardTo").value===""||n.button.getParent(".default-form").getElement("#ForwardTo").value==="0"))return uialert({message:Affinity.languages.english.generic.selectForward,noClose:!1,showButtons:!0,showLoader:!1}),!1;if(u)f=this.detailsWidget.cleanFavData(t),window.uialert({message:i.globals.forwardingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0});else{var t=!1,e=!1,r=n.button;if(r.hasClass("orange")&&window.uialert({message:i.globals.savingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),r.hasClass("green")&&(window.uialert({message:i.globals.submittingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),t="submit"),r.hasClass("grey")&&(window.uialert({message:i.globals.decliningSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),t="decline"),t){if(e=this.detailsWidget.reduceBulkRows(t,this.ignoreDeclined),this.ignoreDeclined=!1,!e)return Affinity.UI.___tempCallback=function(n){this.ignoreDeclined=n.ignoreDeclined,window.removeEvent("__tempCallback",Affinity.UI.___tempCallback),Affinity.UI.___tempCallback=null,delete Affinity.UI.___tempCallback,this.detailsZelosProcessor.submit({target:r})}.bind(this),window.addEvent("__tempCallback",Affinity.UI.___tempCallback),!1}else f=this.detailsWidget.cleanFavData(t),window.uialert({message:i.globals.processingSelected+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0})}}return!0}.bind(this),onSave:function(){}.bind(this),onComplete:function(){}.bind(this)},this.detailsZelosProcessor=new ZelosTemplateProcess(f),this.detailsLoader=new ZelosTemplateLoad({onRequest:function(){},onError:function(t){n="",n+='<div class="section shadow "><div class="section-body"><div class="section-row">',n+="There was an error retrieving your timesheets.<!--"+t+"-->",n+="<\/div><\/div><\/div>",this.tsDetailBox.set("html",n),Affinity.prompts.hide()}.bind(this),onComplete:function(n){var t,i,r;this.tsDetailBox.empty().removeClass("hidden"),this.detailsZelosProcessor.processTemplate(n),this.detailsWidget=this.tsDetailBox.getElement(".widget.timesheettable").getWidget().internalWidget,this.detailsWidget.aaa="I am detail view - timesheets",this.tsDetailBox.getElement(".section-title").set("html","Timesheets"),this.detailsWidget.addEvent("processComplete",function(){var n=this.detailsWidget.returnMessagesArray();this.complete&&this.mileageWidget&&"refresh"in this.mileageWidget&&(this.complete=!1,this.mileageComplete=!1,this.mileageWidget.removeEvent("newRowsLoaded",this.setMileageComplete),this.mileageWidget.addEvent("newRowsLoaded",this.setMileageComplete),this.mileageWidget.refresh()),this.detailsComplete||(this.detailsComplete=!0,this.checkComplete())}.bind(this)),t=this.tsDetailBox.getElements(".section.shadow"),t.length>0&&(i=t[t.length-1],r=t[0],i.getElement(".section-body").inject(r.getElement(".section-body"),"after"),i.addClass("hidden"))}.bind(this)}).loadTemplate(f.getApi)}else uialert({message:Affinity.languages.english.generic.error+"<br />Please refresh the page and try again.",canClose:!0,showButtons:!0,showLoader:!1})},getMileage:function(){var i=Affinity.languages.english.application.timesheets,n,f;if(this.mileageWidget&&(this.mileageWidget.removeEvents(),this.mileageWidget.destroy(),this.mileageComplete=!1,this.mileageWidget=!1),this.mileageLoader&&(this.mileageLoader.removeEvents(),this.mileageLoader.cancel(),this.mileageLoader=!1),this.mileageZelosProcessor&&(this.mileageZelosProcessor.removeEvents(),this.mileageZelosProcessor.cancel(),this.mileageZelosProcessor=!1),this.mlDetailBox){n="",n+='<div class="section shadow "><div class="section-body"><div class="section-row">',n+='Loading Timesheets <img src="'+Affinity.loaders.light+'" />',n+="<\/div><\/div><\/div>",this.mlDetailBox.set("html",n).removeClass("hidden");var r=Affinity.zelosroot+"?api=mileage/GetEmptyMileage",u=Affinity.zelosroot+"?api=mileage/post",t=Affinity.zelosroot+"?api=mileage/get&fromDate="+this.startDate.format("%d.%b.%Y")+"&toDate="+this.startDate.format("%d.%b.%Y"),e=this.isManager?"managerMileage":"employeeMilaege";t+="&view=daydetail",t+="&page=0",t+="&pageSize=10",this.isManager&&(t=t.replace("get","GetAsManager"),u=u.replace("post","PostAsManager"),t+="&timesheetStatus=Submitted,Approved,Declined,Paid",r=r.replace("GetEmptyMileage","GetEmptyMileageAsManager"),this.startEmployee&&(t+="&employeeNo="+this.startEmployee)),r=r.replace("??","?"),t=t.replace("??","?"),u=u.replace("??","?"),f={target:this.mlDetailBox,getApi:t,putApi:u,getEmptyTimesheetApi:r,timesheetType:e,isManager:this.isManager,fromDate:this.startDate,toDate:this.startDate,profile:this.userProfile,insertAddTimesheetForm:!0,paginate:!0,isDual:!1,isMileageDual:!0,onSaveError:function(n){console.log(n)},beforSave:function(n){var u,f;if(n.button){if(u=!1,n.button.getParent(".default-form")&&n.button.getParent(".default-form").getElement("#ForwardTo")&&(u=!0,n.button.getParent(".default-form").getElement("#ForwardTo").value===""||n.button.getParent(".default-form").getElement("#ForwardTo").value==="0"))return uialert({message:Affinity.languages.english.generic.selectForward,noClose:!1,showButtons:!0,showLoader:!1}),!1;if(u)f=this.mileageWidget.cleanFavData(t),window.uialert({message:i.globals.forwardingSelectedMileage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0});else{var t=!1,e=!1,r=n.button;if(r.hasClass("orange")&&window.uialert({message:i.globals.savingSelectedMileage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),r.hasClass("green")&&(window.uialert({message:i.globals.submittingSelectedMileage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),t="submit"),r.hasClass("grey")&&(window.uialert({message:i.globals.decliningSelectedMileage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),t="decline"),t){if(e=this.mileageWidget.reduceBulkRows(t,this.ignoreDeclined),this.ignoreDeclined=!1,!e)return Affinity.UI.___tempCallback=function(n){this.ignoreDeclined=n.ignoreDeclined,window.removeEvent("__tempCallback",Affinity.UI.___tempCallback),Affinity.UI.___tempCallback=null,delete Affinity.UI.___tempCallback,this.detailsZelosProcessor.submit({target:r})}.bind(this),window.addEvent("__tempCallback",Affinity.UI.___tempCallback),!1}else f=this.mileageWidget.cleanFavData(t),window.uialert({message:i.globals.processingSelectedMileage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0})}}return!0}.bind(this),onSave:function(){}.bind(this),onComplete:function(){}.bind(this)},this.mileageZelosProcessor=new ZelosTemplateProcess(f),this.mileageLoader=new ZelosTemplateLoad({onRequest:function(){},onError:function(t){n="",n+='<div class="section shadow "><div class="section-body"><div class="section-row">',n+="There was an error retrieving your mileage timesheets.<!--"+t+"-->",n+="<\/div><\/div><\/div>",this.mlDetailBox.set("html",n),Affinity.prompts.hide()}.bind(this),onComplete:function(n){var t,i,r;this.mlDetailBox.empty().removeClass("hidden"),this.mileageZelosProcessor.processTemplate(n),this.mileageWidget=this.mlDetailBox.getElement(".widget.timesheettable").getWidget().internalWidget,this.mileageWidget.aaa="I am detail view - timesheets",this.mlDetailBox.getElement(".section-title").set("html","Mileage"),this.mileageWidget.addEvent("processComplete",function(){var n=this.mileageWidget.returnMessagesArray();this.complete&&this.detailsWidget&&"refresh"in this.detailsWidget&&(this.complete=!1,this.detailsComplete=!1,this.detailsWidget.removeEvent("newRowsLoaded",this.setAwardsComplete),this.detailsWidget.addEvent("newRowsLoaded",this.setAwardsComplete),this.detailsWidget.refresh()),this.mileageComplete||(this.mileageComplete=!0,this.checkComplete())}.bind(this)),t=this.mlDetailBox.getElements(".section.shadow"),t.length>0&&(i=t[t.length-1],r=t[0],i.getElement(".section-body").inject(r.getElement(".section-body"),"after"),i.addClass("hidden"))}.bind(this)}).loadTemplate(f.getApi)}else uialert({message:"oops! Something went wrong.<br />Please refresh the page and try again.",canClose:!0,showButtons:!0,showLoader:!1})},jumpToTimesheets:function(){Affinity.AwardModels.closeAll(),Affinity.sectionHidables.showSectionBySwitcher(this.tsDetailBox.getElement(".section-switch"))},jumpToMileage:function(){Affinity.AwardModels.closeAll(),Affinity.sectionHidables.showSectionBySwitcher(this.mlDetailBox.getElement(".section-switch"))},refresh:function(){var n,t,i;this.refreshing||(Affinity.AwardModels.closeAll(),log("&#171; refresh manager dual detail view &#187;"),n="Refreshing",uialert({message:n,noClose:!0,showLoader:!0}),this.refreshing=!0,this.detailsWidget&&"refresh"in this.detailsWidget?(this.detailsWidget.showAlerts=!1,this.detailsComplete=!1,this.detailsWidget.removeEvent("newRowsLoaded",this.setDetailsComplete),this.detailsWidget.addEvent("newRowsLoaded",this.setDetailsComplete),t=this.detailsWidget.setDates(this.startDate,this.startDate),t&&this.detailsWidget.refresh()):this.getTimesheets(),this.mileageWidget&&"refresh"in this.mileageWidget?(this.mileageWidget.showAlerts=!1,this.mileageComplete=!1,this.mileageWidget.removeEvent("newRowsLoaded",this.setMileageComplete),this.mileageWidget.addEvent("newRowsLoaded",this.setMileageComplete),i=this.awardsWidget.setDates(this.startDate,this.startDate),i&&this.mileageWidget.refresh()):this.getMileage())},hasChanges:function(){return!1},destroy:function(){this.detailsLoader&&(this.detailsLoader.removeEvents(),this.detailsLoader.cancel()),this.detailsZelosProcessor&&(this.detailsZelosProcessor.removeEvents(),this.detailsZelosProcessor.cancel()),this.detailsWidget&&(this.detailsWidget.removeEvents(),this.detailsWidget.destroy()),this.mileageLoader&&(this.mileageLoader.removeEvents(),this.mileageLoader.cancel()),this.mileageZelosProcessor&&(this.mileageZelosProcessor.removeEvents(),this.mileageZelosProcessor.cancel()),this.mileageWidget&&(this.mileageWidget.removeEvents(),this.mileageWidget.destroy()),this.container&&("eliminate"in this.container&&this.container.eliminate("widget"),this.container.removeEvents(),this.container.destroy()),this.removeEvents(),Affinity.views.managerdualdetailed=null,delete Affinity.views.managerdualdetailed,Object.each(this,function(n,t){this[t]=null,delete this[t]}.bind(this))}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetTableAsMileage={Version:"1.0.26.0",Sequence:10240,Name:"Timesheet Table As Mileage (Zelos Widget)",File:"ui.zelos.widget.timesheets.mileage.js",Jira:"",Notes:"test check exists before tick"},ZelosWidgetTimesheetTableAsMileage=new Class({debug:!1,setMissingDefaultAsReadOnly:!1,Implements:[Options,Events],Binds:["isViewActive","globalElementChangeHandler","checkKeyboardShortcut","beforeClose","renderCheck","processUI","continueProcessUI","processDocument","selectAllRows","cleanFavData","reduceBulkRows","showAwards","subMenuOver","subMenuOut","showButtons","hideButtons","editFormButtonClicked","buttonClicked","buttonClickedContinue","returnSecondaryAddButton","secondaryAdd","addRows","selectFav","promptFavName","showFavSelect","saveFav","openSelectEmployee","toggleAddRowsForm","toggleAddRowsFormCont","showAddRowsForm","hideAddRowsForm","toggleSearchForm","showSearchForm","hideSearchForm","adjustFilterDates","doSearch","getNextPage","getPreviousPage","getPage","hasRowChanged","checkColumnMisssAligned","loadNewRows","returnNewRow","buildTableRow","forceRowReadOnly","getAttributes","getTimesheetType","mobileSelect","popupEditForm","duplicateTimesheet","setDates","setEmployee","refresh","destroy","delUnload","showMobilePopupEditor","updateRow","setupCorrectInfoColorForForwardedRowInMobileMode"],options:{parentForm:null,timesheetType:"employeeMilaege",parentDocument:null,parentSectionIndex:null,parentChildIndex:null,widgetDocument:null,putApi:null,getEmptyTimesheetApi:"",target:null,zelosProcessor:null,insertAddForm:!0,isManager:!1,isEmployee:!1,fromDate:!1,toDate:!1,readOnly:!1,paginate:!0,subType:"not-sub-type",isDual:!1,isAllowanceGrid:!1,profile:!1},uuid:"none yet",aaa:"none yet",ribbonDate:!1,ribbonEmpNo:!1,showAlerts:!0,enableFormEdit:!1,showPeriodButtonsInFilter:!1,showAllUnapproved:!1,messageBucket:[],viewName:"",initialize:function(n){var v,e,o,y,p,s,w,k,d,h,c,l,u,t,f,it,a,i,b,r;if(this.setOptions(n),this.uuid=String.uniqueID(),this.getApi=this.options.zelosProcessor.options.getApi+"",this.isManagerView=this.options.isManager&&this.options.timesheetType.toLowerCase().contains("manager"),this.isManagerView&&(this.showAllUnapproved=Affinity.ShowManagerAllUnapproved==="*"?!0:Affinity.ShowManagerAllUnapproved.split(",").contains(Affinity.login.profile.companyNumber)?!0:!1),this.options.isDual?(v=this.options.subType,e="",this.isManagerView&&(v+="-manager"),e=v.ToCamelCase(),Affinity.views[e]=this,this.viewName=e):this.isManagerView?(Affinity.views.managerMileage=this,this.viewName="managerMileage"):(Affinity.views.mileage=this,this.viewName="mileage"),this.userData=this.options.profile||Affinity.login.profile,this.options.profile&&Affinity.login.profile.employeeNumber!==this.options.profile.employeeNumber&&(this.currentSearchEmployee=this.userData.employeeNumber),this.zelosProcessor=this.options.zelosProcessor,Affinity.apiversion>1?(this.loadTimesheetsFrom=this.userData.payPeriods.currentBegins.clone(),this.loadTimesheetsTo=this.userData.payPeriods.currentEnds.clone()):(o=Affinity.appname,this.userData=JSON.decode(Affinity.CookieMonster.Read(o+"User")),y=JSON.decode(Affinity.CookieMonster.Read(o+"Values")),this.loadTimesheetsFrom=Date.parse(y.ShowTimesheetFrom),this.loadTimesheetsTo=Date.parse(y.NewestTimesheetDate)),this.options.fromDate&&this.options.toDate&&(this.loadTimesheetsFrom=this.options.fromDate.clone(),this.loadTimesheetsTo=this.options.toDate.clone()),this.showAllUnapproved&&(this.loadTimesheetsFrom=Affinity.login.profile.oldestTimesheetDate,this.loadTimesheetsTo=Affinity.login.profile.newestTimesheetDate),p=[["loadTimesheetsFrom","show timesheet from","ShowTimesheetFrom"],["loadTimesheetsTo","newest timesheet","NewestTimesheetDate"]],Array.each(p,function(n){typeOf(this[n[0]])==="date"&&(typeOf(this[n[0]])!=="date"||this[n[0]].isValid())||(this[n[0]]=!1)}.bind(this)),s="",Array.each(p,function(n){this[n[0]]||(s+=n[1]+" date ("+n[2]+") is missing or invalid\r\n")}.bind(this)),s!==""){w={},w.message="You do not have access to view this screen.<br />Please contact your administrator for assistance.<!--\r\n"+s+"-->",window.fireEvent("logout",w);return}if(window.addEvent("processorDocumentSaved",function(n){n.processorId==this.zelosProcessor.processorId&&this.refresh()}.bind(this)),window.addEvent("processorDocumentError",function(n){n.processorId==this.zelosProcessor.processorId&&this.processErrors(n.document,!0)}.bind(this)),this.parentSection=this.options.parentDocument.Children[this.options.parentSectionIndex],this.baseLang=Affinity.languages.english.features,this.baseAppLang=Affinity.languages.english.application.timesheets.features,this.icons={},this.icons.edit=Affinity.icons.Pencil,this.icons.save=Affinity.icons.Save,this.icons.view=Affinity.icons.Page,this.icons.del=Affinity.icons.CrossRound,this.icons.add=Affinity.icons.PlusRound,this.icons.cancel=Affinity.icons.Cancel,this.icons.approve=Affinity.icons.ThumbsUp,this.icons.decline=Affinity.icons.ThumbsDown,this.icons.search=Affinity.icons.Search,this.icons.duplicate=Affinity.icons.Docs,this.icons.list=Affinity.icons.List,this.icons.addrow=Affinity.icons.AddToList,this.icons.allowance=Affinity.icons.Gift,this.icons.award=Affinity.icons.Gift,this.icons.fav=this.baseLang.favourites.icon,this.icons.help=this.baseLang.help.icon,this.icons.dotsVert=Affinity.icons.DotsVert,this.zelosProcessor=this.options.zelosProcessor,this.table=new Element("table").inject(this.options.target),k=new Element("thead").inject(this.table),this.thead=new Element("tr").inject(k),this.tbody=new Element("tbody").inject(this.table),d=new Element("tfoot").inject(this.table),this.tfoot=new Element("tr").inject(d),this.table.addClass("detailed mileage"),h=new Element("div",{"class":"section-table"}).wraps(this.table),this.options.insertAddForm){if(this.searchFormTarget=new Element("div").inject(this.options.target,"top"),this.searchFormButton=new Element("span",{"class":"button blue w-icon showSearch",html:"<span>"+this.icons.search+"<\/span>Search"}),this.searchFormButton.set("reveal",{duration:300,display:"inline-block"}),c=new Element("input",{type:"text"}),l=new Element("input",{type:"text"}),this.searchForm=new Element("div",{"class":"default-form w-border timesheetSearchFrom"}),this.searchEmployee=!1,this.isManagerView&&(this.searchEmployee=new Element("select",{"class":"has-lookup","data-lookup-api":Affinity.zelosroot+"?api=timesheetAsManager/getEmployees"}),this.options.isDual&&this.searchEmployee.set("data-lookup-rules","hasValue"),this.searchEmployeeRow=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search Employee"}),this.searchEmployee),this.searchForm.adopt(this.searchEmployeeRow)),this.searchPayPoint=!1,this.searchEmployeeGroups=!1,this.searchPayPoint=!1,this.searchScreenFilters=!1,this.isManagerView){if(u=!1,Affinity.apiversion>1)try{u=Affinity.login.profile.screenFilters}catch(w){}else try{u=JSON.decode(Affinity.CookieMonster.Read(o+"ScreenFilters"))}catch(w){}u&&typeOf(u)==="array"&&u.length>0?(this.searchScreenFilters=[],Array.each(u,function(n){"Data"in n?(t=new Element("select"),Array.each(n.Data,function(n){new Element("option",{value:n.Key,html:n.Value}).inject(t)}.bind(this)),f=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:n.Label}),t),f.inject(this.searchForm),new UIAutoCompleteWidget({selectElement:t}),n.FieldName==="PayPoint"?(this.searchPayPointRow=f,this.searchPayPoint=t):n.FieldName==="EssGroup"?(this.searchEmployeeGroupsRow=f,this.searchEmployeeGroups=t):this.searchScreenFilters.push(t)):(t=new Element("select"),t.addClass("has-lookup"),t.set("data-field-name",n.FieldName),t.set("data-label",n.Label),t.set("data-lookup-api",Affinity.lookupapi+"?ModelName="+n.ModelName+"&PropertyName="+n.FieldName),this.searchScreenFilters.push(t),f=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Filter By "+n.Label.replace(/ /gi,"&nbsp;")}),t).inject(this.searchForm))}.bind(this))):(this.searchScreenFilters=new Element("input",{type:"hidden",value:""}),this.searchForm.adopt(this.searchScreenFilters))}if(this.showPeriodButtonsInFilter){var g=new Element("span",{"class":"button w-icon blue filter-last-period",html:'<span class="icon-arrow-left"><\/span>Last'}),nt=new Element("span",{"class":"button w-icon blue filter-current-period",html:'<span class="icon-calendar"><\/span>Current'}),tt=new Element("span",{"class":"button w-icon blue filter-next-period",html:'<span class="icon-arrow-right"><\/span>Next'});this.searchForm.adopt(new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search From"}),c),new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search To"}),l),new Element("div",{"class":"form-row"}).adopt(new Element("div",{"class":"sub-text",html:"Set dates to Pay Periods."}),new Element("br"),new Element("label"),new Element("div",{style:"display:inline-block"}).adopt(g,new Element("span",{html:"&nbsp;"}),nt,new Element("span",{html:"&nbsp;"}),tt),new Element("br"),new Element("div",{"class":"sub-text",html:"Leave 'Search To' blank if you wish to search only one day."}))),g.addEvent(Affinity.events.click,this.adjustFilterDates),nt.addEvent(Affinity.events.click,this.adjustFilterDates),tt.addEvent(Affinity.events.click,this.adjustFilterDates)}else this.searchForm.adopt(new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search From"}),c),new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Search To"}),l,new Element("br"),new Element("div",{"class":"sub-text",html:"Leave 'Search To' blank if you wish to search only one day."})));this.searchFrom=new UIDateTimeWidget({target:c,postId:"searchFrom",startDate:this.loadTimesheetsFrom,showCalendarFilterButtonsForMobile:Affinity.mobile}),this.searchTo=new UIDateTimeWidget({target:l,postId:"searchTo",startDate:this.loadTimesheetsTo,showCalendarFilterButtonsForMobile:Affinity.mobile}),this.searchStatus=!1,this.isManagerView&&(this.supportedStatus=["Submitted","Declined","Approved","Paid"],it=new Element("div"),this.searchStatus=new Element("div",{"class":"form-row wide search-status"}).adopt(new Element("label",{html:"Filter by Status"})),a=0,Array.each(this.supportedStatus,function(n){i="",n==="Submitted"?i="checked":this.showAllUnapproved&&(i=""),(this.options.timesheetType=="managerMileage"&&n!=="Pending"||this.options.timesheetType!=="manager")&&(a!==0&&a%3==0&&(new Element("br").inject(this.searchStatus),new Element("div",{"class":"labelplaceholder"}).inject(this.searchStatus)),new Element("div",{"class":"check-label-pair"}).adopt(new Element("input",{type:"checkbox",id:"searchStatusCheck-m-"+n,"class":"searchStatusCheck-m-"+n,name:"searchStatusCheck-m-"+n,checked:i}).addEvent(Affinity.events.click,function(){document.getElement(".select-all-status-m")&&(document.getElement(".select-all-status-m").checked=!1)}.bind(this)),new Element("label",{"class":"right",html:n,"for":"searchStatusCheck-m-"+n})).inject(this.searchStatus),a++)}.bind(this)),this.searchForm.adopt(this.searchStatus),new Element("div",{"class":"form-row wide"}).adopt(new Element("label",{html:""}),new Element("div",{"class":"check-label-pair"}).adopt(new Element("input",{type:"checkbox",id:"select-all-status-m","class":"select-all-status-m",name:"select-all-status-m"}).addEvent("click",function(n){var t=this.searchStatus.getElements('input[type="checkbox"]');Array.each(t,function(t){t.checked=n.target.checked}),t.length>0&&(t[0].checked=!0)}.bind(this)),new Element("label",{"class":"right",html:"Select All","for":"select-all-status-m"}))).inject(this.searchForm)),this.immutibleFilter=!1,this.managedFilter=!1,b=this.options.zelosProcessor.options.getApi.test(new RegExp("dont_return_managed","gi"))?!1:!0,this.isManagerView&&(i="checked",this.immutibleFilter=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Exclude Locked"}),new Element("div",{"class":"check-label-pair"}).adopt(new Element("input",{type:"checkbox","class":"searchExcludeLockedCheck-m",name:"searchFilterImmutible-m",checked:i}))).inject(this.searchForm),i=b?"":"checked",this.managedFilter=new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"My Timesheets to Action"}),new Element("div",{"class":"check-label-pair"}).adopt(new Element("input",{type:"checkbox","class":"searchMangedOnlyCheck-m",name:"searchFilterMangedOnly-m",checked:i}))).inject(this.searchForm)),this.searchForm.adopt(new Element("br"),new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"","class":"mobile-no-display"}),new Element("span",{"class":"button blue w-icon",html:"<span>"+this.icons.add+"<\/span>Search"}).addEvent(Affinity.events.click,this.doSearch),new Element("span",{html:"&nbsp;"}),new Element("span",{"class":"button grey w-icon",html:"<span>"+this.icons.cancel+"<\/span>Cancel"}).addEvent(Affinity.events.click,this.hideSearchForm))),this.searchForm.set("reveal",{duration:300}),this.searchForm.toggle(),this.searchFormButton.addEvent(Affinity.events.click,this.showSearchForm),new Element("div",{"class":"form-row searchboxthinger"}).adopt(this.searchForm,this.searchFormButton).inject(h,"before"),r=[],r.push("Date From "+Date.parse(this.options.fromDate).format("%d/%m/%Y")),r.push("Date To "+Date.parse(this.options.toDate).format("%d/%m/%Y")),this.options.timesheetType==="managerMileage"&&(r.push("Status Submitted"),r.push("Excluding Locked"),b||r.push("My timesheets to approve only")),this.filterStrBox=new Element("div",{"class":"filter-str",html:"Filtered By: "+r.join(", ")}).inject(h,"before"),r=null}this.options.paginate&&(this.paginationContainer=new Element("div",{"class":"pagination"}),this.paginationSection=new Element("div",{"class":"default-form frameless"}).adopt(new Element("div",{"class":"form-row"}).adopt(this.paginationContainer)).inject(h,"after")),this.currentFocus="null",window.addEvent("keyup",function(n){n.code===9&&(this.currentFocus=document.activeElement.get("id"))}.bind(this)),window.addEvent("lookupComplete",function(n){if(n&&n.get("id")&&n.get("id")==this.currentFocus&&(n.focus(),n.select(),this.currentFocus=document.activeElement.get("id"),n.hasClass("ui-autocomplete-display"))){var t=n.retrieve("widget");t.show("ts detailed on lookupComplete"),t=null}}.bind(this)),this.norows=new Element("div",{"class":"no-rows",html:"There are no mileage timesheets to show.&nbsp;&nbsp;",style:"padding: 10px;"}).inject(this.table,"before"),!Affinity.mobile&&this.options.parentForm&&(this.canKeyboardShortcut=!1,this.options.parentForm.addEvent(Affinity.events.overAll,function(){this.canKeyboardShortcut=!0}.bind(this)),this.options.parentForm.addEvent(Affinity.events.outAll,function(){this.canKeyboardShortcut=!1}.bind(this)),window.addEvent("keydown",this.checkKeyboardShortcut)),this.refresh(this.options.widgetDocument)},globalElementChangeHandler:function(n){this.doChangeChecks&&this.isViewActive()&&(this.hasRowChanged(n.target),this.hasChanges()?this.setUnload():this.delUnload())},isViewActive:function(){var n=!1,t=Affinity.timesheets.init.view,i=this.options.timesheetType;return(t==="employeeMilaege"||t==="managerMileage")&&(n=!0),n},checkKeyboardShortcut:function(n){if(this.canKeyboardShortcut&&n.control&&n.alt&&this.isViewActive()){n.stop();switch(n.key){case"n":case"N":this.secondaryAdd()}}},setUnload:function(){window.onbeforeunload=this.beforeClose},delUnload:function(){window.onbeforeunload=function(){}},beforeClose:function(){return"You have unsaved Timesheets."+(this.changedFieldsMessage!==""?"\n\n"+this.changedFieldsMessage:"")},hasRows:!1,setNoRows:function(){this.norows.removeClass("hidden"),this.table.addClass("hidden"),this.hasRows=!1},setHasRows:function(){this.norows.addClass("hidden"),this.table.removeClass("hidden"),this.hasRows=!0},setDates:function(n,t){var i=this.aaa;return typeOf(n)==="date"&&n.isValid()&&typeOf(t)==="date"&&t.isValid()&&(this.loadTimesheetsFrom=n.clone(),this.loadTimesheetsTo=t.clone(),this.options.isDual&&(this.options.fromDate=n.clone())),this.awardModal&&this.awardModal.close(),"from: "+n.toFriendlyShort()+", to: "+t.toFriendlyShort()},setEmployee:function(n){return this.currentSearchEmployee=n,!0},setExisitngDocOnRefresh:function(n){this.destroyRows()&&(this.tbody.empty(),typeOf(this.options.widgetDocument.Children)=="array"&&this.options.widgetDocument.Children.length>0?this.setHasRows():(this.setNoRows(),this.tbody.getParent(".inline-awards")||(this.secondaryAddButton||this.returnSecondaryAddButton(),this.secondaryButtonWrapper.inject(this.norows))),this.processDocument(n))},filterFromRefresh:!1,refresh:function(n,t){var o,u,r,s;if(this.isViewActive()){this.awardModal&&this.awardModal.close(),window.removeEvent("AnElementChanged",this.globalElementChangeHandler),window.removeEvent("AnElementRestored",this.globalElementChangeHandler),this.columnsCheck=[];var h=this.aaa,i,f=!1,e=!1;if(Affinity.viewSettings.employeeNumber&&Affinity.viewSettings.startDate&&(this.filterFromRefresh=!0,this.startDate=Affinity.viewSettings.startDate.clone(),this.startEmployee=Affinity.viewSettings.employeeNumber,uialert({message:o,showLoader:!0,noClose:!0}),this.showSearchForm(),e=Affinity.viewSettings.filterData.forceReload,i=Affinity.viewSettings.filterData,"employee"in i&&(i.emp=i.employee),f=!0),Affinity.timesheets.init.hasOwnProperty("affinityData")&&typeOf(Affinity.timesheets.init.affinityData)==="object"&&(this.filterFromRefresh=!0,o="Getting employee "+Affinity.timesheets.init.affinityData.emp+" for "+Affinity.timesheets.init.affinityData.fromdate.toFriendlyShort()+" to "+Affinity.timesheets.init.affinityData.todate.toFriendlyShort(),this.showSearchForm(),i=Affinity.timesheets.init.affinityData,i.employee=i.emp,i.fromDate=i.fromDate?i.fromDate:i.date,i.toDate=i.toDate?i.toDate:i.date,delete i.emp,delete i.date,f=!0),f){(function(){var t;this.searchEmployee&&"emp"in i&&(t=this.searchEmployee.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue(i.employee+"",!1)),this.searchPayPoint&&(t=this.searchPayPoint.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue(i.payPoint+"",!1)),this.searchEmployeeGroups&&(t=this.searchEmployeeGroups.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue("",!1)),this.searchScreenFilters&&Array.each(this.searchScreenFilters,function(n){t=n.retrieve("widget"),t&&typeOf(t)==="object"&&"setValue"in t&&t.setValue("",!1)}),this.searchStatus&&Array.each(this.searchStatus.getElements("input"),function(n){n.checked=!0}),"date"in i&&(this.searchFrom.setDate(i.date),this.searchTo.setDate(i.date)),"fromDate"in i&&"toDate"in i&&(this.searchFrom.setDate(i.fromDate),this.searchTo.setDate(i.toDate)),this.immutibleFilter&&"excludeLocked"in i&&this.immutibleFilter.getElement(".searchExcludeLockedCheck-d")&&(this.immutibleFilter.getElement(".searchExcludeLockedCheck-d").checked=i.excludeLocked),this.managedFilter&&"onlyManged"in i&&this.managedFilter.getElement(".searchMangedOnlyCheck-d")&&(this.managedFilter.getElement(".searchMangedOnlyCheck-d").checked=i.onlyManged),e?this.doSearch(""):typeOf(n)==="null"?this.doSearch(o):(this.setExisitngDocOnRefresh(n),this.doSearch("",!0)),this.options.isMileageDual||Affinity.viewSettings.reset(),Affinity.timesheets.init.affinityData=null,delete Affinity.timesheets.init.affinityData}).delay(1e3,this);return}typeOf(n)==="null"||e?(u=new URI(this.getApi),r=typeOf(u.parsed.query)==="null"?{}:u.parsed.query.parseQueryString(),r.fromDate=this.loadTimesheetsFrom.format("%d.%b.%Y"),r.toDate=this.loadTimesheetsTo.format("%d.%b.%Y"),this.isManagerView||(r.fromDate=this.searchFrom.getDateObject().format("%d.%b.%Y"),r.toDate=this.searchTo.getDateObject().format("%d.%b.%Y")),this.options.isDual&&(r.fromDate=this.options.fromDate.format("%d.%b.%Y"),r.toDate=this.options.fromDate.format("%d.%b.%Y")),!this.options.isDual&&this.filterQueryObject&&Object.merge(r,this.filterQueryObject),this.currentSearchEmployee&&(r.employeeNo=this.currentSearchEmployee),r.page=this.currentPage,r.view="detail",this.options.isDual&&(r.view="daydetail",this.filterQueryObject=r),u.parsed.query=Object.toQueryString(r),s=Affinity.GetCacheSafePath(u.toString()),this.loadNewRows(s,"Refresh",t)):this.setExisitngDocOnRefresh(n),this.fireEvent("refreshed")}},getMessages:function(n,t){var r=t||"",i=[];return n.Attribute&&(n.Attribute.Message&&i.push('<div class="yellow">'+r+n.Attribute.Message+"<\/div>"),n.Attribute.ErrorMessage&&i.push('<div class="red">'+r+n.Attribute.ErrorMessage+"<\/div>")),i},docMessages:[],returnMessagesArray:function(){return this.docMessages},messageIndent:"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",processDocument:function(n){var i,t,r;window.removeEvent("AnElementChanged",this.globalElementChangeHandler),window.removeEvent("AnElementRestored",this.globalElementChangeHandler),this.doChangeChecks=!1,this.readonly=this.options.widgetDocument.Attribute.IsReadOnly,t=this.readonly?"ui-grid ui-grid-sortable timesheet":"ui-grid timesheet",t=this.options.timesheetType==="employeeDetails"?t+" detailed":t,this.table.set("class",t),this.tbody.getElements("tr.timesheet-row").addClass("old"),this.docMessages=[],Array.each(this.getMessages(n),function(n){this.docMessages.push(n)}.bind(this)),r=0,Array.each(n.Children,function(n){i=this.returnNewRow(n),i&&(i.inject(this.tbody),r++)}.bind(this)),Array.each(this.tbody.getElements("tr.old"),this.destroyRow.bind(this)),this.processUI(),function(){window.addEvent("AnElementChanged",this.globalElementChangeHandler),window.addEvent("AnElementRestored",this.globalElementChangeHandler),this.fireEvent("processComplete")}.delay(1e3,this)},addRowsFormSatus:"closed",openSelectEmployee:function(n){uialert({message:"Select an employee",showButtons:!1});var i=n||"employeeMileage",t=this.addRowEmployeeSelect.clone();t.addClass("hidden"),Affinity.prompts.adopt(new Element("br"),new Element("br"),t,new Element("br"),new Element("br")),function(){t.removeClass("hidden");var n=new UIAutoCompleteWidget({stopInitialChange:!1,selectElement:t,onComplete:function(){prompts.center()},onElementChanged:function(n){var r=parseInt(n,10),e=t.get("id"),o=document.getElement("select#"+e.replace("-Display","")),u=!1,f;if(Array.each(t.getElements("option"),function(n){f=parseInt(n.get("value"),10),f===r&&(u=!0)}.bind(this)),u){if(uialert({message:"Getting empty Timesheet for "+t.value,showLoader:!0,showButtons:!1}),i==="managerMileage"||i==="employeeMileage")this.addRows(new Date,new Date,r);else if(i==="allowance")this.addRows(new Date,new Date,r,!1,!0);else{prompts.hide();throw"Can not add timesheet of unkown type ("+i+")";}Affinity.mobile&&(this.showMobilePopupEditor=!0)}else prompts.hide()}.bind(this)});window.onPromptClose=function(){t&&n&&n.destroy()}.bind(this)}.delay(250,this)},toggleAddRowsForm:function(){var i=this.options.timesheetType,n=!1,t;if(this.options.timesheetType==="managerMileage")if(typeOf(this.currentSearchEmployee)!=="null")if(this.currentSearchEmployee===!1)n=!0;else{this.addRows(new Date,new Date,this.currentSearchEmployee),Affinity.mobile&&(this.showMobilePopupEditor=!0);return}else n=!0;else{this.addRows(new Date),Affinity.mobile&&(this.showMobilePopupEditor=!0);return}n&&(this.addRowEmployeeSelect?this.openSelectEmployee(i):(uialert({message:"Getting Employee list",showLoader:!0,noClose:!0}),t=Affinity.zelosroot+"?api=timesheetAsManager/getEmployees",new Request.JSONP({url:t,callbackKey:"jsoncallback",method:"get",noCache:!0,onComplete:function(n){JSON.Unauthorized(n,'detailed, toggleAddRowsForm "get employees" - '+t)||(this.addRowEmployeeSelect=new Element("select",{"class":"ui-autocomplete ui-autocomplete-center ui-autocomplete-autowidth"}),this.options.isEmployee&&this.addRowEmployeeSelect.adopt(new Element("option",{html:Affinity.login.profile.commonName+" ("+Affinity.login.profile.employeeNumber+")",value:Affinity.login.profile.employeeNumber})),Array.each(n,function(n){n.Value!==""&&n.Key!==""&&n.Key!==this.defaultEmployeeNumber?this.addRowEmployeeSelect.adopt(new Element("option",{html:n.Value,value:n.Key})):n.Value.trim()===""&&n.Key.trim()===""?this.addRowEmployeeSelect.adopt(new Element("option",{html:"Select Employee",value:""})):this.addRowEmployeeSelect.adopt(new Element("option",{html:"[No Name for "+n.Key+"]",value:n.Key}))}.bind(this)),this.openSelectEmployee(i))}.bind(this),onError:function(){},onFailure:function(){}}).send()))},showAddRowsForm:function(){},hideAddRowsForm:function(){},searchFormSatus:"closed",toggleSearchForm:function(){this.awardModal&&this.awardModal.close(),this.searchFormSatus=="open"?this.hideSearchForm():this.searchFormSatus=="closed"&&this.showSearchForm()},showSearchForm:function(n){typeOf(n)!=="null"&&n.stopPropagation(),this.searchForm&&(this.searchFormButton.dissolve(),this.searchForm.reveal(),this.searchFormSatus="open")},hideSearchForm:function(n){typeOf(n)!=="null"&&n.stopPropagation(),this.searchForm&&(this.searchFormButton.reveal(),this.searchForm.dissolve(),this.searchFormSatus="closed")},sanatiseFromToDates:function(n,t){var i,r,u;return typeOf(n)=="string"?(i=Date.parse(n),i!=null&&i||(i=!1)):i=n,typeOf(t)=="string"?(r=Date.parse(t),t!=null&&t||(t=!1)):r=t,typeOf(i)!="date"||t||(r=i.clone()),typeOf(t)!="date"||n||(i=r.clone()),i&&r&&r<i&&(u=i.clone(),i=r.clone(),r=u,delete u),{fromDate:i,toDate:r}},returnSecondaryAddButton:function(){return this.secondaryButtonWrapper=new Element("span"),this.secondaryAddButton=new Element("div",{"class":"button blue w-icon footer-add",html:"<span>"+this.icons.addrow+"<\/span><span>Add<\/span>"}).inject(this.secondaryButtonWrapper),this.secondaryAddButton.addEvent(Affinity.events.click,this.secondaryAdd),Affinity.enableFavourites&&(new Element("span",{html:"&nbsp;"}).inject(this.secondaryButtonWrapper),this.addFromFavButton=new Element("div",{"class":"button blue w-icon-only add-fav footer-add ui-has-tooltip","data-tooltip":this.baseAppLang.favourites.views.mileage.createFromTooltip,"data-tooltip-dir":"top,left",html:"<span>"+this.icons.fav+"<\/span><span>"+this.baseAppLang.favourites.addButtonlabel+"<\/span>"}).inject(this.secondaryButtonWrapper),this.addFromFavButton.addEvent(Affinity.events.click,this.secondaryAdd)),this.secondaryButtonWrapper},secondaryAdd:function(n){var t=n?n.target.hasClass("button")?n.target:n.target.getParent(".button"):!1;if(t&&t.hasClass("add-fav")){this.selectFav(4);return}this.toggleAddRowsForm()},adding:!1,addRows:function(n,t,i,r,u,f){var e,h,c,a,l,s,v,o;if(!this.adding){if(this.loadRequest)try{this.loadRequest.cancel()}catch(y){}if(e=!1,e=this.currentSearchEmployee?this.currentSearchEmployee:e?e:Affinity.login.profile.employeeNumber,e=i||e,!e||e==""){uialert({message:Affinity.languages.english.generic.error+"<br />You are attempting to add a new entry without a Employee Number.",showButtons:!0,noClose:!1});return}if(h=this.tbody.getElements("tr.new"),c=Affinity.mobile?5:10,h.length>=c){e=h=c=null,uialert({message:"You must save your current timesheets before you can add any new ones.",showButtons:!0,noClose:!1});return}this.adding=!0,this.doChangeChecks=!1,l=this.sanatiseFromToDates(n,t),n=l.fromDate,t=l.toDate,this.options.isDual||n.clone().clearTime().getTime()!==t.clone().clearTime().getTime()||(t=t.increment("day",1)),n&&t?(o=this.options.getEmptyTimesheetApi,o+=e?"&employeeNo="+e:"",o+=r?"&timesheetId="+r:"",o+="&FromDate="+n.toZelos()+"&ToDate="+t.toZelos(),typeOf(u)==="boolean"&&u===!0&&(o=o.replace(new RegExp("getEmptyMileage","gi"),"GetEmptyAllowance")),typeof f=="string"&&f!==""&&(o+="&favouriteName="+f),function(){log('&#x2794; attempting detailed addRows "get empty mileage" ...'),this.loadRequest=new Request.JSON({url:o,method:"get",noCache:!0,onSuccess:function(n){if(!JSON.Unauthorized(n,"detailed, addRows - "+o)){if(n.error)log('&#x2718; attempted detailed addRows "get empty mileage" succeeded with errors - '+n.error),window.uialert({message:n.error+"<br />"+o});else{log('&#x2714; attempted detailed addRows "get empty mileage" succeeded');var t=0;this.options.widgetDocument.Children?t=this.options.widgetDocument.Children.length:this.options.widgetDocument.Children=[],this.setTableClass(),Array.each(n,function(n,t){for(t=n.Children.length-1;t>-1;t--)if(n.Children[t].Name.test("TsDate","gi")&&!n.Children[t].Attribute.IsReadOnly){n.Children[t].ElementType="FieldEdit";break}this.options.widgetDocument.Children.push(n),s=this.returnNewRow(n,!0),s&&s.inject(this.tbody)}.bind(this)),a=s?this.processUI(!0,s):this.processUI(!0),Affinity.prompts.hide()}this.adding=!1}}.bind(this),onError:function(n,t){log('&#x2718; attempted detailed addRows "get empty timesheets" failed with errors - '+t),window.uialert({message:t}),this.adding=!1}.bind(this),onFailure:function(n){log('&#x2718; attempted detailed addRows "get empty timesheets" failed - '+n.statusText),window.uialert({message:n.statusText}),this.adding=!1}.bind(this)}).get()}.delay(500,this)):(window.uialert({message:"From and To dates are invalid"}),this.adding=!1),l=e=s=v=h=c=null}},getSubstitutedName:function(n,t){var i=n.match(/-Row[0-9A-Za-z-]+[A-Z]-/)[0],r=i.substring(i.length-2),u="-Row"+i.substring(4,i.length-2)+r,f="-Row"+t+r;return n.replace(u,f)},awardModal:!1,showAwards:function(n){var i,t,f;if(!Affinity.isAwardsPopupEnabled())return!1;if(isNaN(n))if("target"in n)if(n.target.getParent("tr"))i=this.tableRows.indexOf(n.target.getParent("tr"));else return;else return;else i=n;var r=this.tableRows[i],u=[],e=r.querySelectorAll(".message-icon.info");e.length>0&&e.forEach(function(n){n.dataset.tooltip&&n.dataset.tooltip!==""&&(n.dataset.tooltip.contains(",")?n.dataset.tooltip.split(",").forEach(function(n){u.push(n)}):u.push(n.dataset.tooltip))}),t=r.getBoundingClientRect(),f={row:r,iconData:u,returnRowMethod:this.returnNewRow.bind(this),startPosition:{x:t.left+15,y:t.top+t.height-5}},this.awardModal?this.awardModal.set(f):this.awardModal=new ZelosAwardModal(f)},buttonClicked:function(n){var u,l,w,c,b,k,a,v,e,s,i,h,o;Affinity.tooltips.hideAll();var t=n.target.hasClass("button")?n.target:n.target.getParent(".button"),y=n.target.classList.contains("message-icon")?n.target:n.target.getParent(".message-icon"),p=t?t.retrieve("cfbutton")?t.retrieve("cfbutton"):t:!1;if(t=t?t:y?y:!1,!t)return!1;var f=t.getParent(".button-container")?document.id(t.getParent(".button-container").get("data-menu-id")):!1,r=t.getParent("tr")?t.getParent("tr"):t.get("data-row-ref")?this.table.getElement("tr#"+t.get("data-row-ref")):!1,u=r?this.tableRows.indexOf(r):!1;if(u===!1||u<0){uialert({message:"Could not identify Timesheet. Please refresh and try again.",showButtons:!0});return}if(u=r?this.tableRows.indexOf(r):!1,document.getElement(".button-menu-closer")&&document.getElement(".button-menu-closer").addClass("hidden"),f&&Array.each(this.table.getParent().getElements(".button-menu-container"),function(n){n!==f&&n.dissolve()}),t.hasClass("button-menu-button")){f&&(f.getStyle("display")==="block"?f.dissolve():(l=t.getPosition(t.getParent(".section")),w=t.getParent(".section").getSize(),f.setStyles({top:l.y-5,right:w.x-l.x+2}),f.reveal(),document.getElement(".button-menu-closer").removeClass("hidden")));return}t.getParent(".button-menu-container")&&t.getParent(".button-menu-container").dissolve();try{n.preventDefault(),n.stopPropagation()}catch(d){}if(t.get("data-type")==="FormEdit")this.popupEditForm({target:t.getParent("tr")});else if(t.get("data-type")==="Delete"){if(r.hasClass("new")){this.destroyRow(r);return}Array.each(r.getElements("input,select,textarea"),function(n){n.hasClass("validate")&&n.get("data-validate-method")&&n.get("data-validate-method").contains("hasvalue")&&(c=n.get("data-validate-method").split(","),n.value=c.contains("float")||c.contains("int")||c.contains("number")?0:"empty")}),this.rowValidationPassed(p,r,u,n)}else t.get("data-type")==="Duplicate"?(Array.each(this.options.widgetDocument.Children[u].Children,function(n){n.Name.test("TimesheetId","gi")&&(b=n.ValueAsString),n.Name.test("EmployeeNo","gi")&&(k=n.ValueAsString),n.Name.test("TSDate","gi")&&(a=Date.parse(n.ValueAsString))}),this.addRows(a,a,k,b)):t.get("data-type")==="Favourite"?(v=!1,r&&u!==!1&&(e=this.options.widgetDocument.Children[u],e.hasOwnProperty("Data")&&e.Data.hasOwnProperty("FavouriteName")&&(v=e.Data.FavouriteName.trim()!==""?e.Data.FavouriteName.trim():!1),this.promptFavName(t,e,v))):t.get("data-type")==="Awards"?this.showAwards(u):t.get("data-type")==="Obscured"?(h=r.getElement(t.get("data-col-ref")),s=h.getElement(".subhidden")?h.getElement(".subhidden").getElement("input,textarea,select"):h.getElement("input,textarea,select"),i=s.clone(),i.value=s.value,uialert({message:"Set "+t.get("data-display")+"<br /><br />",showButtons:!0,showCancel:!0,onClose:function(){i.retrieve("widget")&&"destroy"in i.retrieve("widget")&&(i.retrieve("widget").destroy(),i.removeEvent("change"))}}),Affinity.prompts.adopt(i),i.get("tag")==="select"?(i.set("class",""),new UIAutoCompleteWidget({stopInitialChange:!0,selectElement:i})):new Affinity.FormElement(i),i.addEvent("change",function(){s.value=i.value,s.fireEvent("change"),this.hasRowChanged(h)}.bind(this))):(o=new UIFormValidation({target:r,onValidateCallback:function(){this.rowValidationPassed(p,r,u,n),o.destroy(),delete o}.bind(this),onValidateFailCallback:function(){o.destroy(),delete o}.bind(this)}),o.validate())},promptFavName:function(n,t,i,r,u){var f=i?this.baseAppLang.favourites.renameMessage:this.baseAppLang.favourites.views.mileage.createMessage;typeOf(r)==="string"&&(r=r.trim().length===0?Affinity.languages.english.generic.error:r,f=r+"<br />Please try again."),uiprompt({message:f,showButtons:!0,value:typeOf(u)==="string"?u:i?i:"",onOk:function(r){var u=this.baseLang.favourites.validation.validateName(r);if(!u.isValid){this.promptFavName.delay(50,this,[n,t,i,u.error,r]);return}this.saveFav(n,r,i?i:!1)}.bind(this)})},returnFavHash:function(n){var t=[];return Object.each(JSON.decode(n.Fields),function(n,i){t.push(i+":"+n)}),t.push("Type:"+n.Type),t.push("EmployeeNo:"+n.EmployeeNo),t.push("Name:"+n.Name),t.sort(),t=t.join(",")},selectFav:function(n){var t;uialert({message:this.baseAppLang.favourites.loadingMessage,noClose:!0,showLoader:!0}),t=Affinity.zelosroot+"?api=Favourite/GetFavouriteNamesExt&EmployeeNo="+Affinity.login.profile.employeeNumber+"&timesheetType="+n,this.isManagerView&&(t=Affinity.zelosroot+"?api=Favourite/GetFavouriteNamesExt&timesheetType="+n),new Request.JSON({url:t,onSuccess:function(n){var r,t,i;if("error"in n&&n.error!==!1||typeOf(n)!=="array"){uialert({message:this.baseAppLang.favourites.loadError,showButtons:!0});return}if(n.length===0){uialert({message:this.baseAppLang.favourites.loadNoneError,showButtons:!0});return}r=this.isManagerView?Affinity.FavResultSort(n,"Name","EmployeeName"):Affinity.FavResultSort(n,"Name"),t=[],this.favouriteData=[],Array.each(r,function(n){i=this.returnFavHash(n),t.indexOf(i)===-1&&(this.favouriteData.push(n),t.push(i))}.bind(this)),this.showFavSelect(this.favouriteData)}.bind(this)}).get()},showFavSelect:function(n,t){var u=t||"",f=this.baseAppLang.favourites.selectLabel,i,r;u!==""&&(f=t+"<br />"+this.baseAppLang.favourites.selectLabel),i=new Element("select"),new Element("option",{html:this.baseAppLang.favourites.selectLabel,value:""}).inject(i),Array.each(n,function(n){var t=n.Name;this.isManagerView&&(t=parseInt(n.EmployeeNo)===parseInt(Affinity.login.profile.employeeNumber)?"Me : "+n.Name:n.EmployeeName+" : "+n.Name),new Element("option",{html:t,value:'{"name":"'+n.Name+'","emp":"'+n.EmployeeNo+'","type":"'+n.Type+'"}'}).inject(i)}.bind(this)),i.addClass("hidden"),uialert({message:this.baseAppLang.favourites.selectLabel,showButtons:!0,showCancel:!0,onOk:function(){if(i.value!==""){var n=JSON.decode(i.value);this.addRows(new Date,new Date,n.emp,!1,!1,n.name)}}.bind(this)}),Affinity.prompts.adopt(new Element("br"),new Element("br"),i,new Element("br")),function(){i.removeClass("hidden"),r=new UIAutoCompleteWidget({stopInitialChange:!1,selectElement:i,onComplete:function(){prompts.center()}}),window.onPromptClose=function(){i&&r&&r.destroy()}.bind(this)}.delay(250,this)},saveFav:function(n,t,i){var s=n.get("data-row-ref"),e=this.table.getElement("#"+s),u=this.tableRows.indexOf(e),h=this.options.widgetDocument.Children[u],r=JSON.parse(JSON.stringify(h)+""),f=Affinity.login.profile.employeeNumber,o,c;Array.each(r.Children,function(n){i&&new RegExp("EmployeeNo","gi").test(n.Name)&&(f=n.hasOwnProperty("Value")?n.Value:f)}.bind(this)),i?(o=Affinity.zelosroot+"?api=Favourite/RenameFavourite?OldName="+i+"&NewName="+t+"&timesheetType=4&employeeNo="+f,uiprompt({message:this.baseAppLang.favourites.renamingMessage+' <img src="'+Affinity.loaders.dark+'" />',showButtons:!1,noClose:!0}),c=new Request.JSON({url:o,onComplete:function(n){if(n.hasOwnProperty("success")&&n.success===!1&&n.hasOwnProperty("error")&&typeOf(n.error)==="string"){var t=n.error.trim()!==""?n.error.trim():Affinity.languages.english.generic.error,t=Affinity.CheckFavError(n,t);uialert({message:"Oops! "+t+"<br />Please try again.",showButtons:!0});return}setTimeout(function(){uialert({message:'Waiting for name change to take affect <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),setTimeout(function(){this.refresh()}.bind(this),3e3)}.bind(this),3e3)}.bind(this),onFailure:function(){uialert({message:Affinity.languages.english.generic.error+"<br />Please try again.",showButtons:!0})}.bind(this),onError:function(n){var t=Affinity.CheckFavError(n,Affinity.languages.english.generic.error+"<br />Please try again.");uialert({message:t,showButtons:!0})}.bind(this)}).post()):(r.Data.IsFavourite=!0,r.Data.FavouriteName=t,Array.each(r.Children,function(n,t){new RegExp("RowButton","gi").test(n.Name)&&Array.each(n.Children,function(n,i){r.Children[t].Children[i].Value.Pressed=!1,new RegExp("Favourite","gi").test(n.Name)&&(r.Children[t].Children[i].Value.Pressed=!0),r.Children[t].Children[i].ValueAsString=JSON.stringify(r.Children[t].Children[i].Value)}.bind(this))}.bind(this)),this.options.widgetDocument.Children[u]=r,this.postDocumentRow({rowIndex:u,row:e,messagea:"saving "+this.baseLang.favourites.name,messageb:"saved "+this.baseLang.favourites.name,isfave:!0}))},sanatisePostDocument:function(n){return Affinity.timesheets.methods.sanatisePostDocument(n)},promptVisible:!1,postDocumentRow:function(n){var h=!1,e,c,u,s,t,i,r=!1,o=!1,l=!0;if(n!==null&&n!==undefined&&n.hasOwnProperty("isfave")&&typeof n.isfave=="boolean"&&n.isfave===!0&&(l=!1),n.hasOwnProperty("rowIndex"))u=n.row,s=n.rowIndex,t=n.messagea||"saving",i=n.messageb||"saved",r="timesheet",o="Timesheet";else if(e=n.target.hasClass("button")?n.target:n.target.getParent(".button"),c=e.retrieve("cfbutton")?e.retrieve("cfbutton"):e,u=c.getParent("tr"),s=this.tbody.getElements("tr.timesheet-row").indexOf(u),t="saving",i="saved",r="timesheet",o="Timesheet",n!==null)switch(e.get("data-type")){case"Submit":t="submitting",i="submitted";break;case"Accept":t="approving",i="approved";break;case"Decline":t="declining",i="declined";break;case"Delete":h=!0,t="deleting",i="deleted";break;default:t="saving",i="saved"}!r&&t.contains(this.baseLang.favourites.name)&&(t=t.replace(this.baseLang.favourites.name,"").trim(),i=i.replace(this.baseLang.favourites.name,"").trim(),r=this.baseLang.favourites.name,o=this.baseLang.favourites.title),this.errormsg=o+'(s) processed with errors<span class="hidden"> while '+i+"<\/span><br />",this.promptVisible=!0,window.uialert({message:t.capitalize()+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0});var v=this.options.widgetDocument.Children[s],f=Object.clone(this.options.parentDocument),a=Object.clone(this.options.widgetDocument);a.Children=[v],f.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex]=a,f=this.sanatisePostDocument(f),l&&(f.Children[0].Children[0]=this.cleanFavData(null,f.Children[0].Children[0])),new Request.JSON({url:this.options.putApi,timeout:3e5,onSuccess:function(n){var f,t,o,e;JSON.Unauthorized(n,"detailed, postDocumentRow - "+this.options.putApi)||(f=this.processErrors(n),f.length===0&&(t="Children"in n?n.Children[0].Children[0].Children[0]:!1,o=!1,swhoDefaultMessage=!0,pMessage="",!t||"Children"in t||"Message"in t.Attribute&&t.Attribute.Message.trim()!==""&&(this.destroyRow(u),pMessage="Got it! Your "+r+" has been "+i+".<br /><br />"+t.Attribute.Message.trim(),window.uialert({message:pMessage,noClose:!1,showButtons:!0}),swhoDefaultMessage=!1),this.promptVisible&&swhoDefaultMessage&&(pMessage="Got it! Your "+r+" has been "+i+".",window.uialert({message:pMessage,noClose:!0}),function(){Affinity.prompts.hide()}.delay(1500,this),this.promptVisible=!1)),h?(this.delWidgetDocumentRow(this.tableRows.indexOf(u)),this.options.widgetDocument.Layout.DataTotal--,this.totalTimesheets=this.options.widgetDocument.Layout.DataTotal):(e=n.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex].Children[0],this.putWidgetDocumentRow(this.tableRows.indexOf(u),e,f),delete e),this.fireEvent("processComplete"),this.processUI())}.bind(this),onError:function(n,i){if(typeOf(i)==="object")if("message"in i)i=i.message;else{var u=i.toString();if(u.contains("401")&&Affinity&&Affinity.login&&Affinity.login.session){window.fireEvent("unauthorized");return}i=="unknown"}typeOf(i)==="string"&&i.contains("401")?Affinity&&Affinity.login&&Affinity.login.session?window.fireEvent("unauthorized"):window.uialert({message:"Oh no! We had trouble "+t.toLowerCase()+" your "+r+".<br />You have been logged out by another system. Please try logging in again."}):window.uialert({message:"Oh no! We had trouble "+t.toLowerCase()+" your "+r+".<br />"+i})}.bind(this),onFailure:function(n,i){var u=n.response?n.response:n.responseText?n.responseText:i;u&&u.contains("401")?Affinity&&Affinity.login&&Affinity.login.session?window.fireEvent("unauthorized"):window.uialert({message:"Oh no! We had trouble "+t.toLowerCase()+" your "+r+".<br />"+n.statusText}):window.uialert({message:"Oh no! We had trouble "+t.toLowerCase()+" your "+r+".<br />"+n.statusText})}.bind(this),onException:function(n,t){window.uialert({message:"Oh no! Something went wrong!<br />There was a problem with the header "+n+": "+t})}.bind(this),onTimeout:function(){window.uialert({message:"Oh no! We reached the timeout limit!<br />Please check your connection and try again."})}}).post("="+escape(JSON.stringify(f)))},rowValidationPassed:function(n,t,i,r){var e,u,o,f;this.updateWidgetDocument(),e=[],Array.each(this.options.widgetDocument.Children,function(n){n.Data.RowType||e.push(n)}),u=Object.clone(e[i]),delete e,o=n.get("id"),f=u.Children.length-1,Array.each(u.Children[f].Children,function(n,t){u.Children[f].Children[t].Value.Pressed=n.Name==o?!0:!1,u.Children[f].Children[t].ValueAsString=JSON.stringify(u.Children[f].Children[t].Value)}),this.options.widgetDocument.Children[i]=u,delete u,delete o,delete f,this.postDocumentRow(r)},processErrors:function(n,t){var i=[],u=0,r;if(n.error?i.push(n.error):Array.each(n.Children,function(n){Array.each(n.Children,function(n){n.ElementType=="TimesheetTable"&&Array.each(n.Children,function(n){n.Data&&n.Data.RowType||(n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&i.push("Row "+(u+1)+" has an error : "+n.Attribute.ErrorMessage),Array.each(n.Children,function(n,t){n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&i.push("Row "+(u+1)+" column "+(t+1)+" has an error : "+n.Attribute.ErrorMessage)}.bind(this)),u++)}.bind(this))}.bind(this))}.bind(this)),typeof t!="undefined"&&t===!0){this.refresh(null,i);return}return this.promptVisible&&i.length>0&&(r=this.errormsg+i.join("<br />"),i.length==1&&(r=r.replace("Row 1","A row")),window.uialert({message:Affinity.languages.english.generic.error+"<br />"+r,showButtons:!0}),this.promptVisible=!1),i},checkSelected:function(){var n=!1,t=!0;return Array.each(this.tbody.getElements(".check input"),function(i){i.checked?n=!0:t=!1}.bind(this)),{anyChecked:n,allChecked:t}},rendered:!1,renderCheckTimer:!1,renderCheck:function(){var t,n,r,i,u,f;clearTimeout(this.renderCheckTimer),this.options.target.getElement("table.timesheet")&&(this.rendered=!0),this.rendered?(t=this.options.target.getParent("form"),this.isManagerView&&(n=t&&typeOf(t)!=="null"?t.getElement("select[id=ForwardTo]"):!1,r=n&&typeOf(n)!=="null"?!n.hasClass("widget"):!1,n&&n.getParent(".form-row")&&(n.getParent(".form-row").addClass("inline"),n.getParent(".form-row").getParent().getElement(".form-row.buttons")&&n.getParent(".form-row").getParent().getElement(".form-row.buttons").addClass("inline")),r&&(n.getElement("option")&&n.getElement("option").get("html")!==""&&new Element("option",{selected:"selected"}).inject(n,"top"),this.frowardWidget=new UIAutoCompleteWidget({selectElement:n}))),i=t?t.getElements(".form-row.buttons"):!1,Affinity.mobile&&i&&i.length>0&&!i.getLast().getElement(".mobile-select-message")&&(u=t.getElements(".form-row.buttons").getLast(),f=u.getElement(".button-wrapper"),new Element("div",{"class":"mobile-select-message",html:"Swipe row right to select, swipe row left to deselect"}).inject(f,"before"))):this.renderCheckTimer=this.renderCheck.delay(50,this)},checkNoRows:function(){this.tableRows=this.tbody&&this.tbody.getElements("tr.timesheet-row")&&this.tbody.getElements("tr.timesheet-row").length>0?this.tbody.getElements("tr.timesheet-row"):[],this.tableRows.length>0?(this.setHasRows(),this.thead.getElements("th").length===0&&this.buildTableHeader(),this.tfoot.getElements("th").length===0&&this.buildTableFooter()):(this.setNoRows(),this.secondaryAddButton||this.returnSecondaryAddButton(),this.secondaryButtonWrapper.inject(this.norows))},processUIThrottle:!1,processUI:function(n,t){clearTimeout(this.processUIThrottle),this.processUIThrottle=this.continueProcessUI.delay(100,this[(n,t)])},continueProcessUI:function(n,t){var f=n?!1:!0,i=t||!1,u,r;return this.debug&&(console.log("%cProcess UI","background: #9d9dfd; color: white"),console.time("Process UI")),this.checkNoRows(),f&&(this.buildTableHeader(),this.buildTableFooter(),this.renderPagination()),i?i.hasClass("new")||i.hasClass("modified")?this.setUnload():this.delUnload():this.tbody.getElements("tr.new").length>0||this.tbody.getElements("tr.modified").length>0?this.setUnload():this.delUnload(),this.setTableClass(),Affinity.uiGrid&&Affinity.uiGrid.zebra(this.table,"timesheet-row"),this.readonly&&document.uiSortableGrid&&document.uiSortableGrid.processTable(this.table,"timesheet-row"),u=i?i.getElements(".has-dependencies"):this.table.getElements(".has-dependencies"),Array.each(u,function(n){if(r=n.retrieve("dependencies"),r&&"setEvents"in r)"eventsset"in r&&!r.eventsset&&r.setEvents();else try{var i=n.getParent("tr"),t="";t+="!!!\tDependency issue found\r\n",t+="\tDependency not established when processing UI (Could not find widget on element)\r\n",t+="\tTime:\t"+(new Date).toTime()+"\r\n",t+="\tElement ID:\t"+n.get("id")+"\r\n",t+="\tElement Class:\t"+n.get("class")+"\r\n",t+="\tRow ID:\t"+i.get("id")+"\r\n",t+="\tRow Class:\t"+i.get("class")+"\r\n",t+="!!!",log(t)}catch(u){}}.bind(this)),Affinity.tooltips&&Affinity.tooltips.processNew(),Affinity.lookups&&Affinity.lookups.processNew({jsonp:!0}),Affinity.displaylookups&&Affinity.displaylookups.processNew({jsonp:!0}),Affinity.uiDrawPanels&&Affinity.uiDrawPanels.processNew(),Affinity.uiDateCalendar&&(u=i?i.getElements(".input.uidate-calendar"):this.table.getElements(".input.uidate-calendar"),Array.each(u,function(n){new UIDateTimeWidget({target:n,showTime:!0})}.bind(this)),i?i.getElements(".ui-calendar-button.blue").addClass("hide1024 hide1350 hide1620"):this.table.getElements(".ui-calendar-button.blue").addClass("hide1024 hide1350 hide1620")),this.doChangeChecks=!0,clearTimeout(this.renderCheckTimer),this.renderCheckTimer=this.renderCheck.delay(50,this),this.debug&&(console.timeEnd("Process UI"),console.log("%c\tUI Processed","background: #9d9dfd; color: white;")),this.showMobilePopupEditor&&(this.popupEditForm({target:this.tableRows.getLast()}),this.showMobilePopupEditor=!1),!0},showMobilePopupEditor:!1,newRowsLoader:null,loadNewRows:function(n,t,i){if(this.doChangeChecks=!1,this.newRowsLoader)try{this.newRowsLoader.cancel()}catch(r){}this.getApi=n,log("&#x2794; attempting detailed loadNewRows ..."),this.newRowsLoader=new ZelosTemplateLoad({noCache:!0,onRequest:function(){if(this.showAlerts){var n=t.length>15?t:t+"ing";uialert({message:n,noClose:!0,showLoader:!0}),t="Search"}}.bind(this),onError:function(n){log("&#x2718; attempted detailed loadNewRows failed with errors - "+n),this.showAlerts&&uialert({message:t+" Failed.<br />"+n}),this.newRowsLoader=!1}.bind(this),onFailure:function(n){log("&#x2718; attempted detailed loadNewRows failed - "+n.statusText),this.showAlerts&&uialert({message:t+" Failed."}),this.newRowsLoader=!1}.bind(this),onComplete:function(t){var r,u;if(!JSON.Unauthorized(t,"detailed, loadNewRows - "+n)){if(log("&#x2714; attempted detailed loadNewRows succeeded"),this.debug&&(console.log("%cAdd New Rows","background: #44b5ec; color: white"),console.time("Add New Rows")),this.destroyRows()){if(this.putWidgetDocument(t.Children[0].Children[0]),typeOf(this.options.widgetDocument.Children)=="array"&&this.options.widgetDocument.Children.length>0&&Array.each(this.options.widgetDocument.Children,function(n){u=this.returnNewRow(n),u&&u.inject(this.tbody)}.bind(this)),this.checkColumnMisssAligned()){this.refresh();return}this.filterFromRefresh||this.hideSearchForm(),this.filterFromRefresh=!1,this.processUI(),this.showAlerts&&(r=function(){var n=!1;Affinity.prompts.currentObj!==undefined&&Affinity.prompts.currentObj.isCloseOnClick!==undefined&&(n=Affinity.prompts.currentObj.isCloseOnClick),n===!1&&Affinity.prompts.hide()}.delay(2e3,this)),this.newRowsLoader=!1,typeOf(i)!=="null"&&i.length>0&&this.showAlerts&&(clearTimeout(r),i.length==1?window.uialert({message:Affinity.languages.english.generic.error+"<br />"+i.join("<br />").replace("Row 1","A row"),showButtons:!0}):window.uialert({message:Affinity.languages.english.generic.error+"<br />"+i.join("<br />"),showButtons:!0}))}this.debug&&(console.timeEnd("Add New Rows"),console.log("%c\tNew Rows Added","background: #44b5ec; color: white;")),this.messageBucket.length>0&&(clearTimeout(r),window.uialert({message:this.messageBucket.join("<br />"),showButtons:!0}),this.messageBucket=[]),window.removeEvent("AnElementChanged",this.globalElementChangeHandler),window.removeEvent("AnElementRestored",this.globalElementChangeHandler),window.addEvent("AnElementChanged",this.globalElementChangeHandler),window.addEvent("AnElementRestored",this.globalElementChangeHandler),this.fireEvent("newRowsLoaded")}}.bind(this)}).loadTemplate(n)},adjustFilterDates:function(n){if(n){var u,t=!1,i=!1,r=n.target.hasClass("button")?n.target:n.target.getParent("button");if(r){u=r.hasClass("filter-last-period")?"last":r.hasClass("filter-current-period")?"current":r.hasClass("filter-next-period")?"next":"unknown";switch(u){case"last":if(Affinity.login.profile.payPeriods.periodCurrentIndex<=0){uialert({message:"There are no past periods for this user",showButtons:!0,showLoader:!1,noClose:!1});return}t=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex-1].from,i=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex-1].to;break;case"current":t=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex].from,i=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex].to;break;case"next":if(Affinity.login.profile.payPeriods.periodCurrentIndex===Affinity.login.profile.payPeriods.periods.length){uialert({message:"There are no future periods for this user",showButtons:!0,showLoader:!1,noClose:!1});return}t=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex+1].from,i=Affinity.login.profile.payPeriods.periods[Affinity.login.profile.payPeriods.periodCurrentIndex+1].to}t&&i&&(this.searchFrom.setDate(t),this.searchTo.setDate(i))}}},filterQueryObject:!1,filterDelay:!1,doSearch:function(n,t){var i=typeOf(t)==="boolean"?t:!1;i||uialert({message:typeOf(n)==="string"&&n!==""?n:"Searching",showLoader:!0,noClose:!0}),clearTimeout(this.filterDelay),this.filterDelay=function(){var r=[],h=this.searchFrom.getRawDate(),c=this.searchTo.getRawDate(),e=this.sanatiseFromToDates(h,c),l=this.getApi,o=new URI(l),t=o.parsed.query.parseQueryString(),s,u,f;e.fromDate&&(t.fromDate=Date.parse(e.fromDate).format("%d.%b.%Y"),r.push("Date From "+Date.parse(e.fromDate).format("%d/%m/%Y"))),e.toDate&&(t.toDate=Date.parse(e.toDate).format("%d.%b.%Y"),r.push("Date To "+Date.parse(e.toDate).format("%d/%m/%Y"))),this.currentSearchEmployee=!1,this.searchEmployee&&(t.employeeNo=this.searchEmployee.value,this.searchEmployee.value!==""&&(this.currentSearchEmployee=this.searchEmployee.value,r.push("Employee "+this.searchEmployee.value))),this.searchPayPoint&&(t.PayPoint=this.searchPayPoint.value,this.currentSearchPayPoint=this.searchPayPoint.value,this.searchPayPoint.value!==""&&r.push("Pay Point "+this.searchPayPoint.value)),this.searchEmployeeGroups&&(t.TimesheetRole=this.searchEmployeeGroups.value,this.currentSearchEmployeeGroup=this.searchEmployeeGroups.value,this.searchEmployeeGroups.value!==""&&r.push("Group "+this.searchEmployeeGroups.value)),s=[],this.searchScreenFilters&&this.searchScreenFilters.length>0&&(Array.each(this.searchScreenFilters,function(n){n.value!==""?(t[n.get("data-field-name")]=n.value,s.push(n.get("data-label")+" is '"+n.value+"'")):delete t[n.get("data-field-name")]}.bind(this)),s.length>0&&r.push("Where "+s.join(" & "))),this.searchStatus&&(u=[],t.timesheetStatus="",Array.each(this.supportedStatus,function(n){this.searchStatus.getElement(".searchStatusCheck-m-"+n)&&this.searchStatus.getElement(".searchStatusCheck-m-"+n).checked&&u.push(n)}.bind(this)),t.timesheetStatus=u.join(","),this.currentSearchStatus=u.join(","),u.length>0&&r.push("Status "+u.join(" and ")),delete u),f=!1,this.immutibleFilter&&this.immutibleFilter.getElement(".searchExcludeLockedCheck-m").checked&&(f="dont_return_locked",r.push("Excluding Locked")),this.managedFilter&&this.managedFilter.getElement(".searchMangedOnlyCheck-m").checked&&(f?f+=",dont_return_managed":f="dont_return_managed",r.push("My timesheets to approve only")),f===!1?(t.DefaultRosterGroup=null,delete t.DefaultRosterGroup):t.DefaultRosterGroup=f,this.filterQueryObject=t,t.page=0,url=o.toString(),o.parsed.query=Object.toQueryString(t),url=o.toString(),this.filterStrBox.set("html","Filtered By: "+r.join(", ")),i||this.loadNewRows(url,typeOf(n)==="string"&&n!==""?n:"Search")}.delay(500,this)},renderPagination:function(){var i,t,n;if(this.options.paginate){for(t=this.options.widgetDocument.Layout,this.pageSize=t.PageSize,this.totalPages=t.PageTotal,this.currentPage=t.PageNumber,this.totalTimesheets=t.DataTotal,this.timsheetRowfrom=this.currentPage*this.pageSize+1,this.timesheetRowTo=this.currentPage*this.pageSize+this.pageSize,this.timesheetRowTo>this.totalTimesheets&&(this.timesheetRowTo=this.totalTimesheets),this.paginationContainer.empty(),new Element("span",{html:"previous","class":this.currentPage==0?"disabled":""}).inject(this.paginationContainer).addEvent(Affinity.events.click,this.getPreviousPage),n=0;n<this.totalPages;n++)i=n==this.currentPage?"page selected":"page",i+=" page"+n,new Element("span",{html:n+1,"class":i,"data-page":n}).inject(this.paginationContainer).addEvent(Affinity.events.click,this.getPage);new Element("span",{html:"next","class":this.currentPage+1>=this.totalPages||this.totalPages==0?"disabled":""}).inject(this.paginationContainer).addEvent(Affinity.events.click,this.getNextPage),new Element("br").inject(this.paginationContainer),new Element("span",{html:"Showing Timesheet(s) "+this.timsheetRowfrom+" to "+this.timesheetRowTo+" of "+this.totalTimesheets,"class":"disabled","class":"desc"}).inject(this.paginationContainer),this.totalTimesheets===0?this.paginationContainer.addClass("hidden"):this.paginationContainer.removeClass("hidden")}},getNextPage:function(n){n.target.hasClass("disabled")||this.currentPage<this.totalPages&&this.paginationContainer.getElement(".page"+(this.currentPage+1))&&this.getPage({target:this.paginationContainer.getElement(".page"+(this.currentPage+1))})},getPreviousPage:function(n){n.target.hasClass("disabled")||this.currentPage>0&&this.paginationContainer.getElement(".page"+(this.currentPage-1))&&this.getPage({target:this.paginationContainer.getElement(".page"+(this.currentPage-1))})},getPage:function(n){var r=n.target.hasClass("page")?n.target:n.target.getParent(".page"),i=new URI(this.getApi),t=typeOf(i.parsed.query)==="null"?{}:i.parsed.query.parseQueryString();t.fromDate=this.loadTimesheetsFrom.format("%d.%b.%Y"),t.toDate=this.loadTimesheetsTo.format("%d.%b.%Y"),this.filterQueryObject&&Object.merge(t,this.filterQueryObject),t.page=parseInt(r.get("data-page")),t.view="detail",this.options.isDual&&(t.view="daydetail"),t.ran=String.uniqueID(),i.parsed.query=Object.toQueryString(t),this.currentPage=t.page+0,this.loadNewRows(i.toString(),"Load")},subMenuOpen:!1,subMenuOpenDelay:!1,subMenuCloseDelay:!1,subMenuOver:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay),n.delay=0,this.showButtons(n)},subMenuOut:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay),n.delay=0,this.hideButtons(n)},showButtons:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay);var t=250;n.hasOwnProperty("delay")&&(t=n.delay),this.subMenuOpenDelay=setTimeout(function(){var t=n.target.hasClass("button")?n.target:n.target.getParent(".button"),i,r,u,f;t&&(this.subMenuOpen=!0,i=t.getParent(".button-container")?document.id(t.getParent(".button-container").get("data-menu-id")):!1,r=t.getPosition(t.getParent(".section")),u=t.getParent(".section").getSize(),f=t.getSize(),document.querySelectorAll(".button-menu-container").forEach(function(n){n!==i&&n.dissolve()}.bind(this)),i.setStyles({top:r.y-5,right:u.x-r.x-f.x-2}),i.reveal(),document.getElement(".button-menu-closer").removeClass("hidden"))}.bind(this),t)},hideButtons:function(n){clearTimeout(this.subMenuOpenDelay),clearTimeout(this.subMenuCloseDelay);var t=250;n.hasOwnProperty("delay")&&(t=n.delay),this.subMenuOpenDelay=setTimeout(function(){this.subMenuOpen=!1,document.getElements(".button-menu-container").dissolve(),document.getElement(".button-menu-closer").addClass("hidden")}.bind(this),t)},simplifyButton:function(n){n.getElement(".button")&&(n=n.getElement(".button")),n.removeClass("w-icon").addClass("w-icon-only").getElements("span").addClass("hidden"),n.getElement("span").removeClass("hidden")},returnButtonfromLang:function(n,t){var i=n.querySelector("span"),f=t.icon,e=f!==!1?Affinity.icons[f]:"",o=t.label,u,r;return i.querySelectorAll("span").length===1?(r=document.createElement("span"),u=i.querySelector("span"),r.innerHTML=e,u.innerHTML=o,i.insertBefore(r,u),i.classList.add("w-icon")):i.querySelectorAll("span").length===2&&(r=i.querySelectorAll("span")[0],u=i.querySelectorAll("span")[1],r.innerHTML=e,u.innerHTML=o,i.classList.add("w-icon")),r&&f===!1&&(r.destroy(),i.classList.remove("w-icon")),n},returnButtons:function(n,t,i,r,u,f,e,o){var h,s,v,l=!1,d=e||!1,y,a,et;if(n.Name.contains("Button")){y=String.uniqueID(),document.getElement(".button-menu-closer")||new Element("div",{"class":"button-menu-closer hidden"}).addEvent(Affinity.events.click,this.hideButtons).inject(document.getElement("body"),"bottom");var p=new Element("div"),w=new Element("span",{"class":"button-divider blue hidden",html:"<hr />"}),g=new Element("span",{"class":"button-divider decline hidden",html:"<hr />"}),nt=new Element("span",{"class":"button-wrapper recalc"}),b=new Element("span",{"class":"button-wrapper awards"}),k=new Element("span",{"class":"button-wrapper duplicate"}),tt=new Element("span",{"class":"button-wrapper favourite"}),it=new Element("span",{"class":"button-wrapper decline"}),rt=new Element("span",{"class":"button-wrapper save"}),ut=new Element("span",{"class":"button-wrapper delete"}),ft=new Element("div",{"class":"button-menu-close",html:this.icons.dotsVert}),c=new Element("div",{"class":"button-menu-container row-ref-"+i,id:"bm"+y}).adopt(ft,new Element("div",{"class":"button-menu-title",html:"Options"}),new Element("div",{"class":"button-wrappers"}).adopt(nt,b,k,tt,p,w,it,g,rt,ut)).inject(document.getElement("body"),"bottom").addEvent(Affinity.events.outAll,this.subMenuOut).addEvent(Affinity.events.overAll,this.subMenuOver);r!=="pending"&&k.addClass("active"),this.isManager&&b.addClass("active"),a=new Element("span",{"class":"button button-menu-button","data-row-ref":i,html:"<span>"+this.icons.dotsVert+"<\/span><span><\/span>"}),Affinity.mobile?a.addEvent(Affinity.events.click,this.buttonClicked):a.addEvent(Affinity.events.outAll,this.hideButtons).addEvent(Affinity.events.overAll,this.showButtons),l=new Element("div",{"class":"button-container","data-menu-id":"bm"+y}).adopt(new Element("span",{"class":"button-wrapper submit"}),new Element("span",{"class":"button-wrapper approve"}),new Element("span",{"class":"button-wrapper decline"}),a),et=!1,Array.each(n.Children,function(n){s=this.zelosProcessor.processChild(n),s&&(n.Name.test("ReCalc","gi")?Affinity.mobile?c.getElement(".button-wrapper.recalc").destroy():(s.addClass("active").inject(c.getElement(".button-wrapper.recalc"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.recalc").destroy(),s=this.returnButtonfromLang(s,Affinity.languages.english.application.timesheets.buttons.recalc),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)):n.Name.test("awards","gi")?Affinity.mobile?c.getElement(".button-wrapper.awards").destroy():(s.addClass("active").inject(c.getElement(".button-wrapper.awards"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.awards").destroy(),s=this.returnButtonfromLang(s,Affinity.languages.english.application.timesheets.buttons.awards),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)):Affinity.enableFavourites&&n.Name.test("favourite","gi")?Affinity.mobile?c.getElement(".button-wrapper.favourite").destroy():(s.addClass("active").inject(c.getElement(".button-wrapper.favourite"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.favourite").destroy(),s=this.returnButtonfromLang(s,{label:o?this.baseAppLang.favourites.renameButtonLabel:this.baseAppLang.favourites.saveButtonLabel,icon:"Pin"}),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)):n.Name.test("save","gi")?s.addClass("active").inject&&c.getElement(".button-wrapper.save")!==null&&(s.addClass("active").inject(c.getElement(".button-wrapper.save"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.save").destroy(),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked),w.classList.remove("hidden")):n.Name.test("approve","gi")?(s.addClass("active").inject(l.getElement(".button-wrapper.approve"),"after"),s.getElement(".button").set("data-row-ref",i),l.getElement(".button-wrapper.approve").destroy(),s.getElement(".button").addEvent(Affinity.events.click,this.buttonClicked),this.simplifyButton(s)):n.Name.test("decline","gi")?(s.addClass("active").inject(l.getElement(".button-wrapper.decline"),"after"),s.getElement(".button").set("data-row-ref",i),l.getElement(".button-wrapper.decline").destroy(),s.getElement(".button").addEvent(Affinity.events.click,this.buttonClicked),this.simplifyButton(s)):n.Name.test("delete","gi")?(s.addClass("active").inject(c.getElement(".button-wrapper.delete"),"after"),s.getElement(".button").set("data-row-ref",i),c.getElement(".button-wrapper.delete")&&c.getElement(".button-wrapper.delete").destroy(),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked),w.classList.remove("hidden")):n.Name.test("submit","gi")?(s.addClass("active").inject(l.getElement(".button-wrapper.submit"),"after"),s.getElement(".button").set("data-row-ref",i),l.getElement(".button-wrapper.submit").destroy(),s.getElement(".button").addEvent(Affinity.events.click,this.buttonClicked),this.simplifyButton(s)):(s.inject(a,"before"),s.getElement(".button").set("data-row-ref",i),h=this.zelosProcessor.processChild(n),h.addClass("hidden"),h.inject(l),s.getElement(".button").store("cfbutton",h.getElement(".button")).addEvent(Affinity.events.click,this.buttonClicked)))}.bind(this)),this.enableFormEdit&&(new Element("span",{"class":"button-divider edits",html:"<hr />"}).inject(c.getElement(".button-wrappers")),v=new Element("span",{"class":"button-wrapper"}).inject(c.getElement(".button-wrappers")),s=new Element("span",{"class":"button blue w-icon","data-row-ref":i,"data-type":"FormEdit"}).adopt(new Element("span",{html:Affinity.icons.Pencil}),new Element("span",{html:"Edit"})).inject(v),s.store("cfbutton",s),s.addEvent(Affinity.events.click,this.buttonClicked)),c.getElement(".button-wrapper.duplicate")&&(typeOf(t)==="null"||t||d?c.getElement(".button-wrapper.duplicate").destroy():s=new Element("span",{"class":"button blue w-icon ui-has-tooltip","data-type":"Duplicate","data-row-ref":i,html:"<span>"+this.icons.duplicate+"<\/span><span>Duplicate<\/span><\/span>"}).inject(c.getElement(".button-wrapper.duplicate")).addEvent(Affinity.events.click,this.buttonClicked)),f&&f.length>0&&(new Element("span",{"class":"button-divider obscured",html:"<hr />"}).inject(p),Array.each(f,function(n){v=new Element("span",{"class":"button-wrapper obscured"}).inject(p),s=new Element("span",{"class":"button "+(n[1].toLowerCase().contains("higher dut")?"yellow":"blue")+" w-icon","data-type":"Obscured","data-row-ref":i,"data-col-ref":n[0],"data-display":n[1]}).adopt(new Element("span",{html:Affinity.icons.FieldEdit}),new Element("span",{html:"Set "+n[1]})).inject(v),s.store("cfbutton",s).addEvent(Affinity.events.click,this.buttonClicked)}.bind(this))),c.inject(this.table,"before").set("reveal",{duration:250,mode:"vertical"}).toggle()}return l},retrunRowStatus:function(n){var i=this.getValue(n).toLowerCase(),t={status:"none",icon:"",color:"none",klass:"",message:"",isNewRow:!1};switch(i){case"pending":t.status=i,t.icon=Affinity.icons.Save,t.message="Timesheet saved but not submitted",t.color="orange",t.klass="color "+t.color;break;case"submitted":t.status=i,t.color="blue",t.klass="color "+t.color;break;case"declined":t.status=i,t.icon=Affinity.icons.ThumbsDown,t.color="red",t.message="Timesheet has been declined",t.klass="color "+t.color;break;case"approved":t.status=i,t.icon=Affinity.icons.ThumbsUp,t.color="green",t.message="Timesheet has been approved",t.klass="color "+t.color;break;case"paid":t.status=i,t.icon=Affinity.icons.Moneybag,t.color="green",t.message="Timesheet has been paid",t.klass="color "+t.color;break;case"immutable":t.status=i,t.icon=Affinity.icons.Lock,t.color="grey",t.message="",t.klass="color "+t.color;break;case"new":t.status=i,t.icon=Affinity.icons.StarFull,t.color="orange",t.message="New Timesheet",t.klass="color "+t.color+" hi",t.isNewRow=!0}return t},setTableClass:function(){if(typeOf(this.options.widgetDocument)==="object"&&"Attribute"in this.options.widgetDocument){var t=this.options.widgetDocument.Attribute.IsReadOnly||!1,n;n=t?"ui-grid ui-grid-sortable timesheet":"ui-grid timesheet",n=this.options.timesheetType==="employeeMilaege"?n+" detailed":n,this.table.set("class",n),this.hasRows||this.table.addClass("hidden")}},buildTableHeader:function(){var n,i,t;if(this.setTableClass(),this.options.widgetDocument&&this.options.widgetDocument.Children&&this.options.widgetDocument.Children.length!==0){for(i=!1,n=0;n<this.options.widgetDocument.Children.length;n++)if(this.options.widgetDocument.Children[n].Data&&typeOf(this.options.widgetDocument.Children[n].Data.RowType)==="null"){i=this.options.widgetDocument.Children[n];break}i&&(t=this.buildTableRow(i,!0),t&&(t.getElement("th.active").addClass("first"),this.table.getElement("thead").empty().adopt(t),this.thead=t,this.thead.getElement("input.selectall")&&(this.bulkSelect=this.thead.getElement("input.selectall"),this.bulkSelect.addEvent(Affinity.events.click,this.selectAllRows))),delete t),delete n,delete i}},buildTableFooter:function(){var n,u,t,f,s,i,r,e,o;if(this.options.widgetDocument&&this.options.widgetDocument.Children&&this.options.widgetDocument.Children.length!==0){for(u=!1,n=0;n<this.options.widgetDocument.Children.length;n++)if(this.options.widgetDocument.Children[n].Data&&typeOf(this.options.widgetDocument.Children[n].Data.RowType)==="null"){u=this.options.widgetDocument.Children[n];break}u&&(t=Number(this.options.widgetDocument.Layout.UnitTotal).round(2),f=this.thead.getElement(".col-id-TsNet")||this.thead.getElement(".col-id-CalculatedTotal")||this.thead.getElement(".col-id-Unit")||this.thead.getElement(".col-id-Units")||!1,f?(this.tfoot.empty(),i=this.thead.getElements("th"),s=i.indexOf(f),Array.each(i,function(n,t){t==s?this.tfoot.adopt(new Element("th",{"class":"active value unit-total"})):this.tfoot.adopt(new Element("th",{"class":n.hasClass("hidden")?"hidden":n.hasClass("active")?"active":""}))}.bind(this)),this.tfoot.getElement("th.active").addClass("first")):(this.tfoot.empty(),i=this.thead.getElements("th"),Array.each(i,function(n){this.tfoot.adopt(new Element("th",{"class":n.hasClass("hidden")?"hidden":n.hasClass("active")?"active":""}))}.bind(this)),this.tfoot.getElement("th.active")&&this.tfoot.getElement("th.active").addClass("first")),this.tfoot.getElement(".unit-total")&&t&&t>0&&(r=this.tfoot.getElement(".unit-total"),e=r.getPrevious("th.active"),r.set("html","Total&nbsp;<strong>"+t+"<\/strong>"),Affinity.mobile?r.set("html","<strong>"+t+"<\/strong>"):(e.set("html","(from&nbsp;"+this.options.widgetDocument.Layout.PageTotal+"&nbsp;pages)"),e.setStyle("text-align","right"),r.set("html","Total&nbsp;<strong>"+t+"<\/strong>"))),function(){var i=[],t=this.tfoot.getElements("th"),u=0,r=0,n;for(this.tfoot.getElement("th.unit-total")&&(r=t.indexOf(this.tfoot.getElement("th.unit-total"))+1),n=t.length-1;n>-1;n--)if(i.push(t[n]),t[n].hasClass("active")&&u++,n===r)break;Array.each(i,function(n){n.destroy()}),new Element("th",{colspan:i.length,"class":"active"}).inject(this.tfoot)}.bind(this)(),this.tfoot.getElements("th.active").length>0&&(this.secondaryAddButton||this.returnSecondaryAddButton(),Affinity.mobile?(o=document.createAttribute("colspan"),o.value=__mergeThs.length,this.tfoot.getElement("th.active").setAttributeNode(o),this.secondaryButtonWrapper.inject(this.tfoot.getElement("th.active"))):this.secondaryButtonWrapper.inject(this.tfoot.getElements("th.active").getLast()))),delete n,delete u}},columnsCheck:[],checkColumnMisssAligned:function(){var i=!1,n,t;return this.columnsCheck.length>0&&(n=this.columnsCheck[0].join(",").trim().replace(/Selected/gi,"").replace(/\,\,/g,","),Array.each(this.columnsCheck,function(r){t=r.join(",").trim().replace(/Selected/gi,"").replace(/\,\,/g,","),/.*[ActEndTime].*[ActStartTime].*[ShiftType].*/gi.test(t)&&/.*[ActEndTime].*[ActStartTime].*[ShiftType].*/gi.test(n)&&(t=t.replace(/ShiftType/gi,"").replace(/\,\,/g,","),n=n.replace(/ShiftType/gi,"").replace(/\,\,/g,",")),n!==t&&(i=!0)}.bind(this))),i},buildTableRow:function(n,t){var o;if(n){var h=[],c=n.Data.RowType?n.Data.RowType:"Timesheet",l=0;if(c==="Award")return!1;if(c==="Timesheet"){var e,u,i,a,v,r,s=!1,f=new Element("tr",{"class":"timesheet-row"}),y=new Element("tr"),p=[];if("Children"in n&&typeOf(n.Children)==="array"){if(n.Children.sort(function(n,t){return parseInt(n.Layout.Rank,10)-parseInt(t.Layout.Rank,10)}),Array.each(n.Children,function(n){if(e=this.getAttributes(n),u=n.Source?n.Source.PropertyName:n.Name.substring(n.Name.lastIndexOf("-")+1),p.push(u.trim()),u.test("TsStatus","gi")&&(s=this.retrunRowStatus(n)),i="active ",e.hidden&&(i="hidden "),a=this.tbody.getElements(".col-id-"+u+".hidden").length>0,v=this.tbody.getElements(".col-id-"+u+".active").length>0,!e.hidden&&a&&(this.table.getElements(".col-id-"+u).removeClass("hidden").addClass("active"),i="active "),e.hidden&&v&&(i="active "),n.Layout.IsObscured&&(this.table.getElements(".col-id-"+u).removeClass("active").addClass("hidden"),i="hidden ",h.push([".col-id-"+u,n.Description.ShortText.replace(/timesheet/gi,"").trim()])),u.test("TimesheetId","gi")&&(f.addClass(n.ValueAsString),f.set("data-timesheet-id",n.ValueAsString)),i=u.test("Comment","gi")?i+"comment ":i,i=u.test("TsNet","gi")?i+"w100 ":i,i=u.test("Unit","gi")?i+"w100 ":i,i=u.test("CalculatedTotal","gi")?i+"w100 ":i,i=u.test("RowButton","gi")?i+"buttons ":i,i=u.test("Selected","gi")?i+" check w25 ":i,n.InputType)switch(n.InputType){case"Time":case"HoursMins":i=i.replace(/w100 /,"")+"w100 ";break;case"Date":case"DateTime":i=i.replace(/w100 /,"")+"w150 "}Affinity.mobile&&i.test("RowButton","gi")&&(i="hidden "+i.replace("active","")),new Element("td",{"class":"loading "+i+"col-id-"+u,"data-col-id":u}).inject(f),l++,t&&(r="",n.Layout&&n.Layout.HideTitle!==!0&&typeOf(n.Description)!=="null"&&typeOf(n.Description.ShortText)!=="null"&&(r=n.Description.ShortText.replace(/timesheet/gi,"").trim(),r=="Position Code"?r='<span>Position<\/span><span class="hide-on-mobile"> Code<\/span>':r=="Pay Code"?r='Pay<span class="hide-on-mobile"> Code<\/span>':r.test(new RegExp(" Element","gi"))?r=r.replace(" Element",'<span class="hide-on-mobile"> Element<\/span>'):r=="Submitted To"?r='<span class="hide-on-mobile">Submitted <\/span><span>To<\/span>':r=="Hours Worked"?r='<span class="hide-on-mobile">Hours<\/span><span class="hide-on-desktop">Hrs<\/span><span class="hide-on-mobile"> Worked<\/span>':r=="Hours"?r='<span class="hide-on-mobile">Hours<\/span><span class="hide-on-desktop">Hrs<\/span>':r.test(new RegExp("hours","gi"))?Affinity.mobile&&(r="Hrs"):r.test(new RegExp("cost","gi"))?Affinity.mobile&&(r="Cost"):r.test(new RegExp("resource","gi"))?Affinity.mobile&&(r=r.replace(new RegExp("resource","gi"),"Res")):r.test(new RegExp("approver","gi"))?Affinity.mobile&&(r=r.replace(new RegExp("approver","gi"),"Appr")):r.test(new RegExp("employee","gi"))?Affinity.mobile&&(r="Emp"):r=="Bulk Process"?r='<input type="checkbox" class="selectall ui-has-tooltip" data-tooltip="Select / Deselect All" data-tooltip-dir="top,left" />':e.required&&!e.readonly?r+='&nbsp;<span class="required">*<\/span>':r=r.replace(/ /g,"&nbsp;")),new Element("th",{"class":i+"col-id-"+u,"data-col-id":u,html:r}).inject(y))}.bind(this)),this.columnsCheck.push(p),f.getElement("td.active").addClass("indicate").addClass("first"),f.store("status",s),f.addClass("loading").set("data-loadcount",l).set("row-loaded",0),Affinity.mobile&&f.getElement("td.indicate")){o=new Hammer(f,{domEvents:!0}),o.get("swipe").set({direction:Hammer.DIRECTION_HORIZONTAL}),o.add(new Hammer.Press({event:"longpress",time:501}));o.on("panleft panright",this.mobileSelect);o.on("longpress",this.mobileSelect);o.on("tap",this.popupEditForm)}return(delete i,delete u,delete s,t)?y:(f.store("obscured",h),f)}return f.destroy(),"Message"in n.Attribute&&n.Attribute.Message.trim()!==""&&this.messageBucket.push(n.Attribute.Message.trim()),!1}}},updateRow:function(n,t,i,r){if(this.options.widgetDocument===undefined&&(this.options.widgetDocument=n),this.options.widgetDocument&&this.options.widgetDocument.hasOwnProperty("Children")&&typeOf(this.options.widgetDocument.Children==="array")&&t<this.options.widgetDocument.Children.length&&this.options.widgetDocument.Children[t]&&t<this.tableRows.length&&this.tableRows[t]){var f=this.returnNewRow(r,!0),u=this.tableRows[t],e=u.hasClass("new");f.inject(u,"after"),this.destroyRow(u),e||f.removeClass("new"),this.tbody&&this.tbody.getElements("tr.timesheet-row")&&this.tbody.getElements("tr.timesheet-row").length>0&&(this.tableRows=this.tbody.getElements("tr.timesheet-row")),t<this.options.widgetDocument.Children.length?this.options.widgetDocument.Children.splice(t,0,r):this.options.widgetDocument.Children.push(r)}},returnNewRow:function(n,t,i){var r=this.buildTableRow(n),tt,g,a,b,f,h,c,l,s;if(r){tt=i||this.options.timesheetType,g=this.tbody.getElements(".timesheet-row").length,this.docMessages=[],a=this.getMessages(n,"Row "+g+": "),a.length>0&&Array.each(a,function(n){this.docMessages.push(n)}.bind(this)),r.set("id",n.Name);var v=this.getAttributes(n),e=r.retrieve("status"),i="timesheet",it=!1,rt=!1,w=!1;if((n.hasOwnProperty("Data")&&n.Data.hasOwnProperty("IsFavourite")&&n.Data.hasOwnProperty("FavouriteName")&&n.Data.IsFavourite===!0&&n.Data.FavouriteName.trim()!==""&&(rt=!0,w=n.Data.FavouriteName.trim()),b=!1,v.readonly?Array.each(n.Children,function(n){n.Name&&n.Name.test(new RegExp("TsDate","gi"))&&(r.dataset.date=n.ValueAsString),n.Name&&n.Name.test(new RegExp("TimesheetId","gi"))&&(r.dataset.timesheetId=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeNo","gi"))&&(r.dataset.employeeNo=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeName","gi"))&&(r.dataset.employeeName=n.ValueAsString)}.bind(this)):Array.each(n.Children,function(n){n.Name&&n.Name.test(new RegExp("Comment","gi"))&&n.ValueAsString&&n.ValueAsString.test(new RegExp("Leave App","gi"))&&(b=!0),n.Name&&n.Name.test(new RegExp("TimesheetType","gi"))&&(i=this.getTimesheetType((n.Value+"").trim()),it=i==="allowance"?!0:!1),n.Name&&n.Name.test(new RegExp("TsDate","gi"))&&(r.dataset.date=n.ValueAsString),n.Name&&n.Name.test(new RegExp("TimesheetId","gi"))&&(r.dataset.timesheetId=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeNo","gi"))&&(r.dataset.employeeNo=n.ValueAsString),n.Name&&n.Name.test(new RegExp("EmployeeName","gi"))&&(r.dataset.employeeName=n.ValueAsString)}.bind(this)),b&&(v.readonly=!0),v.hidden)||(typeOf(t)==="null"||!t)&&e.isNewRow)return delete v,delete e,r.destroy(),delete r,!1;t&&!e.isNewRow&&(e.isNewRow=!0);var ut=n.AwardRows&&n.AwardRows.AwardRowIds&&typeOf(n.AwardRows.AwardRowIds)==="array"&&n.AwardRows.AwardRowIds.length>0?!0:!1,nt=!1,k=[],o=!1,ft=!1,u,y,p,d;return Array.each(n.Children,function(t){var i,f,o;if(t.hasOwnProperty("Name")&&typeof t.Name=="string"&&t.Name.trim()!==""&&t.Name.test(new RegExp("RowButton","gi"))&&t.Children.forEach(function(n){n.hasOwnProperty("Value")&&typeof n.Value=="object"&&n.Value.hasOwnProperty("ButtonType")&&typeof n.Value.ButtonType=="string"&&n.Value.ButtonType.trim()!==""&&n.Value.ButtonType.test(new RegExp("Awards","gi"))&&(nt=!0)}.bind(this)),u=!1,y=this.getAttributes(t),b&&(y.readonly=!0,t.Name.test(new RegExp("Bulk","gi"))&&(y.hidden=!0)),t.Description.InfoText&&(this.setupCorrectInfoColorForForwardedRowInMobileMode(t,e),k.push(t.Description)),p=t.Source?t.Source.PropertyName:t.Name.substring(t.Name.lastIndexOf("-")+1),p.test("AuthoriserId","gi")&&(ft=t.Value),!y.hidden)if(v.readonly||y.readonly){if(u=r.getElement(".col-id-"+p),u.set("html",this.getValue(t)),t.InputType){switch(t.InputType){case"Date":i=(new Date).parse(t.ValueAsString),Affinity.mobile?(u.addClass("mobile-date"),u.set("html",i.isValid()?i.format("%e&nbsp;%b<span>%Y<\/span>"):t.ValueAsString)):u.set("html",i.isValid()?i.format("%e/%m/%y"):t.ValueAsString);break;case"Time":i=(new Date).parse(t.ValueAsString),Affinity.mobile?(u.addClass("mobile-time"),u.set("html",i.isValid()?i.format("%l:%M<span>%p<\/span>").replace(/ /g,""):t.ValueAsString)):u.set("html",i.isValid()?i.format("%l:%M%p").replace(/ /g,""):t.ValueAsString)}delete i}t.InputType=="Lookup"&&typeOf(t.Value)!=="null"&&(u.addClass("has-display-lookup").addClass("display"),u.set("data-lookup-api",Affinity.lookupapi+"?ModelName="+t.Source.ModelName+"&PropertyName="+t.Source.PropertyName+"&key="+t.Value)),t.Description.HelpText&&(u.addClass("ui-has-tooltip"),u.set("data-tooltip",t.Description.HelpText),u.set("data-tooltip-dir","top")),d=this.zelosProcessor.getLookupDependancies(t),d&&(u.set("id",t.Name),v.readonly?(f=!1,o=[],"Source"in t&&typeOf(t.Value)==="array"&&(Array.each(n.Children,function(n){Array.each(d,function(t){n.Name.contains(t.updateFromPropertyName)&&o.push({LinkType:"Dependency",ModelName:"Timesheet",PropertyName:t.updateFromPropertyName,ValueAsString:n.ValueAsString})})}),f=Affinity.lookupapi.replace("/Get","/GetConditional")+"&ModelName="+t.Source.ModelName+"&PropertyName="+t.Source.PropertyName+'&parameters={"Parameter":'+JSON.stringify(o)+"}"),f&&(u.set("data-lookup-api",f),u.removeClass("has-dependencies"),u.addClass("has-display-lookup"))):this.zelosProcessor.setLookupDependancies(t,d,u))}else{if(a=this.getMessages(t,"Row "+g+' "'+t.Description.ShortText+'": '),a.length>0&&Array.each(a,function(n){this.docMessages.push(n)}.bind(this)),t.ElementType=="SectionHeading"&&t.Name.test("button","gi"))u=this.returnButtons(t,e.isNewRow,n.Name,e.status,ut,r.retrieve("obscured"),it,w),r.eliminate("obscured");else try{u=this.zelosProcessor.processChild(t)}catch(s){u=!1}u&&u.inject(r.getElement(".col-id-"+p)),t.Name.toLowerCase().contains("tsnet")&&u.getElement("input")&&u.getElement("input").addEvent("blur",function(n){var t=[],i;val=n.target.value,val.contains(".")||(i=val.split(/\D/),i.length>0&&Array.each(i,function(n){typeOf(parseInt(n,10))!=="null"&&t.push(n)})),t.length>1&&(n.target.value=Number.format(parseInt(t[0],10)+parseInt(t[1],10)/60,{decimals:2}))})}}.bind(this)),w&&k.push({InfoText:"From Favourite '"+w+"'",InfoIcon:"Pin",InfoColor:"yellow"}),f=!1,r.getElement("td.indicate").addClass(e.color),["new","pending","paid","approved","declined"].contains(e.status)&&(f=new Element("div",{html:e.icon,"class":"message-icon master "+e.color+" print-hidden ui-has-tooltip","data-tooltip":e.message}),f.inject(r.getElement("td.indicate"),"top")),n.Attribute&&n.Attribute.IsMessage&&n.Attribute.Message&&n.Attribute.Message!==""&&(f=new Element("div",{html:Affinity.icons.Warning,"class":"message-icon master yellow print-hidden ui-has-tooltip","data-tooltip":n.Attribute.Message}),f.inject(r.getElement("td.indicate"),"top"),r.getElement("td.indicate").removeClass(e.color).removeClass("red").addClass("yellow")),n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&n.Attribute.ErrorMessage!==""&&(f=new Element("div",{html:Affinity.icons.Warning,"class":"message-icon master red print-hidden ui-has-tooltip","data-tooltip":n.Attribute.ErrorMessage}),f.inject(r.getElement("td.indicate"),"top"),r.getElement("td.indicate").removeClass(e.color).removeClass("yellow").addClass("red")),e.status==="immutable"&&(f=new Element("div",{html:Affinity.icons.Lock,"class":"message-icon master grey print-hidden ui-has-tooltip","data-tooltip":"Can not be edited"}),f.inject(r.getElement("td.indicate"),"top")),n.Description.InfoText&&(h=n.Description.InfoText&&typeOf(n.Description.InfoText)==="string"&&n.Description.InfoText.trim()!==""?!0:!1,c=h?n.Description.InfoText:!1,l=Affinity.icons.getIcon(n.Description.InfoIcon,"PromptInfo"),infocolor=n.Description.InfoColor||"blue",s=new Element("div",{html:l,"class":"message-icon info "+infocolor+" print-hidden"}),s.inject(r.getElement("td.indicate"),"bottom"),h&&(s.addClass("ui-has-tooltip"),s.set("data-tooltip",c))),k.length>0&&(o=document.createElement("div"),o.classList.add("message-icons"),Affinity.mobile||r.querySelector("td.indicate").classList.add("has-message-icons"),r.querySelector("td.indicate").appendChild(o),Array.each(k,function(n){h=n.InfoText&&typeOf(n.InfoText)==="string"&&n.InfoText.trim()!==""?!0:!1,c=h?n.InfoText:!1,l=Affinity.icons.getIcon(n.InfoIcon,"PromptInfo"),infocolor=n.InfoColor||"blue",new RegExp("lock","gi").test(n.InfoIcon)?f?(f.set("class","message-icon master "+infocolor+" print-hidden"),f.set("html",l),h&&(f.addClass("ui-has-tooltip"),f.set("data-tooltip",c)),Affinity.mobile&&(infocolor==="blue-darker"||infocolor==="green"||infocolor==="red")&&r.getElement("td.indicate").removeClass("blue").addClass(infocolor)):(f=new Element("div",{html:l,"class":"message-icon master "+infocolor+" print-hidden"}),f.inject(o,"top"),h&&(f.addClass("ui-has-tooltip"),f.set("data-tooltip",c)),Affinity.mobile&&(infocolor==="blue-darker"||infocolor==="green"||infocolor==="red")&&r.getElement("td.indicate").removeClass("blue").addClass(infocolor)):n.InfoText&&(s=new Element("div",{html:l,"class":"message-icon info "+infocolor+" print-hidden"}),s.inject(o,"bottom"),h&&(s.addClass("ui-has-tooltip"),s.set("data-tooltip",c)),h=n.InfoText&&typeOf(n.InfoText)==="string"&&n.InfoText.trim()!==""?!0:!1,c=h?n.InfoText:!1,l=Affinity.icons.getIcon(n.InfoIcon,"PromptInfo"),infocolor=n.InfoColor||"blue",["employeeMilaege","managerMileage"].contains(tt)&&(Affinity.mobile||n.InfoIcon.trim()!=="CodeP"||n.hasOwnProperty("InfoButtonType")||(n.InfoButtonType="Awards"),!Affinity.mobile&&n.hasOwnProperty("InfoButtonType")&&n.InfoButtonType.trim()!==""&&(s.classList.add("convert-to-button"),s.dataset.type=n.InfoButtonType,s.dataset.color=infocolor)),Affinity.mobile&&(infocolor==="blue-darker"||infocolor==="green"||infocolor==="red")&&r.getElement("td.indicate").removeClass("blue").addClass(infocolor))}.bind(this))),o&&o.querySelector(".convert-to-button")&&o.querySelectorAll(".convert-to-button").forEach(function(n){(Affinity.isAwardsPopupEnabled()&&n.dataset.type==="Awards"&&nt||n.dataset.type!=="Awards")&&(n.classList.remove("convert-to-button","blue",n.dataset.color),n.classList.add("as-button","color-white","bg-"+n.dataset.color,"as-button-type-"+n.dataset.type.toLowerCase()),n.removeAttribute("data-color"),n.addEventListener(Affinity.events.click,this.buttonClicked),o.appendChild(n))}.bind(this)),nt&&o&&Affinity.isAwardsPopupEnabled()&&o.querySelector(".as-button-type-awards")&&o.appendChild(o.querySelector(".as-button-type-awards")),e.isNewRow&&(r.addClass("new"),r.getElement(".check input")&&(r.getElement(".check input").checked="checked")),r}return!1},setupCorrectInfoColorForForwardedRowInMobileMode:function(n,t){Affinity.mobile&&(n.Description.InfoText.indexOf("assigned to")>-1&&t.status!=="approved"&&t.status!=="declined"?n.Description.InfoColor="blue-darker":n.Description.InfoText.indexOf("assigned to")>-1&&(t.status==="approved"||t.status==="declined")&&(n.Description.InfoColor=t.color))},forceRowReadOnly:function(n,t){if(this.setMissingDefaultAsReadOnly){var f=n.getElements("td"),r,u,i;n.removeClass("modified"),Array.each(f,function(f){f.hasClass("active")?(f.getElement(".message-icon.master")&&(f.getElement(".message-icon.master").removeClass("orange").removeClass("red").removeClass("green").removeClass("blue").removeClass("light-blue").addClass("grey").set("html",Affinity.icons.Lock),typeOf(t)==="string"&&t.trim()!==""&&(Affinity.UI.Tooltips.Remove(f.getElement(".message-icon.master")),f.getElement(".message-icon.master").addClass("ui-has-tooltip").set("data-tooltip","Row is locked because "+t),Affinity.UI.Tooltips.Process())),n.getElement("td.indicate")&&n.getElement("td.indicate").removeClass("orange").removeClass("red").removeClass("green").removeClass("blue").removeClass("light-blue").addClass("grey").addClass("grey"),(f.hasClass("buttons")||f.hasClass("check"))&&(f.empty(),f.removeClass("buttons").removeClass("check")),f.getElement("input")&&(r=f.getElement("input").value,f.getElement(".subhidden")?(u=f.getElement(".subhidden").getChildren()[0],i=u.retrieve("widget"),i&&"destroy"in i&&i.destroy()):f.empty(),f.set("html",r))):f.empty()}.bind(this)),n.getParent("tbody").getElements("tr.modified").length===0&&this.delUnload()}},selectAllRows:function(n){Array.each(this.tbody.getElements(".check input"),function(t){t.checked=n.target.checked?!0:!1})},cleanFavData:function(n,t){var i=t!==undefined?t:this.options.widgetDocument;return(Array.each(i.Children,function(n,t){var r={};Object.keys(n.Data).forEach(function(t){t!=="IsFavourite"&&t!=="FavouriteName"&&t!=="FavouriteType"&&(r[t]=n.Data[t])}),n.Data=r,i.Children[t].Data=r,Array.each(n.Children,function(n,r){n.Name.test(/RowButton/gi)&&Array.each(n.Children,function(n,u){n.Value.ButtonType==="Favourite"&&(n.Value.Pressed=!1,n.ValueAsString=JSON.stringify(n.Value),i.Children[t].Children[r].Children[u].Value=n.Value,i.Children[t].Children[r].Children[u].ValueAsString=n.ValueAsString)}.bind(this))}.bind(this))}.bind(this)),t!==undefined)?i:(this.options.widgetDocument=i,!0)},reduceBulkRows:function(){var n=parseInt(this.userData.employeeNumber),t=parseInt(this.currentSearchEmployee?this.currentSearchEmployee:n),r=Affinity.login.areas.Timesheet.IsEmployee,i=n!==t?!0:Affinity.login.areas.Timesheet.IsManager,u=this.cleanFavData();return Array.each(this.options.widgetDocument.Children,function(n,t){var o,r=!1,f=!1,e="",u=-1;Array.each(n.Children,function(n,t){n.Name.test(/TimesheetId/gi)&&(o=n.ValueAsString,r=this.options.target.getElement("tr.timesheet-row."+o)||!1,f=r&&r.hasClass("modified")?!0:!1),n.Name.test(/TsStatus/gi)&&(e=n.ValueAsString.toLowerCase()),n.Name.test(/Bulk/gi)&&(u=t)}.bind(this)),r&&(i?e.test(new RegExp("decline|approve|paid","gi"))&&!f&&(r.getElement("td.check input")&&(r.getElement("td.check input").checked=!1),this.options.widgetDocument.Children[t].Children[u]&&(this.options.widgetDocument.Children[t].Children[u].Value=!1,this.options.widgetDocument.Children[t].Children[u].ValueAsString="False")):e.test(new RegExp("submit|decline|approve|paid","gi"))&&!f&&(r.getElement("td.check input")&&(r.getElement("td.check input").checked=!1),this.options.widgetDocument.Children[t].Children[u]&&(this.options.widgetDocument.Children[t].Children[u].Value=!1,this.options.widgetDocument.Children[t].Children[u].ValueAsString="False")))}.bind(this)),!0},hasRowChangedDelay:!1,changedFieldsMessage:"",getFirstCellvalue:function(n){var u=this.thead.getFirst("th.active").get("data-col-id"),t=n.getElement(".col-id-"+u),r=!1,i;return t.getElement(".widget")?(i=t.getElement(".widget").getWidget(),"getValue"in i&&(r=i.getValue())):t.getElement("input[type=hidden]")?r=t.getElement("input[type=hidden]").value:t.getChildren().length===0&&(r=t.get("html")),delete u,delete t,delete i,r},changeCount:0,hasChanges:function(){var n,i,e,r,u,o,s,h,c,f,t;if(this.isViewActive())return Affinity.timesheets.init.view&&(Affinity.timesheets.init.view==="managerMileage"||Affinity.timesheets.init.view==="employeeMilaege")?(n=[],n.append(this.tbody.getElements("tr.modified")),n.append(this.tbody.getElements("tr.new")),n.length>0?(f=this.tbody.getElements("tr.timesheet-row"),this.changedFieldsMessage="",t=[],Array.each(n,function(n){i=this.getFirstCellvalue(n),n.getElement(".message-icon.default-issue")&&n.getElement(".message-icon.default-issue").destroy(),n.getElement(".check input")&&(n.getElement(".check input").checked="checked"),this.setMissingDefaultAsReadOnly?function(n,t,i,f){Array.each(t,function(r,u){r.test(new RegExp("Row "+(i.indexOf(n)+1)+(f?" ("+f+")":""),"gi"))&&t.splice(u,1)}.bind(this)),n.getElement(".cant-select-default")&&!n.hasClass("new")?(e=n.getElements(".cant-select-default"),r=e[0].getParent("tr"),u=[],Array.each(e,function(t){o=t.getParent("td"),s=r.getElements("td").indexOf(o),h=n.getParent("table").getElement("thead tr").getElements("th")[s].get("html").stripTags(),u.push(h+' can not select the saved value of "'+t.get("data-default-value")+'" as you are not configured to see this value.')}.bind(this)),c=new Element("span",{"class":"message-icon default-issue info red print-hidden ui-has-tooltip","data-tooltip":u.join("<br />"),html:Affinity.icons.Warning}),c.inject(r.getElement("td.active"),"bottom"),this.forceRowReadOnly(r,u.join("<br />")),t.push("Row "+(i.indexOf(n)+1)+(f?" ("+f+")":"")+" has changes - a default cant be selected")):t.push("Row "+(i.indexOf(n)+1)+(f?" ("+f+")":"")+" has changes")}.delay(1e3,this,[n,t,f,i]):t.push("Row "+(f.indexOf(n)+1)+(i?" ("+i+")":"")+" has changes")}.bind(this)),t.length>0&&(this.changedFieldsMessage="\n"+t.join("\n")),n=i=t=f=null,Affinity.UI.Tooltips.Process(),!0):(n=null,!1)):!1},getChangeMessage:function(){return this.changedFieldsMessage},hasRowChanged:function(n){var t=n&&"getParent"in n&&n.getParent("tr")||!1;t&&(clearTimeout(this.hasRowChangedDelay),this.hasRowChangedDelay=this.checkRowDiff.delay(250,this,[t]))},checkRowDiff:function(n){var t=n.retrieve("status"),i=!1;return this.options.target.getElements("tr").contains(n)?typeof t=="undefined"?!1:(Array.each(n.getElements("input,select,textarea"),function(n){n.hasChanged()&&(i=!0)}.bind(this)),n.getElement("td.indicate").removeClass("modified").removeClass("none").removeClass("blue").removeClass("green").removeClass("red").removeClass("orange"),i?n.getElement("td.indicate")&&(n.addClass("modified"),n.getElement(".check input")&&(n.getElement(".check input").checked="checked"),n.hasClass("new")||(n.getElement("td.indicate").removeClass("none").removeClass("blue").removeClass("green").removeClass("red").addClass("orange"),n.getElement("td.indicate").getElement(".message-icon.master")?n.getElement("td.indicate").getElement(".message-icon.master").removeClass("blue").removeClass("green").removeClass("red").addClass("orange").addClass("hourglass").set("html",Affinity.icons.Hourglass):new Element("div",{html:Affinity.icons.Hourglass,"class":"message-icon master orange hourglass print-hidden"}).inject(n.getElement("td.indicate"),"top")),n.getElement("input[type=checkbox]")&&(n.getElement("input[type=checkbox]").checked=!0),n.addClass("modified")):n.getElement("td.indicate")&&(n.getElement("td.indicate").removeClass("none").removeClass("blue").removeClass("green").removeClass("orange"),n.getElement("td.indicate .message-icon.hourglass")&&(t.icon!==""?n.getElement("td.indicate .message-icon.hourglass").removeClass("hourglass").removeClass("orange").addClass(t.klass).set("html",t.icon):n.getElement("td.indicate .message-icon.hourglass").destroy()),n.getElement("td.indicate").addClass(t.color),!n.getElement("td.indicate").hasClass("new")&&n.getElement("input[type=checkbox]")&&(n.getElement("input[type=checkbox]").checked=!1),n.removeClass("modified")),this.hasChanges()?this.setUnload():this.delUnload(),i):!1},getWidgetDocument:function(){return this.options.widgetDocument},putWidgetDocument:function(n){return this.options.widgetDocument=n,n},updateWidgetDocument:function(){var n;return Array.each(this.options.widgetDocument.Children,function(t,i){n=this.tableRows[i],Array.each(t.Children,function(t,r){this.zelosProcessor.readField(this.options.widgetDocument,i,r,t,n)}.bind(this))}.bind(this)),delete n,this.options.widgetDocument},getWidgetDocumentRow:function(n){return this.options.widgetDocument.Children[n]?this.options.widgetDocument.Children[n]:!1},putWidgetDocumentRow:function(n,t,i){var u=this.returnNewRow(t),f,e,r,o;if(u){for(this.options.widgetDocument.Children[n]?(f=this.tbody.getElements("tr.timesheet-row")[n],this.options.widgetDocument.Children[n]=t,u.inject(f,"after"),f.destroy()):n<0?(this.options.widgetDocument.Children.unshift(t),u.inject(this.tbody,"top")):(this.options.widgetDocument.Children.push(t),u.inject(this.tbody,"bottom")),e="none",r=0;r<t.Children.length;r++)if(t.Children[r].Name.test("TimesheetId","gi")){e=t.Children[r].ValueAsString;break}if(o=this.tbody.getElement("."+e),o&&this.tbody.getElements("tr.timesheet-row")[n]!==o){this.refresh(null,i),delete f,delete r,delete e;return}delete r,delete e,this.processUI(),delete f}return u},delWidgetDocumentRow:function(n){if(this.options.widgetDocument.Children[n]){this.options.widgetDocument.Children.splice(n,1),this.debug&&(console.log("%cRemove Row Element","background: #ffd484; color: white"),console.time("Remove Row Element"));var t=this.tbody.getElements("tr.timesheet-row")[n];t.parentNode.removeChild(t),this.debug&&(console.timeEnd("Remove Row Element"),console.log("%c\tRow Element Removed","background: #ffd484; color: white;"))}this.processUI()},updateWidgetDocumentRow:function(n){var t=this.tbody.getElements("tr.timesheet-row")[n];return Array.each(this.options.widgetDocument.Children[n].Children,function(i,r){this.zelosProcessor.readField(this.options.widgetDocument,n,r,i,t)}.bind(this)),delete t,this.options.widgetDocument.Children[n]},returnDocument:function(){return this.updateWidgetDocument(),this.getWidgetDocument()},mobileFilter:["TsCode","ProjectId","TsCost","ResourceCode","AuthoriserId","CostElement1","CostElement2","CostElement3","CostElement4"],getTimesheetType:function(n){switch(n){case"1":return"timesheet";case"2":return"allowance"}return"timesheet"},getAttributes:function(n){var t=n;if(Affinity.mobile&&Affinity.appname==="timesheets"&&Affinity.timesheets.init.view&&["employeeMilaege","managerMileage"].contains(Affinity.timesheets.init.view)){if(t.Name.test(new RegExp("Comment","gi"))||t.Name.test(new RegExp("BulkProcess","gi"))||t.Name.test(new RegExp("Submit","gi"))||t.Name.test(new RegExp("RowButton","gi"))||t.Layout.Rank>2&&t.Source&&t.Source.PropertyName&&this.mobileFilter.contains(t.Source.PropertyName))return{readonly:!0,hidden:!0,required:!1};if(t.Attribute&&!t.Attribute.IsHidden)return{readonly:!0,hidden:!1,required:!1}}return{readonly:n.Attribute&&n.Attribute.IsReadOnly?n.Attribute.IsReadOnly:!1,hidden:n.Attribute&&n.Attribute.IsHidden?n.Attribute.IsHidden:!1,required:n.Attribute&&n.Attribute.IsRequired?n.Attribute.IsRequired:!1}},getValue:function(n){var i=n.Value==null||n.Value==undefined||n.Value=="undefined"?"":n.Value,t;if(n.Name=="Hours"&&(i=parseFloat(i).round(1)),typeOf(i)==="array")for(t=0;t<n.Value.length;t++)if(typeOf(n.Value[t])==="object"&&n.Value[t].selected){if(n.Value[t].display){i=n.Value[t].display;break}if(n.Value[t].value){i=n.Value[t].value;break}}return i},mobileSelect:function(n){Affinity.stopHammerEvent(n);var t=n.target.get("tag")==="tr"?n.target:n.target.getParent("tr"),r=this.tableRows.indexOf(t),e=this.options.widgetDocument.Children[r];if(t.getElement("td.check")){var u=t.getElement("td.active.indicate"),f=t.getElement("td.check"),i=t.hasClass("selected");switch(n.type){case"longpress":i?(u.removeClass("selected"),t.removeClass("selected"),i=!1):(u.addClass("selected"),t.addClass("selected"),i=!0);break;case"swipeleft":case"panleft":u.removeClass("selected"),t.removeClass("selected"),i=!1;break;case"swiperight":case"panright":u.addClass("selected"),t.addClass("selected"),i=!0}Array.each(this.options.widgetDocument.Children[r].Children,function(n,t){n.Source&&n.Source.PropertyName&&n.Source.PropertyName===f.get("data-col-id")&&(this.options.widgetDocument.Children[r].Children[t].Value=i,this.options.widgetDocument.Children[r].Children[t].ValueAsString=i.toString().capitalize())}.bind(this))}},formElement:!1,duplicateTimesheet:function(n){var i,r,t;Array.each(this.options.widgetDocument.Children[n].Children,function(n){n.Name.test("TimesheetId","gi")&&(i=n.ValueAsString),n.Name.test("EmployeeNo","gi")&&(r=n.ValueAsString),n.Name.test("TSDate","gi")&&(t=Date.parse(n.ValueAsString))}),this.addRows(t,t,r,i)},popupEditForm:function(n){var r=n.target.get("tag")==="tr"?n.target:n.target.getParent("tr");if(r){var u=this.tableRows.indexOf(r),i=this.options.widgetDocument.Children[u],t={target:this.formElement,onSave:this.refresh,originDoc:i,originRow:r,originRowIndex:u,updateOnChange:this.updateRow,refreshBehind:this.refresh,duplicateTimesheet:this.duplicateTimesheet};i&&(this.formElement||(this.formElement=new Element("div",{"class":"timesheet-edit-form"})),this.formElement.empty(),t.target=this.formElement,i.hasOwnProperty("Children")&&typeOf(i.Children)==="array"&&i.Children.length>0&&Array.each(i.Children,function(n){n.Name.toLowerCase().contains("timesheetid")&&(t.timesheetId=n.Value),n.Name.toLowerCase().contains("employeeno")&&(t.employeeNumber=n.Value)}),(t.timesheetId===-1||t.timesheetId==="-1")&&(t.timesheetId=!1,delete t.timesheetId),new ZelosWidgetTimesheetEditForm(t))}},destroyRow:function(n){this.debug&&(console.log("%cDestroy Single Row","background: orange; color: white"),console.time("Destroy Single Row"));var t,i=n.get("id"),r=this.tbody.getElements("tr.timesheet-row").indexOf(n);Array.each(n.getElements("input,textarea,select,.button"),function(n){if(n.hasClass("widget"))try{t=n.retrieve("widget"),"destroy"in t&&(t.destroy(),t=null)}catch(i){}n.removeEvents()}.bind(this)),n.removeEvents(),this.delWidgetDocumentRow(r),document.getElements(".row-ref-"+i).destroy(),this.debug&&(console.timeEnd("Destroy Single Row"),console.log("%c\tSingle Row Destroyed","background: orange; color: white")),this.checkNoRows(),this.setTableClass()},destroyRows:function(){return this.debug&&(console.log("%cDestroy Rows","background: orange; color: white; font-size: large"),console.time("Destroy Rows")),Array.each(this.tbody.getElements("tr.timesheet-row"),function(n){this.destroyRow(n)}.bind(this)),this.thead.empty(),this.tfoot&&this.tfoot.empty(),this.debug&&(console.timeEnd("Destroy Rows"),console.log("%c\tRows Destroyed","background: orange; color: white; font-size: large")),this.checkNoRows(),this.setTableClass(),!0},destroy:function(){this.options.parentForm.removeEvents(),window.removeEvent("keydown",this.checkKeyboardShortcut),this.destroyRows(),this.tbody.empty(),this.frowardWidget&&this.frowardWidget.destroy(),document.getElement(".button-menu-closer")&&(document.getElement(".button-menu-closer").removeEvent(Affinity.events.click,this.hideButtons),document.getElement(".button-menu-closer").destroy()),Affinity.views.detailed=null,delete Affinity.views.detailed}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetOverview={Version:"1.0.4.0",Sequence:10210,Name:"Timesheet Overview (Zelos Widget)",File:"ui.zelos.widget.timesheets.overview.js",Jira:"",Notes:"API structure change"},ZelosWidgetTimesheetOverview=new Class({debug:!1,Implements:[Options,Events],Binds:["switchUser","setDate","setEmployee","getDetails","populateOverview","getColor","showChartTooltip","hideTooltip","refresh","hasChanges","destroy"],options:{target:null,isManager:!1,fromDate:!1,toDate:!1,startDate:!1,getApi:"",profile:!1,doRibbon:!0},showAlerts:!0,overviewComplete:!1,selectedDate:!1,currentEmployee:!1,employeSelectTimer:!1,innerPies:[],colors:{ordinary:["blue","#44b5ec"],overtime:["orange","#ff6600"],leave:["green","#7abd2d"],holiday:["green","#7abd2d"],meal:["yellow","#ffbd00"],other:["grey","#888888"],submitted:["blue","#44b5ec"],approved:["green","#7abd2d"],declined:["red","#ff0000"],paid:["orange","#ff6600"]},initted:!1,initialize:function(n){this.setOptions(n),Affinity.views.overview=this,Affinity.DarkMode&&(this.colors.other[1]="#555"),this.container=new Element("div").inject(this.options.target),this.container.addClass("widget"),this.container.store("widget",this),this.isManager=this.options.isManager,this.fromDate=this.options.fromDate,this.toDate=this.options.toDate,this.startDate=this.options.startDate,this.userProfile=this.options.profile?this.options.profile:Affinity.login.profile,this.options.doRibbon&&(this.ribbonSection=new Element("div",{"class":"section shadow"}).inject(this.container),this.ribbonSectionBody=new Element("div",{"class":"section-body"}).inject(this.ribbonSection),this.ribbonBox=new Element("div").inject(this.ribbonSectionBody),this.payPeriodBox=new Element("div",{"class":"ts-pay-period"}).inject(this.ribbonBox,"before")),this.options.doRibbon&&(this.ribbon=new ZelosWidgetTimesheetRibbon({target:this.ribbonBox,onSelected:function(n){Affinity.AwardModels.closeAll(),this.selectedDate=n,this.fireEvent("dateChanged",n),this.overviewComplete&&this.getDetails()}.bind(this)})),this.options.doRibbon?(this.overviewSection=new Element("div",{"class":"section shadow"}).inject(this.container),this.overviewSectionBody=new Element("div",{"class":"section-body"}).inject(this.overviewSection),this.overviewBox=new Element("div",{"class":"ts-overview"}).inject(this.overviewSectionBody),this.isManager?(uialert({message:"Getting manager data",noClose:!0,showLoader:!0}),this.searchEmployee=new Element("select",{"class":"has-lookup","data-lookup-api":Affinity.zelosroot+"?api=timesheetAsManager/getEmployees","data-default-value":Affinity.login.profile.employeeNumber,"data-lookup-rules":"hasValue"}),this.searchEmployee.adopt(new Element("option",{html:Affinity.login.profile.commonName+" ("+Affinity.login.profile.employeeNumber+")",value:Affinity.login.profile.employeeNumber})),window.addEvent("gotUserWithPeriods",this.switchUser),this.searchEmployee.addEvent("emptyData",function(){uialert({message:"This user has no employees to manage.",showButtons:!0,noClose:!1,showLoader:!1})}.bind(this)),this.searchEmployee.addEvent("lookupComplete",function(n){typeOf(n)==="object"&&"defaultValue"in n&&(n.defaultValue+"").trim()!==(Affinity.login.profile.employeeNumber+"").trim()?(uialert({message:"Getting user details",noClose:!0,showLoader:!0}),Affinity.login.controller.getUser(n.defaultValue)):this.switchUser(Affinity.login.profile),this.searchEmployee.addEvent("change",function(){parseInt(this.userProfile.employeeNumber)!==parseInt(this.searchEmployee.value)&&(uialert({message:"Getting user details",noClose:!0,showLoader:!0}),Affinity.login.controller.getUser(this.searchEmployee.value))}.bind(this))}.bind(this)),new Element("form",{"class":"default-form",styles:{position:"relative",margin:"20px auto 0 auto",width:560}}).adopt(new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:"Select Employee"}),this.searchEmployee)).inject(this.ribbonBox,"after"),Affinity.lookups&&Affinity.lookups.processNew({jsonp:!0}),this.buildOverview()):(this.selectedDate=this.startDate,this.buildOverview(),this.switchUser(this.userProfile))):(this.selectedDate=this.startDate,this.overviewBox=new Element("div",{"class":"ts-overview"}).inject(this.container),this.buildOverview(),this.switchUser(this.userProfile)),this.initted=!0},switchUser:function(n){var f,t,i,r,u,e,o;(Affinity.prompts.hide(),Affinity.AwardModels.closeAll(),this.initted&&this.options.target&&this.options.target.hasClass("hidden"))||(this.userProfile=n,this.options.doRibbon&&(this.ribbonBox&&(f="",this.userProfile.previousPaydate&&this.userProfile.currentPaydate&&(t=Date.parse(this.userProfile.previousPaydate),t.isValid()||(t=!1),i=Date.parse(this.userProfile.currentPaydate),t.isValid()||(i=!1),t&&i&&(f="Pay Period from <strong>"+t.clone().increment("day",1).toFriendlyShort()+"<\/strong> to <strong>"+i.toFriendlyShort()+"<\/strong>")),this.payPeriodBox||(this.payPeriodBox=new Element("div",{"class":"ts-pay-period"}).inject(this.ribbonBox,"before")),this.payPeriodBox.set("html",f)),this.selectedDate||(this.selectedDate=new Date),this.userProfile.oldestTimesheetDate&&this.selectedDate>Date.parse(this.userProfile.newestTimesheetDate)&&(this.selectedDate=Date.parse(this.userProfile.newestTimesheetDate)),r=new URI(this.options.getApi),u=typeOf(r.parsed.query)==="null"?{}:r.parsed.query.parseQueryString(),typeOf(u.employeeno)!=="null"||this.options.getApi.contains("employeeno=")||(u.employeeno=this.userProfile.employeeNumber),r.parsed.query=Object.toQueryString(u),e=r.toString(),o={url:e,method:"get",returnKey:"DayDetail[0].Total"},this.selectedDate||(this.selectedDate=new Date),this.ribbon&&this.ribbon.reset({fromDate:Date.parse(this.userProfile.oldestTimesheetDate),toDate:Date.parse(this.userProfile.newestTimesheetDate),startDate:this.selectedDate,innerFromDate:t,innerToDate:i,valueApi:o})),this.getDetails())},setDate:function(n){return typeOf(n)==="date"&&n.isValid()&&(this.options.startDate=this.selectedDate=n.clone(),this.ribbon&&this.ribbon.setDate(n.clone(),!1)),n.toFriendlyShort()},useEmployeeNum:!1,setEmployee:function(n){return this.useEmployeeNum=n,!0},detailsLoader:!1,getDetails:function(){var i=new Date,f,t,n,o;if(Affinity.tooltips.hideAll(),this.detailsLoader&&this.detailsLoader.cancel(),f=this.selectedDate||this.options.startDate||!1,f){var e="",r=new URI(this.options.getApi),u=typeOf(r.parsed.query)==="null"?{}:r.parsed.query.parseQueryString();u.hasOwnProperty("api")&&(r=new URI(u.api),u=typeOf(r.parsed.query)==="null"?{}:r.parsed.query.parseQueryString()),u.hasOwnProperty("employeeNo")&&(e="employeeNo="+u.employeeNo),t=new URI(this.options.getApi.replace(e,"")),n=typeOf(t.parsed.query)==="null"?{}:t.parsed.query.parseQueryString(),this.useEmployeeNum?(n.employeeNo=this.useEmployeeNum,this.useEmployeeNum=!1):n.employeeNo=this.userProfile.employeeNumber,n.fromDate=f.format("%d.%b.%Y"),n.toDate=n.fromDate,n.ran=String.uniqueID(),t.parsed.query=Object.toQueryString(n),o=t.toString(),log("&#x2794; attempting overview getDetails ("+i.elapsed()+") ..."),this.detailsLoader=new Request.JSON({url:o,method:"get",onRequest:function(){this.options.doRibbon&&this.showAlerts&&uialert({message:"Loading details",noClose:!0,showLoader:!0})}.bind(this),onError:function(n){log("&#x2718; attempted overview getDetail failed with errors ("+i.elapsed()+") - "+n),this.showAlerts&&uialert({message:"Details Failed.<br />"+n})}.bind(this),onFailure:function(n){log("&#x2718; attempted overview getDetail failed ("+i.elapsed()+") - "+n.statusText),this.showAlerts&&uialert({message:"Details Failed.<br />"+n.statusText})}.bind(this),onComplete:function(n){JSON.Unauthorized(n,"overview, getDetails - "+t.toString())||(typeOf(n)==="object"&&n.hasOwnProperty("error")&&n.error!=="null"?(log("&#x2718; attempted overview getDetail succeeded with errors ("+i.elapsed()+") - "+n.error),this.showAlerts&&uialert({message:"Details Failed.<br />"+n.error})):(log("&#x2714; attempted overview getDetail succeeded ("+i.elapsed()+")"),window.fireEvent("OverviewUpdated",n),JSON.stringify(n)!==JSON.stringify(this.data)?(this.data=n,this.populateOverview(n)):this.fireEvent("detailsLoaded"),this.options.doRibbon&&Affinity.prompts.hide()))}.bind(this)}).get()}},buildOverview:function(){this.overviewComplete=!0,this.overviewLeft=new Element("div",{"class":"ts-overview-left"}).inject(this.overviewBox),this.overviewRight=new Element("div",{"class":"ts-overview-right"}).inject(this.overviewBox),this.mouseOverData=!1,this.totalsPieChart=!1,this.overviewPieBox=new Element("div",{"class":"pie"}).inject(this.overviewRight),this.totalsPieCanvas=new Element("canvas",{width:150,height:150}).inject(this.overviewPieBox),this.totalsPieCanvas.onmousemove=function(n){this.totalsPieChart&&(this.mouseOverData=this.totalsPieChart.getSegmentsAtEvent(n))}.bind(this),this.totalsPieCanvas.addEvent("mousemove",this.showChartTooltip),this.totalsPieCanvas.addEvent("mouseleave",this.hideTooltip),this.overviewPieTotal=new Element("div",{"class":"label",html:""}).inject(this.overviewPieBox).fade("hide"),this.options.doRibbon&&(this.editButton=new Element("div",{"class":"button large blue w-icon",html:"<span>"+Affinity.icons.Pencil+"<\/span><span>Manage<\/span>"}).inject(this.overviewRight),this.editButton.addEvent(Affinity.events.click,function(){window.fireEvent("TSSwitchView",{view:"dualdetail",date:this.selectedDate,profile:this.userProfile})}.bind(this))),this.tooltip=new Element("div",{"class":"chart-tooltip hidden"}).inject(this.container,"bottom"),this.fireEvent("complete"),this.selectedDate&&this.getDetails()},getColor:function(n,t){var i=n.replace(/ -/g,"").trim().toLowerCase(),r=i;switch(!0){case i.contains("ordinary"):case i.contains("normal"):r="ordinary";break;case i.contains("overtime"):case i.contains("double"):case i.contains("t1."):case i.contains("t2."):case i.contains("callout"):r="overtime";break;case i.contains("leave"):case i.contains("lsl"):r="leave";break;case i.contains("meal"):r="meal";break;case i.contains("holiday"):r="holiday";break;case i.contains("submitted"):r="submitted";break;case i.contains("approved"):r="approved";break;case i.contains("declined"):r="declined";break;case i.contains("paid"):r="paid";break;default:r="other"}return typeOf(t)!=="null"&&t===!0?this.colors[r]?this.colors[r][0]:this.colors.other[0]:this.colors[r]?this.colors[r][1]:this.colors.other[1]},populateOverview:function(n){if(this.overviewLeft&&this.overviewLeft.empty(),this.overviewPieTotal&&this.overviewPieTotal.fade("out"),this.totalsPieCanvas){this.totalsPieCanvas.getContext("2d").clearRect(0,0,150,150),this.totalsPieChart&&this.totalsPieChart.destroy(),this.totalsPieChart=!1,this.mouseOverData=!1,Array.each(this.innerPies,function(n){n.canvas.removeEvents(),n.canvas.getContext("2d").clearRect(0,0,60,60),n.chart.destroy()}.bind(this)),this.innerPies=[];var o,s,r,i,h,y,t,c,l,f,u,e,p,a=[],v=0,w=["Submitted","Approved","Declined","Paid","Other"];n.DayDetail[0].Details.length===0?(s="",t={},t.label="NULL",t.color=this.colors.other[1],t.highlight=this.colors.other[1],t.value=100,a.push(t),u=new Element("div",{"class":"pie"}),o=new Element("div",{"class":"ts-overview-bar"}).adopt(new Element("div",{"class":"value grey"}).adopt(new Element("div",{"class":"num",html:"..."}),new Element("div",{"class":"unit",html:""})),new Element("div",{"class":"label",html:"No Records"}),u).inject(this.overviewLeft),Affinity.mobile&&u.inject(o,"top")):(s=Number.round(n.DayDetail[0].Total,2),Array.each(n.DayDetail[0].Details,function(n,s){r=0,i=n.UnitType.trim().toLowerCase(),i=i.charAt(i.length-1)==="s"?i.substr(0,i.length-1):i,l=[],Object.each(n,function(n,t){w.contains(t.trim())&&parseFloat(n)>0&&(c=this.getColor(t,!1),f={},f.label=t.trim(),f.color=c,f.highlight=c,f.value=Number.round(parseFloat(n),2),l.push(f),t!=="Declined"&&(r+=parseFloat(n)))}.bind(this)),h=this.getColor(n.Name,!1),y=this.getColor(n.Name,!0),t={},t.label=n.Name,t.color=h,t.highlight=h,t.value=Number.round(r,2),a.push(t),u=new Element("div",{"class":"pie"}),o=new Element("div",{"class":"ts-overview-bar"}).adopt(new Element("div",{"class":"value "+y}).adopt(new Element("div",{"class":"num",html:r<1?(Number.round(r,2)+"").substr(1):Number.round(r,2)+"&nbsp;"}),new Element("div",{"class":"unit",html:i+(r==1?"":"s")})),new Element("div",{"class":"label",html:n.Name}),u).inject(this.overviewLeft),Affinity.mobile&&u.inject(o,"top"),function(n,t,i){try{e=new Element("canvas",{width:60,height:60,"data-index":i}).inject(t);try{p=new Chart(e.getContext("2d")).Pie(n,{segmentStrokeColor:Affinity.DarkMode?"#2f2f2f":"#efefef",animationSteps:25,showTooltips:!1}),this.innerPies[i]={canvas:e,chart:p},e.onmousemove=function(n){this.mouseOverData=this.innerPies[i].chart.getSegmentsAtEvent(n)}.bind(this),e.addEvent("mousemove",this.showChartTooltip),e.addEvent("mouseleave",this.hideTooltip)}catch(r){}}catch(r){}}.delay(500+v*250,this,[l,u,s]),v++}.bind(this))),function(){try{this.totalsPieChart=new Chart(this.totalsPieCanvas.getContext("2d")).Doughnut(a,{segmentStrokeColor:Affinity.DarkMode?"#2f2f2f":"#efefef",animationSteps:25,percentageInnerCutout:50,showTooltips:!1,onAnimationComplete:function(){this.overviewPieTotal&&(this.overviewPieTotal.set("html",s),this.overviewPieTotal.fade("in"))}.bind(this)})}catch(n){}this.fireEvent("detailsLoaded")}.delay(500+v*250,this)}this.showAlerts&&Affinity.prompts.hide()},tooltipFadeTimer:null,showChartTooltip:function(n){var r,t,i,u,f;this.mouseOverData&&(r=n.target.get("tag")=="canvas"?n.target:n.target.getParent("canvas"),t=this.mouseOverData,t&&t.length==1&&t[0].label!=="NULL"&&(clearTimeout(this.tooltipFadeTimer),i="",i+="<div>",i+='<span class="chart-tooltip-label">'+t[0].label+":&nbsp;<\/span>",i+='<span class="chart-tooltip-value inline right">'+t[0].value+"<\/span>",i+="<\/div>",this.tooltip.set("html",i).removeClass("hidden"),u=this.tooltip.getSize(),f=this.overviewBox.getParent(".section-body.has-inline")?r.getPosition(r.getParent(".pie")):r.getPosition(),this.tooltip.setStyles({top:f.y-u.y,left:n.client.x-u.x/2,opacity:1})))},hideTooltip:function(){this.tooltip.setStyle("opacity",0),clearTimeout(this.tooltipFadeTimer),this.tooltipFadeTimer=function(){this.tooltip.addClass("hidden")}.delay(250,this)},refresh:function(){if(log("&#171; refresh overview view &#187;"),this.selectedDate&&this.ribbon&&this.ribbon.getDate()&&"isValid"in this.ribbon.getDate()&&"isValid"in this.selectedDate&&this.ribbon.getDate().isValid()&&this.selectedDate.isValid()){var n=this.ribbon.getDate().sameDay(this.selectedDate);n?this.getDetails():this.ribbon.setDate(this.selectedDate)}else this.getDetails()},hasChanges:function(){return!1},destroy:function(){try{this.totalsPieCanvas&&(this.totalsPieCanvas.getContext("2d").clearRect(0,0,150,150),this.totalsPieCanvas.removeEvents())}catch(n){}try{this.totalsPieChart&&this.totalsPieChart.destroy(),Array.each(this.innerPies,function(n){n.canvas.removeEvents(),n.canvas.getContext("2d").clearRect(0,0,60,60),n.chart.destroy()}.bind(this)),this.options.doRibbon&&(this.editButton&&(this.editButton.removeEvents(),this.editButton.destroy()),this.ribbon&&this.ribbon.destroy()),this.container.eliminate("widget"),this.container.removeEvents(),this.container.destroy(),this.removeEvents()}catch(n){}Object.each(this,function(n,t){this[t]=null,delete this[t]}.bind(this)),Affinity.views.overview=null,delete Affinity.views.overview}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetReportAsPeriodTable={Version:"1.0.13.0",Sequence:10220,Name:"Report As Period Table (Zelos Widget)",File:"ui.zelos.widget.timesheets.period.js",Jira:"CT-1342",Notes:"Add lookup to PayPeriod select"},ZelosWidgetReportAsPeriodTable=new Class({Implements:[Options,Events],Binds:["cancelOtherRequests","reset","fillPaypointSelect","getSizes","doResize","setAdminWarningSize","hasChanges","refresh","getReport","loadReport","reportLoaded","changePayPoint","lastPeriod","nextPeriod","cleanName","insertReportRow","returnReportCells","updateWorschduleError","updateWorschduleRemaining","populateReportCells","filterRows","showDetails","hideDetails","showManageDetails","jumpToDetailed","bulkApprove","bulkDecline","bulkProcess","destroyGroup","destroyRows","destroy"],options:{target:null,startDay:0,showDays:14,publicHolidays:[]},unitRounding:2,initted:!1,initialize:function(n){var y,t,e,p,o,w,i,s,h,r,u,c,f;this.setOptions(n),this.options.target.empty();var l=new Element("div",{"class":"section shadow"}).inject(this.options.target),a=new Element("div",{"class":"section-body"}).inject(l),v=new Element("div",{"class":"default-form"}).inject(a);if(this.target=new Element("div").inject(v),this.loadMessage="Getting Data",Affinity.login.profile.admin&&(this.loadMessage="Getting Admin Data. This could take a couple of minutes."),Affinity.views.period=this,y=Affinity.appname,this.isManager=Affinity.login.areas.Timesheet.IsManager,this.isEmployee=Affinity.login.areas.Timesheet.IsEmployee,this.insertWorkSchedule=this.isManager&&Affinity.enableGridWorkSchedules?!0:!1,!("payPoints"in Affinity.login.profile)||typeOf(Affinity.login.profile.payPoints)!=="array"||!(Affinity.login.profile.payPoints.length>0)){t="payPoints is missing in user profile",this.isManager||this.isEmployee||(t+="User is neither an employee or manager\r\n"),e={message:"You do not have access to view this screen.<br />Please contact your administrator for assistance.<!--\r\n"+t+"-->"},window.fireEvent("logout",e);return}for(p=864e5,parseInt(Affinity.login.profile.employeeNumber,10)<5e6?(this.periodData=Affinity.login.profile.payPeriods,this.options.showDays=this.showDays=this.periodData.length,this.totalPeriods=this.periodData.periods.length,this.oldestPeriod=0-this.periodData.periodCurrentIndex,this.latestPeriod=this.totalPeriods-this.periodData.periodCurrentIndex):(this.totalPeriods=5,this.oldestPeriod=-3,this.latestPeriod=1),this.showDays=this.options.showDays,this.currentPayPeriod=0,this.currentPayPoint=!1,this.currentPayPointDisplay=!1,this.payPointSelect=new Element("select"),this.payPointSelect.addEvent("change",this.changePayPoint),this.target.addClass("timesheet-grid"),o=new Element("th",{"class":"timeslots",style:"width: "+this.midWidth}).adopt(new Element("div",{"class":"date-heading"}),new Element("div",{"class":"date-headings"})),this.gridTotal=new Element("span",{"class":"total"+(Affinity.mobile?"":" left"),html:"0"}),this.gridTotalsContainer=new Element("td",{"class":"totals"}),this.noTimesheetsBox=new Element("div",{html:this.options.readOnly?"No Timesheets to view.":'No Timesheets. Use <span class="inline-desc-button"><span>'+Affinity.icons.AddToList+"<\/span> Add<\/span> top right."}),this.isDelegatingBox=new Element("span").inject(this.noTimesheetsBox),this.lastPeriodButton=new Element("span",{"class":"button blue w-icon-only last",html:'<span class="hidden"><\/span><span class="icon-arrow-left"><\/span>'}),this.nextPeriodButton=new Element("span",{"class":"button blue w-icon-only next",html:'<span class="hidden"><\/span><span class="icon-arrow-right"><\/span>'}),this.lastPeriodButton.addEvent(Affinity.events.click,this.lastPeriod),this.nextPeriodButton.addEvent(Affinity.events.click,this.nextPeriod),this.detailsBox=new Element("th",{"class":"details period-view",style:"width: "+this.leftWidth}),this.detailsButtonBox=new Element("div",{"class":"buttons"}).inject(this.detailsBox),this.lastPeriodButton.inject(this.detailsButtonBox),this.payPointSelectBox=new Element("div",{"class":"selects"}).inject(this.detailsBox),this.payPointSelect.inject(this.payPointSelectBox),this.searchFilterBox=new Element("div",{"class":"emp-filter"}).inject(this.detailsBox),this.searchBox=new Element("input",{type:"text",placeholder:"Filter Employee"}).inject(this.searchFilterBox),this.searchBox.addEvent("keyup",this.filterRows),w=new Element("td",{colspan:3}),this.table=new Element("table",{"class":"nostyles weekmode hourstype period-view",style:"width: "+this.tableWidth}).adopt(new Element("thead").adopt(new Element("tr").adopt(this.detailsBox,o,new Element("th",{"class":"buttons",style:"width: "+this.rightWidth}).adopt(this.nextPeriodButton)),new Element("tr").adopt(new Element("th",{"class":"details"}),new Element("th",{"class":"timeslots"}).adopt(new Element("div",{"class":"submitdays-buttons"})),new Element("th",{"class":"buttons"}))),new Element("tbody"),new Element("tbody",{"class":"hidden"}),new Element("tfoot")).inject(this.target),this.publicHolidays={},this.options.publicHolidays.length>0&&(Array.each(this.options.publicHolidays,function(n){i=Date.parse(n.Date),this.publicHolidays["d"+i.getTime()]=n.Description}.bind(this)),i=null),this.weekButtons=this.table.getElement(".submitweek-buttons"),this.submitdaysButtons=this.table.getElement(".submitdays-buttons"),this.totalRow=this.table.getElement(".totalsrow"),this.noRows=this.table.getElement(".norows"),this.submitcolumnbuttons=new Element("div",{"class":"submitdays-container hidden"}).set("tween",{duration:250}),this.submitcolumnbuttons.fade("hide"),this.managecolumnbuttons=new Element("div",{"class":"managedays-container hidden"}).set("tween",{duration:250}),r=0;r<this.showDays;r++)s=new Element("div",{"class":"timeslotTitle"}).setStyle("width",this.cellWidth),s.inject(this.submitcolumnbuttons),h=new Element("div",{"class":"timeslotTitle"}).setStyle("width",this.cellWidth),h.inject(this.managecolumnbuttons);this.rowTarget=this.table.getFirst("tbody"),this.dumpTarget=this.table.getLast("tbody"),this.dateHeading=this.table.getElement(".date-heading"),this.dateHeadings=this.table.getElement(".date-headings"),this.hoverBox=new Element("div",{"class":"ts-report-hover"}).inject(this.target,"bottom"),this.hoverBox.set("tween",{duration:250}),this.hoverBox.fade("hide"),Affinity.mobile&&(this.mobileFitersBox=new Element("div",{"class":"mobile-filters"}).inject(this.table,"before"),this.mobileDetailsBox=new Element("div",{"class":"mobile-details"}).inject(this.table,"before"),this.lastPeriodButton.inject(this.mobileDetailsBox),this.nextPeriodButton.inject(this.mobileDetailsBox),this.dateHeading.inject(this.mobileDetailsBox),this.payPointSelectBox.inject(this.mobileFitersBox),this.searchFilterBox.inject(this.mobileFitersBox)),window.addEvent("resize",this.doResize),this.initted=!0,this.filterData=[],this.reportLoader=new Request.JSON({onComplete:this.reportLoaded}),document.getElement(".period-manage-back")||(this.manageback=new Element("li",{"class":"period-manage-back blue u-blue hidden",html:'<span class="icon-arrow-left"><\/span><span>Back<\/span>'}),u=document.getElement(".section-nav .help")?document.getElement(".section-nav .help"):document.getElement(".section-nav .logout")?document.getElement(".section-nav .logout"):!1,u?this.manageback.inject(u,"before"):this.manageback.inject(document.getElement(".section-nav ul"),"after"),this.manageback.addEvent(Affinity.events.click,function(){Affinity.timesheets.init.doSwitchToPeriodView()}.bind(this))),this.adminWarning=!1,this.adminRefreshButton=!1,Affinity.login.profile.admin&&(this.adminRefreshButton=new Element("span",{"class":"admin-refresh button blue w-icon",html:'<span class="icon-cycle"><\/span><span>Refresh<\/span>'}).addEvent(Affinity.events.click,this.refresh),this.adminWarning=new Element("div",{"class":"hidden period-admin-warning",html:"<span><\/span>"}).adopt(new Element("span",{html:'<strong class="color-red">Warning: <\/strong>Data may be out of date.'}),this.adminRefreshButton,new Element("span",{html:" Refresh may take a couple of minutes to complete."})),new Element("tbody").inject(this.table,"top").adopt(new Element("tr").adopt(new Element("td",{colspan:3}).adopt(this.adminWarning)))),c=(Affinity.login.profile.companyNumber+"").toLowerCase().trim(),Affinity.betaComps.contains(c)?this.paypointRequest=new Request.JSON({url:Affinity.urlroot+"Api/GetToActionPaypoints",onSuccess:function(n){if(typeOf(n)==="array"&&n.length>0){this.payPointSelect.innerHTML="",new Element("option").inject(this.payPointSelect),Array.each(n,function(n){f=new Element("option",{value:n.Key,html:n.Value}),this.currentPayPoint||n.Key===null||(this.currentPayPoint=n.Key,this.currentPayPointDisplay=n.Value,f.set("selected","selected")),f.inject(this.payPointSelect)}.bind(this)),this.getReport(),this.fireEvent("complete");return}this.fillPaypointSelect()}.bind(this),onError:this.fillPaypointSelect,onFailure:this.fillPaypointSelect}).get():this.fillPaypointSelect()},fillPaypointSelect:function(){this.payPointSelect.innerHTML="",new Element("option").inject(this.payPointSelect),Array.each(Affinity.login.profile.payPoints,function(n){option=new Element("option",{value:n.Key,html:n.Value}),this.currentPayPoint||n.Key===null||(this.currentPayPoint=n.Key,this.currentPayPointDisplay=n.Value,option.set("selected","selected")),option.inject(this.payPointSelect)}.bind(this)),this.getReport(),this.fireEvent("complete")},cancelOtherRequests:function(){var n=!0;return Affinity.uiDisplayLookup&&(Affinity.uiDisplayLookup.cancelQueue(),Affinity.uiDisplayLookup.enabled=!0),Affinity.uiSelectLookup&&(Affinity.uiSelectLookup.cancelQueue(),Affinity.uiSelectLookup.enabled=!0),Affinity.UI.dependancyQueue&&(Affinity.UI.dependancyQueue.cancelQueue(),Affinity.UI.dependancyQueue.enabled=!0),Affinity.hasOwnProperty("ribbons")&&Affinity.ribbons.hasOwnProperty("widgets")&&typeOf(Affinity.ribbons.widgets)==="array"&&(n=Array.each(Affinity.ribbons.widgets,function(n){n!==null&&n.clear()})),!0},reset:function(){return this.filterData=[],this.rowTarget.getElements(".timeslot.report").removeEvents(),this.dumpTarget.getElements(".timeslot.report").removeEvents(),this.rowTarget.empty(),this.dumpTarget.empty(),this.gridTotalsContainer.empty(),this.dateHeadings.empty(),this.searchBox.value="","reset"},markEmployee:!1,refresh:function(n){var t=typeOf(n)==="boolean"&&!n?!1:!0;this.switchData&&this.switchData.hasOwnProperty("emp")&&(this.markEmployee=this.switchData.emp),this.manageback&&this.manageback.addClass("hidden"),t&&(uialert({message:this.loadMessage,noClose:!0,showLoader:!0}),this.getReport())},changePayPoint:function(){this.payPointSelect.value!==this.currentPayPoint&&(this.currentPayPoint=this.payPointSelect.value,this.currentPayPointDisplay=this.payPointSelect.getElements("option")[this.payPointSelect.selectedIndex].get("html"),this.getReport())},lastPeriod:function(){this.currentPayPeriod>this.oldestPeriod&&(this.currentPayPeriod--,this.getReport())},nextPeriod:function(){this.currentPayPeriod<this.latestPeriod&&(this.currentPayPeriod++,this.getReport())},forceFilter:!1,higlightReset:!1,getReport:function(){var t,i,n,r;this.cancelOtherRequests(),t=this.payPointSelect.value+"",i=this.searchBox.value+"",this.reset(),this.payPointSelect.value=t,this.searchBox.value=i,uialert({message:this.loadMessage,noClose:!0,showLoader:!0}),this.switchData&&(this.currentPayPeriod=parseInt(this.switchData.filters.period,10),this.currentPayPoint=parseInt(this.switchData.filters.payPoint,10),this.payPointSelect.value=this.switchData.filters.payPoint,this.searchBox.value="",this.forceFilter=!0,this.switchData=!1),this.currentPayPeriod===this.latestPeriod?this.nextPeriodButton.addClass("disabled"):this.nextPeriodButton.removeClass("disabled"),this.currentPayPeriod===this.oldestPeriod?this.lastPeriodButton.addClass("disabled"):this.lastPeriodButton.removeClass("disabled"),n={},n.payPoint=this.currentPayPoint,n.payPeriod=this.currentPayPeriod,r=Affinity.zelosroot+"?api=timesheetInfo/GetTimesheetTotalForEmployees&"+Object.toQueryString(n),this.loadReport(r)},loadReport:function(n){this.reportLoader.url=this.reportLoader.options.url=n,this.reportLoader.get()},reportLoaded:function(n){var h,t,u,e;if(uialert({message:"Processing Data",noClose:!0,showLoader:!0}),this.rowTarget.empty(),n.hasOwnProperty("success")&&n.success===!1){this.dateHeading.set("html","<span>"+Affinity.languages.english.application.timesheets.views.period.norows+"<\/span>"),this.doResize(),prompts.hide();return}if(!n.hasOwnProperty("employeeDaySummaryList")||n.hasOwnProperty("employeeDaySummaryList")&&!Array.isArray(n.employeeDaySummaryList)||n.hasOwnProperty("employeeDaySummaryList")&&Array.isArray(n.employeeDaySummaryList)&&n.employeeDaySummaryList.length===0){this.dateHeading.set("html","<span>"+Affinity.languages.english.application.timesheets.views.period.norows+"<\/span>"),this.doResize(),prompts.hide();return}if("PeriodStartDate"in n&&"PeriodEndDate"in n){var f=Date.parse(0),o=n.PeriodStartDate,s=n.PeriodEndDate,i=Date.parse(o),r=Date.parse(s);typeOf(i)==="date"&&i.isValid()&&!i.sameDay(f)&&typeOf(r)==="date"&&r.isValid()&&!r.sameDay(f)&&(this.reportFrom=i,this.reportTo=r,this.reportDate=this.reportFrom.clone(),this.showDays=Math.ceil((this.reportTo.getTime()-this.reportFrom.getTime())/864e5)+1,this.showDays>27?this.table.addClass("fullmonth"):this.table.removeClass("fullmonth"),this.getSizes(),this.setDateHeadings(this.reportFrom,this.reportTo))}if("employeeDaySummaryList"in n&&typeOf(n.employeeDaySummaryList)==="array"&&n.employeeDaySummaryList.length>0)for(t=0;t<n.employeeDaySummaryList.length;)h=this.insertReportRow(n.employeeDaySummaryList[t],t),t++;this.doResize(),(this.forceFilter||this.searchBox.value.trim()!=="")&&(this.forceFilter=!1,this.filterRows()),prompts.hide(),this.markEmployee&&(u=this.rowTarget.getParent("table").getElement("tr."+this.markEmployee),e=u.getPosition().y,window.scrollTo(0,e-10),clearTimeout(this.higlightReset),u.getElement(".highlighter").addClass("highlight"),this.higlightReset=function(){u.getElement(".highlighter").removeClass("highlight")}.delay(3e3,this),this.markEmployee=!1)},getGroupIdentifier:function(n){return(n.Displayname+"-"+n.EmployeeNo).toLowerCase().clean().trim().replace(/ /g,"-")},insertReportRow:function(n,t){var h=this.getGroupIdentifier(n),f=n.Displayname+" "+n.EmployeeNo,rt=h,e=f.toLowerCase(),i=new Element("tr",{id:h,"class":"timesheet-row "+e,"data-search-str":e,"data-row-index":t}).inject(this.rowTarget),o,s,d,tt,it,r,g,u;i.store("employee",f),i.store("emp-num",n.EmployeeNo),o=Object.clone(n),o.Hours=null,i.store("data",o);var c=new Element("div",{"class":"titlerow1 maintitle inline-no-wrap"}),l=new Element("div",{"class":"titlerow2 title"}),a=new Element("div",{"class":"titlerow3 subtitle"}),v=f,y=n.TotalTimesheets+" Timesheets",p="",ut=new Element("td",{"class":"timesheet-col details"}).adopt(new Element("div",{"class":"highlighter"}).adopt(c,l,a)).inject(i),w=new Element("div",{"class":"titlerow1 maintitle inline-no-wrap"}),b=new Element("div",{"class":"titlerow2 title"}),k=new Element("div",{"class":"titlerow3 subtitle"}),nt=new Element("div",{"class":"hide-on-desktop timesheet-mobile-details",style:"width:"+this.midWidth}).adopt(w,b,k);return c.set("html",v),l.set("html",y),a.set("html",p),w.set("html",v),b.set("html",y),k.set("html",p),this.filterData.push({search:e,row:i}),s=new Element("td",{"class":"timesheet-col timeslots"}).inject(i),nt.inject(s),d=new Element("td",{"class":"timesheet-col buttons"}).inject(i),new Element("span",{"class":"gtotal",html:""}).inject(d),tt=this.returnReportCells(s),it=this.populateReportCells(n),n.hasOwnProperty("Messages")&&n.Messages.trim()!==""&&(r=n.Messages.replace(/\r\n/gi,", ").split(", "),g=r.unique(),r=g.join("<br />"),i.querySelector(".details")&&(u=i.querySelector(".details"),u.classList.add("has-error","ui-has-tooltip"),u.dataset.tooltip=r,Affinity.tooltips.processTooltip(u))),!0},returnReportCells:function(n){var h=(new Date).clearTime(),t=this.reportFrom.clone().clearTime(),c=this.reportTo.clone().clearTime().increment("day",1),o=0,r,f,i,s,e,u=new Element("div",{"class":"timeslots-container"});for(u.inject(n);t.lessThan(c);)f=" row"+n.getParent("tr").get("data-row-index")+" col"+o,i=t.sameDay(h)?"timeslot today d-"+t.toSimple().clean().trim():"timeslot d-"+t.toSimple().clean().trim(),i+=f,i=typeOf(this.publicHolidays["d"+t.getTime()])!=="null"?i+" holiday":i,i+=" report",s=new Element("div",{"class":"icon-gift"}),e=new Element("input",{"class":f.trim(),type:"text",value:"-",autocomplete:"off"}),e.set("disabled","disabled"),r=new Element("div",{"class":i,"data-time":t.getTime()}).setStyles({width:this.cellWidth,height:this.cellHeight}).adopt(s,e).inject(u),r.store("date",t.clone()),t.increment("day",1),o++;if(this.insertWorkSchedule){r=new Element("div",{"class":"timeslot actual-total",html:"..."}).setStyles({width:this.wideCellWidth,height:this.cellHeight}).inject(u);var l=this.reportFrom.clone().format("%Y-%m-%d"),a=t.clone().decrement("day",1).format("%Y-%m-%d"),v=Affinity.login.profile.employeeNumber,y=Affinity.zelosroot+"?api=timesheetInfo/GetWorkScheduleTotal&employeeNo="+v+"&dateFrom="+l+"&dateTo="+a;r=new Element("div",{"class":"timeslot schedule display-lookup-el",html:"..."}).setStyles({width:this.wideCellWidth,height:this.cellHeight}).addEvent("lookupComplete",this.updateWorschduleRemaining).addEvent("lookupError",this.updateWorschduleError).inject(u),r=new Element("div",{"class":"timeslot schedule-remaining",html:"..."}).setStyles({width:this.doubleCellWidth,height:this.cellHeight}).inject(u)}return!0},updateWorschduleError:function(n){if(this.insertWorkSchedule){var i=0,t=n.target.getParent(".timeslots-container"),r=t.getElement(".actual-total"),u=t.getElement(".schedule-remaining");Array.each(t.getElements(".timeslot"),function(n){n.getElement("input")&&(val=n.getElement("input").value,val.trim()!==""&&(i+=parseFloat(val)))}.bind(this)),r.innerHTML=Number(i).format({decimals:this.unitRounding}),u.innerHTML="?"}},updateWorschduleRemaining:function(n){this.insertWorkSchedule&&function(n){var r=parseFloat(n.value),t=0,u=n.target.getParent(".timeslots-container"),o=u.getElement(".actual-total"),i=u.getElement(".schedule-remaining"),f=0,e,s;Array.each(u.getElements(".timeslot"),function(n){n.retrieve("data")&&(e=n.retrieve("data"),s=e.Approved+e.Submitted,t+=parseFloat(s))}.bind(this)),n.target.innerHTML=n.value,o.innerHTML=parseFloat(t).toFixed(this.unitRounding),f=(parseFloat(r-t).toFixed(this.unitRounding)+"").replace("-",""),r-t<0?(i.removeClass("over").addClass("under"),i.innerHTML="+"+f):r-t>0&&(i.removeClass("under").addClass("over"),i.innerHTML="-"+f),o.classList.add("loaded"),i.classList.add("loaded"),n.target.classList.add("loaded")}.delay(500,this,n)},populateReportCells:function(n){var v,t,s,r,h,u,f,y,p,e,c,l,i=this.reportDate.clone().clearTime(),w=i.clone(),a=0,b=this.getGroupIdentifier(n),o=document.id(b),k=o.getElement(".timeslots-container");if(Array.each(n.Hours,function(n){s="CallerToApprove"in n&&n.CallerToApprove===!0?!0:!1,r=s?!0:!1,h=r?!0:!1,v=".d-"+i.toSimple().clean().trim(),t=k.getElement(v),t&&(u=t.getElement("input"),i.sameDay(Date.parse(n.Day))?(f=parseFloat(n.Submitted),y=parseFloat(n.Approved),p=parseFloat(n.Declined),e=f+y+p,c="ApprovedAllowanceTimesheet"in n?parseFloat(n.ApprovedAllowanceTimesheet):!1,l="AllowanceTimesheet"in n?parseFloat(n.AllowanceTimesheet):!1,a+=e,u.value=Number(e).format({decimals:this.unitRounding}),t.classList.remove("att","msg","zero","orange","allowance"),e===0?(t.addClass("zero"),u.value=0):h=!0,(f>0||"Messages"in n)&&(s||(r=!0)),c&&l&&l-c>0&&t.addClass("allowance"),r&&t.addClass("att"),n.hasOwnProperty("Messages")&&f<=0&&t.addClass("msg"),h?(t.removeEvents(),t.addEvent(Affinity.events.over,this.showDetails),t.addEvent(Affinity.events.out,this.hideDetails),t.addEvent(Affinity.events.click,this.showManageDetails),t.store("data",Object.clone(n))):(t.removeEvents(),t.eliminate("data"))):(u.value=0,t.removeEvents(),t.eliminate("data"),t.classList.remove("att","msg","zero","orange","allowance"),t.classList.add("zero"))),t.classList.contains("zero")&&t.classList.remove("att","msg","orange","allowance"),i.increment("day",1)}.bind(this)),this.insertWorkSchedule){var d=w.clone().format("%Y-%m-%d"),g=i.clone().decrement("day",1).format("%Y-%m-%d"),nt=n.EmployeeNo,tt=Affinity.zelosroot+"?api=timesheetInfo/GetWorkScheduleTotal&employeeNo="+nt+"&dateFrom="+d+"&dateTo="+g;o.getElement(".timeslot.schedule").addClass("has-display-lookup").set("data-lookup-api",tt),Affinity.displaylookups.processNew({jsonp:!1})}return this.insertWorkSchedule||o.getElement(".gtotal").set("html",Number(a).format({decimals:this.unitRounding})),o.getElement(".titlerow3").set("html","Total Hours: "+Number(a).format({decimals:this.unitRounding})),!0},filterRows:function(){var n=this.searchBox.value.toLowerCase().clean().trim();n===""?Array.each(this.filterData,function(n){n.row.inject(this.rowTarget,"bottom")}.bind(this)):Array.each(this.filterData,function(t){t.search.test(new RegExp(n,"gi"))?t.row.inject(this.rowTarget,"bottom"):t.row.inject(this.dumpTarget)}.bind(this))},switchdata:!1,hoverData:!1,showDetails:function(n){var u=n.target.hasClass("timeslot")?n.target:n.target.getParent(".timeslot"),t=u.getParent("tr"),rt=t.retrieve("employee"),y=u.retrieve("date"),i=u.retrieve("data"),ct=t.retrieve("data"),e,a,nt,tt,ht;this.hoverData={emp:t.retrieve("emp-num"),date:y.clone(),data:Object.clone(i),cell:u},this.hoverBox.empty();var p=parseFloat(i.Submitted),w=parseFloat(i.Approved),b=parseFloat(i.Declined),k="LeaveHour"in i?parseFloat(i.LeaveHour):!1,d="MileageTimesheet"in i?parseFloat(i.MileageTimesheet):!1,ut="ApprovedAllowanceTimesheet"in i?parseFloat(i.ApprovedAllowanceTimesheet):0,l="AllowanceTimesheet"in i?parseFloat(i.AllowanceTimesheet):0,g=l-ut>0?!0:!1,ft=g?"red":"green",et=p+w+b,r=new Element("div",{"class":"box","data-date":y,"data-employee":rt});t=new Element("div",{"class":"row"}).inject(r),new Element("div",{html:"Total Timesheets","class":"label"}).inject(t),new Element("div",{html:i.Timesheets,"class":"value"}).inject(t),t=new Element("div",{"class":"row"}).inject(r),new Element("div",{html:"Total Hours","class":"label"}).inject(t),new Element("div",{html:Number(et).format({decimals:this.unitRounding}),"class":"value"}).inject(t),t=new Element("div",{"class":"row"}).inject(r),new Element("div",{html:"Submitted Hours","class":"label"}).inject(t),new Element("div",{html:Number(p).format({decimals:this.unitRounding}),"class":"value blue"}).inject(t),t=new Element("div",{"class":"row"}).inject(r),new Element("div",{html:"Approved Hours","class":"label"}).inject(t),new Element("div",{html:Number(w).format({decimals:this.unitRounding}),"class":"value green"}).inject(t),t=new Element("div",{"class":"row"}).inject(r),new Element("div",{html:"Declined Hours","class":"label"}).inject(t),new Element("div",{html:Number(b).format({decimals:this.unitRounding}),"class":"value red"}).inject(t),e=!1,k&&(t=new Element("div",{"class":"row border-top"}).inject(r),new Element("div",{html:"Leave Hours","class":"label"}).inject(t),new Element("div",{html:Number(k).format({decimals:this.unitRounding}),"class":"value "}).inject(t),e=!0),d&&(t=new Element("div",{"class":"row border-top"}).inject(r),new Element("div",{html:"Mileage Timesheets","class":"label"}).inject(t),new Element("div",{html:d,"class":"value "}).inject(t),e=!0),g&&l>0&&(t=new Element("div",{"class":"row allowances border-top"}).inject(r),new Element("div",{html:"Unit Count","class":"label"}).inject(t),new Element("div",{html:parseInt(l),"class":"value "+ft}).inject(t),e=!0),"Messages"in i&&typeOf(i.Messages)==="string"&&(a=i.Messages,(i.Messages.contains(",")||i.Messages.contains("\\r\\n"))&&(nt=i.Messages.replace(/\r\n/gi,", ").split(", "),tt=nt.unique(),a=tt.join("<br />")),t=new Element("div",{"class":"row"}).inject(r),new Element("div",{html:"Message","class":"label"}).inject(t),new Element("div",{html:a,"class":"value"}).inject(t)),t=new Element("div",{"class":"row content"+(e?" border-top":""),html:"(Click cell to Manage)"}).inject(r),this.hoverBox.fade("in"),this.hoverBox.adopt(r);var ot=window.getScroll(),s=u.getPosition(),st=u.getSize(),f=s.y,o=s.x+st.x,h=this.hoverBox.getSize(),it=window.getSize(),v=document.querySelector(".ts-dashboard-nav"),c={x:0,y:0};v&&(c.x=v.classList.contains("show")?(v.offsetWidth+10)*-1:-10,c.y=(document.querySelector(".section-header").offsetHeight+20)*-1),o+h.x>it.x&&(o=s.x-h.x+10,f+=20),f+h.y-ot.y>it.y&&(f=s.y-h.y-35),f=Math.ceil(f-61),o=Math.ceil(o),ht=this.hoverBox.setStyles({top:f+c.y,left:o+c.x})},hideDetails:function(){this.hoverBox.fade("out")},destroymanagerDetails:function(){Affinity.modal.modalbody.getElements(".button").removeEvents(),Affinity.modal.beforeClose=null},showManageDetails:function(n){if(typeOf(n)!=="null")try{n.stop()}catch(i){}var t=this.hoverBox.getElement(".box").clone();t.getElement(".allowances")&&t.getElement(".allowances").removeClass("hidden"),this.hideDetails(),function(){var i=parseFloat(this.hoverData.data.Submitted)>0,n,r,u,f;i="CallerToApprove"in this.hoverData.data?this.hoverData.data.CallerToApprove?i:!1:i,t.getLast("div").destroy(),t.addClass("ts-report-manage"),n=new Element("div",{"class":"row content title",html:t.get("data-employee")+" - "+Date.parse(t.get("data-date")).toFriendly()}).inject(t,"top"),n=new Element("div",{"class":"row content"}).inject(t),i&&(r=new Element("span",{"class":"button green w-icon",html:"<span>"+Affinity.icons.ThumbsUp+"<\/span><span>Approve Submitted<\/span><\/span>"}).inject(n),r.addEvent(Affinity.events.click,this.bulkApprove),u=new Element("span",{"class":"button red w-icon",html:"<span>"+Affinity.icons.ThumbsDown+"<\/span><span>Decline Submitted<\/span><\/span>"}).inject(n),u.addEvent(Affinity.events.click,this.bulkDecline)),(Affinity.timesheets.init.areas.ShowDualDetailView||Affinity.timesheets.init.areas.ShowDetailView||Affinity.timesheets.init.areas.ShowTeamView)&&(f=new Element("span",{"class":"button blue w-icon",html:"<span>"+Affinity.icons.User+"<\/span><span>Manage Details<\/span><\/span>"}).inject(n),f.addEvent(Affinity.events.click,this.jumpToDetailed)),Affinity.modal.clear(),Affinity.modal.adopt(t),Affinity.modal.show(),Affinity.modal.beforeClose=this.destroymanagerDetails}.delay(250,this)},jumpToDetailed:function(){if(window.scrollTo(0,0),Affinity.timesheets.init.switchData=Object.clone(this.hoverData),Affinity.timesheets.init.switchData.payPoint=this.currentPayPoint,Affinity.timesheets.init.switchData.excludeLocked=!1,Affinity.timesheets.init.switchData.forceReload=!0,this.manageback&&this.manageback.removeClass("hidden"),Affinity.modal.hide(),this.switchData=Object.clone(this.hoverData),this.switchData.filters={period:this.currentPayPeriod,payPoint:this.currentPayPoint,excludeLocked:!1,forceReload:!0},Affinity.viewSettings.reset()&&(Affinity.viewSettings.set("employeeNumber",this.hoverData.emp),Affinity.viewSettings.set("startDate",this.hoverData.date.clone()),Affinity.viewSettings.set("fromDate",this.hoverData.date.clone()),Affinity.viewSettings.set("toDate",this.hoverData.date.clone()),Affinity.login.userProfiles[this.hoverData.emp]&&Affinity.viewSettings.setProfileData(Affinity.login.userProfiles[this.hoverData.emp]),Affinity.viewSettings.filter.set("employee",this.hoverData.emp),Affinity.viewSettings.filter.set("fromDate",this.hoverData.date.clone()),Affinity.viewSettings.filter.set("toDate",this.hoverData.date.clone()),Affinity.viewSettings.filter.set("period",this.currentPayPeriod),Affinity.viewSettings.filter.set("payPoint",this.currentPayPoint),Affinity.viewSettings.filter.set("excludeLocked",!1),Affinity.viewSettings.filter.set("onlyManged",!1),Affinity.viewSettings.filter.set("forceReload",!0)),log("&#x22C8; period view attempting switch ..."),Affinity.timesheets.init.areas.ShowDualDetailView){if(Affinity.timesheets.init.hasOwnProperty("doSwitchToDualdetailView")){Affinity.timesheets.init.doSwitchToDualdetailView(),log("&#x22C8; period view switch to Dualdetail View ...");return}}else if(Affinity.timesheets.init.areas.ShowDetailView){if(Affinity.timesheets.init.hasOwnProperty("doSwitchToManagerView")){Affinity.timesheets.init.doSwitchToManagerView(),log("&#x22C8; period view switch to Manager View ...");return}}else if(Affinity.timesheets.init.areas.ShowTeamView&&Affinity.timesheets.init.hasOwnProperty("doSwitchToManagerView")){Affinity.timesheets.init.doSwitchToManagerView(),log("&#x22C8; period view switch to Manager Team View ...");return}log("&#x22C8; period view switch FAILED","color: red"),uialert({message:"You are not configured to have any manager views.",showButtons:!0})},bulkApprove:function(){this.bulkProcess("Approve",Affinity.icons.ThumbsUp,"green",3)},bulkDecline:function(){this.bulkProcess("Decline",Affinity.icons.ThumbsDown,"red",2)},bulkProcess:function(n,t,i,r){uiconfirm({message:"This will "+n+" all submitted timesheets on this day.<br />Anything already Approved or Declined will be ignored.<br />Continue?",noClose:!0,okText:n,okIcon:t,okColor:i,cancelText:"Do nothing",onOk:function(){var t={},i;t.employeeNo=this.hoverData.emp,t.date=this.hoverData.date.format("%d.%b.%Y"),t.fromStatus=0,t.toSTatus=r,i=Affinity.zelosroot+"?api=TimesheetAsManager/SetTimesheetStatus/&"+Object.toQueryString(t),i=Affinity.GetCacheSafePath(i),new Request.JSON({url:i,onError:function(){uialert({message:Affinity.languages.english.generic.error+"<br />Timesheets were not "+n+"d. Please use manager instead.",noClose:!1,showLoader:!1,showButtons:!0})},onFailure:function(){uialert({message:Affinity.languages.english.generic.error+"<br />Timesheets were not  "+n+"d. Please use manager instead.",noClose:!1,showLoader:!1,showButtons:!0})},onTimeout:function(){uialert({message:Affinity.languages.english.generic.error+"<br />Timesheets were not  "+n+"d. Please use manager instead.",noClose:!1,showLoader:!1,showButtons:!0})},onRequest:function(){uialert({message:n.substring(0,n.length-1)+"ing timesheets",noClose:!0,showLoader:!0})}.bind(this),onSuccess:function(t){var u=parseFloat(t.Submitted),e=parseFloat(t.Approved),o=parseFloat(t.Declined),f=u+e+o,i=this.hoverData.cell,s=i.getElement("input"),r=i.retrieve("data");r.Submitted=u,r.Approved=e,r.Declined=o,"Messages"in t&&typeOf(t.Messages)==="string"&&(r.Messages=t.Messages),s.value=Number(f).format({decimals:this.unitRounding}),i.removeClass("zero").removeClass("att"),f===0&&(i.addClass("zero"),s.value=0),(u>0||"Messages"in r)&&i.addClass("att"),f>0?(i.store("data",Object.clone(r)),i.removeEvents(),i.addEvent(Affinity.events.over,this.showDetails),i.addEvent(Affinity.events.out,this.hideDetails),i.addEvent(Affinity.events.click,this.showManageDetails)):(i.removeEvents(),i.eliminate("data"),i.removeClass("att")),Affinity.modal.hide(),uialert({message:"Timesheets "+n+"d.",noClose:!1,showLoader:!1,showButtons:!0})}.bind(this)}).post()}.bind(this)})},getSizes:function(){var r=50,u=200,n=this.showDays,i=document.getSize().x-46,t,f,e;return this.insertWorkSchedule&&(r=60,n+=5),Affinity.mobile?(this.leftWidth="0px",this.midWidth=window.getSize().x-80+"px",this.rightWidth="40px",this.cellWidth=100/n+"%",this.wideCellWidth=100/n*1.5+"%",this.doubleCellWidth=200/n+"%",this.cellHeight="63px"):(50*n+u>i?(t=i>1450?u:250,leftPer=t/i*100,f=1e4/i,e=100-(leftPer+f),this.tableWidth="100%",this.leftWidth=leftPer+"%",this.midWidth=e+"%",this.rightWidth=f+"%",this.cellWidth=100/n+"%",this.wideCellWidth=100/n*1.5+"%",this.doubleCellWidth=200/n+"%",this.cellHeight="100%"):(t=u,this.tableWidth=t+r*n+"px",this.leftWidth=t+"px",this.midWidth=r*n+"px",this.rightWidth="100px",this.cellWidth=100/n+"%",this.wideCellWidth=100/n*1.5+"%",this.doubleCellWidth=200/n+"%",this.cellHeight="100%"),this.adminWarning&&(this.adminWarning.removeClass("hidden"),this.setAdminWarningSize())),!0},resizeTimer:!1,doResize:function(){clearTimeout(this.resizeTimer),Affinity.mobile||(this.resizeTimer=function(){this.getSizes(),this.table.setStyle("width",this.tableWidth),Array.each(this.table.getElements("th.details"),function(n){n.setStyle("width",this.leftWidth)}.bind(this)),Array.each(this.table.getElements("th.timeslots"),function(n){n.setStyle("width",this.midWidth)}.bind(this)),Array.each(this.table.getElements("th.buttons"),function(n){n.setStyle("width",this.rightWidth)}.bind(this)),Array.each(this.table.getElements("th.timeslotTitle, tbody.timeslot, tfoot.daytotal"),function(n){n.setStyle("width",this.cellWidth)}.bind(this)),this.setAdminWarningSize()}.delay(100,this))},setAdminWarningSize:function(){this.adminWarning&&this.adminWarning.setStyles({width:parseFloat(this.midWidth)+"%","margin-left":this.leftWidth})},hasChanges:function(){return!1},setDateHeadings:function(n,t){this.gridTotalsContainer.empty(),this.dateHeadings.empty();var o=(new Date).clearTime().getTime(),i=n.clone().clearTime(),s=t.clone().clearTime().increment("day",1),r,e,h,f,u=new Element("div",{"class":"dateheadings-container"}).set("tween",{duration:250});for(u.fade("hide");i.lessThan(s);)r="timeslotTitle",r=i.getTime()===o?r+" today":r,r+=" td-"+i.toSimple(),e=!1,typeOf(this.publicHolidays["d"+i.getTime()])!=="null"&&(e=new Element("span",{"class":"holiday-icon ui-has-tooltip",html:Affinity.icons.Plane,"data-tooltip":this.publicHolidays["d"+i.getTime()]}),r+=" holiday"),h=new Element("div",{"class":r,html:i.format("%a<br><span>%e<span>%o<\/span><\/span>")}).setStyle("width",this.cellWidth).adopt(e).inject(u),i=i.increment("day",1);this.insertWorkSchedule&&(new Element("div",{"class":"timeslotTitle ui-has-tooltip",html:"<strong>Act<br /><span>Total<\/span><\/strong>","data-tooltip":"Actual Total"}).setStyle("width",this.wideCellWidth).inject(u),new Element("div",{"class":"timeslotTitle ui-has-tooltip",html:"<strong>Sch<br /><span>Total<\/span><\/strong>","data-tooltip":"Scheduled Total"}).setStyle("width",this.wideCellWidth).inject(u),new Element("div",{"class":"timeslotTitle ui-has-tooltip",html:"<strong>Diff<br /><span>Total<\/span><\/strong>","data-tooltip":"Difference"}).setStyle("width",this.doubleCellWidth).inject(u)),u.inject(this.dateHeadings),u.fade("in"),f="Pay period from <span>"+n.format("%e%o of %b, %Y")+"<\/span> to <span>"+t.format("%e%o of %b, %Y")+"<\/span>",Affinity.mobile&&(f="<span>"+n.format("%e %b %Y")+"<\/span> - <span>"+t.format("%e %b %Y")+"<\/span>"),this.dateHeading.set("html",f),f=null},destroyGroup:function(n){n.empty(),n.destroy()},destroyRows:function(){Array.each(this.currentGroupRows,this.destroyGroup),this.currentGroupRows=[],this.currentGoups={}},destroy:function(){this.destroyRows(),this.options.target.empty(),Affinity.views.period=null,delete Affinity.views.period}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetRibbon={Version:"1.0.2.0",Sequence:10300,Name:"Timesheet Ribbon (Zelos Widget)",File:"ui.zelos.widget.timesheets.ribbon.js",Jira:"",Notes:""},ZelosWidgetTimesheetRibbon=new Class({debug:!1,Implements:[Options,Events],Binds:["clearTiles","reset","clear","updateTile","tileClicked","nextLast","selected","jumpToDate","getDate","setDate","refresh","cancel","destroy"],options:{target:null,fromDate:!1,toDate:!1,startDate:!1,innerFromDate:!1,innerToDate:!1,valueApi:!1,deferInitialSelect:!1,markPeriods:!0},initialize:function(n){this.setOptions(n),window.tsr=this,Affinity.ribbons||(Affinity.ribbons={},Affinity.ribbons.count=0,Affinity.ribbons.instances=[],Affinity.ribbons.widgets=[]),Affinity.ribbons.instances.push({tilecount:0}),Affinity.ribbons.count=Affinity.ribbons.instances.length,Affinity.ribbons.widgets.push(this),this.ribbonid=Affinity.ribbons.count-1,this.moved=!1,this.width=60,this.visible=15,Affinity.mobile&&(this.width=55,this.visible=5),this.uuid=String.uniqueID(),this.options.target.addClass("ts-ribbon-container"),this.dateScrollerDiv=new Element("div",{"class":"ts-date-ribbon"}).inject(this.options.target),this.options.markPeriods&&this.dateScrollerDiv.addClass("highligh-periods"),this.dateScrollerinnerDiv=new Element("div",{"class":"ts-date-ribbon-inner",id:"ribbon-inner-"+this.uuid}).inject(this.dateScrollerDiv),this.lastButton=new Element("div",{"class":"ts-date-ribbon-next-last last",html:Affinity.icons.ArrowLineLeft}).addEvent(Affinity.events.start,this.eventStop).addEvent(Affinity.events.click,this.nextLast).inject(this.dateScrollerDiv,"before"),this.nextButton=new Element("div",{"class":"ts-date-ribbon-next-last next",html:Affinity.icons.ArrowLineRight}).addEvent(Affinity.events.start,this.eventStop).addEvent(Affinity.events.click,this.nextLast).inject(this.dateScrollerDiv,"after"),this.frame=new Element("div",{"class":"ts-date-ribbon-frame"}).inject(this.options.target),this.frame.setStyle("margin-left",this.visible/2*this.width-1),this.dateScrollerDiv.setStyle("width",this.visible*this.width),this.options.target.getStyle("margin-left")==="auto"&&this.options.target.getStyle("margin-right")==="auto"&&this.options.target.setStyle("width",this.visible*this.width+(this.width+10)),this.mover=new Fx.Tween("ribbon-inner-"+this.uuid,{duration:250,transition:Fx.Transitions.Sine.easeInOut,link:"cancel",property:"left"}),this.options.fromDate&&this.options.toDate&&this.reset()},clearTiles:function(){return this.tiles&&this.tiles.length>0&&Array.each(this.tiles,function(n){n.retrieve("widget")?n.retrieve("widget").destroy():(n.removeEvents(),n.destroy())}),this.dateScrollerinnerDiv.empty(),this.tiles=[],this.tiles},reset:function(n){var h=this.cancel(),s,o,e;if(typeOf(n)==="object"&&this.setOptions(n),typeOf(this.options.fromDate)!=="date"||!this.options.fromDate.isValid()||typeOf(this.options.toDate)!=="date"||!this.options.toDate.isValid()){for(s=this.clearTiles(),i=0;i<this.visible;i++)t=this.dateTile(!1),t.inject(this.dateScrollerinnerDiv,"top");return}this.options.startDate?this.days=this.options.fromDate.clearTime().diff(this.options.toDate.clearTime(),"day"):(this.days=20,this.options.startDate=new Date),this.date=this.options.startDate,this.innerFromDate=typeOf(this.options.innerFromDate)=="date"&&this.options.innerFromDate.isValid()?this.options.innerFromDate:!1,this.innerToDate=typeOf(this.options.innerToDate)=="date"&&this.options.innerToDate.isValid()?this.options.innerToDate:!1;var s=this.clearTiles(),t,r=this.date.clone(),u=this.date.clone(),f=0;for(t=this.dateTile(this.date),t.inject(this.dateScrollerinnerDiv),f++,o=0;f<this.days*2;)u=u.increment("day",1),r=r.decrement("day",1),r>=this.options.fromDate&&(t=this.dateTile(r.clone()),t.inject(this.dateScrollerinnerDiv,"top"),f++),u<=this.options.toDate&&(t=this.dateTile(u.clone()),t.inject(this.dateScrollerinnerDiv,"bottom"),f++),o>=this.days*2&&(f=this.days*2),o++;for(u=u.increment("day",1),r=r.decrement("day",1),r>=this.options.fromDate&&(t=this.dateTile(r.clone()),t.inject(this.dateScrollerinnerDiv,"top")),u<=this.options.toDate&&(t=this.dateTile(u.clone()),t.inject(this.dateScrollerinnerDiv,"bottom")),i=0;i<(this.visible-1)/2;i++)t=this.dateTile(!1),t.inject(this.dateScrollerinnerDiv,"top"),t=this.dateTile(!1),t.inject(this.dateScrollerinnerDiv,"bottom");this.tiles=this.dateScrollerinnerDiv.getElements(".ts-date-tile"),e=0-(this.days-1)*this.width,this.drag?this.dragBox&&this.drag?this.drag.setOptions({limit:{x:[e,0],y:[0,0]}}):log("Ribbon dragger box or drag instance could not be identified (#ribbon-inner-"+this.uuid+")"):(this.dragTileCheckPeriodical=!1,this.dragResetTimer=null,this.dragBox=document.id("ribbon-inner-"+this.uuid),this.dragBox?this.drag=new Drag.Move(this.dragBox,{limit:{x:[e,0],y:[0,0]},preventDefault:!0,stopPropagation:!0,onStart:function(){this.dragging=!0,clearInterval(this.dragTileCheckPeriodical),this.dragTileCheckPeriodical=function(){this.dateScrollerinnerDiv.fireEvent("ribbonTileCheckVisible")}.periodical(500,this)}.bind(this),onComplete:function(){clearInterval(this.dragTileCheckPeriodical),clearTimeout(this.dragResetTimer);var n=this.dateScrollerinnerDiv.getPosition(this.dateScrollerDiv).x,t=n-(n-e)%this.width,i=t*-1/this.width+Math.floor(this.visible/2);this.mover.start(t),this.moved=!0,this.selected(this.tiles[i]),this.dragResetTimer=function(){this.dragging=!1}.delay(300,this),function(){this.dateScrollerinnerDiv.fireEvent("ribbonTileCheckVisible")}.delay(500,this)}.bind(this)}):log("Ribbon dragger box could not be identified (#ribbon-inner-"+this.uuid+")")),this.options.valueApi&&this.options.valueApi.returnKey&&window.addEvent("OverviewUpdated",this.updateTile),this.dateScrollerinnerDiv.setStyle("width",(f+this.visible)*this.width),this.jumpToDate(this.options.startDate)},clear:function(){for(var i,t,r=this.dateScrollerinnerDiv.getElements(".ts-date-tile"),n=0;n<r.length;n++)i=r[n],t=i.getWidget(),t&&t.reset();return!0},updateTile:function(n){var t=this.options.valueApi.returnKey,i,r;if(t.contains(".")){var u=Object.valueFromKeyString(n,t),e=t.substr(0,t.lastIndexOf("."))+".Date",f=Object.valueFromKeyString(n,e);u&&f&&(i=Date.parse(f),i.isValid()&&(r=this.dateScrollerinnerDiv.getElement(".ts-ribbon-date-"+i.format("%d-%m-%Y")+" .value"),r&&r.set("html",u)))}},eventStop:function(n){n.stop()},nextLast:function(n){var i=n.getTarget("ts-date-ribbon-next-last"),t=this.date.clone();i.hasClass("last")&&t.decrement("day",1),i.hasClass("next")&&t.increment("day",1),this.jumpToDate(t),function(){this.dateScrollerinnerDiv.fireEvent("ribbonTileCheckVisible")}.delay(500,this)},dateTile:function(n){var t="",i;return this.innerFromDate&&this.innerToDate&&(t="diag",typeOf(n)=="date"&&n.isValid()&&n.getTime()>=this.innerFromDate.getTime()&&n.getTime()<=this.innerToDate.getTime()&&(t="")),n===!1&&(t="placeholder"),i=new ZelosWidgetTimesheetRibbonTile({api:this.options.valueApi,value:0,date:n,today:new Date,klass:t,parent:this.dateScrollerinnerDiv,ribbonid:this.ribbonid+0}),i.element.addEvent(Affinity.events.click,this.tileClicked),i.element},tileClicked:function(n,t){if(!this.dragging){var i=n.target.hasClass("ts-date-tile")?n.target:n.target.getParent(".ts-date-tile"),f=this.dateScrollerinnerDiv.getPosition(this.dateScrollerDiv).x,u=this.visible*this.width/2-this.width/2,r=0-this.tiles.indexOf(i)*this.width+u;this.moved?this.mover.start(r):this.mover.start(0,r),this.selected(i,t),this.moved=!0,typeOf(t)==="boolean"&&t===!1||function(){this.dateScrollerinnerDiv.fireEvent("ribbonTileCheckVisible")}.delay(500,this)}},eventTimer:null,selected:function(n,t){this.options.deferInitialSelect||(this.date=n.retrieve("date"),clearTimeout(this.eventTimer),typeOf(t)==="boolean"&&t===!1||(this.eventTimer=function(){this.fireEvent("selected",this.date)}.delay(1e3,this))),this.options.deferInitialSelect=!1},jumpToDate:function(n,t){this.dateScrollerinnerDiv.getElement(".ts-ribbon-date-"+n.format("%d-%m-%Y"))&&this.tileClicked({target:this.dateScrollerinnerDiv.getElement(".ts-ribbon-date-"+n.format("%d-%m-%Y"))},t)},getDate:function(){return this.date},setDate:function(n,t){this.jumpToDate(n,t)},checkRefreshTimer:!1,refresh:function(){if(clearTimeout(this.checkRefreshTimer),this.options.target.offsetParent===null)this.checkRefreshTimer=this.refresh.delay(500,this);else return this.cancel(!0)},cancel:function(n){for(var r,t,u=this.dateScrollerinnerDiv.getElements(".ts-date-tile"),i=0;i<u.length;i++)r=u[i],t=r.getWidget(),t&&(t.cancel(),typeOf(n)==="boolean"&&n===!0&&(t.isVisible()?t.refresh.delay(1e3,t):t.reset()));return!0},destroy:function(){clearTimeout(this.eventTimer),clearTimeout(this.dragResetTimer),this.drag&&(this.drag.stop(),this.drag.detach()),this.lastButton.removeEvents(),this.nextButton.removeEvents(),this.lastButton.destroy(),this.nextButton.destroy();var n;Array.each(this.dateScrollerinnerDiv.getElements(".ts-date-tile"),function(t){n=t.getWidget(),n.element.removeEvents(),n.destroy(),t&&t.destroy()}),n=null,this.dateScrollerDiv.destroy(),this.options.target.removeClass("ts-ribbon-container"),this.options.target.set("style",null),this.removeEvents(),Affinity.ribbons.instances[this.ribbonid]=null,Affinity.ribbons.widgets[this.ribbonid]=null,window.removeEvent("OverviewUpdated",this.updateTile),Object.each(this,function(n,t){this[t]=null,delete this[t]}.bind(this))}}),ZelosWidgetTimesheetRibbonTile=new Class({Implements:[Options,Events],Binds:["isVisible","requestValueIfVisible","requestValue","getValue","setValue","refresh","reset","cancel","destroy"],options:{value:0,api:{url:"",method:"get",headers:{},returnKey:!1},date:!1,today:!1,klass:"",parent:!1,ribbonid:null},element:null,initialize:function(n){this.setOptions(n),this.options.today||(this.options.today=new Date),this.isToday=!1,this.element=new Element("div",{"class":"ts-date-tile widget "+this.options.klass}),this.dateDiv=new Element("div",{"class":"label"}).inject(this.element),this.valueDiv=new Element("div",{"class":"value"}).inject(this.element),this.element.store("widget",this),this.options.date&&(this.isToday=this.options.date.sameDay(this.options.today),this.dateDiv.set("html",this.options.date.format("%a %e<br />%b")),this.valueDiv.set("html",this.options.value),this.element.addClass("active"),this.isToday&&this.element.addClass("today"),this.element.store("date",this.options.date),this.element.addClass("ts-ribbon-date-"+this.options.date.format("%d-%m-%Y")),this.options.api&&this.options.api.url?(this.valueDiv.set("html","..."),this.options.parent?this.options.parent.addEvent("ribbonTileCheckVisible",this.requestValueIfVisible):this.requestValue(this.options.api.url,this.options.api.method?this.options.api.method:"get",this.options.api.headers?this.options.api.headers:{},this.options.api.returnKey?this.options.api.returnKey:!1)):(this.dateDiv.set("html",this.options.date.format("%a<br />%b")),this.valueDiv.set("html",this.options.date.format("%e%o")))),this.count=Affinity.ribbons.instances[this.options.ribbonid].tilecount+0,Affinity.ribbons.instances[this.options.ribbonid].tilecount++,this.internalid=this.options.ribbonid+"-"+this.count},isVisible:function(){if(this.element.getParent()&&this.element.getParent().hasClass("ts-date-ribbon-inner")){var r=this.element.getParent().getParent(),n=this.element.getParent(),t=parseInt(n.getStyle("left"))*-1,u=t+parseInt(r.getSize().x),i=this.element.getPosition(n).x;if(i>=t&&i<=u)return!0}return!1},requestDelay:null,requestValueIfVisible:function(){!this.apiLoaded&&this.isVisible()&&(clearTimeout(this.requestDelay),this.requestDelay=this.requestValue.delay(1e3,this,[this.options.api.url,this.options.api.method?this.options.api.method:"get",this.options.api.headers?this.options.api.headers:{},this.options.api.returnKey?this.options.api.returnKey:!1]))},apiLoaded:!1,apiLoader:!1,requestValue:function(n,t,i,r){var f,u,n;if(this.apiLoader)try{this.apiLoader.cancel()}catch(e){}this.apiLoaded||(log("\t&#x2794; attempting RibbonTile "+this.internalid+" load ..."),f=new URI(n),u=typeOf(f.parsed.query)==="null"?{}:f.parsed.query.parseQueryString(),u.fromDate=this.options.date.format("%d.%b.%Y"),u.toDate=u.fromDate,u.ran=String.uniqueID(),f.parsed.query=Object.toQueryString(u),n=decodeURI(Affinity.GetCacheSafePath(f.toString())),clearTimeout(this.requestDelay),this.requestDelay=function(){var u=new Date;this.apiLoader=new Request.JSON({url:n,method:t,headers:i,onRequest:function(){log("\t&#x2794; RibbonTile "+this.internalid+" load requested ("+u.elapsed()+") ...",{color:"blue"})}.bind(this),onFailure:function(n){var t="",i;switch(n.status){case 401:t="Api unauthorized.";break;case 404:t="API path not found.";break;case 500:try{i=JSON.decode(n.responseText)}catch(r){i=!1,t=n.responseText}i&&(t=i.error?i.error:n.responseText),delete i;break;default:t=n.statusText}log("\t&#x270B; RibbonTile "+this.internalid+" load failed ("+u.elapsed()+") - "+t,{color:"red"})}.bind(this),onError:function(n){log("\t&#x270B; RibbonTile "+this.internalid+" load failed ("+u.elapsed()+") - "+n,{color:"red"})}.bind(this),onException:function(n,t){log("\t&#x270B; RibbonTile "+this.internalid+" load failed with exception ("+u.elapsed()+") - "+n+"; "+t,{color:"red"})}.bind(this),onTimeout:function(){log("\t&#x270B; RibbonTile "+this.internalid+" load timedout ("+u.elapsed()+")",{color:"red"})}.bind(this),onSuccess:function(n){log("\t&#x2714; RibbonTile "+this.internalid+" load succeeded ("+u.elapsed()+")",{color:"green"});var t="";t=r?Object.valueFromKeyString(n,r):n,isNaN(t)?this.valueDiv.set("html",t):this.valueDiv.set("html",Number.round(parseFloat(t),2)),this.apiLoaded=!0}.bind(this)}).send()}.delay(1e3,this))},refresh:function(){try{this.reset(),this.isVisible()&&this.requestValue(this.options.api.url,this.options.api.method?this.options.api.method:"get",this.options.api.headers?this.options.api.headers:{},this.options.api.returnKey?this.options.api.returnKey:!1)}catch(n){}},reset:function(){this.cancel(),this.apiLoaded=!1,this.valueDiv.set("html","...")},cancel:function(){try{this.apiLoader.cancel()}catch(n){}},destroy:function(){this.apiLoader&&this.apiLoader.isRunning()&&this.apiLoader.cancel(),this.element.eliminate("widget"),this.element.destroy()}}),Affinity.Components=Affinity.Components||{},Affinity.Components.ZelosWidgetTimesheetTableAsWeekly={Version:"1.0.34.0",Sequence:10200,Name:"Timesheet Table As Weekly (Zelos Widget)",File:"ui.zelos.widget.timesheets.weekly.js",Jira:"CT-1231",Notes:"Fix fav labels"},ZelosWidgetTimesheetTableAsWeekly=new Class({Implements:[Options,Events],Binds:["processDates","getSizes","doResize","hasChanges","beforeClose","processErrors","getFavs","setupFavsProcessTimesheets","processTimesheets","getFavDisplayData","toggleAddRowsForm","showAddRowsForm","hideAddRowsForm","jumpToToday","jumpToDate","switchUser","continueWithSwitch","switchUserWithProfile","generateKey","getRowStatus","updateWorschduleRemaining","updateWorschduleError","sanatisePostJson","postDocumentRow","processDocumentErrors","checkRowForSubmit","submitRow","doSubmitRow","submitCol","submitWeek","refresh","toggleFavourite","favNameEdit","addNewGroup","addGroupAsFav","delGroupAsFav","getEmployeeFromTimsheetDoc","destroyGroup","destroyRows","destroy","delUnload"],options:{timesheetType:"employee",parentDocument:null,parentSectionIndex:null,parentChildIndex:null,widgetDocument:null,putApi:null,getEmptyTimesheetApi:"",target:null,zelosEngine:null,zelosProcessor:null,insertAddForm:!0,startDay:0,showDays:7,publicHolidays:[],readOnly:!1},clickDelay:500,disableReadOnlyGroups:!1,disableReadOnlyUnits:!1,unitRounding:2,statusNewEditedColor:"black",swapFavNameIfOnBehalf:!1,currentDates:{from:null,to:null},initted:!1,initialize:function(n){var w,f,b,s,e,h,l,y,p,r,a,v,t,i,o,u;this.setOptions(n),Affinity.views.calendar=this,w=Affinity.appname,this.userData=Affinity.login.profile,f=Affinity.login.areas,this.lang=Affinity.languages.english,this.genLang=this.lang.generic,this.baseLang=this.lang.features,this.baseAppLang=this.lang.application.timesheets.features,this.globalLang=this.lang.application.timesheets.globals,this.showDays=7,this.greyBefore=!1,this.greyAfter=!1,this.disableBefore=!1,this.disableAfter=!1,this.currentPayDate=!1,this.nextPayPeriodStarts=!1,this.currentPayPeriodStarts=!1,this.isManager=f.Timesheet.IsManager,this.isEmployee=f.Timesheet.IsEmployee,this.insertWorkSchedule=this.isManager&&Affinity.enableGridWorkSchedules?!0:!1,this.readOnlyOverride=typeOf(f.Timesheet.ReadonlyWeeklyView)==="boolean"?f.Timesheet.ReadonlyWeeklyView:!1,this.delegateIcon=Affinity.icons.Return,this.zelosProcessor=this.options.zelosProcessor,b=this.processDates(this.userData),this.getSizes(),window.addEvent("processorDocumentSaved",function(n){n.processorId==this.zelosProcessor.processorId&&this.refresh(null,!0)}.bind(this)),window.addEvent("processorDocumentError",function(n){n.processorId==this.zelosProcessor.processorId&&this.processErrors(n.document,!0)}.bind(this)),this.target=this.options.target,this.target.addClass("timesheet-grid"),s=new Element("input",{"class":"jumptodateInput"}),e=new Element("span",{"class":"button w-icon blue left",html:"<span>"+Affinity.icons.Calendar+"<\/span>"+(Affinity.mobile?"Goto":"Goto Date")}),this.switchEmployeeBox=!1,this.switchEmployeeSelect=!1,h=Affinity.zelosroot+"?api=timesheetAsManager/getEmployees",log('&#x2794; attempting weekly, initialize "get employees" ...'),this.isManager&&(this.defaultCompanyNumber=Affinity.login.companyNumber+"",this.defaultEmployeeNumber=Affinity.login.profile.employeeNumber+"",this.switchEmployeeSelect=new Element("select",{"class":"hidden"}),new Request.JSONP({callbackKey:"jsoncallback",url:h,method:"get",noCache:!0,onComplete:function(n){JSON.Unauthorized(n,'weekly, initialize "get employees" - '+h)||(log('&#x2714; attempted weekly, initialize "get employees" succeeded'),this.switchEmployeeSelect.empty(),this.isEmployee&&this.switchEmployeeSelect.adopt(new Element("option",{html:Affinity.login.profile.commonName+" ("+Affinity.login.profile.employeeNumber+")",value:Affinity.login.profile.employeeNumber})),Array.each(n,function(n){n.Value!==""&&n.Key!==""&&n.Key+""!==this.defaultEmployeeNumber&&this.switchEmployeeSelect.adopt(new Element("option",{html:n.Value,value:n.Key}))}.bind(this)),this.switchEmployeeSelect.removeClass("hidden"),this.switchEmployeeSelect.addClass("ui-autocomplete"),this.switcherWidget=Affinity.mobile&&"UIAutoCompleteMobileWidget"in window?new UIAutoCompleteMobileWidget({selectElement:this.switchEmployeeSelect}):new UIAutoCompleteWidget({selectElement:this.switchEmployeeSelect}),window.addEvent("gotUserWithPeriods",this.switchUserWithProfile),window.addEvent("elementChanged",function(n){if(n.element==this.switchEmployeeSelect){var t=n.element.getWidget();t&&"changed"in t?t.changed&&this.switchUser({target:n.element}):this.switchUser({target:n.element})}}.bind(this)))}.bind(this)}).send(),this.switchEmployeeBox=new Element("div",{"class":"form-row switcher-box"}).adopt(this.switchEmployeeSelect)),this.lastButton=new Element("span",{"class":"button blue icononly nextlast last",html:Affinity.icons.ArrowLeft}),this.nextButton=new Element("span",{"class":"button blue icononly nextlast next",html:Affinity.icons.ArrowRight});var c=new Element("th",{"class":"timeslots",style:"width: "+this.midWidth}).adopt(new Element("div",{"class":"date-heading"}),new Element("div",{"class":"date-headings"})),k=new Element("span",{"class":"button w-icon approve green",html:"<span>"+Affinity.icons.ThumbsUp+"<\/span>Approve All"}).addEvent(Affinity.events.click,this.submitWeek),d=new Element("span",{"class":"button w-icon decline red",html:"<span>"+Affinity.icons.ThumbsDown+"<\/span>Decline All"}).addEvent(Affinity.events.click,this.submitWeek);for(this.gridTotal=new Element("span",{"class":"total"+(Affinity.mobile?"":" left"),html:"0"}),this.gridTotalsContainer=new Element("td",{"class":"totals"}),this.noTimesheetsBox=new Element("div",{html:this.options.readOnly?"No Timesheets to view.":'No Timesheets. Use <span class="inline-desc-button"><span>'+Affinity.icons.AddToList+"<\/span> Add<\/span> top right."}),this.isDelegatingBox=new Element("span").inject(this.noTimesheetsBox),l=new Element("td",{colspan:3}),this.readOnlyOverride||l.adopt(k,d),this.buttonBox=new Element("div",{"class":"button-box"}).adopt(s,e,new Element("span",{"class":"button w-icon blue totoday left",html:"<span>"+Affinity.icons.Calendar+"<\/span>"+(Affinity.mobile?"Now":"Today")}).addEvent(Affinity.events.click,this.jumpToToday),new Element("span",{"class":"clear"}),this.switchEmployeeBox),y=new Element("thead").adopt(new Element("tr").adopt(new Element("th",{"class":"details",style:"width: "+this.leftWidth}).adopt(this.lastButton,this.buttonBox),c,new Element("th",{"class":"buttons",style:"width: "+this.rightWidth}).adopt(this.nextButton)),new Element("tr").adopt(new Element("th",{"class":"details"}),new Element("th",{"class":"timeslots"}).adopt(new Element("div",{"class":"submitdays-buttons"})),new Element("th",{"class":"buttons"}))),p=new Element("tfoot").adopt(new Element("tr",{"class":"totalsrow"}).adopt(new Element("td",{"class":"details",html:'<span class="gtotal right">Totals<\/span>'}),this.gridTotalsContainer,new Element("td",{"class":"buttons"}).adopt(this.gridTotal)),new Element("tr",{"class":"submitweek-buttons hidden"}).adopt(l),new Element("tr",{"class":"norows hidden"}).adopt(new Element("td",{"class":"details"}),new Element("td",{"class":"timeslots"}).adopt(this.noTimesheetsBox),new Element("td",{"class":"buttons"}))),this.table=new Element("table",{"class":"nostyles weekmode hourstype"+(this.showDays>27?" fullmonth":""),style:"width: "+this.tableWidth}).adopt(y,new Element("tbody"),p).inject(this.target),r=new UIDateTimeWidget({outputFormat:"%d.%m.%Y",displayFormat:"%a %e %b %Y",showCalendar:!0,showTime:!1,startDate:null,labelName:"",postId:"",postName:"",validationMethods:"",validationErrorStr:"",target:s}),r.display.addClass("jumptodateInput"),r.addEvent("dateClicked",function(n){r.dontClose=!1,r.hide();var i,u,t=!1,n=Date.parse(n);n.greaterThanOrEqualTo(this.periodData.oldest)&&n.lessThanOrEqualTo(this.periodData.newest)&&Array.each(this.periodData.periods,function(r,f){i=r.from.clone().clearTime(),u=r.to.clone().clearTime(),!t&&n.greaterThanOrEqualTo(i)&&n.lessThanOrEqualTo(u)&&(t=!0,this.periodIndex=f,this.jumpToDate(!0))}.bind(this)),t||uialert({message:n.toFriendlyShort()+" is not within your allowable date range.<br /><br />Please select a date between <strong>"+this.periodData.oldest.toFriendlyShort()+"<\/strong> and <strong>"+this.periodData.newest.toFriendlyShort()+"<\/strong><br /><br />",showButtons:!0,noClose:!1,showLoader:!1})}.bind(this)),e.addEvent(Affinity.events.overAll,function(){r.dontClose=!0}),e.addEvent(Affinity.events.outAll,function(){r.dontClose=!1}),e.addEvent(Affinity.events.click,function(){r.dontClose=!0,r.show()}),this.publicHolidays={},this.options.publicHolidays.length>0&&(Array.each(this.options.publicHolidays,function(n){a=Date.parse(n.Date),this.publicHolidays["d"+a.getTime()]=n.Description}.bind(this)),a=null),this.weekButtons=this.table.getElement(".submitweek-buttons"),this.submitdaysButtons=this.table.getElement(".submitdays-buttons"),this.totalRow=this.table.getElement(".totalsrow"),this.noRows=this.table.getElement(".norows"),this.submitcolumnbuttons=new Element("div",{"class":"submitdays-container hidden"}),this.managecolumnbuttons=new Element("div",{"class":"managedays-container hidden"}),!this.readOnlyOverride&&this.options.insertAddForm&&(this.addRowsButton=new Element("span",{"class":"button blue w-icon addrows",html:"<span><\/span>Add Timesheets"}),this.addRowsButton.set("reveal",{duration:300,display:"inline-block"}),this.addRowsform=new Element("div",{"class":"default-form w-border timesheetAddFrom"}).inject(this.table,"after"),this.addFormInner=new Element("div").inject(this.addRowsform),new Element("div",{"class":"form-row"}).adopt(new Element("label",{html:""}),new Element("span",{"class":"button blue w-icon",html:"<span>"+Affinity.icons.PlusRound+"<\/span>Add"}).addEvent(Affinity.events.click,this.addNewGroup),new Element("span",{html:"&nbsp;"}),new Element("span",{"class":"button grey w-icon",html:"<span>"+Affinity.icons.Cancel+"<\/span>Cancel"}).addEvent(Affinity.events.click,this.hideAddRowsForm)).inject(this.addRowsform),this.addRowsform.set("reveal",{duration:300}),this.addRowsform.toggle(),this.addRowsButton.addEvent(Affinity.events.click,this.showAddRowsForm.bind(this)),new Element("div",{"class":"form-row"}).adopt(this.addRowsButton).inject(this.table,"after")),v=new Element("div",{"class":"grid-wrapper"}).inject(this.table,"after").adopt(this.table),this.key=new Element("div",{"class":"key"}).inject(v,"after"),this.keyShowButton=new Element("span",{"class":"button yellow icononly key-button",html:"<span>"+Affinity.icons.HelpRound+"<\/span>"}).inject(this.nextButton,"after").addEvent(Affinity.events.click,function(){this.keybox.reveal(),this.keyShowButton.addClass("hidden"),this.keyHideButton.removeClass("hidden")}.bind(this)),this.keyHideButton=new Element("span",{"class":"button yellow icononly key-button hidden",html:"<span>"+Affinity.icons.HelpRound+"<\/span>"}).inject(this.nextButton,"after").addEvent(Affinity.events.click,function(){this.keybox.dissolve(),this.keyHideButton.addClass("hidden"),this.keyShowButton.removeClass("hidden")}.bind(this)),this.keybox=new Element("div").inject(this.key),this.keybox.set("reveal",{duration:250}),this.keybox.toggle(),this.keytable=new Element("table").inject(this.keybox),t=[],i=[],t.push(["Submit day column or<br />Submit timesheet row",new Element("span",{"class":"button green w-icon-only",html:"<span>"+Affinity.icons.Paperplane+"<\/span>"})]),t.push(["Approve day column or<br />Approve timesheet row",new Element("span",{"class":"button green w-icon-only",html:"<span>"+Affinity.icons.ThumbsUp+"<\/span>"})]),t.push(["Decline day column or<br />Decline timesheet row",new Element("span",{"class":"button red w-icon-only",html:"<span>"+Affinity.icons.ThumbsDown+"<\/span>"})]),t.push(["Timesheet hours box",new Element("div",{"class":"key-block",html:""})]),t.push(["Current day",new Element("div",{"class":"key-block today",html:""})]),t.push(["Holiday",new Element("div",{"class":"key-block holiday",html:""})]),t.push(["Outside current pay period",new Element("div",{"class":"key-block outside",html:""})]),t.push(["Can not create a Timesheet",new Element("div",{"class":"key-block outside-as",html:""})]),i.push(["Day is Delegated<br />(Mouse over or tap for info)",new Element("div",{"class":"font-icons orange",html:this.delegateIcon})]),i.push(["Timesheet is new",new Element("div",{"class":"key-block new",html:"8"})]),i.push(["Timesheet has been submitted or is pending",new Element("div",{"class":"key-block submitted",html:"8"})]),i.push(["Timesheet has been approved",new Element("div",{"class":"key-block approved",html:"8"})]),i.push(["Timesheet has been declined",new Element("div",{"class":"key-block declined",html:"8"})]),i.push(["Timesheet has an error (Mouse over or tap for info)",new Element("div",{"class":"key-block haserror",html:"99"})]),u=0;u<(t.length>i.length?t.length:i.length);u++)o=new Element("tr").inject(this.keytable),t[u]&&(new Element("td").adopt(t[u][1]).inject(o),new Element("td",{"class":"label",html:t[u][0]}).inject(o)),i[u]&&(new Element("td").adopt(i[u][1]).inject(o),new Element("td",{"class":"label",html:i[u][0]}).inject(o));Affinity.mobile&&(this.buttonBox.inject(this.table,"before"),this.lastButton.inject(c,"top"),this.nextButton.inject(c,"top")),this.wrapper=v,this.wrapper.set("tween",{duration:250}),this.wrapper.fade("hide"),this.rowTarget=this.table.getElement("tbody"),this.dateHeading=this.table.getElement(".date-heading"),this.dateHeadings=this.table.getElement(".date-headings"),this.table.getElements(".nextlast").addEvent(Affinity.events.click,this.nextLast.bind(this)),this.checkForFullRowLock=!1,this.checkForFullRowLockData=[],this.options.widgetDocument.hasOwnProperty("Data")&&this.options.widgetDocument.Data.hasOwnProperty("GroupIdentifierData")&&(this.checkForFullRowLock=!0,this.checkForFullRowLockData=this.options.widgetDocument.Data.GroupIdentifierData),this.setupFavsProcessTimesheets(this.options.widgetDocument),this.setDateHeadings(this.showDays),window.addEvent("resize",this.doResize),this.doResize(),this.initted=!0},processDates:function(n,t){var r,u,f;this.periodData=Object.clone(this.userData.payPeriods);var o=this.periodData.periods[this.periodData.periodTodayIndex],i=this.periodData.periods[this.periodData.periodCurrentIndex],e=this.periodData.periods[this.periodData.periodCurrentIndex+1];return(this.showDays=this.periodData.length,this.periodIndex=this.periodData.periodCurrentIndex,this.loadTimesheetsFrom=i.from.clone(),this.loadTimesheetsTo=i.to.clone(),this.greyBefore=i.from.clone(),this.greyAfter=i.to.clone(),this.disableBefore=this.periodData.oldest.clone(),this.disableAfter=this.periodData.newest.clone(),this.currentPayDate=this.periodData.currentPayDate.clone(),this.currentPayPeriodStarts=i.from.clone(),this.nextPayPeriodStarts=e.from.clone(),this.date=i.from.clone(),this.doResize(),r=[["greyBefore","grey before","PreviousPaydate"],["greyAfter","grey after","CurrentPaydate"],["disableBefore","disable before","OldestTimesheetDate"],["disableAfter","disable after","NewestTimesheetDate"],["currentPayDate","current pay","CurrentPaydate"],["currentPayPeriodStarts","current payperiod starts","CurrentPayPeriodStarts"],["nextPayPeriodStarts","next payperiod starts","currentPayDate + 1 day"]],Array.each(r,function(n){typeOf(this[n[0]])==="date"&&(typeOf(this[n[0]])!=="date"||this[n[0]].isValid())||(this[n[0]]=!1)}.bind(this)),!this.greyBefore||!this.greyAfter||!this.disableBefore||!this.disableAfter||!this.currentPayDate||!this.currentPayPeriodStarts||!this.nextPayPeriodStarts)?(u="",Array.each(r,function(n){this[n[0]]||(u+=n[1]+" date ("+n[2]+") is missing or invalid\r\n")}.bind(this)),t?(f={},f.message=this.globalLang.noViewAccess+"<!--\r\n"+u+"-->",window.fireEvent("logout",f)):uialert({message:this.globalLang.minLoginNotMet,showButtons:!0,noClose:!1,showLoader:!1}),!1):!0},getSizes:function(){var n,t;if(Affinity.mobile)this.leftWidth="0px",this.midWidth=window.getSize().x-80+"px",this.rightWidth="40px",this.cellWidth=100/this.showDays+"%",this.cellHeight="63px";else if(n=document.getSize().x-46,50*this.showDays+450>n){var t=n>1450?350:250,i=t/n*100,r=1e4/n,u=100-(i+r);this.tableWidth="100%",this.leftWidth=i+"%",this.midWidth=u+"%",this.rightWidth=r+"%",this.cellWidth=100/this.showDays+"%",this.cellHeight="100%"}else t=450,this.tableWidth=t+50*this.showDays+"px",this.leftWidth="350px",this.midWidth=50*this.showDays+"px",this.rightWidth="100px",this.cellWidth=100/this.showDays+"%",this.cellHeight="100%"},resizeTimer:!1,doResize:function(){clearTimeout(this.resizeTimer),Affinity.mobile||(this.resizeTimer=function(){this.getSizes(),this.table.setStyle("width",this.tableWidth),Array.each(this.table.getElements("th.details"),function(n){n.setStyle("width",this.leftWidth)}.bind(this)),Array.each(this.table.getElements("th.timeslots"),function(n){n.setStyle("width",this.midWidth)}.bind(this)),Array.each(this.table.getElements("th.buttons"),function(n){n.setStyle("width",this.rightWidth)}.bind(this)),Array.each(this.table.getElements("th.timeslotTitle, tbody.timeslot, tfoot.daytotal"),function(n){n.setStyle("width",this.cellWidth)}.bind(this))}.delay(100,this))},mobileHalt:!1,setUnload:function(){window.onbeforeunload=this.beforeClose},delUnload:function(){window.onbeforeunload=function(){}},beforeClose:function(){return this.globalLang.unsavedTimeshetWarn+(this.changedFieldsMessage!==""?"\n\n"+this.changedFieldsMessage:"")},changedFieldsMessage:"",hasChanges:function(){var t,i,r,u,f,e,n;return this.changedFieldsMessage="",t=this.table.getElements(".timeslot input.value-changed"),t.length>0?(this.changedFieldsMessage="",n=[],Array.each(t,function(t){i=t.getParent(".timeslot"),r=t.getParent(".timesheet-row"),u=Date.parse(i.get("data-time")),f=document.getElements(".timesheet-row").indexOf(r),e=r.getElements(".timeslot").indexOf(i),t.hasChanged()&&(t.getTrackedDefault()!==""?n.push("Row "+(f+1)+" Column "+(e+1)+" ("+u.format("%a %e%o %b")+") has changed from '"+t.getTrackedDefault()+"' to '"+t.value+"'"):n.push("Row "+(f+1)+" Column "+(e+1)+" ("+u.format("%a %e%o %b")+") has changed to '"+t.value+"'"))}.bind(this)),this.changedFieldsMessage=n.join("\n"),!0):!1},getChangeMessage:function(){return this.changedFieldsMessage},checkChanges:function(){this.hasChanges()?this.setUnload():this.delUnload()},delegating:!1,delegateFrom:!1,delegateTo:!1,delegateEmployee:!1,delegateCheckRequest:!1,checkForDelegates:function(){if(this.delegateCheckRequest&&this.delegateCheckRequest.isRunning()&&this.delegateCheckRequest.cancel(),this.onBehalf){var n=Affinity.zelosroot+"?api=Employee/GetNotifyApproval&notifyArea=Timesheet";log("&#x2794; attempting weekly checkForDelegates ..."),this.delegateCheckRequest=new Request.JSON({url:n,method:"get",noCache:!0,onComplete:function(n){log("&#x2714; attempted weekly checkForDelegates succeeded"),typeOf(n)=="array"&&n.length>0&&(this.delegateFrom=[],this.delegateTo=[],this.delegateEmployee=[],Array.each(n,function(n){n.ShareDelegate==="Delegate"&&(this.delegating=!0,this.delegateFrom.push(Date.parse(n.DateFrom)),this.delegateTo.push(Date.parse(n.DateTo)),this.delegateEmployee.push(n.AlternateApproverName))}.bind(this))),this.continueWithSwitch()}.bind(this),onError:function(n){log("&#x2714; attempted weekly checkForDelegates failed with errors - "+n),this.continueWithSwitch()}.bind(this),onFailure:function(n){log("&#x2714; attempted weekly checkForDelegates failed - "+n.statusText),this.continueWithSwitch()}.bind(this)}).send()}else this.delegating=!1,this.delegateFrom=!1,this.delegateTo=!1,this.delegateEmployee=!1,this.continueWithSwitch()},onBehalf:!1,switchUser:function(n){if(Affinity.tooltips.hideAll(),this.switchEmployeeSelect){var t=String(n.target.value),i=n.target.getElements("option")[n.target.selectedIndex].get("html").replace(" ("+t+")","");this.switchUserEvent=n,this.wrapper.fade("out"),uialert({message:this.switchUserEvent&&this.switchUserEvent.refreshing?this.genLang.refreshing:this.globalLang.loadingTimesheetsFor+i,noClose:!0,showLoader:!0,showButtons:!1}),Affinity.login.controller.getUser(n.target.value)}},continueWithSwitch:function(){this.processTimesheet(this.options.widgetDocument),this.setupWeek(),this.switchEmployeeBox.removeClass("hidden"),this.errorStore?(window.uialert({message:this.errorStore,showButtons:!0}),this.errorStore=!1):Affinity.prompts.hide()},switchUserWithProfile:function(n){var o,u,s,i,f,r,t,e;(Affinity.tooltips.hideAll(),this.initted&&this.options.target&&this.options.target.hasClass("hidden"))||(o=this.destroyRows(),this.userData=n,u={from:this.loadTimesheetsFrom.clone(),to:this.loadTimesheetsTo.clone(),index:this.periodIndex},s=this.processDates(this.userData,!1),this.loadTimesheetsFrom=u.from.clone(),this.loadTimesheetsTo=u.to.clone(),this.periodIndex=u.index+0,i=String(this.userData.employeeNumber).trim()||"",f=String(this.userData.commonName).trim()||"",this.onBehalfData={},this.switchEmployeeBox.addClass("hidden"),this.hideAddRowsForm(),i!==""?i===String(this.defaultEmployeeNumber)?(this.onBehalf=!1,this.refresh()):(this.onBehalf=!0,this.onBehalfData.number=i,this.onBehalfData.name=f,r=new URI(Affinity.zelosroot+"?api=timesheetAsManager/get"),t=typeOf(r.parsed.query)==="null"?{}:r.parsed.query.parseQueryString(),t.fromDate=this.loadTimesheetsFrom.format("%d.%b.%Y"),t.toDate=this.loadTimesheetsTo.format("%d.%b.%Y"),this.currentDates.from===null||this.loadTimesheetsFrom.sameDay(this.currentDates.from)||(t.fromDate=this.currentDates.from.format("%d.%b.%Y")),this.currentDates.to===null||this.loadTimesheetsTo.sameDay(this.currentDates.to)||(t.toDate=this.currentDates.to.format("%d.%b.%Y")),t.employeeNo=i,t.view="week",r.parsed.query=Object.toQueryString(t),e=r.toString(),new ZelosTemplateLoad({onRequest:function(){uialert({message:this.switchUserEvent&&this.switchUserEvent.refreshing?this.genLang.refreshing:this.globalLang.loadingTimesheetsFor+f,noClose:!0,showLoader:!0,showButtons:!1})}.bind(this),onError:function(n){this.switchEmployeeBox.removeClass("hidden"),uialert({message:this.genLang.failed+"<br />"+n}),this.newRowsLoader=!1}.bind(this),onComplete:function(n){JSON.Unauthorized(n,"weekly, switchUser, ZelosTemplateLoad - "+e)||(this.destroyRows(),this.onBehalf=!0,this.options.widgetDocument=n.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex],this.checkForDelegates())}.bind(this)}).loadTemplate(e)):(this.onBehalf=!1,this.refresh()))},generateTemplateDoc:function(n){var t=Object.clone(n);return Array.each(t.Children,function(n){n.Source&&n.Source.PropertyName&&(n.Source.PropertyName.test("tsnet","gi")&&(n.Value=0,n.ValueAsString="0"),n.Source.PropertyName.test("tsstatus","gi")&&(n.Value="Pending",n.ValueAsString="Pending"),n.Source.PropertyName.test("originalkey","gi")&&(n.Value="",n.ValueAsString=""),n.Source.PropertyName.test("timesheetid","gi")&&(n.Value=-1,n.ValueAsString="-1"),n.Source.PropertyName.test("employeeno","gi")&&(n.Value=this.userData.employeeNumber,n.ValueAsString=this.userData.employeeNumber+""),n.Source.PropertyName.test("authorisedby","gi")&&(n.Value="",n.ValueAsString=""))}.bind(this)),t},currentGroupRows:[],currentGoups:{},generateKey:function(n,t){var o,u,f,e=[],s=t||!1,r,i;return Array.each(n.Children,function(n){n.Source&&n.Source.PropertyName&&(n.Source.PropertyName.toLowerCase().contains("tsunit")||n.Source.PropertyName.toLowerCase().contains("tsnet")||n.Source.PropertyName.toLowerCase().contains("starttime")||n.Source.PropertyName.toLowerCase().contains("endtime")||n.Source.PropertyName.toLowerCase().contains("breaktime")||n.Source.PropertyName.toLowerCase().contains("tsstatus")||n.Source.PropertyName.toLowerCase().contains("date")||n.Name.toLowerCase().contains("bulk")||n.Name.toLowerCase().contains("tsunit")||n.Name.toLowerCase().contains("tsnet")||n.Name.toLowerCase().contains("starttime")||n.Name.toLowerCase().contains("endtime")||n.Name.toLowerCase().contains("tsstatus")||n.Name.toLowerCase().contains("date")||n.Name.toLowerCase().contains("rowbutton")||n.Name.toLowerCase().contains("comment")||n.Attribute.IsHidden?ignore=!0:n.Source.PropertyName.toLowerCase().contains("authoriserid")?(o=typeOf(n.Value)==="string"?JSON.parse(n.Value):n.Value,Array.each(o,function(t){t.selected&&(u=n.Source.PropertyName,f=t.value,s,e.push([u,f]))})):(u=n.Source.PropertyName,f=n.ValueAsString,s,e.push([u,f])))}.bind(this)),i=[],Array.each(e,function(n){n.length>0&&n[1]&&(n[1]+"").trim()!==""&&(r=n.join("-").replace(/ /g,""),i.contains(r)||i.push(r))}),this.onBehalf&&(r="EmployeeName-"+this.onBehalfData.name.replace(/ /g,""),i.contains(r)||i.push(r)),i.sort(),i.join("_")},generateGroupIdentifier:function(n){var t=n;return typeOf(n)==="object"&&(t=JOSN.stringify(n)),(t+"").replace(/\,/g,"_").replace(/\:/g,"-").replace(/\{|\}|\[|\]|\"| /g,"").trim()},checkForRows:function(){this.table.getElements(".timesheet-row").length>0?(this.submitdaysButtons.removeClass("hidden"),this.totalRow.removeClass("hidden"),this.noRows.addClass("hidden"),this.onBehalf?this.weekButtons.removeClass("hidden"):this.weekButtons.addClass("hidden")):(this.submitdaysButtons.addClass("hidden"),this.totalRow.addClass("hidden"),this.noRows.removeClass("hidden"),this.weekButtons.addClass("hidden")),this.onBehalf?this.options.zelosProcessor.target.getElement(".form-row.buttons")&&this.options.zelosProcessor.target.getElement(".form-row.buttons").getParent(".section").addClass("hidden"):this.options.zelosProcessor.target.getElement(".form-row.buttons")&&this.options.zelosProcessor.target.getElement(".form-row.buttons").getParent(".section").removeClass("hidden")},sanatizeKeyValueDisplay:function(n,t){var i,r,u,f,e,o;return n.toLowerCase().trim()==="jobid"||n.toLowerCase().trim()==="tscode"?(i=t,t.contains(",")&&(r=t.split(","),i=r[0].trim().length>r[1].trim().length?r[1]+" - "+r[0]:r[0]+" - "+r[1])):(i=t,u=n.trim().toLowerCase(),f=t.trim().toLowerCase(),t.contains(",")&&(r=t.split(","),r.length===2&&(u=r[0],f=r[1])),u===f?i=t.capitalize():u.replace(" ","")===f.replace(" ","")?i=f.capitalize():(e=[],o=f.replace(/\,/gi,"").split(" "),Array.each(o,function(n,t){n.length>2&&(u!==n?e.push(n):u===n&&t>0&&e.push(n))}),i=e.length===0?t.capitalize():e.join(" ").capitalize())),i.trim().indexOf("- ")===0&&(i=i.trim().substring(2).trim()),i.contains("&Amp;")&&(i=i.replace("&Amp;","&amp;")),Affinity.debug&&console.log('fav name converted to from: {"'+n+'":"'+t+'"} to: '+i),i.trim()},maxLabelLength:30,favourites:{},returnFavHash:function(n){var t=[];return Object.each(JSON.decode(n.Fields),function(n,i){t.push(i+":"+n)}),t.push("Type:"+n.Type),t.push("EmployeeNo:"+n.EmployeeNo),t.push("Name:"+n.Name),t.sort(),t=t.join(",")},getFavs:function(n){var t,i,r,u,f;this.favourites={},u=1,t=Affinity.zelosroot+"?api=Favourite/GetFavouriteNamesExt&employeeNo="+Affinity.login.profile.employeeNumber,this.isManager&&(t=Affinity.zelosroot+"?api=Favourite/GetFavouriteNamesExt"),t=t+"&ran="+String.uniqueID(),f=new Request.JSON({url:t,onComplete:function(t){if(typeof t=="object"&&"length"in t&&t.length>0){this.favs=t;var f=[],u;Array.each(t,function(n){u=this.returnFavHash(n),f.indexOf(u)===-1&&(i=this.returnEmpKey(n.EmployeeNo),r=this.returnFavKey(n.Name),this.favourites[i]||(this.favourites[i]={}),this.favourites[i][r]=n,f.push(u))}.bind(this))}n&&n()}.bind(this),onFailure:function(){n&&n()}.bind(this),onError:function(){n&&n()}.bind(this)}).get()},returnEmpKey:function(n){return n=(n+"").trim(),"emp_"+n},returnFavKey:function(n){return n=n.trim(),n=n.replace(/\W/g,"_"),n=n.replace(new RegExp("__","gi"),"_"),"fav_"+n},setupFavsProcessTimesheets:function(n){Affinity.enableFavourites?this.getFavs(function(){this.processTimesheet(n),this.setupWeek()}.bind(this)):(this.processTimesheet(n),this.setupWeek())},getFavDisplayData:function(n,t){var o=parseInt(t)===0?Affinity.login.profile.employeeNumber:t,r={display:n,hover:o},s=this.returnEmpKey(o),h=this.returnFavKey(n),f,i,u,e;return this.favourites.hasOwnProperty(s)&&(f=this.favourites[s],f.hasOwnProperty(h)&&(i=f[h],e=[],u=i.Fields,typeOf(u)==="string"&&(u=JSON.parse(i.Fields)),Object.each(u,function(n,t){t!==""&&n!==""&&e.push(t+" as "+n)}),r.hover=e.join(" and "),r.display=i.Name,this.isManager&&(r.display=parseInt(i.EmployeeNo)===parseInt(Affinity.login.profile.employeeNumber)?"Me : "+i.Name:i.EmployeeName+" : "+i.Name),r.display=r.display.replace(new RegExp("_","gi")," "))),r},insertGroupRow:function(n,t){var lt=Affinity.showFavKeyLabels,at=t||!1,vt=this.generateKey(n),y=JSON.decode(n.Data.GroupValue),yt=y.JobId?y.JobId:"none",nt=this.generateGroupIdentifier(n.Data.GroupIdentifier),pt=this.target.getElements(".timesheet-row"),l=pt.length,o=new Element("tr",{id:nt,"class":"timesheet-row row"+l+" "+nt+" key_"+vt,"data-row-index":l,"data-job":yt}).inject(this.rowTarget),tt=this.getEmpFromRowDoc(n),wt=tt===!1||tt===0?!1:this.checkForFullRowLock,p=!1,c,a,w,f,s,e,ht,h,ct;o.store("full-row-lock",!1),wt&&this.checkForFullRowLockData.each(function(t){if(t.hasOwnProperty("Id")&&t.hasOwnProperty("IsReadOnly")&&t.Id+""==n.Data.GroupIdentifier+""&&t.IsReadOnly){p=!0,o.store("full-row-lock",!0);return}},this),c=new Element("div"),a="titlefavedit icon-pencil",at?a="hidden":Affinity.enableFavourites&&!this.readOnlyOverride?(w=this.baseAppLang.favourites.views.calendar.createFromTooltip,n.Data.IsFavourite&&(w=this.baseAppLang.favourites.renameTooltip),c.addClass("ui-has-tooltip").set("data-tooltip",w+"").set("data-tooltip-dir","left"),c.addEvent(Affinity.events.click,this.favNameEdit)):a="hidden",c.addClass(a);var it=new Element("div",{"class":"titlerow1 maintitle inline-no-wrap"}),b=new Element("div",{"class":"titlerow2 title"}),rt=new Element("div",{"class":"titlerow3 subtitle"}),r="",i="",u="",ut=new Element("td",{"class":"timesheet-col details"}).adopt(c,it,b,rt).inject(o),ft=new Element("div",{"class":"titlerow1 maintitle inline-no-wrap"}),k=new Element("div",{"class":"titlerow2 title"}),et=new Element("div",{"class":"titlerow3 subtitle"}),bt=new Element("div",{"class":"hide-on-desktop timesheet-mobile-details",style:"width:"+this.midWidth}).adopt(ft,k,et),d,ot=!1;if(Affinity.enableFavourites&&n.Data.IsFavourite&&"FavouriteName"in n.Data&&n.Data.FavouriteName.trim()!==""){c.dataset.favname=n.Data.FavouriteName.trim();var kt=this.getEmpFromRowDoc(n),v=this.getFavDisplayData(n.Data.FavouriteName,kt),st=v.display,g=v.hover;this.swapFavNameIfOnBehalf&&this.onBehalf&&(st=v.hover,g=v.display),r="<strong>"+st+"<\/strong>",i="",u=g?g:"(Saved "+this.baseLang.favourites.name+")",b.addClass("hidden"),k.addClass("hidden"),ut.addClass("ui-has-tooltip").set("data-tooltip",u+"").set("data-tooltip-dir","top"),u.length>this.maxLabelLength&&(u=u.substr(0,this.maxLabelLength)+"&#133;"),ot=!0}else Object.each(y,function(n,t){d=n.toLowerCase().capitalize().trim().replace(/  /g," "),d.trim()!==""&&(i!==""&&(i+=", "),lt&&(i+=t+": "),i+=this.sanatizeKeyValueDisplay(t,d))}.bind(this)),(r.toLowerCase().contains("project")||r.toLowerCase().contains("job"))&&(i+u).trim()===""&&(i="Units / Times Only"),r.toLowerCase().contains("project")||r.toLowerCase().contains("job")||(i+u).trim()!==""||(i="Units / Times"),r=r.replace(/  /g," "),ut.addClass("ui-has-tooltip").set("data-tooltip",r+"").set("data-tooltip-dir","top"),r.length>this.maxLabelLength&&(r=r.substr(0,this.maxLabelLength)+"&#133;");for(ot||(i.trim()===""&&u.trim()!=""&&(i=u+"",u=""),r.trim()===""&&i.trim()!=""&&(r=i+"",i="")),f=[r,i,u],s=0;s<f.length;s++)e=f[s],e.trim().indexOf("- ")===0&&(f[s]=e.trim().substring(2).trim()),e.contains(", - ")&&(f[s]=e.replace(", - ",", ")),e.contains(",- ")&&(f[s]=e.replace(",- ",", ")),e.contains("&Amp;")&&(f[s]=e.replace("&Amp;","&amp;"));r=f[0],i=f[1],u=f[2],it.set("html",r),b.set("html",i),rt.set("html",u),ft.set("html",r),k.set("html",i),et.set("html",u),ht=new Element("td",{"class":"timesheet-col timeslots"}).inject(o),bt.inject(ht),h=new Element("td",{"class":"timesheet-col buttons"}),this.onBehalf?(this.readOnlyOverride||(p?h.adopt(new Element("span",{"class":"button green disabled w-icon-only",html:"<span>"+Affinity.icons.ThumbsUp+"<\/span>"}),new Element("span",{"class":"button red disabled w-icon-only",html:"<span>"+Affinity.icons.ThumbsDown+"<\/span>"})):h.adopt(new Element("span",{"class":"button approve row"+l+" green w-icon-only ui-has-tooltip",html:"<span>"+Affinity.icons.ThumbsUp+"<\/span>","data-tooltip":"Approve all in this row","data-tooltip-dir":"top,left"}).addEvent(Affinity.events.click,this.submitRow),new Element("span",{"class":"button decline row"+l+" red w-icon-only ui-has-tooltip",html:"<span>"+Affinity.icons.ThumbsDown+"<\/span>","data-tooltip":"Decline all in this row","data-tooltip-dir":"top,left"}).addEvent(Affinity.events.click,this.submitRow))),h.inject(o)):(this.readOnlyOverride||(p?h.adopt(new Element("span",{"class":"button disabled green w-icon-only",html:"<span>"+Affinity.icons.Paperplane+"<\/span>"})):h.adopt(new Element("span",{"class":"button submit row"+l+" green w-icon-only ui-has-tooltip",html:"<span>"+Affinity.icons.Paperplane+"<\/span>","data-tooltip":"Submit all in this row","data-tooltip-dir":"top,left"}).addEvent(Affinity.events.click,this.submitRow))),h.inject(o)),ct=this.generateTemplateDoc(n),o.store("templateDoc",ct),Affinity.tooltips.processNew(),this.currentGroupRows.push(o)},getRowStatus:function(n){for(var t,r=!1,i=n.Children.length-1;i>=0;i--)if(t=n.Children[i],t.Source&&t.Source.PropertyName&&t.Source.PropertyName.test("status","gi")){r=t.ValueAsString.toLowerCase();break}return r},returnFavouritisedPostDoc:function(n,t){var f=Object.clone(this.options.parentDocument),e=Object.clone(this.options.widgetDocument),u;n.hasOwnProperty("Data")||(n.Data={}),n.Data.FavouriteName=t.trim(),n.Data.IsFavourite=!0;var i=-1,o=-1,r=!1,s=!1;return Array.each(n.Children,function(t,u){t.Name.toLowerCase().contains("-rowbutton")&&(i=u,Array.each(t.Children,function(t,u){r||(r=t.Name,s=t.Value.ButtonType),n.Children[i].Children[u].Value.Pressed=!1,t.Value.ButtonType.toLowerCase()==="favourite"&&(n.Children[i].Children[u].Value.Pressed=!0,o=u)}.bind(this)))}.bind(this)),o===-1&&(u={Label:"Favourite",ButtonType:"Favourite",Pressed:!0},n.Children[i].Children.push({ValueAsString:JSON.stringify(u),Value:u,Layout:{Rank:0},ElementType:"TimesheetRowButton",Name:r.replace(s,"Favourite")}),n.Data.InsertedFavourite=!0),e.Children=[n],f.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex]=e,f},favNameEdit:function(n){var r,e;if(Affinity.enableFavourites){var f=n.target.getParent(".timesheet-row"),t=f?f.retrieve("templateDoc"):!1,o=!1,i=!1,u=this.onBehalf?this.onBehalfData.number:this.userData?this.userData.employeeNumber:Affinity.login.profile.employeeNumber,s=this.baseAppLang.favourites.views.calendar.createMessage,h=!1;t&&t.hasOwnProperty("Data")&&t.Data.hasOwnProperty("FavouriteName")&&(o=!0,i=t.Data.FavouriteName,r=1,e=this.returnEmpKey(u),Object.each(this.favourites[e],function(n){if(n.Name===i){r=n.Type;return}}),h=Affinity.zelosroot+"?api=Favourite/RenameFavourite&timesheetType="+r+"&employeeNo="+u+"&OldName="+i+"&NewName=",s=this.baseAppLang.favourites.renameMessage),t?this.promptforFavName(t,u,r,i,!1,!1,""):uialert({message:this.baseAppLang.favourites.noneError,showButtons:!0,noClose:!1})}},promptforFavName:function(n,t,i,r,u,f){var e=!1,o=this.baseAppLang.favourites.views.calendar.createMessage;r&&(e=Affinity.zelosroot+"?api=Favourite/RenameFavourite&timesheetType="+i+"&employeeNo="+t+"&OldName="+r+"&NewName=",o=this.baseAppLang.favourites.renameMessage),typeOf(u)==="string"&&(u=u.trim().length===0?this.genLang.error:u,o=u+"<br />Please try again."),uiprompt({message:o,showButtons:!0,noClose:!1,value:typeOf(f)==="string"?f:r?r:"",onOk:function(u){var o=this.baseLang.favourites.validation.validateName(u),h,s,f;if(!o.isValid){this.promptforFavName.delay(50,this,[n,t,i,r,o.error,u]);return}r?(uialert({message:this.baseAppLang.favourites.renamingMessage+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),e+=u.trim(),h=new Request.JSON({url:e,onComplete:function(n){if(n.hasOwnProperty("success")&&n.success===!1&&n.hasOwnProperty("error")&&typeOf(n.error)==="string"){var t=n.error.trim()!==""?n.error.trim():this.genLang.error,t=Affinity.CheckFavError(n,t);uialert({message:this.genLang.errorPrefix+" "+t+"<br />"+this.genLang.tryAgain,showButtons:!0});return}setTimeout(function(){uialert({message:this.globalLang.waitForNameChange+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0}),setTimeout(function(){this.refresh()}.bind(this),3e3)}.bind(this),3e3)}.bind(this),onFailure:function(){uialert({message:this.genLang.error+"<br />"+this.genLang.tryAgain,showButtons:!0})}.bind(this),onError:function(n){var t=Affinity.CheckFavError(n,this.genLang.error+"<br />"+this.genLang.tryAgain);uialert({message:t,showButtons:!0})}.bind(this)}).post()):(s=this.returnFavouritisedPostDoc(n,u),f=["saving "+this.baseLang.favourites.name,"saved "+this.baseLang.favourites.name],this.postDocumentRow(s,f[0],f[1]))}.bind(this)})},processTimesheet:function(n){var t;this.timesheetDocument=n,this.checkForFullRowLock=!1,this.checkForFullRowLockData=[],n.hasOwnProperty("Data")&&n.Data.hasOwnProperty("GroupIdentifierData")&&(this.checkForFullRowLock=!0,this.checkForFullRowLockData=n.Data.GroupIdentifierData),Array.each(n.Children,function(i,r){this.generateKey(i,!0),(!("Data"in i)||"Data"in i&&!("RowType"in i.Data)||"Data"in i&&"RowType"in i.Data&&i.Data.RowType==="Timesheet")&&(Array.each(i.Children,function(t,i){t.Name.toLowerCase().contains("bulkprocess")&&(n.Children[r].Children[i].Value=!0,n.Children[r].Children[i].ValueAsString="True")}),t=this.generateGroupIdentifier(i.Data.GroupIdentifier),typeOf(this.currentGoups[t])==="null"&&(this.currentGoups[t]=[],this.insertGroupRow(i)),this.currentGoups[t].push(i))}.bind(this)),this.checkForRows()},isDateVisible:function(n){var r=this.showDays,t=this.date.clone().clearTime(),i=this.date.clone().increment("day",r).clearTime();return n>=t&&n<=i?!0:(t=this.loadTimesheetsFrom.clone().clearTime(),i=this.loadTimesheetsTo.clone().clearTime(),n>=t&&n<=i)?!0:!1},insertImmutableIcon:function(n,t){var i,r=!1,u=!1,f=this.lang.application.timesheets.globals;Array.each(t.Children,function(t){t.Name.test("tscode","gi")&&(r=!0,t.InputType==="Lookup"?(u=!0,i=Affinity.lookupapi+"?ModelName="+t.Source.ModelName+"&PropertyName="+t.Source.PropertyName+"&Key="+t.Value,log("&#x2794; attempting xxx ..."),log("&#x2794; attempting weekly insertImmutableIcon ..."),new Request.JSONP({callbackKey:"jsoncallback",url:i,method:"get",noCache:!0,onComplete:function(t){if(!JSON.Unauthorized(t,"weekly, insertImmutableIcon - "+i)){if(log("&#x2714; attempted  weekly insertImmutableIcon succeeded"),typeOf(t)==="array"&&typeOf(t[0].Value)!=="null"&&typeOf(t[0].Key)!=="null"&&t[0].Value!==""){var r=t[0].Value.split(",").sort(function(n,t){return t.length-n.length})[0];new Element("div",{html:Affinity.icons.Lock,"class":"message-icon grey print-hidden ui-has-tooltip","data-tooltip":r+" can not be modified"}).inject(n)}else new Element("div",{html:Affinity.icons.Lock,"class":"message-icon grey print-hidden ui-has-tooltip","data-tooltip":"Pay Code "+t[0].Key+" can not be modified"}).inject(n);Affinity.tooltips&&Affinity.tooltips.processNew()}}.bind(this)}).send()):new Element("div",{html:Affinity.icons.Lock,"class":"message-icon grey print-hidden ui-has-tooltip","data-tooltip":t.Value+" can not be modified"}).inject(n))}.bind(this)),r||u||new Element("div",{html:Affinity.icons.Lock,"class":"message-icon grey print-hidden ui-has-tooltip","data-tooltip":"This can not be modified"}).inject(n),r=u=null},setTimesheetValues:function(){var h=0,c,e,u,o,f,i,r,l,a,t,n,v,s;Object.each(this.currentGoups,function(y){Array.each(y,function(y){if(c=this.generateGroupIdentifier(y.Data.GroupIdentifier),e=this.rowTarget.getElement("#"+c),u=y.Attribute.IsReadOnly,typeOf(e)!=="null"&&(Array.each(y.Children,function(n){n.Name.toLowerCase().contains("tsdate")&&(o=Date.parse(n.ValueAsString)),n.Name.toLowerCase().contains("tsnet")&&(f=parseFloat(n.ValueAsString),this.disableReadOnlyUnits&&(u=!u&&n.Attribute.IsReadOnly?!0:u)),n.Name.toLowerCase().contains("tsstatus")&&(i=n.ValueAsString.toLowerCase()),n.Name.toLowerCase().contains("authoriserid")&&(r=n.ValueAsString.toLowerCase())}.bind(this)),this.isDateVisible(o)&&i!=="new"&&(a="d"+o.getTime(),t=e.getElement("."+a),t&&(t.getElements(".message-icon").destroy(),y.Attribute&&y.Attribute.IsMessage&&y.Attribute.Message&&y.Attribute.Message!==""&&new Element("div",{html:Affinity.icons.Warning,"class":"message-icon warning yellow print-hidden ui-has-tooltip","data-tooltip":y.Attribute.Message}).inject(t),y.Attribute&&y.Attribute.IsError&&y.Attribute.ErrorMessage&&y.Attribute.ErrorMessage!==""&&new Element("div",{html:Affinity.icons.Warning,"class":"message-icon error red print-hidden ui-has-tooltip","data-tooltip":y.Attribute.ErrorMessage}).inject(t),i==="paid"&&new Element("div",{html:Affinity.icons.Moneybag,"class":"message-icon paid green print-hidden ui-has-tooltip","data-tooltip":this.globalLang.timesheetPaid}).inject(t),i==="immutable"&&this.insertImmutableIcon(t,y),n=t.getElement("input"),n)))){if(n.store("timesheetDoc",y),n.retrieve("changetracker")?n.retrieve("changetracker").setValue(n,f):n.value=f,u){n.set("disabled","disabled");var p="";t.getElement(".message-icon")&&(p+=t.getElement(".message-icon").get("data-tooltip")),parseInt(r)!==Affinity.login.EmployeeNumber?(typeof JSON.parse(r)=="object"&&(l=JSON.parse(r),r=!1,Array.each(l,function(n){n.selected&&(r=n.display)})),p+=r?(p===""?"":" - ")+"Assigned to "+r+" for approval":(p===""?"":" - ")+"Assigned to another manager for approval."):p+=(p===""?"":" - ")+"Assigned to another manager for approval",t.getElement(".message-icon")?t.getElement(".message-icon").set("data-tooltip",p):new Element("div",{html:Affinity.icons.Lock,"class":"message-icon grey readonly print-hidden ui-has-tooltip","data-tooltip":p,"data-tooltip-dir":"top,center"}).inject(t)}if(i.test("new","gi")||i.test("save","gi")||i.test("decline","gi")||(h+=f,v=e.getElements(".timeslot").indexOf(t),s=this.gridTotalsContainer.getElements(".daytotal")[v],s.set("html",Number.round(f+parseFloat(s.get("html")),this.unitRounding))),i)switch(i){case"pending":n.addClass("color "+this.statusNewEditedColor);break;case"submitted":n.addClass("color blue");break;case"declined":n.addClass("color red");break;case"approved":n.addClass("color green");break;case"paid":n.addClass("color green"),n.set("disabled","disabled");break;case"new":n.addClass("color "+this.statusNewEditedColor+" hi");break;case"immutable":n.addClass("color grey"),n.set("disabled","disabled")}}}.bind(this))}.bind(this)),this.gridTotal.set("html",Number.round(h,this.unitRounding)),this.checkChanges(),function(){if(this.tempstore.length>0){var n;Array.each(this.tempstore,function(t){this.table.getElement(t[0])&&(n=this.table.getElement(t[0]),(n.value.trim()===""||n.value.trim()!==t[1].trim())&&(n.retrieve("changetracker")?n.retrieve("changetracker").setValue(n,t[1]):n.value=t[1],this.hoursBlured({target:n})))}.bind(this)),this.tempstore=[]}this.checkChanges()}.delay(500,this),Affinity.tooltips&&Affinity.tooltips.processNew()},processErrors:function(n){var t=this.processDocumentErrors(n);return t.length>0?!0:!1},setDateHeadings:function(){var r,u,s,t;this.gridTotalsContainer.empty();var h,t,i,e,o,f=this.showDays,l=(new Date).clearTime().getTime(),n=this.loadTimesheetsFrom.clone(),a=n.clone(),c=new Element("div",{"class":"dateheadings-container"});if(this.currentDates.from===null||this.loadTimesheetsFrom.sameDay(this.currentDates.from)||(n=this.currentDates.from.clone(),a=n.clone()),this.isManager){for(this.getSizes(),this.managecolumnbuttons.getElements(".button")&&this.managecolumnbuttons.getElements(".button").removeEvents(),this.managecolumnbuttons.empty().addClass("hidden"),this.submitcolumnbuttons.getElements(".button")&&this.submitcolumnbuttons.getElements(".button").removeEvents(),this.submitcolumnbuttons.empty().addClass("hidden"),t=0;t<f;t++)r=new Element("div",{"class":"timeslotTitle"}).setStyle("width",this.cellWidth),this.readOnlyOverride||r.adopt(new Element("span",{"class":"button submit col"+t+" green w-icon-only ui-has-tooltip",html:"<span>"+Affinity.icons.Paperplane+"<\/span>","data-tooltip":"Submit all on this day","data-tooltip-dir":"top,center"}).addEvent(Affinity.events.click,this.submitCol)),r.inject(this.submitcolumnbuttons),u=new Element("div",{"class":"timeslotTitle"}).setStyle("width",this.cellWidth),this.readOnlyOverride||u.adopt(new Element("span",{"class":"button approve col"+t+" green w-icon-only ui-has-tooltip",html:"<span>"+Affinity.icons.ThumbsUp+"<\/span>","data-tooltip":"Approve all on this day","data-tooltip-dir":"top,center"}).addEvent(Affinity.events.click,this.submitCol),new Element("span",{"class":"button decline col"+t+" red w-icon-only ui-has-tooltip",html:"<span>"+Affinity.icons.ThumbsDown+"<\/span>","data-tooltip":"Decline all on this day","data-tooltip-dir":"bottom,center"}).addEvent(Affinity.events.click,this.submitCol)),u.inject(this.managecolumnbuttons);this.readOnlyOverride||(this.submitcolumnbuttons.inject(this.submitdaysButtons),this.managecolumnbuttons.inject(this.submitdaysButtons)),s=String(this.userData.employeeNumber).trim()||"",s!==""&&(s===String(this.defaultEmployeeNumber)?(this.submitcolumnbuttons.removeClass("hidden"),this.managecolumnbuttons.addClass("hidden")):(this.submitcolumnbuttons.addClass("hidden"),this.managecolumnbuttons.removeClass("hidden")))}else{for(this.submitcolumnbuttons.empty().addClass("hidden"),t=0;t<f;t++)r=new Element("div",{"class":"timeslotTitle"}).setStyle("width",this.cellWidth),this.readOnlyOverride||r.adopt(new Element("span",{"class":"button submit col"+t+" green w-icon-only ui-has-tooltip",html:"<span>"+Affinity.icons.Paperplane+"<\/span>","data-tooltip":"Submit all on this day","data-tooltip-dir":"top,center"}).addEvent(Affinity.events.click,this.submitCol)),r.inject(this.submitcolumnbuttons),u=new Element("div",{"class":"timeslotTitle"}).setStyle("width",this.cellWidth),u.inject(this.managecolumnbuttons);this.readOnlyOverride||this.submitcolumnbuttons.inject(this.submitdaysButtons),this.submitcolumnbuttons.removeClass("hidden")}for(t=0;t<f;t++)i="timeslotTitle",i=n.getTime()==l?i+" today":i,e=!1,typeOf(this.publicHolidays["d"+n.getTime()])!=="null"&&(e=new Element("span",{"class":"holiday-icon ui-has-tooltip",html:Affinity.icons.Plane,"data-tooltip":this.publicHolidays["d"+n.getTime()]}),i+=" holiday"),h=new Element("div",{"class":i,html:n.format("%a<br><span>%e<span>%o<\/span><\/span>")}).setStyle("width",this.cellWidth).adopt(e).inject(c),this.delegating&&Array.each(this.delegateEmployee,function(t,i){n>=this.delegateFrom[i]&&n<=this.delegateTo[i]&&h.adopt(new Element("span",{html:this.delegateIcon,"class":"delegate-info font-icons orange ui-has-tooltip","data-tooltip":"Delegating to "+t}))}.bind(this)),t==0&&(o=Affinity.mobile?"<span>"+n.format("%e %b")+"<\/span>to":"Showing period <span>"+n.format("%e%o of %b").trim()+"<\/span> to "),n=n.increment("day",1),new Element("div",{"class":"daytotal",html:"0"}).setStyle("width",this.cellWidth).inject(this.gridTotalsContainer);this.dateHeadings.getElement(".dateheadings-container")&&this.dateHeadings.getElement(".dateheadings-container").destroy(),c.inject(this.dateHeadings),n=n.decrement("day",1),o+=Affinity.mobile?"<span>"+n.format("%e %b %Y").trim()+"<\/span>":"<span>"+n.format("%e%o of %b, %Y").trim()+"<\/span>",this.dateHeading.set("html",f>1?o:"&nbsp;"),this.isDelegatingBox.set("html","").set("class",""),this.delegating&&this.isDelegatingBox.set("html",this.delegateIcon).set("data-tooltip","Delegating to "+this.delegateEmployee.unique().join(", ")+'.<br /><br />See <span class="inline-desc-button"><span>'+this.delegateIcon+"<\/span><\/span> for details.").addClass("font-icons orange ui-has-tooltip"),Affinity.tooltips.processNew()},returnTimeslots:function(n,t){var h;if(!t.getElement(".timeslots-container")){var l,o,s,u,f,a=this.showDays,e=t,v=(new Date).clearTime(),r=this.loadTimesheetsFrom.clone(),y=r.clone(),c=new Element("div",{"class":"timeslots-container"});for(this.currentDates.from===null||this.loadTimesheetsFrom.sameDay(this.currentDates.from)||(r=this.currentDates.from.clone(),y=r.clone()),c.inject(e),h=!1,e.getParent(".timesheet-row")&&e.getParent(".timesheet-row").retrieve("full-row-lock")&&(h=!0),i=0;i<a;i++)o=" row"+e.getParent("tr").get("data-row-index")+" col"+i,u=r.sameDay(v)?"timeslot today d"+r.getTime():"timeslot d"+r.getTime(),u+=o,s="",u=typeOf(this.publicHolidays["d"+r.getTime()])!=="null"?u+" holiday":u,u+=r<this.disableBefore||r>this.disableAfter?" outside-as":r.lessThan(this.greyBefore)||r.greaterThan(this.greyAfter)?" outside":" current",f=new Element("input",{"class":o.trim(),type:"text",value:s==0?"":s,autocomplete:"off"}),r<this.disableBefore||r>this.disableAfter?f.set("disabled","disabled"):this.readOnlyOverride||h?f.set("disabled","disabled"):f.addEvents({keydown:this.hoursInputKeyDown.bind(this),focus:this.hoursInputClicked.bind(this),blur:this.hoursBlured.bind(this)}).addChangeTracker(),l=new Element("div",{"class":u,"data-time":r.getTime()}).setStyles({width:this.cellWidth,height:this.cellHeight}).adopt(f).inject(c),r.increment("day",1);Affinity.tooltips.processNew()}},updateWorschduleError:function(n){if(this.insertWorkSchedule){var t=n.target.getParent(".timeslots-container"),i=t.getElement(".actual-total"),r=t.getElement(".schedule-remaining");i.innerHTML="",r.innerHTML=""}},updateWorschduleRemaining:function(n){this.insertWorkSchedule&&function(n){var i=parseInt(n.value),t=0,u=n.target.getParent(".timeslots-container"),e=u.getElement(".actual-total"),r=u.getElement(".schedule-remaining"),f;Array.each(u.getElements(".timeslot"),function(n){n.getElement("input")&&(f=n.getElement("input").value,f.trim()!==""&&(t+=parseFloat(f)))}.bind(this)),n.target.innerHTML=i,e.innerHTML=t,i-t<0?(r.removeClass("over").addClass("under"),r.innerHTML="+"+Math.abs(i-t)):i-t>0&&(r.removeClass("under").addClass("over"),r.innerHTML="-"+Math.abs(i-t))}.delay(500,this,n)},sanitizeHours:function(n){if(n.contains(":")){if(isNaN(n.replace(/\:/g,".")))return"";var t=n.split(":");return parseFloat(parseInt(t[0])+parseInt(t[1])/60).round(this.unitRounding)}return isNaN(n)?"":n},validateHours:function(n){var t=n.getParent(),i=n.value;i!==""&&(parseFloat(i)>24?(t.addClass("error"),t.addClass("ui-has-tooltip"),t.set("data-tooltip","This is greater than 24 hours"),Affinity.tooltips.processTooltip(t,!0,!0)):(t.removeClass("error"),Affinity.tooltips.removeTooltip(t))),i=t=null},hoursInputKeyDown:function(n){var t=!1;n.shift?(n.code==186&&(t=!0),n.code==187&&(t=!0)):((n.code==8||n.code==46)&&(t=!0),(n.code==109||n.code==189)&&(t=!0),n.code==107&&(t=!0),(n.code==110||n.code==190)&&(t=!0),n.code>=48&&n.code<=57&&(t=!0),n.code>=96&&n.code<=105&&(t=!0),n.code>=37&&n.code<=40&&(t=!0)),t||n.stop()},selectedValue:"",hoursInputClicked:function(n){this.selectedValue=n.target.value,n.target.select()},hoursBlured:function(n){var t=!1,i=n.target.retrieve("timesheetDoc");typeOf(i)!=="null"&&(t=this.getRowStatus(i)),t&&t!=="pending"&&this.selectedValue!==""&&n.target.value===""?uialert({message:"Clearing a value will not delete a timesheet.<\/br>If this timesheet has been saved or submitted, this change will be ignored.<br />Please contact your authoriser to delete a timesheet.",showButtons:!0,noClose:!1,onOk:function(){n.target.value=this.selectedValue,this.continueHoursBlured(n)}.bind(this)}):this.continueHoursBlured(n),delete i,delete t},continueHoursBlured:function(n){var r=!1,t,i;if(!Affinity.mobile||!this.mobileHalt){if(n.target.value=this.sanitizeHours(n.target.value),this.validateHours(n.target),r=n.target.hasChanged(),n.target.value+""!=this.selectedValue+""&&(n.target.addClass("class","widget color "+this.statusNewEditedColor+" hi"),r=!0),r&&n.target.value!==""&&(this.insertDocuemntRow(n.target),n.target.getParent(".timeslot").getElements(".message-icon").destroy()),n.target.value===""){if(t=n.target.retrieve("timesheetDoc"),t){for(i=0;i<t.Children.length;i++)if(t.Children[i].Name.test("TimesheetId","gi")){parseInt(t.Children[i].Value)===-1&&(n.target.store("timesheetDoc",!1),n.target.eliminate("timesheetDoc"),n.target.set("class","widget"));break}delete i}delete t}this.checkChanges()}},nextLast:function(n,t){var r=typeOf(t)==="boolean"?t:!1,i;if(!r&&this.hasChanges()){Affinity.tooltips.hideAll(),uiconfirm({message:"You are about to change dates with unsaved changes.<br /><br />"+this.getChangeMessage()+"<br /><br />Do you wish to continue?",onOk:function(){this.nextLast(n,!0)}.bind(this)});return}i=n.target.hasClass("button")?n.target:n.target.getParent(".button"),i.hasClass("last")?this.goBack():i.hasClass("next")&&this.goForward(),delete i},destroyCalendars:function(){Array.each(this.table.getElements("input.ui-calendar-display"),function(n){n.get("data-calendar-id")&&Affinity.uiDateCalendar.destroyCalendar(n.get("data-calendar-id"))})},jumpToToday:function(n){var t,i,r,u=typeOf(n)==="boolean"?n:!1;if(!u&&this.hasChanges()){Affinity.tooltips.hideAll(),uiconfirm({message:"You are about to change dates with unsaved changes.<br /><br />"+this.getChangeMessage()+"<br /><br />Do you wish to continue?",onOk:function(){this.jumpToToday(!0)}.bind(this)});return}t=(new Date).clearTime(),i=this.periodData.oldest.clone().clearTime(),r=this.periodData.newest.clone().clearTime(),t.greaterThanOrEqualTo(i)&&t.lessThanOrEqualTo(r)&&(this.periodIndex=this.periodData.periodTodayIndex,this.jumpToDate(!0))},goBack:function(){this.periodIndex-1>=0&&(this.periodIndex=this.periodIndex-1,this.jumpToDate(!0))},goForward:function(){this.periodIndex+1<this.periodData.periods.length&&(this.periodIndex=this.periodIndex+1,this.jumpToDate(!0))},jumpToDate:function(n){var t=typeOf(n)==="boolean"?n:!1;if(!t&&this.hasChanges()){Affinity.tooltips.hideAll(),uiconfirm({message:"You are about to change dates with unsaved changes.<br /><br />"+this.getChangeMessage()+"<br /><br />Do you wish to continue?",onOk:function(){this.jumpToDate(!0)}.bind(this)});return}this.loadTimesheetsFrom=this.periodData.periods[this.periodIndex].from.clone(),this.loadTimesheetsTo=this.periodData.periods[this.periodIndex].to.clone(),this.currentDates.from=this.loadTimesheetsFrom.clone(),this.currentDates.to=this.loadTimesheetsTo.clone(),this.date=this.loadTimesheetsFrom.clone(),this.nextButton.removeClass("disabled"),this.lastButton.removeClass("disabled"),this.periodIndex===0&&this.lastButton.addClass("disabled"),this.periodIndex===this.periodData.periods.length-1&&this.nextButton.addClass("disabled"),this.wrapper.fade("out"),function(){this.clearWeek(),this.setDateHeadings(this.showDays),this.loadNewRows(this.zelosProcessor.options.getApi,"Load")}.delay(250,this)},clearTotals:function(){Array.each(this.gridTotalsContainer.getElements(".daytotal"),function(n){n.set("html",0)})},clearWeek:function(){this.destroyCalendars(),this.clearTotals(),this.rowTarget.getElements(".timeslots-container")&&this.rowTarget.getElements(".timeslots-container").destroy(),this.dateHeadings.getElement(".dateheadings-container")&&this.dateHeadings.getElement(".dateheadings-container").destroy()},setupWeek:function(){this.clearWeek(),function(){this.table.removeClass("daymode"),this.table.addClass("weekmode"),this.setDateHeadings(this.showDays),Array.each(this.rowTarget.getElements(".timesheet-row"),function(n){this.returnTimeslots(this.showDays,n.getElement(".timesheet-col.timeslots"))}.bind(this)),this.clearTotals(),this.setTimesheetValues(),this.wrapper.fade("in")}.delay(250,this)},getNetFromRow:function(n){for(var t=n.Children.length-1;t>=0;t--)if(child=n.Children[t],child.Source&&child.Source.PropertyName&&child.Source.PropertyName.test("tsnet","gi"))return child.Value},setNetToRow:function(n,t){for(var r=!1,u=!1,i=n.Children.length-1;i>=0;i--){if(child=n.Children[i],child.Source&&child.Source.PropertyName&&child.Source.PropertyName.test("tsnet","gi")&&(child.Value=parseFloat(t),child.ValueAsString=t+"",r=!0,r&&u))break;if(child.Name.test("BulkProcess","gi")&&(child.Value=!0,child.ValueAsString="True",u=!0,r&&u))break}return n},setNetAndDateToRow:function(n,t,i){for(var u=!1,f=!1,e=!1,r=n.Children.length-1;r>=0;r--){if(child=n.Children[r],child.Source&&child.Source.PropertyName&&child.Source.PropertyName.test("tsnet","gi")&&(child.Value=parseFloat(t),child.ValueAsString=t+"",u=!0,u&&f&&e))break;if(child.Name.test("tsDate","gi")&&(child.Value=i,child.ValueAsString=i,f=!0,u&&f&&e))break;if(child.Name.test("BulkProcess","gi")&&(child.Value=!0,child.ValueAsString="True",e=!0,u&&f&&e))break}return n},setEmployeeToRow:function(n,t,i){for(var u=!1,f=!1,e=!1,r=n.Children.length-1;r>=0;r--){if(child=n.Children[r],child.Source&&child.Source.PropertyName&&child.Source.PropertyName.test("EmployeeNo","gi")&&(child.Value=t,child.ValueAsString=t+"",u=!0,u&&f&&e))break;if(child.Source&&child.Source.PropertyName&&child.Source.PropertyName.test("EmployeeName","gi")&&(child.Value=i,child.ValueAsString=i+"",f=!0,u&&f&&e))break;if(child.Name.test("BulkProcess","gi")&&(child.Value=!0,child.ValueAsString="True",e=!0,u&&f&&e))break}return n},setButtonClickToRow:function(n,t){for(var i=n.Children.length-1;i>=0;i--)if(child=n.Children[i],child.Name.test("RowButton","gi")){Array.each(child.Children,function(n,i){child.Children[i].Value.Pressed=child.Children[i].Name.test(t,"gi")?!0:!1,child.Children[i].ValueAsString=JSON.stringify(child.Children[i].Value)});break}return n},insertDocuemntRow:function(n){var i=n.getParent(".timesheet-row"),r=parseInt(n.getParent(".timeslot").get("data-time")),u=Date.parse(r),t=!1;n.retrieve("timesheetDoc")?t=n.retrieve("timesheetDoc"):i.retrieve("templateDoc")&&(t=Object.clone(i.retrieve("templateDoc")),t&&(t.Name="Row"+String.uniqueID())),this.onBehalf&&(t=this.setEmployeeToRow(t,this.onBehalfData.number,this.onBehalfData.name)),t&&(t=this.setNetAndDateToRow(t,n.value,u.format("zelos")),n.store("timesheetDoc",t),n.removeClass("color"),n.removeClass("hi"),n.removeClass("black"),n.removeClass("blue"),n.removeClass("orange"),n.removeClass("green"),n.removeClass("red"),n.removeClass("grey"),n.addClass("color "+this.statusNewEditedColor+" hi"))},addRows:function(){},returnDocument:function(){var n,t=Object.clone(this.options.widgetDocument);return t.Children=[],Array.each(this.target.getElements(".timeslot input"),function(i){n=i.retrieve("timesheetDoc"),n&&(n=this.setNetToRow(n,i.value),t.Children.push(n))}.bind(this)),t},checkSelected:function(){var n=!1,t=!0;return Array.each(this.target.getElements(".timeslot input"),function(i){i.value===""?t=!1:n=!0}.bind(this)),{anyChecked:n,allChecked:t}},promptVisible:!1,errorStore:!1,sanatiseErrorMessage:function(n){var t=n.replace("an submitted","a submitted");return t.replace("Field 'Units'","'Hours'")},processDocumentErrors:function(n){var r,u,i,e,t,o,f=[];return Array.each(n.Children,function(n){Array.each(n.Children,function(n){n.ElementType=="TimesheetTable"&&Array.each(n.Children,function(n){r=!1,u=!1,i=!1,e=this.generateKey(n),t=document.getElement(".key_"+e),o=document.getElements(".timesheet-row").indexOf(t),n.Attribute&&n.Attribute.IsError&&n.Attribute.ErrorMessage&&(i=this.sanatiseErrorMessage(n.Attribute.ErrorMessage)),i&&t&&Array.each(n.Children,function(n){if(n.Name.test("date","gi")&&n&&n.hasOwnProperty("Value")&&t){var i=!1,f,e,o;try{i=Date.parse(n.Value)}catch(s){}i&&(f=t.getElement(".d"+i.format("%s")+"000")||!1,f&&(e=t.getElements(".timeslot")||!1,e&&(o=e.indexOf(f)||!1,o&&(u=i,r=o))))}}.bind(this)),u&&r!==!1&&i&&f.push("Row "+(o+1)+" Column "+(r+1)+" ("+u.format("%a %e%o %b")+") has an error:<br />"+i)}.bind(this))}.bind(this))}.bind(this)),f.length>0&&(typeOf(this.errormsg)==="null"&&(this.errormsg="Timesheet(s) processed with errors.<br />"),this.errorStore=this.genLang.error+"<br />"+this.errormsg+"<br />"+f.join("<br /><br />")),f},sanatisePostJson:function(n){var t=JSON.encode(n);return t=t.replace(new RegExp("&amp;","gi"),"%26"),t=t.replace(new RegExp("&","gi"),"%26"),escape(t)},postDocumentRow:function(n,t,i){var e,f,o,h,c,r,u,s;this.errormsg='Timesheet(s) processed with errors.<span class="hidden"> while '+i+"<\/span><br />",window.uialert({message:t.capitalize()+' <img src="'+Affinity.loaders.dark+'" />',noClose:!0,showButtons:!1}),u="Oh no! We had trouble "+t.toLowerCase()+" your timesheet.<br />",s="Got it! Your timesheet has been "+i+".",t.contains("favourite")&&(this.errormsg=this.baseAppLang.favourites.views.calendar.processedWithError+'<span class="hidden"> while '+i+"<\/span><br />",u=this.baseAppLang.favourites.views.calendar.processedFailed+".<br />",s=this.baseAppLang.favourites.views.calendar.processedSuccess),e=this.options.putApi,this.onBehalf&&(e=this.options.putApi.replace(/Timesheet\/Post/gi,"TimesheetAsManager/Post")),f=new URI(e),o=typeOf(f.parsed.query)==="null"?{}:f.parsed.query.parseQueryString(),this.onBehalf&&(o.employeeNo=this.onBehalfData.number),f.parsed.query=Object.toQueryString(o),log("&#x2794; attempting weekly postDocumentRow ..."),h=this.sanatisePostJson(n),new Request.JSON({method:"POST",url:f.toString(),noCache:!0,timeout:3e5,onSuccess:function(n){JSON.Unauthorized(n,"weekly, postDocumentRow - "+f.toString())||(n.error?(log("&#x2718; attempted weekly postDocumentRow succeeded with errors - "+n.error),window.uialert({message:u+n.error})):(c=this.processDocumentErrors(n),c.length===0?(window.uialert({message:s,noClose:!0}),function(){Affinity.prompts.hide(),this.refresh(null,!0)}.delay(1e3,this)):this.refresh(null,!0)))}.bind(this),onError:function(n,t){r=n.error?n.error:t.response?t.response:n,r.contains("401")?Affinity&&Affinity.login&&Affinity.login.session?(log("&#x270B; attempted weekly postDocumentRow unauthorized &#x270B;"),window.fireEvent("unauthorized")):(log("&#x2718; attempted weekly postDocumentRow failed with errors - "+jsonData.error),window.uialert({message:u+"You have been logged out by another system. Please try logging in again."})):(log("&#x2718; attempted weekly postDocumentRow failed with errors - "+r),window.uialert({message:u+r}))}.bind(this),onFailure:function(n,t){r=n.response?n.response:n.responseText?n.responseText:t,r&&r.contains("401")?Affinity&&Affinity.login&&Affinity.login.session?(log("&#x270B; attempted weekly postDocumentRow unauthorized &#x270B;"),window.fireEvent("unauthorized")):(log("&#x2718; attempted weekly postDocumentRow failed - "+n.statusText),window.uialert({message:u+n.statusText})):(log("&#x2718; attempted weekly postDocumentRow failed - "+n.statusText),window.uialert({message:u+n.statusText}))}.bind(this),onException:function(n,t){log("&#x2718; attempted weekly postDocumentRow failed with exception - "+n+": "+t),window.uialert({message:"Oh no! Something went wrong!<br />There was a problem with the header "+n+": "+t})}.bind(this),onTimeout:function(){log("&#x2718; attempted weekly postDocumentRow timed out"),window.uialert({message:"Oh no! We reached the timeout limit!<br />Please check your connection and try again."})}}).post("="+h)},tempstore:[],checkRowForSubmit:function(n,t){var i=!1,r=!1;return n&&(this.isEmployee?this.isManager?this.onBehalf?i=!0:r=!0:r=!0:i=!0,!i&&r&&t.hasChanged()&&(i=!0),i||this.getRowStatus(n)!=="pending"||(i=!0)),i},submitRow:function(n,t){return window.uialert({message:'Saving <img src="'+Affinity.loaders.dark+'" />',noClose:!0,showButtons:!1}),this.doSubmitRow.delay(this.clickDelay,this,[n,t])},doSubmitRow:function(n,t){var u,r,h,i,f,o,c,s,e;if(Affinity.mobile&&(this.mobileHalt=!0),u=n.target.hasClass("button")?n.target:n.target.getParent(".button"),r="submit",r=u.hasClass("approve")?"approve":r,r=u.hasClass("decline")?"decline":r,delete u,h=n.target.getParent(".timesheet-row"),f=Object.clone(this.options.widgetDocument),f.Children=[],this.tempstore=[],c=this.table.getElements(".timesheet-row"),Array.each(c,function(n){Array.each(n.getElements(".timeslot input"),function(t){i=!1,n===h?(i=t.retrieve("timesheetDoc"),i||t.value.trim()===""||(t.value=this.sanitizeHours(t.value),this.validateHours(t),t.value!==""&&(this.insertDocuemntRow(t),i=t.retrieve("timesheetDoc")))):t.value.trim()!==""&&(o="tr.key_"+this.generateKey(t.retrieve("timesheetDoc"))+" input.",Array.each(t.get("class").split(" "),function(n){o+=n.contains("col")&&!n.contains("color")?n.trim():""}),this.tempstore.push([o,t.value])),this.checkRowForSubmit(i,t)&&(i=this.setButtonClickToRow(i,r),i=this.setNetToRow(i,t.value),f.Children.push(i))}.bind(this))}.bind(this)),s=["sending","sent"],e=Object.clone(this.options.parentDocument),e.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex]=f,typeOf(t)!=="null"&&t)return e;(function(){this.postDocumentRow(e,s[0],s[1]),this.mobileHalt=!1}).delay(500,this)},submitCol:function(n){window.uialert({message:'Submitting <img src="'+Affinity.loaders.dark+'" />',noClose:!0,showButtons:!1}),function(){var f,r,i,u,t,e,o,c,s,h;(Affinity.mobile&&(this.mobileHalt=!0),f=n.target.hasClass("button")?n.target:n.target.getParent(".button"),r="submit",r=f.hasClass("approve")?"approve":r,r=f.hasClass("decline")?"decline":r,delete f,i=n.target.getParent(".timeslotTitle"),u=!1,i.getParent(".submitdays-container")&&(u=i.getParent(".submitdays-container").getElements(".timeslotTitle").indexOf(i)),i.getParent(".managedays-container")&&(u=i.getParent(".managedays-container").getElements(".timeslotTitle").indexOf(i)),u!==!1)&&(e=Object.clone(this.options.widgetDocument),e.Children=[],this.tempstore=[],c=this.table.getElements(".timesheet-row"),Array.each(c,function(n){Array.each(n.getElements(".timeslot input"),function(n,i){t=!1,i===u?(t=n.retrieve("timesheetDoc"),t||n.value.trim()===""||(n.value=this.sanitizeHours(n.value),this.validateHours(n),n.value!==""&&(this.insertDocuemntRow(n),t=n.retrieve("timesheetDoc")))):n.value.trim()!==""&&(o="tr.key_"+this.generateKey(n.retrieve("timesheetDoc"))+" input.",Array.each(n.get("class").split(" "),function(n){o+=n.contains("col")&&!n.contains("color")?n.trim():""}),this.tempstore.push([o,n.value])),this.checkRowForSubmit(t,n)&&(t=this.setButtonClickToRow(t,r),t=this.setNetToRow(t,n.value),e.Children.push(t))}.bind(this))}.bind(this)),s=["sending","sent"],h=Object.clone(this.options.parentDocument),h.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex]=e,function(){this.postDocumentRow(h,s[0],s[1]),this.mobileHalt=!1}.delay(500,this))}.delay(this.clickDelay,this)},submitWeek:function(n){var i=n.target.hasClass("button")?n.target:n.target.getParent(".button"),t="submit",r;if(t=i.hasClass("approve")?"approve":t,t=i.hasClass("decline")?"decline":t,r=["sending all","sent all"],t==="approve")r=["approving all","approved all"];else if(t==="decline")r=["declining all","declined all"];else if(t==="submit")r=["submitting all","submitted all"];else return this.mobileHalt=!1,!1;window.uialert({message:r[0].capitalize()+' Timesheets <img src="'+Affinity.loaders.dark+'" />',noClose:!0,showButtons:!1}),function(){var n,u,f;Affinity.mobile&&(this.mobileHalt=!0),n=Object.clone(this.options.widgetDocument),n.Children=[],Array.each(this.table.getElements(".timesheet-row"),function(r){i=!1,t==="approve"?i=r.getElement(".button.approve"):t==="decline"?i=r.getElement(".button.decline"):t==="submit"&&(i=r.getElement(".button.submit")),i&&(u=this.doSubmitRow({target:i},!0),Array.each(u.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex].Children,function(t){n.Children.push(t)}.bind(this)))}.bind(this)),delete u,delete i,f=Object.clone(this.options.parentDocument),f.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex]=n,function(){this.postDocumentRow(f,r[0],r[1]),this.mobileHalt=!1}.delay(500,this)}.delay(this.clickDelay,this)},newRowsLoader:null,loadNewRows:function(n,t){n=this.onBehalf?unescape(n).replace(/Timesheet\/Get/gi,"TimesheetAsManager/Get"):unescape(n).replace(/TimesheetAsManager\/Get/gi,"Timesheet/Get");var r=new URI(n),i=typeOf(r.parsed.query)==="null"?{}:r.parsed.query.parseQueryString();i.fromDate=this.loadTimesheetsFrom.format("%d.%b.%Y"),i.toDate=this.loadTimesheetsTo.format("%d.%b.%Y"),this.currentDates.from===null||this.loadTimesheetsFrom.sameDay(this.currentDates.from)||(i.fromDate=this.currentDates.from.format("%d.%b.%Y")),this.currentDates.to===null||this.loadTimesheetsTo.sameDay(this.currentDates.to)||(i.toDate=this.currentDates.to.format("%d.%b.%Y")),this.onBehalf&&(i.employeeNo=this.onBehalfData.number,i.view="week"),r.parsed.query=Object.toQueryString(i),n=r.toString(),this.doChangeChecks=!1,this.newRowsLoader&&this.newRowsLoader.cancel(),this.options.zelosProcessor.options.getApi=n,n+=n.contains("?")?"&ran="+String.uniqueID():"?ran="+String.uniqueID(),log("&#x2794; attempting weekly loadNewRows ..."),this.newRowsLoader=new ZelosTemplateLoad({onRequest:function(){uialert({message:t+"ing",noClose:!0,showLoader:!0,showButtons:!1})},onError:function(n){log("&#x2718; attempted weekly loadNewRows failed with errors - "+n),uialert({message:t+" Failed.<br />"+n}),this.newRowsLoader=!1}.bind(this),onFailure:function(n){log("&#x2718; attempted weekly loadNewRows failed - "+n.statusText),this.showAlerts&&uialert({message:t+" Failed."}),this.newRowsLoader=!1}.bind(this),onComplete:function(t){JSON.Unauthorized(t,"weekly, loadNewRows - "+n)||(log("&#x2714; attempted weekly loadNewRows succeeded"),this.destroyRows(),this.options.widgetDocument=t.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex],this.processTimesheet(this.options.widgetDocument),this.setupWeek(),this.errorStore?(window.uialert({message:this.errorStore,showButtons:!0}),this.errorStore=!1):Affinity.prompts.hide())}.bind(this)}).loadTemplate(n)},processorCalledRefresh:!1,refresh:function(n,t){Affinity.showProdConsole&&console.log("calendar view refresh called; with favourites enabled: ",Affinity.enableFavourites),uialert({message:"Refreshing",noClose:!0,showLoader:!0,showButtons:!1}),Affinity.enableFavourites?this.getFavs(function(){this.refreshCallback(n,t)}.bind(this)):this.refreshCallback(n,t)},refreshCallback:function(n,t){var r=typeOf(n)==="object"||typeOf(n)==="array"?!0:!1,i=typeOf(t)==="boolean"?t:!1;if(i=this.tempstore.length>0?!0:i,Affinity.showProdConsole&&console.log("calendar view refreshCallback called; with doc: ",r,"; with ignoreChanges: ",i),!i&&this.hasChanges()){Affinity.tooltips.hideAll(),uiconfirm({message:"You are about to refresh with unsaved changes.<br /><br />"+this.getChangeMessage()+"<br /><br />Do you wish to continue?",onOk:function(){this.refresh(n,!0)}.bind(this)});return}if(typeOf(n)!=="null"&&n!==!1){this.processorCalledRefresh=!0;return}if(log("&#171; refresh weekly view &#187;"),this.onBehalf){this.switchUser({target:this.switchEmployeeSelect,refreshing:!0});return}if(typeOf(n)!=="null"&&typeOf(n)!=="domevent"&&n!==!1){if(n.ElementType=="Document")this.options.parentDocument=n,this.options.widgetDocument=this.options.parentDocument.Children[this.options.parentSectionIndex].Children[this.options.parentChildIndex],Affinity.showProdConsole&&console.log('calendar view refreshCallback set document"');else if(n.ElementType=="TimesheetTable"){Affinity.showProdConsole&&console.log('calendar view refreshCallback called "loadNewRows"'),this.loadNewRows(this.zelosProcessor.options.getApi,"Refresh");return}}else Affinity.showProdConsole&&console.log('calendar view refreshCallback called "loadNewRows"'),this.loadNewRows(this.zelosProcessor.options.getApi,"Refresh");this.switchEmployeeBox&&this.switchEmployeeBox.removeClass("hidden")},highlightRow:function(n){n.addClass("highlight");for(var t=1;t<16;t++)(function(){n.addClass("highlight")}).delay(t*100),function(){n.removeClass("highlight")}.delay((t+1)*100),t++},addNewGroup:function(){var e=this.addGroupZelosProcessor.updateDocument(),f=String.uniqueID(),n=e.Children[0],r=!1,i,u,t;n.ElementType="TimesheetRow",n.Name=f,i=this.generateKey(n,!1),this.table.getElement(".key_"+i)&&(r=!0),r||(i=this.generateKey(n,!0),this.table.getElement(".key_"+i)&&(r=!0)),r?(uialert({message:"Hey! A row already exists for these settings!",onOk:function(){this.highlightRow(this.table.getElement(".key_"+i))}.bind(this)}),this.clearAddForm()):(n.Data={},n.Data.GroupValue={},Array.each(this.addFormInner.getElements(".widget"),function(i){t=i.retrieve("widget"),t&&"selectElement"in t&&t.selectElement.getElements("option")&&t.selectElement.getElements("option").length>0&&t.selectElement.getElements("option")[t.selectElement.selectedIndex]&&(u=t.selectElement.getElements("option")[t.selectElement.selectedIndex],n.Data.GroupValue[t.selectElement.get("id").split("-").getLast()]=u.get("html").replace(u.get("value"),"").replace(/\(\)|\,/g,"").trim())}.bind(this)),n.Data.GroupValue=JSON.stringify(n.Data.GroupValue),n.Data.GroupIdentifier=f,this.hideAddRowsForm(),this.insertGroupRow(n,!0),this.returnTimeslots(this.showDays,this.table.getElement(".key_"+i).getElement(".timesheet-col.timeslots"))),this.checkForRows()},addRowTemplateLoader:null,addRowTemplateFor:null,addRowsFormSatus:"closed",clearAddForm:function(){var t,n;document.getElement(".timesheetAddFrom")&&Array.each(document.getElement(".timesheetAddFrom").getElements("input,textarea,select"),function(i){t=i.get("tag").toLowerCase(),n=i.get("type").toLowerCase()||!1,(n=="checkbox"||n=="radio")&&(i.checked=!1),n=="text"&&(i.value=""),t=="select"&&(i.value="",i.selectedIndex=0),t=="textarea"&&(i.value="")})},toggleAddRowsForm:function(){this.addRowsFormSatus=="open"?this.hideAddRowsForm():this.addRowsFormSatus=="closed"&&this.showAddRowsForm()},showAddRowsForm:function(n){if(typeOf(n)!=="null"&&n.stopPropagation(),!this.readOnlyOverride&&this.options.insertAddForm){var i=!1,t=this.options.getEmptyTimesheetApi;this.onBehalf?this.addRowTemplateFor!=this.onBehalfData.number&&(t=t.replace(/timesheet\//gi,"timesheetAsManager/")+"&employeeNo="+this.onBehalfData.number,this.addRowTemplateFor=this.onBehalfData.number,i=!0):this.addRowTemplateFor!="me"&&(this.addRowTemplateFor="me",i=!0),this.addRowsform.reveal(),this.addRowsButton.dissolve(),this.addRowsFormSatus="open",window.scrollTo(0,document.body.scrollHeight),i&&(uialert({message:this.genLang.wait,noClose:!0,showLoader:!0,showButtons:!1}),this.addFormInner.empty(),this.addGroupZelosProcessor=new ZelosTemplateProcess({target:this.addFormInner,getApi:t,putApi:"#",onComplete:function(){this.addFormInner.getElements(".section-header").destroy(),this.addFormInner.getElement(".section").setStyle("min-width","100%"),this.addFormInner.getElements(".form-row").setStyle("min-height",25),this.addFormInner.getElements(".shadow").removeClass("shadow"),this.addFormInner.getElements(".section,.section-body").addClass("frameless nopadding nomargin"),Affinity.prompts.hide()}.bind(this)}),this.addRowTemplateLoader&&"isRunning"in this.addRowTemplateLoader&&this.addRowTemplateLoader.isRunning()&&this.addRowTemplateLoader.cancel(),log("&#x2794; attempting weekly showAddRowsForm ..."),this.addRowTemplateLoader=new Request.JSON({url:t,method:"get",noCache:!0,onSuccess:function(n){if(!JSON.Unauthorized(n,"weekly, showAddRowsForm - "+t)){if(typeOf(n)==="object"){if("success"in n&&!n.success){uialert({message:this.genLang.error,showButtons:!0,noClose:!1,showLoader:!1}),log("&#x2714; attempted weekly showAddRowsForm failed: "+("error"in n&&n.error!==""?n.error:"unknown"));return}uialert({message:this.genLang.error+"<br />The add template returned is invalid.",showButtons:!0,noClose:!1,showLoader:!1}),log("&#x2714; attempted weekly showAddRowsForm failed: The data returned is invalid")}if(typeOf(n)==="array"&&n.length>0&&"Children"in n[0]){log("&#x2714; attempted weekly showAddRowsForm succeeded");var i={Children:[{Children:[],Description:{ShortText:null,HelpText:null},Attribute:{IsHidden:!1,IsReadOnly:!1,IsRequired:!1},Layout:{Rank:0,HideTitle:!0},ElementType:"SectionHeading",Name:"Default"}],Description:{ShortText:null,HelpText:null},Attribute:{IsHidden:!1,IsReadOnly:!1,IsRequired:!1},Layout:{Rank:0},ElementType:"Document"},r=n[0].Children;Array.each(r,function(n){!n.Attribute.IsHidden&&!n.Attribute.IsReadOnly&&(n.InputType==="Lookup"||n.Source&&n.Source.PropertyName==="AuthoriserId")||(n.Attribute.IsHidden=!0)}),i.Children[0].Children=n[0].Children,this.addGroupZelosProcessor.processTemplate(i),window.scrollTo(0,document.body.scrollHeight)}else uialert({message:this.genLang.error+"<br />The add template returned is invalid.",showButtons:!0,noClose:!1,showLoader:!1}),log("&#x2714; attempted weekly showAddRowsForm failed: The data returned is invalid")}}.bind(this),onError:function(n,t){log("&#x2718; attempted weekly showAddRowsForm failed with errors - "+n),window.uialert({message:t})}.bind(this),onFailure:function(n){log("&#x2718; attempted weekly showAddRowsForm failed - "+n.statusText),window.uialert({message:n.statusText})}.bind(this)}).get())}},hideAddRowsForm:function(n){typeOf(n)!=="null"&&n.stopPropagation(),this.options.insertAddForm&&this.addRowsform&&(this.addRowsform.dissolve(),this.addRowsButton.reveal(),this.addRowsFormSatus="closed",this.clearAddForm())},getEmpFromRowDoc:function(n){for(i=n.Children.length-1;i>=0;i--)if(n.Children[i].Source&&n.Children[i].Source.PropertyName&&n.Children[i].Source.PropertyName.test("EmployeeNo","gi"))return parseInt(n.Children[i].Value)},destroyGroup:function(n){return Array.each(n.getElements("input"),function(n){n.eliminate("timesheetDoc"),n.retrieve("changetracker")&&n.retrieve("changetracker").destroy()}),n.eliminate("full-row-lock"),n.eliminate("templateDoc"),n.empty(),n.destroy(),!0},destroyRows:function(){var n=!1;return Array.each(this.currentGroupRows,function(t){n=this.destroyGroup(t)}.bind(this)),this.currentGroupRows=[],this.currentGoups={},!0},destroy:function(){var n=this.destroyRows();this.options.target.empty(),Affinity.views.calendar=null,delete Affinity.views.calendar}})